[ {
  "name" : "- BOM Import Utility",
  "description" : "BOM Import Utility",
  "data" : "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Solidworks BOM Conversion Tool</title>\r\n\r\n    <!-- Bootstrap 5.3 CSS -->\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css\" rel=\"stylesheet\">\r\n\r\n    <!-- Fishbowl Modern Theme (overrides Bootstrap) -->\r\n    <style>\r\n        {% Style fishbowl-theme-modern %}\r\n    </style>\r\n\r\n    <style>\r\n        /* Page-specific overrides and Bootstrap integration */\r\n        h1 {\r\n            text-align: center;\r\n            margin-bottom: 10px;\r\n        }\r\n\r\n        .subtitle {\r\n            text-align: center;\r\n            color: var(--fb-text-secondary);\r\n            margin-bottom: 20px;\r\n        }\r\n\r\n        /* Upload section improvements */\r\n        .upload-section {\r\n            padding: 20px;\r\n            background-color: var(--fb-primary-pale);\r\n            border: 2px dashed var(--fb-primary);\r\n            border-radius: 8px;\r\n            text-align: center;\r\n            margin-bottom: 20px;\r\n            transition: all 0.3s ease;\r\n        }\r\n\r\n        .upload-section:hover {\r\n            border-color: var(--fb-primary-dark);\r\n            background-color: #BBDEFB;\r\n        }\r\n\r\n        .upload-section.dragover {\r\n            border-color: var(--fb-success);\r\n            background-color: var(--fb-success-bg);\r\n            border-style: solid;\r\n        }\r\n\r\n        .upload-section h3 {\r\n            margin: 0 0 10px 0;\r\n            color: var(--fb-primary-dark);\r\n            font-size: 18px;\r\n        }\r\n\r\n        .upload-section p {\r\n            margin: 5px 0;\r\n            font-size: 14px;\r\n        }\r\n\r\n        /* Compact summary stats - inline badges */\r\n        .summary-stats {\r\n            display: flex;\r\n            gap: 10px;\r\n            margin-bottom: 20px;\r\n            flex-wrap: wrap;\r\n            justify-content: center;\r\n        }\r\n\r\n        .stat-card {\r\n            display: inline-flex;\r\n            align-items: center;\r\n            gap: 6px;\r\n            padding: 6px 12px;\r\n            border-radius: 16px;\r\n            font-size: 13px;\r\n            font-weight: 600;\r\n        }\r\n\r\n        .stat-card.total {\r\n            background-color: var(--fb-info);\r\n            color: white;\r\n        }\r\n\r\n        .stat-card.parts {\r\n            background-color: var(--fb-primary);\r\n            color: white;\r\n        }\r\n\r\n        .stat-card.boms {\r\n            background-color: var(--fb-secondary);\r\n            color: white;\r\n        }\r\n\r\n        .stat-card.new-parts {\r\n            background-color: var(--fb-success);\r\n            color: white;\r\n        }\r\n\r\n        .stat-card.warning {\r\n            background-color: var(--fb-warning);\r\n            color: white;\r\n        }\r\n\r\n        .stat-card.error {\r\n            background-color: var(--fb-danger);\r\n            color: white;\r\n        }\r\n\r\n        .stat-number {\r\n            font-size: 16px;\r\n            font-weight: bold;\r\n        }\r\n\r\n        .stat-label {\r\n            font-size: 12px;\r\n            opacity: 0.95;\r\n        }\r\n\r\n        /* Results table with max height and scrolling */\r\n        .results-table-container {\r\n            max-height: 600px;\r\n            overflow-y: auto;\r\n            border: 1px solid var(--fb-border-light);\r\n            border-radius: 6px;\r\n            margin-bottom: 20px;\r\n        }\r\n\r\n        /* BOM Tree Table Styling */\r\n        .bom-header-row:hover {\r\n            filter: brightness(0.95);\r\n        }\r\n\r\n        .bom-header-row td {\r\n            border-top: 1px solid #dee2e6;\r\n            border-bottom: 1px solid #dee2e6;\r\n        }\r\n\r\n        .results-table-container table tbody tr {\r\n            transition: background-color 0.15s ease;\r\n        }\r\n\r\n        .results-table-container table tbody tr:hover {\r\n            background-color: rgba(33, 150, 243, 0.08) !important;\r\n        }\r\n\r\n        /* Offcanvas customization */\r\n        .offcanvas {\r\n            background-color: white !important;\r\n            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);\r\n        }\r\n\r\n        .offcanvas.offcanvas-start {\r\n            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);\r\n        }\r\n\r\n        .offcanvas-header {\r\n            background-color: var(--fb-primary);\r\n            color: var(--fb-text-white);\r\n            border-bottom: 2px solid var(--fb-primary-dark);\r\n        }\r\n\r\n        .offcanvas-title {\r\n            color: var(--fb-text-white);\r\n            font-weight: 600;\r\n        }\r\n\r\n        .btn-close {\r\n            filter: brightness(0) invert(1);\r\n        }\r\n\r\n        /* Toolbar area - fixed at top */\r\n        /* Off-Canvas Tab Buttons (sticky tabs on sides) */\r\n        .offcanvas-tab {\r\n            position: fixed;\r\n            top: 50%;\r\n            transform: translateY(-50%);\r\n            z-index: 1001;\r\n            background-color: var(--fb-primary);\r\n            color: white;\r\n            border: none;\r\n            border-radius: 8px 0 0 8px;\r\n            padding: 40px 8px;\r\n            writing-mode: vertical-rl;\r\n            text-orientation: mixed;\r\n            font-size: 14px;\r\n            font-weight: bold;\r\n            cursor: pointer;\r\n            box-shadow: -2px 2px 8px rgba(0, 0, 0, 0.3);\r\n            transition: all 0.3s ease;\r\n            letter-spacing: 2px;\r\n        }\r\n\r\n        .offcanvas-tab:hover {\r\n            background-color: var(--fb-primary-dark);\r\n            box-shadow: -4px 4px 12px rgba(0, 0, 0, 0.4);\r\n        }\r\n\r\n        .offcanvas-tab.tab-right {\r\n            right: 0;\r\n            border-radius: 8px 0 0 8px;\r\n        }\r\n\r\n        .offcanvas-tab.tab-right:hover {\r\n            right: 5px;\r\n        }\r\n\r\n        .offcanvas-tab.tab-left {\r\n            left: 0;\r\n            border-radius: 0 8px 8px 0;\r\n            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);\r\n        }\r\n\r\n        .offcanvas-tab.tab-left:hover {\r\n            left: 5px;\r\n            box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.4);\r\n        }\r\n\r\n        @media print {\r\n            .offcanvas-tab {\r\n                display: none !important;\r\n            }\r\n        }\r\n\r\n        /* Configuration settings styling */\r\n        .config-group {\r\n            margin-bottom: 20px;\r\n            padding: 15px;\r\n            background-color: var(--fb-gray-50);\r\n            border-radius: 6px;\r\n            border: 1px solid var(--fb-border-light);\r\n        }\r\n\r\n        .config-group h5 {\r\n            color: var(--fb-primary-dark);\r\n            font-size: 14px;\r\n            font-weight: 600;\r\n            margin-bottom: 10px;\r\n        }\r\n\r\n        .config-item {\r\n            margin-bottom: 10px;\r\n        }\r\n\r\n        .config-item label {\r\n            display: block;\r\n            font-size: 13px;\r\n            font-weight: 500;\r\n            color: var(--fb-text-primary);\r\n            margin-bottom: 5px;\r\n        }\r\n\r\n        .form-check-label {\r\n            font-size: 13px;\r\n            color: var(--fb-text-primary);\r\n        }\r\n\r\n        /* BOM tree visualization */\r\n        .bom-tree {\r\n            margin-bottom: 20px;\r\n        }\r\n\r\n        .bom-item {\r\n            padding: 8px;\r\n            margin: 4px 0;\r\n            border-left: 3px solid var(--fb-primary);\r\n            background-color: var(--fb-gray-50);\r\n        }\r\n\r\n        .bom-item.level-0 {\r\n            margin-left: 0;\r\n            border-left-color: var(--fb-primary-dark);\r\n            font-weight: 600;\r\n        }\r\n\r\n        .bom-item.level-1 {\r\n            margin-left: 20px;\r\n            border-left-color: var(--fb-primary);\r\n        }\r\n\r\n        .bom-item.level-2 {\r\n            margin-left: 40px;\r\n            border-left-color: var(--fb-primary-light);\r\n        }\r\n\r\n        .bom-item.level-3 {\r\n            margin-left: 60px;\r\n            border-left-color: var(--fb-primary-soft);\r\n        }\r\n\r\n        /* Export buttons */\r\n        .export-section {\r\n            margin: 20px 0;\r\n            padding: 15px;\r\n            background-color: var(--fb-gray-50);\r\n            border-radius: 6px;\r\n            text-align: center;\r\n        }\r\n\r\n        .export-btn {\r\n            margin: 5px;\r\n        }\r\n\r\n        /* Hidden utility */\r\n        .hidden {\r\n            display: none !important;\r\n        }\r\n\r\n        /* Progress indicator */\r\n        .progress-section {\r\n            margin: 20px 0;\r\n        }\r\n\r\n        /* Alert customization */\r\n        .alert {\r\n            border-radius: 6px;\r\n        }\r\n\r\n        /* Info boxes in offcanvas */\r\n        .info-box {\r\n            padding: 12px;\r\n            background-color: var(--fb-primary-pale);\r\n            border-left: 4px solid var(--fb-primary);\r\n            border-radius: 4px;\r\n            margin-bottom: 15px;\r\n            font-size: 13px;\r\n        }\r\n\r\n        .info-box ul {\r\n            margin-bottom: 0;\r\n            padding-left: 20px;\r\n        }\r\n\r\n        .info-box li {\r\n            margin-bottom: 5px;\r\n        }\r\n\r\n        /* Field mapping section */\r\n        .mapping-section {\r\n            margin: 20px 0;\r\n            padding: 15px;\r\n            background-color: var(--fb-gray-50);\r\n            border-radius: 6px;\r\n            border: 1px solid var(--fb-border-light);\r\n        }\r\n\r\n        .mapping-row {\r\n            display: grid;\r\n            grid-template-columns: 45% 10% 45%;\r\n            align-items: center;\r\n            gap: 10px;\r\n            margin-bottom: 10px;\r\n            padding: 8px;\r\n            background-color: white;\r\n            border-radius: 4px;\r\n        }\r\n\r\n        .mapping-label {\r\n            font-weight: 500;\r\n            color: var(--fb-text-primary);\r\n            font-size: 13px;\r\n        }\r\n\r\n        .mapping-arrow {\r\n            color: var(--fb-primary);\r\n            font-size: 18px;\r\n            text-align: center;\r\n        }\r\n\r\n        .mapping-select {\r\n            padding: 6px 10px;\r\n            border: 1px solid var(--fb-border-light);\r\n            border-radius: 4px;\r\n            font-size: 13px;\r\n            width: 100%;\r\n        }\r\n\r\n        .required-field::after {\r\n            content: \" *\";\r\n            color: var(--fb-danger);\r\n        }\r\n\r\n        /* Debug accordion */\r\n        .debug-section {\r\n            margin-top: 30px;\r\n            margin-bottom: 20px;\r\n        }\r\n\r\n        .debug-content {\r\n            max-height: 400px;\r\n            overflow-y: auto;\r\n            background-color: #1e1e1e;\r\n            color: #d4d4d4;\r\n            padding: 15px;\r\n            border-radius: 4px;\r\n            font-family: 'Courier New', monospace;\r\n            font-size: 12px;\r\n            line-height: 1.5;\r\n        }\r\n\r\n        .debug-entry {\r\n            margin-bottom: 8px;\r\n            padding: 4px 0;\r\n            border-bottom: 1px solid #333;\r\n        }\r\n\r\n        .debug-timestamp {\r\n            color: #858585;\r\n            font-size: 11px;\r\n        }\r\n\r\n        .debug-type {\r\n            font-weight: bold;\r\n            margin-right: 8px;\r\n        }\r\n\r\n        .debug-type.info {\r\n            color: #4fc3f7;\r\n        }\r\n\r\n        .debug-type.success {\r\n            color: #66bb6a;\r\n        }\r\n\r\n        .debug-type.warning {\r\n            color: #ffa726;\r\n        }\r\n\r\n        .debug-type.error {\r\n            color: #ef5350;\r\n        }\r\n\r\n        .debug-message {\r\n            color: #d4d4d4;\r\n        }\r\n\r\n        .debug-data {\r\n            margin-top: 4px;\r\n            padding-left: 15px;\r\n            color: #ce9178;\r\n            white-space: pre-wrap;\r\n            word-break: break-all;\r\n        }\r\n    </style>\r\n</head>\r\n\r\n<body>\r\n    <!-- Sticky Side Tab Buttons -->\r\n    <button class=\"offcanvas-tab tab-left\" type=\"button\" data-bs-toggle=\"offcanvas\" data-bs-target=\"#settingsOffcanvas\" aria-controls=\"settingsOffcanvas\">\r\n        SETTINGS\r\n    </button>\r\n    <button class=\"offcanvas-tab tab-right\" type=\"button\" data-bs-toggle=\"offcanvas\" data-bs-target=\"#instructionsOffcanvas\" aria-controls=\"instructionsOffcanvas\">\r\n        INSTRUCTIONS\r\n    </button>\r\n\r\n    <!-- Left Offcanvas: Configuration Settings -->\r\n    <div class=\"offcanvas offcanvas-start\" tabindex=\"-1\" id=\"settingsOffcanvas\" aria-labelledby=\"settingsOffcanvasLabel\" style=\"width: 380px;\">\r\n        <div class=\"offcanvas-header\">\r\n            <h5 class=\"offcanvas-title\" id=\"settingsOffcanvasLabel\"><i class=\"bi bi-gear-fill\"></i> Configuration Settings</h5>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"offcanvas\" aria-label=\"Close\"></button>\r\n        </div>\r\n        <div class=\"offcanvas-body\">\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-sliders\"></i> Default Values</h5>\r\n                <div class=\"config-item\">\r\n                    <label for=\"defaultUOM\">Default UOM (Part UOM)</label>\r\n                    <select class=\"form-select form-select-sm\" id=\"defaultUOM\" onchange=\"saveSettings()\">\r\n                        <option value=\"ea\" selected>ea (Each)</option>\r\n                        <!-- Will be populated from Fishbowl -->\r\n                    </select>\r\n                    <small class=\"text-muted d-block mt-1\">Default unit of measure for parts without specified UOM</small>\r\n                </div>\r\n                <div class=\"config-item\">\r\n                    <label for=\"defaultTaxCode\">Default Tax Code</label>\r\n                    <select class=\"form-select form-select-sm\" id=\"defaultTaxCode\" onchange=\"saveSettings()\">\r\n                        <option value=\"NON\">NON (Non-Taxable)</option>\r\n                        <!-- Will be populated from Fishbowl -->\r\n                    </select>\r\n                    <small class=\"text-muted d-block mt-1\">Tax code for new parts</small>\r\n                </div>\r\n                <div class=\"config-item\">\r\n                    <label for=\"defaultWeightUOM\">Default Weight UOM</label>\r\n                    <select class=\"form-select form-select-sm\" id=\"defaultWeightUOM\" onchange=\"saveSettings()\">\r\n                        <optgroup label=\"Metric\">\r\n                            <option value=\"kg\" selected>kg (Kilogram)</option>\r\n                            <option value=\"g\">g (Gram)</option>\r\n                        </optgroup>\r\n                        <optgroup label=\"Imperial\">\r\n                            <option value=\"lb\">lb (Pound)</option>\r\n                            <option value=\"oz\">oz (Ounce)</option>\r\n                        </optgroup>\r\n                    </select>\r\n                    <small class=\"text-muted d-block mt-1\">Unit for part weights</small>\r\n                </div>\r\n                <div class=\"config-item\">\r\n                    <label for=\"defaultSizeUOM\">Default Size UOM</label>\r\n                    <select class=\"form-select form-select-sm\" id=\"defaultSizeUOM\" onchange=\"saveSettings()\">\r\n                        <optgroup label=\"Metric\">\r\n                            <option value=\"cm\" selected>cm (Centimeter)</option>\r\n                            <option value=\"mm\">mm (Millimeter)</option>\r\n                            <option value=\"m\">m (Meter)</option>\r\n                        </optgroup>\r\n                        <optgroup label=\"Imperial\">\r\n                            <option value=\"in\">in (Inch)</option>\r\n                            <option value=\"ft\">ft (Foot)</option>\r\n                        </optgroup>\r\n                    </select>\r\n                    <small class=\"text-muted d-block mt-1\">Unit for dimensions (width, height, length)</small>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-box-seam\"></i> Part Creation Options</h5>\r\n                <div class=\"config-item\">\r\n                    <div class=\"form-check\">\r\n                        <input class=\"form-check-input\" type=\"checkbox\" id=\"createAsInventory\" checked onchange=\"saveSettings()\">\r\n                        <label class=\"form-check-label\" for=\"createAsInventory\">\r\n                            Create new parts as Inventory type\r\n                        </label>\r\n                    </div>\r\n                    <small class=\"text-muted d-block mt-1\">All new parts will be created with Part Type = Inventory</small>\r\n                </div>\r\n                <div class=\"config-item\">\r\n                    <div class=\"form-check\">\r\n                        <input class=\"form-check-input\" type=\"checkbox\" id=\"createFinishedGoodsAsProducts\" onchange=\"saveSettings()\">\r\n                        <label class=\"form-check-label\" for=\"createFinishedGoodsAsProducts\">\r\n                            Create finished goods as Products\r\n                        </label>\r\n                    </div>\r\n                    <small class=\"text-muted d-block mt-1\">Parts that are output of a BOM/stage will also be created as products</small>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-diagram-3\"></i> BOM Processing Options</h5>\r\n                <div class=\"config-item\">\r\n                    <div class=\"form-check\">\r\n                        <input class=\"form-check-input\" type=\"checkbox\" id=\"validatePartsExist\" checked onchange=\"saveSettings()\">\r\n                        <label class=\"form-check-label\" for=\"validatePartsExist\">\r\n                            Validate all parts before creating BOMs\r\n                        </label>\r\n                    </div>\r\n                    <small class=\"text-muted d-block mt-1\">Ensure all required parts exist before BOM creation</small>\r\n                </div>\r\n                <div class=\"config-item\">\r\n                    <div class=\"form-check\">\r\n                        <input class=\"form-check-input\" type=\"checkbox\" id=\"processStagesSequentially\" checked onchange=\"saveSettings()\">\r\n                        <label class=\"form-check-label\" for=\"processStagesSequentially\">\r\n                            Process staged BOMs sequentially\r\n                        </label>\r\n                    </div>\r\n                    <small class=\"text-muted d-block mt-1\">Create parts from earlier stages before later stages</small>\r\n                </div>\r\n                <div class=\"config-item\">\r\n                    <div class=\"form-check\">\r\n                        <input class=\"form-check-input\" type=\"checkbox\" id=\"createBOMFromFilename\" onchange=\"saveSettings()\">\r\n                        <label class=\"form-check-label\" for=\"createBOMFromFilename\">\r\n                            Create top-level BOM from filename\r\n                        </label>\r\n                    </div>\r\n                    <small class=\"text-muted d-block mt-1\">Wrap all BOMs in a main assembly named after the CSV file</small>\r\n                </div>\r\n                <div class=\"config-item\">\r\n                    <label for=\"autoCreateType\" class=\"form-label\" style=\"font-weight: 500;\">BOM Auto Create Type</label>\r\n                    <select class=\"form-select form-select-sm\" id=\"autoCreateType\" onchange=\"saveSettings()\">\r\n                        <option value=\"Never\">Never</option>\r\n                        <option value=\"Short Quantity\">Short Quantity</option>\r\n                        <option value=\"Order Quantity\">Order Quantity</option>\r\n                        <option value=\"Always Create\">Always Create</option>\r\n                        <option value=\"Build To Order\">Build To Order</option>\r\n                    </select>\r\n                    <small class=\"text-muted d-block mt-1\">How BOMs should auto-create work orders in Fishbowl</small>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Configuration Management -->\r\n            <div class=\"config-group mt-4\">\r\n                <h5><i class=\"bi bi-file-earmark-arrow-down\"></i> Configuration</h5>\r\n                <div class=\"d-grid gap-2\">\r\n                    <button class=\"btn btn-success btn-sm\" onclick=\"saveConfiguration()\">\r\n                        <i class=\"bi bi-download\"></i> Save Configuration\r\n                    </button>\r\n                    <button class=\"btn btn-outline-primary btn-sm\" onclick=\"loadConfiguration()\">\r\n                        <i class=\"bi bi-upload\"></i> Load Configuration\r\n                    </button>\r\n                </div>\r\n                <small class=\"text-muted d-block mt-2\">\r\n                    <i class=\"bi bi-info-circle\"></i> Saves/loads both settings and field mappings together\r\n                </small>\r\n            </div>\r\n\r\n            <div class=\"alert alert-info mt-3\" style=\"font-size: 12px;\">\r\n                <i class=\"bi bi-info-circle-fill\"></i> Changes take effect when you process the next file.\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Right Offcanvas: Instructions -->\r\n    <div class=\"offcanvas offcanvas-end\" tabindex=\"-1\" id=\"instructionsOffcanvas\" aria-labelledby=\"instructionsOffcanvasLabel\" style=\"width: 500px;\">\r\n        <div class=\"offcanvas-header\">\r\n            <h5 class=\"offcanvas-title\" id=\"instructionsOffcanvasLabel\"><i class=\"bi bi-book-fill\"></i> How to Use This Tool</h5>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"offcanvas\" aria-label=\"Close\"></button>\r\n        </div>\r\n        <div class=\"offcanvas-body\">\r\n            <div class=\"info-box\">\r\n                <h6 class=\"fw-bold mb-2\"><i class=\"bi bi-1-circle-fill\"></i> Export from Solidworks</h6>\r\n                <p>Export your Bill of Materials from Solidworks as a CSV file with:</p>\r\n                <ul style=\"font-size: 12px;\">\r\n                    <li><strong>Dotted indentation levels</strong> (1, 1.1, 1.1.1, 1.2, 2, 2.1...)</li>\r\n                    <li>Part numbers, descriptions, quantities</li>\r\n                    <li>Optional: vendor info, costs, UPC, dimensions</li>\r\n                </ul>\r\n            </div>\r\n\r\n            <div class=\"info-box\">\r\n                <h6 class=\"fw-bold mb-2\"><i class=\"bi bi-2-circle-fill\"></i> Upload & Map Fields</h6>\r\n                <p style=\"font-size: 12px;\">Drag and drop your CSV file, then map Solidworks columns to Fishbowl fields in the popup dialog.</p>\r\n                <p style=\"font-size: 12px;\"><strong>Required mappings:</strong></p>\r\n                <ul style=\"font-size: 11px;\">\r\n                    <li><strong>Level</strong> - BOM hierarchy (1, 1.1, 1.2...)</li>\r\n                    <li><strong>Number</strong> - Part number</li>\r\n                    <li><strong>Description</strong> - Part description</li>\r\n                    <li><strong>Quantity</strong> - Component quantity</li>\r\n                </ul>\r\n                <p style=\"font-size: 12px;\"><strong>Optional but recommended:</strong> UOM, Vendor, Vendor Cost, UPC, Dimensions</p>\r\n            </div>\r\n\r\n            <div class=\"info-box\">\r\n                <h6 class=\"fw-bold mb-2\"><i class=\"bi bi-3-circle-fill\"></i> Configure Settings</h6>\r\n                <p style=\"font-size: 12px;\">Click the <strong>Settings</strong> tab (left side) to configure:</p>\r\n                <ul style=\"font-size: 11px;\">\r\n                    <li><strong>Default UOM/Tax Code</strong> - Applied to parts without values</li>\r\n                    <li><strong>Create as Inventory</strong> - Part type (checked) vs other types</li>\r\n                    <li><strong>Create Finished Goods as Products</strong> - Make FG parts sellable products</li>\r\n                    <li><strong>Validate Parts Exist</strong> - Check against Fishbowl database</li>\r\n                    <li><strong>Process Stages Sequentially</strong> - Create sub-assemblies first</li>\r\n                    <li><strong>Create BOM from Filename</strong> - Wrap all BOMs in top-level assembly</li>\r\n                    <li><strong>BOM Auto Create Type</strong> - Work order creation rules</li>\r\n                </ul>\r\n            </div>\r\n\r\n            <div class=\"info-box\">\r\n                <h6 class=\"fw-bold mb-2\"><i class=\"bi bi-4-circle-fill\"></i> Review BOM Structure</h6>\r\n                <p style=\"font-size: 12px;\">The tool displays:</p>\r\n                <ul style=\"font-size: 11px;\">\r\n                    <li><strong>Hierarchical tree</strong> - Click to expand/collapse assemblies</li>\r\n                    <li><strong>Cost rollup</strong> - Calculated from vendor costs or Fishbowl data</li>\r\n                    <li><strong>Part badges</strong> - Shows Finished Good, Raw Good, or Stage types</li>\r\n                    <li><strong>Subtotals</strong> - Per assembly and grand total</li>\r\n                </ul>\r\n            </div>\r\n\r\n            <div class=\"info-box\">\r\n                <h6 class=\"fw-bold mb-2\"><i class=\"bi bi-5-circle-fill\"></i> Export or Import</h6>\r\n                <p style=\"font-size: 12px;\"><strong>CSV Export (manual):</strong></p>\r\n                <ul style=\"font-size: 11px;\">\r\n                    <li><strong>Export PPvP</strong> - Part/Product/Vendor Pricing CSV for manual import</li>\r\n                    <li><strong>Export BOM</strong> - BOM Import CSV for manual import</li>\r\n                </ul>\r\n                <p style=\"font-size: 12px;\"><strong>Direct API (automatic):</strong></p>\r\n                <ul style=\"font-size: 11px;\">\r\n                    <li><strong>Create Parts</strong> - Import parts directly via Fishbowl API</li>\r\n                    <li><strong>Create BOMs</strong> - Import BOMs directly via Fishbowl API</li>\r\n                </ul>\r\n            </div>\r\n\r\n            <div class=\"alert alert-warning mt-3\" style=\"font-size: 11px;\">\r\n                <i class=\"bi bi-exclamation-triangle-fill\"></i> <strong>Import Order:</strong> Always create parts BEFORE BOMs. BOMs require all referenced parts to exist.\r\n            </div>\r\n\r\n            <div class=\"alert alert-info mt-3\" style=\"font-size: 11px;\">\r\n                <i class=\"bi bi-lightbulb-fill\"></i> <strong>Tip:</strong> Save/load configuration files to reuse field mappings and settings across sessions.\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Field Mapping Modal -->\r\n    <div class=\"modal fade\" id=\"fieldMappingModal\" tabindex=\"-1\" aria-labelledby=\"fieldMappingModalLabel\" aria-hidden=\"true\">\r\n        <div class=\"modal-dialog modal-lg\">\r\n            <div class=\"modal-content\">\r\n                <div class=\"modal-header\" style=\"background-color: var(--fb-primary); color: white;\">\r\n                    <h5 class=\"modal-title\" id=\"fieldMappingModalLabel\">\r\n                        <i class=\"bi bi-arrows-angle-contract\"></i> Map Solidworks Columns to Fishbowl BOM Import\r\n                    </h5>\r\n                    <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\r\n                </div>\r\n                <div class=\"modal-body\">\r\n                    <div class=\"alert alert-info mb-3\">\r\n                        <i class=\"bi bi-info-circle-fill\"></i> Map your Solidworks BOM columns to Fishbowl fields. Fields marked with <span class=\"text-danger\">*</span> are required.\r\n                    </div>\r\n\r\n                    <div style=\"display: grid; grid-template-columns: 45% 10% 45%; gap: 10px; margin-bottom: 15px; font-weight: bold;\">\r\n                        <div>Fishbowl Field</div>\r\n                        <div style=\"text-align: center;\"></div>\r\n                        <div>Solidworks Column</div>\r\n                    </div>\r\n\r\n                    <!-- BOM field mappings -->\r\n                    <div id=\"bomLevelMappings\">\r\n                        <!-- Will be populated dynamically -->\r\n                    </div>\r\n\r\n                    <!-- Hidden - not used anymore but keeping for compatibility -->\r\n                    <div id=\"itemLevelMappings\" style=\"display: none;\"></div>\r\n\r\n                    <div class=\"alert alert-warning mt-3 mb-0\">\r\n                        <small><i class=\"bi bi-lightbulb-fill\"></i> <strong>Tip:</strong> Use \"None\" to skip optional fields. Required fields must be mapped.</small>\r\n                    </div>\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <div class=\"me-auto\">\r\n                        <button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" onclick=\"exportMappingFile()\">\r\n                            <i class=\"bi bi-download\"></i> Export Mapping\r\n                        </button>\r\n                        <button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" onclick=\"importMappingFile()\">\r\n                            <i class=\"bi bi-upload\"></i> Import Mapping\r\n                        </button>\r\n                    </div>\r\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancel</button>\r\n                    <button type=\"button\" class=\"btn btn-primary\" onclick=\"saveMappings()\">\r\n                        <i class=\"bi bi-save\"></i> Save & Process\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"container\">\r\n        <h1>Solidworks BOM Conversion Tool</h1>\r\n        <p class=\"subtitle\">Convert Solidworks BOM exports to Fishbowl-compatible Part and BOM imports</p>\r\n\r\n        <!-- Upload Section -->\r\n        <div class=\"upload-section\" id=\"uploadSection\">\r\n            <h3>\uD83D\uDCC4 Upload Solidworks BOM CSV</h3>\r\n            <p>Drag and drop file here, or <button type=\"button\" class=\"btn btn-primary\" onclick=\"document.getElementById('fileInput').click()\">Choose File</button></p>\r\n            <input type=\"file\" id=\"fileInput\" accept=\".csv\" onchange=\"handleFileSelect(event)\" style=\"display: none;\" />\r\n            <p id=\"fileName\" class=\"text-primary fw-bold\"></p>\r\n        </div>\r\n\r\n        <!-- Field Mapping Button (hidden until file loaded) -->\r\n        <div class=\"text-center mb-3 hidden\" id=\"mappingButtonSection\">\r\n            <button class=\"btn btn-primary btn-lg\" onclick=\"openFieldMappingDialog()\">\r\n                <i class=\"bi bi-arrows-angle-contract\"></i> Configure Field Mapping\r\n            </button>\r\n            <button class=\"btn btn-outline-secondary btn-lg ms-2\" onclick=\"importMappingFile()\" title=\"Load saved field mappings from JSON file\">\r\n                <i class=\"bi bi-upload\"></i> Load Saved Mappings\r\n            </button>\r\n            <p class=\"text-muted mt-2 mb-0\">\r\n                <small>Map Solidworks columns to Fishbowl fields, or load a saved mapping configuration</small>\r\n            </p>\r\n        </div>\r\n\r\n        <!-- Summary Stats (hidden until file loaded) -->\r\n        <div class=\"summary-stats hidden\" id=\"summaryStats\">\r\n            <div class=\"stat-card total\">\r\n                <span class=\"stat-number\" id=\"statTotal\">0</span>\r\n                <span class=\"stat-label\">Total Items</span>\r\n            </div>\r\n            <div class=\"stat-card parts\">\r\n                <span class=\"stat-number\" id=\"statParts\">0</span>\r\n                <span class=\"stat-label\">Unique Parts</span>\r\n            </div>\r\n            <div class=\"stat-card new-parts\">\r\n                <span class=\"stat-number\" id=\"statNewParts\">0</span>\r\n                <span class=\"stat-label\">New Parts</span>\r\n            </div>\r\n            <div class=\"stat-card boms\">\r\n                <span class=\"stat-number\" id=\"statBOMs\">0</span>\r\n                <span class=\"stat-label\">BOMs/Stages</span>\r\n            </div>\r\n            <div class=\"stat-card warning\">\r\n                <span class=\"stat-number\" id=\"statWarnings\">0</span>\r\n                <span class=\"stat-label\">Warnings</span>\r\n            </div>\r\n            <div class=\"stat-card error\">\r\n                <span class=\"stat-number\" id=\"statErrors\">0</span>\r\n                <span class=\"stat-label\">Errors</span>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Progress Section (hidden until processing) -->\r\n        <div class=\"progress-section hidden\" id=\"progressSection\">\r\n            <div class=\"alert alert-info\">\r\n                <i class=\"bi bi-hourglass-split\"></i> <span id=\"progressText\">Processing...</span>\r\n            </div>\r\n            <div class=\"progress\">\r\n                <div class=\"progress-bar progress-bar-striped progress-bar-animated\" id=\"progressBar\" role=\"progressbar\" style=\"width: 0%\"></div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- BOM Structure Preview (hidden until file loaded) -->\r\n        <div class=\"hidden\" id=\"bomStructureSection\">\r\n            <h3>\uD83D\uDCCA BOM Structure</h3>\r\n            <div class=\"bom-tree\" id=\"bomTree\">\r\n                <!-- Will be populated dynamically -->\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Parts to Create (hidden until file loaded) -->\r\n        <div class=\"hidden\" id=\"partsSection\">\r\n            <div class=\"accordion\" id=\"partsAccordion\">\r\n                <div class=\"accordion-item\">\r\n                    <h2 class=\"accordion-header\">\r\n                        <button class=\"accordion-button\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#partsContent\" aria-expanded=\"true\">\r\n                            <i class=\"bi bi-box-seam me-2\"></i> \uD83D\uDD27 Parts to Create (<span id=\"partsCount\">0</span>)\r\n                        </button>\r\n                    </h2>\r\n                    <div id=\"partsContent\" class=\"accordion-collapse collapse show\" data-bs-parent=\"#partsAccordion\">\r\n                        <div class=\"accordion-body p-0\">\r\n                            <div class=\"results-table-container\">\r\n                                <table class=\"table table-sm table-hover mb-0\" id=\"partsTable\">\r\n                                    <thead>\r\n                                        <tr>\r\n                                            <th>Part Number</th>\r\n                                            <th>Description</th>\r\n                                            <th>UOM</th>\r\n                                            <th>Type</th>\r\n                                            <th>Status</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody id=\"partsTableBody\">\r\n                                        <!-- Will be populated dynamically -->\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- BOMs to Create (hidden until file loaded) -->\r\n        <div class=\"hidden\" id=\"bomsSection\">\r\n            <div class=\"accordion\" id=\"bomsAccordion\">\r\n                <div class=\"accordion-item\">\r\n                    <h2 class=\"accordion-header\">\r\n                        <button class=\"accordion-button\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#bomsContent\" aria-expanded=\"true\">\r\n                            <i class=\"bi bi-diagram-3 me-2\"></i> \uD83D\uDCCB BOMs to Create (<span id=\"bomsCount\">0</span>)\r\n                        </button>\r\n                    </h2>\r\n                    <div id=\"bomsContent\" class=\"accordion-collapse collapse show\" data-bs-parent=\"#bomsAccordion\">\r\n                        <div class=\"accordion-body p-0\">\r\n                            <div class=\"results-table-container\">\r\n                                <table class=\"table table-sm table-hover mb-0\" id=\"bomsTable\">\r\n                                    <thead>\r\n                                        <tr>\r\n                                            <th>BOM Name</th>\r\n                                            <th>Parent Part</th>\r\n                                            <th>Items</th>\r\n                                            <th>Stage</th>\r\n                                            <th>Status</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody id=\"bomsTableBody\">\r\n                                        <!-- Will be populated dynamically -->\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Export Section (hidden until ready) -->\r\n        <div class=\"export-section hidden\" id=\"exportSection\">\r\n            <h4>\uD83D\uDCE5 Export & Import to Fishbowl</h4>\r\n\r\n            <div class=\"d-flex gap-2 justify-content-center flex-wrap\">\r\n                <button class=\"btn btn-sm btn-outline-success\" onclick=\"exportPartImport()\">\r\n                    <i class=\"bi bi-download\"></i> Export PPvP\r\n                </button>\r\n                <button class=\"btn btn-sm btn-outline-primary\" onclick=\"exportBOMImport()\">\r\n                    <i class=\"bi bi-download\"></i> Export BOM\r\n                </button>\r\n                <button class=\"btn btn-sm btn-success\" onclick=\"importPartsToFishbowl()\">\r\n                    <i class=\"bi bi-upload\"></i> Create Parts\r\n                </button>\r\n                <button class=\"btn btn-sm btn-primary\" onclick=\"importBOMsToFishbowl()\">\r\n                    <i class=\"bi bi-upload\"></i> Create BOMs\r\n                </button>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Toast Container (Bottom-Right) -->\r\n        <div class=\"toast-container position-fixed bottom-0 end-0 p-3\" id=\"toastContainer\">\r\n            <!-- Dynamic toasts will appear here -->\r\n        </div>\r\n\r\n        <!-- Debug Section -->\r\n        <div class=\"debug-section\">\r\n            <div class=\"accordion\" id=\"debugAccordion\">\r\n                <div class=\"accordion-item\">\r\n                    <h2 class=\"accordion-header\">\r\n                        <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#debugContent\" aria-expanded=\"false\" aria-controls=\"debugContent\">\r\n                            <i class=\"bi bi-bug-fill me-2\"></i> Debug Console\r\n                        </button>\r\n                    </h2>\r\n                    <div id=\"debugContent\" class=\"accordion-collapse collapse\" data-bs-parent=\"#debugAccordion\">\r\n                        <div class=\"accordion-body p-0\">\r\n                            <div class=\"p-2 bg-dark text-white d-flex justify-content-between align-items-center\">\r\n                                <small>Debug log - Auto-scrolls to latest entry</small>\r\n                                <button class=\"btn btn-sm btn-outline-light\" onclick=\"clearDebugLog()\">\r\n                                    <i class=\"bi bi-trash\"></i> Clear\r\n                                </button>\r\n                            </div>\r\n                            <div class=\"debug-content\" id=\"debugLog\">\r\n                                <div class=\"debug-entry\">\r\n                                    <span class=\"debug-timestamp\">[00:00:00]</span>\r\n                                    <span class=\"debug-type info\">[INFO]</span>\r\n                                    <span class=\"debug-message\">Debug console initialized</span>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Bootstrap 5 JS Bundle (includes Popper) -->\r\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\r\n\r\n    <script>\r\n        // Configuration state\r\n        const config = {\r\n            createAsInventory: true,\r\n            createFinishedGoodsAsProducts: false,\r\n            validatePartsExist: true,\r\n            processStagesSequentially: true,\r\n            createBOMFromFilename: false,\r\n            autoCreateType: 'Build To Order' // Options: Never, Short Quantity, Order Quantity, Always Create, Build To Order\r\n        };\r\n\r\n        // Application state\r\n        let solidworksData = null;\r\n        let rawCSVContent = null; // Store raw CSV before processing\r\n        let csvFilename = null; // Store the CSV filename for BOM creation\r\n        let parsedBOM = null;\r\n        let partsToCreate = [];\r\n        let bomsToCreate = [];\r\n        let bomImportHeaders = null;\r\n        let bomLevelHeaders = [];\r\n        let itemLevelHeaders = [];\r\n        let partImportHeaders = []; // Store part import headers from API\r\n        let solidworksColumns = [];\r\n        let fieldMappings = {};\r\n\r\n        // Fishbowl data cache\r\n        let fishbowlData = {\r\n            uoms: [],\r\n            uomDetails: [],\r\n            vendors: [],\r\n            taxCodes: [],\r\n            taxCodeDetails: [],\r\n            existingParts: [], // Cache of existing parts in Fishbowl\r\n            partTypes: ['Inventory', 'Non-Inventory', 'Service', 'Labor', 'Overhead', 'Miscellaneous', 'Internal Use', 'Capital Equipment', 'Shipping']\r\n        };\r\n\r\n        // User-configurable defaults\r\n        let defaultValues = {\r\n            uom: 'ea',\r\n            taxCode: 'NON',\r\n            weightUOM: 'kg', // Metric default\r\n            sizeUOM: 'cm',   // Metric default\r\n            active: true\r\n        };\r\n\r\n        // BOM Field definitions (from Fishbowl documentation)\r\n        const bomFieldDefinitions = {\r\n            'Level': { required: true, desc: 'Hierarchical level (1, 1.1, 1.2, etc.)', validate: false },\r\n            'Number': { required: true, desc: 'Part number in Fishbowl', validate: false },\r\n            'Description': { required: true, desc: 'Part description', validate: false },\r\n            'Details': { required: false, desc: 'Additional details about the part', validate: false },\r\n            'Revision': { required: false, desc: 'Revision identifier', validate: false },\r\n            'Standard Cost': { required: false, desc: 'Anticipated cost per unit', validate: false },\r\n            'Quantity': { required: true, desc: 'Quantity needed in BOM', validate: false },\r\n            'UPC': { required: false, desc: 'Universal Product Code', validate: false },\r\n            'UOM': { required: true, desc: 'Unit of Measure', validateUOM: true },\r\n            'Weight': { required: false, desc: 'Part weight', validate: false },\r\n            'Width': { required: false, desc: 'Part width', validate: false },\r\n            'Height': { required: false, desc: 'Part height', validate: false },\r\n            'Length': { required: false, desc: 'Part length', validate: false },\r\n            'Vendor': { required: false, desc: 'Vendor name', validateVendor: true },\r\n            'Vendor Number': { required: false, desc: 'Vendor part number', validate: false },\r\n            'Vendor Cost': { required: false, desc: 'Cost from vendor', validate: false }\r\n        };\r\n\r\n        const MAPPING_STORAGE_KEY = 'solidworksBOMMappings';\r\n\r\n        // Debug logging functions\r\n        function debugLog(type, message, data = null) {\r\n            const timestamp = new Date().toLocaleTimeString();\r\n            const logEntry = document.createElement('div');\r\n            logEntry.className = 'debug-entry';\r\n\r\n            let html = `\r\n                <span class=\"debug-timestamp\">[${timestamp}]</span>\r\n                <span class=\"debug-type ${type}\">[${type.toUpperCase()}]</span>\r\n                <span class=\"debug-message\">${message}</span>\r\n            `;\r\n\r\n            if (data) {\r\n                const dataStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);\r\n                html += `<div class=\"debug-data\">${dataStr}</div>`;\r\n            }\r\n\r\n            logEntry.innerHTML = html;\r\n\r\n            const debugLogEl = document.getElementById('debugLog');\r\n            debugLogEl.appendChild(logEntry);\r\n\r\n            // Auto-scroll to bottom\r\n            debugLogEl.scrollTop = debugLogEl.scrollHeight;\r\n\r\n            // Also log to console\r\n            console.log(`[${type.toUpperCase()}]`, message, data || '');\r\n        }\r\n\r\n        function clearDebugLog() {\r\n            const debugLogEl = document.getElementById('debugLog');\r\n            debugLogEl.innerHTML = `\r\n                <div class=\"debug-entry\">\r\n                    <span class=\"debug-timestamp\">[${new Date().toLocaleTimeString()}]</span>\r\n                    <span class=\"debug-type info\">[INFO]</span>\r\n                    <span class=\"debug-message\">Debug log cleared</span>\r\n                </div>\r\n            `;\r\n        }\r\n\r\n        // Check BOM Import API Headers\r\n        function checkBOMImportHeaders() {\r\n            debugLog('info', 'Checking BOM Import API headers...');\r\n\r\n            const headerPayload = {\r\n                \"ImportHeaderRq\": {\r\n                    \"Type\": \"ImportBillOfMaterials\"\r\n                }\r\n            };\r\n\r\n            try {\r\n                const headerResponse = runApiRequest('ImportHeaderRq', JSON.stringify(headerPayload));\r\n\r\n                if (headerResponse) {\r\n                    const headerResult = typeof headerResponse === 'string' ? JSON.parse(headerResponse) : headerResponse;\r\n\r\n                    if (headerResult && headerResult.ImportHeaderRs && headerResult.ImportHeaderRs.Header) {\r\n                        bomImportHeaders = headerResult.ImportHeaderRs.Header;\r\n                        debugLog('success', 'BOM Import Headers retrieved successfully');\r\n\r\n                        // Parse the two header rows\r\n                        if (bomImportHeaders.Row && bomImportHeaders.Row.length >= 2) {\r\n                            // First row is BOM-level headers\r\n                            bomLevelHeaders = parseCSVLine(bomImportHeaders.Row[0]);\r\n                            debugLog('info', 'BOM-level headers', bomLevelHeaders);\r\n\r\n                            // Second row is Item-level headers\r\n                            itemLevelHeaders = parseCSVLine(bomImportHeaders.Row[1]);\r\n                            debugLog('info', 'Item-level headers', itemLevelHeaders);\r\n                        }\r\n\r\n                        showMessage('BOM Import headers retrieved successfully', 'success');\r\n                        return bomImportHeaders;\r\n                    } else {\r\n                        debugLog('warning', 'No headers found in response');\r\n                        showMessage('Could not find headers in API response', 'warning');\r\n                    }\r\n                } else {\r\n                    debugLog('error', 'No response from ImportHeaderRq');\r\n                    showMessage('No response from API', 'danger');\r\n                }\r\n            } catch (e) {\r\n                debugLog('error', 'Error querying BOM import headers', e.toString());\r\n                showMessage('Error querying BOM import headers: ' + e.message, 'danger');\r\n            }\r\n\r\n            return null;\r\n        }\r\n\r\n        function checkPartImportHeaders() {\r\n            debugLog('info', 'Checking Part Import API headers...');\r\n\r\n            const headerPayload = {\r\n                \"ImportHeaderRq\": {\r\n                    \"Type\": \"ImportPartProductAndVendorPricing\"\r\n                }\r\n            };\r\n\r\n            try {\r\n                const headerResponse = runApiRequest('ImportHeaderRq', JSON.stringify(headerPayload));\r\n\r\n                if (headerResponse) {\r\n                    const headerResult = typeof headerResponse === 'string' ? JSON.parse(headerResponse) : headerResponse;\r\n\r\n                    if (headerResult && headerResult.ImportHeaderRs && headerResult.ImportHeaderRs.Header) {\r\n                        const headers = headerResult.ImportHeaderRs.Header;\r\n                        debugLog('success', 'Part Import Headers retrieved successfully');\r\n\r\n                        // Parse the header row (PPP import has single header row)\r\n                        if (headers.Row && headers.Row.length > 0) {\r\n                            partImportHeaders = parseCSVLine(headers.Row[0]);\r\n                            debugLog('success', 'Part import headers', partImportHeaders);\r\n                        }\r\n\r\n                        showMessage('Part Import headers retrieved successfully', 'success');\r\n                        return headers;\r\n                    } else {\r\n                        debugLog('warning', 'No headers found in response');\r\n                        showMessage('Could not find headers in API response', 'warning');\r\n                    }\r\n                } else {\r\n                    debugLog('error', 'No response from ImportHeaderRq');\r\n                    showMessage('No response from API', 'danger');\r\n                }\r\n            } catch (e) {\r\n                debugLog('error', 'Error querying Part import headers', e.toString());\r\n                showMessage('Error querying Part import headers: ' + e.message, 'danger');\r\n            }\r\n\r\n            return null;\r\n        }\r\n\r\n        // File handling\r\n        function handleFileSelect(event) {\r\n            const file = event.target.files[0];\r\n            if (file) {\r\n                processFile(file);\r\n            }\r\n        }\r\n\r\n        // Drag and drop support\r\n        const uploadSection = document.getElementById('uploadSection');\r\n\r\n        uploadSection.addEventListener('dragover', (e) => {\r\n            e.preventDefault();\r\n            uploadSection.classList.add('dragover');\r\n        });\r\n\r\n        uploadSection.addEventListener('dragleave', () => {\r\n            uploadSection.classList.remove('dragover');\r\n        });\r\n\r\n        uploadSection.addEventListener('drop', (e) => {\r\n            e.preventDefault();\r\n            uploadSection.classList.remove('dragover');\r\n\r\n            const file = e.dataTransfer.files[0];\r\n            if (file && file.name.endsWith('.csv')) {\r\n                processFile(file);\r\n            } else {\r\n                showMessage('Please drop a CSV file', 'danger');\r\n            }\r\n        });\r\n\r\n        // Process uploaded file\r\n        function processFile(file) {\r\n            document.getElementById('fileName').textContent = file.name;\r\n\r\n            // Store filename without extension for potential BOM creation\r\n            csvFilename = file.name.replace(/\\.csv$/i, '');\r\n            debugLog('info', `CSV filename captured: ${csvFilename}`);\r\n\r\n            const reader = new FileReader();\r\n            reader.onload = function(e) {\r\n                const content = e.target.result;\r\n                parseSolidworksCSV(content);\r\n            };\r\n            reader.readAsText(file);\r\n        }\r\n\r\n        // Parse Solidworks CSV - ONLY extract headers\r\n        function parseSolidworksCSV(csvContent) {\r\n            debugLog('info', 'Loading Solidworks BOM CSV...');\r\n            showMessage('Loading Solidworks BOM...', 'info');\r\n\r\n            try {\r\n                // Store raw content for later processing\r\n                rawCSVContent = csvContent;\r\n\r\n                // Parse CSV into rows\r\n                const lines = csvContent.split('\\n').map(line => line.trim()).filter(line => line.length > 0);\r\n                debugLog('info', `Total lines in CSV: ${lines.length}`);\r\n\r\n                if (lines.length < 2) {\r\n                    debugLog('error', 'CSV file is empty or has no data rows');\r\n                    showMessage('CSV file is empty or invalid', 'danger');\r\n                    return;\r\n                }\r\n\r\n                // Parse header row ONLY\r\n                const headers = parseCSVLine(lines[0]);\r\n                solidworksColumns = headers;\r\n                debugLog('success', `Detected ${headers.length} columns in Solidworks CSV`, headers);\r\n\r\n                showMessage(` CSV loaded with ${headers.length} columns. Processing BOM structure...`, 'info');\r\n\r\n                // Show field mapping button\r\n                document.getElementById('mappingButtonSection').classList.remove('hidden');\r\n\r\n                // Check if mappings already exist (e.g., from loaded configuration)\r\n                if (fieldMappings && Object.keys(fieldMappings).length > 0) {\r\n                    // Validate existing mappings against current CSV headers\r\n                    const invalidMappings = Object.values(fieldMappings).filter(\r\n                        col => col && !headers.includes(col)\r\n                    );\r\n\r\n                    if (invalidMappings.length === 0) {\r\n                        // Existing mappings are valid - use them\r\n                        debugLog('success', 'Using pre-loaded field mappings (valid for current CSV)');\r\n                        applyMappingsToUI();\r\n\r\n                        // Auto-process BOM\r\n                        if (rawCSVContent) {\r\n                            debugLog('info', 'Auto-processing BOM with pre-loaded mappings');\r\n                            setTimeout(() => processBOMData(), 500);\r\n                        }\r\n                    } else {\r\n                        // Mappings are invalid - warn user\r\n                        debugLog('warning', `Pre-loaded mappings have ${invalidMappings.length} invalid columns - need to remap`);\r\n                        showMessage('Loaded mappings don\\'t match CSV columns - please configure field mappings', 'warning');\r\n                        fieldMappings = {}; // Clear invalid mappings\r\n                        loadSavedMappings(); // Try localStorage as fallback\r\n                    }\r\n                } else {\r\n                    // No pre-loaded mappings - try to load saved mappings from localStorage\r\n                    loadSavedMappings();\r\n                }\r\n\r\n            } catch (error) {\r\n                debugLog('error', 'Error loading Solidworks CSV', error.toString());\r\n                showMessage('Error loading CSV: ' + error.message, 'danger');\r\n            }\r\n        }\r\n\r\n        // Process BOM Data AFTER mappings are configured\r\n        function processBOMData() {\r\n            debugLog('info', 'Processing BOM data with configured mappings...');\r\n            showMessage('Processing BOM data...', 'info');\r\n\r\n            try {\r\n                if (!rawCSVContent) {\r\n                    showMessage('No CSV file loaded', 'danger');\r\n                    return;\r\n                }\r\n\r\n                // Parse CSV into rows\r\n                const lines = rawCSVContent.split('\\n').map(line => line.trim()).filter(line => line.length > 0);\r\n\r\n                // Get mapped column names from the new simplified structure\r\n                const levelCol = fieldMappings['Level'];\r\n                const partCol = fieldMappings['Number'];\r\n                const descCol = fieldMappings['Description'];\r\n                const detailsCol = fieldMappings['Details'];\r\n                const revisionCol = fieldMappings['Revision'];\r\n                const standardCostCol = fieldMappings['Standard Cost'];\r\n                const qtyCol = fieldMappings['Quantity'];\r\n                const upcCol = fieldMappings['UPC'];\r\n                const uomCol = fieldMappings['UOM'];\r\n                const weightCol = fieldMappings['Weight'];\r\n                const widthCol = fieldMappings['Width'];\r\n                const heightCol = fieldMappings['Height'];\r\n                const lengthCol = fieldMappings['Length'];\r\n                const vendorCol = fieldMappings['Vendor'];\r\n                const vendorNumberCol = fieldMappings['Vendor Number'];\r\n                const vendorCostCol = fieldMappings['Vendor Cost'];\r\n\r\n                debugLog('info', 'Using mapped columns', fieldMappings);\r\n\r\n                // Find column indices\r\n                const levelIndex = levelCol ? solidworksColumns.indexOf(levelCol) : -1;\r\n                const partNumIndex = partCol ? solidworksColumns.indexOf(partCol) : -1;\r\n                const descIndex = descCol ? solidworksColumns.indexOf(descCol) : -1;\r\n                const detailsIndex = detailsCol ? solidworksColumns.indexOf(detailsCol) : -1;\r\n                const revisionIndex = revisionCol ? solidworksColumns.indexOf(revisionCol) : -1;\r\n                const costIndex = standardCostCol ? solidworksColumns.indexOf(standardCostCol) : -1;\r\n                const qtyIndex = qtyCol ? solidworksColumns.indexOf(qtyCol) : -1;\r\n                const upcIndex = upcCol ? solidworksColumns.indexOf(upcCol) : -1;\r\n                const uomIndex = uomCol ? solidworksColumns.indexOf(uomCol) : -1;\r\n                const weightIndex = weightCol ? solidworksColumns.indexOf(weightCol) : -1;\r\n                const widthIndex = widthCol ? solidworksColumns.indexOf(widthCol) : -1;\r\n                const heightIndex = heightCol ? solidworksColumns.indexOf(heightCol) : -1;\r\n                const lengthIndex = lengthCol ? solidworksColumns.indexOf(lengthCol) : -1;\r\n                const vendorIndex = vendorCol ? solidworksColumns.indexOf(vendorCol) : -1;\r\n                const vendorNumIndex = vendorNumberCol ? solidworksColumns.indexOf(vendorNumberCol) : -1;\r\n                const vendorCostIndex = vendorCostCol ? solidworksColumns.indexOf(vendorCostCol) : -1;\r\n\r\n                // Parse data rows\r\n                const bomItems = [];\r\n                for (let i = 1; i < lines.length; i++) {\r\n                    const row = parseCSVLine(lines[i]);\r\n                    if (row.length > 0) {\r\n                        const item = {\r\n                            level: levelIndex >= 0 ? row[levelIndex] : String(i),\r\n                            partNumber: partNumIndex >= 0 ? row[partNumIndex] : '',\r\n                            description: descIndex >= 0 ? row[descIndex] : '',\r\n                            details: detailsIndex >= 0 ? row[detailsIndex] : '',\r\n                            revision: revisionIndex >= 0 ? row[revisionIndex] : '',\r\n                            standardCost: costIndex >= 0 ? row[costIndex] : '',\r\n                            quantity: qtyIndex >= 0 ? row[qtyIndex] : '1',\r\n                            upc: upcIndex >= 0 ? row[upcIndex] : '',\r\n                            uom: uomIndex >= 0 ? row[uomIndex] : 'ea',\r\n                            weight: weightIndex >= 0 ? row[weightIndex] : '',\r\n                            width: widthIndex >= 0 ? row[widthIndex] : '',\r\n                            height: heightIndex >= 0 ? row[heightIndex] : '',\r\n                            length: lengthIndex >= 0 ? row[lengthIndex] : '',\r\n                            vendor: vendorIndex >= 0 ? row[vendorIndex] : '',\r\n                            vendorNumber: vendorNumIndex >= 0 ? row[vendorNumIndex] : '',\r\n                            vendorCost: vendorCostIndex >= 0 ? row[vendorCostIndex] : '',\r\n                            lineNumber: i + 1,\r\n                            rawData: row // Store full row for later use\r\n                        };\r\n                        bomItems.push(item);\r\n                    }\r\n                }\r\n\r\n                debugLog('success', `Parsed ${bomItems.length} BOM items`);\r\n\r\n                // Analyze BOM structure\r\n                analyzeBOMStructure(bomItems);\r\n\r\n                solidworksData = bomItems;\r\n                showMessage(`Successfully processed ${bomItems.length} items from Solidworks BOM`, 'success');\r\n\r\n            } catch (error) {\r\n                debugLog('error', 'Error processing BOM data', error.toString());\r\n                showMessage('Error processing BOM data: ' + error.message, 'danger');\r\n            }\r\n        }\r\n\r\n        // Simple CSV line parser (handles quoted fields)\r\n        function parseCSVLine(line) {\r\n            const result = [];\r\n            let current = '';\r\n            let inQuotes = false;\r\n\r\n            for (let i = 0; i < line.length; i++) {\r\n                const char = line[i];\r\n\r\n                if (char === '\"') {\r\n                    inQuotes = !inQuotes;\r\n                } else if (char === ',' && !inQuotes) {\r\n                    result.push(current.trim());\r\n                    current = '';\r\n                } else {\r\n                    current += char;\r\n                }\r\n            }\r\n\r\n            result.push(current.trim());\r\n            return result;\r\n        }\r\n\r\n        // Analyze BOM structure and extract parts/BOMs\r\n        function analyzeBOMStructure(bomItems) {\r\n            debugLog('info', 'Analyzing BOM structure...');\r\n\r\n            const uniqueParts = new Map();\r\n            const bomStructure = [];\r\n            const bomsByLevel = new Map(); // Track BOMs by their level\r\n\r\n            // First pass: identify all unique parts and potential BOMs\r\n            for (let i = 0; i < bomItems.length; i++) {\r\n                const item = bomItems[i];\r\n                const levelParts = item.level.split('.');\r\n                const depth = levelParts.length;\r\n\r\n                // Track unique parts - preserve ALL fields from the item\r\n                if (item.partNumber && !uniqueParts.has(item.partNumber)) {\r\n                    uniqueParts.set(item.partNumber, {\r\n                        partNumber: item.partNumber,\r\n                        description: item.description,\r\n                        details: item.details,\r\n                        type: item.type,\r\n                        uom: item.uom,\r\n                        upc: item.upc,\r\n                        revision: item.revision,\r\n                        standardCost: item.standardCost,\r\n                        weight: item.weight,\r\n                        width: item.width,\r\n                        height: item.height,\r\n                        length: item.length,\r\n                        vendor: item.vendor,\r\n                        vendorNumber: item.vendorNumber,\r\n                        vendorCost: item.vendorCost\r\n                    });\r\n                }\r\n\r\n                // Check if this item has children (is a BOM parent)\r\n                const hasChildren = i < bomItems.length - 1 &&\r\n                    bomItems[i + 1].level.startsWith(item.level + '.');\r\n\r\n                if (hasChildren) {\r\n                    // This is a BOM/assembly\r\n                    const bom = {\r\n                        level: item.level,\r\n                        partNumber: item.partNumber,\r\n                        description: item.description,\r\n                        uom: item.uom || defaultValues.uom, // Include UOM from item or default\r\n                        items: [],\r\n                        isStage: depth > 1 // Sub-assemblies are stages\r\n                    };\r\n                    bomsByLevel.set(item.level, bom);\r\n                    bomStructure.push(bom);\r\n                }\r\n            }\r\n\r\n            // Second pass: assign items to their parent BOMs\r\n            for (const item of bomItems) {\r\n                const levelParts = item.level.split('.');\r\n\r\n                // Find the parent BOM (one level up)\r\n                if (levelParts.length > 1) {\r\n                    const parentLevel = levelParts.slice(0, -1).join('.');\r\n                    const parentBOM = bomsByLevel.get(parentLevel);\r\n\r\n                    if (parentBOM) {\r\n                        // This item belongs to the parent BOM\r\n                        parentBOM.items.push(item);\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Create wrapper BOM from filename if enabled\r\n            if (config.createBOMFromFilename && csvFilename) {\r\n                debugLog('info', `Creating wrapper BOM from filename: ${csvFilename}`);\r\n\r\n                // Find all top-level BOMs (level without dots)\r\n                const topLevelBOMs = bomStructure.filter(bom => !bom.level.includes('.'));\r\n\r\n                if (topLevelBOMs.length > 0) {\r\n                    // Create wrapper BOM\r\n                    const wrapperBOM = {\r\n                        level: '0',\r\n                        partNumber: csvFilename,\r\n                        description: csvFilename,\r\n                        uom: defaultValues.uom,\r\n                        items: topLevelBOMs.map(bom => ({\r\n                            level: bom.level,\r\n                            partNumber: bom.partNumber,\r\n                            description: bom.description,\r\n                            uom: bom.uom,\r\n                            quantity: '1', // Each top-level BOM is qty 1 in the wrapper\r\n                            type: 'Raw Good' // Top-level BOMs are raw goods in the wrapper BOM\r\n                        })),\r\n                        isStage: false // The wrapper itself is not a stage\r\n                    };\r\n\r\n                    bomsByLevel.set('0', wrapperBOM);\r\n                    bomStructure.push(wrapperBOM);\r\n\r\n                    // Add wrapper's finished good part to uniqueParts if not already present\r\n                    if (!uniqueParts.has(csvFilename)) {\r\n                        uniqueParts.set(csvFilename, {\r\n                            partNumber: csvFilename,\r\n                            description: csvFilename,\r\n                            type: config.createFinishedGoodsAsProducts ? 'Product' : 'Inventory',\r\n                            uom: defaultValues.uom\r\n                        });\r\n                    }\r\n\r\n                    debugLog('success', `Created wrapper BOM \"${csvFilename}\" containing ${topLevelBOMs.length} top-level assemblies`);\r\n                } else {\r\n                    debugLog('warning', 'No top-level BOMs found to wrap');\r\n                }\r\n            }\r\n\r\n            // Filter out parts that already exist in Fishbowl (if validation enabled)\r\n            let allParts = Array.from(uniqueParts.values());\r\n\r\n            // Sort BOMs by depth (deepest first) so stages are created before their parent BOMs\r\n            bomStructure.sort((a, b) => {\r\n                const aDepth = a.level.split('.').length;\r\n                const bDepth = b.level.split('.').length;\r\n                return bDepth - aDepth; // Descending order (deepest first)\r\n            });\r\n\r\n            bomsToCreate = bomStructure;\r\n            debugLog('info', `BOMs sorted by depth for bottom-up creation (deepest first)`);\r\n            if (bomsToCreate.length > 0) {\r\n                debugLog('info', `BOM creation order example: ${bomsToCreate.slice(0, 5).map(b => `${b.level} (${b.partNumber})`).join(', ')}`);\r\n            }\r\n\r\n            // Validate UOMs and apply defaults for parts AND BOM items\r\n            const invalidUOMs = [];\r\n            const missingUOMs = [];\r\n\r\n            // Validate part UOMs\r\n            allParts.forEach(part => {\r\n                // Apply default UOM if missing or empty\r\n                if (!part.uom || part.uom.trim() === '') {\r\n                    part.uom = defaultValues.uom;\r\n                    missingUOMs.push(part.partNumber);\r\n                }\r\n\r\n                // Validate UOM against Fishbowl UOMs (if loaded)\r\n                if (fishbowlData.uoms.length > 0 && !fishbowlData.uoms.includes(part.uom)) {\r\n                    invalidUOMs.push({ partNumber: part.partNumber, uom: part.uom });\r\n                }\r\n            });\r\n\r\n            // Validate BOM item UOMs\r\n            bomsToCreate.forEach(bom => {\r\n                // Validate BOM's own UOM\r\n                if (!bom.uom || bom.uom.trim() === '') {\r\n                    bom.uom = defaultValues.uom;\r\n                }\r\n                if (fishbowlData.uoms.length > 0 && !fishbowlData.uoms.includes(bom.uom)) {\r\n                    invalidUOMs.push({ partNumber: `${bom.partNumber} (BOM)`, uom: bom.uom });\r\n                }\r\n\r\n                // Validate item UOMs\r\n                bom.items.forEach(item => {\r\n                    if (!item.uom || item.uom.trim() === '') {\r\n                        item.uom = defaultValues.uom;\r\n                        missingUOMs.push(`${item.partNumber} (in BOM ${bom.partNumber})`);\r\n                    }\r\n                    if (fishbowlData.uoms.length > 0 && !fishbowlData.uoms.includes(item.uom)) {\r\n                        invalidUOMs.push({ partNumber: `${item.partNumber} (in BOM ${bom.partNumber})`, uom: item.uom });\r\n                    }\r\n                });\r\n            });\r\n\r\n            if (missingUOMs.length > 0) {\r\n                debugLog('info', `Applied default UOM \"${defaultValues.uom}\" to ${missingUOMs.length} items without UOM`);\r\n            }\r\n\r\n            if (invalidUOMs.length > 0) {\r\n                debugLog('warning', `Found ${invalidUOMs.length} items with invalid UOMs (not in Fishbowl)`);\r\n                const uniqueInvalidUOMs = [...new Set(invalidUOMs.map(item => item.uom))];\r\n                showMessage(` Warning: ${invalidUOMs.length} items have invalid UOMs (${uniqueInvalidUOMs.join(', ')}). Create these UOMs in Fishbowl first.`, 'warning');\r\n            }\r\n\r\n            if (config.validatePartsExist && fishbowlData.existingParts.length > 0) {\r\n                const existingPartsSet = new Set(fishbowlData.existingParts);\r\n                const newParts = [];\r\n                const existingParts = [];\r\n\r\n                allParts.forEach(part => {\r\n                    if (existingPartsSet.has(part.partNumber)) {\r\n                        existingParts.push(part);\r\n                    } else {\r\n                        newParts.push(part);\r\n                    }\r\n                });\r\n\r\n                partsToCreate = newParts;\r\n\r\n                debugLog('success', `Parts Analysis: ${allParts.length} total in file, ${existingParts.length} already exist, ${newParts.length} new to create`);\r\n                if (existingParts.length > 0) {\r\n                    showMessage(`Parts: ${allParts.length} total, ${existingParts.length} exist, ${newParts.length} new to create`, 'info');\r\n                }\r\n            } else {\r\n                partsToCreate = allParts;\r\n                debugLog('success', `Parts Analysis: ${partsToCreate.length} total in file, validation ${config.validatePartsExist ? 'pending' : 'disabled'}`);\r\n            }\r\n\r\n            debugLog('success', `BOMs Analysis: ${bomsToCreate.length} BOMs to create/update (will override if exist)`);\r\n\r\n            updateStats({\r\n                total: bomItems.length,\r\n                parts: partsToCreate.length,\r\n                newParts: partsToCreate.length, // Will be refined later\r\n                boms: bomsToCreate.length,\r\n                warnings: 0,\r\n                errors: 0\r\n            });\r\n\r\n            // Show parts section and BOMs section\r\n            displayPartsToCreate();\r\n            displayBOMsToCreate();\r\n\r\n            // Show field mapping button\r\n            document.getElementById('mappingButtonSection').classList.remove('hidden');\r\n        }\r\n\r\n        // Get part cost from CSV data or Fishbowl query\r\n        function getPartCost(partNumber, csvCost) {\r\n            // First try CSV vendor cost\r\n            if (csvCost && csvCost.trim() !== '' && !isNaN(parseFloat(csvCost))) {\r\n                return parseFloat(csvCost);\r\n            }\r\n\r\n            // Fallback to Fishbowl partcost.avgcost query\r\n            if (typeof runQuery === 'function') {\r\n                try {\r\n                    const query = `SELECT pc.avgcost\r\n                                   FROM partcost pc\r\n                                   JOIN part p ON p.id = pc.partid\r\n                                   WHERE p.num = '${partNumber.replace(/'/g, \"''\")}'`;\r\n                    const result = runQuery(query);\r\n                    if (result) {\r\n                        const data = JSON.parse(result);\r\n                        const cost = Array.isArray(data) ? data[0]?.avgcost : data?.avgcost;\r\n                        if (cost && !isNaN(parseFloat(cost))) {\r\n                            return parseFloat(cost);\r\n                        }\r\n                    }\r\n                } catch (error) {\r\n                    // Silently fail - cost will be 0\r\n                }\r\n            }\r\n\r\n            return 0;\r\n        }\r\n\r\n        // Calculate BOM total cost recursively\r\n        function calculateBOMCost(bom, costCache = new Map()) {\r\n            let total = 0;\r\n\r\n            // Calculate cost for all items in this BOM\r\n            for (const item of bom.items) {\r\n                const qty = parseFloat(item.quantity) || 1;\r\n\r\n                // Check if this item is a sub-BOM\r\n                const subBOM = bomsToCreate.find(b => b.level === item.level);\r\n\r\n                if (subBOM) {\r\n                    // Recursive: get the sub-BOM's total cost\r\n                    const subCost = costCache.has(subBOM.level)\r\n                        ? costCache.get(subBOM.level)\r\n                        : calculateBOMCost(subBOM, costCache);\r\n                    costCache.set(subBOM.level, subCost);\r\n                    total += subCost * qty;\r\n                } else {\r\n                    // Regular part: get unit cost and multiply by quantity\r\n                    const unitCost = getPartCost(item.partNumber, item.vendorCost);\r\n                    total += unitCost * qty;\r\n                }\r\n            }\r\n\r\n            return total;\r\n        }\r\n\r\n        // Toggle BOM row expansion\r\n        function toggleBOMRow(bomId) {\r\n            const detailRows = document.querySelectorAll(`.bom-detail-${bomId}`);\r\n            const chevron = document.getElementById(`chevron-${bomId}`);\r\n            const isExpanded = detailRows[0]?.style.display !== 'none';\r\n\r\n            detailRows.forEach(row => {\r\n                row.style.display = isExpanded ? 'none' : 'table-row';\r\n            });\r\n\r\n            if (chevron) {\r\n                chevron.style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0deg)';\r\n            }\r\n        }\r\n\r\n        // Build BOM tree rows recursively\r\n        function buildBOMTreeRows(bom, depth = 0, costCache = new Map(), allRows = []) {\r\n            const bomId = bom.level.replace(/\\./g, '-');\r\n            const indent = depth * 20;\r\n            const bomCost = costCache.has(bom.level)\r\n                ? costCache.get(bom.level)\r\n                : calculateBOMCost(bom, costCache);\r\n            costCache.set(bom.level, bomCost);\r\n\r\n            const bgColor = depth === 0 ? '#e3f2fd' : (depth === 1 ? '#e9ecef' : '#f5f5f5');\r\n\r\n            // BOM quantity defaults to 1 (or could be retrieved from parent if needed)\r\n            const bomQty = 1;\r\n            const bomUnitCost = bomCost; // Cost per unit of this BOM\r\n            const bomTotalCost = bomUnitCost * bomQty;\r\n\r\n            const typeLabel = bom.isStage ? '<span class=\"badge bg-info\" style=\"font-size: 7px;\">Stage</span>' : '<span class=\"badge bg-primary\" style=\"font-size: 7px;\">FG</span>';\r\n\r\n            // BOM header row (clickable to expand/collapse) - matches detail row columns\r\n            allRows.push(`\r\n                <tr class=\"bom-header-row\" style=\"background-color: ${bgColor}; cursor: pointer; font-weight: 500;\" onclick=\"toggleBOMRow('${bomId}')\">\r\n                    <td style=\"padding: 6px 8px; padding-left: ${indent + 8}px;\">\r\n                        <i id=\"chevron-${bomId}\" class=\"bi bi-chevron-right\" style=\"transition: transform 0.2s; display: inline-block;\"></i>\r\n                        <strong style=\"margin-left: 8px;\">${bom.level}</strong>\r\n                    </td>\r\n                    <td style=\"padding: 6px 8px;\">${bom.partNumber}</td>\r\n                    <td style=\"padding: 6px 8px;\">${bom.description || bom.partNumber} ${typeLabel}</td>\r\n                    <td style=\"padding: 6px 8px; text-align: right;\">${bomQty}</td>\r\n                    <td style=\"padding: 6px 8px;\">${bom.uom || 'ea'}</td>\r\n                    <td style=\"padding: 6px 8px; text-align: right; font-weight: 600;\">$${bomUnitCost.toFixed(2)}</td>\r\n                    <td style=\"padding: 6px 8px; text-align: right; font-weight: 600; color: #198754;\">$${bomTotalCost.toFixed(2)}</td>\r\n                </tr>\r\n            `);\r\n\r\n            // Component rows - iterate through items and inline sub-BOMs\r\n            for (const item of bom.items) {\r\n                // Special handling for wrapper BOM (level 0) - directly recurse into top-level BOMs\r\n                if (bom.level === '0') {\r\n                    // Find the actual BOM object for this top-level BOM\r\n                    const topLevelBOM = bomsToCreate.find(b =>\r\n                        b.partNumber === item.partNumber && b.level === item.level\r\n                    );\r\n\r\n                    if (topLevelBOM) {\r\n                        // Recursively render this top-level BOM with wrapper's detail class\r\n                        const nestedRows = [];\r\n                        buildBOMTreeRows(topLevelBOM, depth + 1, costCache, nestedRows);\r\n\r\n                        // Add all rows with parent's detail class\r\n                        nestedRows.forEach(row => {\r\n                            if (row.includes('class=\"')) {\r\n                                allRows.push(row.replace('class=\"', `class=\"bom-detail-${bomId} `));\r\n                            } else {\r\n                                allRows.push(row.replace('<tr ', `<tr class=\"bom-detail-${bomId}\" `));\r\n                            }\r\n                        });\r\n                        continue; // Skip the regular item rendering below\r\n                    }\r\n                }\r\n\r\n                const subBOM = bomsToCreate.find(b => b.level === item.level);\r\n\r\n                if (subBOM) {\r\n                    // This item is a sub-BOM - render it inline as a nested BOM with its own expand/collapse\r\n                    // Add it to the parent's detail class so it shows/hides with parent\r\n                    const subBomId = subBOM.level.replace(/\\./g, '-');\r\n                    const subIndent = (depth + 1) * 20;\r\n                    const subBomCost = costCache.has(subBOM.level)\r\n                        ? costCache.get(subBOM.level)\r\n                        : calculateBOMCost(subBOM, costCache);\r\n                    costCache.set(subBOM.level, subBomCost);\r\n\r\n                    const qty = parseFloat(item.quantity) || 1;\r\n                    const extended = subBomCost * qty;\r\n                    const subBgColor = depth === 0 ? '#e9ecef' : '#f5f5f5';\r\n\r\n                    // Display badge based on item type (Raw Good vs Stage)\r\n                    const itemType = item.type || 'Stage';\r\n                    const subTypeLabel = itemType === 'Raw Good'\r\n                        ? '<span class=\"badge bg-success\" style=\"font-size: 7px;\">Raw Good</span>'\r\n                        : '<span class=\"badge bg-info\" style=\"font-size: 7px;\">Stage</span>';\r\n\r\n                    // Sub-BOM header row (part of parent's detail)\r\n                    allRows.push(`\r\n                        <tr class=\"bom-detail-${bomId} bom-header-row\" style=\"display: none; background-color: ${subBgColor}; cursor: pointer; font-weight: 500;\" onclick=\"toggleBOMRow('${subBomId}')\">\r\n                            <td style=\"padding: 6px 8px; padding-left: ${subIndent + 8}px;\">\r\n                                <i id=\"chevron-${subBomId}\" class=\"bi bi-chevron-right\" style=\"transition: transform 0.2s; display: inline-block;\"></i>\r\n                                <strong style=\"margin-left: 8px;\">${subBOM.level}</strong>\r\n                            </td>\r\n                            <td style=\"padding: 6px 8px;\">${subBOM.partNumber}</td>\r\n                            <td style=\"padding: 6px 8px;\">${subBOM.description || subBOM.partNumber} ${subTypeLabel}</td>\r\n                            <td style=\"padding: 6px 8px; text-align: right;\">${qty}</td>\r\n                            <td style=\"padding: 6px 8px;\">${subBOM.uom || 'ea'}</td>\r\n                            <td style=\"padding: 6px 8px; text-align: right; font-weight: 600;\">$${subBomCost.toFixed(2)}</td>\r\n                            <td style=\"padding: 6px 8px; text-align: right; font-weight: 600; color: #198754;\">$${extended.toFixed(2)}</td>\r\n                        </tr>\r\n                    `);\r\n\r\n                    // Recursively add sub-BOM's components\r\n                    for (const subItem of subBOM.items) {\r\n                        const nestedSubBOM = bomsToCreate.find(b => b.level === subItem.level);\r\n\r\n                        if (nestedSubBOM) {\r\n                            // Another level of nesting - recursively call buildBOMTreeRows\r\n                            const nestedRows = [];\r\n                            buildBOMTreeRows(nestedSubBOM, depth + 2, costCache, nestedRows);\r\n                            // Add nested rows with both parent detail classes\r\n                            nestedRows.forEach(row => {\r\n                                if (row.includes('class=\"')) {\r\n                                    allRows.push(row.replace('class=\"', `class=\"bom-detail-${bomId} bom-detail-${subBomId} `));\r\n                                } else {\r\n                                    allRows.push(row.replace('<tr ', `<tr class=\"bom-detail-${bomId} bom-detail-${subBomId}\" `));\r\n                                }\r\n                            });\r\n                        } else {\r\n                            // Regular component of sub-BOM\r\n                            const subItemQty = parseFloat(subItem.quantity) || 1;\r\n                            const subItemUnitCost = getPartCost(subItem.partNumber, subItem.vendorCost);\r\n                            const subItemExtended = subItemUnitCost * subItemQty;\r\n\r\n                            allRows.push(`\r\n                                <tr class=\"bom-detail-${bomId} bom-detail-${subBomId}\" style=\"display: none; background-color: white;\">\r\n                                    <td style=\"padding: 4px 8px; padding-left: ${subIndent + 40}px; font-size: 10pt;\">${subItem.level}</td>\r\n                                    <td style=\"padding: 4px 8px; font-size: 10pt;\">${subItem.partNumber}</td>\r\n                                    <td style=\"padding: 4px 8px; font-size: 10pt;\">${subItem.description || ''}</td>\r\n                                    <td style=\"padding: 4px 8px; text-align: right; font-size: 10pt;\">${subItemQty}</td>\r\n                                    <td style=\"padding: 4px 8px; font-size: 10pt;\">${subItem.uom || 'ea'}</td>\r\n                                    <td style=\"padding: 4px 8px; text-align: right; font-size: 10pt;\">$${subItemUnitCost.toFixed(2)}</td>\r\n                                    <td style=\"padding: 4px 8px; text-align: right; font-size: 10pt;\">$${subItemExtended.toFixed(2)}</td>\r\n                                </tr>\r\n                            `);\r\n                        }\r\n                    }\r\n\r\n                    // Sub-BOM subtotal row\r\n                    allRows.push(`\r\n                        <tr class=\"bom-detail-${bomId} bom-detail-${subBomId}\" style=\"display: none; background-color: #e8f4f8; border-top: 1px solid #b3d9e8;\">\r\n                            <td colspan=\"6\" style=\"padding: 6px 8px; padding-left: ${subIndent + 40}px; font-size: 9.5pt; font-weight: 500; text-align: right;\">\r\n                                BOM ${subBOM.level} Subtotal:\r\n                            </td>\r\n                            <td style=\"padding: 6px 8px; text-align: right; font-size: 10pt; font-weight: 600; color: #0c5460;\">\r\n                                $${subBomCost.toFixed(2)}\r\n                            </td>\r\n                        </tr>\r\n                    `);\r\n                } else {\r\n                    // Regular component - render as detail row\r\n                    const qty = parseFloat(item.quantity) || 1;\r\n                    const unitCost = getPartCost(item.partNumber, item.vendorCost);\r\n                    const extended = unitCost * qty;\r\n\r\n                    allRows.push(`\r\n                        <tr class=\"bom-detail-${bomId}\" style=\"display: none; background-color: white;\">\r\n                            <td style=\"padding: 4px 8px; padding-left: ${indent + 40}px; font-size: 10pt;\">${item.level}</td>\r\n                            <td style=\"padding: 4px 8px; font-size: 10pt;\">${item.partNumber}</td>\r\n                            <td style=\"padding: 4px 8px; font-size: 10pt;\">${item.description || ''}</td>\r\n                            <td style=\"padding: 4px 8px; text-align: right; font-size: 10pt;\">${qty}</td>\r\n                            <td style=\"padding: 4px 8px; font-size: 10pt;\">${item.uom || 'ea'}</td>\r\n                            <td style=\"padding: 4px 8px; text-align: right; font-size: 10pt;\">$${unitCost.toFixed(2)}</td>\r\n                            <td style=\"padding: 4px 8px; text-align: right; font-size: 10pt;\">$${extended.toFixed(2)}</td>\r\n                        </tr>\r\n                    `);\r\n                }\r\n            }\r\n\r\n            // Add subtotal row showing breakdown\r\n            allRows.push(`\r\n                <tr class=\"bom-detail-${bomId}\" style=\"display: none; background-color: #e8f4f8; border-top: 1px solid #b3d9e8;\">\r\n                    <td colspan=\"6\" style=\"padding: 6px 8px; padding-left: ${indent + 40}px; font-size: 9.5pt; font-weight: 500; text-align: right;\">\r\n                        BOM ${bom.level} Subtotal:\r\n                    </td>\r\n                    <td style=\"padding: 6px 8px; text-align: right; font-size: 10pt; font-weight: 600; color: #0c5460;\">\r\n                        $${bomCost.toFixed(2)}\r\n                    </td>\r\n                </tr>\r\n            `);\r\n\r\n            return allRows;\r\n        }\r\n\r\n        // Display BOMs as hierarchical tree table\r\n        function displayBOMsToCreate() {\r\n            // Find the container - use the results-table-container div\r\n            const tableContainer = document.querySelector('#bomsContent .results-table-container');\r\n            if (!tableContainer) {\r\n                debugLog('error', 'Could not find BOM table container');\r\n                return;\r\n            }\r\n\r\n            // Calculate all costs first\r\n            const costCache = new Map();\r\n            let grandTotal = 0;\r\n\r\n            // Check if wrapper BOM exists (level \"0\") - if so, only count it as top-level\r\n            const hasWrapperBOM = bomsToCreate.some(bom => bom.level === '0');\r\n            const realTopLevelBOMs = hasWrapperBOM\r\n                ? bomsToCreate.filter(bom => bom.level === '0')\r\n                : bomsToCreate.filter(bom => !bom.level.includes('.'));\r\n\r\n            realTopLevelBOMs.forEach(bom => {\r\n                const cost = calculateBOMCost(bom, costCache);\r\n                grandTotal += cost;\r\n            });\r\n\r\n            // Build table structure\r\n            let html = `\r\n                <table class=\"table table-sm table-hover mb-0\" style=\"font-size: 10.5pt;\">\r\n                    <thead style=\"background-color: #e3f2fd; position: sticky; top: 0; z-index: 10;\">\r\n                        <tr>\r\n                            <th style=\"padding: 8px; width: 100px;\">Level</th>\r\n                            <th style=\"padding: 8px; width: 150px;\">Part Number</th>\r\n                            <th style=\"padding: 8px;\">Description</th>\r\n                            <th style=\"padding: 8px; width: 60px; text-align: right;\">Qty</th>\r\n                            <th style=\"padding: 8px; width: 60px;\">UOM</th>\r\n                            <th style=\"padding: 8px; width: 100px; text-align: right;\">Unit Cost</th>\r\n                            <th style=\"padding: 8px; width: 100px; text-align: right;\">Total Cost</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>`;\r\n\r\n            // Build hierarchical rows - only for top-level BOMs (sub-BOMs are inlined)\r\n            const allRows = [];\r\n            const topLevelBOMs = realTopLevelBOMs;\r\n\r\n            // Build each top-level BOM (sub-BOMs are nested inline within buildBOMTreeRows)\r\n            topLevelBOMs.forEach(bom => buildBOMTreeRows(bom, 0, costCache, allRows));\r\n\r\n            html += allRows.join('');\r\n\r\n            // Add grand total row\r\n            html += `\r\n                        <tr style=\"background-color: #d1ecf1; font-weight: bold; border-top: 2px solid #0c5460;\">\r\n                            <td colspan=\"6\" style=\"padding: 10px 8px; text-align: right; font-size: 11pt;\">TOTAL ESTIMATED COST:</td>\r\n                            <td style=\"padding: 10px 8px; text-align: right; font-size: 12pt; color: #0c5460;\">$${grandTotal.toFixed(2)}</td>\r\n                        </tr>\r\n                    </tbody>\r\n                </table>`;\r\n\r\n            // Replace content\r\n            tableContainer.innerHTML = html;\r\n\r\n            // Update count in accordion header\r\n            document.getElementById('bomsCount').textContent = bomsToCreate.length;\r\n\r\n            if (bomsToCreate.length > 0) {\r\n                document.getElementById('bomsSection').classList.remove('hidden');\r\n            }\r\n        }\r\n\r\n        // Load Fishbowl data (UOMs, Vendors, Tax Codes, etc.)\r\n        function loadFishbowlData() {\r\n            debugLog('info', 'Loading Fishbowl data (UOMs, Vendors, Tax Codes)...');\r\n\r\n            try {\r\n                // Load UOMs\r\n                debugLog('info', 'Loading UOMs...');\r\n                const uomQuery = `SELECT code, name, uomtype FROM uom WHERE activeflag = 1 ORDER BY code`;\r\n                const uomResult = runQuery(uomQuery);\r\n\r\n                if (uomResult) {\r\n                    let uoms = JSON.parse(uomResult);\r\n                    if (uoms && !Array.isArray(uoms)) uoms = [uoms];\r\n                    fishbowlData.uoms = uoms.map(u => u.code);\r\n                    fishbowlData.uomDetails = uoms;\r\n                    debugLog('success', `Loaded ${fishbowlData.uoms.length} UOMs`);\r\n                } else {\r\n                    debugLog('warning', 'No UOMs loaded from Fishbowl');\r\n                    fishbowlData.uoms = [];\r\n                    fishbowlData.uomDetails = [];\r\n                }\r\n\r\n                // Load Vendors\r\n                debugLog('info', 'Loading Vendors...');\r\n                const vendorQuery = `SELECT name FROM vendor WHERE activeflag = 1 ORDER BY name`;\r\n                const vendorResult = runQuery(vendorQuery);\r\n\r\n                if (vendorResult) {\r\n                    let vendors = JSON.parse(vendorResult);\r\n                    if (vendors && !Array.isArray(vendors)) vendors = [vendors];\r\n                    fishbowlData.vendors = vendors.map(v => v.name);\r\n                    debugLog('success', `Loaded ${fishbowlData.vendors.length} Vendors`);\r\n                } else {\r\n                    debugLog('warning', 'No Vendors loaded from Fishbowl');\r\n                    fishbowlData.vendors = [];\r\n                }\r\n\r\n                // Load Tax Codes\r\n                debugLog('info', 'Loading Tax Codes...');\r\n                const taxQuery = `SELECT code, name FROM taxrate WHERE activeflag = 1 ORDER BY code`;\r\n                const taxResult = runQuery(taxQuery);\r\n\r\n                if (taxResult) {\r\n                    let taxCodes = JSON.parse(taxResult);\r\n                    if (taxCodes && !Array.isArray(taxCodes)) taxCodes = [taxCodes];\r\n                    fishbowlData.taxCodes = taxCodes.map(t => t.code);\r\n                    fishbowlData.taxCodeDetails = taxCodes; // Store full details\r\n                    debugLog('success', `Loaded ${fishbowlData.taxCodes.length} Tax Codes`);\r\n                } else {\r\n                    debugLog('warning', 'No Tax Codes loaded from Fishbowl');\r\n                    fishbowlData.taxCodes = [];\r\n                    fishbowlData.taxCodeDetails = [];\r\n                }\r\n\r\n                // Load Existing Parts (for validation)\r\n                debugLog('info', 'Loading existing parts from Fishbowl...');\r\n                const partsQuery = `SELECT num FROM part WHERE activeflag = 1`;\r\n                const partsResult = runQuery(partsQuery);\r\n\r\n                if (partsResult) {\r\n                    let parts = JSON.parse(partsResult);\r\n                    if (parts && !Array.isArray(parts)) parts = [parts];\r\n                    fishbowlData.existingParts = parts.map(p => p.num);\r\n                    debugLog('success', `Loaded ${fishbowlData.existingParts.length} existing parts from Fishbowl`);\r\n                } else {\r\n                    debugLog('warning', 'No existing parts loaded from Fishbowl');\r\n                    fishbowlData.existingParts = [];\r\n                }\r\n\r\n                // Populate settings dropdowns if they exist\r\n                populateSettingsDropdowns();\r\n\r\n                return true;\r\n\r\n            } catch (error) {\r\n                debugLog('error', 'Error loading Fishbowl data', error.toString());\r\n                showMessage('Warning: Could not load data from Fishbowl', 'warning');\r\n                return false;\r\n            }\r\n        }\r\n\r\n        // Field Mapping Functions\r\n        function openFieldMappingDialog() {\r\n            debugLog('info', 'User requested to open field mapping dialog');\r\n\r\n            // Load Fishbowl data if not already loaded\r\n            if (fishbowlData.uoms.length === 0 || fishbowlData.vendors.length === 0) {\r\n                debugLog('info', 'Fishbowl data not loaded yet - loading...');\r\n                showMessage('Loading UOMs and Vendors from Fishbowl...', 'info');\r\n                loadFishbowlData();\r\n            }\r\n\r\n            // Populate the mapping UI\r\n            populateFieldMappings();\r\n\r\n            // Show the modal\r\n            const modalElement = document.getElementById('fieldMappingModal');\r\n            const modal = new bootstrap.Modal(modalElement);\r\n            modal.show();\r\n        }\r\n\r\n        function populateFieldMappings() {\r\n            debugLog('info', 'Populating field mapping UI with simplified BOM fields');\r\n            debugLog('info', `Solidworks columns count: ${solidworksColumns.length}`, solidworksColumns);\r\n\r\n            if (solidworksColumns.length === 0) {\r\n                debugLog('error', 'Solidworks columns are empty!');\r\n                showMessage('No Solidworks columns detected. Please upload a valid CSV file.', 'danger');\r\n                return;\r\n            }\r\n\r\n            // Clear existing mappings\r\n            const bomMappingsDiv = document.getElementById('bomLevelMappings');\r\n            const itemMappingsDiv = document.getElementById('itemLevelMappings');\r\n            bomMappingsDiv.innerHTML = '';\r\n            itemMappingsDiv.innerHTML = '';\r\n\r\n            // Create mapping rows for each BOM field\r\n            let rowCount = 0;\r\n            Object.keys(bomFieldDefinitions).forEach((field, index) => {\r\n                const fieldDef = bomFieldDefinitions[field];\r\n                const isRequired = fieldDef.required;\r\n                const row = createMappingRow(field, isRequired, 'bom', index, fieldDef.desc);\r\n                bomMappingsDiv.appendChild(row);\r\n                rowCount++;\r\n            });\r\n\r\n            debugLog('success', `Created ${rowCount} BOM field mapping rows`);\r\n        }\r\n\r\n        function createMappingRow(fishbowlField, isRequired, level, index, description) {\r\n            const row = document.createElement('div');\r\n            row.className = 'mapping-row';\r\n\r\n            const labelDiv = document.createElement('div');\r\n            labelDiv.className = 'mapping-label';\r\n\r\n            const labelText = document.createElement('div');\r\n            if (isRequired) {\r\n                labelText.classList.add('required-field');\r\n            }\r\n            labelText.textContent = fishbowlField;\r\n            labelDiv.appendChild(labelText);\r\n\r\n            if (description) {\r\n                const descText = document.createElement('small');\r\n                descText.className = 'text-muted d-block';\r\n                descText.style.fontSize = '11px';\r\n                descText.style.fontWeight = 'normal';\r\n                descText.textContent = description;\r\n                labelDiv.appendChild(descText);\r\n            }\r\n\r\n            const arrow = document.createElement('div');\r\n            arrow.className = 'mapping-arrow';\r\n            arrow.innerHTML = '<i class=\"bi bi-arrow-left\"></i>';\r\n\r\n            const select = document.createElement('select');\r\n            select.className = 'mapping-select form-select';\r\n            select.id = `mapping-${level}-${index}`;\r\n            select.dataset.field = fishbowlField;\r\n            select.dataset.level = level;\r\n            select.dataset.required = isRequired;\r\n\r\n            // Add \"None\" option\r\n            const noneOption = document.createElement('option');\r\n            noneOption.value = '';\r\n            noneOption.textContent = '-- None --';\r\n            select.appendChild(noneOption);\r\n\r\n            // Add Solidworks column options\r\n            solidworksColumns.forEach(col => {\r\n                const option = document.createElement('option');\r\n                option.value = col;\r\n                option.textContent = col;\r\n\r\n                // Check if we have a loaded mapping for this field (takes priority)\r\n                if (fieldMappings[fishbowlField] && fieldMappings[fishbowlField] === col) {\r\n                    option.selected = true;\r\n                }\r\n                // Otherwise, try to auto-match based on field name similarity\r\n                else if (!fieldMappings[fishbowlField] && autoMatchField(fishbowlField, col)) {\r\n                    option.selected = true;\r\n                }\r\n\r\n                select.appendChild(option);\r\n            });\r\n\r\n            row.appendChild(labelDiv);\r\n            row.appendChild(arrow);\r\n            row.appendChild(select);\r\n\r\n            return row;\r\n        }\r\n\r\n        function autoMatchField(fishbowlField, solidworksColumn) {\r\n            const fb = fishbowlField.toLowerCase();\r\n            const sw = solidworksColumn.toLowerCase();\r\n\r\n            // Direct matches\r\n            if (fb === sw) return true;\r\n\r\n            // Common mappings\r\n            const mappings = {\r\n                'level': ['level', 'item', 'line'],\r\n                'number': ['p/n', 'part', 'number', 'part number', 'partnumber', 'part num', 'pn', 'item'],\r\n                'description': ['description', 'desc', 'name'],\r\n                'details': ['details', 'notes', 'comments'],\r\n                'revision': ['revision', 'rev', 'version'],\r\n                'standard cost': ['cost', 'standard cost', 'unit cost'],\r\n                'quantity': ['qty', 'quantity', 'amount', 'qnty'],\r\n                'upc': ['upc', 'barcode', 'ean'],\r\n                'uom': ['uom', 'unit', 'units', 'u/m'],\r\n                'weight': ['weight', 'wt', 'mass'],\r\n                'width': ['width', 'w'],\r\n                'height': ['height', 'h'],\r\n                'length': ['length', 'l', 'len'],\r\n                'vendor': ['vendor', 'supplier', 'mfg', 'manufacturer'],\r\n                'vendor number': ['vendor number', 'vendor p/n', 'vendor part', 'mfg part'],\r\n                'vendor cost': ['vendor cost', 'purchase cost', 'buy cost']\r\n            };\r\n\r\n            if (mappings[fb]) {\r\n                return mappings[fb].some(match => sw.includes(match));\r\n            }\r\n\r\n            return false;\r\n        }\r\n\r\n        function saveMappings() {\r\n            debugLog('info', 'Saving field mappings...');\r\n\r\n            const mappings = {};\r\n\r\n            // Collect all field mappings\r\n            const allSelects = document.querySelectorAll('select[data-level=\"bom\"]');\r\n            let hasErrors = false;\r\n\r\n            allSelects.forEach(select => {\r\n                const field = select.dataset.field;\r\n                const isRequired = select.dataset.required === 'true';\r\n                const value = select.value;\r\n\r\n                if (isRequired && !value) {\r\n                    showMessage(`Required field \"${field}\" must be mapped`, 'danger');\r\n                    select.classList.add('is-invalid');\r\n                    hasErrors = true;\r\n                } else {\r\n                    select.classList.remove('is-invalid');\r\n                    if (value) {\r\n                        mappings[field] = value;\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (hasErrors) {\r\n                debugLog('error', 'Field mapping validation failed - required fields missing');\r\n                return;\r\n            }\r\n\r\n            fieldMappings = mappings;\r\n            debugLog('success', 'Field mappings saved', fieldMappings);\r\n\r\n            // Save to localStorage for future use\r\n            saveMappingToLocalStorage(mappings);\r\n\r\n            showMessage('Field mappings saved successfully', 'success');\r\n\r\n            // Close the modal\r\n            const modal = bootstrap.Modal.getInstance(document.getElementById('fieldMappingModal'));\r\n            modal.hide();\r\n\r\n            // Now process the BOM data with the configured mappings\r\n            processBOMData();\r\n        }\r\n\r\n        // Save mapping to localStorage\r\n        function saveMappingToLocalStorage(mappings) {\r\n            try {\r\n                const mappingData = {\r\n                    mappings: mappings,\r\n                    solidworksColumns: solidworksColumns,\r\n                    timestamp: new Date().toISOString()\r\n                };\r\n                localStorage.setItem(MAPPING_STORAGE_KEY, JSON.stringify(mappingData));\r\n                debugLog('success', 'Mappings saved to browser storage');\r\n            } catch (e) {\r\n                if (e.name === 'SecurityError') {\r\n                    debugLog('info', 'localStorage not available (running in restricted context)');\r\n                } else {\r\n                    debugLog('warning', 'Could not save mappings to localStorage', e.toString());\r\n                }\r\n            }\r\n        }\r\n\r\n        // Load saved mappings from localStorage\r\n        function loadSavedMappings() {\r\n            try {\r\n                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);\r\n                if (saved) {\r\n                    const mappingData = JSON.parse(saved);\r\n                    debugLog('info', 'Found saved mappings from ' + mappingData.timestamp);\r\n\r\n                    // Check if the columns match\r\n                    const savedCols = mappingData.solidworksColumns || [];\r\n                    const currentCols = solidworksColumns;\r\n\r\n                    const colsMatch = savedCols.length === currentCols.length &&\r\n                        savedCols.every((col, i) => col === currentCols[i]);\r\n\r\n                    if (colsMatch) {\r\n                        debugLog('success', 'Saved mappings match current CSV columns - auto-loading');\r\n                        fieldMappings = mappingData.mappings;\r\n\r\n                        // Apply mappings to UI dropdowns\r\n                        applyMappingsToUI();\r\n\r\n                        showMessage('Loaded saved field mappings from previous session', 'success');\r\n\r\n                        // Auto-process if we have CSV\r\n                        if (rawCSVContent) {\r\n                            debugLog('info', 'Auto-processing BOM with saved mappings');\r\n                            setTimeout(() => processBOMData(), 500);\r\n                        }\r\n                    } else {\r\n                        debugLog('warning', 'Saved mappings do not match current CSV columns');\r\n                        showMessage('Found saved mappings but column structure has changed', 'warning');\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                if (e.name === 'SecurityError') {\r\n                    debugLog('info', 'localStorage not available (running in restricted context)');\r\n                } else {\r\n                    debugLog('error', 'Error loading saved mappings', e.toString());\r\n                }\r\n            }\r\n        }\r\n\r\n        // Export mapping to JSON file\r\n        function exportMappingFile() {\r\n            const mappingData = {\r\n                mappings: fieldMappings,\r\n                solidworksColumns: solidworksColumns,\r\n                bomLevelHeaders: bomLevelHeaders,\r\n                itemLevelHeaders: itemLevelHeaders,\r\n                timestamp: new Date().toISOString(),\r\n                version: '1.0'\r\n            };\r\n\r\n            const content = JSON.stringify(mappingData, null, 2);\r\n            downloadCSV(content, 'bom_field_mappings.json');\r\n            debugLog('success', 'Mapping configuration exported');\r\n        }\r\n\r\n        // Import mapping from JSON file\r\n        function importMappingFile() {\r\n            const input = document.createElement('input');\r\n            input.type = 'file';\r\n            input.accept = '.json';\r\n\r\n            input.onchange = function(e) {\r\n                const file = e.target.files[0];\r\n                if (!file) return;\r\n\r\n                const reader = new FileReader();\r\n                reader.onload = function(event) {\r\n                    try {\r\n                        const mappingData = JSON.parse(event.target.result);\r\n                        fieldMappings = mappingData.mappings;\r\n                        debugLog('success', 'Mapping configuration imported from file');\r\n\r\n                        showMessage('Field mappings imported successfully! Open \"Configure Field Mapping\" to see the loaded mappings.', 'success');\r\n\r\n                        // Apply the mappings if we have data\r\n                        if (rawCSVContent) {\r\n                            processBOMData();\r\n                        }\r\n                    } catch (err) {\r\n                        debugLog('error', 'Error parsing mapping file: ' + err.toString());\r\n                        showMessage('Error importing mapping file: ' + err.message, 'danger');\r\n                    }\r\n                };\r\n                reader.readAsText(file);\r\n            };\r\n\r\n            input.click();\r\n        }\r\n\r\n        // Apply loaded mappings to the UI dropdowns\r\n        function applyMappingsToUI() {\r\n            debugLog('info', 'Applying loaded mappings to UI');\r\n\r\n            // Find all mapping dropdowns\r\n            const allSelects = document.querySelectorAll('select[data-level=\"bom\"]');\r\n\r\n            allSelects.forEach(select => {\r\n                const field = select.dataset.field;\r\n\r\n                // If we have a mapping for this field, set the dropdown value\r\n                if (fieldMappings[field]) {\r\n                    select.value = fieldMappings[field];\r\n                    debugLog('info', `Set ${field} -> ${fieldMappings[field]}`);\r\n                }\r\n            });\r\n\r\n            debugLog('success', 'Applied mappings to UI dropdowns');\r\n        }\r\n\r\n        // Display parts to create in table\r\n        function displayPartsToCreate() {\r\n            const tbody = document.getElementById('partsTableBody');\r\n            tbody.innerHTML = '';\r\n\r\n            for (const part of partsToCreate) {\r\n                const row = document.createElement('tr');\r\n                row.innerHTML = `\r\n                    <td>${part.partNumber}</td>\r\n                    <td>${part.description}</td>\r\n                    <td>${part.uom || 'ea'}</td>\r\n                    <td>${config.createAsInventory ? 'Inventory' : (part.type || 'Inventory')}</td>\r\n                    <td><span class=\"badge bg-warning\">To Create</span></td>\r\n                `;\r\n                tbody.appendChild(row);\r\n            }\r\n\r\n            // Update count in accordion header\r\n            document.getElementById('partsCount').textContent = partsToCreate.length;\r\n\r\n            document.getElementById('partsSection').classList.remove('hidden');\r\n            document.getElementById('exportSection').classList.remove('hidden');\r\n        }\r\n\r\n        // Export functions\r\n        function exportPartImport() {\r\n            debugLog('info', 'Starting Part/Product/Vendor Pricing CSV export...');\r\n\r\n            if (partsToCreate.length === 0) {\r\n                showMessage('No parts to export', 'warning');\r\n                return;\r\n            }\r\n\r\n            try {\r\n                // PPP Import format with all key fields from Fishbowl documentation\r\n                // Required fields: PartNumber, PartDescription, UOM, PartTypeID, Active, PartTaxCode\r\n                const headers = [\r\n                    'PartNumber', 'PartDescription', 'PartDetails', 'UOM', 'UPC',\r\n                    'PartTypeID', 'Active', 'PartTaxCode', 'StdCost', 'ABCCode',\r\n                    'Weight', 'WeightUOM', 'Width', 'Height', 'Len', 'SizeUOM',\r\n                    'PartRevision', 'PartURL',\r\n                    // Product columns (for parts created as Products)\r\n                    'ProductNum', 'ProductDescription', 'ProductDetails', 'ProductPrice', 'ProductTaxable',\r\n                    'ProductIncomeAccount', 'ProductDefaultSOItemType', 'ProductAlertNote', 'ProductImageUrl',\r\n                    // Vendor columns\r\n                    'Vendor', 'VendorPartNumber', 'Cost', 'VendorUOM', 'DefaultVendor'\r\n                ];\r\n                const rows = [];\r\n\r\n                // Header row\r\n                rows.push(headers.map(h => `\"${h}\"`).join(','));\r\n\r\n                // Data rows\r\n                for (const part of partsToCreate) {\r\n                    // Map part type to PartTypeID (10=INVENTORY by default)\r\n                    let partTypeID = '10'; // 10=INVENTORY (default)\r\n                    if (!config.createAsInventory && part.type) {\r\n                        const typeMap = {\r\n                            'Inventory': '10',\r\n                            'Service': '20',\r\n                            'Labor': '21',\r\n                            'Overhead': '22',\r\n                            'Non-Inventory': '30',\r\n                            'Internal Use': '40',\r\n                            'Capital Equipment': '50',\r\n                            'Shipping': '60'\r\n                        };\r\n                        partTypeID = typeMap[part.type] || '10';\r\n                    }\r\n\r\n                    // Determine if this part should have product data\r\n                    const isProduct = part.type === 'Product';\r\n\r\n                    const row = [\r\n                        part.partNumber || '',\r\n                        part.description || '',\r\n                        part.details || '',\r\n                        part.uom || defaultValues.uom,\r\n                        part.upc || '',\r\n                        partTypeID, // PartTypeID (required)\r\n                        'true', // Active\r\n                        defaultValues.taxCode, // PartTaxCode\r\n                        part.standardCost || '', // StdCost\r\n                        'B', // ABCCode (default to B)\r\n                        part.weight || '',\r\n                        part.weight ? defaultValues.weightUOM : '', // WeightUOM\r\n                        part.width || '',\r\n                        part.height || '',\r\n                        part.length || '',\r\n                        (part.width || part.height || part.length) ? defaultValues.sizeUOM : '', // SizeUOM\r\n                        part.revision || '',\r\n                        '', // PartURL\r\n                        // Product columns (populate if this is a Product)\r\n                        isProduct ? part.partNumber : '', // ProductNum (same as part number)\r\n                        isProduct ? part.description : '', // ProductDescription (same as part description)\r\n                        isProduct ? (part.details || '') : '', // ProductDetails\r\n                        isProduct ? (part.productPrice || '') : '', // ProductPrice (optional - can be set later)\r\n                        isProduct ? 'true' : '', // ProductTaxable (default to true for products)\r\n                        isProduct ? '' : '', // ProductIncomeAccount (optional)\r\n                        isProduct ? '10' : '', // ProductDefaultSOItemType (10=Sale, optional)\r\n                        isProduct ? '' : '', // ProductAlertNote (optional)\r\n                        isProduct ? '' : '', // ProductImageUrl (optional)\r\n                        // Vendor columns\r\n                        part.vendor || '',\r\n                        part.vendorNumber || '',\r\n                        part.vendorCost || '',\r\n                        part.vendor ? (part.uom || defaultValues.uom) : '', // VendorUOM\r\n                        part.vendor ? 'true' : '' // DefaultVendor\r\n                    ];\r\n                    rows.push(row.map(v => `\"${v}\"`).join(','));\r\n                }\r\n\r\n                const csvContent = rows.join('\\n');\r\n                debugLog('success', `Generated Part/Product/Vendor Pricing CSV with ${partsToCreate.length} parts`);\r\n\r\n                downloadCSV(csvContent, 'part_product_vendor_pricing.csv');\r\n                showMessage(`Exported ${partsToCreate.length} parts in PPP format`, 'success');\r\n\r\n            } catch (error) {\r\n                debugLog('error', 'Error generating Part Import CSV', error.toString());\r\n                showMessage('Error generating Part Import CSV: ' + error.message, 'danger');\r\n            }\r\n        }\r\n\r\n        function exportBOMImport() {\r\n            debugLog('info', 'Starting BOM Import CSV export...');\r\n\r\n            if (bomsToCreate.length === 0) {\r\n                showMessage('No BOMs to export', 'warning');\r\n                return;\r\n            }\r\n\r\n            // Check if mappings are configured (new flat structure)\r\n            if (!fieldMappings || Object.keys(fieldMappings).length === 0) {\r\n                showMessage('Please configure field mappings first', 'warning');\r\n                debugLog('warning', 'Field mappings not configured');\r\n                return;\r\n            }\r\n\r\n            // Auto-load BOM import headers if not loaded\r\n            if (!bomLevelHeaders.length || !itemLevelHeaders.length) {\r\n                debugLog('info', 'BOM import headers not loaded - loading now...');\r\n                checkBOMImportHeaders();\r\n\r\n                if (!bomLevelHeaders.length || !itemLevelHeaders.length) {\r\n                    showMessage('Failed to load BOM import headers', 'danger');\r\n                    return;\r\n                }\r\n            }\r\n\r\n            try {\r\n                const rows = [];\r\n\r\n                // Row 1: BOM-level headers (exactly as from API)\r\n                rows.push(bomLevelHeaders.map(h => `\"${h}\"`).join(','));\r\n\r\n                // Row 2: Item-level headers (exactly as from API)\r\n                rows.push(itemLevelHeaders.map(h => `\"${h}\"`).join(','));\r\n\r\n                // Generate BOM rows\r\n                for (let i = 0; i < bomsToCreate.length; i++) {\r\n                    const bom = bomsToCreate[i];\r\n\r\n                    // Log first BOM as example\r\n                    if (i === 0) {\r\n                        debugLog('info', `Generating BOM rows (example): ${bom.partNumber}`);\r\n                    }\r\n\r\n                    // BOM-level row (Flag = \"BOM\")\r\n                    const bomRow = generateBOMRow(bom);\r\n                    rows.push(bomRow);\r\n\r\n                    // First item: Finished Good output\r\n                    const finishedGoodRow = generateFinishedGoodRow(bom);\r\n                    rows.push(finishedGoodRow);\r\n\r\n                    // Item-level rows (Flag = \"Item\") for each component\r\n                    for (const item of bom.items) {\r\n                        const itemRow = generateItemRow(bom, item);\r\n                        rows.push(itemRow);\r\n                    }\r\n                }\r\n\r\n                const csvContent = rows.join('\\n');\r\n                debugLog('success', `Generated BOM Import CSV with ${bomsToCreate.length} BOMs`);\r\n                debugLog('info', 'CSV Preview (first 500 chars)', csvContent.substring(0, 500));\r\n\r\n                downloadCSV(csvContent, 'bom_import.csv');\r\n                showMessage(`Exported ${bomsToCreate.length} BOMs successfully`, 'success');\r\n\r\n            } catch (error) {\r\n                debugLog('error', 'Error generating BOM Import CSV', error.toString());\r\n                showMessage('Error generating BOM Import CSV: ' + error.message, 'danger');\r\n            }\r\n        }\r\n\r\n        function generateBOMRow(bom) {\r\n            const row = [];\r\n\r\n            // For each BOM-level header, generate the value\r\n            for (const header of bomLevelHeaders) {\r\n                let value = '';\r\n\r\n                if (header === 'Flag') {\r\n                    value = 'BOM';\r\n                } else if (header === 'Number') {\r\n                    value = bom.partNumber || '';\r\n                } else if (header === 'Description') {\r\n                    value = bom.description || '';\r\n                } else if (header === 'Active') {\r\n                    value = 'true';\r\n                } else if (header === 'AutoCreateType') {\r\n                    value = config.autoCreateType || 'Build To Order';\r\n                } else {\r\n                    // For other fields, leave empty\r\n                    value = '';\r\n                }\r\n\r\n                // Properly escape quotes (like PPP validator)\r\n                row.push('\"' + String(value).replace(/\"/g, '\"\"') + '\"');\r\n            }\r\n\r\n            return row.join(',');\r\n        }\r\n\r\n        function generateFinishedGoodRow(bom) {\r\n            const row = [];\r\n\r\n            // For each Item-level header, generate the Finished Good output\r\n            for (const header of itemLevelHeaders) {\r\n                let value = '';\r\n\r\n                if (header === 'Flag') {\r\n                    value = 'Item';\r\n                } else if (header === 'Part') {\r\n                    value = bom.partNumber || '';\r\n                } else if (header === 'Quantity') {\r\n                    value = '1';\r\n                } else if (header === 'UOM') {\r\n                    value = bom.uom || defaultValues.uom;\r\n                } else if (header === 'Description') {\r\n                    value = bom.description || '';\r\n                } else if (header === 'Type') {\r\n                    value = 'Finished Good'; // BOM output is always Finished Good\r\n                } else if (header === 'IsStage') {\r\n                    value = 'false'; // Finished Good is NEVER a stage (only Raw Goods can be stages)\r\n                } else if (header === 'StageBOMNumber') {\r\n                    value = '';\r\n                } else if (header === 'IsVariableQuantity') {\r\n                    value = 'false';\r\n                } else if (header === 'MinQuantity' || header === 'MaxQuantity') {\r\n                    value = '0';\r\n                } else if (header === 'IsGroupDefault') {\r\n                    value = 'true';\r\n                } else if (header === 'PriceAdjustment') {\r\n                    value = '0.00';\r\n                } else if (header === 'IsOneTimeItem') {\r\n                    value = 'false';\r\n                } else if (header === 'ConfigurationSortOrder') {\r\n                    value = '1';\r\n                } else {\r\n                    // For any other fields, leave empty\r\n                    value = '';\r\n                }\r\n\r\n                // Properly escape quotes (like PPP validator)\r\n                row.push('\"' + String(value).replace(/\"/g, '\"\"') + '\"');\r\n            }\r\n\r\n            return row.join(',');\r\n        }\r\n\r\n        function generateItemRow(bom, item) {\r\n            const row = [];\r\n\r\n            // For each Item-level header, generate the value\r\n            for (const header of itemLevelHeaders) {\r\n                let value = '';\r\n\r\n                if (header === 'Flag') {\r\n                    value = 'Item';\r\n                } else if (header === 'Part') {\r\n                    value = item.partNumber || '';\r\n                } else if (header === 'Quantity') {\r\n                    value = item.quantity || '1';\r\n                } else if (header === 'UOM') {\r\n                    value = item.uom || defaultValues.uom;\r\n                } else if (header === 'Description') {\r\n                    value = item.description || '';\r\n                } else if (header === 'Type') {\r\n                    value = item.type || 'Raw Good';\r\n                } else if (header === 'IsStage') {\r\n                    // Check if this item has its own BOM\r\n                    const hasOwnBOM = bomsToCreate.find(b => b.partNumber === item.partNumber);\r\n                    value = hasOwnBOM ? 'true' : 'false';\r\n                } else if (header === 'StageBOMNumber') {\r\n                    // If it's a stage, reference the stage BOM\r\n                    const hasOwnBOM = bomsToCreate.find(b => b.partNumber === item.partNumber);\r\n                    value = hasOwnBOM ? item.partNumber : '';\r\n                } else if (header === 'IsVariableQuantity') {\r\n                    value = 'false';\r\n                } else if (header === 'MinQuantity' || header === 'MaxQuantity') {\r\n                    value = '0';\r\n                } else if (header === 'IsGroupDefault') {\r\n                    value = 'true';\r\n                } else if (header === 'PriceAdjustment') {\r\n                    value = '0.00';\r\n                } else if (header === 'IsOneTimeItem') {\r\n                    value = 'false';\r\n                } else if (header === 'ConfigurationSortOrder') {\r\n                    value = '1';\r\n                } else {\r\n                    // For any other fields, leave empty\r\n                    value = '';\r\n                }\r\n\r\n                // Properly escape quotes (like PPP validator)\r\n                row.push('\"' + String(value).replace(/\"/g, '\"\"') + '\"');\r\n            }\r\n\r\n            return row.join(',');\r\n        }\r\n\r\n        function getItemData(item) {\r\n            // Find the original row data from solidworksData\r\n            const foundItem = solidworksData.find(d => d.level === item.level && d.partNumber === item.partNumber);\r\n            if (!foundItem) return null;\r\n\r\n            // Create a map of column name to value\r\n            const data = {};\r\n            solidworksColumns.forEach((col, index) => {\r\n                // Store the data using column names\r\n                if (col === 'LEVEL') data[col] = foundItem.level;\r\n                if (col === 'Description') data[col] = foundItem.description;\r\n                if (col === 'PGE P/N#') data[col] = foundItem.partNumber;\r\n                if (col === 'Ordering type') data[col] = foundItem.type;\r\n                if (col === 'Qty') data[col] = foundItem.quantity;\r\n                if (col === 'uom') data[col] = foundItem.uom;\r\n            });\r\n\r\n            return data;\r\n        }\r\n\r\n        // API Import Functions\r\n        function importPartsToFishbowl() {\r\n            debugLog('info', 'Starting direct Part import to Fishbowl...');\r\n\r\n            if (partsToCreate.length === 0) {\r\n                showMessage('No parts to import', 'warning');\r\n                return;\r\n            }\r\n\r\n            try {\r\n                // Use standard PPP import headers (same as PPP Pricing Validator)\r\n                const headers = [\r\n                    'PartNumber', 'PartDescription', 'PartDetails', 'UOM', 'UPC',\r\n                    'PartTypeID', 'Active', 'PartTaxCode', 'StdCost', 'ABCCode',\r\n                    'Weight', 'WeightUOM', 'Width', 'Height', 'Len', 'SizeUOM',\r\n                    'PartRevision', 'PartURL',\r\n                    // Product columns (for parts created as Products)\r\n                    'ProductNum', 'ProductDescription', 'ProductDetails', 'ProductPrice', 'ProductTaxable',\r\n                    'ProductIncomeAccount', 'ProductDefaultSOItemType', 'ProductAlertNote', 'ProductImageUrl',\r\n                    // Vendor columns\r\n                    'Vendor', 'VendorPartNumber', 'Cost', 'VendorUOM', 'DefaultVendor'\r\n                ];\r\n\r\n                const rows = [];\r\n\r\n                // Header row (escape quotes like PPP validator)\r\n                rows.push(headers.map(h => '\"' + h.replace(/\"/g, '\"\"') + '\"').join(','));\r\n\r\n                // Data rows\r\n                for (let i = 0; i < partsToCreate.length; i++) {\r\n                    const part = partsToCreate[i];\r\n\r\n                    // Log first part as example\r\n                    if (i === 0) {\r\n                        debugLog('info', `Generating part row (example): ${part.partNumber}`);\r\n                    }\r\n\r\n                    // Map part type to PartTypeID (10=INVENTORY by default)\r\n                    let partTypeID = '10'; // 10=INVENTORY (default)\r\n                    if (!config.createAsInventory && part.type) {\r\n                        const typeMap = {\r\n                            'Inventory': '10',\r\n                            'Service': '20',\r\n                            'Labor': '21',\r\n                            'Overhead': '22',\r\n                            'Non-Inventory': '30',\r\n                            'Internal Use': '40',\r\n                            'Capital Equipment': '50',\r\n                            'Shipping': '60'\r\n                        };\r\n                        partTypeID = typeMap[part.type] || '10';\r\n                    }\r\n\r\n                    // Determine if this part should have product data\r\n                    const isProduct = part.type === 'Product';\r\n\r\n                    const row = [\r\n                        part.partNumber || '',\r\n                        part.description || '',\r\n                        part.details || '',\r\n                        part.uom || defaultValues.uom,\r\n                        part.upc || '',\r\n                        partTypeID, // PartTypeID (required)\r\n                        'true', // Active\r\n                        defaultValues.taxCode, // PartTaxCode\r\n                        part.standardCost || '', // StdCost\r\n                        'B', // ABCCode (default to B)\r\n                        part.weight || '',\r\n                        part.weight ? defaultValues.weightUOM : '', // WeightUOM\r\n                        part.width || '',\r\n                        part.height || '',\r\n                        part.length || '',\r\n                        (part.width || part.height || part.length) ? defaultValues.sizeUOM : '', // SizeUOM\r\n                        part.revision || '',\r\n                        '', // PartURL\r\n                        // Product columns (populate if this is a Product)\r\n                        isProduct ? part.partNumber : '', // ProductNum (same as part number)\r\n                        isProduct ? part.description : '', // ProductDescription (same as part description)\r\n                        isProduct ? (part.details || '') : '', // ProductDetails\r\n                        isProduct ? (part.productPrice || '') : '', // ProductPrice (optional - can be set later)\r\n                        isProduct ? 'true' : '', // ProductTaxable (default to true for products)\r\n                        isProduct ? '' : '', // ProductIncomeAccount (optional)\r\n                        isProduct ? '10' : '', // ProductDefaultSOItemType (10=Sale, optional)\r\n                        isProduct ? '' : '', // ProductAlertNote (optional)\r\n                        isProduct ? '' : '', // ProductImageUrl (optional)\r\n                        // Vendor columns\r\n                        part.vendor || '',\r\n                        part.vendorNumber || '',\r\n                        part.vendorCost || '',\r\n                        part.vendor ? (part.uom || defaultValues.uom) : '', // VendorUOM\r\n                        part.vendor ? 'true' : '' // DefaultVendor\r\n                    ];\r\n\r\n                    // Properly escape quotes in values (like PPP validator)\r\n                    const escapedRow = row.map(v => '\"' + String(v).replace(/\"/g, '\"\"') + '\"').join(',');\r\n                    rows.push(escapedRow);\r\n                }\r\n\r\n                // Build API request payload\r\n                const payload = {\r\n                    \"ImportRq\": {\r\n                        \"Type\": \"ImportPartProductAndVendorPricing\",\r\n                        \"Rows\": {\r\n                            \"Row\": rows\r\n                        }\r\n                    }\r\n                };\r\n\r\n                debugLog('info', `Importing ${partsToCreate.length} parts to Fishbowl...`);\r\n\r\n                showMessage(`Importing ${partsToCreate.length} parts to Fishbowl...`, 'info');\r\n                showProgress('Importing parts to Fishbowl...', 50);\r\n\r\n                // Call the Fishbowl API\r\n                const response = runApiRequest('ImportRq', JSON.stringify(payload));\r\n\r\n                hideProgress();\r\n\r\n                if (!response) {\r\n                    showMessage('Part import failed: No response from API', 'danger');\r\n                    debugLog('error', 'Part import failed: No response from API');\r\n                    return;\r\n                }\r\n\r\n                // Parse response\r\n                const result = typeof response === 'string' ? JSON.parse(response) : response;\r\n\r\n                // Check for errors in response\r\n                if (result && result.ImportRs) {\r\n                    const importRs = result.ImportRs;\r\n\r\n                    // statusCode can be either number or string\r\n                    if (importRs.statusCode === 1000 || importRs.statusCode === '1000') {\r\n                        // Success\r\n                        showMessage(` Successfully imported ${partsToCreate.length} parts to Fishbowl!`, 'success');\r\n                        debugLog('success', `Part import successful - ${partsToCreate.length} parts created`);\r\n\r\n                        // Update UI to show parts were imported\r\n                        updatePartsStatus('imported');\r\n                    } else {\r\n                        // Error\r\n                        const errorMsg = importRs.statusMessage || 'Unknown error';\r\n                        showMessage(`Part import failed: ${errorMsg}`, 'danger');\r\n                        debugLog('error', `Part import failed: ${errorMsg}`);\r\n                    }\r\n                } else {\r\n                    showMessage('Unexpected response format from API', 'warning');\r\n                    debugLog('warning', 'Unexpected response format');\r\n                }\r\n\r\n            } catch (error) {\r\n                hideProgress();\r\n                debugLog('error', 'Error during Part import', error.toString());\r\n                showMessage('Error importing parts: ' + error.message, 'danger');\r\n            }\r\n        }\r\n\r\n        function importBOMsToFishbowl() {\r\n            debugLog('info', 'Starting direct BOM import to Fishbowl...');\r\n\r\n            if (bomsToCreate.length === 0) {\r\n                showMessage('No BOMs to import', 'warning');\r\n                return;\r\n            }\r\n\r\n            // Check if mappings are configured (new flat structure)\r\n            if (!fieldMappings || Object.keys(fieldMappings).length === 0) {\r\n                showMessage('Please configure field mappings first', 'warning');\r\n                debugLog('warning', 'Field mappings not configured');\r\n                return;\r\n            }\r\n\r\n            // Auto-load BOM import headers if not loaded\r\n            if (!bomLevelHeaders.length || !itemLevelHeaders.length) {\r\n                debugLog('info', 'BOM import headers not loaded - loading now...');\r\n                checkBOMImportHeaders();\r\n\r\n                if (!bomLevelHeaders.length || !itemLevelHeaders.length) {\r\n                    showMessage('Failed to load BOM import headers', 'danger');\r\n                    return;\r\n                }\r\n            }\r\n\r\n            try {\r\n                const rows = [];\r\n\r\n                // Row 1: BOM-level headers (exactly as from API)\r\n                rows.push(bomLevelHeaders.map(h => `\"${h}\"`).join(','));\r\n\r\n                // Row 2: Item-level headers (exactly as from API)\r\n                rows.push(itemLevelHeaders.map(h => `\"${h}\"`).join(','));\r\n\r\n                // Generate BOM rows\r\n                for (let i = 0; i < bomsToCreate.length; i++) {\r\n                    const bom = bomsToCreate[i];\r\n\r\n                    // Log first BOM as example\r\n                    if (i === 0) {\r\n                        debugLog('info', `Adding BOM to import (example): ${bom.partNumber}`);\r\n                    }\r\n\r\n                    // BOM-level row (Flag = \"BOM\")\r\n                    const bomRow = generateBOMRow(bom);\r\n                    rows.push(bomRow);\r\n\r\n                    // First item: Finished Good output\r\n                    const finishedGoodRow = generateFinishedGoodRow(bom);\r\n                    rows.push(finishedGoodRow);\r\n\r\n                    // Item-level rows (Flag = \"Item\") for each component\r\n                    for (const item of bom.items) {\r\n                        const itemRow = generateItemRow(bom, item);\r\n                        rows.push(itemRow);\r\n                    }\r\n                }\r\n\r\n                // Build API request payload\r\n                const payload = {\r\n                    \"ImportRq\": {\r\n                        \"Type\": \"ImportBillOfMaterials\",\r\n                        \"Rows\": {\r\n                            \"Row\": rows\r\n                        }\r\n                    }\r\n                };\r\n\r\n                debugLog('info', `Importing ${bomsToCreate.length} BOMs to Fishbowl...`);\r\n\r\n                showMessage(`Importing ${bomsToCreate.length} BOMs to Fishbowl...`, 'info');\r\n                showProgress('Importing BOMs to Fishbowl...', 50);\r\n\r\n                // Call the Fishbowl API\r\n                const response = runApiRequest('ImportRq', JSON.stringify(payload));\r\n\r\n                hideProgress();\r\n\r\n                if (!response) {\r\n                    showMessage('BOM import failed: No response from API', 'danger');\r\n                    debugLog('error', 'BOM import failed: No response from API');\r\n                    return;\r\n                }\r\n\r\n                // Parse response\r\n                const result = typeof response === 'string' ? JSON.parse(response) : response;\r\n\r\n                // Check for errors in response\r\n                if (result && result.ImportRs) {\r\n                    const importRs = result.ImportRs;\r\n\r\n                    // statusCode can be either number or string\r\n                    if (importRs.statusCode === 1000 || importRs.statusCode === '1000') {\r\n                        // Success\r\n                        showMessage(` Successfully imported ${bomsToCreate.length} BOMs to Fishbowl!`, 'success');\r\n                        debugLog('success', `BOM import successful - ${bomsToCreate.length} BOMs created`);\r\n\r\n                        // Update UI to show BOMs were imported\r\n                        updateBOMsStatus('imported');\r\n                    } else {\r\n                        // Error\r\n                        const errorMsg = importRs.statusMessage || 'Unknown error';\r\n                        showMessage(`BOM import failed: ${errorMsg}`, 'danger');\r\n                        debugLog('error', `BOM import failed: ${errorMsg}`);\r\n                    }\r\n                } else {\r\n                    showMessage('Unexpected response format from API', 'warning');\r\n                    debugLog('warning', 'Unexpected response format');\r\n                }\r\n\r\n            } catch (error) {\r\n                hideProgress();\r\n                debugLog('error', 'Error during BOM import', error.toString());\r\n                showMessage('Error importing BOMs: ' + error.message, 'danger');\r\n            }\r\n        }\r\n\r\n        // Update parts table status\r\n        function updatePartsStatus(status) {\r\n            const tbody = document.getElementById('partsTableBody');\r\n            const rows = tbody.getElementsByTagName('tr');\r\n\r\n            for (const row of rows) {\r\n                const statusCell = row.cells[4]; // Updated index (was 3, now 4 due to UOM column)\r\n                if (status === 'imported') {\r\n                    statusCell.innerHTML = '<span class=\"badge bg-success\">Imported</span>';\r\n                }\r\n            }\r\n        }\r\n\r\n        // Update BOMs table status\r\n        function updateBOMsStatus(status) {\r\n            // New table structure doesn't have status column\r\n            // Status is already shown via toast messages\r\n            // This function is now a no-op for backwards compatibility\r\n            if (status === 'imported') {\r\n                debugLog('success', 'BOMs status updated to imported');\r\n            }\r\n        }\r\n\r\n        // Show/hide progress indicator\r\n        function showProgress(message, percent) {\r\n            const progressSection = document.getElementById('progressSection');\r\n            const progressText = document.getElementById('progressText');\r\n            const progressBar = document.getElementById('progressBar');\r\n\r\n            progressText.textContent = message;\r\n            progressBar.style.width = percent + '%';\r\n            progressSection.classList.remove('hidden');\r\n        }\r\n\r\n        function hideProgress() {\r\n            const progressSection = document.getElementById('progressSection');\r\n            progressSection.classList.add('hidden');\r\n        }\r\n\r\n        function downloadCSV(csvContent, filename) {\r\n            debugLog('info', `Downloading CSV file: ${filename}`);\r\n\r\n            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\r\n            const link = document.createElement('a');\r\n\r\n            if (link.download !== undefined) {\r\n                const url = URL.createObjectURL(blob);\r\n                link.setAttribute('href', url);\r\n                link.setAttribute('download', filename);\r\n                link.style.visibility = 'hidden';\r\n                document.body.appendChild(link);\r\n                link.click();\r\n                document.body.removeChild(link);\r\n                URL.revokeObjectURL(url);\r\n\r\n                debugLog('success', `CSV file downloaded: ${filename}`);\r\n            } else {\r\n                showMessage('Download not supported in this browser', 'danger');\r\n                debugLog('error', 'Download not supported');\r\n            }\r\n        }\r\n\r\n        // Utility functions\r\n        function showMessage(message, type = 'info') {\r\n            const toastContainer = document.getElementById('toastContainer');\r\n\r\n            // Map alert types to toast icons and colors\r\n            const iconMap = {\r\n                'success': 'check-circle-fill',\r\n                'danger': 'exclamation-triangle-fill',\r\n                'warning': 'exclamation-circle-fill',\r\n                'info': 'info-circle-fill'\r\n            };\r\n\r\n            const bgMap = {\r\n                'success': 'success',\r\n                'danger': 'danger',\r\n                'warning': 'warning',\r\n                'info': 'info'\r\n            };\r\n\r\n            const icon = iconMap[type] || 'info-circle-fill';\r\n            const bgColor = bgMap[type] || 'info';\r\n\r\n            // Create toast element\r\n            const toastEl = document.createElement('div');\r\n            toastEl.className = 'toast';\r\n            toastEl.setAttribute('role', 'alert');\r\n            toastEl.setAttribute('aria-live', 'assertive');\r\n            toastEl.setAttribute('aria-atomic', 'true');\r\n\r\n            toastEl.innerHTML = `\r\n                <div class=\"toast-header bg-${bgColor} text-white\">\r\n                    <i class=\"bi bi-${icon} me-2\"></i>\r\n                    <strong class=\"me-auto\">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>\r\n                    <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"toast\" aria-label=\"Close\"></button>\r\n                </div>\r\n                <div class=\"toast-body\">\r\n                    ${message}\r\n                </div>\r\n            `;\r\n\r\n            toastContainer.appendChild(toastEl);\r\n\r\n            // Initialize Bootstrap toast\r\n            const toast = new bootstrap.Toast(toastEl, {\r\n                autohide: type === 'success' || type === 'info', // Auto-hide success/info, persist errors/warnings\r\n                delay: 5000\r\n            });\r\n\r\n            toast.show();\r\n\r\n            // Remove from DOM after hidden\r\n            toastEl.addEventListener('hidden.bs.toast', () => {\r\n                toastEl.remove();\r\n            });\r\n        }\r\n\r\n        function updateStats(stats) {\r\n            document.getElementById('statTotal').textContent = stats.total || 0;\r\n            document.getElementById('statParts').textContent = stats.parts || 0;\r\n            document.getElementById('statNewParts').textContent = stats.newParts || 0;\r\n            document.getElementById('statBOMs').textContent = stats.boms || 0;\r\n            document.getElementById('statWarnings').textContent = stats.warnings || 0;\r\n            document.getElementById('statErrors').textContent = stats.errors || 0;\r\n\r\n            document.getElementById('summaryStats').classList.remove('hidden');\r\n        }\r\n\r\n        // Populate settings dropdowns with Fishbowl data\r\n        function populateSettingsDropdowns() {\r\n            // Populate UOM dropdown\r\n            const uomSelect = document.getElementById('defaultUOM');\r\n            if (uomSelect && fishbowlData.uomDetails.length > 0) {\r\n                // Clear existing options except the first (ea)\r\n                while (uomSelect.options.length > 1) {\r\n                    uomSelect.remove(1);\r\n                }\r\n\r\n                // Add UOMs from Fishbowl with name\r\n                fishbowlData.uomDetails.forEach(uom => {\r\n                    if (uom.code !== 'ea') { // Don't duplicate ea\r\n                        const option = document.createElement('option');\r\n                        option.value = uom.code;\r\n                        option.textContent = `${uom.code} - ${uom.name || uom.code}`;\r\n                        uomSelect.appendChild(option);\r\n                    }\r\n                });\r\n\r\n                debugLog('success', `Populated ${fishbowlData.uomDetails.length} UOMs in settings`);\r\n            }\r\n\r\n            // Populate Tax Code dropdown\r\n            const taxCodeSelect = document.getElementById('defaultTaxCode');\r\n            if (taxCodeSelect && fishbowlData.taxCodeDetails.length > 0) {\r\n                // Clear existing options except the first (NON)\r\n                while (taxCodeSelect.options.length > 1) {\r\n                    taxCodeSelect.remove(1);\r\n                }\r\n\r\n                // Add tax codes from Fishbowl with name\r\n                fishbowlData.taxCodeDetails.forEach(tax => {\r\n                    if (tax.code !== 'NON') { // Don't duplicate NON\r\n                        const option = document.createElement('option');\r\n                        option.value = tax.code;\r\n                        option.textContent = `${tax.code} - ${tax.name || tax.code}`;\r\n                        taxCodeSelect.appendChild(option);\r\n                    }\r\n                });\r\n\r\n                debugLog('success', `Populated ${fishbowlData.taxCodeDetails.length} tax codes in settings`);\r\n            }\r\n\r\n            // Load saved settings after populating dropdowns\r\n            loadSettings();\r\n        }\r\n\r\n        // Save settings to localStorage\r\n        function saveSettings() {\r\n            const settings = {\r\n                defaultUOM: document.getElementById('defaultUOM').value,\r\n                defaultTaxCode: document.getElementById('defaultTaxCode').value,\r\n                defaultWeightUOM: document.getElementById('defaultWeightUOM').value,\r\n                defaultSizeUOM: document.getElementById('defaultSizeUOM').value,\r\n                createAsInventory: document.getElementById('createAsInventory').checked,\r\n                createFinishedGoodsAsProducts: document.getElementById('createFinishedGoodsAsProducts').checked,\r\n                validatePartsExist: document.getElementById('validatePartsExist').checked,\r\n                processStagesSequentially: document.getElementById('processStagesSequentially').checked,\r\n                createBOMFromFilename: document.getElementById('createBOMFromFilename').checked,\r\n                autoCreateType: document.getElementById('autoCreateType').value\r\n            };\r\n\r\n            try {\r\n                localStorage.setItem('bomConverterSettings', JSON.stringify(settings));\r\n                debugLog('info', 'Settings saved');\r\n            } catch (error) {\r\n                // localStorage not available, but settings still applied to memory\r\n                debugLog('info', 'Settings applied (localStorage not available)');\r\n            }\r\n\r\n            // Update the in-memory config and defaultValues\r\n            defaultValues.uom = settings.defaultUOM;\r\n            defaultValues.taxCode = settings.defaultTaxCode;\r\n            defaultValues.weightUOM = settings.defaultWeightUOM;\r\n            defaultValues.sizeUOM = settings.defaultSizeUOM;\r\n            config.createAsInventory = settings.createAsInventory;\r\n            config.createFinishedGoodsAsProducts = settings.createFinishedGoodsAsProducts;\r\n            config.validatePartsExist = settings.validatePartsExist;\r\n            config.processStagesSequentially = settings.processStagesSequentially;\r\n            config.createBOMFromFilename = settings.createBOMFromFilename;\r\n            config.autoCreateType = settings.autoCreateType;\r\n        }\r\n\r\n        // Load settings from localStorage\r\n        function loadSettings() {\r\n            try {\r\n                const savedSettings = localStorage.getItem('bomConverterSettings');\r\n                if (savedSettings) {\r\n                    try {\r\n                        const settings = JSON.parse(savedSettings);\r\n\r\n                        // Apply settings to UI elements\r\n                        if (settings.defaultUOM) document.getElementById('defaultUOM').value = settings.defaultUOM;\r\n                        if (settings.defaultTaxCode) document.getElementById('defaultTaxCode').value = settings.defaultTaxCode;\r\n                        if (settings.defaultWeightUOM) document.getElementById('defaultWeightUOM').value = settings.defaultWeightUOM;\r\n                        if (settings.defaultSizeUOM) document.getElementById('defaultSizeUOM').value = settings.defaultSizeUOM;\r\n                        if (settings.createAsInventory !== undefined) document.getElementById('createAsInventory').checked = settings.createAsInventory;\r\n                        if (settings.createFinishedGoodsAsProducts !== undefined) document.getElementById('createFinishedGoodsAsProducts').checked = settings.createFinishedGoodsAsProducts;\r\n                        if (settings.validatePartsExist !== undefined) document.getElementById('validatePartsExist').checked = settings.validatePartsExist;\r\n                        if (settings.processStagesSequentially !== undefined) document.getElementById('processStagesSequentially').checked = settings.processStagesSequentially;\r\n                        if (settings.createBOMFromFilename !== undefined) document.getElementById('createBOMFromFilename').checked = settings.createBOMFromFilename;\r\n                        if (settings.autoCreateType) document.getElementById('autoCreateType').value = settings.autoCreateType;\r\n\r\n                        // Update in-memory config and defaultValues\r\n                        defaultValues.uom = settings.defaultUOM || 'ea';\r\n                        defaultValues.taxCode = settings.defaultTaxCode || 'NON';\r\n                        defaultValues.weightUOM = settings.defaultWeightUOM || 'kg'; // Metric default\r\n                        defaultValues.sizeUOM = settings.defaultSizeUOM || 'cm';      // Metric default\r\n                        config.createAsInventory = settings.createAsInventory !== undefined ? settings.createAsInventory : true;\r\n                        config.createFinishedGoodsAsProducts = settings.createFinishedGoodsAsProducts || false;\r\n                        config.validatePartsExist = settings.validatePartsExist !== undefined ? settings.validatePartsExist : true;\r\n                        config.processStagesSequentially = settings.processStagesSequentially !== undefined ? settings.processStagesSequentially : true;\r\n                        config.createBOMFromFilename = settings.createBOMFromFilename || false;\r\n                        config.autoCreateType = settings.autoCreateType || 'Build To Order';\r\n\r\n                        debugLog('success', 'Settings loaded from localStorage');\r\n                    } catch (error) {\r\n                        debugLog('error', 'Error parsing settings', error.toString());\r\n                    }\r\n                } else {\r\n                    debugLog('info', 'No saved settings found, using defaults');\r\n                }\r\n            } catch (error) {\r\n                // localStorage not available (e.g., data: URLs, file: URLs with restrictions)\r\n                debugLog('info', 'localStorage not available, using defaults');\r\n            }\r\n        }\r\n\r\n        // Save combined configuration (settings + field mappings)\r\n        function saveConfiguration() {\r\n            const configuration = {\r\n                version: '1.0',\r\n                timestamp: new Date().toISOString(),\r\n                settings: {\r\n                    defaultUOM: document.getElementById('defaultUOM').value,\r\n                    defaultTaxCode: document.getElementById('defaultTaxCode').value,\r\n                    defaultWeightUOM: document.getElementById('defaultWeightUOM').value,\r\n                    defaultSizeUOM: document.getElementById('defaultSizeUOM').value,\r\n                    createAsInventory: document.getElementById('createAsInventory').checked,\r\n                    createFinishedGoodsAsProducts: document.getElementById('createFinishedGoodsAsProducts').checked,\r\n                    validatePartsExist: document.getElementById('validatePartsExist').checked,\r\n                    processStagesSequentially: document.getElementById('processStagesSequentially').checked,\r\n                    createBOMFromFilename: document.getElementById('createBOMFromFilename').checked,\r\n                    autoCreateType: document.getElementById('autoCreateType').value\r\n                },\r\n                fieldMappings: fieldMappings\r\n            };\r\n\r\n            const json = JSON.stringify(configuration, null, 2);\r\n            const blob = new Blob([json], { type: 'application/json' });\r\n            const url = URL.createObjectURL(blob);\r\n            const a = document.createElement('a');\r\n            a.href = url;\r\n            a.download = `bom-converter-config-${new Date().toISOString().split('T')[0]}.json`;\r\n            a.click();\r\n            URL.revokeObjectURL(url);\r\n\r\n            showMessage('Configuration saved successfully', 'success');\r\n            debugLog('success', 'Configuration saved to file');\r\n        }\r\n\r\n        // Load combined configuration (settings + field mappings)\r\n        function loadConfiguration() {\r\n            const input = document.createElement('input');\r\n            input.type = 'file';\r\n            input.accept = '.json';\r\n\r\n            input.onchange = function(e) {\r\n                const file = e.target.files[0];\r\n                if (!file) return;\r\n\r\n                const reader = new FileReader();\r\n                reader.onload = function(event) {\r\n                    try {\r\n                        const configuration = JSON.parse(event.target.result);\r\n\r\n                        // Load settings\r\n                        if (configuration.settings) {\r\n                            const settings = configuration.settings;\r\n                            if (settings.defaultUOM) document.getElementById('defaultUOM').value = settings.defaultUOM;\r\n                            if (settings.defaultTaxCode) document.getElementById('defaultTaxCode').value = settings.defaultTaxCode;\r\n                            if (settings.defaultWeightUOM) document.getElementById('defaultWeightUOM').value = settings.defaultWeightUOM;\r\n                            if (settings.defaultSizeUOM) document.getElementById('defaultSizeUOM').value = settings.defaultSizeUOM;\r\n                            if (settings.createAsInventory !== undefined) document.getElementById('createAsInventory').checked = settings.createAsInventory;\r\n                            if (settings.createFinishedGoodsAsProducts !== undefined) document.getElementById('createFinishedGoodsAsProducts').checked = settings.createFinishedGoodsAsProducts;\r\n                            if (settings.validatePartsExist !== undefined) document.getElementById('validatePartsExist').checked = settings.validatePartsExist;\r\n                            if (settings.processStagesSequentially !== undefined) document.getElementById('processStagesSequentially').checked = settings.processStagesSequentially;\r\n                            if (settings.createBOMFromFilename !== undefined) document.getElementById('createBOMFromFilename').checked = settings.createBOMFromFilename;\r\n                            if (settings.autoCreateType) document.getElementById('autoCreateType').value = settings.autoCreateType;\r\n\r\n                            // Update in-memory values\r\n                            defaultValues.uom = settings.defaultUOM || 'ea';\r\n                            defaultValues.taxCode = settings.defaultTaxCode || 'NON';\r\n                            defaultValues.weightUOM = settings.defaultWeightUOM || 'kg';\r\n                            defaultValues.sizeUOM = settings.defaultSizeUOM || 'cm';\r\n                            config.createAsInventory = settings.createAsInventory !== undefined ? settings.createAsInventory : true;\r\n                            config.createFinishedGoodsAsProducts = settings.createFinishedGoodsAsProducts || false;\r\n                            config.validatePartsExist = settings.validatePartsExist !== undefined ? settings.validatePartsExist : true;\r\n                            config.processStagesSequentially = settings.processStagesSequentially !== undefined ? settings.processStagesSequentially : true;\r\n                            config.createBOMFromFilename = settings.createBOMFromFilename || false;\r\n                            config.autoCreateType = settings.autoCreateType || 'Build To Order';\r\n\r\n                            // Save to localStorage\r\n                            saveSettings();\r\n                        }\r\n\r\n                        // Load field mappings\r\n                        if (configuration.fieldMappings) {\r\n                            fieldMappings = configuration.fieldMappings;\r\n                        }\r\n\r\n                        showMessage('Configuration loaded successfully! Settings applied and field mappings ready.', 'success');\r\n                        debugLog('success', 'Configuration loaded from file');\r\n\r\n                        // Reprocess if we have data\r\n                        if (rawCSVContent) {\r\n                            processBOMData();\r\n                        }\r\n                    } catch (err) {\r\n                        debugLog('error', 'Error loading configuration: ' + err.toString());\r\n                        showMessage('Error loading configuration file: ' + err.message, 'danger');\r\n                    }\r\n                };\r\n                reader.readAsText(file);\r\n            };\r\n\r\n            input.click();\r\n        }\r\n\r\n        // Configuration event listeners\r\n        document.getElementById('defaultUOM').addEventListener('change', function() {\r\n            defaultValues.uom = this.value;\r\n            debugLog('info', `Default UOM changed to: ${this.value}`);\r\n        });\r\n\r\n        document.getElementById('defaultTaxCode').addEventListener('change', function() {\r\n            defaultValues.taxCode = this.value;\r\n            debugLog('info', `Default tax code changed to: ${this.value}`);\r\n        });\r\n\r\n        document.getElementById('defaultWeightUOM').addEventListener('change', function() {\r\n            defaultValues.weightUOM = this.value;\r\n            debugLog('info', `Default weight UOM changed to: ${this.value}`);\r\n        });\r\n\r\n        document.getElementById('defaultSizeUOM').addEventListener('change', function() {\r\n            defaultValues.sizeUOM = this.value;\r\n            debugLog('info', `Default size UOM changed to: ${this.value}`);\r\n        });\r\n\r\n        document.getElementById('createAsInventory').addEventListener('change', function() {\r\n            config.createAsInventory = this.checked;\r\n        });\r\n\r\n        document.getElementById('createFinishedGoodsAsProducts').addEventListener('change', function() {\r\n            config.createFinishedGoodsAsProducts = this.checked;\r\n        });\r\n\r\n        document.getElementById('validatePartsExist').addEventListener('change', function() {\r\n            config.validatePartsExist = this.checked;\r\n        });\r\n\r\n        document.getElementById('processStagesSequentially').addEventListener('change', function() {\r\n            config.processStagesSequentially = this.checked;\r\n        });\r\n\r\n        document.getElementById('createBOMFromFilename').addEventListener('change', function() {\r\n            config.createBOMFromFilename = this.checked;\r\n        });\r\n\r\n        // Add event listener for settings panel to load Fishbowl data\r\n        const settingsOffcanvas = document.getElementById('settingsOffcanvas');\r\n        if (settingsOffcanvas) {\r\n            settingsOffcanvas.addEventListener('show.bs.offcanvas', function() {\r\n                // Load Fishbowl data if not already loaded and runQuery is available\r\n                if ((fishbowlData.uomDetails.length === 0 || fishbowlData.taxCodeDetails.length === 0) && typeof runQuery === 'function') {\r\n                    try {\r\n                        loadFishbowlData();\r\n                    } catch (error) {\r\n                        debugLog('warning', 'Could not load Fishbowl data: ' + error.message);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n        // Initialize\r\n        console.log('Solidworks BOM Conversion Tool initialized');\r\n        debugLog('info', 'Solidworks BOM Conversion Tool initialized');\r\n        debugLog('info', 'Ready to process Solidworks BOM CSV files');\r\n        debugLog('info', 'Upload Solidworks CSV to begin BOM conversion');\r\n\r\n        // Auto-check BOM headers on load (optional - can comment out if not needed)\r\n        // setTimeout(() => checkBOMImportHeaders(), 1000);\r\n    </script>\r\n</body>\r\n</html>\r\n",
  "active" : true,
  "note" : "",
  "type" : "Page"
} ]