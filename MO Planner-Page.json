[ {
  "name" : "MO Planner",
  "description" : "MO Planner",
  "data" : "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Work Order Capacity Planning - Gantt Chart v2 (vis-timeline)</title>\r\n\r\n    <!-- vis-timeline CSS -->\r\n    <link href=\"https://unpkg.com/vis-timeline@7.7.3/styles/vis-timeline-graph2d.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n\r\n    <!-- Bootstrap 5.3 CSS -->\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n\r\n    <!-- Bootstrap Icons -->\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css\" rel=\"stylesheet\">\r\n\r\n    <!-- Fishbowl Modern Theme -->\r\n    <link href=\"fishbowl-theme-modern.css\" rel=\"stylesheet\">\r\n\r\n    <style>\r\n        {% Style fishbowl-theme-modern %}\r\n\r\n        /* ============================================\r\n           General Layout\r\n           ============================================ */\r\n\r\n        body {\r\n            background-color: var(--fb-gray-50);\r\n            font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\r\n        }\r\n\r\n        #visualization {\r\n            height: 600px;\r\n            border: 1px solid #ddd;\r\n            background-color: white;\r\n            border-radius: 4px;\r\n            margin-bottom: 1rem;\r\n        }\r\n\r\n        /* ============================================\r\n           Status Colors (matching Fishbowl theme)\r\n           ============================================ */\r\n\r\n        .vis-item.status-entered {\r\n            background-color: var(--fb-info) !important;\r\n            border-color: var(--fb-info) !important;\r\n            color: white !important;\r\n        }\r\n\r\n        .vis-item.status-started {\r\n            background-color: var(--fb-warning) !important;\r\n            border-color: var(--fb-warning) !important;\r\n            color: white !important;\r\n        }\r\n\r\n        .vis-item.status-fulfilled {\r\n            background-color: var(--fb-success) !important;\r\n            border-color: var(--fb-success) !important;\r\n            color: white !important;\r\n        }\r\n\r\n        .vis-item.conflict {\r\n            background-color: var(--fb-danger) !important;\r\n            border-color: var(--fb-danger) !important;\r\n            color: white !important;\r\n            box-shadow: 0 0 8px rgba(231, 76, 60, 0.5) !important;\r\n        }\r\n\r\n        /* Weekend background shading */\r\n        .vis-item.weekend-background {\r\n            background-color: #e8e8e8;\r\n            border: none;\r\n            z-index: -1;\r\n        }\r\n\r\n        .vis-item.mo-header {\r\n            background-color: #34495e !important;\r\n            border-color: #2c3e50 !important;\r\n            color: white !important;\r\n            font-weight: bold !important;\r\n            opacity: 0.8;\r\n        }\r\n\r\n        /* MO header status colors */\r\n        .vis-item.mo-header.status-entered {\r\n            background-color: var(--fb-info) !important;\r\n            opacity: 0.7;\r\n        }\r\n\r\n        .vis-item.mo-header.status-started {\r\n            background-color: var(--fb-warning) !important;\r\n            opacity: 0.7;\r\n        }\r\n\r\n        .vis-item.mo-header.status-fulfilled {\r\n            background-color: var(--fb-success) !important;\r\n            opacity: 0.7;\r\n        }\r\n\r\n        /* ============================================\r\n           Category Swim Lane Styling\r\n           ============================================ */\r\n\r\n        .vis-label.category-label {\r\n            font-weight: 600;\r\n            padding: 8px !important;\r\n            border-radius: 4px;\r\n            color: #333 !important;\r\n        }\r\n\r\n        /* ============================================\r\n           Timeline Controls\r\n           ============================================ */\r\n\r\n        .vis-custom-time {\r\n            background-color: var(--fb-danger);\r\n            width: 2px;\r\n        }\r\n\r\n        .view-toggle-btn {\r\n            padding: 8px 16px;\r\n            border: 2px solid var(--fb-primary);\r\n            background-color: white;\r\n            color: var(--fb-primary);\r\n            border-radius: 4px;\r\n            cursor: pointer;\r\n            font-weight: 500;\r\n            transition: all 0.3s;\r\n        }\r\n\r\n        .view-toggle-btn:hover {\r\n            background-color: var(--fb-primary-pale);\r\n        }\r\n\r\n        .view-toggle-btn.active {\r\n            background-color: var(--fb-primary);\r\n            color: white;\r\n        }\r\n\r\n        .info-card {\r\n            background-color: white;\r\n            border: 1px solid #dee2e6;\r\n            border-radius: 4px;\r\n            padding: 15px;\r\n            margin-bottom: 15px;\r\n        }\r\n\r\n        .legend-item {\r\n            display: inline-flex;\r\n            align-items: center;\r\n            margin-right: 20px;\r\n            margin-bottom: 8px;\r\n            cursor: pointer;\r\n            padding: 4px 8px;\r\n            border-radius: 4px;\r\n            transition: background-color 0.2s;\r\n        }\r\n\r\n        .legend-item:hover {\r\n            background-color: var(--fb-gray-100);\r\n        }\r\n\r\n        .legend-item.active {\r\n            background-color: var(--fb-primary-pale);\r\n            border: 2px solid var(--fb-primary);\r\n        }\r\n\r\n        .legend-color {\r\n            width: 20px;\r\n            height: 20px;\r\n            border-radius: 3px;\r\n            margin-right: 8px;\r\n            border: 1px solid #ccc;\r\n        }\r\n\r\n        /* ============================================\r\n           Debug Console\r\n           ============================================ */\r\n\r\n        .debug-section {\r\n            margin-top: 2rem;\r\n        }\r\n\r\n        .debug-content {\r\n            max-height: 300px;\r\n            overflow-y: auto;\r\n            background-color: #1e1e1e;\r\n            color: #d4d4d4;\r\n            font-family: 'Courier New', monospace;\r\n            font-size: 12px;\r\n            padding: 10px;\r\n        }\r\n\r\n        .debug-entry {\r\n            padding: 4px 0;\r\n            border-bottom: 1px solid #333;\r\n        }\r\n\r\n        .debug-timestamp {\r\n            color: #858585;\r\n            margin-right: 8px;\r\n        }\r\n\r\n        .debug-type {\r\n            font-weight: bold;\r\n            margin-right: 8px;\r\n        }\r\n\r\n        .debug-type.info { color: #4fc3f7; }\r\n        .debug-type.success { color: #66bb6a; }\r\n        .debug-type.warning { color: #ffa726; }\r\n        .debug-type.error { color: #ef5350; }\r\n\r\n        .debug-data {\r\n            margin-top: 4px;\r\n            margin-left: 20px;\r\n            padding: 8px;\r\n            background-color: #2d2d2d;\r\n            border-left: 3px solid #569cd6;\r\n            font-size: 11px;\r\n            overflow-x: auto;\r\n            white-space: pre-wrap;\r\n        }\r\n\r\n        /* Empty state */\r\n        .empty-state {\r\n            text-align: center;\r\n            padding: 3rem;\r\n            color: var(--fb-gray-600);\r\n        }\r\n\r\n        .empty-state i {\r\n            font-size: 3rem;\r\n            margin-bottom: 1rem;\r\n        }\r\n\r\n        /* Loading spinner */\r\n        .loading-overlay {\r\n            display: none;\r\n            position: fixed;\r\n            top: 0;\r\n            left: 0;\r\n            width: 100%;\r\n            height: 100%;\r\n            background-color: rgba(0, 0, 0, 0.5);\r\n            z-index: 9999;\r\n            justify-content: center;\r\n            align-items: center;\r\n        }\r\n\r\n        .loading-overlay.show {\r\n            display: flex;\r\n        }\r\n\r\n        .loading-spinner {\r\n            width: 3rem;\r\n            height: 3rem;\r\n        }\r\n\r\n        /* ============================================\r\n           vis-timeline Resize Handle Styling\r\n           ============================================ */\r\n\r\n        /* Ensure resize handles are visible and functional */\r\n        .vis-item.vis-range.vis-editable {\r\n            cursor: move;\r\n        }\r\n\r\n        .vis-item.vis-range.vis-editable.vis-selected {\r\n            cursor: move;\r\n        }\r\n\r\n        /* Make resize handles more prominent */\r\n        .vis-item.vis-range .vis-drag-left,\r\n        .vis-item.vis-range .vis-drag-right {\r\n            cursor: ew-resize !important;\r\n            width: 24px;\r\n            opacity: 0;\r\n            transition: opacity 0.2s;\r\n        }\r\n\r\n        .vis-item.vis-range:hover .vis-drag-left,\r\n        .vis-item.vis-range:hover .vis-drag-right,\r\n        .vis-item.vis-range.vis-selected .vis-drag-left,\r\n        .vis-item.vis-range.vis-selected .vis-drag-right {\r\n            opacity: 0.3;\r\n        }\r\n\r\n        .vis-item.vis-range.vis-selected .vis-drag-left:hover,\r\n        .vis-item.vis-range.vis-selected .vis-drag-right:hover {\r\n            opacity: 0.6;\r\n        }\r\n\r\n        /* Make sure MO headers are NOT resizable */\r\n        .vis-item.mo-header {\r\n            cursor: default !important;\r\n        }\r\n\r\n        .vis-item.mo-header .vis-drag-left,\r\n        .vis-item.mo-header .vis-drag-right {\r\n            display: none !important;\r\n        }\r\n\r\n        /* ============================================\r\n           Calendar Grid Styling\r\n           ============================================ */\r\n\r\n        /* Make day borders more visible */\r\n        .vis-time-axis .vis-grid.vis-vertical {\r\n            border-left: 1px solid #ddd !important;\r\n        }\r\n\r\n        /* Make major grid lines (week/month) more prominent */\r\n        .vis-time-axis .vis-grid.vis-vertical.vis-major {\r\n            border-left: 2px solid #999 !important;\r\n        }\r\n\r\n        /* Alternating background for better day visibility */\r\n        .vis-background .vis-vertical {\r\n            border-left: 1px solid #e8e8e8 !important;\r\n        }\r\n\r\n        .vis-background .vis-vertical.vis-major {\r\n            border-left: 2px solid #bbb !important;\r\n        }\r\n\r\n        /* Today column highlight */\r\n        .vis-time-axis .vis-grid.vis-today {\r\n            background-color: rgba(231, 76, 60, 0.05) !important;\r\n        }\r\n\r\n        /* ============================================\r\n           Dependency Arrow Styling\r\n           ============================================ */\r\n\r\n        /* Arrows are feint by default */\r\n        .dependency-arrow {\r\n            opacity: 0.5;\r\n            transition: opacity 0.2s, stroke-width 0.2s;\r\n        }\r\n\r\n        /* Darken arrows on hover */\r\n        .dependency-arrow.highlighted {\r\n            opacity: 1;\r\n            stroke-width: 3px !important;\r\n            z-index: 1000;\r\n        }\r\n\r\n        /* ============================================\r\n           Off-Canvas Tab Buttons (sticky tabs on sides)\r\n           ============================================ */\r\n        .offcanvas-tab {\r\n            position: fixed;\r\n            top: 50%;\r\n            transform: translateY(-50%);\r\n            z-index: 1001;\r\n            background-color: var(--fb-primary);\r\n            color: white;\r\n            border: none;\r\n            border-radius: 8px 0 0 8px;\r\n            padding: 40px 8px;\r\n            writing-mode: vertical-rl;\r\n            text-orientation: mixed;\r\n            font-size: 14px;\r\n            font-weight: bold;\r\n            cursor: pointer;\r\n            box-shadow: -2px 2px 8px rgba(0, 0, 0, 0.3);\r\n            transition: all 0.3s ease;\r\n            letter-spacing: 2px;\r\n        }\r\n\r\n        .offcanvas-tab:hover {\r\n            background-color: var(--fb-primary-dark);\r\n            box-shadow: -4px 4px 12px rgba(0, 0, 0, 0.4);\r\n        }\r\n\r\n        .offcanvas-tab.tab-right {\r\n            right: 0;\r\n            border-radius: 8px 0 0 8px;\r\n        }\r\n\r\n        .offcanvas-tab.tab-right:hover {\r\n            right: 5px;\r\n        }\r\n\r\n        .offcanvas-tab.tab-left {\r\n            left: 0;\r\n            border-radius: 0 8px 8px 0;\r\n            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);\r\n        }\r\n\r\n        .offcanvas-tab.tab-left:hover {\r\n            left: 5px;\r\n            box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.4);\r\n        }\r\n\r\n        .offcanvas-header {\r\n            background-color: var(--fb-primary);\r\n            color: white;\r\n            border-bottom: 2px solid var(--fb-primary-dark);\r\n        }\r\n\r\n        .offcanvas-title {\r\n            color: white;\r\n            font-weight: 600;\r\n        }\r\n\r\n        .config-group {\r\n            margin-bottom: 1.5rem;\r\n            padding: 1rem;\r\n            background-color: var(--fb-gray-100);\r\n            border-radius: var(--bs-border-radius);\r\n        }\r\n\r\n        .config-group h5 {\r\n            color: var(--fb-primary-dark);\r\n            margin-bottom: 1rem;\r\n            font-size: 1rem;\r\n            font-weight: 600;\r\n        }\r\n\r\n        /* Compact view toggle buttons */\r\n        .view-toggle-btn {\r\n            padding: 6px 12px;\r\n            font-size: 0.875rem;\r\n        }\r\n\r\n        .view-toggle-btn.btn-sm {\r\n            padding: 4px 8px;\r\n            font-size: 0.8125rem;\r\n            border-width: 1px;\r\n        }\r\n\r\n        /* Override Bootstrap btn-sm for even smaller buttons */\r\n        .btn-sm {\r\n            padding: 0.25rem 0.5rem !important;\r\n            font-size: 0.8125rem !important;\r\n            line-height: 1.5 !important;\r\n        }\r\n\r\n        /* Icon-only toggle buttons with ON/OFF states */\r\n        .toggle-icon-btn {\r\n            width: 38px;\r\n            height: 38px;\r\n            padding: 0;\r\n            display: inline-flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            border: 2px solid var(--fb-gray-400);\r\n            background-color: white;\r\n            color: var(--fb-gray-600);\r\n            border-radius: 4px;\r\n            cursor: pointer;\r\n            transition: all 0.3s;\r\n            font-size: 1.1rem;\r\n        }\r\n\r\n        .toggle-icon-btn.btn-sm {\r\n            width: 31px;\r\n            height: 31px;\r\n            font-size: 0.875rem;\r\n            border-width: 1px;\r\n        }\r\n\r\n        .toggle-icon-btn:hover {\r\n            background-color: var(--fb-gray-100);\r\n            border-color: var(--fb-gray-500);\r\n        }\r\n\r\n        .toggle-icon-btn.active {\r\n            background-color: var(--fb-success);\r\n            border-color: var(--fb-success);\r\n            color: white;\r\n        }\r\n\r\n        .toggle-icon-btn.active:hover {\r\n            background-color: var(--fb-success-dark, #1e7e34);\r\n            border-color: var(--fb-success-dark, #1e7e34);\r\n        }\r\n\r\n        /* Remove red border from vis-timeline elements */\r\n        .vis-labelset .vis-label,\r\n        .vis-panel.vis-left,\r\n        .vis-foreground .vis-group {\r\n            border-color: #ddd !important;\r\n        }\r\n\r\n        /* Ensure dependency arrows are behind timeline labels */\r\n        #dependencyArrowsSvg {\r\n            z-index: 0 !important;\r\n        }\r\n\r\n        .vis-labelset,\r\n        .vis-panel.vis-left {\r\n            z-index: 5 !important;\r\n        }\r\n\r\n        /* Weekend highlighting */\r\n        .vis-time-axis .vis-grid.vis-saturday,\r\n        .vis-time-axis .vis-grid.vis-sunday,\r\n        .vis-time-axis .vis-grid.vis-minor.weekend-column {\r\n            background-color: #f5f5f5 !important;\r\n        }\r\n\r\n        .vis-panel.vis-background .vis-vertical.vis-saturday,\r\n        .vis-panel.vis-background .vis-vertical.vis-sunday,\r\n        .vis-panel.vis-background .vis-vertical.weekend-column {\r\n            background-color: #f5f5f5 !important;\r\n        }\r\n\r\n        /* Force category colors on labels and backgrounds */\r\n        .vis-labelset .vis-label[data-category-color] {\r\n            background-color: var(--cat-bg-color) !important;\r\n        }\r\n\r\n        .vis-panel.vis-background .vis-group[data-category-color] {\r\n            background-color: var(--cat-bg-color) !important;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <!-- Folder Tab Buttons -->\r\n    <button class=\"offcanvas-tab tab-left\" type=\"button\" data-bs-toggle=\"offcanvas\" data-bs-target=\"#settingsOffcanvas\" aria-controls=\"settingsOffcanvas\">\r\n        SETTINGS\r\n    </button>\r\n    <button class=\"offcanvas-tab tab-right\" type=\"button\" data-bs-toggle=\"offcanvas\" data-bs-target=\"#instructionsOffcanvas\" aria-controls=\"instructionsOffcanvas\">\r\n        INSTRUCTIONS\r\n    </button>\r\n    <!-- Loading Overlay -->\r\n    <div id=\"loadingOverlay\" class=\"loading-overlay\">\r\n        <div class=\"spinner-border loading-spinner text-light\" role=\"status\">\r\n            <span class=\"visually-hidden\">Loading...</span>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Toast Container -->\r\n    <div class=\"toast-container position-fixed top-0 end-0 p-3\" style=\"z-index: 11000;\">\r\n        <!-- Toasts will be dynamically added here -->\r\n    </div>\r\n\r\n    <!-- Settings Offcanvas -->\r\n    <div class=\"offcanvas offcanvas-start\" tabindex=\"-1\" id=\"settingsOffcanvas\" aria-labelledby=\"settingsOffcanvasLabel\" style=\"width: 400px;\">\r\n        <div class=\"offcanvas-header\">\r\n            <h5 class=\"offcanvas-title\" id=\"settingsOffcanvasLabel\">\r\n                <i class=\"bi bi-gear-fill\"></i> Settings & Filters\r\n            </h5>\r\n            <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"offcanvas\" aria-label=\"Close\"></button>\r\n        </div>\r\n        <div class=\"offcanvas-body\">\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-funnel\"></i> Filters</h5>\r\n\r\n                <div class=\"mb-3\">\r\n                    <label for=\"moFilterOffcanvas\" class=\"form-label\">\r\n                        <i class=\"bi bi-diagram-3\"></i> Filter by MO\r\n                    </label>\r\n                    <select id=\"moFilterOffcanvas\" class=\"form-select form-select-sm\">\r\n                        <option value=\"all\">All MOs</option>\r\n                    </select>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-toggles\"></i> Options</h5>\r\n\r\n                <div class=\"mb-3\">\r\n                    <div class=\"form-check form-switch\">\r\n                        <input class=\"form-check-input\" type=\"checkbox\" role=\"switch\" id=\"allowSameDayStartOffcanvas\" checked>\r\n                        <label class=\"form-check-label\" for=\"allowSameDayStartOffcanvas\" style=\"cursor: pointer; font-size: 0.875rem;\">\r\n                            Allow same-day starts\r\n                        </label>\r\n                    </div>\r\n                    <small class=\"text-muted\">When enabled, a WO can start on the same day its dependency finishes (no conflict).</small>\r\n                </div>\r\n\r\n                <div class=\"mb-3\">\r\n                    <div class=\"form-check form-switch\">\r\n                        <input class=\"form-check-input\" type=\"checkbox\" role=\"switch\" id=\"shiftDependentWOsOffcanvas\">\r\n                        <label class=\"form-check-label\" for=\"shiftDependentWOsOffcanvas\" style=\"cursor: pointer; font-size: 0.875rem;\">\r\n                            Shift dependent WOs when dragging\r\n                        </label>\r\n                    </div>\r\n                    <small class=\"text-muted\">When enabled, dragging a WO will shift all dependent WOs by the same amount.</small>\r\n                </div>\r\n\r\n                <div class=\"mb-3\">\r\n                    <div class=\"form-check form-switch\">\r\n                        <input class=\"form-check-input\" type=\"checkbox\" role=\"switch\" id=\"skipWeekendsOffcanvas\" checked>\r\n                        <label class=\"form-check-label\" for=\"skipWeekendsOffcanvas\" style=\"cursor: pointer; font-size: 0.875rem;\">\r\n                            Skip weekends when scheduling\r\n                        </label>\r\n                    </div>\r\n                    <small class=\"text-muted\">When enabled, WOs cannot be scheduled on weekends (Sat/Sun). Dragging will snap to weekdays.</small>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"d-grid gap-2\">\r\n                <button id=\"refreshBtn\" class=\"btn btn-primary btn-sm\">\r\n                    <i class=\"bi bi-arrow-clockwise\"></i> Apply & Refresh\r\n                </button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Instructions Offcanvas -->\r\n    <div class=\"offcanvas offcanvas-end\" tabindex=\"-1\" id=\"instructionsOffcanvas\" aria-labelledby=\"instructionsOffcanvasLabel\" style=\"width: 500px;\">\r\n        <div class=\"offcanvas-header\">\r\n            <h5 class=\"offcanvas-title\" id=\"instructionsOffcanvasLabel\">\r\n                <i class=\"bi bi-book-fill\"></i> Instructions\r\n            </h5>\r\n            <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"offcanvas\" aria-label=\"Close\"></button>\r\n        </div>\r\n        <div class=\"offcanvas-body\">\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-info-circle\"></i> About This Report</h5>\r\n                <p>This interactive Gantt chart visualizes Work Orders using the vis-timeline library. Toggle between MO Gantt View (grouped by Manufacturing Order) and Category Swim Lane View (grouped by manufacturing category for capacity planning).</p>\r\n            </div>\r\n\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-palette\"></i> Status Colors</h5>\r\n                <div class=\"mb-2\">\r\n                    <span class=\"badge\" style=\"background-color: var(--fb-info);\">Entered</span>\r\n                    - WO has been entered but not started\r\n                </div>\r\n                <div class=\"mb-2\">\r\n                    <span class=\"badge\" style=\"background-color: var(--fb-warning);\">Started</span>\r\n                    - WO is currently in progress\r\n                </div>\r\n                <div class=\"mb-2\">\r\n                    <span class=\"badge\" style=\"background-color: var(--fb-success);\">Fulfilled</span>\r\n                    - WO has been completed\r\n                </div>\r\n                <div class=\"mb-2\">\r\n                    <span class=\"badge\" style=\"background-color: var(--fb-danger);\">CONFLICT!</span>\r\n                    - Scheduling conflict detected (dependency not met)\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-mouse\"></i> Interactions</h5>\r\n                <ul class=\"small\">\r\n                    <li><strong>Drag WO:</strong> Click and drag a WO bar to reschedule it</li>\r\n                    <li><strong>Resize WO:</strong> Drag the left or right edge to adjust start/finish dates</li>\r\n                    <li><strong>Double-click WO:</strong> Opens the Manufacturing Order in Fishbowl</li>\r\n                    <li><strong>Hover over WO:</strong> See dependency arrows highlighted</li>\r\n                    <li><strong>Drag timeline:</strong> Hold Ctrl/Cmd and drag, or use scroll wheel</li>\r\n                    <li><strong>Zoom:</strong> Pinch gesture or Ctrl+scroll, or use zoom buttons</li>\r\n                </ul>\r\n            </div>\r\n\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-diagram-3\"></i> Dependencies & Conflicts</h5>\r\n                <p><strong>Dependency Arrows:</strong> Gray arrows show which WOs provide parts/materials to other WOs (within the same MO only). Red arrows indicate conflicts.</p>\r\n                <p><strong>Conflict Detection:</strong> A WO turns <span style=\"color: var(--fb-danger); font-weight: bold;\">RED</span> when a dependent WO's scheduled finish date is AFTER (or same day if \"Allow same-day starts\" is disabled) the current WO's start date.</p>\r\n                <p class=\"small\"><em>Example: If WO-002 needs parts from WO-001, but WO-001 finishes on Dec 15 and WO-002 starts on Dec 10, WO-002 will be RED.</em></p>\r\n            </div>\r\n\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-layout-three-columns\"></i> View Modes</h5>\r\n                <p><strong>MO Gantt View:</strong> Groups WOs by Manufacturing Order. Best for tracking individual order progress and dependencies.</p>\r\n                <p><strong>Category Swim Lane View:</strong> Groups WOs by manufacturing category (Fabrication, Powdercoating, etc.). Best for capacity planning and resource utilization across categories.</p>\r\n            </div>\r\n\r\n            <div class=\"config-group\">\r\n                <h5><i class=\"bi bi-calendar3\"></i> Category Colors</h5>\r\n                <p>In Category Swim Lane View, each category swim lane is colored according to the Calendar Category defined in Fishbowl. This helps quickly identify different manufacturing processes.</p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"container-fluid p-4\">\r\n        <!-- Header -->\r\n        <div class=\"row mb-3\">\r\n            <div class=\"col\">\r\n                <h2>\r\n                    <i class=\"bi bi-diagram-3\"></i>\r\n                    Work Order Capacity Planning - Gantt Chart\r\n                </h2>\r\n                <p class=\"text-muted\">Toggle between MO Gantt View and Category Swim Lane View</p>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Compact Controls -->\r\n        <div class=\"info-card\">\r\n            <div class=\"row align-items-center g-2\">\r\n                <div class=\"col-auto\">\r\n                    <div class=\"btn-group btn-group-sm\" role=\"group\">\r\n                        <button id=\"moViewBtn\" class=\"view-toggle-btn btn-sm active\">\r\n                            <i class=\"bi bi-list-nested\"></i> MO Gantt\r\n                        </button>\r\n                        <button id=\"categoryViewBtn\" class=\"view-toggle-btn btn-sm\">\r\n                            <i class=\"bi bi-layout-three-columns\"></i> Category\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-auto\">\r\n                    <select class=\"form-select form-select-sm\" id=\"moFilter\" style=\"min-width: 200px;\">\r\n                        <option value=\"all\">All MOs</option>\r\n                    </select>\r\n                </div>\r\n                <div class=\"col-auto\">\r\n                    <select class=\"form-select form-select-sm\" id=\"statusFilter\" style=\"min-width: 120px;\">\r\n                        <option value=\"all\">All Statuses</option>\r\n                        <option value=\"10\">Entered</option>\r\n                        <option value=\"30\">Started</option>\r\n                        <option value=\"40\">Fulfilled</option>\r\n                        <option value=\"conflict\">Conflicts</option>\r\n                    </select>\r\n                </div>\r\n                <div class=\"col-auto ms-auto\">\r\n                    <div class=\"d-flex gap-2 align-items-center\">\r\n                        <div class=\"btn-group btn-group-sm\" role=\"group\">\r\n                            <button id=\"undoBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Undo\" disabled>\r\n                                <i class=\"bi bi-arrow-counterclockwise\"></i>\r\n                            </button>\r\n                            <button id=\"redoBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Redo\" disabled>\r\n                                <i class=\"bi bi-arrow-clockwise\"></i>\r\n                            </button>\r\n                        </div>\r\n                        <button id=\"refreshDataBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Refresh Data\">\r\n                            <i class=\"bi bi-arrow-repeat\"></i>\r\n                        </button>\r\n                        <div class=\"btn-group btn-group-sm\" role=\"group\">\r\n                            <button id=\"zoomInBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Zoom In\">\r\n                                <i class=\"bi bi-zoom-in\"></i>\r\n                            </button>\r\n                            <button id=\"zoomOutBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Zoom Out\">\r\n                                <i class=\"bi bi-zoom-out\"></i>\r\n                            </button>\r\n                        </div>\r\n                        <div class=\"btn-group btn-group-sm\" role=\"group\">\r\n                            <button id=\"prevWeekBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Previous Week\">\r\n                                <i class=\"bi bi-chevron-left\"></i>\r\n                            </button>\r\n                            <button id=\"nextWeekBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Next Week\">\r\n                                <i class=\"bi bi-chevron-right\"></i>\r\n                            </button>\r\n                        </div>\r\n                        <div class=\"btn-group btn-group-sm\" role=\"group\">\r\n                            <button id=\"zoomWeekBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Show 1 Week\">1W</button>\r\n                            <button id=\"zoom2WeeksBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Show 2 Weeks\">2W</button>\r\n                            <button id=\"zoomMonthBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Show 1 Month\">1M</button>\r\n                            <button id=\"zoom3MonthsBtn\" class=\"btn btn-outline-secondary btn-sm\" title=\"Show 3 Months\">3M</button>\r\n                        </div>\r\n                        <div class=\"btn-group btn-group-sm\" role=\"group\">\r\n                            <button id=\"todayBtn\" class=\"btn btn-outline-primary btn-sm\">\r\n                                <i class=\"bi bi-calendar-day\"></i> Today\r\n                            </button>\r\n                        </div>\r\n                        <button id=\"shiftDependentWOs\" class=\"toggle-icon-btn btn-sm\" title=\"Shift dependent WOs when dragging\">\r\n                            <i class=\"bi bi-arrow-left-right\"></i>\r\n                        </button>\r\n                        <button id=\"allowSameDayStart\" class=\"toggle-icon-btn btn-sm active\" title=\"Allow same-day starts (dependencies can finish on the same day WO starts)\">\r\n                            <i class=\"bi bi-calendar-check\"></i>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Timeline Container -->\r\n        <div id=\"visualization\"></div>\r\n        <div id=\"emptyState\" class=\"empty-state\" style=\"display: none;\">\r\n            <i class=\"bi bi-inbox\"></i>\r\n            <h3>No Work Orders Found</h3>\r\n            <p>Try adjusting your filters or date range</p>\r\n        </div>\r\n\r\n        <!-- Info Panel -->\r\n        <div class=\"info-card\">\r\n            <div class=\"row\">\r\n                <div class=\"col-md-6\">\r\n                    <h6>Interaction Guide</h6>\r\n                    <ul class=\"small mb-0\">\r\n                        <li><strong>Drag WO:</strong> Click and drag to reschedule</li>\r\n                        <li><strong>Resize WO:</strong> Drag left/right edge to adjust start/finish dates</li>\r\n                        <li><strong>Drag Timeline:</strong> Hold Ctrl/Cmd and drag, or use scroll wheel</li>\r\n                        <li><strong>Zoom:</strong> Pinch or Ctrl+scroll, or use zoom buttons</li>\r\n                    </ul>\r\n                </div>\r\n                <div class=\"col-md-6\" id=\"statsPanel\">\r\n                    <h6>Statistics</h6>\r\n                    <p class=\"small mb-1\"><strong>Total WOs:</strong> <span id=\"totalWOs\">0</span></p>\r\n                    <p class=\"small mb-1\"><strong>Total MOs:</strong> <span id=\"totalMOs\">0</span></p>\r\n                    <p class=\"small mb-1\"><strong>Dependencies:</strong> <span id=\"totalDeps\">0</span></p>\r\n                    <p class=\"small mb-0\"><strong>Conflicts:</strong> <span id=\"totalConflicts\">0</span></p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Debug Console -->\r\n        <div class=\"debug-section\">\r\n            <div class=\"accordion\" id=\"debugAccordion\">\r\n                <div class=\"accordion-item\">\r\n                    <h2 class=\"accordion-header\">\r\n                        <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#debugContent\">\r\n                            <i class=\"bi bi-bug-fill me-2\"></i> Debug Console\r\n                        </button>\r\n                    </h2>\r\n                    <div id=\"debugContent\" class=\"accordion-collapse collapse\">\r\n                        <div class=\"accordion-body p-0\">\r\n                            <div class=\"p-2 bg-dark text-white d-flex justify-content-between align-items-center\">\r\n                                <small>Debug log - Auto-scrolls to latest entry</small>\r\n                                <button class=\"btn btn-sm btn-outline-light\" onclick=\"clearDebugLog()\">\r\n                                    <i class=\"bi bi-trash\"></i> Clear\r\n                                </button>\r\n                            </div>\r\n                            <div class=\"debug-content\" id=\"debugLog\">\r\n                                <div class=\"debug-entry\">\r\n                                    <span class=\"debug-timestamp\">[00:00:00]</span>\r\n                                    <span class=\"debug-type info\">[INFO]</span>\r\n                                    <span class=\"debug-message\">Debug console initialized</span>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Moment.js for date handling -->\r\n    <script src=\"https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js\"></script>\r\n\r\n    <!-- vis-timeline JS -->\r\n    <script src=\"https://unpkg.com/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js\"></script>\r\n\r\n    <!-- Bootstrap JS -->\r\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\r\n\r\n<script>\r\n{% Script Util %}\r\n\r\n// ============================================\r\n// Global Variables\r\n// ============================================\r\nlet timeline = null;\r\nlet viewMode = 'mo'; // 'mo' or 'category'\r\nlet allWorkOrders = [];\r\nlet filteredWorkOrders = [];\r\nlet stagingDependencies = [];\r\nlet manufacturingOrders = [];\r\nlet activeStatusFilter = null;\r\nlet groups = [];\r\nlet items = [];\r\n\r\n// Undo/Redo stacks\r\nlet undoStack = [];\r\nlet redoStack = [];\r\nconst MAX_UNDO_STACK = 50; // Limit stack size to prevent memory issues\r\n\r\n// ============================================\r\n// Debug Logging Functions\r\n// ============================================\r\nfunction debugLog(type, message, data = null) {\r\n    const timestamp = new Date().toLocaleTimeString();\r\n    const logEntry = document.createElement('div');\r\n    logEntry.className = 'debug-entry';\r\n\r\n    let html = `\r\n        <span class=\"debug-timestamp\">[${timestamp}]</span>\r\n        <span class=\"debug-type ${type}\">[${type.toUpperCase()}]</span>\r\n        <span class=\"debug-message\">${message}</span>\r\n    `;\r\n\r\n    if (data) {\r\n        const dataStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);\r\n        html += `<div class=\"debug-data\">${dataStr}</div>`;\r\n    }\r\n\r\n    logEntry.innerHTML = html;\r\n\r\n    const debugLogEl = document.getElementById('debugLog');\r\n    if (debugLogEl) {\r\n        debugLogEl.appendChild(logEntry);\r\n        debugLogEl.scrollTop = debugLogEl.scrollHeight;\r\n    }\r\n\r\n    console.log(`[${type.toUpperCase()}] ${message}`, data);\r\n}\r\n\r\nfunction clearDebugLog() {\r\n    const debugLogEl = document.getElementById('debugLog');\r\n    if (debugLogEl) {\r\n        debugLogEl.innerHTML = `\r\n            <div class=\"debug-entry\">\r\n                <span class=\"debug-timestamp\">[${new Date().toLocaleTimeString()}]</span>\r\n                <span class=\"debug-type info\">[INFO]</span>\r\n                <span class=\"debug-message\">Debug log cleared</span>\r\n            </div>\r\n        `;\r\n    }\r\n}\r\n\r\n// ============================================\r\n// Loading Indicator\r\n// ============================================\r\nfunction showLoading(show) {\r\n    const overlay = document.getElementById('loadingOverlay');\r\n    if (show) {\r\n        overlay.classList.add('show');\r\n    } else {\r\n        overlay.classList.remove('show');\r\n    }\r\n}\r\n\r\nfunction showEmptyState(show) {\r\n    document.getElementById('emptyState').style.display = show ? 'block' : 'none';\r\n    document.getElementById('visualization').style.display = show ? 'none' : 'block';\r\n}\r\n\r\n// ============================================\r\n// Toast Notifications\r\n// ============================================\r\nfunction showToast(message, type = 'info', sticky = false) {\r\n    debugLog(type, message);\r\n\r\n    const toastContainer = document.querySelector('.toast-container');\r\n    if (!toastContainer) {\r\n        console.error('Toast container not found');\r\n        return;\r\n    }\r\n\r\n    // Create unique ID for this toast\r\n    const toastId = 'toast_' + Date.now();\r\n\r\n    // Determine icon and colors based on type\r\n    let icon, bgClass, headerText;\r\n    switch (type) {\r\n        case 'success':\r\n            icon = 'bi-check-circle-fill';\r\n            bgClass = 'bg-success';\r\n            headerText = 'Success';\r\n            break;\r\n        case 'error':\r\n            icon = 'bi-exclamation-triangle-fill';\r\n            bgClass = 'bg-danger';\r\n            headerText = 'Error';\r\n            break;\r\n        case 'warning':\r\n            icon = 'bi-exclamation-circle-fill';\r\n            bgClass = 'bg-warning';\r\n            headerText = 'Warning';\r\n            break;\r\n        default:\r\n            icon = 'bi-info-circle-fill';\r\n            bgClass = 'bg-info';\r\n            headerText = 'Info';\r\n    }\r\n\r\n    // Create toast element\r\n    const toastEl = document.createElement('div');\r\n    toastEl.id = toastId;\r\n    toastEl.className = 'toast';\r\n    toastEl.setAttribute('role', 'alert');\r\n    toastEl.setAttribute('aria-live', 'assertive');\r\n    toastEl.setAttribute('aria-atomic', 'true');\r\n\r\n    // Set autohide based on sticky parameter (errors are persistent)\r\n    if (sticky || type === 'error') {\r\n        toastEl.setAttribute('data-bs-autohide', 'false');\r\n    } else {\r\n        toastEl.setAttribute('data-bs-autohide', 'true');\r\n        toastEl.setAttribute('data-bs-delay', '5000');\r\n    }\r\n\r\n    toastEl.innerHTML = `\r\n        <div class=\"toast-header ${bgClass} text-white\">\r\n            <i class=\"bi ${icon} me-2\"></i>\r\n            <strong class=\"me-auto\">${headerText}</strong>\r\n            <small>just now</small>\r\n            <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"toast\" aria-label=\"Close\"></button>\r\n        </div>\r\n        <div class=\"toast-body\">\r\n            ${message}\r\n        </div>\r\n    `;\r\n\r\n    // Add to container\r\n    toastContainer.appendChild(toastEl);\r\n\r\n    // Initialize and show toast\r\n    const toast = new bootstrap.Toast(toastEl);\r\n    toast.show();\r\n\r\n    // Remove from DOM after hidden (if not sticky)\r\n    if (!sticky && type !== 'error') {\r\n        toastEl.addEventListener('hidden.bs.toast', function() {\r\n            toastEl.remove();\r\n        });\r\n    }\r\n}\r\n\r\n// ============================================\r\n// Load Work Orders from Database\r\n// ============================================\r\nfunction loadWorkOrders() {\r\n    showLoading(true);\r\n\r\n    const woQuery = `\r\n        SELECT\r\n            mo.num AS mo_num,\r\n            mo.id AS mo_id,\r\n            wo.id AS wo_id,\r\n            wo.num AS wo_num,\r\n            wo.statusid AS wo_status,\r\n            CASE wo.statusid\r\n                WHEN 10 THEN 'Entered'\r\n                WHEN 30 THEN 'Started'\r\n                WHEN 40 THEN 'Fulfilled'\r\n                ELSE 'Unknown'\r\n            END AS wo_status_name,\r\n            moitem.description AS description,\r\n            COALESCE(bom.estimatedDuration, 0) * COALESCE(wo.qtyTarget, 0) AS estimated_duration,\r\n            COALESCE(wo.datescheduled, moitem.datescheduled) AS date_scheduled,\r\n            COALESCE(wo.datescheduledtostart, moitem.datescheduledtostart) AS date_scheduled_start,\r\n            wo.datefinished AS date_finished,\r\n            COALESCE(calcat.name, '') AS calendar_category,\r\n            COALESCE(calcat.color, 'CCCCCC') AS category_color,\r\n            wo.qtyTarget AS qty_target,\r\n            (SELECT part.num FROM woitem\r\n             LEFT JOIN part ON woitem.partid = part.id\r\n             WHERE woitem.woid = wo.id AND woitem.typeid = 10\r\n             LIMIT 1) AS part_num\r\n        FROM wo\r\n        LEFT JOIN moitem ON wo.moitemid = moitem.id\r\n        LEFT JOIN mo ON moitem.moid = mo.id\r\n        LEFT JOIN bom ON moitem.bomid = bom.id\r\n        LEFT JOIN calcategory AS calcat ON wo.calcategoryid = calcat.id\r\n        WHERE wo.num IS NOT NULL\r\n            AND wo.statusid IN (10, 30, 40)\r\n            AND moitem.typeid = 50\r\n        ORDER BY mo.num, wo.num\r\n    `;\r\n\r\n    const depQuery = `\r\n        SELECT DISTINCT\r\n            wo.id AS wo_id,\r\n            wo.num AS wo_num,\r\n            staging_wo.id AS staging_wo_id,\r\n            staging_wo.num AS staging_wo_num,\r\n            COALESCE(staging_wo.datescheduled, staging_moitem.datescheduled) AS staging_wo_finish,\r\n            COALESCE(wo.datescheduledtostart, current_moitem.datescheduledtostart) AS wo_start,\r\n            part.num AS part_num\r\n        FROM wo\r\n        LEFT JOIN moitem AS current_moitem ON wo.moitemid = current_moitem.id\r\n        LEFT JOIN mo AS current_mo ON current_moitem.moid = current_mo.id\r\n        LEFT JOIN woitem ON woitem.woid = wo.id AND woitem.typeid = 20\r\n        LEFT JOIN part ON woitem.partid = part.id\r\n        LEFT JOIN woitem AS staging_woitem ON staging_woitem.partid = part.id AND staging_woitem.typeid = 10\r\n        LEFT JOIN wo AS staging_wo ON staging_woitem.woid = staging_wo.id\r\n        LEFT JOIN moitem AS staging_moitem ON staging_wo.moitemid = staging_moitem.id\r\n        LEFT JOIN mo AS staging_mo ON staging_moitem.moid = staging_mo.id\r\n        WHERE wo.num IS NOT NULL\r\n            AND wo.statusid IN (10, 30, 40)\r\n            AND staging_wo.num IS NOT NULL\r\n            AND staging_wo.id != wo.id\r\n            AND current_mo.id = staging_mo.id\r\n    `;\r\n\r\n    const moQuery = `\r\n        SELECT DISTINCT\r\n            mo.num AS mo_num,\r\n            mo.id AS mo_id,\r\n            mo.statusid AS mo_status,\r\n            mo.datescheduled AS mo_date_scheduled,\r\n            part.num AS part_num,\r\n            moitem.description AS description,\r\n            moitem.qtytofulfill AS qty,\r\n            bom.num AS bom_num\r\n        FROM mo\r\n        LEFT JOIN moitem ON moitem.moid = mo.id\r\n        LEFT JOIN part ON moitem.partid = part.id\r\n        LEFT JOIN bom ON moitem.bomid = bom.id\r\n        WHERE moitem.typeid = 50\r\n            AND moitem.parentid IS NULL\r\n            AND mo.id IN (\r\n                SELECT DISTINCT mo.id\r\n                FROM wo\r\n                LEFT JOIN moitem ON wo.moitemid = moitem.id\r\n                LEFT JOIN mo ON moitem.moid = mo.id\r\n                WHERE wo.num IS NOT NULL AND wo.statusid IN (10, 30, 40)\r\n            )\r\n        ORDER BY mo.num\r\n    `;\r\n\r\n    try {\r\n        debugLog('info', 'Starting to load work orders...');\r\n\r\n        // Load WOs\r\n        const woResults = JSON.parse(runQuery(woQuery));\r\n        allWorkOrders = woResults;\r\n        debugLog('success', `Loaded ${allWorkOrders.length} work orders`);\r\n\r\n        // Load staging dependencies\r\n        const depResults = JSON.parse(runQuery(depQuery));\r\n        stagingDependencies = depResults;\r\n        debugLog('success', `Loaded ${stagingDependencies.length} staging dependencies`);\r\n\r\n        // Load MO finished goods\r\n        const moResults = JSON.parse(runQuery(moQuery));\r\n        manufacturingOrders = moResults;\r\n        debugLog('success', `Loaded ${manufacturingOrders.length} MO finished goods`);\r\n\r\n        // Filter old fulfilled MOs\r\n        filterOldFulfilledMOs();\r\n\r\n        // Populate MO filter\r\n        populateMOFilter();\r\n\r\n        // Initialize timeline\r\n        initTimeline();\r\n\r\n        showLoading(false);\r\n    } catch (error) {\r\n        debugLog('error', 'Error loading work orders', error.toString());\r\n        showToast('Error loading work orders: ' + error.toString(), 'error', true);\r\n        showLoading(false);\r\n        showEmptyState(true);\r\n    }\r\n}\r\n\r\n// ============================================\r\n// Filter Completed/Closed MOs\r\n// ============================================\r\nfunction filterOldFulfilledMOs() {\r\n    const filteredOutMOs = new Set();\r\n\r\n    // Group WOs by MO\r\n    const wosByMO = {};\r\n    allWorkOrders.forEach(wo => {\r\n        if (!wosByMO[wo.mo_num]) {\r\n            wosByMO[wo.mo_num] = [];\r\n        }\r\n        wosByMO[wo.mo_num].push(wo);\r\n    });\r\n\r\n    // Check each MO\r\n    Object.keys(wosByMO).forEach(moNum => {\r\n        const moInfo = manufacturingOrders.find(mo => mo.mo_num === moNum);\r\n\r\n        if (moInfo && moInfo.mo_status) {\r\n            // Filter out Fulfilled (60), Closed Short (70), and Void (80)\r\n            if (moInfo.mo_status === 60 || moInfo.mo_status === 70 || moInfo.mo_status === 80) {\r\n                filteredOutMOs.add(moNum);\r\n                const statusName = moInfo.mo_status === 60 ? 'Fulfilled' :\r\n                                   moInfo.mo_status === 70 ? 'Closed Short' : 'Void';\r\n                debugLog('info', `Filtering out MO ${moNum} - status ${statusName} (${moInfo.mo_status})`);\r\n            }\r\n        }\r\n    });\r\n\r\n    // Remove filtered MOs from allWorkOrders\r\n    allWorkOrders = allWorkOrders.filter(wo => !filteredOutMOs.has(wo.mo_num));\r\n\r\n    debugLog('success', `Filtered out ${filteredOutMOs.size} MOs (Fulfilled/Closed Short/Void)`);\r\n}\r\n\r\n// ============================================\r\n// Populate MO Filter\r\n// ============================================\r\nfunction populateMOFilter() {\r\n    const moFilter = document.getElementById('moFilter');\r\n    const moFilterOffcanvas = document.getElementById('moFilterOffcanvas');\r\n    const uniqueMOs = [...new Set(allWorkOrders.map(wo => wo.mo_num))].sort();\r\n\r\n    const allOption = '<option value=\"all\">All MOs</option>';\r\n    moFilter.innerHTML = allOption;\r\n    moFilterOffcanvas.innerHTML = allOption;\r\n\r\n    uniqueMOs.forEach(moNum => {\r\n        const moInfo = manufacturingOrders.find(mo => mo.mo_num === moNum);\r\n        const partNum = moInfo ? moInfo.part_num : '';\r\n        const bomNum = moInfo ? moInfo.bom_num : '';\r\n        const qty = moInfo ? moInfo.qty : '';\r\n\r\n        let optionText = `MO ${moNum}`;\r\n        if (partNum) {\r\n            optionText += ` - ${partNum}`;\r\n        }\r\n        if (bomNum) {\r\n            optionText += ` (BOM: ${bomNum})`;\r\n        }\r\n        if (qty) {\r\n            optionText += ` [Qty: ${qty}]`;\r\n        }\r\n\r\n        const option = document.createElement('option');\r\n        option.value = moNum;\r\n        option.textContent = optionText;\r\n        moFilter.appendChild(option);\r\n\r\n        const optionOffcanvas = document.createElement('option');\r\n        optionOffcanvas.value = moNum;\r\n        optionOffcanvas.textContent = optionText;\r\n        moFilterOffcanvas.appendChild(optionOffcanvas);\r\n    });\r\n\r\n    // Sync main filter with offcanvas\r\n    moFilter.addEventListener('change', function() {\r\n        moFilterOffcanvas.value = this.value;\r\n        rebuildTimeline();\r\n    });\r\n\r\n    moFilterOffcanvas.addEventListener('change', function() {\r\n        moFilter.value = this.value;\r\n        rebuildTimeline();\r\n    });\r\n}\r\n\r\n// ============================================\r\n// Undo/Redo Functions\r\n// ============================================\r\n\r\nfunction saveStateForUndo() {\r\n    // Create a deep copy of current state\r\n    const state = {\r\n        allWorkOrders: JSON.parse(JSON.stringify(allWorkOrders)),\r\n        filteredWorkOrders: JSON.parse(JSON.stringify(filteredWorkOrders)),\r\n        stagingDependencies: JSON.parse(JSON.stringify(stagingDependencies)),\r\n        timestamp: Date.now()\r\n    };\r\n\r\n    // Add to undo stack\r\n    undoStack.push(state);\r\n\r\n    // Limit stack size\r\n    if (undoStack.length > MAX_UNDO_STACK) {\r\n        undoStack.shift(); // Remove oldest\r\n    }\r\n\r\n    // Clear redo stack when new action is performed\r\n    redoStack = [];\r\n\r\n    // Update button states\r\n    updateUndoRedoButtons();\r\n\r\n    debugLog('info', `State saved for undo (stack size: ${undoStack.length})`);\r\n}\r\n\r\nfunction restoreState(state) {\r\n    // Restore data arrays\r\n    allWorkOrders = JSON.parse(JSON.stringify(state.allWorkOrders));\r\n    filteredWorkOrders = JSON.parse(JSON.stringify(state.filteredWorkOrders));\r\n    stagingDependencies = JSON.parse(JSON.stringify(state.stagingDependencies));\r\n\r\n    // Rebuild timeline items with restored data\r\n    items = buildItems();\r\n    timeline.setItems(items);\r\n\r\n    // Update conflicts and arrows\r\n    updateConflictHighlighting();\r\n\r\n    debugLog('success', 'State restored');\r\n}\r\n\r\nfunction undo() {\r\n    if (undoStack.length === 0) {\r\n        debugLog('warning', 'Nothing to undo');\r\n        return;\r\n    }\r\n\r\n    // Save current state to redo stack first\r\n    const currentState = {\r\n        allWorkOrders: JSON.parse(JSON.stringify(allWorkOrders)),\r\n        filteredWorkOrders: JSON.parse(JSON.stringify(filteredWorkOrders)),\r\n        stagingDependencies: JSON.parse(JSON.stringify(stagingDependencies)),\r\n        timestamp: Date.now()\r\n    };\r\n    redoStack.push(currentState);\r\n\r\n    // Pop from undo stack and restore\r\n    const previousState = undoStack.pop();\r\n    restoreState(previousState);\r\n\r\n    // Update button states\r\n    updateUndoRedoButtons();\r\n\r\n    debugLog('success', `Undo performed (undo stack: ${undoStack.length}, redo stack: ${redoStack.length})`);\r\n}\r\n\r\nfunction redo() {\r\n    if (redoStack.length === 0) {\r\n        debugLog('warning', 'Nothing to redo');\r\n        return;\r\n    }\r\n\r\n    // Save current state to undo stack first\r\n    const currentState = {\r\n        allWorkOrders: JSON.parse(JSON.stringify(allWorkOrders)),\r\n        filteredWorkOrders: JSON.parse(JSON.stringify(filteredWorkOrders)),\r\n        stagingDependencies: JSON.parse(JSON.stringify(stagingDependencies)),\r\n        timestamp: Date.now()\r\n    };\r\n    undoStack.push(currentState);\r\n\r\n    // Pop from redo stack and restore\r\n    const nextState = redoStack.pop();\r\n    restoreState(nextState);\r\n\r\n    // Update button states\r\n    updateUndoRedoButtons();\r\n\r\n    debugLog('success', `Redo performed (undo stack: ${undoStack.length}, redo stack: ${redoStack.length})`);\r\n}\r\n\r\nfunction updateUndoRedoButtons() {\r\n    const undoBtn = document.getElementById('undoBtn');\r\n    const redoBtn = document.getElementById('redoBtn');\r\n\r\n    if (undoBtn) {\r\n        undoBtn.disabled = undoStack.length === 0;\r\n        undoBtn.title = undoStack.length > 0 ? `Undo (${undoStack.length} actions)` : 'Nothing to undo';\r\n    }\r\n\r\n    if (redoBtn) {\r\n        redoBtn.disabled = redoStack.length === 0;\r\n        redoBtn.title = redoStack.length > 0 ? `Redo (${redoStack.length} actions)` : 'Nothing to redo';\r\n    }\r\n}\r\n\r\n// ============================================\r\n// Helper Functions\r\n// ============================================\r\n\r\nfunction getStatusClass(wo) {\r\n    if (wo.wo_status === 10) return 'status-entered';\r\n    if (wo.wo_status === 30) return 'status-started';\r\n    if (wo.wo_status === 40) return 'status-fulfilled';\r\n    return '';\r\n}\r\n\r\nfunction getMOStatusClass(moNum) {\r\n    const wos = allWorkOrders.filter(wo => wo.mo_num === moNum);\r\n    const statuses = wos.map(wo => wo.wo_status);\r\n\r\n    if (statuses.includes(30)) return 'status-started';\r\n    if (statuses.every(s => s === 40)) return 'status-fulfilled';\r\n    if (statuses.every(s => s === 10)) return 'status-entered';\r\n    return '';\r\n}\r\n\r\nfunction lightenColor(hex, percent) {\r\n    // Remove # if present\r\n    hex = hex.replace('#', '');\r\n\r\n    // Convert to RGB\r\n    let r = parseInt(hex.substring(0, 2), 16);\r\n    let g = parseInt(hex.substring(2, 4), 16);\r\n    let b = parseInt(hex.substring(4, 6), 16);\r\n\r\n    // Lighten\r\n    r = Math.min(255, Math.floor(r + (255 - r) * percent));\r\n    g = Math.min(255, Math.floor(g + (255 - g) * percent));\r\n    b = Math.min(255, Math.floor(b + (255 - b) * percent));\r\n\r\n    // Convert back to hex\r\n    return '#' + [r, g, b].map(x => {\r\n        const hex = x.toString(16);\r\n        return hex.length === 1 ? '0' + hex : hex;\r\n    }).join('');\r\n}\r\n\r\nfunction skipWeekends(date) {\r\n    const checkbox = document.getElementById('skipWeekendsOffcanvas');\r\n    const skipWeekendsEnabled = checkbox ? checkbox.checked : false;\r\n\r\n    if (!skipWeekendsEnabled) {\r\n        return date;\r\n    }\r\n\r\n    const m = moment(date);\r\n    const dayOfWeek = m.day();\r\n    const originalDate = m.format('YYYY-MM-DD');\r\n\r\n    // If Saturday (6), move to Monday (+2 days)\r\n    if (dayOfWeek === 6) {\r\n        const newDate = m.add(2, 'days').toDate();\r\n        debugLog('info', `Skip weekends: ${originalDate} (Sat)  ${moment(newDate).format('YYYY-MM-DD')} (Mon)`);\r\n        return newDate;\r\n    }\r\n    // If Sunday (0), move to Monday (+1 day)\r\n    if (dayOfWeek === 0) {\r\n        const newDate = m.add(1, 'day').toDate();\r\n        debugLog('info', `Skip weekends: ${originalDate} (Sun)  ${moment(newDate).format('YYYY-MM-DD')} (Mon)`);\r\n        return newDate;\r\n    }\r\n\r\n    return date;\r\n}\r\n\r\n// ============================================\r\n// Build Groups Based on View Mode\r\n// ============================================\r\n\r\nfunction buildMOGroups() {\r\n    const moGroups = [];\r\n    const moNums = [...new Set(filteredWorkOrders.map(wo => wo.mo_num))].sort();\r\n\r\n    moNums.forEach(moNum => {\r\n        const moInfo = manufacturingOrders.find(mo => mo.mo_num === moNum);\r\n\r\n        // Build MO label with part number, BOM number, and quantity\r\n        const partNum = moInfo ? moInfo.part_num : '';\r\n        const bomNum = moInfo ? moInfo.bom_num : '';\r\n        const qty = moInfo ? moInfo.qty : '';\r\n\r\n        let moLabel = `<strong>MO ${moNum}</strong>`;\r\n        if (partNum) {\r\n            moLabel += ` - ${partNum}`;\r\n        }\r\n        if (bomNum) {\r\n            moLabel += ` (BOM: ${bomNum})`;\r\n        }\r\n        if (qty) {\r\n            moLabel += ` [Qty: ${qty}]`;\r\n        }\r\n\r\n        // MO header group\r\n        moGroups.push({\r\n            id: `mo_${moNum}`,\r\n            content: moLabel,\r\n            nestedGroups: [`mo_${moNum}_wos`]\r\n        });\r\n\r\n        // Nested group for WOs\r\n        moGroups.push({\r\n            id: `mo_${moNum}_wos`,\r\n            content: `   Work Orders`\r\n        });\r\n    });\r\n\r\n    return moGroups;\r\n}\r\n\r\nfunction buildCategoryGroups() {\r\n    // Get unique categories and count WOs in each\r\n    const categoryMap = {};\r\n    filteredWorkOrders.forEach(wo => {\r\n        const category = wo.calendar_category || 'Unassigned';\r\n        const color = wo.category_color || 'CCCCCC';\r\n\r\n        if (!categoryMap[category]) {\r\n            categoryMap[category] = {\r\n                count: 0,\r\n                color: color,\r\n                wos: []\r\n            };\r\n        }\r\n        categoryMap[category].count++;\r\n        categoryMap[category].wos.push(wo);\r\n    });\r\n\r\n    // Build groups with color backgrounds\r\n    const catGroups = [];\r\n    Object.keys(categoryMap).sort().forEach(category => {\r\n        const info = categoryMap[category];\r\n        const bgColor = '#' + info.color;\r\n        const lightBgColor = lightenColor(bgColor, 0.5); // Reduced from 0.85 - more visible colors\r\n\r\n        catGroups.push({\r\n            id: `cat_${category}`,\r\n            content: `${category} (${info.count})`,\r\n            className: 'category-label',\r\n            // Store color in a data attribute for later application\r\n            treeLevel: 1,\r\n            // Store the color info so we can apply it after render\r\n            categoryColor: lightBgColor\r\n        });\r\n    });\r\n\r\n    return catGroups;\r\n}\r\n\r\n// ============================================\r\n// Detect Conflicts\r\n// ============================================\r\n\r\nfunction detectConflicts() {\r\n    const conflicts = new Set();\r\n    const allowSameDay = document.getElementById('allowSameDayStart').classList.contains('active');\r\n\r\n    debugLog('info', `Detecting conflicts (allowSameDay: ${allowSameDay})...`);\r\n\r\n    filteredWorkOrders.forEach(wo => {\r\n        // Check 1: Dependencies - WO depends on staging WO that finishes too late\r\n        const deps = stagingDependencies.filter(d => d.wo_id === wo.wo_id);\r\n\r\n        deps.forEach(dep => {\r\n            // Find the staging WO to check its status\r\n            const stagingWO = allWorkOrders.find(w => w.wo_id === dep.staging_wo_id);\r\n\r\n            // If staging WO is Fulfilled (status 40), it's already finished - no conflict\r\n            if (stagingWO && stagingWO.wo_status === 40) {\r\n                debugLog('info', `No conflict: WO ${dep.staging_wo_num} is Fulfilled (actual work complete)`);\r\n                return;\r\n            }\r\n\r\n            // Strip time component - compare only dates\r\n            const stagingFinish = moment(dep.staging_wo_finish).startOf('day');\r\n            const currentStart = moment(wo.date_scheduled_start).startOf('day');\r\n\r\n            let isConflict = false;\r\n            if (allowSameDay) {\r\n                // If same-day starts allowed, only conflict if staging finishes AFTER (not on same day)\r\n                isConflict = stagingFinish.isAfter(currentStart);\r\n            } else {\r\n                // If same-day starts NOT allowed, conflict if staging finishes on or after start day\r\n                isConflict = stagingFinish.isSameOrAfter(currentStart);\r\n            }\r\n\r\n            if (isConflict) {\r\n                conflicts.add(wo.wo_id);\r\n                debugLog('warning', `CONFLICT: WO ${wo.wo_num} starts ${wo.date_scheduled_start} but depends on WO ${dep.staging_wo_num} which finishes ${dep.staging_wo_finish} (allowSameDay: ${allowSameDay})`);\r\n            }\r\n        });\r\n\r\n        // Check 2: MO deadline - WO finishes after MO scheduled date\r\n        const moInfo = manufacturingOrders.find(mo => mo.mo_num === wo.mo_num);\r\n        if (moInfo && moInfo.mo_date_scheduled) {\r\n            // Strip time component - compare only dates\r\n            const woFinish = moment(wo.date_scheduled).startOf('day');\r\n            const moScheduled = moment(moInfo.mo_date_scheduled).startOf('day');\r\n\r\n            if (woFinish.isAfter(moScheduled)) {\r\n                conflicts.add(wo.wo_id);\r\n                debugLog('warning', `CONFLICT: WO ${wo.wo_num} finishes ${wo.date_scheduled} after MO ${wo.mo_num} scheduled date ${moInfo.mo_date_scheduled}`);\r\n            }\r\n        }\r\n    });\r\n\r\n    debugLog('info', `Detected ${conflicts.size} conflicts`);\r\n    return conflicts;\r\n}\r\n\r\n// ============================================\r\n// Build Items Based on View Mode\r\n// ============================================\r\n\r\nfunction buildItems() {\r\n    const timelineItems = [];\r\n    const conflicts = detectConflicts();\r\n\r\n    if (viewMode === 'mo') {\r\n        // Add MO headers\r\n        const moNums = [...new Set(filteredWorkOrders.map(wo => wo.mo_num))].sort();\r\n\r\n        moNums.forEach(moNum => {\r\n            const wos = filteredWorkOrders.filter(wo => wo.mo_num === moNum);\r\n            if (wos.length === 0) return;\r\n\r\n            // MO start = earliest WO start date\r\n            const starts = wos.map(wo => new Date(wo.date_scheduled_start));\r\n            const moStart = new Date(Math.min(...starts));\r\n\r\n            // MO end = MO scheduled date (not latest WO end date)\r\n            // This makes it visually obvious when a WO exceeds the MO deadline\r\n            const moInfo = manufacturingOrders.find(mo => mo.mo_num === moNum);\r\n            const moEnd = moInfo && moInfo.mo_date_scheduled\r\n                ? moment(moInfo.mo_date_scheduled).hour(12).minute(0).second(0).toDate()\r\n                : new Date(Math.max(...wos.map(wo => new Date(wo.date_scheduled))));\r\n\r\n            timelineItems.push({\r\n                id: `mo_header_${moNum}`,\r\n                group: `mo_${moNum}`,\r\n                content: `MO ${moNum}`,\r\n                start: moStart,\r\n                end: moEnd,\r\n                type: 'range',\r\n                className: `mo-header ${getMOStatusClass(moNum)}`,\r\n                title: `Manufacturing Order ${moNum}`,\r\n                editable: false  // MO headers should NOT be draggable\r\n            });\r\n        });\r\n\r\n        // Add WOs\r\n        filteredWorkOrders.forEach(wo => {\r\n            const hasConflict = conflicts.has(wo.wo_id);\r\n            const className = hasConflict ? 'conflict' : getStatusClass(wo);\r\n\r\n            // Always render at noon (12:00:00) for consistent alignment\r\n            // Special case: same-day WOs render as 6am-6pm for draggability\r\n            // Use explicit date parsing to avoid timezone issues\r\n            const startMoment = moment(wo.date_scheduled_start, 'YYYY-MM-DD');\r\n            const endMoment = moment(wo.date_scheduled, 'YYYY-MM-DD');\r\n            const isSameDay = startMoment.isSame(endMoment, 'day');\r\n\r\n            const startDate = isSameDay\r\n                ? startMoment.hour(6).minute(0).second(0).toDate()\r\n                : startMoment.hour(12).minute(0).second(0).toDate();\r\n            const endDate = isSameDay\r\n                ? endMoment.hour(18).minute(0).second(0).toDate()\r\n                : endMoment.hour(12).minute(0).second(0).toDate();\r\n\r\n            // For Fulfilled WOs with actual finish date, calculate gradient for dual shading\r\n            let itemStyle = '';\r\n            let statusDisplay = wo.wo_status_name;\r\n            if (wo.wo_status === 40 && wo.date_finished) {\r\n                const finishedMoment = moment(wo.date_finished, 'YYYY-MM-DD');\r\n                // Format as \"Fulfilled - 18 Dec\"\r\n                statusDisplay = `Fulfilled - ${finishedMoment.format('DD MMM')}`;\r\n\r\n                // Only apply gradient if finished before scheduled end\r\n                if (finishedMoment.isBefore(endMoment, 'day')) {\r\n                    // Calculate percentage of completion\r\n                    const totalDays = endMoment.diff(startMoment, 'days') + 1;\r\n                    const actualDays = finishedMoment.diff(startMoment, 'days') + 1;\r\n                    const percentComplete = Math.min(100, Math.max(0, (actualDays / totalDays) * 100));\r\n\r\n                    // Create gradient: solid green up to completion point, then light green\r\n                    // Use background-image instead of background to avoid being overridden\r\n                    itemStyle = `background-color: #2e7d32; background-image: linear-gradient(to right, #2e7d32 0%, #2e7d32 ${percentComplete}%, rgba(46, 125, 50, 0.3) ${percentComplete}%, rgba(46, 125, 50, 0.3) 100%);`;\r\n                }\r\n            }\r\n\r\n            timelineItems.push({\r\n                id: `wo_${wo.wo_id}`,\r\n                group: `mo_${wo.mo_num}_wos`,\r\n                content: `WO ${wo.wo_num}`,\r\n                start: startDate,\r\n                end: endDate,\r\n                type: 'range',\r\n                className: `${className} wo-item-${wo.wo_id}`,\r\n                style: itemStyle,\r\n                title: `WO ${wo.wo_num}\\nMO ${wo.mo_num}\\nCategory: ${wo.calendar_category}\\nPart: ${wo.part_num} (${wo.qty_target})\\nStatus: ${statusDisplay}`,\r\n                editable: {\r\n                    updateTime: true,\r\n                    updateGroup: false,\r\n                    remove: false\r\n                },\r\n                woData: wo\r\n            });\r\n        });\r\n\r\n    } else {\r\n        // Category view - all WOs grouped by category\r\n        filteredWorkOrders.forEach(wo => {\r\n            const category = wo.calendar_category || 'Unassigned';\r\n            const hasConflict = conflicts.has(wo.wo_id);\r\n            const className = hasConflict ? 'conflict' : getStatusClass(wo);\r\n\r\n            // Always render at noon (12:00:00) for consistent alignment\r\n            // Special case: same-day WOs render as 6am-6pm for draggability\r\n            // Use explicit date parsing to avoid timezone issues\r\n            const startMoment = moment(wo.date_scheduled_start, 'YYYY-MM-DD');\r\n            const endMoment = moment(wo.date_scheduled, 'YYYY-MM-DD');\r\n            const isSameDay = startMoment.isSame(endMoment, 'day');\r\n\r\n            const startDate = isSameDay\r\n                ? startMoment.hour(6).minute(0).second(0).toDate()\r\n                : startMoment.hour(12).minute(0).second(0).toDate();\r\n            const endDate = isSameDay\r\n                ? endMoment.hour(18).minute(0).second(0).toDate()\r\n                : endMoment.hour(12).minute(0).second(0).toDate();\r\n\r\n            // For Fulfilled WOs with actual finish date, calculate gradient for dual shading\r\n            let itemStyle = '';\r\n            let statusDisplay = wo.wo_status_name;\r\n            if (wo.wo_status === 40 && wo.date_finished) {\r\n                const finishedMoment = moment(wo.date_finished, 'YYYY-MM-DD');\r\n                // Format as \"Fulfilled - 18 Dec\"\r\n                statusDisplay = `Fulfilled - ${finishedMoment.format('DD MMM')}`;\r\n\r\n                // Only apply gradient if finished before scheduled end\r\n                if (finishedMoment.isBefore(endMoment, 'day')) {\r\n                    // Calculate percentage of completion\r\n                    const totalDays = endMoment.diff(startMoment, 'days') + 1;\r\n                    const actualDays = finishedMoment.diff(startMoment, 'days') + 1;\r\n                    const percentComplete = Math.min(100, Math.max(0, (actualDays / totalDays) * 100));\r\n\r\n                    // Create gradient: solid green up to completion point, then light green\r\n                    // Use background-image instead of background to avoid being overridden\r\n                    itemStyle = `background-color: #2e7d32; background-image: linear-gradient(to right, #2e7d32 0%, #2e7d32 ${percentComplete}%, rgba(46, 125, 50, 0.3) ${percentComplete}%, rgba(46, 125, 50, 0.3) 100%);`;\r\n                }\r\n            }\r\n\r\n            timelineItems.push({\r\n                id: `wo_${wo.wo_id}`,\r\n                group: `cat_${category}`,\r\n                content: `WO ${wo.wo_num} (MO ${wo.mo_num})`,\r\n                start: startDate,\r\n                end: endDate,\r\n                type: 'range',\r\n                className: `${className} wo-item-${wo.wo_id}`,\r\n                style: itemStyle,\r\n                title: `WO ${wo.wo_num}\\nMO ${wo.mo_num}\\nCategory: ${category}\\nPart: ${wo.part_num} (${wo.qty_target})\\nStatus: ${statusDisplay}`,\r\n                editable: {\r\n                    updateTime: true,\r\n                    updateGroup: false,\r\n                    remove: false\r\n                },\r\n                woData: wo\r\n            });\r\n        });\r\n    }\r\n\r\n    // Add weekend background items for better visibility\r\n    // Calculate range to cover (current view +/- some buffer)\r\n    const today = moment();\r\n    const rangeStart = today.clone().subtract(6, 'months').startOf('week');\r\n    const rangeEnd = today.clone().add(6, 'months').endOf('week');\r\n\r\n    // Iterate through each day and add background items for weekends\r\n    let currentDay = rangeStart.clone();\r\n    while (currentDay.isSameOrBefore(rangeEnd)) {\r\n        const dayOfWeek = currentDay.day();\r\n\r\n        // Saturday (6) or Sunday (0)\r\n        if (dayOfWeek === 0 || dayOfWeek === 6) {\r\n            timelineItems.push({\r\n                id: `weekend_${currentDay.format('YYYY-MM-DD')}`,\r\n                start: currentDay.clone().startOf('day').toDate(),\r\n                end: currentDay.clone().endOf('day').toDate(),\r\n                type: 'background',\r\n                className: 'weekend-background',\r\n                editable: false\r\n            });\r\n        }\r\n\r\n        currentDay.add(1, 'day');\r\n    }\r\n\r\n    return timelineItems;\r\n}\r\n\r\n// ============================================\r\n// Apply Filters\r\n// ============================================\r\n\r\nfunction applyFilters() {\r\n    const moFilter = document.getElementById('moFilter').value;\r\n\r\n    filteredWorkOrders = allWorkOrders.filter(wo => {\r\n        // MO filter\r\n        if (moFilter !== 'all' && wo.mo_num !== moFilter) {\r\n            return false;\r\n        }\r\n\r\n        // Status filter\r\n        if (activeStatusFilter !== null) {\r\n            if (activeStatusFilter === 'conflict') {\r\n                const conflicts = detectConflicts();\r\n                if (!conflicts.has(wo.wo_id)) {\r\n                    return false;\r\n                }\r\n            } else if (wo.wo_status !== parseInt(activeStatusFilter)) {\r\n                return false;\r\n            }\r\n        }\r\n\r\n        return true;\r\n    });\r\n\r\n    // Update statistics\r\n    updateStatistics();\r\n}\r\n\r\n// ============================================\r\n// Update Statistics\r\n// ============================================\r\n\r\nfunction updateStatistics() {\r\n    const uniqueMOs = new Set(filteredWorkOrders.map(wo => wo.mo_num));\r\n    const conflicts = detectConflicts();\r\n\r\n    document.getElementById('totalWOs').textContent = filteredWorkOrders.length;\r\n    document.getElementById('totalMOs').textContent = uniqueMOs.size;\r\n    document.getElementById('totalDeps').textContent = stagingDependencies.length;\r\n    document.getElementById('totalConflicts').textContent = conflicts.size;\r\n}\r\n\r\n// ============================================\r\n// Initialize Timeline\r\n// ============================================\r\n\r\nfunction initTimeline() {\r\n    const container = document.getElementById('visualization');\r\n\r\n    // Apply filters\r\n    applyFilters();\r\n\r\n    if (filteredWorkOrders.length === 0) {\r\n        showEmptyState(true);\r\n        return;\r\n    }\r\n\r\n    showEmptyState(false);\r\n\r\n    // Build groups and items\r\n    groups = buildMOGroups();\r\n    items = buildItems();\r\n\r\n    // Timeline options\r\n    const options = {\r\n        // Row stacking configuration\r\n        stack: true,\r\n        stackSubgroups: true,\r\n\r\n        // Editable configuration - ENABLE DRAG/RESIZE\r\n        editable: {\r\n            add: false,         // Don't allow adding new items\r\n            updateTime: true,   // Allow dragging to change time (enables both move AND resize)\r\n            updateGroup: false, // Don't allow dragging between groups (WO can't change category/MO)\r\n            remove: false,      // Don't allow deleting\r\n            overrideItems: true // Allow individual items to override editable settings\r\n        },\r\n\r\n        // Selection configuration\r\n        selectable: true,\r\n        multiselect: false,\r\n\r\n        // Snap to noon (12:00:00) on day boundaries, skip weekends if enabled\r\n        snap: function(date, scale, step) {\r\n            const m = moment(date);\r\n            // Round to nearest day, then set to noon\r\n            m.startOf('day').hour(12).minute(0).second(0);\r\n            return skipWeekends(m.toDate());\r\n        },\r\n\r\n        // Orientation\r\n        orientation: 'top',\r\n\r\n        // Zoom and move\r\n        zoomable: true,\r\n        moveable: true,\r\n        zoomMin: 1000 * 60 * 60 * 24 * 7,  // 1 week minimum zoom\r\n        zoomMax: 1000 * 60 * 60 * 24 * 180, // 6 months maximum zoom\r\n\r\n        // Time axis format (static format - custom functions cause TypeError in vis-timeline 7.7.3)\r\n        format: {\r\n            minorLabels: {\r\n                day: 'ddd D',\r\n                weekday: 'ddd D',\r\n                week: 'w'\r\n            },\r\n            majorLabels: {\r\n                day: 'MMMM YYYY',\r\n                week: 'MMMM YYYY',\r\n                month: 'YYYY'\r\n            }\r\n        },\r\n\r\n        // Force timeline to show individual days\r\n        timeAxis: {\r\n            scale: 'day',\r\n            step: 1\r\n        },\r\n\r\n        // Margins\r\n        margin: {\r\n            item: {\r\n                horizontal: 10,\r\n                vertical: 5\r\n            }\r\n        },\r\n\r\n        // Set initial view to show current week (with some buffer)\r\n        start: moment().startOf('week').subtract(1, 'week').toDate(),\r\n        end: moment().endOf('week').add(3, 'weeks').toDate(),\r\n\r\n        // Callbacks for edits\r\n        onMove: handleWOMove,\r\n        onMoving: handleWOMoving,\r\n        onUpdate: handleWOUpdate\r\n    };\r\n\r\n    // Destroy existing timeline if it exists (prevents duplicates on refresh)\r\n    if (timeline) {\r\n        timeline.destroy();\r\n        timeline = null;\r\n    }\r\n\r\n    // Create timeline\r\n    timeline = new vis.Timeline(container, items, groups, options);\r\n\r\n    // Add today marker\r\n    timeline.addCustomTime(new Date(), 'today');\r\n    timeline.setCustomTimeMarker('Today', 'today', false);\r\n\r\n    // Set initial view to start at Monday of current week, showing 4 weeks\r\n    const monday = moment().startOf('isoWeek');\r\n    timeline.setWindow(monday.toDate(), monday.clone().add(4, 'weeks').toDate());\r\n\r\n    // Add double-click event to open MO screen\r\n    timeline.on('doubleClick', function(properties) {\r\n        if (properties.item) {\r\n            const itemId = properties.item;\r\n\r\n            // Check if it's a WO (not MO header)\r\n            if (itemId.startsWith('wo_')) {\r\n                const woId = parseInt(itemId.replace('wo_', ''));\r\n                const wo = filteredWorkOrders.find(w => w.wo_id === woId);\r\n\r\n                if (wo) {\r\n                    debugLog('info', `Double-clicked WO ${wo.wo_num} - opening MO ${wo.mo_num}`);\r\n\r\n                    try {\r\n                        // Use the Fishbowl openModule function (same as v1)\r\n                        openModule(\"Manufacture Order\", wo.mo_num);\r\n                    } catch (error) {\r\n                        debugLog('error', 'Error opening MO', error.toString());\r\n                        showToast('Error opening MO ' + wo.mo_num + ': ' + error.toString(), 'error', true);\r\n                    }\r\n                }\r\n            } else if (itemId.startsWith('mo_header_')) {\r\n                // Double-clicked MO header directly\r\n                const moNum = itemId.replace('mo_header_', '');\r\n\r\n                debugLog('info', `Double-clicked MO header ${moNum}`);\r\n\r\n                try {\r\n                    // Use the Fishbowl openModule function\r\n                    openModule(\"Manufacture Order\", moNum);\r\n                } catch (error) {\r\n                    debugLog('error', 'Error opening MO', error.toString());\r\n                    showToast('Error opening MO ' + moNum + ': ' + error.toString(), 'error', true);\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n    // Render dependency arrows and apply colors\r\n    setTimeout(() => {\r\n        renderDependencyArrows();\r\n    }, 300);\r\n\r\n    // Apply category colors after render with longer timeout to ensure DOM is ready\r\n    if (viewMode === 'category') {\r\n        setTimeout(() => {\r\n            applyCategoryColors();\r\n        }, 800);\r\n    }\r\n\r\n    // Re-render arrows and colors on timeline events\r\n    timeline.on('changed', () => {\r\n        renderDependencyArrows();\r\n        if (viewMode === 'category') {\r\n            applyCategoryColors();\r\n        }\r\n        highlightWeekends();\r\n    });\r\n\r\n    // Reapply category colors after any redraw (critical for vis-timeline)\r\n    if (viewMode === 'category') {\r\n        timeline.on('rangechanged', applyCategoryColors);\r\n        timeline.on('changed', applyCategoryColors);\r\n    }\r\n\r\n    debugLog('success', `Timeline initialized in ${viewMode} view with ${filteredWorkOrders.length} WOs`);\r\n}\r\n\r\n// ============================================\r\n// Apply Category Colors to Labels and Background Rows\r\n// ============================================\r\nfunction applyCategoryColors() {\r\n    if (viewMode !== 'category') {\r\n        debugLog('info', 'Skipping colors - not in category view');\r\n        return;\r\n    }\r\n\r\n    debugLog('info', `Applying category colors (${groups.length} groups)...`);\r\n\r\n    setTimeout(() => {\r\n        // vis-timeline 7.7.3 doesn't add data-groupid, so use index-based matching\r\n        // Our category-label class helps us find the right elements\r\n        const labels = document.querySelectorAll('.vis-label.category-label');\r\n        const bgGroups = document.querySelectorAll('.vis-panel.vis-background .vis-group');\r\n\r\n        debugLog('info', `Found ${labels.length} category labels, ${bgGroups.length} background groups (${groups.length} groups in data)`);\r\n\r\n        groups.forEach((group, index) => {\r\n            if (!group.categoryColor) return;\r\n\r\n            const color = group.categoryColor;\r\n            debugLog('info', `Applying ${color} to group ${index} (${group.id})`);\r\n\r\n            // Apply to label by index (with !important to override vis styles)\r\n            if (labels[index]) {\r\n                labels[index].style.setProperty('background-color', color, 'important');\r\n                const computed = window.getComputedStyle(labels[index]).backgroundColor;\r\n                debugLog('success', `   Label: set ${color}, computed ${computed}`);\r\n            } else {\r\n                debugLog('warning', `   Label ${index} not found`);\r\n            }\r\n\r\n            // Apply to background group by index\r\n            if (bgGroups[index]) {\r\n                bgGroups[index].style.setProperty('background-color', color, 'important');\r\n                const computed = window.getComputedStyle(bgGroups[index]).backgroundColor;\r\n                debugLog('success', `   Background: set ${color}, computed ${computed}`);\r\n            } else {\r\n                debugLog('warning', `   Background ${index} not found`);\r\n            }\r\n        });\r\n\r\n        debugLog('success', `Category colors applied to ${labels.length} labels`);\r\n    }, 100);\r\n}\r\n\r\n// ============================================\r\n// Render Dependency Arrows\r\n// ============================================\r\nfunction renderDependencyArrows() {\r\n    debugLog('info', 'Rendering dependency arrows...');\r\n\r\n    // Remove existing arrow SVG if it exists\r\n    const existingSvg = document.getElementById('dependencyArrowsSvg');\r\n    if (existingSvg) {\r\n        existingSvg.remove();\r\n    }\r\n\r\n    const container = document.getElementById('visualization');\r\n    if (!container) {\r\n        debugLog('error', 'Container not found for dependency arrows');\r\n        return;\r\n    }\r\n\r\n    // Create SVG overlay\r\n    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n    svg.id = 'dependencyArrowsSvg';\r\n    svg.style.position = 'absolute';\r\n    svg.style.top = '0';\r\n    svg.style.left = '0';\r\n    svg.style.width = '100%';\r\n    svg.style.height = '100%';\r\n    svg.style.pointerEvents = 'none';\r\n    svg.style.zIndex = '1';\r\n\r\n    container.style.position = 'relative';\r\n    container.appendChild(svg);\r\n\r\n    // Get timeline dimensions\r\n    const timelineContent = container.querySelector('.vis-content');\r\n    if (!timelineContent) return;\r\n\r\n    const allowSameDay = document.getElementById('allowSameDayStart').classList.contains('active');\r\n\r\n    let arrowsRendered = 0;\r\n    let conflictArrows = 0;\r\n\r\n    // Draw arrows for each dependency\r\n    stagingDependencies.forEach(dep => {\r\n        // Find the source (staging) and target (consuming) WO elements by class name\r\n        const sourceItem = container.querySelector(`.vis-item.wo-item-${dep.staging_wo_id}`);\r\n        const targetItem = container.querySelector(`.vis-item.wo-item-${dep.wo_id}`);\r\n\r\n        if (!sourceItem || !targetItem) return;\r\n\r\n        // Get positions\r\n        const sourceRect = sourceItem.getBoundingClientRect();\r\n        const targetRect = targetItem.getBoundingClientRect();\r\n        const containerRect = container.getBoundingClientRect();\r\n\r\n        // Calculate arrow start/end points (relative to container)\r\n        const startX = sourceRect.right - containerRect.left;\r\n        const startY = sourceRect.top + sourceRect.height / 2 - containerRect.top;\r\n        const endX = targetRect.left - containerRect.left;\r\n        const endY = targetRect.top + targetRect.height / 2 - containerRect.top;\r\n\r\n        // Check if this dependency is in conflict\r\n        // Find the staging WO to check its status\r\n        const stagingWO = allWorkOrders.find(w => w.wo_id === dep.staging_wo_id);\r\n\r\n        let isConflict = false;\r\n\r\n        // If staging WO is Fulfilled (status 40), it's already finished - no conflict\r\n        if (!(stagingWO && stagingWO.wo_status === 40)) {\r\n            // Strip time component - compare only dates\r\n            const stagingFinish = moment(dep.staging_wo_finish).startOf('day');\r\n            const currentStart = moment(dep.wo_start).startOf('day');\r\n\r\n            if (allowSameDay) {\r\n                isConflict = stagingFinish.isAfter(currentStart);\r\n            } else {\r\n                isConflict = stagingFinish.isSameOrAfter(currentStart);\r\n            }\r\n        }\r\n\r\n        // Draw arrow with right angles\r\n        const color = isConflict ? '#e74c3c' : '#95a5a6';\r\n        const strokeWidth = isConflict ? 2 : 1.5;\r\n\r\n        // Create path with right-angle turns\r\n        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n\r\n        // Calculate right-angle path\r\n        const horizontalOffset = 10; // Small offset from the bar\r\n        const midX = (startX + endX) / 2;\r\n\r\n        // Path: start  right  down/up  right  end\r\n        let pathData;\r\n        if (Math.abs(endY - startY) < 5) {\r\n            // Same row or very close - simple straight line\r\n            pathData = `M ${startX} ${startY} L ${endX} ${endY}`;\r\n        } else {\r\n            // Different rows - right angle path\r\n            pathData = `M ${startX} ${startY}\r\n                        L ${startX + horizontalOffset} ${startY}\r\n                        L ${startX + horizontalOffset} ${endY}\r\n                        L ${endX} ${endY}`;\r\n        }\r\n\r\n        path.setAttribute('d', pathData);\r\n        path.setAttribute('stroke', color);\r\n        path.setAttribute('stroke-width', strokeWidth);\r\n        path.setAttribute('fill', 'none');\r\n        path.setAttribute('class', 'dependency-arrow');\r\n        path.setAttribute('data-source-id', dep.staging_wo_id);\r\n        path.setAttribute('data-target-id', dep.wo_id);\r\n        path.setAttribute('marker-end', `url(#arrowhead-${isConflict ? 'conflict' : 'normal'})`);\r\n\r\n        svg.appendChild(path);\r\n        arrowsRendered++;\r\n        if (isConflict) conflictArrows++;\r\n    });\r\n\r\n    debugLog('info', `Rendered ${arrowsRendered} dependency arrows (${conflictArrows} conflicts)`);\r\n\r\n    // Add arrowhead markers\r\n    addArrowheadMarkers(svg);\r\n\r\n    // Add hover event listeners to WO items\r\n    addArrowHoverListeners(container);\r\n}\r\n\r\nfunction addArrowHoverListeners(container) {\r\n    // Find all WO items\r\n    const woItems = container.querySelectorAll('.vis-item.vis-range');\r\n\r\n    woItems.forEach(woItem => {\r\n        // Extract WO ID from class name (wo-item-123)\r\n        const classMatch = woItem.className.match(/wo-item-(\\d+)/);\r\n        if (!classMatch) return;\r\n\r\n        const woId = classMatch[1];\r\n\r\n        // Add mouseenter event\r\n        woItem.addEventListener('mouseenter', function() {\r\n            // Find all arrows connected to this WO\r\n            const arrows = container.querySelectorAll(\r\n                `.dependency-arrow[data-source-id=\"${woId}\"], .dependency-arrow[data-target-id=\"${woId}\"]`\r\n            );\r\n\r\n            arrows.forEach(arrow => {\r\n                arrow.classList.add('highlighted');\r\n            });\r\n        });\r\n\r\n        // Add mouseleave event\r\n        woItem.addEventListener('mouseleave', function() {\r\n            // Remove highlight from all arrows\r\n            const arrows = container.querySelectorAll('.dependency-arrow.highlighted');\r\n            arrows.forEach(arrow => {\r\n                arrow.classList.remove('highlighted');\r\n            });\r\n        });\r\n    });\r\n}\r\n\r\nfunction addArrowheadMarkers(svg) {\r\n    // Create defs element for markers\r\n    let defs = svg.querySelector('defs');\r\n    if (!defs) {\r\n        defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');\r\n        svg.appendChild(defs);\r\n    }\r\n\r\n    // Normal arrowhead (smaller)\r\n    const markerNormal = document.createElementNS('http://www.w3.org/2000/svg', 'marker');\r\n    markerNormal.setAttribute('id', 'arrowhead-normal');\r\n    markerNormal.setAttribute('markerWidth', '6');\r\n    markerNormal.setAttribute('markerHeight', '6');\r\n    markerNormal.setAttribute('refX', '5');\r\n    markerNormal.setAttribute('refY', '2');\r\n    markerNormal.setAttribute('orient', 'auto');\r\n\r\n    const pathNormal = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    pathNormal.setAttribute('d', 'M0,0 L0,4 L5,2 z');\r\n    pathNormal.setAttribute('fill', '#95a5a6');\r\n    markerNormal.appendChild(pathNormal);\r\n    defs.appendChild(markerNormal);\r\n\r\n    // Conflict arrowhead (smaller)\r\n    const markerConflict = document.createElementNS('http://www.w3.org/2000/svg', 'marker');\r\n    markerConflict.setAttribute('id', 'arrowhead-conflict');\r\n    markerConflict.setAttribute('markerWidth', '6');\r\n    markerConflict.setAttribute('markerHeight', '6');\r\n    markerConflict.setAttribute('refX', '5');\r\n    markerConflict.setAttribute('refY', '2');\r\n    markerConflict.setAttribute('orient', 'auto');\r\n\r\n    const pathConflict = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    pathConflict.setAttribute('d', 'M0,0 L0,4 L5,2 z');\r\n    pathConflict.setAttribute('fill', '#e74c3c');\r\n    markerConflict.appendChild(pathConflict);\r\n    defs.appendChild(markerConflict);\r\n}\r\n\r\n// ============================================\r\n// Handle WO Move/Resize Events\r\n// ============================================\r\n\r\nfunction handleWOMoving(item, callback) {\r\n    // Called while dragging - allow the move\r\n    callback(item);\r\n}\r\n\r\nfunction handleWOMove(item, callback) {\r\n    // Prevent MO headers from being moved\r\n    if (item.id.startsWith('mo_header_')) {\r\n        debugLog('warning', 'Cannot move MO header - canceling move');\r\n        callback(null); // Cancel the move\r\n        return;\r\n    }\r\n\r\n    // Extract WO ID from item id (format: \"wo_123\")\r\n    const woId = parseInt(item.id.replace('wo_', ''));\r\n\r\n    debugLog('info', `WO moved: ${item.content}`, {\r\n        woId: woId,\r\n        newStart: moment(item.start).format('YYYY-MM-DD'),\r\n        newEnd: moment(item.end).format('YYYY-MM-DD')\r\n    });\r\n\r\n    let newStartDate = moment(item.start).toDate();\r\n    let newEndDate = moment(item.end).toDate();\r\n\r\n    // Apply skip weekends if enabled\r\n    newStartDate = skipWeekends(newStartDate);\r\n    newEndDate = skipWeekends(newEndDate);\r\n\r\n    // Format with time component for Fishbowl API (ISO 8601)\r\n    const newStart = moment(newStartDate).format('YYYY-MM-DD[T]HH:mm:ss');\r\n    const newEnd = moment(newEndDate).format('YYYY-MM-DD[T]HH:mm:ss');\r\n\r\n    debugLog('info', `After skip weekends - Start: ${newStart}, End: ${newEnd}`);\r\n\r\n    // Save state for undo BEFORE making changes\r\n    saveStateForUndo();\r\n\r\n    // Save old dates BEFORE updating (needed for shift calculation)\r\n    const movedWO = filteredWorkOrders.find(wo => wo.wo_id === woId);\r\n    const oldStart = movedWO ? movedWO.date_scheduled_start : null;\r\n    const oldEnd = movedWO ? movedWO.date_scheduled : null;\r\n\r\n    // Update the underlying data arrays FIRST\r\n    const updateWODates = (wo) => {\r\n        if (wo.wo_id === woId) {\r\n            wo.date_scheduled_start = newStart;\r\n            wo.date_scheduled = newEnd;\r\n            debugLog('success', `Updated WO ${wo.wo_num} in data array`);\r\n        }\r\n        return wo;\r\n    };\r\n\r\n    allWorkOrders = allWorkOrders.map(updateWODates);\r\n    filteredWorkOrders = filteredWorkOrders.map(updateWODates);\r\n\r\n    // CRITICAL: Also update stagingDependencies array with new dates\r\n    stagingDependencies = stagingDependencies.map(dep => {\r\n        // If this WO is a staging WO (provides parts to others), update its finish date\r\n        if (dep.staging_wo_id === woId) {\r\n            dep.staging_wo_finish = newEnd;\r\n            debugLog('info', `Updated staging dependency: WO ${dep.staging_wo_num} new finish: ${newEnd}`);\r\n        }\r\n        // If this WO consumes parts (depends on others), update its start date\r\n        if (dep.wo_id === woId) {\r\n            dep.wo_start = newStart;\r\n            debugLog('info', `Updated consuming dependency: WO ${dep.wo_num} new start: ${newStart}`);\r\n        }\r\n        return dep;\r\n    });\r\n\r\n    // Update database using Fishbowl API (GetWorkOrderRq -> modify -> SaveWorkOrderRq)\r\n    debugLog('info', `Fetching WO ${movedWO.wo_num} from API to update dates...`);\r\n\r\n    const woRequest = {\r\n        GetWorkOrderRq: {\r\n            WorkOrderNumber: movedWO.wo_num\r\n        }\r\n    };\r\n\r\n    try {\r\n        const woResponse = JSON.parse(runApiRequest('GetWorkOrderRq', JSON.stringify(woRequest)));\r\n\r\n        debugLog('info', `API Response for GetWorkOrderRq`, {\r\n            statusCode: woResponse.GetWorkOrderRs ? woResponse.GetWorkOrderRs.statusCode : 'N/A',\r\n            statusMessage: woResponse.GetWorkOrderRs ? woResponse.GetWorkOrderRs.statusMessage : 'N/A',\r\n            hasWO: !!(woResponse.GetWorkOrderRs && woResponse.GetWorkOrderRs.WO)\r\n        });\r\n\r\n        if (woResponse.GetWorkOrderRs && woResponse.GetWorkOrderRs.statusCode === 1000 && woResponse.GetWorkOrderRs.WO) {\r\n            const wo = woResponse.GetWorkOrderRs.WO;\r\n            debugLog('success', `Successfully retrieved WO ${movedWO.wo_num}`);\r\n\r\n            // Update the main WO dates\r\n            wo.DateScheduledToStart = newStart;\r\n            wo.DateScheduled = newEnd;\r\n\r\n            // Also update WO items if they exist\r\n            if (wo.WOItems && wo.WOItems.WOItem) {\r\n                const items = Array.isArray(wo.WOItems.WOItem) ? wo.WOItems.WOItem : [wo.WOItems.WOItem];\r\n                debugLog('info', `Updating ${items.length} WO items with new scheduled date`);\r\n                items.forEach(item => {\r\n                    item.DateScheduled = newStart;\r\n                });\r\n            }\r\n\r\n            // Save the updated WO\r\n            debugLog('info', `Saving updated WO ${movedWO.wo_num}...`);\r\n            const saveRequest = {\r\n                SaveWorkOrderRq: {\r\n                    WO: wo\r\n                }\r\n            };\r\n\r\n            const saveResponse = JSON.parse(runApiRequest('SaveWorkOrderRq', JSON.stringify(saveRequest)));\r\n\r\n            debugLog('info', `API Response for SaveWorkOrderRq`, {\r\n                statusCode: saveResponse.SaveWorkOrderRs ? saveResponse.SaveWorkOrderRs.statusCode : 'N/A',\r\n                statusMessage: saveResponse.SaveWorkOrderRs ? saveResponse.SaveWorkOrderRs.statusMessage : 'N/A'\r\n            });\r\n\r\n            if (saveResponse.SaveWorkOrderRs && saveResponse.SaveWorkOrderRs.statusCode === 1000) {\r\n                debugLog('success', ` Successfully updated WO ${movedWO.wo_num} via API`);\r\n                showToast(`WO ${movedWO.wo_num} dates updated successfully`, 'success');\r\n            } else {\r\n                const errorMsg = saveResponse.SaveWorkOrderRs ? saveResponse.SaveWorkOrderRs.statusMessage : 'Unknown error';\r\n                debugLog('error', ` SaveWorkOrderRq failed for WO ${movedWO.wo_num}:`, errorMsg);\r\n                showToast(`Save failed: ${errorMsg}`, 'error', true);\r\n            }\r\n        } else {\r\n            const errorMsg = woResponse.GetWorkOrderRs ? woResponse.GetWorkOrderRs.statusMessage : 'Failed to retrieve WO';\r\n            debugLog('error', ` GetWorkOrderRq failed for WO ${movedWO.wo_num}:`, errorMsg);\r\n            showToast(`Failed to retrieve WO: ${errorMsg}`, 'error', true);\r\n        }\r\n    } catch (error) {\r\n        const errorMsg = error ? error.toString() : 'Unknown error';\r\n        debugLog('error', ` API error updating WO ${movedWO.wo_num}:`, errorMsg);\r\n        showToast(`API error: ${errorMsg}`, 'error', true);\r\n    }\r\n\r\n    // Confirm the move\r\n    callback(item);\r\n\r\n    // If shift deps enabled, shift dependent WOs\r\n    if (document.getElementById('shiftDependentWOs').classList.contains('active')) {\r\n        shiftDependentWOs(item, woId, oldStart, oldEnd);\r\n    }\r\n\r\n    // Just update conflicts without full rebuild\r\n    updateConflictHighlighting();\r\n}\r\n\r\nfunction handleWOUpdate(item, callback) {\r\n    // Handle resize/update the same way\r\n    handleWOMove(item, callback);\r\n}\r\n\r\nfunction shiftDependentWOs(movedItem, movedWoId, oldStartDate = null, oldEndDate = null) {\r\n    debugLog('info', `Shifting dependent WOs for WO ID ${movedWoId}...`);\r\n\r\n    // Calculate the time delta (how much the WO was moved)\r\n    // Use passed old dates if available, otherwise use current data\r\n    const oldStart = oldStartDate ? moment(oldStartDate) : moment(movedItem.start);\r\n    const newStart = moment(movedItem.start);\r\n    const oldEnd = oldEndDate ? moment(oldEndDate) : moment(movedItem.end);\r\n    const newEnd = moment(movedItem.end);\r\n\r\n    const startDelta = newStart.diff(oldStart, 'days');\r\n    const endDelta = newEnd.diff(oldEnd, 'days');\r\n\r\n    debugLog('info', `WO moved by ${startDelta} days (start) and ${endDelta} days (end)`);\r\n\r\n    // Find all WOs that depend on this WO (WOs where this WO is the staging WO)\r\n    const dependentWOs = stagingDependencies\r\n        .filter(dep => dep.staging_wo_id === movedWoId)\r\n        .map(dep => dep.wo_id);\r\n\r\n    if (dependentWOs.length === 0) {\r\n        debugLog('info', 'No dependent WOs to shift');\r\n        return;\r\n    }\r\n\r\n    debugLog('info', `Found ${dependentWOs.length} dependent WOs to shift`);\r\n\r\n    // Shift each dependent WO (only if it would cause a conflict)\r\n    const itemsToUpdate = [];\r\n    const allowSameDay = document.getElementById('allowSameDayStart').classList.contains('active');\r\n\r\n    dependentWOs.forEach(depWoId => {\r\n        const depWO = filteredWorkOrders.find(wo => wo.wo_id === depWoId);\r\n        if (!depWO) return;\r\n\r\n        // Check if this WO would have a conflict with the moved WO\r\n        // Strip time component - compare only dates\r\n        const stagingFinish = moment(newEnd).startOf('day');\r\n        const currentStart = moment(depWO.date_scheduled_start).startOf('day');\r\n\r\n        let wouldConflict = false;\r\n        if (allowSameDay) {\r\n            // If same-day starts allowed, only conflict if staging finishes AFTER (not on same day)\r\n            wouldConflict = stagingFinish.isAfter(currentStart);\r\n        } else {\r\n            // If same-day starts NOT allowed, conflict if staging finishes on or after start day\r\n            wouldConflict = stagingFinish.isSameOrAfter(currentStart);\r\n        }\r\n\r\n        // Only shift if it would cause a conflict\r\n        if (!wouldConflict) {\r\n            debugLog('info', `Skipping WO ${depWO.wo_num} - no conflict (staging finishes ${stagingFinish.format('YYYY-MM-DD')}, WO starts ${currentStart.format('YYYY-MM-DD')})`);\r\n            return;\r\n        }\r\n\r\n        // Save old dates for this dependent WO before shifting\r\n        const depOldStart = depWO.date_scheduled_start;\r\n        const depOldEnd = depWO.date_scheduled;\r\n\r\n        // Calculate new dates and skip weekends\r\n        let newDepStart = moment(depWO.date_scheduled_start).add(startDelta, 'days').toDate();\r\n        newDepStart = skipWeekends(newDepStart);\r\n        const newDepStartStr = moment(newDepStart).format('YYYY-MM-DD[T]HH:mm:ss');\r\n\r\n        let newDepEnd = moment(depWO.date_scheduled).add(endDelta, 'days').toDate();\r\n        newDepEnd = skipWeekends(newDepEnd);\r\n        const newDepEndStr = moment(newDepEnd).format('YYYY-MM-DD[T]HH:mm:ss');\r\n\r\n        debugLog('info', `Shifting WO ${depWO.wo_num}: ${depOldStart}  ${newDepStartStr} (conflict detected)`);\r\n\r\n        // Update the data arrays\r\n        const updateWODates = (wo) => {\r\n            if (wo.wo_id === depWoId) {\r\n                wo.date_scheduled_start = newDepStartStr;\r\n                wo.date_scheduled = newDepEndStr;\r\n            }\r\n            return wo;\r\n        };\r\n\r\n        allWorkOrders = allWorkOrders.map(updateWODates);\r\n        filteredWorkOrders = filteredWorkOrders.map(updateWODates);\r\n\r\n        // Update staging dependencies\r\n        stagingDependencies = stagingDependencies.map(dep => {\r\n            if (dep.staging_wo_id === depWoId) {\r\n                dep.staging_wo_finish = newDepEndStr;\r\n            }\r\n            if (dep.wo_id === depWoId) {\r\n                dep.wo_start = newDepStartStr;\r\n            }\r\n            return dep;\r\n        });\r\n\r\n        // Find the timeline item and update it\r\n        const timelineItem = timeline.itemsData.get(`wo_${depWoId}`);\r\n        if (timelineItem) {\r\n            timelineItem.start = newDepStartStr;\r\n            timelineItem.end = newDepEndStr;\r\n            itemsToUpdate.push(timelineItem);\r\n        }\r\n\r\n        // Save to database via API\r\n        debugLog('info', `Saving shifted WO ${depWO.wo_num} to database...`);\r\n        const woRequest = {\r\n            GetWorkOrderRq: {\r\n                WorkOrderNumber: depWO.wo_num\r\n            }\r\n        };\r\n\r\n        try {\r\n            const woResponse = JSON.parse(runApiRequest('GetWorkOrderRq', JSON.stringify(woRequest)));\r\n\r\n            if (woResponse.GetWorkOrderRs && woResponse.GetWorkOrderRs.statusCode === 1000 && woResponse.GetWorkOrderRs.WO) {\r\n                const wo = woResponse.GetWorkOrderRs.WO;\r\n\r\n                // Update the dates\r\n                wo.DateScheduledToStart = newDepStartStr;\r\n                wo.DateScheduled = newDepEndStr;\r\n\r\n                // Also update WO items if they exist\r\n                if (wo.WOItems && wo.WOItems.WOItem) {\r\n                    const items = Array.isArray(wo.WOItems.WOItem) ? wo.WOItems.WOItem : [wo.WOItems.WOItem];\r\n                    items.forEach(item => {\r\n                        item.DateScheduled = newDepStartStr;\r\n                    });\r\n                }\r\n\r\n                // Save the updated WO\r\n                const saveRequest = {\r\n                    SaveWorkOrderRq: {\r\n                        WO: wo\r\n                    }\r\n                };\r\n\r\n                const saveResponse = JSON.parse(runApiRequest('SaveWorkOrderRq', JSON.stringify(saveRequest)));\r\n\r\n                if (saveResponse.SaveWorkOrderRs && saveResponse.SaveWorkOrderRs.statusCode === 1000) {\r\n                    debugLog('success', ` Shifted WO ${depWO.wo_num} saved to database`);\r\n                } else {\r\n                    const errorMsg = saveResponse.SaveWorkOrderRs ? saveResponse.SaveWorkOrderRs.statusMessage : 'Unknown error';\r\n                    debugLog('error', ` Failed to save shifted WO ${depWO.wo_num}:`, errorMsg);\r\n                }\r\n            }\r\n        } catch (error) {\r\n            const errorMsg = error ? error.toString() : 'Unknown error';\r\n            debugLog('error', ` API error saving shifted WO ${depWO.wo_num}:`, errorMsg);\r\n        }\r\n\r\n        // Recursively shift dependents of this WO\r\n        shiftDependentWOs({ start: newDepStartStr, end: newDepEndStr }, depWoId, depOldStart, depOldEnd);\r\n    });\r\n\r\n    // Update all shifted items in the timeline at once\r\n    if (itemsToUpdate.length > 0) {\r\n        timeline.itemsData.update(itemsToUpdate);\r\n        debugLog('success', `Shifted ${itemsToUpdate.length} dependent WOs in timeline`);\r\n    }\r\n}\r\n\r\nfunction updateConflictHighlighting() {\r\n    // Re-detect conflicts and update item classes\r\n    const conflicts = detectConflicts();\r\n\r\n    // Get current items\r\n    const currentItems = timeline.itemsData.get();\r\n\r\n    currentItems.forEach(item => {\r\n        if (item.id.startsWith('wo_')) {\r\n            const woId = parseInt(item.id.replace('wo_', ''));\r\n            const hasConflict = conflicts.has(woId);\r\n\r\n            // Update class - PRESERVE the wo-item-{wo_id} class for arrow rendering!\r\n            if (hasConflict) {\r\n                item.className = `conflict wo-item-${woId}`;\r\n            } else {\r\n                const wo = filteredWorkOrders.find(w => w.wo_id === woId);\r\n                if (wo) {\r\n                    item.className = `${getStatusClass(wo)} wo-item-${woId}`;\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n    // Update items in timeline\r\n    timeline.itemsData.update(currentItems);\r\n\r\n    // Update statistics\r\n    updateStatistics();\r\n\r\n    // Re-render dependency arrows with longer timeout to ensure DOM updates complete\r\n    setTimeout(() => renderDependencyArrows(), 300);\r\n\r\n    debugLog('info', `Updated conflict highlighting - ${conflicts.size} conflicts found`);\r\n}\r\n\r\n// ============================================\r\n// Switch View Mode\r\n// ============================================\r\n\r\nfunction switchView(newMode) {\r\n    if (newMode === viewMode) return;\r\n\r\n    viewMode = newMode;\r\n\r\n    // Update button states\r\n    document.getElementById('moViewBtn').classList.toggle('active', viewMode === 'mo');\r\n    document.getElementById('categoryViewBtn').classList.toggle('active', viewMode === 'category');\r\n\r\n    debugLog('info', `Switched to ${viewMode} view`);\r\n\r\n    // Rebuild timeline\r\n    rebuildTimeline();\r\n}\r\n\r\n// ============================================\r\n// Rebuild Timeline (after filter/toggle)\r\n// ============================================\r\n\r\nfunction rebuildTimeline() {\r\n    if (!timeline) return;\r\n\r\n    // Apply filters\r\n    applyFilters();\r\n\r\n    if (filteredWorkOrders.length === 0) {\r\n        showEmptyState(true);\r\n        return;\r\n    }\r\n\r\n    showEmptyState(false);\r\n\r\n    // Rebuild groups and items\r\n    groups = viewMode === 'mo' ? buildMOGroups() : buildCategoryGroups();\r\n    items = buildItems();\r\n\r\n    // Update timeline\r\n    timeline.setGroups(groups);\r\n    timeline.setItems(items);\r\n\r\n    // Re-render dependency arrows\r\n    setTimeout(() => {\r\n        renderDependencyArrows();\r\n    }, 300);\r\n\r\n    // Apply category colors with longer timeout\r\n    if (viewMode === 'category') {\r\n        setTimeout(() => {\r\n            applyCategoryColors();\r\n        }, 800);\r\n    }\r\n\r\n    // Highlight weekends\r\n    setTimeout(() => {\r\n        highlightWeekends();\r\n    }, 500);\r\n\r\n    debugLog('info', `Timeline rebuilt with ${filteredWorkOrders.length} WOs in ${viewMode} view`);\r\n}\r\n\r\n// ============================================\r\n// Status Filter Toggle\r\n// ============================================\r\n\r\nfunction toggleStatusFilter(status) {\r\n    if (activeStatusFilter === status) {\r\n        activeStatusFilter = null;\r\n    } else {\r\n        activeStatusFilter = status;\r\n    }\r\n\r\n    // Update visual state\r\n    document.querySelectorAll('.legend-item.clickable').forEach(item => {\r\n        if (item.getAttribute('data-status') === activeStatusFilter) {\r\n            item.classList.add('active');\r\n        } else {\r\n            item.classList.remove('active');\r\n        }\r\n    });\r\n\r\n    debugLog('info', `Status filter: ${activeStatusFilter || 'none'}`);\r\n\r\n    rebuildTimeline();\r\n}\r\n\r\n// ============================================\r\n// Event Listeners\r\n// ============================================\r\n\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n    // View toggle buttons\r\n    document.getElementById('moViewBtn').addEventListener('click', () => switchView('mo'));\r\n    document.getElementById('categoryViewBtn').addEventListener('click', () => switchView('category'));\r\n\r\n    // Timeline controls\r\n    document.getElementById('zoomInBtn').addEventListener('click', () => {\r\n        if (timeline) timeline.zoomIn(0.2);\r\n    });\r\n\r\n    document.getElementById('zoomOutBtn').addEventListener('click', () => {\r\n        if (timeline) timeline.zoomOut(0.2);\r\n    });\r\n\r\n    // Preset zoom buttons (start from current week's Monday)\r\n    document.getElementById('zoomWeekBtn').addEventListener('click', () => {\r\n        if (timeline) {\r\n            const monday = moment().startOf('isoWeek');\r\n            timeline.setWindow(monday.toDate(), monday.clone().add(1, 'week').toDate());\r\n        }\r\n    });\r\n\r\n    document.getElementById('zoom2WeeksBtn').addEventListener('click', () => {\r\n        if (timeline) {\r\n            const monday = moment().startOf('isoWeek');\r\n            timeline.setWindow(monday.toDate(), monday.clone().add(2, 'weeks').toDate());\r\n        }\r\n    });\r\n\r\n    document.getElementById('zoomMonthBtn').addEventListener('click', () => {\r\n        if (timeline) {\r\n            const monday = moment().startOf('isoWeek');\r\n            timeline.setWindow(monday.toDate(), monday.clone().add(4, 'weeks').toDate());\r\n        }\r\n    });\r\n\r\n    document.getElementById('zoom3MonthsBtn').addEventListener('click', () => {\r\n        if (timeline) {\r\n            const monday = moment().startOf('isoWeek');\r\n            timeline.setWindow(monday.toDate(), monday.clone().add(12, 'weeks').toDate());\r\n        }\r\n    });\r\n\r\n    // Week navigation buttons (shift by 1 week, starting on Monday)\r\n    document.getElementById('prevWeekBtn').addEventListener('click', () => {\r\n        if (timeline) {\r\n            const currentWindow = timeline.getWindow();\r\n            const currentStart = moment(currentWindow.start);\r\n            const currentEnd = moment(currentWindow.end);\r\n            const duration = currentEnd.diff(currentStart);\r\n\r\n            // Shift back 1 week, align to Monday\r\n            const newStart = currentStart.subtract(1, 'week').startOf('isoWeek');\r\n            const newEnd = newStart.clone().add(duration, 'milliseconds');\r\n\r\n            timeline.setWindow(newStart.toDate(), newEnd.toDate());\r\n        }\r\n    });\r\n\r\n    document.getElementById('nextWeekBtn').addEventListener('click', () => {\r\n        if (timeline) {\r\n            const currentWindow = timeline.getWindow();\r\n            const currentStart = moment(currentWindow.start);\r\n            const currentEnd = moment(currentWindow.end);\r\n            const duration = currentEnd.diff(currentStart);\r\n\r\n            // Shift forward 1 week, align to Monday\r\n            const newStart = currentStart.add(1, 'week').startOf('isoWeek');\r\n            const newEnd = newStart.clone().add(duration, 'milliseconds');\r\n\r\n            timeline.setWindow(newStart.toDate(), newEnd.toDate());\r\n        }\r\n    });\r\n\r\n    document.getElementById('todayBtn').addEventListener('click', () => {\r\n        if (timeline) timeline.moveTo(new Date());\r\n    });\r\n\r\n    // Status filter dropdown\r\n    document.getElementById('statusFilter').addEventListener('change', function() {\r\n        const status = this.value;\r\n        if (status === 'all') {\r\n            activeStatusFilter = null;\r\n        } else {\r\n            activeStatusFilter = status;\r\n        }\r\n        debugLog('info', `Status filter: ${activeStatusFilter || 'all'}`);\r\n        rebuildTimeline();\r\n    });\r\n\r\n    // Icon toggle buttons (converted from checkboxes)\r\n    document.getElementById('shiftDependentWOs').addEventListener('click', function() {\r\n        this.classList.toggle('active');\r\n        const isActive = this.classList.contains('active');\r\n        document.getElementById('shiftDependentWOsOffcanvas').checked = isActive;\r\n        debugLog('info', `Shift dependent WOs: ${isActive}`);\r\n    });\r\n\r\n    document.getElementById('allowSameDayStart').addEventListener('click', function() {\r\n        this.classList.toggle('active');\r\n        const isActive = this.classList.contains('active');\r\n        document.getElementById('allowSameDayStartOffcanvas').checked = isActive;\r\n        debugLog('info', `Allow same-day start: ${isActive}`);\r\n        rebuildTimeline();\r\n    });\r\n\r\n    // Sync offcanvas toggles with main toggles\r\n    document.getElementById('shiftDependentWOsOffcanvas').addEventListener('change', function() {\r\n        const shiftBtn = document.getElementById('shiftDependentWOs');\r\n        if (this.checked) {\r\n            shiftBtn.classList.add('active');\r\n        } else {\r\n            shiftBtn.classList.remove('active');\r\n        }\r\n        debugLog('info', `Shift dependent WOs: ${this.checked}`);\r\n    });\r\n\r\n    document.getElementById('allowSameDayStartOffcanvas').addEventListener('change', function() {\r\n        const allowBtn = document.getElementById('allowSameDayStart');\r\n        if (this.checked) {\r\n            allowBtn.classList.add('active');\r\n        } else {\r\n            allowBtn.classList.remove('active');\r\n        }\r\n        debugLog('info', `Allow same-day start: ${this.checked}`);\r\n        rebuildTimeline();\r\n    });\r\n\r\n    // Refresh button in offcanvas\r\n    document.getElementById('refreshBtn').addEventListener('click', function() {\r\n        rebuildTimeline();\r\n        // Close offcanvas\r\n        const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('settingsOffcanvas'));\r\n        if (offcanvas) offcanvas.hide();\r\n    });\r\n\r\n    // Undo/Redo buttons\r\n    document.getElementById('undoBtn').addEventListener('click', undo);\r\n    document.getElementById('redoBtn').addEventListener('click', redo);\r\n\r\n    // Refresh data button (reloads data from database)\r\n    document.getElementById('refreshDataBtn').addEventListener('click', function() {\r\n        debugLog('info', 'Refreshing data from database...');\r\n        loadWorkOrders();\r\n    });\r\n\r\n    // Keyboard shortcuts for undo/redo\r\n    document.addEventListener('keydown', function(e) {\r\n        // Ctrl+Z or Cmd+Z for undo\r\n        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {\r\n            e.preventDefault();\r\n            undo();\r\n        }\r\n        // Ctrl+Y or Cmd+Y or Ctrl+Shift+Z for redo\r\n        if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {\r\n            e.preventDefault();\r\n            redo();\r\n        }\r\n    });\r\n\r\n    // Load data\r\n    debugLog('info', 'Initialization complete - loading work orders...');\r\n    loadWorkOrders();\r\n});\r\n\r\n</script>\r\n</body>\r\n</html>\r\n",
  "active" : true,
  "note" : "",
  "type" : "Page"
} ]