[ {
  "name" : "5. PPvP Validation",
  "description" : "5. PPvP Validation",
  "data" : "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Part, Product & Vendor Pricing Validator</title>\r\n\r\n    <!-- Bootstrap 5.3 CSS -->\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css\" rel=\"stylesheet\">\r\n\r\n    <!-- Fishbowl Modern Theme (overrides Bootstrap) -->\r\n    <style>\r\n        {% Style fishbowl-theme-modern %}\r\n    </style>\r\n\r\n    <style>\r\n        /* Page-specific overrides and Bootstrap integration */\r\n        h1 {\r\n            text-align: center;\r\n            margin-bottom: 10px;\r\n        }\r\n\r\n        .subtitle {\r\n            text-align: center;\r\n            color: var(--fb-text-secondary);\r\n            margin-bottom: 20px;\r\n        }\r\n\r\n        /* Upload section improvements */\r\n        .upload-section {\r\n            padding: 20px;\r\n            background-color: var(--fb-primary-pale);\r\n            border: 2px dashed var(--fb-primary);\r\n            border-radius: 8px;\r\n            text-align: center;\r\n            margin-bottom: 20px;\r\n            transition: all 0.3s ease;\r\n        }\r\n\r\n        .upload-section:hover {\r\n            border-color: var(--fb-primary-dark);\r\n            background-color: #BBDEFB;\r\n        }\r\n\r\n        .upload-section.dragover {\r\n            border-color: var(--fb-success);\r\n            background-color: var(--fb-success-bg);\r\n            border-style: solid;\r\n        }\r\n\r\n        .upload-section h3 {\r\n            margin: 0 0 10px 0;\r\n            color: var(--fb-primary-dark);\r\n            font-size: 18px;\r\n        }\r\n\r\n        .upload-section p {\r\n            margin: 5px 0;\r\n            font-size: 14px;\r\n        }\r\n\r\n        /* Compact summary stats - inline badges */\r\n        .summary-stats {\r\n            display: flex;\r\n            gap: 10px;\r\n            margin-bottom: 20px;\r\n            flex-wrap: wrap;\r\n            justify-content: center;\r\n        }\r\n\r\n        .stat-card {\r\n            display: inline-flex;\r\n            align-items: center;\r\n            gap: 6px;\r\n            padding: 6px 12px;\r\n            border-radius: 16px;\r\n            font-size: 13px;\r\n            font-weight: 600;\r\n        }\r\n\r\n        .stat-card.total {\r\n            background-color: var(--fb-info);\r\n            color: white;\r\n        }\r\n\r\n        .stat-card.valid {\r\n            background-color: var(--fb-success);\r\n            color: white;\r\n        }\r\n\r\n        .stat-card.warning {\r\n            background-color: var(--fb-warning);\r\n            color: white;\r\n        }\r\n\r\n        .stat-card.error {\r\n            background-color: var(--fb-danger);\r\n            color: white;\r\n        }\r\n\r\n        .stat-number {\r\n            font-size: 16px;\r\n            font-weight: bold;\r\n        }\r\n\r\n        .stat-label {\r\n            font-size: 12px;\r\n            opacity: 0.95;\r\n        }\r\n\r\n        /* Results table with max height and scrolling */\r\n        .results-table-container {\r\n            max-height: 600px;\r\n            overflow-y: auto;\r\n            border: 1px solid var(--fb-border-light);\r\n            border-radius: 6px;\r\n            margin-bottom: 20px;\r\n        }\r\n\r\n        /* Issue action buttons - proper Bootstrap styling */\r\n        .issue-action-btn {\r\n            padding: 6px 12px;\r\n            font-size: 13px;\r\n            border-radius: 4px;\r\n            transition: all 0.2s;\r\n            display: inline-flex;\r\n            align-items: center;\r\n            gap: 6px;\r\n        }\r\n\r\n        /* Offcanvas customization */\r\n        .offcanvas {\r\n            background-color: white !important;\r\n            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);\r\n        }\r\n\r\n        .offcanvas.offcanvas-start {\r\n            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);\r\n        }\r\n\r\n        .offcanvas-header {\r\n            background-color: var(--fb-primary);\r\n            color: var(--fb-text-white);\r\n            border-bottom: 2px solid var(--fb-primary-dark);\r\n        }\r\n\r\n        .offcanvas-title {\r\n            color: var(--fb-text-white);\r\n            font-weight: 600;\r\n        }\r\n\r\n        .btn-close {\r\n            filter: brightness(0) invert(1);\r\n        }\r\n\r\n        /* Toolbar area - fixed at top */\r\n        .toolbar-area {\r\n            position: sticky;\r\n            top: 0;\r\n            z-index: 1020;\r\n            background-color: white;\r\n            border-bottom: 2px solid var(--fb-border-light);\r\n            padding: 10px 20px;\r\n            margin-bottom: 20px;\r\n            box-shadow: 0 2px 4px rgba(0,0,0,0.05);\r\n        }\r\n\r\n        .toolbar-btn {\r\n            margin: 0 5px;\r\n        }\r\n\r\n        /* Configuration settings styling */\r\n        .config-group {\r\n            margin-bottom: 20px;\r\n            padding: 15px;\r\n            background-color: var(--fb-gray-50);\r\n            border-radius: 6px;\r\n            border: 1px solid var(--fb-border-light);\r\n        }\r\n\r\n        .config-group h5 {\r\n            color: var(--fb-primary-dark);\r\n            font-size: 14px;\r\n            font-weight: 600;\r\n            margin-bottom: 10px;\r\n        }\r\n\r\n        .config-item {\r\n            margin-bottom: 10px;\r\n        }\r\n\r\n        .config-item label {\r\n            display: block;\r\n            font-size: 13px;\r\n            font-weight: 500;\r\n            color: var(--fb-text-primary);\r\n            margin-bottom: 5px;\r\n        }\r\n\r\n        .config-item input[type=\"number\"],\r\n        .config-item select {\r\n            width: 100%;\r\n            padding: 6px 10px;\r\n            border: 1px solid var(--fb-border-medium);\r\n            border-radius: 4px;\r\n            font-size: 13px;\r\n        }\r\n\r\n        .config-item small {\r\n            color: var(--fb-text-secondary);\r\n            font-size: 11px;\r\n        }\r\n\r\n        /* Flyout section styling for instructions */\r\n        .flyout-section {\r\n            margin-bottom: 25px;\r\n        }\r\n\r\n        .flyout-section h3 {\r\n            color: var(--fb-primary-dark);\r\n            margin-top: 0;\r\n            margin-bottom: 10px;\r\n            font-size: 16px;\r\n        }\r\n\r\n        .flyout-section p,\r\n        .flyout-section ol,\r\n        .flyout-section ul {\r\n            margin: 0 0 10px 0;\r\n            line-height: 1.6;\r\n        }\r\n\r\n        .flyout-section ol li,\r\n        .flyout-section ul li {\r\n            margin-bottom: 8px;\r\n        }\r\n\r\n        /* Off-Canvas Tab Buttons (sticky tabs on sides) */\r\n        .offcanvas-tab {\r\n            position: fixed;\r\n            top: 50%;\r\n            transform: translateY(-50%);\r\n            z-index: 1001;\r\n            background-color: var(--fb-primary);\r\n            color: white;\r\n            border: none;\r\n            border-radius: 8px 0 0 8px;\r\n            padding: 40px 8px;\r\n            writing-mode: vertical-rl;\r\n            text-orientation: mixed;\r\n            font-size: 14px;\r\n            font-weight: bold;\r\n            cursor: pointer;\r\n            box-shadow: -2px 2px 8px rgba(0, 0, 0, 0.3);\r\n            transition: all 0.3s ease;\r\n            letter-spacing: 2px;\r\n        }\r\n\r\n        .offcanvas-tab:hover {\r\n            background-color: var(--fb-primary-dark);\r\n            box-shadow: -4px 4px 12px rgba(0, 0, 0, 0.4);\r\n        }\r\n\r\n        .offcanvas-tab.tab-right {\r\n            right: 0;\r\n            border-radius: 8px 0 0 8px;\r\n        }\r\n\r\n        .offcanvas-tab.tab-right:hover {\r\n            right: 5px;\r\n        }\r\n\r\n        .offcanvas-tab.tab-left {\r\n            left: 0;\r\n            border-radius: 0 8px 8px 0;\r\n            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);\r\n        }\r\n\r\n        .offcanvas-tab.tab-left:hover {\r\n            left: 5px;\r\n            box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.4);\r\n        }\r\n\r\n        @media print {\r\n            .offcanvas-tab {\r\n                display: none !important;\r\n            }\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <!-- Left Tab Button for Column Guide -->\r\n    <button id=\"columnGuideTab\" class=\"offcanvas-tab tab-left\" type=\"button\" data-bs-toggle=\"offcanvas\" data-bs-target=\"#columnRefOffcanvas\" aria-controls=\"columnRefOffcanvas\" title=\"Click to view column reference\">Column Guide</button>\r\n\r\n    <!-- Right Tab Button for Instructions -->\r\n    <button id=\"instructionsTab\" class=\"offcanvas-tab tab-right\" type=\"button\" data-bs-toggle=\"offcanvas\" data-bs-target=\"#instructionsOffcanvas\" aria-controls=\"instructionsOffcanvas\" title=\"Click to view usage instructions\">Instructions</button>\r\n\r\n    <!-- Left Offcanvas: Column Reference Guide -->\r\n    <div class=\"offcanvas offcanvas-start\" tabindex=\"-1\" id=\"columnRefOffcanvas\" aria-labelledby=\"columnRefOffcanvasLabel\" style=\"width: 450px;\">\r\n        <div class=\"offcanvas-header\">\r\n            <h5 class=\"offcanvas-title\" id=\"columnRefOffcanvasLabel\"><i class=\"bi bi-book-fill\"></i> PPP Import Column Reference</h5>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"offcanvas\" aria-label=\"Close\"></button>\r\n        </div>\r\n        <div class=\"offcanvas-body\">\r\n            <div class=\"alert alert-info mb-3\" style=\"font-size: 12px;\">\r\n                <i class=\"bi bi-info-circle-fill\"></i> This guide describes all columns expected in the PPP import CSV file.\r\n            </div>\r\n            <div id=\"columnRefContent\">\r\n                <!-- Will be populated dynamically -->\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Right Offcanvas: Instructions -->\r\n    <div class=\"offcanvas offcanvas-end\" tabindex=\"-1\" id=\"instructionsOffcanvas\" aria-labelledby=\"instructionsOffcanvasLabel\" style=\"width: 500px;\">\r\n        <div class=\"offcanvas-header\">\r\n            <h5 class=\"offcanvas-title\" id=\"instructionsOffcanvasLabel\"><i class=\"bi bi-question-circle-fill\"></i> Usage Instructions</h5>\r\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"offcanvas\" aria-label=\"Close\"></button>\r\n        </div>\r\n        <div class=\"offcanvas-body\">\r\n            <div class=\"flyout-section\">\r\n                <h3>Purpose</h3>\r\n                <p>This tool validates your PPP (Part, Product & Vendor Pricing) import CSV before importing to Fishbowl, catching errors and missing data upfront.</p>\r\n            </div>\r\n\r\n            <div class=\"flyout-section\">\r\n                <h3>Quick Start</h3>\r\n                <ol>\r\n                    <li><strong>Upload CSV:</strong> Drag & drop or click to browse</li>\r\n                    <li><strong>Review Issues:</strong> Check the Issues Summary for errors/warnings</li>\r\n                    <li><strong>Fix Errors:</strong> Use quick-fix buttons to resolve common issues</li>\r\n                    <li><strong>Create Missing Data:</strong> Create UOMs, vendors, or conversions as needed</li>\r\n                    <li><strong>Import:</strong> Once validated, import directly to Fishbowl</li>\r\n                </ol>\r\n            </div>\r\n\r\n            <div class=\"flyout-section\">\r\n                <h3>Status Badges</h3>\r\n                <div class=\"mb-2\">\r\n                    <span class=\"badge bg-success me-2\"><i class=\"bi bi-check-circle\"></i> Valid</span>\r\n                    <span>All checks passed</span>\r\n                </div>\r\n                <div class=\"mb-2\">\r\n                    <span class=\"badge bg-warning text-dark me-2\"><i class=\"bi bi-exclamation-triangle\"></i> Warning</span>\r\n                    <span>Non-critical issues</span>\r\n                </div>\r\n                <div class=\"mb-2\">\r\n                    <span class=\"badge bg-danger me-2\"><i class=\"bi bi-x-circle\"></i> Error</span>\r\n                    <span>Must be fixed before import</span>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"flyout-section\">\r\n                <h3>Quick Actions</h3>\r\n                <p><strong>Create UOM:</strong> Creates missing units of measure in Fishbowl</p>\r\n                <p><strong>Create Conversion:</strong> Sets up UOM conversion ratios (e.g., 1 Box = 24 Each)</p>\r\n                <p><strong>Map to Existing:</strong> Links CSV values to existing Fishbowl data</p>\r\n                <p><strong>Fill Values:</strong> Bulk-fill empty cells with dropdown selections</p>\r\n            </div>\r\n\r\n            <div class=\"flyout-section\">\r\n                <h3>Settings</h3>\r\n                <p>Click <i class=\"bi bi-gear-fill\"></i> <strong>Settings</strong> to adjust:</p>\r\n                <ul class=\"mb-0\">\r\n                    <li>Batch size (performance tuning)</li>\r\n                    <li>Row height (table display)</li>\r\n                    <li>Virtual scrolling threshold</li>\r\n                    <li>Validation debounce delay</li>\r\n                    <li>Strict mode (additional checks)</li>\r\n                </ul>\r\n            </div>\r\n\r\n            <div class=\"flyout-section\">\r\n                <h3>Tips</h3>\r\n                <div class=\"alert alert-success mb-2 py-2\">\r\n                    <i class=\"bi bi-lightbulb\"></i> Use the <strong>Column Guide</strong> button to view all expected CSV columns and their requirements\r\n                </div>\r\n                <div class=\"alert alert-info mb-2 py-2\">\r\n                    <i class=\"bi bi-lightbulb\"></i> Click row issue counts to expand/collapse detailed error messages\r\n                </div>\r\n                <div class=\"alert alert-warning mb-0 py-2\">\r\n                    <i class=\"bi bi-lightbulb\"></i> After creating UOMs or conversions, click <strong>Re-validate</strong> to clear resolved issues\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"container\">\r\n        <h1>Part, Product & Vendor Pricing Validator</h1>\r\n        <p class=\"subtitle\">Validate your PPP import CSV before importing to Fishbowl</p>\r\n\r\n        <!-- Upload Section -->\r\n        <div class=\"upload-section\" id=\"uploadSection\">\r\n            <h3>\uD83D\uDCC4 Upload PPP Import CSV</h3>\r\n            <p>Drag and drop file here, or <button type=\"button\" class=\"btn btn-primary\" onclick=\"document.getElementById('fileInput').click()\">Choose File</button></p>\r\n            <input type=\"file\" id=\"fileInput\" accept=\".csv\" onchange=\"handleFileSelect(event)\" style=\"display: none;\" />\r\n            <p id=\"fileName\" class=\"text-primary fw-bold\"></p>\r\n        </div>\r\n\r\n        <!-- Summary Stats (hidden until file loaded) -->\r\n        <div class=\"summary-stats hidden\" id=\"summaryStats\">\r\n            <div class=\"stat-card total\">\r\n                <span class=\"stat-number\" id=\"statTotal\">0</span>\r\n                <span class=\"stat-label\">Total</span>\r\n            </div>\r\n            <div class=\"stat-card valid\">\r\n                <span class=\"stat-number\" id=\"statValid\">0</span>\r\n                <span class=\"stat-label\">Valid</span>\r\n            </div>\r\n            <div class=\"stat-card warning\">\r\n                <span class=\"stat-number\" id=\"statWarning\">0</span>\r\n                <span class=\"stat-label\">Warnings</span>\r\n            </div>\r\n            <div class=\"stat-card error\">\r\n                <span class=\"stat-number\" id=\"statError\">0</span>\r\n                <span class=\"stat-label\">Errors</span>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Consolidated Issues Summary -->\r\n        <div class=\"consolidated-issues hidden\" id=\"consolidatedIssues\">\r\n            <h3>⚠️ Issues Summary</h3>\r\n            <div id=\"consolidatedIssuesContent\"></div>\r\n        </div>\r\n\r\n        <!-- Filter Controls -->\r\n        <div class=\"filter-controls hidden\" id=\"filterControls\">\r\n            <div class=\"row g-3 align-items-center\">\r\n                <div class=\"col-auto\">\r\n                    <label for=\"filterStatus\" class=\"col-form-label fw-bold\">Show:</label>\r\n                </div>\r\n                <div class=\"col-auto\">\r\n                    <select id=\"filterStatus\" class=\"form-select\" onchange=\"applyFilters()\">\r\n                        <option value=\"all\">All Rows</option>\r\n                        <option value=\"errors\" selected>Errors Only</option>\r\n                        <option value=\"warnings\">Warnings Only</option>\r\n                        <option value=\"valid\">Valid Only</option>\r\n                    </select>\r\n                </div>\r\n                <div class=\"col\">\r\n                    <div class=\"input-group\">\r\n                        <span class=\"input-group-text\"><i class=\"bi bi-search\"></i></span>\r\n                        <input type=\"text\" id=\"searchInput\" class=\"form-control\" placeholder=\"Search by Part Number, Vendor, etc...\" oninput=\"applyFilters()\" />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Results Table -->\r\n        <div class=\"results-section hidden\" id=\"resultsSection\">\r\n            <div class=\"results-table-container\">\r\n                <table class=\"table table-sm table-hover results-table\" id=\"resultsTable\">\r\n                    <thead id=\"tableHeader\" class=\"table-primary sticky-top\">\r\n                        <!-- Dynamic headers -->\r\n                    </thead>\r\n                    <tbody id=\"tableBody\">\r\n                        <!-- Dynamic rows -->\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Action Buttons -->\r\n        <div class=\"action-buttons hidden\" id=\"actionButtons\">\r\n            <div class=\"d-flex gap-2 flex-wrap justify-content-center\">\r\n                <button type=\"button\" class=\"btn btn-primary\" onclick=\"revalidateData()\">\r\n                    <i class=\"bi bi-arrow-clockwise\"></i> Re-validate\r\n                </button>\r\n                <button type=\"button\" class=\"btn btn-success\" onclick=\"exportValidRows()\" id=\"exportValidBtn\">\r\n                    <i class=\"bi bi-check-circle\"></i> Export Valid Rows\r\n                </button>\r\n                <button type=\"button\" class=\"btn btn-warning\" onclick=\"exportAllWithFixes()\" id=\"exportAllBtn\">\r\n                    <i class=\"bi bi-pencil-square\"></i> Export All (with suggestions)\r\n                </button>\r\n                <button type=\"button\" class=\"btn btn-success\" onclick=\"importToFishbowl()\" id=\"importBtn\">\r\n                    <i class=\"bi bi-download\"></i> Import to Fishbowl\r\n                </button>\r\n                <button type=\"button\" class=\"btn btn-secondary\" onclick=\"clearData()\">\r\n                    <i class=\"bi bi-trash\"></i> Clear\r\n                </button>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Settings and Debug Sections (Accordions) -->\r\n        <div class=\"accordion mt-4\" id=\"bottomAccordions\">\r\n            <!-- Advanced Settings Accordion -->\r\n            <div class=\"accordion-item\">\r\n                <h2 class=\"accordion-header\">\r\n                    <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#settingsAccordion\">\r\n                        <i class=\"bi bi-gear me-2\"></i> Advanced Settings\r\n                    </button>\r\n                </h2>\r\n                <div id=\"settingsAccordion\" class=\"accordion-collapse collapse\" data-bs-parent=\"#bottomAccordions\">\r\n                    <div class=\"accordion-body\">\r\n                        <div class=\"config-group\">\r\n                            <h5><i class=\"bi bi-speedometer2\"></i> Performance Settings</h5>\r\n                            <div class=\"config-item\">\r\n                                <label for=\"batchSizeInput\">Batch Size:</label>\r\n                                <input type=\"number\" id=\"batchSizeInput\" value=\"200\" min=\"50\" max=\"1000\" step=\"50\" onchange=\"updateBatchSize(this.value)\">\r\n                                <small>Number of rows to process at a time (50-1000)</small>\r\n                            </div>\r\n                            <div class=\"config-item\">\r\n                                <label for=\"rowHeightInput\">Row Height (px):</label>\r\n                                <input type=\"number\" id=\"rowHeightInput\" value=\"35\" min=\"25\" max=\"60\" step=\"5\" onchange=\"updateRowHeight(this.value)\">\r\n                                <small>Approximate height of each table row (25-60px)</small>\r\n                            </div>\r\n                            <div class=\"config-item\">\r\n                                <label for=\"bufferRowsInput\">Buffer Rows:</label>\r\n                                <input type=\"number\" id=\"bufferRowsInput\" value=\"20\" min=\"5\" max=\"50\" step=\"5\" onchange=\"updateBufferRows(this.value)\">\r\n                                <small>Extra rows to render above/below viewport (5-50)</small>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class=\"config-group\">\r\n                            <h5><i class=\"bi bi-display\"></i> Display Settings</h5>\r\n                            <div class=\"config-item\">\r\n                                <label for=\"virtualScrollThreshold\">Virtual Scroll Threshold:</label>\r\n                                <input type=\"number\" id=\"virtualScrollThreshold\" value=\"500\" min=\"100\" max=\"2000\" step=\"100\" onchange=\"updateVirtualScrollThreshold(this.value)\">\r\n                                <small>Enable virtual scrolling when rows exceed this number (100-2000)</small>\r\n                            </div>\r\n                            <div class=\"config-item\">\r\n                                <label for=\"debounceDelay\">Debounce Delay (ms):</label>\r\n                                <input type=\"number\" id=\"debounceDelay\" value=\"500\" min=\"100\" max=\"2000\" step=\"100\" onchange=\"updateDebounceDelay(this.value)\">\r\n                                <small>Delay before revalidating after edits (100-2000ms)</small>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class=\"config-group\">\r\n                            <h5><i class=\"bi bi-shield-check\"></i> Validation Settings</h5>\r\n                            <div class=\"config-item\">\r\n                                <label for=\"strictMode\">Strict Mode:</label>\r\n                                <select id=\"strictMode\" onchange=\"updateStrictMode(this.value)\">\r\n                                    <option value=\"false\">Normal (Warnings + Errors)</option>\r\n                                    <option value=\"true\">Strict (Errors Only)</option>\r\n                                </select>\r\n                                <small>Choose validation strictness level</small>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class=\"alert alert-info mt-3\" style=\"font-size: 12px;\">\r\n                            <i class=\"bi bi-info-circle-fill\"></i> Changes take effect immediately. Refresh the page to reset to defaults.\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Debug Console Accordion -->\r\n            <div class=\"accordion-item\">\r\n                <h2 class=\"accordion-header\">\r\n                    <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#debugAccordion\">\r\n                        <i class=\"bi bi-terminal me-2\"></i> Debug Console\r\n                    </button>\r\n                </h2>\r\n                <div id=\"debugAccordion\" class=\"accordion-collapse collapse\" data-bs-parent=\"#bottomAccordions\">\r\n                    <div class=\"accordion-body p-0\">\r\n                        <div class=\"d-flex justify-content-between align-items-center bg-dark text-light p-2\">\r\n                            <span style=\"font-family: 'Courier New', monospace; font-size: 12px;\">Debug Output</span>\r\n                            <button type=\"button\" class=\"btn btn-sm btn-outline-light\" onclick=\"clearDebugConsole()\">\r\n                                <i class=\"bi bi-trash\"></i> Clear\r\n                            </button>\r\n                        </div>\r\n                        <div id=\"debugConsoleContent\" class=\"card-body bg-dark text-light\"\r\n                             style=\"font-family: 'Courier New', monospace; font-size: 12px; max-height: 300px; overflow-y: auto;\">\r\n                            <!-- Debug messages will appear here -->\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Loading Overlay -->\r\n    <div class=\"loading-overlay hidden\" id=\"loadingOverlay\">\r\n        <div class=\"text-center\">\r\n            <div class=\"spinner-border text-primary loading-spinner\" role=\"status\" style=\"width: 4rem; height: 4rem;\">\r\n                <span class=\"visually-hidden\">Loading...</span>\r\n            </div>\r\n            <div class=\"loading-text mt-3 fs-5 fw-bold text-white\" id=\"loadingText\">Processing file...</div>\r\n            <div id=\"progressBarContainer\" class=\"hidden mt-3\" style=\"width: 300px; margin-left: auto; margin-right: auto;\">\r\n                <div class=\"progress\" style=\"height: 20px;\">\r\n                    <div id=\"progressBar\" class=\"progress-bar bg-success progress-bar-striped progress-bar-animated\"\r\n                         role=\"progressbar\" style=\"width: 0%;\" aria-valuenow=\"0\" aria-valuemin=\"0\" aria-valuemax=\"100\"></div>\r\n                </div>\r\n            </div>\r\n            <div id=\"progressText\" class=\"hidden mt-2 text-white\">0 / 0 rows</div>\r\n        </div>\r\n    </div>\r\n\r\n    <script>\r\n    // ============================================\r\n    // Debug Console Functions\r\n    // ============================================\r\n\r\n    function debugLog(message, type = 'log') {\r\n        const timestamp = new Date().toLocaleTimeString();\r\n        const colors = {\r\n            log: '#d4d4d4',\r\n            info: '#4fc3f7',\r\n            warn: '#ffb74d',\r\n            error: '#ff6b6b',\r\n            success: '#66bb6a'\r\n        };\r\n\r\n        const consoleContent = document.getElementById('debugConsoleContent');\r\n        if (consoleContent) {\r\n            const logEntry = document.createElement('div');\r\n            logEntry.style.color = colors[type] || colors.log;\r\n            logEntry.style.marginBottom = '4px';\r\n            logEntry.style.borderBottom = '1px solid #2a2a2a';\r\n            logEntry.style.paddingBottom = '4px';\r\n\r\n            // Create type label mapping without toUpperCase\r\n            const typeLabels = {\r\n                log: 'LOG    ',\r\n                info: 'INFO   ',\r\n                warn: 'WARN   ',\r\n                error: 'ERROR  ',\r\n                success: 'SUCCESS'\r\n            };\r\n            const typeLabel = typeLabels[type] || 'LOG    ';\r\n\r\n            logEntry.innerHTML = `<span style=\"color: #666;\">[${timestamp}]</span> <span style=\"color: ${colors[type]};\">[${typeLabel}]</span> ${escapeHtml(String(message))}`;\r\n\r\n            consoleContent.appendChild(logEntry);\r\n            consoleContent.scrollTop = consoleContent.scrollHeight;\r\n        }\r\n    }\r\n\r\n    function toggleDebugConsole() {\r\n        const content = document.getElementById('debugConsoleContent');\r\n        const toggle = document.getElementById('debugToggle');\r\n\r\n        if (content.classList.contains('hidden')) {\r\n            content.classList.remove('hidden');\r\n            toggle.textContent = '▼';\r\n        } else {\r\n            content.classList.add('hidden');\r\n            toggle.textContent = '▶';\r\n        }\r\n    }\r\n\r\n    function clearDebugConsole() {\r\n        const consoleContent = document.getElementById('debugConsoleContent');\r\n        if (consoleContent) {\r\n            consoleContent.innerHTML = '';\r\n        }\r\n    }\r\n\r\n    // Override console methods to also write to debug console\r\n    const originalConsole = {\r\n        log: console.log,\r\n        error: console.error,\r\n        warn: console.warn,\r\n        info: console.info\r\n    };\r\n\r\n    console.log = function(...args) {\r\n        debugLog(args.join(' '), 'log');\r\n        originalConsole.log.apply(console, args);\r\n    };\r\n\r\n    console.error = function(...args) {\r\n        debugLog(args.join(' '), 'error');\r\n        originalConsole.error.apply(console, args);\r\n    };\r\n\r\n    console.warn = function(...args) {\r\n        debugLog(args.join(' '), 'warn');\r\n        originalConsole.warn.apply(console, args);\r\n    };\r\n\r\n    console.info = function(...args) {\r\n        debugLog(args.join(' '), 'info');\r\n        originalConsole.info.apply(console, args);\r\n    };\r\n\r\n    // Global error handler\r\n    window.onerror = function(message, source, lineno, colno, error) {\r\n        debugLog(`JavaScript Error: ${message} at line ${lineno}:${colno}`, 'error');\r\n        if (error && error.stack) {\r\n            debugLog(`Stack: ${error.stack}`, 'error');\r\n        }\r\n        return false; // Allow default error handling\r\n    };\r\n\r\n    // Unhandled promise rejection handler\r\n    window.onunhandledrejection = function(event) {\r\n        debugLog(`Unhandled Promise Rejection: ${event.reason}`, 'error');\r\n    };\r\n\r\n    // ============================================\r\n    // Performance Utility Functions\r\n    // ============================================\r\n\r\n    function showProgress(current, total) {\r\n        const progressBar = document.getElementById('progressBar');\r\n        const progressText = document.getElementById('progressText');\r\n        const progressBarContainer = document.getElementById('progressBarContainer');\r\n\r\n        if (progressBar && progressText && progressBarContainer) {\r\n            progressBarContainer.classList.remove('hidden');\r\n            progressText.classList.remove('hidden');\r\n\r\n            const percent = Math.round((current / total) * 100);\r\n            progressBar.style.width = percent + '%';\r\n            progressText.textContent = `${current} / ${total} rows (${percent}%)`;\r\n        }\r\n    }\r\n\r\n    function hideProgress() {\r\n        const progressBarContainer = document.getElementById('progressBarContainer');\r\n        const progressText = document.getElementById('progressText');\r\n\r\n        if (progressBarContainer && progressText) {\r\n            progressBarContainer.classList.add('hidden');\r\n            progressText.classList.add('hidden');\r\n        }\r\n    }\r\n\r\n    // Debounce function to delay execution\r\n    function debounce(func, delay) {\r\n        return function(...args) {\r\n            if (debounceTimer) {\r\n                clearTimeout(debounceTimer);\r\n            }\r\n            debounceTimer = setTimeout(() => {\r\n                func.apply(this, args);\r\n            }, delay);\r\n        };\r\n    }\r\n\r\n    // Sleep function for batch processing\r\n    function sleep(ms) {\r\n        return new Promise(resolve => setTimeout(resolve, ms));\r\n    }\r\n\r\n    // ============================================\r\n    // Configuration & Column Definitions\r\n    // ============================================\r\n\r\n    const PPP_COLUMNS = {\r\n        // Part Information - Core (Required fields marked)\r\n        'PartNumber': { type: 'Text', required: true, desc: 'Unique part identifier (70 chars max) - REQUIRED' },\r\n        'PartDescription': { type: 'Text', required: true, desc: 'Part description (252 chars max) - REQUIRED' },\r\n        'PartDetails': { type: 'Text', required: false, desc: 'Additional part details (no limit)' },\r\n        'UOM': { type: 'Text', required: true, desc: 'Default Unit of Measure (10 chars max) - REQUIRED', validateUOM: true },\r\n        'UPC': { type: 'Text', required: false, desc: 'Universal Product Code (31 chars max)' },\r\n        'PartTypeID': { type: 'Integer', required: true, desc: 'Part type ID - REQUIRED: 10=INVENTORY, 20=SERVICE, 21=LABOR, 22=OVERHEAD, 30=NON_INVENTORY, 40=INTERNAL_USE, 50=CAPITAL, 60=SHIPPING', validValues: ['10', '20', '21', '22', '30', '40', '50', '60'] },\r\n        'Active': { type: 'Text', required: true, desc: 'Whether part is active (text field) - REQUIRED' },\r\n        'PartTaxCode': { type: 'Text', required: true, desc: 'Tax code for the part - REQUIRED', validateTaxCode: true },\r\n        'StdCost': { type: 'Decimal', required: false, desc: 'Standard cost (numeric)' },\r\n\r\n        // Part - Tracking Flags (all Text type in Fishbowl)\r\n        'Tracks-Lot Number': { type: 'Text', required: false, desc: 'Indicates if the part tracks lot numbers' },\r\n        'Tracks-Revision Level': { type: 'Text', required: false, desc: 'Indicates if the part tracks revision levels' },\r\n        'Tracks-Expiration Date': { type: 'Text', required: false, desc: 'Indicates if the part tracks expiration dates' },\r\n        'Tracks-Serial Number': { type: 'Text', required: false, desc: 'Indicates if the part tracks serial numbers' },\r\n        'Tracks-Batch Number': { type: 'Text', required: false, desc: 'Indicates if the part tracks batch numbers' },\r\n        'Tracks-BoxID-Qty': { type: 'Text', required: false, desc: 'Indicates if the part tracks BoxID quantity' },\r\n        'Tracks-BoxID-count': { type: 'Text', required: false, desc: 'Indicates if the part tracks BoxID count' },\r\n        'Tracks-BoxID-money': { type: 'Text', required: false, desc: 'Indicates if the part tracks BoxID money' },\r\n        'Tracks-Consignment': { type: 'Text', required: false, desc: 'Indicates if the part tracks consignment' },\r\n        'Next Value-': { type: 'Text', required: false, desc: 'The next value for tracking' },\r\n\r\n        // Accounting\r\n        'AssetAccount': { type: 'Text', required: false, desc: 'Inventory asset account' },\r\n        'COGSAccount': { type: 'Text', required: false, desc: 'Cost of goods sold account' },\r\n        'AdjustmentAccount': { type: 'Text', required: false, desc: 'Adjustment account' },\r\n        'ScrapAccount': { type: 'Text', required: false, desc: 'Scrap account' },\r\n        'VarianceAccount': { type: 'Text', required: false, desc: 'Variance account' },\r\n        'ABCCode': { type: 'Text', required: false, desc: 'ABC code classification' },\r\n\r\n        // Part - Physical Properties (all Text type)\r\n        'Weight': { type: 'Text', required: false, desc: 'Part weight' },\r\n        'WeightUOM': { type: 'Text', required: false, desc: 'Weight unit of measure', validateUOM: true },\r\n        'Width': { type: 'Text', required: false, desc: 'Part width' },\r\n        'Height': { type: 'Text', required: false, desc: 'Part height' },\r\n        'Len': { type: 'Text', required: false, desc: 'Part length' },\r\n        'SizeUOM': { type: 'Text', required: false, desc: 'Size unit of measure', validateUOM: true },\r\n        'ConsumptionRate': { type: 'Decimal', required: false, desc: 'Consumption rate (numeric)' },\r\n\r\n        // Part - Other\r\n        'PartURL': { type: 'Text', required: false, desc: 'URL for the part' },\r\n        'PartRevision': { type: 'Text', required: false, desc: 'Part revision' },\r\n        'PartPictureURL': { type: 'Text', required: false, desc: 'URL to part picture (import only)' },\r\n\r\n        // Product Information\r\n        'ProductNumber': { type: 'Text', required: false, desc: 'Product number (70 chars max)' },\r\n        'ProductDescription': { type: 'Text', required: false, desc: 'Product description (252 chars max)' },\r\n        'ProductDetails': { type: 'Text', required: false, desc: 'Additional product details (no limit)' },\r\n        'Price': { type: 'Decimal', required: false, desc: 'Product price (numeric)' },\r\n        'ProductSKU': { type: 'Text', required: false, desc: 'Product SKU (31 chars max)' },\r\n        'ProductUPC': { type: 'Text', required: false, desc: 'Product UPC code (31 chars max)' },\r\n        'ProductActive': { type: 'Text', required: false, desc: 'Whether product is active' },\r\n        'ProductTaxable': { type: 'Text', required: false, desc: 'Whether product is taxable' },\r\n        'ProductSOItemTypeID': { type: 'Integer', required: false, desc: 'Product SO item type ID: 10=Sale, 12=Drop Ship, 20=Credit Return', validValues: ['10', '12', '20'] },\r\n        'IncomeAccount': { type: 'Text', required: false, desc: 'Income account' },\r\n\r\n        // Product - Physical Properties (all Text type)\r\n        'ProductWeight': { type: 'Text', required: false, desc: 'Product weight' },\r\n        'ProductWeightUOM': { type: 'Text', required: false, desc: 'Product weight UOM', validateUOM: true },\r\n        'ProductWidth': { type: 'Text', required: false, desc: 'Product width' },\r\n        'ProductHeight': { type: 'Text', required: false, desc: 'Product height' },\r\n        'ProductLen': { type: 'Text', required: false, desc: 'Product length' },\r\n        'ProductSizeUOM': { type: 'Text', required: false, desc: 'Product size UOM', validateUOM: true },\r\n        'ProductPictureURL': { type: 'Text', required: false, desc: 'Product picture URL (import only)' },\r\n\r\n        // Vendor Pricing Information\r\n        'Vendor': { type: 'Text', required: false, desc: 'Vendor name (41 chars / 30 chars max)', validateVendor: true },\r\n        'DefaultVendor': { type: 'Text', required: false, desc: 'Whether this is the default vendor' },\r\n        'VendorPartNumber': { type: 'Text', required: false, desc: 'Vendor part number (70 chars / 30 chars max)' },\r\n        'Cost': { type: 'Decimal', required: false, desc: 'Vendor cost (numeric)' },\r\n        'VendorUOM': { type: 'Text', required: false, desc: 'Vendor UOM (10 chars max)', validateUOM: true }\r\n    };\r\n\r\n    // Global state\r\n    let csvData = [];\r\n    let csvHeaders = [];\r\n    let validationResults = [];\r\n    let consolidatedIssues = {};\r\n    let fishbowlData = {\r\n        uoms: [],\r\n        uomDetails: [], // Full UOM details including type\r\n        vendors: [],\r\n        customFields: [],\r\n        uomConversions: [],\r\n        taxCodes: [],\r\n        partTypes: []\r\n    };\r\n\r\n    // Performance optimization settings (configurable via settings offcanvas)\r\n    let BATCH_SIZE = 200; // Process 200 rows at a time\r\n    let ROW_HEIGHT = 35; // Approximate height of each table row in pixels\r\n    let BUFFER_ROWS = 20; // Extra rows to render above/below viewport\r\n    let VIRTUAL_SCROLL_THRESHOLD = 500; // Enable virtual scrolling when rows exceed this number\r\n    let DEBOUNCE_DELAY = 500; // Delay before revalidating after edits\r\n    let STRICT_MODE = false; // Validation strictness\r\n\r\n    // Virtual scrolling state\r\n    let virtualScrollState = {\r\n        enabled: false,\r\n        scrollTop: 0,\r\n        viewportHeight: 500,\r\n        totalRows: 0,\r\n        visibleStartIndex: 0,\r\n        visibleEndIndex: 0\r\n    };\r\n\r\n    // Sorting state\r\n    let sortState = {\r\n        column: null,\r\n        direction: 'asc' // 'asc' or 'desc'\r\n    };\r\n\r\n    // Debounce timer\r\n    let debounceTimer = null;\r\n\r\n    // ============================================\r\n    // Initialization\r\n    // ============================================\r\n\r\n    window.onload = function() {\r\n        loadFishbowlReferenceData();\r\n        populateColumnReference();\r\n        setupDragAndDrop();\r\n    };\r\n\r\n    function setupDragAndDrop() {\r\n        const uploadSection = document.getElementById('uploadSection');\r\n\r\n        uploadSection.addEventListener('dragover', function(e) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            this.classList.add('dragover');\r\n        });\r\n\r\n        uploadSection.addEventListener('dragleave', function(e) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            this.classList.remove('dragover');\r\n        });\r\n\r\n        uploadSection.addEventListener('drop', function(e) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            this.classList.remove('dragover');\r\n\r\n            const files = e.dataTransfer.files;\r\n            if (files.length > 0 && files[0].name.endsWith('.csv')) {\r\n                processFile(files[0]);\r\n            } else {\r\n                showToast('Invalid File', 'Please drop a CSV file.', 'warning');\r\n            }\r\n        });\r\n    }\r\n\r\n    // ============================================\r\n    // Fishbowl Data Loading\r\n    // ============================================\r\n\r\n    function loadFishbowlReferenceData() {\r\n        try {\r\n            // Load UOMs with type information\r\n            console.log('Loading UOMs...');\r\n            let uomQuery = `SELECT code, name, uomtype FROM uom WHERE activeflag = 1 ORDER BY code`;\r\n            console.log('UOM query:', uomQuery);\r\n            let uomResult = runQuery(uomQuery);\r\n            console.log('UOM query result (raw):', uomResult);\r\n            console.log('UOM result type:', typeof uomResult);\r\n            console.log('UOM result is null?:', uomResult === null);\r\n            console.log('UOM result is undefined?:', uomResult === undefined);\r\n            console.log('UOM result is empty string?:', uomResult === '');\r\n\r\n            if (!uomResult) {\r\n                console.warn('UOM query returned null, undefined, or empty string');\r\n                fishbowlData.uoms = [];\r\n                fishbowlData.uomDetails = [];\r\n            } else {\r\n                let uoms = JSON.parse(uomResult);\r\n                console.log('UOM query result (parsed):', uoms);\r\n                if (uoms && !Array.isArray(uoms)) uoms = [uoms];\r\n                fishbowlData.uoms = uoms.map(u => u.code);\r\n                fishbowlData.uomDetails = uoms; // Store full details including type\r\n            }\r\n\r\n            // Load Vendors\r\n            console.log('Loading Vendors...');\r\n            let vendorQuery = `SELECT name FROM vendor WHERE activeflag = 1 ORDER BY name`;\r\n            console.log('Vendor query:', vendorQuery);\r\n            let vendorResult = runQuery(vendorQuery);\r\n            console.log('Vendor query result (raw):', vendorResult);\r\n            console.log('Vendor result type:', typeof vendorResult);\r\n\r\n            if (!vendorResult) {\r\n                console.warn('Vendor query returned null, undefined, or empty string');\r\n                fishbowlData.vendors = [];\r\n            } else {\r\n                let vendors = JSON.parse(vendorResult);\r\n                console.log('Vendor query result (parsed):', vendors);\r\n                if (vendors && !Array.isArray(vendors)) vendors = [vendors];\r\n                fishbowlData.vendors = vendors.map(v => v.name);\r\n            }\r\n\r\n            // Load Custom Fields (for Part)\r\n            console.log('Loading Custom Fields...');\r\n            let cfQuery = `SELECT name FROM customfield WHERE tableid IN (SELECT id FROM systables WHERE name = 'Part') AND activeflag = 1`;\r\n            let cfResult = runQuery(cfQuery);\r\n            console.log('Custom Field query result:', cfResult);\r\n            let customFields = cfResult ? JSON.parse(cfResult) : [];\r\n            if (customFields && !Array.isArray(customFields)) customFields = [customFields];\r\n            fishbowlData.customFields = customFields.map(cf => cf.name);\r\n\r\n            // Load UOM Conversions\r\n            console.log('Loading UOM Conversions...');\r\n            let convQuery = `SELECT\r\n                u1.code as fromUom,\r\n                u2.code as toUom\r\n            FROM uomconversion uc\r\n            INNER JOIN uom u1 ON uc.touomid = u1.id\r\n            INNER JOIN uom u2 ON uc.fromuomid = u2.id`;\r\n            let convResult = runQuery(convQuery);\r\n            console.log('UOM Conversion query result:', convResult);\r\n            let conversions = convResult ? JSON.parse(convResult) : [];\r\n            if (conversions && !Array.isArray(conversions)) conversions = [conversions];\r\n            fishbowlData.uomConversions = conversions.map(c => c.fromUom + '->' + c.toUom);\r\n\r\n            // Load Tax Codes\r\n            console.log('Loading Tax Codes...');\r\n            let taxQuery = `SELECT code, name FROM taxrate WHERE activeflag = 1 ORDER BY name`;\r\n            console.log('Tax query:', taxQuery);\r\n            let taxResult = runQuery(taxQuery);\r\n            console.log('Tax Code query result (raw):', taxResult);\r\n            console.log('Tax Code result type:', typeof taxResult);\r\n\r\n            if (!taxResult) {\r\n                console.warn('Tax query returned null or undefined');\r\n                fishbowlData.taxCodes = [];\r\n            } else {\r\n                let taxCodes = JSON.parse(taxResult);\r\n                console.log('Tax Code query result (parsed):', taxCodes);\r\n                if (taxCodes && !Array.isArray(taxCodes)) taxCodes = [taxCodes];\r\n                fishbowlData.taxCodes = taxCodes; // Keep objects with code and name\r\n            }\r\n\r\n            // Load Part Types\r\n            console.log('Loading Part Types...');\r\n            let partTypeQuery = `SELECT id, name FROM parttype ORDER BY name`;\r\n            console.log('Part Type query:', partTypeQuery);\r\n            let partTypeResult = runQuery(partTypeQuery);\r\n            console.log('Part Type query result (raw):', partTypeResult);\r\n\r\n            if (!partTypeResult) {\r\n                console.warn('Part Type query returned null or undefined');\r\n                fishbowlData.partTypes = [];\r\n            } else {\r\n                let partTypes = JSON.parse(partTypeResult);\r\n                console.log('Part Type query result (parsed):', partTypes);\r\n                if (partTypes && !Array.isArray(partTypes)) partTypes = [partTypes];\r\n                fishbowlData.partTypes = partTypes; // Keep objects with id and name\r\n            }\r\n\r\n            console.log('Loaded Fishbowl reference data:', {\r\n                uoms: fishbowlData.uoms.length,\r\n                vendors: fishbowlData.vendors.length,\r\n                customFields: fishbowlData.customFields.length,\r\n                uomConversions: fishbowlData.uomConversions.length,\r\n                taxCodes: fishbowlData.taxCodes.length,\r\n                partTypes: fishbowlData.partTypes.length\r\n            });\r\n\r\n        } catch (e) {\r\n            console.error('Error loading Fishbowl reference data:', e);\r\n            showToast('Load Error', 'Error loading reference data from Fishbowl: ' + e.message + '. Check debug console for details.', 'danger');\r\n            // Continue with empty data - validation will still work for format checks\r\n        }\r\n    }\r\n\r\n    // ============================================\r\n    // File Processing\r\n    // ============================================\r\n\r\n    function handleFileSelect(event) {\r\n        const file = event.target.files[0];\r\n        if (file) {\r\n            processFile(file);\r\n        }\r\n    }\r\n\r\n    function processFile(file) {\r\n        showLoading('Reading file...');\r\n        document.getElementById('fileName').textContent = file.name;\r\n\r\n        const reader = new FileReader();\r\n        reader.onload = async function(e) {\r\n            try {\r\n                showLoading('Parsing CSV...');\r\n                parseCSV(e.target.result);\r\n\r\n                showLoading('Validating data...');\r\n                await validateData(); // Now async!\r\n\r\n                showLoading('Rendering results...');\r\n                renderResults();\r\n\r\n                hideLoading();\r\n\r\n            } catch (err) {\r\n                hideLoading();\r\n                hideProgress();\r\n                showToast('Processing Error', 'Error processing file: ' + err.message, 'danger');\r\n                console.error(err);\r\n            }\r\n        };\r\n        reader.onerror = function() {\r\n            hideLoading();\r\n            showToast('File Error', 'Error reading file', 'danger');\r\n        };\r\n        reader.readAsText(file);\r\n    }\r\n\r\n    function parseCSV(text) {\r\n        csvData = [];\r\n        csvHeaders = [];\r\n\r\n        // Handle different line endings\r\n        const lines = text.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n').split('\\n');\r\n\r\n        if (lines.length === 0) {\r\n            throw new Error('Empty file');\r\n        }\r\n\r\n        // Parse header row\r\n        csvHeaders = parseCSVLine(lines[0]);\r\n\r\n        // Parse data rows\r\n        for (let i = 1; i < lines.length; i++) {\r\n            const line = lines[i].trim();\r\n            if (line === '') continue;\r\n\r\n            const values = parseCSVLine(line);\r\n            const row = { _rowNum: i + 1 };\r\n\r\n            csvHeaders.forEach((header, index) => {\r\n                row[header] = values[index] !== undefined ? values[index] : '';\r\n            });\r\n\r\n            csvData.push(row);\r\n        }\r\n\r\n        console.log('Parsed ' + csvData.length + ' rows with ' + csvHeaders.length + ' columns');\r\n    }\r\n\r\n    function parseCSVLine(line) {\r\n        const result = [];\r\n        let current = '';\r\n        let inQuotes = false;\r\n\r\n        for (let i = 0; i < line.length; i++) {\r\n            const char = line[i];\r\n            const nextChar = line[i + 1];\r\n\r\n            if (inQuotes) {\r\n                if (char === '\"' && nextChar === '\"') {\r\n                    // Escaped quote\r\n                    current += '\"';\r\n                    i++;\r\n                } else if (char === '\"') {\r\n                    // End of quoted field\r\n                    inQuotes = false;\r\n                } else {\r\n                    current += char;\r\n                }\r\n            } else {\r\n                if (char === '\"') {\r\n                    inQuotes = true;\r\n                } else if (char === ',') {\r\n                    result.push(current.trim());\r\n                    current = '';\r\n                } else {\r\n                    current += char;\r\n                }\r\n            }\r\n        }\r\n\r\n        result.push(current.trim());\r\n        return result;\r\n    }\r\n\r\n    // ============================================\r\n    // Validation\r\n    // ============================================\r\n\r\n    // Validate a single row - helper function\r\n    function validateRow(row, index, missingDeps) {\r\n        const rowResult = {\r\n            rowNum: row._rowNum,\r\n            rowIndex: index,\r\n            status: 'valid',\r\n            errors: [],\r\n            warnings: [],\r\n            cellErrors: {},\r\n            cellWarnings: {}\r\n        };\r\n\r\n        // Check all required fields - these generate WARNINGS\r\n        const requiredFields = ['PartNumber', 'PartDescription', 'UOM', 'PartTypeID', 'Active', 'PartTaxCode'];\r\n        requiredFields.forEach(field => {\r\n            if (!row[field] || row[field].trim() === '') {\r\n                rowResult.warnings.push({\r\n                    field: field,\r\n                    message: `Required field is missing`,\r\n                    suggestion: `Provide a value for ${field}`\r\n                });\r\n                rowResult.cellWarnings[field] = true;\r\n            }\r\n        });\r\n\r\n        // Validate each column - validation failures generate ERRORS\r\n        csvHeaders.forEach(header => {\r\n            const value = row[header];\r\n            if (!value || value.trim() === '') return; // Skip empty values\r\n\r\n            // Check if it's a custom field\r\n            if (header.startsWith('CF-')) {\r\n                const cfName = header.substring(3);\r\n                if (fishbowlData.customFields.length > 0 && !fishbowlData.customFields.includes(cfName)) {\r\n                    rowResult.errors.push({\r\n                        field: header,\r\n                        message: `Custom field \"${cfName}\" does not exist in Fishbowl`,\r\n                        suggestion: 'Create this custom field in Fishbowl first, or remove this column'\r\n                    });\r\n                    rowResult.cellErrors[header] = true;\r\n                    missingDeps.customFields.add(cfName);\r\n                }\r\n                return;\r\n            }\r\n\r\n            const colDef = PPP_COLUMNS[header];\r\n            if (!colDef) {\r\n                // Unknown column - Fishbowl will ignore it, we'll skip validation\r\n                return;\r\n            }\r\n\r\n            // Type validation (only if value is not empty)\r\n            const typeError = validateType(value, colDef.type, header);\r\n            if (typeError) {\r\n                rowResult.errors.push(typeError);\r\n                rowResult.cellErrors[header] = true;\r\n            }\r\n\r\n            // Valid values check\r\n            if (colDef.validValues && !colDef.validValues.includes(value)) {\r\n                rowResult.errors.push({\r\n                    field: header,\r\n                    message: `Invalid value \"${value}\"`,\r\n                    suggestion: `Valid values: ${colDef.validValues.join(', ')}`\r\n                });\r\n                rowResult.cellErrors[header] = true;\r\n            }\r\n\r\n            // UOM validation\r\n            if (colDef.validateUOM && fishbowlData.uoms.length > 0) {\r\n                if (!fishbowlData.uoms.includes(value)) {\r\n                    rowResult.errors.push({\r\n                        field: header,\r\n                        message: `UOM \"${value}\" does not exist in Fishbowl`,\r\n                        suggestion: 'Create this UOM first, or use an existing one'\r\n                    });\r\n                    rowResult.cellErrors[header] = true;\r\n                    missingDeps.uoms.add(value);\r\n                }\r\n            }\r\n\r\n            // Vendor validation\r\n            if (colDef.validateVendor && fishbowlData.vendors.length > 0) {\r\n                if (!fishbowlData.vendors.some(v => v.toLowerCase() === value.toLowerCase())) {\r\n                    rowResult.errors.push({\r\n                        field: header,\r\n                        message: `Vendor \"${value}\" does not exist in Fishbowl`,\r\n                        suggestion: 'Create this vendor first, or check spelling'\r\n                    });\r\n                    rowResult.cellErrors[header] = true;\r\n                    missingDeps.vendors.add(value);\r\n                }\r\n            }\r\n\r\n            // Tax Code validation\r\n            if (colDef.validateTaxCode && fishbowlData.taxCodes.length > 0) {\r\n                if (!fishbowlData.taxCodes.some(tc => tc.code.toLowerCase() === value.toLowerCase())) {\r\n                    rowResult.errors.push({\r\n                        field: header,\r\n                        message: `Tax code \"${value}\" does not exist in Fishbowl`,\r\n                        suggestion: 'Select a valid tax code or create this tax code first'\r\n                    });\r\n                    rowResult.cellErrors[header] = true;\r\n                }\r\n            }\r\n        });\r\n\r\n        // Check UOM conversions if multiple UOMs are specified\r\n        const partUom = row['UOM'] ? row['UOM'] : null;\r\n        const productUom = row['ProductUOM'] ? row['ProductUOM'] : null;\r\n        const vendorUom = row['VendorUOM'] ? row['VendorUOM'] : null;\r\n\r\n        if (partUom && productUom && partUom !== productUom) {\r\n            const convKey = partUom + '->' + productUom;\r\n            const revConvKey = productUom + '->' + partUom;\r\n            if (fishbowlData.uomConversions.length > 0 &&\r\n                !fishbowlData.uomConversions.includes(convKey) &&\r\n                !fishbowlData.uomConversions.includes(revConvKey)) {\r\n                rowResult.warnings.push({\r\n                    field: 'ProductUOM',\r\n                    message: `UOM conversion from ${partUom} to ${productUom} may not exist`,\r\n                    suggestion: 'Ensure UOM conversion exists in Fishbowl'\r\n                });\r\n                rowResult.cellWarnings['ProductUOM'] = true;\r\n                missingDeps.uomConversions.add(partUom + ' <-> ' + productUom);\r\n            }\r\n        }\r\n\r\n        if (partUom && vendorUom && partUom !== vendorUom) {\r\n            const convKey = partUom + '->' + vendorUom;\r\n            const revConvKey = vendorUom + '->' + partUom;\r\n            if (fishbowlData.uomConversions.length > 0 &&\r\n                !fishbowlData.uomConversions.includes(convKey) &&\r\n                !fishbowlData.uomConversions.includes(revConvKey)) {\r\n                rowResult.warnings.push({\r\n                    field: 'VendorUOM',\r\n                    message: `UOM conversion from ${partUom} to ${vendorUom} may not exist`,\r\n                    suggestion: 'Ensure UOM conversion exists in Fishbowl'\r\n                });\r\n                rowResult.cellWarnings['VendorUOM'] = true;\r\n                missingDeps.uomConversions.add(partUom + ' <-> ' + vendorUom);\r\n            }\r\n        }\r\n\r\n        // Set overall status\r\n        if (rowResult.errors.length > 0) {\r\n            rowResult.status = 'error';\r\n        } else if (rowResult.warnings.length > 0) {\r\n            rowResult.status = 'warning';\r\n        }\r\n\r\n        return rowResult;\r\n    }\r\n\r\n    // Batched async validation with progress indicator\r\n    async function validateData() {\r\n        validationResults = [];\r\n        consolidatedIssues = {}; // Clear old consolidated issues before revalidation\r\n\r\n        const missingDeps = {\r\n            uoms: new Set(),\r\n            vendors: new Set(),\r\n            customFields: new Set(),\r\n            uomConversions: new Set()\r\n        };\r\n\r\n        const totalRows = csvData.length;\r\n        const enableVirtualScroll = totalRows > 500; // Enable virtual scroll for large datasets\r\n\r\n        console.log(`Validating ${totalRows} rows (batch size: ${BATCH_SIZE})...`);\r\n\r\n        // Process rows in batches\r\n        for (let i = 0; i < totalRows; i += BATCH_SIZE) {\r\n            const batchEnd = Math.min(i + BATCH_SIZE, totalRows);\r\n            const batch = csvData.slice(i, batchEnd);\r\n\r\n            // Validate batch\r\n            batch.forEach((row, batchIndex) => {\r\n                const globalIndex = i + batchIndex;\r\n                const rowResult = validateRow(row, globalIndex, missingDeps);\r\n                validationResults.push(rowResult);\r\n            });\r\n\r\n            // Update progress\r\n            showProgress(batchEnd, totalRows);\r\n\r\n            // Allow UI to update between batches (prevents freezing)\r\n            if (batchEnd < totalRows) {\r\n                await sleep(10);\r\n            }\r\n        }\r\n\r\n        // Enable/disable virtual scrolling based on dataset size\r\n        virtualScrollState.enabled = enableVirtualScroll;\r\n        virtualScrollState.totalRows = totalRows;\r\n\r\n        console.log(`Validation complete. Virtual scrolling: ${enableVirtualScroll ? 'enabled' : 'disabled'}`);\r\n        hideProgress();\r\n    }\r\n\r\n    function validateType(value, type, field) {\r\n        switch (type) {\r\n            case 'Integer':\r\n                if (!/^-?\\d+$/.test(value)) {\r\n                    return {\r\n                        field: field,\r\n                        message: `\"${value}\" is not a valid integer`,\r\n                        suggestion: 'Use whole numbers only (e.g., 1, 10, 100)'\r\n                    };\r\n                }\r\n                break;\r\n\r\n            case 'Decimal':\r\n            case 'Currency':\r\n            case 'Percentage':\r\n                // Remove currency symbols and commas for validation\r\n                const cleanValue = value.replace(/[$,]/g, '');\r\n                if (!/^-?\\d*\\.?\\d+$/.test(cleanValue)) {\r\n                    return {\r\n                        field: field,\r\n                        message: `\"${value}\" is not a valid number`,\r\n                        suggestion: 'Use numeric format (e.g., 10.50)'\r\n                    };\r\n                }\r\n                break;\r\n\r\n            case 'Boolean':\r\n                const boolValues = ['true', 'false', '1', '0', 'yes', 'no'];\r\n                if (!boolValues.includes(value.toLowerCase())) {\r\n                    return {\r\n                        field: field,\r\n                        message: `\"${value}\" is not a valid boolean`,\r\n                        suggestion: 'Use true/false, 1/0, or yes/no'\r\n                    };\r\n                }\r\n                break;\r\n\r\n            case 'Date':\r\n                // Basic date validation - could be enhanced\r\n                const dateRegex = /^\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{2,4}$|^\\d{4}[\\/\\-]\\d{1,2}[\\/\\-]\\d{1,2}$/;\r\n                if (!dateRegex.test(value)) {\r\n                    return {\r\n                        field: field,\r\n                        message: `\"${value}\" is not a valid date format`,\r\n                        suggestion: 'Use MM/DD/YYYY or YYYY-MM-DD format'\r\n                    };\r\n                }\r\n                break;\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // ============================================\r\n    // Rendering\r\n    // ============================================\r\n\r\n    function renderResults() {\r\n        // Show sections\r\n        document.getElementById('summaryStats').classList.remove('hidden');\r\n        document.getElementById('filterControls').classList.remove('hidden');\r\n        document.getElementById('resultsSection').classList.remove('hidden');\r\n        document.getElementById('actionButtons').classList.remove('hidden');\r\n\r\n        // Update stats\r\n        const totalRows = validationResults.length;\r\n        const validRows = validationResults.filter(r => r.status === 'valid').length;\r\n        const warningRows = validationResults.filter(r => r.status === 'warning').length;\r\n        const errorRows = validationResults.filter(r => r.status === 'error').length;\r\n\r\n        document.getElementById('statTotal').textContent = totalRows;\r\n        document.getElementById('statValid').textContent = validRows;\r\n        document.getElementById('statWarning').textContent = warningRows;\r\n        document.getElementById('statError').textContent = errorRows;\r\n\r\n        // Enable/disable export buttons\r\n        document.getElementById('exportValidBtn').disabled = validRows === 0;\r\n\r\n        // Consolidate and render issues\r\n        consolidateIssues();\r\n        renderConsolidatedIssues();\r\n\r\n        // Render table with default filter (errors only)\r\n        applyFilters();\r\n    }\r\n\r\n    // ============================================\r\n    // Consolidated Issues\r\n    // ============================================\r\n\r\n    function consolidateIssues() {\r\n        consolidatedIssues = {};\r\n\r\n        validationResults.forEach(result => {\r\n            // Consolidate errors\r\n            result.errors.forEach(error => {\r\n                const key = `${error.field}:${error.message}`;\r\n                if (!consolidatedIssues[key]) {\r\n                    consolidatedIssues[key] = {\r\n                        type: 'error',\r\n                        field: error.field,\r\n                        message: error.message,\r\n                        suggestion: error.suggestion,\r\n                        values: new Set(),\r\n                        rowCount: 0\r\n                    };\r\n                }\r\n                // Track unique values that caused the issue\r\n                const row = csvData[result.rowIndex];\r\n                if (row[error.field]) {\r\n                    consolidatedIssues[key].values.add(row[error.field]);\r\n                }\r\n                consolidatedIssues[key].rowCount++;\r\n            });\r\n\r\n            // Consolidate warnings\r\n            result.warnings.forEach(warning => {\r\n                const key = `${warning.field}:${warning.message}`;\r\n                if (!consolidatedIssues[key]) {\r\n                    consolidatedIssues[key] = {\r\n                        type: 'warning',\r\n                        field: warning.field,\r\n                        message: warning.message,\r\n                        suggestion: warning.suggestion,\r\n                        values: new Set(),\r\n                        rowCount: 0\r\n                    };\r\n                }\r\n                const row = csvData[result.rowIndex];\r\n                if (row[warning.field]) {\r\n                    consolidatedIssues[key].values.add(row[warning.field]);\r\n                }\r\n                consolidatedIssues[key].rowCount++;\r\n            });\r\n        });\r\n    }\r\n\r\n    function renderConsolidatedIssues() {\r\n        const panel = document.getElementById('consolidatedIssues');\r\n        const content = document.getElementById('consolidatedIssuesContent');\r\n\r\n        // Sort issues by row count (most frequent first)\r\n        const sortedIssues = Object.values(consolidatedIssues).sort((a, b) => b.rowCount - a.rowCount);\r\n\r\n        if (sortedIssues.length === 0) {\r\n            panel.classList.add('hidden');\r\n            return;\r\n        }\r\n\r\n        panel.classList.remove('hidden');\r\n\r\n        let html = '';\r\n        sortedIssues.forEach(issue => {\r\n            const groupClass = issue.type === 'warning' ? 'warning-group' : '';\r\n            const valuesArray = Array.from(issue.values);\r\n\r\n            // Determine action buttons based on issue type\r\n            let actionButtons = '';\r\n\r\n            // Missing required fields (warnings)\r\n            if (issue.field === 'Active' && issue.message.includes('Required field is missing')) {\r\n                actionButtons = `\r\n                    <button class=\"btn btn-sm btn-success issue-action-btn\" onclick=\"setActiveToTrue()\" title=\"Set all empty Active cells to TRUE\">\r\n                        <i class=\"bi bi-check-circle\"></i> Set to TRUE\r\n                    </button>\r\n                    <button class=\"btn btn-sm btn-danger issue-action-btn\" onclick=\"setActiveToFalse()\" title=\"Set all empty Active cells to FALSE\">\r\n                        <i class=\"bi bi-x-circle\"></i> Set to FALSE\r\n                    </button>\r\n                `;\r\n            } else if (issue.field === 'PartTaxCode' && issue.message.includes('Required field is missing')) {\r\n                actionButtons = `\r\n                    <button class=\"issue-action-btn fix\" onclick=\"fillPartTaxCode()\" title=\"Fill in tax codes from dropdown\">\r\n                        \uD83D\uDCCB Select Tax Code\r\n                    </button>\r\n                `;\r\n            } else if (issue.field === 'PartTypeID' && issue.message.includes('Required field is missing')) {\r\n                actionButtons = `\r\n                    <button class=\"issue-action-btn fix\" onclick=\"fillPartTypeID()\" title=\"Fill in part type from dropdown\">\r\n                        \uD83D\uDCCB Select Part Type\r\n                    </button>\r\n                `;\r\n            } else if (issue.field === 'UOM' && issue.message.includes('Required field is missing')) {\r\n                actionButtons = `\r\n                    <button class=\"issue-action-btn fix\" onclick=\"fillUOM()\" title=\"Fill in UOM from dropdown\">\r\n                        \uD83D\uDCCB Select UOM\r\n                    </button>\r\n                `;\r\n            }\r\n            // Validation errors\r\n            else if (issue.message.includes('UOM') && issue.message.includes('does not exist')) {\r\n                const uomValues = JSON.stringify(Array.from(issue.values));\r\n                actionButtons = `\r\n                    <button class=\"issue-action-btn create\" onclick='createUOM(${uomValues})' title=\"Create these UOM(s) in Fishbowl\">\r\n                        ➕ Create UOM\r\n                    </button>\r\n                    <button class=\"issue-action-btn map\" onclick=\"mapUOM()\" title=\"Map to existing UOM\">\r\n                        \uD83D\uDD17 Map to Existing\r\n                    </button>\r\n                `;\r\n            } else if (issue.message.includes('Vendor') && issue.message.includes('does not exist')) {\r\n                actionButtons = `\r\n                    <button class=\"issue-action-btn create\" onclick=\"createVendor()\" title=\"Create missing vendor(s) in Fishbowl\">\r\n                        ➕ Create Vendor\r\n                    </button>\r\n                    <button class=\"issue-action-btn map\" onclick=\"mapVendor()\" title=\"Map to existing vendor\">\r\n                        \uD83D\uDD17 Map to Existing\r\n                    </button>\r\n                `;\r\n            } else if (issue.message.includes('Tax code') && issue.message.includes('does not exist')) {\r\n                actionButtons = `\r\n                    <button class=\"issue-action-btn map\" onclick=\"mapTaxCode()\" title=\"Map to existing tax code\">\r\n                        \uD83D\uDD17 Map to Existing\r\n                    </button>\r\n                `;\r\n            } else if (issue.message.includes('Custom field') && issue.message.includes('does not exist')) {\r\n                actionButtons = `\r\n                    <button class=\"issue-action-btn create\" onclick=\"createCustomField()\" title=\"Create missing custom field in Fishbowl\">\r\n                        ➕ Create Custom Field\r\n                    </button>\r\n                `;\r\n            } else if (issue.message.includes('Invalid value') || issue.message.includes('not a valid')) {\r\n                actionButtons = `\r\n                    <button class=\"issue-action-btn fix\" onclick=\"fixValues()\" title=\"Fix invalid values\">\r\n                        \uD83D\uDD27 Fix Values\r\n                    </button>\r\n                `;\r\n            } else if (issue.message.includes('conversion') && issue.message.includes('may not exist')) {\r\n                actionButtons = `\r\n                    <button class=\"issue-action-btn create\" onclick=\"createUOMConversion()\" title=\"Create UOM conversion in Fishbowl\">\r\n                        ➕ Create Conversion\r\n                    </button>\r\n                `;\r\n            }\r\n\r\n            html += `\r\n                <div class=\"issue-group ${groupClass}\">\r\n                    <div class=\"issue-group-header\">\r\n                        <div>\r\n                            <span class=\"issue-group-title\">${issue.field}: ${issue.message}</span>\r\n                            <span class=\"issue-count\">${issue.rowCount} row${issue.rowCount > 1 ? 's' : ''}</span>\r\n                        </div>\r\n                        ${actionButtons ? `<div class=\"issue-actions\">${actionButtons}</div>` : ''}\r\n                    </div>\r\n                    ${valuesArray.length > 0 ? `\r\n                        <div class=\"issue-items\">\r\n                            ${valuesArray.slice(0, 10).map(v => `<span class=\"issue-value\">${escapeHtml(v)}</span>`).join('')}\r\n                            ${valuesArray.length > 10 ? `<span class=\"issue-value\">+${valuesArray.length - 10} more</span>` : ''}\r\n                        </div>\r\n                    ` : ''}\r\n                    ${issue.suggestion ? `<div style=\"color: var(--fb-success); font-size: 12px; margin-top: 5px;\">\uD83D\uDCA1 ${issue.suggestion}</div>` : ''}\r\n                </div>\r\n            `;\r\n        });\r\n\r\n        content.innerHTML = html;\r\n    }\r\n\r\n    // Action button handlers - Fill missing required fields\r\n\r\n    function setActiveToTrue() {\r\n        if (csvData.length === 0) {\r\n            showToast('No Data', 'No data loaded.', 'warning');\r\n            return;\r\n        }\r\n\r\n        let count = 0;\r\n        csvData.forEach(row => {\r\n            if (!row['Active'] || row['Active'].trim() === '') {\r\n                row['Active'] = 'TRUE';\r\n                count++;\r\n            }\r\n        });\r\n\r\n        if (count > 0) {\r\n            showToast('Success', `Set ${count} empty Active cells to TRUE`, 'success');\r\n            revalidateData();\r\n        } else {\r\n            showToast('Info', 'No empty Active cells found.', 'info');\r\n        }\r\n    }\r\n\r\n    function setActiveToFalse() {\r\n        if (csvData.length === 0) {\r\n            showToast('No Data', 'No data loaded.', 'warning');\r\n            return;\r\n        }\r\n\r\n        let count = 0;\r\n        csvData.forEach(row => {\r\n            if (!row['Active'] || row['Active'].trim() === '') {\r\n                row['Active'] = 'FALSE';\r\n                count++;\r\n            }\r\n        });\r\n\r\n        if (count > 0) {\r\n            showToast('Success', `Set ${count} empty Active cells to FALSE`, 'success');\r\n            revalidateData();\r\n        } else {\r\n            showToast('Info', 'No empty Active cells found.', 'info');\r\n        }\r\n    }\r\n\r\n    function fillPartTaxCode() {\r\n        if (csvData.length === 0) {\r\n            showToast('No Data', 'No data loaded.', 'warning');\r\n            return;\r\n        }\r\n\r\n        if (fishbowlData.taxCodes.length === 0) {\r\n            showToast('Missing Data', 'No tax codes loaded from Fishbowl. Please check your database connection.', 'warning');\r\n            return;\r\n        }\r\n\r\n        // Count empty cells\r\n        const emptyCount = csvData.filter(row => !row['PartTaxCode'] || row['PartTaxCode'].trim() === '').length;\r\n        if (emptyCount === 0) {\r\n            showToast('Info', 'No empty PartTaxCode cells found.', 'info');\r\n            return;\r\n        }\r\n\r\n        // Build dropdown options (show name, but use code)\r\n        const options = fishbowlData.taxCodes\r\n            .map(tc => `<option value=\"${escapeHtml(tc.code)}\">${escapeHtml(tc.name)} (${escapeHtml(tc.code)})</option>`)\r\n            .join('');\r\n\r\n        showModal(\r\n            'Fill PartTaxCode',\r\n            `\r\n                <p>Select a tax code to fill ${emptyCount} empty PartTaxCode cells:</p>\r\n                <select id=\"modalSelect\" style=\"width: 100%; padding: 8px; font-size: 14px; margin-top: 10px;\">\r\n                    <option value=\"\">-- Select Tax Code --</option>\r\n                    ${options}\r\n                </select>\r\n            `,\r\n            function() {\r\n                const selectedCode = document.getElementById('modalSelect').value;\r\n                if (!selectedCode) {\r\n                    showToast('Selection Required', 'Please select a tax code.', 'warning');\r\n                    return false;\r\n                }\r\n\r\n                let count = 0;\r\n                csvData.forEach(row => {\r\n                    if (!row['PartTaxCode'] || row['PartTaxCode'].trim() === '') {\r\n                        row['PartTaxCode'] = selectedCode;\r\n                        count++;\r\n                    }\r\n                });\r\n\r\n                showToast('Success', `Filled ${count} empty PartTaxCode cells with \"${selectedCode}\"`, 'success', 'Success');\r\n                revalidateData();\r\n                return true;\r\n            }\r\n        );\r\n    }\r\n\r\n    function fillPartTypeID() {\r\n        if (csvData.length === 0) {\r\n            showToast('No Data', 'No data loaded.', 'warning');\r\n            return;\r\n        }\r\n\r\n        if (fishbowlData.partTypes.length === 0) {\r\n            showToast('Missing Data', 'No part types loaded from Fishbowl. Please check your database connection.', 'warning');\r\n            return;\r\n        }\r\n\r\n        // Count empty cells\r\n        const emptyCount = csvData.filter(row => !row['PartTypeID'] || row['PartTypeID'].trim() === '').length;\r\n        if (emptyCount === 0) {\r\n            showToast('Info', 'No empty PartTypeID cells found.', 'info');\r\n            return;\r\n        }\r\n\r\n        // Build dropdown options (show name, but use id)\r\n        const options = fishbowlData.partTypes\r\n            .map(pt => `<option value=\"${pt.id}\">${escapeHtml(pt.name)} (${pt.id})</option>`)\r\n            .join('');\r\n\r\n        showModal(\r\n            'Fill PartTypeID',\r\n            `\r\n                <p>Select a part type to fill ${emptyCount} empty PartTypeID cells:</p>\r\n                <select id=\"modalSelect\" style=\"width: 100%; padding: 8px; font-size: 14px; margin-top: 10px;\">\r\n                    <option value=\"\">-- Select Part Type --</option>\r\n                    ${options}\r\n                </select>\r\n            `,\r\n            function() {\r\n                const selectedId = document.getElementById('modalSelect').value;\r\n                if (!selectedId) {\r\n                    showToast('Selection Required', 'Please select a part type.', 'warning');\r\n                    return false;\r\n                }\r\n\r\n                let count = 0;\r\n                csvData.forEach(row => {\r\n                    if (!row['PartTypeID'] || row['PartTypeID'].trim() === '') {\r\n                        row['PartTypeID'] = selectedId;\r\n                        count++;\r\n                    }\r\n                });\r\n\r\n                showToast('Success', `Filled ${count} empty PartTypeID cells with \"${selectedId}\"`, 'success', 'Success');\r\n                revalidateData();\r\n                return true;\r\n            }\r\n        );\r\n    }\r\n\r\n    function fillUOM() {\r\n        if (csvData.length === 0) {\r\n            showToast('No Data', 'No data loaded.', 'warning');\r\n            return;\r\n        }\r\n\r\n        if (fishbowlData.uoms.length === 0) {\r\n            showToast('Missing Data', 'No UOMs loaded from Fishbowl. Please check your database connection.', 'warning');\r\n            return;\r\n        }\r\n\r\n        // Count empty cells\r\n        const emptyCount = csvData.filter(row => !row['UOM'] || row['UOM'].trim() === '').length;\r\n        if (emptyCount === 0) {\r\n            showToast('Info', 'No empty UOM cells found.', 'info');\r\n            return;\r\n        }\r\n\r\n        // Build dropdown options (use UOM code/name)\r\n        const options = fishbowlData.uoms\r\n            .map(uom => `<option value=\"${escapeHtml(uom)}\">${escapeHtml(uom)}</option>`)\r\n            .join('');\r\n\r\n        showModal(\r\n            'Fill UOM',\r\n            `\r\n                <p>Select a UOM to fill ${emptyCount} empty UOM cells:</p>\r\n                <select id=\"modalSelect\" style=\"width: 100%; padding: 8px; font-size: 14px; margin-top: 10px;\">\r\n                    <option value=\"\">-- Select UOM --</option>\r\n                    ${options}\r\n                </select>\r\n            `,\r\n            function() {\r\n                const selectedUom = document.getElementById('modalSelect').value;\r\n                if (!selectedUom) {\r\n                    showToast('Selection Required', 'Please select a UOM.', 'warning');\r\n                    return false;\r\n                }\r\n\r\n                let count = 0;\r\n                csvData.forEach(row => {\r\n                    if (!row['UOM'] || row['UOM'].trim() === '') {\r\n                        row['UOM'] = selectedUom;\r\n                        count++;\r\n                    }\r\n                });\r\n\r\n                showToast('Success', `Filled ${count} empty UOM cells with \"${selectedUom}\"`, 'success', 'Success');\r\n                revalidateData();\r\n                return true;\r\n            }\r\n        );\r\n    }\r\n\r\n    // Bootstrap Modal Helper\r\n    function showModal(title, content, onConfirm, options = {}) {\r\n        const modalId = 'dynamicModal' + Date.now();\r\n        const size = options.size || ''; // '', 'modal-lg', 'modal-xl'\r\n        const confirmText = options.confirmText || 'Apply';\r\n        const cancelText = options.cancelText || 'Cancel';\r\n        const confirmClass = options.confirmClass || 'btn-primary';\r\n\r\n        // Create Bootstrap modal HTML\r\n        const modalHtml = `\r\n            <div class=\"modal fade\" id=\"${modalId}\" tabindex=\"-1\" aria-hidden=\"true\">\r\n                <div class=\"modal-dialog ${size}\">\r\n                    <div class=\"modal-content\">\r\n                        <div class=\"modal-header\">\r\n                            <h5 class=\"modal-title\">${title}</h5>\r\n                            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\r\n                        </div>\r\n                        <div class=\"modal-body\">\r\n                            ${content}\r\n                        </div>\r\n                        <div class=\"modal-footer\">\r\n                            <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">${cancelText}</button>\r\n                            <button type=\"button\" class=\"btn ${confirmClass}\" id=\"${modalId}Confirm\">${confirmText}</button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        // Add modal to DOM\r\n        const modalContainer = document.createElement('div');\r\n        modalContainer.innerHTML = modalHtml;\r\n        document.body.appendChild(modalContainer.firstElementChild);\r\n\r\n        // Initialize Bootstrap modal\r\n        const modalElement = document.getElementById(modalId);\r\n        const bsModal = new bootstrap.Modal(modalElement);\r\n\r\n        // Handle confirm button\r\n        document.getElementById(modalId + 'Confirm').onclick = function() {\r\n            const shouldClose = onConfirm ? onConfirm() : true;\r\n            if (shouldClose !== false) {\r\n                bsModal.hide();\r\n            }\r\n        };\r\n\r\n        // Clean up after modal is hidden\r\n        modalElement.addEventListener('hidden.bs.modal', function() {\r\n            document.body.removeChild(modalElement);\r\n        });\r\n\r\n        // Show modal\r\n        bsModal.show();\r\n\r\n        return bsModal;\r\n    }\r\n\r\n    // Create/map missing data\r\n    function createUOM(specificUOMs) {\r\n        let missingList;\r\n\r\n        // If specific UOMs are provided (from button click), use only those\r\n        if (specificUOMs && Array.isArray(specificUOMs) && specificUOMs.length > 0) {\r\n            missingList = specificUOMs;\r\n            console.log('Creating specific UOMs:', missingList);\r\n        } else {\r\n            // Otherwise, extract all missing UOMs from consolidated issues\r\n            const missingUOMs = new Set();\r\n\r\n            // Look for UOM errors in consolidated issues\r\n            Object.keys(consolidatedIssues).forEach(key => {\r\n                const issue = consolidatedIssues[key];\r\n                if (issue.field === 'UOM' && issue.message.includes('does not exist')) {\r\n                    // Add all the invalid UOM values\r\n                    issue.values.forEach(val => missingUOMs.add(val));\r\n                }\r\n            });\r\n\r\n            console.log('Missing UOMs found:', Array.from(missingUOMs));\r\n\r\n            if (missingUOMs.size === 0) {\r\n                showToast('Info', 'No missing UOMs found. All UOMs in your dataset already exist in Fishbowl.', 'info');\r\n                return;\r\n            }\r\n\r\n            missingList = Array.from(missingUOMs);\r\n        }\r\n\r\n        // Build Bootstrap modal form\r\n        let formHtml = `\r\n            <div class=\"alert alert-warning mb-3\">\r\n                <i class=\"bi bi-exclamation-triangle-fill\"></i> Each UOM requires a Name, Abbreviation, and Type.\r\n            </div>\r\n            <div style=\"max-height: 500px; overflow-y: auto;\">\r\n        `;\r\n\r\n        missingList.forEach((uomName, idx) => {\r\n            formHtml += `\r\n                <div class=\"card mb-3\">\r\n                    <div class=\"card-header bg-primary text-white\">\r\n                        <h6 class=\"mb-0\"><i class=\"bi bi-tag\"></i> UOM #${idx + 1}</h6>\r\n                    </div>\r\n                    <div class=\"card-body\">\r\n                        <div class=\"mb-3\">\r\n                            <label class=\"form-label fw-bold\">\r\n                                Name <span class=\"text-danger\">*</span>\r\n                            </label>\r\n                            <input type=\"text\" class=\"form-control uom-name\" data-index=\"${idx}\"\r\n                                value=\"${escapeHtml(uomName)}\" maxlength=\"30\" required />\r\n                            <small class=\"form-text text-muted\">Max 30 characters</small>\r\n                        </div>\r\n\r\n                        <div class=\"mb-3\">\r\n                            <label class=\"form-label fw-bold\">\r\n                                Abbreviation <span class=\"text-danger\">*</span>\r\n                            </label>\r\n                            <input type=\"text\" class=\"form-control uom-abbrev\" data-index=\"${idx}\"\r\n                                value=\"${escapeHtml(uomName.substring(0, 4))}\" maxlength=\"10\" required />\r\n                            <small class=\"form-text text-muted\">Max 10 characters (4 recommended for reports)</small>\r\n                        </div>\r\n\r\n                        <div class=\"mb-3\">\r\n                            <label class=\"form-label fw-bold\">\r\n                                Type <span class=\"text-danger\">*</span>\r\n                            </label>\r\n                            <select class=\"form-select uom-type\" data-index=\"${idx}\" required>\r\n                                <option value=\"\">-- Select Type --</option>\r\n                                <option value=\"1\" selected>Count</option>\r\n                                <option value=\"2\">Weight</option>\r\n                                <option value=\"3\">Length</option>\r\n                                <option value=\"4\">Area</option>\r\n                                <option value=\"5\">Volume</option>\r\n                                <option value=\"6\">Time</option>\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            `;\r\n        });\r\n\r\n        formHtml += '</div>';\r\n\r\n        showModal('Create UOMs', formHtml, function() {\r\n            // Validate and collect data\r\n            const uomsToCreate = [];\r\n            let hasErrors = false;\r\n\r\n            for (let i = 0; i < missingList.length; i++) {\r\n                const nameInput = document.querySelector(`.uom-name[data-index=\"${i}\"]`);\r\n                const abbrevInput = document.querySelector(`.uom-abbrev[data-index=\"${i}\"]`);\r\n                const typeSelect = document.querySelector(`.uom-type[data-index=\"${i}\"]`);\r\n\r\n                const name = nameInput.value.trim();\r\n                const abbrev = abbrevInput.value.trim();\r\n                const typeID = typeSelect.value;\r\n\r\n                // Validate\r\n                if (!name) {\r\n                    showToast('Validation Error', `UOM #${i + 1}: Name is required`, 'warning', 'Validation Error');\r\n                    nameInput.focus();\r\n                    hasErrors = true;\r\n                    return false;\r\n                }\r\n\r\n                if (!abbrev) {\r\n                    showToast('Validation Error', `UOM #${i + 1}: Abbreviation is required`, 'warning', 'Validation Error');\r\n                    abbrevInput.focus();\r\n                    hasErrors = true;\r\n                    return false;\r\n                }\r\n\r\n                if (!typeID) {\r\n                    showToast('Validation Error', `UOM #${i + 1}: Type is required`, 'warning', 'Validation Error');\r\n                    typeSelect.focus();\r\n                    hasErrors = true;\r\n                    return false;\r\n                }\r\n\r\n                uomsToCreate.push({\r\n                    Name: name,\r\n                    Abbrev: abbrev,\r\n                    UomTypeID: typeID,\r\n                    Active: 'true',\r\n                    ReadOnly: 'false',\r\n                    Details: ''\r\n                });\r\n            }\r\n\r\n            if (hasErrors) return false;\r\n\r\n            // Confirm\r\n            if (!(await showConfirm(`Create ${uomsToCreate.length} UOM(s) in Fishbowl?`, \\'Create UOMs\\'))) {\r\n                return false;\r\n            }\r\n\r\n            // Build CSV rows (data only, no header row for API)\r\n            const headers = ['Name', 'Abbrev', 'UomTypeID', 'Active', 'ReadOnly', 'Details'];\r\n            let rows = [];\r\n\r\n            // Data rows only (API doesn't expect header row)\r\n            uomsToCreate.forEach(uom => {\r\n                const values = headers.map(h => {\r\n                    const value = uom[h] || '';\r\n                    return '\"' + String(value).replace(/\"/g, '\"\"') + '\"';\r\n                });\r\n                rows.push(values.join(','));\r\n            });\r\n\r\n            // Build API request\r\n            const payload = {\r\n                \"ImportRq\": {\r\n                    \"Type\": \"ImportUnitsOfMeasure\",\r\n                    \"Rows\": {\r\n                        \"Row\": rows\r\n                    }\r\n                }\r\n            };\r\n\r\n            console.log('Create UOM Request - Type:', payload.ImportRq.Type);\r\n            console.log('Create UOM Request - Row Count:', rows.length);\r\n            console.log('Create UOM Request - First 3 rows:', rows.slice(0, 3));\r\n            console.log('Create UOM Request - Full Payload:', JSON.stringify(payload, null, 2));\r\n\r\n            showLoading('Creating UOMs in Fishbowl...');\r\n\r\n            try {\r\n                const response = runApiRequest('ImportRq', JSON.stringify(payload));\r\n                console.log('Create UOM Response (raw):', response);\r\n                console.log('Create UOM Response (type):', typeof response);\r\n                hideLoading();\r\n\r\n                if (!response) {\r\n                    showToast('API Error', 'Create UOM failed: No response from API', 'danger');\r\n                    return false;\r\n                }\r\n\r\n                const result = typeof response === 'string' ? JSON.parse(response) : response;\r\n                console.log('Create UOM Response (parsed):', result);\r\n\r\n                if (result && result.ImportRs && result.ImportRs.statusCode === 1000) {\r\n                    showToast('UOM Created', `Successfully created ${uomsToCreate.length} UOM(s) in Fishbowl! Revalidating data...`, 'success');\r\n\r\n                    // Reload UOMs and revalidate to clear errors\r\n                    loadFishbowlReferenceData();\r\n                    revalidateData();\r\n\r\n                    return true;\r\n                } else {\r\n                    let errorMsg = 'Create UOM failed';\r\n                    if (result && result.ImportRs) {\r\n                        errorMsg += `\\nStatus Code: ${result.ImportRs.statusCode}`;\r\n                        if (result.ImportRs.statusMessage) {\r\n                            errorMsg += `\\nMessage: ${result.ImportRs.statusMessage}`;\r\n                        }\r\n                    }\r\n                    console.error('Create UOM Error Details:', result);\r\n                    showToast('Error', errorMsg, 'danger');\r\n                    return false;\r\n                }\r\n            } catch (error) {\r\n                hideLoading();\r\n                console.error('Error creating UOMs:', error);\r\n                showToast('Error', 'Error creating UOMs: ' + error.message, 'danger');\r\n                return false;\r\n            }\r\n        });\r\n    }\r\n\r\n    function mapUOM() {\r\n        if (csvData.length === 0) {\r\n            showToast('No Data', 'No data loaded.', 'warning');\r\n            return;\r\n        }\r\n\r\n        if (fishbowlData.uoms.length === 0) {\r\n            showToast('Missing Data', 'No UOMs loaded from Fishbowl. Please check your database connection.', 'warning');\r\n            return;\r\n        }\r\n\r\n        // Find all invalid UOMs\r\n        const invalidUoms = new Set();\r\n        validationResults.forEach(result => {\r\n            result.errors.forEach(error => {\r\n                if (error.field && (error.field === 'UOM' || error.field.includes('UOM')) &&\r\n                    error.message.includes('does not exist')) {\r\n                    const row = csvData[result.rowIndex];\r\n                    if (row[error.field]) {\r\n                        invalidUoms.add(row[error.field]);\r\n                    }\r\n                }\r\n            });\r\n        });\r\n\r\n        if (invalidUoms.size === 0) {\r\n            showToast('Info', 'No invalid UOMs found.', 'info');\r\n            return;\r\n        }\r\n\r\n        // Build Bootstrap mapping UI\r\n        const invalidList = Array.from(invalidUoms);\r\n        const uomOptions = fishbowlData.uoms\r\n            .map(uom => `<option value=\"${escapeHtml(uom)}\">${escapeHtml(uom)}</option>`)\r\n            .join('');\r\n\r\n        let mappingHtml = `\r\n            <div class=\"alert alert-info mb-3\">\r\n                <i class=\"bi bi-arrow-left-right\"></i> Map each invalid UOM to an existing one in Fishbowl.\r\n            </div>\r\n            <div style=\"max-height: 400px; overflow-y: auto;\">\r\n        `;\r\n\r\n        invalidList.forEach(invalid => {\r\n            mappingHtml += `\r\n                <div class=\"card mb-2\">\r\n                    <div class=\"card-body py-2\">\r\n                        <div class=\"row align-items-center\">\r\n                            <div class=\"col-4\">\r\n                                <span class=\"badge bg-danger\">${escapeHtml(invalid)}</span>\r\n                            </div>\r\n                            <div class=\"col-1 text-center\">\r\n                                <i class=\"bi bi-arrow-right\"></i>\r\n                            </div>\r\n                            <div class=\"col-7\">\r\n                                <select class=\"form-select form-select-sm uom-mapping\" data-invalid=\"${escapeHtml(invalid)}\" required>\r\n                                    <option value=\"\">-- Select UOM --</option>\r\n                                    ${uomOptions}\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            `;\r\n        });\r\n        mappingHtml += '</div>';\r\n\r\n        showModal(\r\n            'Map Invalid UOMs',\r\n            mappingHtml,\r\n            function() {\r\n                const mappings = {};\r\n                const selects = document.querySelectorAll('.uom-mapping');\r\n\r\n                selects.forEach(select => {\r\n                    const invalid = select.getAttribute('data-invalid');\r\n                    const valid = select.value;\r\n                    if (valid) {\r\n                        mappings[invalid] = valid;\r\n                    }\r\n                });\r\n\r\n                if (Object.keys(mappings).length === 0) {\r\n                    showToast('Selection Required', 'No mappings selected.', 'warning');\r\n                    return false;\r\n                }\r\n\r\n                // Apply mappings\r\n                let count = 0;\r\n                csvData.forEach(row => {\r\n                    csvHeaders.forEach(header => {\r\n                        if ((header === 'UOM' || header.includes('UOM')) && row[header] && mappings[row[header]]) {\r\n                            row[header] = mappings[row[header]];\r\n                            count++;\r\n                        }\r\n                    });\r\n                });\r\n\r\n                showToast('Success', `Mapped ${count} UOM values`, 'success', 'Success');\r\n                revalidateData();\r\n                return true;\r\n            }\r\n        );\r\n    }\r\n\r\n    function createVendor() {\r\n        showToast('Info', 'Create Vendor functionality will be implemented here', 'info');\r\n    }\r\n\r\n    function mapVendor() {\r\n        if (csvData.length === 0) {\r\n            showToast('No Data', 'No data loaded.', 'warning');\r\n            return;\r\n        }\r\n\r\n        if (fishbowlData.vendors.length === 0) {\r\n            showToast('Missing Data', 'No vendors loaded from Fishbowl. Please check your database connection.', 'warning');\r\n            return;\r\n        }\r\n\r\n        // Find all invalid vendors\r\n        const invalidVendors = new Set();\r\n        validationResults.forEach(result => {\r\n            result.errors.forEach(error => {\r\n                if (error.field === 'Vendor' && error.message.includes('does not exist')) {\r\n                    const row = csvData[result.rowIndex];\r\n                    if (row[error.field]) {\r\n                        invalidVendors.add(row[error.field]);\r\n                    }\r\n                }\r\n            });\r\n        });\r\n\r\n        if (invalidVendors.size === 0) {\r\n            showToast('Info', 'No invalid vendors found.', 'info');\r\n            return;\r\n        }\r\n\r\n        // Build Bootstrap mapping UI\r\n        const invalidList = Array.from(invalidVendors);\r\n        const vendorOptions = fishbowlData.vendors\r\n            .map(vendor => `<option value=\"${escapeHtml(vendor)}\">${escapeHtml(vendor)}</option>`)\r\n            .join('');\r\n\r\n        let mappingHtml = `\r\n            <div class=\"alert alert-info mb-3\">\r\n                <i class=\"bi bi-arrow-left-right\"></i> Map each invalid vendor to an existing one in Fishbowl.\r\n            </div>\r\n            <div style=\"max-height: 400px; overflow-y: auto;\">\r\n        `;\r\n\r\n        invalidList.forEach(invalid => {\r\n            mappingHtml += `\r\n                <div class=\"card mb-2\">\r\n                    <div class=\"card-body py-2\">\r\n                        <div class=\"row align-items-center\">\r\n                            <div class=\"col-4\">\r\n                                <span class=\"badge bg-danger\">${escapeHtml(invalid)}</span>\r\n                            </div>\r\n                            <div class=\"col-1 text-center\">\r\n                                <i class=\"bi bi-arrow-right\"></i>\r\n                            </div>\r\n                            <div class=\"col-7\">\r\n                                <select class=\"form-select form-select-sm vendor-mapping\" data-invalid=\"${escapeHtml(invalid)}\" required>\r\n                                    <option value=\"\">-- Select Vendor --</option>\r\n                                    ${vendorOptions}\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            `;\r\n        });\r\n        mappingHtml += '</div>';\r\n\r\n        showModal(\r\n            'Map Invalid Vendors',\r\n            mappingHtml,\r\n            function() {\r\n                const mappings = {};\r\n                const selects = document.querySelectorAll('.vendor-mapping');\r\n\r\n                selects.forEach(select => {\r\n                    const invalid = select.getAttribute('data-invalid');\r\n                    const valid = select.value;\r\n                    if (valid) {\r\n                        mappings[invalid] = valid;\r\n                    }\r\n                });\r\n\r\n                if (Object.keys(mappings).length === 0) {\r\n                    showToast('Selection Required', 'No mappings selected.', 'warning');\r\n                    return false;\r\n                }\r\n\r\n                // Apply mappings\r\n                let count = 0;\r\n                csvData.forEach(row => {\r\n                    if (row['Vendor'] && mappings[row['Vendor']]) {\r\n                        row['Vendor'] = mappings[row['Vendor']];\r\n                        count++;\r\n                    }\r\n                });\r\n\r\n                showToast('Success', `Mapped ${count} vendor values`, 'success', 'Success');\r\n                revalidateData();\r\n                return true;\r\n            }\r\n        );\r\n    }\r\n\r\n    function mapTaxCode() {\r\n        if (csvData.length === 0) {\r\n            showToast('No Data', 'No data loaded.', 'warning');\r\n            return;\r\n        }\r\n\r\n        if (fishbowlData.taxCodes.length === 0) {\r\n            showToast('Missing Data', 'No tax codes loaded from Fishbowl. Please check your database connection.', 'warning');\r\n            return;\r\n        }\r\n\r\n        // Find all invalid tax codes\r\n        const invalidTaxCodes = new Set();\r\n        validationResults.forEach(result => {\r\n            result.errors.forEach(error => {\r\n                if (error.field === 'PartTaxCode' && error.message.includes('does not exist')) {\r\n                    const row = csvData[result.rowIndex];\r\n                    if (row[error.field]) {\r\n                        invalidTaxCodes.add(row[error.field]);\r\n                    }\r\n                }\r\n            });\r\n        });\r\n\r\n        if (invalidTaxCodes.size === 0) {\r\n            showToast('Info', 'No invalid tax codes found.', 'info');\r\n            return;\r\n        }\r\n\r\n        // Build mapping UI\r\n        const invalidList = Array.from(invalidTaxCodes);\r\n        const taxOptions = fishbowlData.taxCodes\r\n            .map(tc => `<option value=\"${escapeHtml(tc.code)}\">${escapeHtml(tc.name)} (${escapeHtml(tc.code)})</option>`)\r\n            .join('');\r\n\r\n        let mappingHtml = '<div style=\"max-height: 400px; overflow-y: auto;\">';\r\n        mappingHtml += '<p>Map invalid tax codes to existing ones:</p>';\r\n        invalidList.forEach(invalid => {\r\n            mappingHtml += `\r\n                <div style=\"margin: 10px 0; display: flex; align-items: center; gap: 10px;\">\r\n                    <strong style=\"width: 150px;\">${escapeHtml(invalid)}</strong>\r\n                    <span>→</span>\r\n                    <select class=\"tax-mapping\" data-invalid=\"${escapeHtml(invalid)}\" style=\"flex: 1; padding: 6px;\">\r\n                        <option value=\"\">-- Select Tax Code --</option>\r\n                        ${taxOptions}\r\n                    </select>\r\n                </div>\r\n            `;\r\n        });\r\n        mappingHtml += '</div>';\r\n\r\n        showModal(\r\n            'Map Invalid Tax Codes',\r\n            mappingHtml,\r\n            function() {\r\n                const mappings = {};\r\n                const selects = document.querySelectorAll('.tax-mapping');\r\n\r\n                selects.forEach(select => {\r\n                    const invalid = select.getAttribute('data-invalid');\r\n                    const valid = select.value;\r\n                    if (valid) {\r\n                        mappings[invalid] = valid;\r\n                    }\r\n                });\r\n\r\n                if (Object.keys(mappings).length === 0) {\r\n                    showToast('Selection Required', 'No mappings selected.', 'warning');\r\n                    return false;\r\n                }\r\n\r\n                // Apply mappings\r\n                let count = 0;\r\n                csvData.forEach(row => {\r\n                    if (row['PartTaxCode'] && mappings[row['PartTaxCode']]) {\r\n                        row['PartTaxCode'] = mappings[row['PartTaxCode']];\r\n                        count++;\r\n                    }\r\n                });\r\n\r\n                showToast('Success', `Mapped ${count} tax code values`, 'success', 'Success');\r\n                revalidateData();\r\n                return true;\r\n            }\r\n        );\r\n    }\r\n\r\n    function createCustomField() {\r\n        showToast('Info', 'Create Custom Field functionality will be implemented here', 'info');\r\n    }\r\n\r\n    function fixValues() {\r\n        showToast('Info', 'Fix Values functionality will be implemented here', 'info');\r\n    }\r\n\r\n    async function createUOMConversion() {\r\n        // Debug logging\r\n        console.log('createUOMConversion called');\r\n        console.log('fishbowlData:', fishbowlData);\r\n        console.log('fishbowlData.uomDetails:', fishbowlData.uomDetails);\r\n        console.log('fishbowlData.uomDetails type:', typeof fishbowlData.uomDetails);\r\n        console.log('fishbowlData.uomDetails.length:', fishbowlData.uomDetails?.length);\r\n        console.log('fishbowlData.uoms:', fishbowlData.uoms);\r\n        console.log('fishbowlData.uoms.length:', fishbowlData.uoms?.length);\r\n\r\n        if (!fishbowlData.uomDetails || fishbowlData.uomDetails.length === 0) {\r\n            showToast('Missing Data', 'No UOMs loaded. Please ensure UOMs are loaded from Fishbowl.', 'warning');\r\n            return;\r\n        }\r\n\r\n        // Build UOM type name mapping\r\n        const uomTypeNames = {\r\n            1: 'Count',\r\n            2: 'Weight',\r\n            3: 'Length',\r\n            4: 'Area',\r\n            5: 'Volume',\r\n            6: 'Time'\r\n        };\r\n\r\n        // Build Bootstrap modal form\r\n        let formHtml = `\r\n            <div class=\"alert alert-info mb-3\">\r\n                <i class=\"bi bi-info-circle-fill\"></i> UOMs must be of the same type to convert between them.\r\n            </div>\r\n            <div style=\"max-height: 500px; overflow-y: auto;\">\r\n                <div class=\"card\">\r\n                    <div class=\"card-body\">\r\n                        <div class=\"mb-3\">\r\n                            <label for=\"fromUOM\" class=\"form-label fw-bold\">\r\n                                From UOM <span class=\"text-danger\">*</span>\r\n                            </label>\r\n                            <select id=\"fromUOM\" class=\"form-select\" onchange=\"filterToUOM()\" required>\r\n                                <option value=\"\">-- Select From UOM --</option>\r\n                                ${fishbowlData.uomDetails.map(uom =>\r\n                                    `<option value=\"${escapeHtml(uom.code)}\" data-type=\"${uom.uomtype}\">${escapeHtml(uom.code)} (${uomTypeNames[uom.uomtype]})</option>`\r\n                                ).join('')}\r\n                            </select>\r\n                        </div>\r\n\r\n                        <div class=\"mb-3\">\r\n                            <label for=\"toUOM\" class=\"form-label fw-bold\">\r\n                                To UOM <span class=\"text-danger\">*</span>\r\n                            </label>\r\n                            <select id=\"toUOM\" class=\"form-select\" onchange=\"updateToUOMLabel()\" required>\r\n                                <option value=\"\">-- Select To UOM --</option>\r\n                            </select>\r\n                            <small class=\"form-text text-muted\" id=\"toUOMHint\">Select From UOM first</small>\r\n                        </div>\r\n\r\n                        <div class=\"card bg-light mt-4\">\r\n                            <div class=\"card-header\">\r\n                                <strong><i class=\"bi bi-calculator\"></i> Conversion Formula</strong>\r\n                            </div>\r\n                            <div class=\"card-body\">\r\n                                <div class=\"d-flex align-items-center gap-2 mb-3\">\r\n                                    <span class=\"badge bg-secondary\">1</span>\r\n                                    <span>×</span>\r\n                                    <span id=\"toUOMLabel\" class=\"badge bg-primary fs-6\">___</span>\r\n                                    <span>=</span>\r\n                                    <input type=\"number\" id=\"conversionValue\" class=\"form-control form-control-lg text-center fw-bold\"\r\n                                        placeholder=\"1000\" step=\"any\" min=\"0\" style=\"max-width: 150px;\" required />\r\n                                    <span id=\"fromUOMLabel\" class=\"badge bg-primary fs-6\">___</span>\r\n                                </div>\r\n                                <div class=\"alert alert-secondary mb-0 py-2\">\r\n                                    <small><i class=\"bi bi-lightbulb\"></i> Example: 1 × Box = 1000 Each</small>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        // Add filter function to window scope\r\n        window.filterToUOM = function() {\r\n            const fromSelect = document.getElementById('fromUOM');\r\n            const toSelect = document.getElementById('toUOM');\r\n            const fromUOMLabel = document.getElementById('fromUOMLabel');\r\n            const selectedOption = fromSelect.options[fromSelect.selectedIndex];\r\n\r\n            if (!selectedOption || !selectedOption.value) {\r\n                toSelect.innerHTML = '<option value=\"\">-- Select To UOM --</option>';\r\n                fromUOMLabel.textContent = '___';\r\n                return;\r\n            }\r\n\r\n            const selectedType = selectedOption.dataset.type;\r\n            const fromUOMCode = selectedOption.value;\r\n            fromUOMLabel.textContent = fromUOMCode;\r\n\r\n            // Filter To UOM by same type, excluding the From UOM\r\n            const filteredUOMs = fishbowlData.uomDetails.filter(uom =>\r\n                uom.uomtype == selectedType && uom.code !== fromUOMCode\r\n            );\r\n\r\n            toSelect.innerHTML = '<option value=\"\">-- Select To UOM --</option>' +\r\n                filteredUOMs.map(uom =>\r\n                    `<option value=\"${escapeHtml(uom.code)}\">${escapeHtml(uom.code)}</option>`\r\n                ).join('');\r\n\r\n            document.getElementById('toUOMHint').textContent =\r\n                filteredUOMs.length > 0 ? `${filteredUOMs.length} ${uomTypeNames[selectedType]} UOMs available` : 'No matching UOMs';\r\n        };\r\n\r\n        // Add change handler for To UOM\r\n        window.updateToUOMLabel = function() {\r\n            const toSelect = document.getElementById('toUOM');\r\n            const toUOMLabel = document.getElementById('toUOMLabel');\r\n            toUOMLabel.textContent = toSelect.value || '___';\r\n        };\r\n\r\n        showModal('Create UOM Conversion', formHtml, function() {\r\n            // Validate\r\n            const fromUOM = document.getElementById('fromUOM').value;\r\n            const toUOM = document.getElementById('toUOM').value;\r\n            const conversionValue = parseFloat(document.getElementById('conversionValue').value);\r\n\r\n            if (!fromUOM) {\r\n                showToast('Selection Required', 'Please select From UOM', 'warning');\r\n                document.getElementById('fromUOM').focus();\r\n                return false;\r\n            }\r\n\r\n            if (!toUOM) {\r\n                showToast('Selection Required', 'Please select To UOM', 'warning');\r\n                document.getElementById('toUOM').focus();\r\n                return false;\r\n            }\r\n\r\n            if (!conversionValue || conversionValue <= 0) {\r\n                showToast('Validation Error', 'Please enter a valid conversion value (greater than 0)', 'warning');\r\n                document.getElementById('conversionValue').focus();\r\n                return false;\r\n            }\r\n\r\n            // Confirm\r\n            if (!(await showConfirm(`Create conversion: 1 ${toUOM} = ${conversionValue} ${fromUOM}?`, \\'Create UOM Conversion\\'))) {\r\n                return false;\r\n            }\r\n\r\n            // Build conversion data\r\n            // Factor = number of FromUOM units per one ToUOM unit (e.g., 1000 ea per 1 BX1000)\r\n            // Multiply = always 1 for standard conversions\r\n            const conversion = {\r\n                FromUOM: fromUOM,\r\n                ToUOM: toUOM,\r\n                Multiply: 1,\r\n                Factor: conversionValue,\r\n                Description: `1 ${toUOM} = ${conversionValue} ${fromUOM}`\r\n            };\r\n\r\n            // Query import headers to get the correct format\r\n            console.log('Querying import headers for ImportUnitOfMeasureConversions...');\r\n            const headerPayload = {\r\n                \"ImportHeaderRq\": {\r\n                    \"Type\": \"ImportUnitOfMeasureConversions\"\r\n                }\r\n            };\r\n\r\n            try {\r\n                const headerResponse = runApiRequest('ImportHeaderRq', JSON.stringify(headerPayload));\r\n                console.log('Import Headers Response:', headerResponse);\r\n\r\n                if (headerResponse) {\r\n                    const headerResult = typeof headerResponse === 'string' ? JSON.parse(headerResponse) : headerResponse;\r\n                    console.log('Import Headers Parsed:', headerResult);\r\n\r\n                    if (headerResult && headerResult.ImportHeaderRs && headerResult.ImportHeaderRs.Header) {\r\n                        console.log('Expected CSV Headers:', headerResult.ImportHeaderRs.Header);\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.error('Error querying import headers:', e);\r\n            }\r\n\r\n            // Build CSV rows with correct column order from ImportHeaderRs\r\n            // Expected order: ToUOM, FromUOM, Description, Factor, Multiply\r\n            const headers = ['ToUOM', 'FromUOM', 'Description', 'Factor', 'Multiply'];\r\n            let rows = [];\r\n\r\n            // Header row (required by API)\r\n            rows.push(headers.map(h => '\"' + h + '\"').join(','));\r\n\r\n            // Data row\r\n            const values = headers.map(h => {\r\n                const value = conversion[h] || '';\r\n                return '\"' + String(value).replace(/\"/g, '\"\"') + '\"';\r\n            });\r\n            rows.push(values.join(','));\r\n\r\n            // Build API request\r\n            const payload = {\r\n                \"ImportRq\": {\r\n                    \"Type\": \"ImportUnitOfMeasureConversions\",\r\n                    \"Rows\": {\r\n                        \"Row\": rows\r\n                    }\r\n                }\r\n            };\r\n\r\n            console.log('Create UOM Conversion Request:', payload);\r\n            console.log('Conversion CSV:', rows);\r\n            showLoading('Creating UOM conversion in Fishbowl...');\r\n\r\n            try {\r\n                const response = runApiRequest('ImportRq', JSON.stringify(payload));\r\n                console.log('Create UOM Conversion Response:', response);\r\n                hideLoading();\r\n\r\n                if (!response) {\r\n                    showToast('API Error', 'Create UOM Conversion failed: No response from API', 'danger');\r\n                    return false;\r\n                }\r\n\r\n                const result = typeof response === 'string' ? JSON.parse(response) : response;\r\n\r\n                if (result && result.ImportRs && result.ImportRs.statusCode === 1000) {\r\n                    showToast('Conversion Created', `Successfully created conversion: 1 ${toUOM} = ${conversionValue} ${fromUOM}. Revalidating data...`, 'success');\r\n\r\n                    // Reload conversions and revalidate\r\n                    loadFishbowlReferenceData();\r\n                    revalidateData();\r\n\r\n                    return true;\r\n                } else {\r\n                    let errorMsg = 'Create UOM Conversion failed';\r\n                    if (result && result.ImportRs) {\r\n                        errorMsg += `\\nStatus Code: ${result.ImportRs.statusCode}`;\r\n                        if (result.ImportRs.statusMessage) {\r\n                            errorMsg += `\\nMessage: ${result.ImportRs.statusMessage}`;\r\n                        }\r\n                    }\r\n                    console.error('Create UOM Conversion Error:', result);\r\n                    showToast('Error', errorMsg, 'danger');\r\n                    return false;\r\n                }\r\n            } catch (error) {\r\n                hideLoading();\r\n                console.error('Error creating UOM conversion:', error);\r\n                showToast('Error', 'Error creating UOM conversion: ' + error.message, 'danger');\r\n                return false;\r\n            }\r\n        });\r\n    }\r\n\r\n    // ============================================\r\n    // Column Sorting and Quick Fill\r\n    // ============================================\r\n\r\n    function sortBy(column) {\r\n        // Toggle direction if same column, otherwise default to ascending\r\n        if (sortState.column === column) {\r\n            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';\r\n        } else {\r\n            sortState.column = column;\r\n            sortState.direction = 'asc';\r\n        }\r\n\r\n        // Sort validationResults based on column\r\n        validationResults.sort((a, b) => {\r\n            let aVal, bVal;\r\n\r\n            if (column === 'rowNum') {\r\n                aVal = a.rowNum;\r\n                bVal = b.rowNum;\r\n            } else {\r\n                // Get values from csvData\r\n                aVal = csvData[a.rowIndex][column] || '';\r\n                bVal = csvData[b.rowIndex][column] || '';\r\n\r\n                // Convert to lowercase for case-insensitive string comparison\r\n                if (typeof aVal === 'string') aVal = aVal.toLowerCase();\r\n                if (typeof bVal === 'string') bVal = bVal.toLowerCase();\r\n            }\r\n\r\n            // Compare\r\n            if (aVal < bVal) return sortState.direction === 'asc' ? -1 : 1;\r\n            if (aVal > bVal) return sortState.direction === 'asc' ? 1 : -1;\r\n            return 0;\r\n        });\r\n\r\n        // Re-render with current filters\r\n        applyFilters();\r\n    }\r\n\r\n    function quickFillColumn(column, value) {\r\n        if (!value) return; // Empty selection, do nothing\r\n\r\n        // Count ALL empty cells across entire dataset\r\n        let emptyCount = 0;\r\n        let nonEmptyCount = 0;\r\n        let sampleNonEmpty = [];\r\n\r\n        csvData.forEach(row => {\r\n            const cellValue = row[column];\r\n            // Check if empty: undefined, null, empty string, or whitespace only\r\n            if (cellValue === undefined || cellValue === null || cellValue === '' || (typeof cellValue === 'string' && cellValue.trim() === '')) {\r\n                emptyCount++;\r\n            } else {\r\n                nonEmptyCount++;\r\n                // Collect sample of non-empty values for debugging\r\n                if (sampleNonEmpty.length < 5) {\r\n                    sampleNonEmpty.push(`\"${cellValue}\" (length: ${cellValue.length})`);\r\n                }\r\n            }\r\n        });\r\n\r\n        console.log(`Quick-fill check: Column=\"${column}\", Value=\"${value}\", EmptyCount=${emptyCount}, NonEmptyCount=${nonEmptyCount}, TotalRows=${csvData.length}`);\r\n        if (sampleNonEmpty.length > 0) {\r\n            console.log(`Sample non-empty ${column} values:`, sampleNonEmpty.join(', '));\r\n        }\r\n\r\n        if (emptyCount === 0) {\r\n            showToast('Info', `No empty ${column} cells found in the dataset. All cells contain values. Check debug console for details.`, 'info', 'Info');\r\n            return;\r\n        }\r\n\r\n        // Confirm with user - make it clear it fills ALL rows (including hidden)\r\n        const msg = `Fill ${emptyCount} empty ${column} cells with \"${value}\"?\\n\\nThis will fill ALL empty cells across the entire dataset\\n(including rows not currently visible due to filters).`;\r\n        if (!(await showConfirm(msg, \\'Fill Values\\'))) {\r\n            return;\r\n        }\r\n\r\n        // Fill ALL empty cells\r\n        let filledCount = 0;\r\n        csvData.forEach(row => {\r\n            const cellValue = row[column];\r\n            if (cellValue === undefined || cellValue === null || cellValue === '' || (typeof cellValue === 'string' && cellValue.trim() === '')) {\r\n                row[column] = value;\r\n                filledCount++;\r\n            }\r\n        });\r\n\r\n        console.log(`Quick-filled ${filledCount} ${column} cells with \"${value}\"`);\r\n\r\n        // Re-validate immediately (not debounced) to ensure changes are applied\r\n        revalidateData();\r\n\r\n        // Reset dropdown\r\n        event.target.value = '';\r\n    }\r\n\r\n    function replaceAllInColumn(column, oldValue, newValue) {\r\n        if (!newValue) return; // Empty selection, do nothing\r\n\r\n        // Count cells that match oldValue\r\n        let matchCount = 0;\r\n        csvData.forEach(row => {\r\n            const cellValue = row[column];\r\n            if (cellValue === oldValue) {\r\n                matchCount++;\r\n            }\r\n        });\r\n\r\n        console.log(`Replace-all check: Column=\"${column}\", OldValue=\"${oldValue}\", NewValue=\"${newValue}\", MatchCount=${matchCount}, TotalRows=${csvData.length}`);\r\n\r\n        if (matchCount === 0) {\r\n            showToast('Info', `No cells found with value \"${oldValue}\" in column ${column}.`, 'info', 'Info');\r\n            return;\r\n        }\r\n\r\n        // Confirm with user\r\n        const msg = `Replace ${matchCount} cells containing \"${oldValue}\" with \"${newValue}\" in column ${column}?`;\r\n        if (!(await showConfirm(msg, \\'Fill Values\\'))) {\r\n            return;\r\n        }\r\n\r\n        // Replace all matching cells\r\n        let replacedCount = 0;\r\n        csvData.forEach(row => {\r\n            const cellValue = row[column];\r\n            if (cellValue === oldValue) {\r\n                row[column] = newValue;\r\n                replacedCount++;\r\n            }\r\n        });\r\n\r\n        console.log(`Replaced ${replacedCount} ${column} cells: \"${oldValue}\" → \"${newValue}\"`);\r\n\r\n        // Re-validate immediately (not debounced) to ensure changes are applied\r\n        revalidateData();\r\n\r\n        // Reset dropdown\r\n        event.target.value = '';\r\n    }\r\n\r\n    // Handler for column actions (fill or replace)\r\n    function handleColumnAction(column, actionValue) {\r\n        if (!actionValue) return;\r\n\r\n        // Parse action: \"FILL:value\" or \"REPLACE:oldValue:newValue\"\r\n        if (actionValue.startsWith('FILL:')) {\r\n            const value = actionValue.substring(5);\r\n            quickFillColumn(column, value);\r\n        } else if (actionValue.startsWith('REPLACE:')) {\r\n            const parts = actionValue.substring(8).split(':');\r\n            if (parts.length === 2) {\r\n                replaceAllInColumn(column, parts[0], parts[1]);\r\n            }\r\n        }\r\n    }\r\n\r\n    // ============================================\r\n    // Results Table Rendering\r\n    // ============================================\r\n\r\n    function renderTable(results) {\r\n        const thead = document.getElementById('tableHeader');\r\n        const tbody = document.getElementById('tableBody');\r\n        const tableContainer = document.querySelector('.results-table-container');\r\n\r\n        // Build header - show status, row number, then visible columns (limit to avoid overflow)\r\n        let visibleHeaders = ['PartNumber', 'PartDescription'];\r\n\r\n        // Add other headers that have data\r\n        csvHeaders.forEach(header => {\r\n            if (!visibleHeaders.includes(header)) {\r\n                const hasData = csvData.some(row => row[header] && row[header].trim() !== '');\r\n                if (hasData) {\r\n                    visibleHeaders.push(header);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Limit columns for display (show first 10)\r\n        const displayHeaders = visibleHeaders.slice(0, 10);\r\n        const hasMoreColumns = visibleHeaders.length > 10;\r\n\r\n        // Build sortable headers with quick-fill dropdowns\r\n        let headerRow1 = '<tr>';\r\n        headerRow1 += '<th class=\"row-status\">Status</th>';\r\n        headerRow1 += '<th onclick=\"sortBy(\\'rowNum\\')\" style=\"cursor: pointer;\">Row ' + (sortState.column === 'rowNum' ? (sortState.direction === 'asc' ? '▲' : '▼') : '') + '</th>';\r\n\r\n        displayHeaders.forEach(h => {\r\n            const sortIndicator = sortState.column === h ? (sortState.direction === 'asc' ? '▲' : '▼') : '';\r\n            headerRow1 += `<th onclick=\"sortBy('${h}')\" style=\"cursor: pointer;\">${h} ${sortIndicator}</th>`;\r\n        });\r\n\r\n        if (hasMoreColumns) headerRow1 += '<th>...</th>';\r\n        headerRow1 += '<th>Issues</th>';\r\n        headerRow1 += '</tr>';\r\n\r\n        // Second row: Quick-fill dropdowns for applicable columns\r\n        let headerRow2 = '<tr class=\"quick-fill-row\">';\r\n        headerRow2 += '<th></th><th></th>'; // Status and Row columns\r\n\r\n        displayHeaders.forEach(h => {\r\n            const colDef = PPP_COLUMNS[h];\r\n            let dropdown = '';\r\n\r\n            // Add dropdown for columns with valid values or specific known columns\r\n            if (h === 'Active') {\r\n                dropdown = `<select onchange=\"quickFillColumn('${h}', this.value)\" style=\"width: 100%; font-size: 11px; padding: 2px;\">\r\n                    <option value=\"\">Quick Fill...</option>\r\n                    <option value=\"TRUE\">Fill empty → TRUE</option>\r\n                    <option value=\"FALSE\">Fill empty → FALSE</option>\r\n                </select>`;\r\n            } else if (h === 'PartTaxCode' && fishbowlData.taxCodes.length > 0) {\r\n                const taxOpts = fishbowlData.taxCodes.map(tc =>\r\n                    `<option value=\"${escapeHtml(tc.code)}\">${escapeHtml(tc.name)}</option>`\r\n                ).join('');\r\n                dropdown = `<select onchange=\"quickFillColumn('${h}', this.value)\" style=\"width: 100%; font-size: 11px; padding: 2px;\">\r\n                    <option value=\"\">Quick Fill...</option>\r\n                    ${taxOpts}\r\n                </select>`;\r\n            } else if (h === 'PartTypeID' && fishbowlData.partTypes.length > 0) {\r\n                const ptOpts = fishbowlData.partTypes.map(pt =>\r\n                    `<option value=\"${pt.id}\">${escapeHtml(pt.name)}</option>`\r\n                ).join('');\r\n                dropdown = `<select onchange=\"quickFillColumn('${h}', this.value)\" style=\"width: 100%; font-size: 11px; padding: 2px;\">\r\n                    <option value=\"\">Quick Fill...</option>\r\n                    ${ptOpts}\r\n                </select>`;\r\n            } else if (h === 'UOM' && fishbowlData.uoms.length > 0) {\r\n                // Find invalid UOM values in dataset\r\n                const invalidUOMs = new Set();\r\n                csvData.forEach(row => {\r\n                    const uomVal = row[h];\r\n                    if (uomVal && uomVal.trim() !== '' && !fishbowlData.uoms.includes(uomVal)) {\r\n                        invalidUOMs.add(uomVal);\r\n                    }\r\n                });\r\n\r\n                // Fill options\r\n                const fillOpts = fishbowlData.uoms.map(uom =>\r\n                    `<option value=\"FILL:${escapeHtml(uom)}\">Fill empty → ${escapeHtml(uom)}</option>`\r\n                ).join('');\r\n\r\n                // Replace options for invalid values\r\n                let replaceOpts = '';\r\n                if (invalidUOMs.size > 0) {\r\n                    replaceOpts = Array.from(invalidUOMs).map(invalidUOM => {\r\n                        // For each invalid UOM, offer to replace with each valid UOM\r\n                        const subOpts = fishbowlData.uoms.slice(0, 3).map(validUOM => // Limit to first 3 to avoid huge dropdown\r\n                            `<option value=\"REPLACE:${escapeHtml(invalidUOM)}:${escapeHtml(validUOM)}\">Replace \"${escapeHtml(invalidUOM)}\" → ${escapeHtml(validUOM)}</option>`\r\n                        ).join('');\r\n                        return subOpts;\r\n                    }).join('');\r\n                }\r\n\r\n                dropdown = `<select onchange=\"handleColumnAction('${h}', this.value); this.value='';\" style=\"width: 100%; font-size: 11px; padding: 2px;\">\r\n                    <option value=\"\">Actions...</option>\r\n                    <optgroup label=\"Fill Empty\">\r\n                        ${fillOpts}\r\n                    </optgroup>\r\n                    ${replaceOpts ? `<optgroup label=\"Replace Invalid\">${replaceOpts}</optgroup>` : ''}\r\n                </select>`;\r\n            } else if (colDef && colDef.validValues) {\r\n                const valOpts = colDef.validValues.map(v =>\r\n                    `<option value=\"${escapeHtml(v)}\">${escapeHtml(v)}</option>`\r\n                ).join('');\r\n                dropdown = `<select onchange=\"quickFillColumn('${h}', this.value)\" style=\"width: 100%; font-size: 11px; padding: 2px;\">\r\n                    <option value=\"\">Quick Fill...</option>\r\n                    ${valOpts}\r\n                </select>`;\r\n            }\r\n\r\n            headerRow2 += `<th style=\"padding: 2px;\">${dropdown}</th>`;\r\n        });\r\n\r\n        if (hasMoreColumns) headerRow2 += '<th></th>';\r\n        headerRow2 += '<th></th>'; // Issues column\r\n        headerRow2 += '</tr>';\r\n\r\n        thead.innerHTML = headerRow1 + headerRow2;\r\n\r\n        // Virtual scrolling: determine which rows to render\r\n        let rowsToRender = results;\r\n        let startIndex = 0;\r\n        let endIndex = results.length;\r\n\r\n        if (virtualScrollState.enabled && tableContainer) {\r\n            // Calculate visible range based on scroll position\r\n            const scrollTop = virtualScrollState.scrollTop;\r\n            const viewportHeight = virtualScrollState.viewportHeight;\r\n\r\n            startIndex = Math.floor(scrollTop / ROW_HEIGHT) - BUFFER_ROWS;\r\n            endIndex = Math.ceil((scrollTop + viewportHeight) / ROW_HEIGHT) + BUFFER_ROWS;\r\n\r\n            startIndex = Math.max(0, startIndex);\r\n            endIndex = Math.min(results.length, endIndex);\r\n\r\n            rowsToRender = results.slice(startIndex, endIndex);\r\n\r\n            virtualScrollState.visibleStartIndex = startIndex;\r\n            virtualScrollState.visibleEndIndex = endIndex;\r\n        }\r\n\r\n        // Build body\r\n        let html = '';\r\n\r\n        // Add top spacer for virtual scrolling\r\n        if (virtualScrollState.enabled && startIndex > 0) {\r\n            const spacerHeight = startIndex * ROW_HEIGHT;\r\n            html += `<tr><td colspan=\"${displayHeaders.length + 4}\" style=\"height: ${spacerHeight}px; padding: 0;\"></td></tr>`;\r\n        }\r\n\r\n        rowsToRender.forEach((result, displayIdx) => {\r\n            const idx = virtualScrollState.enabled ? startIndex + displayIdx : displayIdx;\r\n            const row = csvData[result.rowIndex];\r\n            const rowClass = result.status === 'error' ? 'row-error' :\r\n                            (result.status === 'warning' ? 'row-warning' : '');\r\n            // Create status badge instead of icon\r\n            const statusBadge = result.status === 'valid' ?\r\n                '<span class=\"badge bg-success\"><i class=\"bi bi-check-circle\"></i> Valid</span>' :\r\n                (result.status === 'warning' ?\r\n                    '<span class=\"badge bg-warning text-dark\"><i class=\"bi bi-exclamation-triangle\"></i> Warning</span>' :\r\n                    '<span class=\"badge bg-danger\"><i class=\"bi bi-x-circle\"></i> Error</span>');\r\n\r\n            html += `<tr class=\"${rowClass}\" id=\"row-${idx}\">`;\r\n            html += `<td class=\"row-status\">${statusBadge}</td>`;\r\n            html += `<td>${result.rowNum}</td>`;\r\n\r\n            displayHeaders.forEach(header => {\r\n                const value = row[header] || '';\r\n                const cellClass = result.cellErrors[header] ? 'cell-error' :\r\n                                 (result.cellWarnings[header] ? 'cell-warning' : '');\r\n\r\n                // Make certain fields editable with dropdowns\r\n                if (header === 'Active') {\r\n                    html += `<td class=\"${cellClass}\" style=\"min-width: 120px;\">\r\n                        <select onchange=\"updateCell(${result.rowIndex}, '${header}', this.value)\" style=\"width: 100%; padding: 4px;\">\r\n                            <option value=\"\" ${value === '' ? 'selected' : ''}></option>\r\n                            <option value=\"TRUE\" ${value === 'TRUE' ? 'selected' : ''}>TRUE</option>\r\n                            <option value=\"FALSE\" ${value === 'FALSE' ? 'selected' : ''}>FALSE</option>\r\n                        </select>\r\n                    </td>`;\r\n                } else if (header === 'PartTaxCode') {\r\n                    if (fishbowlData.taxCodes.length > 0) {\r\n                        const taxOptions = fishbowlData.taxCodes\r\n                            .map(tc => `<option value=\"${escapeHtml(tc.code)}\" ${value === tc.code ? 'selected' : ''}>${escapeHtml(tc.name)} (${escapeHtml(tc.code)})</option>`)\r\n                            .join('');\r\n                        html += `<td class=\"${cellClass}\">\r\n                            <select onchange=\"updateCell(${result.rowIndex}, '${header}', this.value)\" style=\"width: 100%; padding: 2px; font-size: 11px;\">\r\n                                <option value=\"\" ${value === '' ? 'selected' : ''}></option>\r\n                                ${taxOptions}\r\n                            </select>\r\n                        </td>`;\r\n                    } else {\r\n                        html += `<td class=\"${cellClass}\">${escapeHtml(value)}</td>`;\r\n                    }\r\n                } else if (header === 'PartTypeID') {\r\n                    if (fishbowlData.partTypes.length > 0) {\r\n                        const ptOptions = fishbowlData.partTypes\r\n                            .map(pt => `<option value=\"${pt.id}\" ${value == pt.id ? 'selected' : ''}>${escapeHtml(pt.name)} (${pt.id})</option>`)\r\n                            .join('');\r\n                        html += `<td class=\"${cellClass}\" style=\"min-width: 150px;\">\r\n                            <select onchange=\"updateCell(${result.rowIndex}, '${header}', this.value)\" style=\"width: 100%; padding: 4px; font-size: 11px;\">\r\n                                <option value=\"\" ${value === '' ? 'selected' : ''}></option>\r\n                                ${ptOptions}\r\n                            </select>\r\n                        </td>`;\r\n                    } else {\r\n                        html += `<td class=\"${cellClass}\">${escapeHtml(value)}</td>`;\r\n                    }\r\n                } else if (header === 'UOM') {\r\n                    if (fishbowlData.uoms.length > 0) {\r\n                        const uomOptions = fishbowlData.uoms\r\n                            .map(uom => `<option value=\"${escapeHtml(uom)}\" ${value === uom ? 'selected' : ''}>${escapeHtml(uom)}</option>`)\r\n                            .join('');\r\n                        html += `<td class=\"${cellClass}\" style=\"min-width: 120px;\">\r\n                            <select onchange=\"updateCell(${result.rowIndex}, '${header}', this.value)\" style=\"width: 100%; padding: 4px; font-size: 11px;\">\r\n                                <option value=\"\" ${value === '' ? 'selected' : ''}></option>\r\n                                ${uomOptions}\r\n                            </select>\r\n                        </td>`;\r\n                    } else {\r\n                        html += `<td class=\"${cellClass}\">${escapeHtml(value)}</td>`;\r\n                    }\r\n                } else {\r\n                    html += `<td class=\"${cellClass}\">${escapeHtml(value)}</td>`;\r\n                }\r\n            });\r\n\r\n            if (hasMoreColumns) {\r\n                html += `<td style=\"color: var(--fb-text-secondary); font-style: italic;\">+${visibleHeaders.length - 10} cols</td>`;\r\n            }\r\n\r\n            // Issues column\r\n            const totalIssues = result.errors.length + result.warnings.length;\r\n            if (totalIssues > 0) {\r\n                html += `<td>\r\n                    <button class=\"expand-btn\" onclick=\"toggleRowDetails(${idx})\">\r\n                        ${totalIssues} issue${totalIssues > 1 ? 's' : ''} ▼\r\n                    </button>\r\n                </td>`;\r\n            } else {\r\n                html += `<td style=\"color: var(--fb-success);\">None</td>`;\r\n            }\r\n\r\n            html += `</tr>`;\r\n\r\n            // Hidden details row\r\n            if (totalIssues > 0) {\r\n                html += `<tr class=\"row-details\" id=\"details-${idx}\">\r\n                    <td colspan=\"${displayHeaders.length + 4}\">\r\n                        <div class=\"error-details\">\r\n                            ${result.errors.map(e => `\r\n                                <div class=\"error-item\">\r\n                                    <span class=\"error-field\">${e.field}:</span>\r\n                                    <span class=\"error-message\">${e.message}</span>\r\n                                    ${e.suggestion ? `<span class=\"error-suggestion\">\uD83D\uDCA1 ${e.suggestion}</span>` : ''}\r\n                                </div>\r\n                            `).join('')}\r\n                            ${result.warnings.map(w => `\r\n                                <div class=\"error-item warning-item\">\r\n                                    <span class=\"error-field\" style=\"color: var(--fb-warning);\">${w.field}:</span>\r\n                                    <span class=\"error-message\">${w.message}</span>\r\n                                    ${w.suggestion ? `<span class=\"error-suggestion\">\uD83D\uDCA1 ${w.suggestion}</span>` : ''}\r\n                                </div>\r\n                            `).join('')}\r\n                        </div>\r\n                    </td>\r\n                </tr>`;\r\n            }\r\n        });\r\n\r\n        // Add bottom spacer for virtual scrolling\r\n        if (virtualScrollState.enabled && endIndex < results.length) {\r\n            const remainingRows = results.length - endIndex;\r\n            const spacerHeight = remainingRows * ROW_HEIGHT;\r\n            html += `<tr><td colspan=\"${displayHeaders.length + 4}\" style=\"height: ${spacerHeight}px; padding: 0;\"></td></tr>`;\r\n        }\r\n\r\n        tbody.innerHTML = html;\r\n\r\n        // Setup scroll listener for virtual scrolling (only once)\r\n        if (virtualScrollState.enabled && tableContainer && !tableContainer.dataset.scrollListenerAttached) {\r\n            tableContainer.addEventListener('scroll', handleTableScroll);\r\n            tableContainer.dataset.scrollListenerAttached = 'true';\r\n            console.log('Virtual scroll listener attached');\r\n        }\r\n    }\r\n\r\n    // Handle table scroll for virtual scrolling\r\n    function handleTableScroll() {\r\n        const tableContainer = document.querySelector('.results-table-container');\r\n        if (!tableContainer || !virtualScrollState.enabled) return;\r\n\r\n        virtualScrollState.scrollTop = tableContainer.scrollTop;\r\n        virtualScrollState.viewportHeight = tableContainer.clientHeight;\r\n\r\n        // Re-render only visible rows\r\n        const statusFilter = document.getElementById('filterStatus').value;\r\n        const searchTerm = document.getElementById('searchInput').value.toLowerCase();\r\n\r\n        let filtered = validationResults.filter(result => {\r\n            // Status filter\r\n            if (statusFilter !== 'all') {\r\n                if (statusFilter === 'errors' && result.status !== 'error') return false;\r\n                if (statusFilter === 'warnings' && result.status !== 'warning') return false;\r\n                if (statusFilter === 'valid' && result.status !== 'valid') return false;\r\n            }\r\n\r\n            // Search filter\r\n            if (searchTerm) {\r\n                const row = csvData[result.rowIndex];\r\n                const rowText = Object.values(row).join(' ').toLowerCase();\r\n                if (!rowText.includes(searchTerm)) return false;\r\n            }\r\n\r\n            return true;\r\n        });\r\n\r\n        renderTable(filtered);\r\n    }\r\n\r\n    function toggleRowDetails(idx) {\r\n        const detailsRow = document.getElementById('details-' + idx);\r\n        if (detailsRow) {\r\n            detailsRow.classList.toggle('expanded');\r\n        }\r\n    }\r\n\r\n    // Debounced re-validation function\r\n    const debouncedRevalidate = debounce(async function() {\r\n        showLoading('Re-validating...');\r\n        await validateData();\r\n        renderResults();\r\n        hideLoading();\r\n    }, 500);\r\n\r\n    function updateCell(rowIndex, field, newValue) {\r\n        if (rowIndex >= 0 && rowIndex < csvData.length) {\r\n            csvData[rowIndex][field] = newValue;\r\n            // Re-validate after cell update (debounced to avoid re-validating on every keystroke)\r\n            debouncedRevalidate();\r\n        }\r\n    }\r\n\r\n    function escapeHtml(text) {\r\n        if (!text) return '';\r\n        return text\r\n            .replace(/&/g, '&amp;')\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;')\r\n            .replace(/\"/g, '&quot;');\r\n    }\r\n\r\n    // ============================================\r\n    // Filtering\r\n    // ============================================\r\n\r\n    function applyFilters() {\r\n        const statusFilter = document.getElementById('filterStatus').value;\r\n        const searchTerm = document.getElementById('searchInput').value.toLowerCase();\r\n\r\n        let filtered = validationResults.filter(result => {\r\n            // Status filter\r\n            if (statusFilter !== 'all') {\r\n                if (statusFilter === 'errors' && result.status !== 'error') return false;\r\n                if (statusFilter === 'warnings' && result.status !== 'warning') return false;\r\n                if (statusFilter === 'valid' && result.status !== 'valid') return false;\r\n            }\r\n\r\n            // Search filter\r\n            if (searchTerm) {\r\n                const row = csvData[result.rowIndex];\r\n                const rowText = Object.values(row).join(' ').toLowerCase();\r\n                if (!rowText.includes(searchTerm)) return false;\r\n            }\r\n\r\n            return true;\r\n        });\r\n\r\n        renderTable(filtered);\r\n    }\r\n\r\n    // ============================================\r\n    // Export Functions\r\n    // ============================================\r\n\r\n    function exportValidRows() {\r\n        const validResults = validationResults.filter(r => r.status === 'valid');\r\n        if (validResults.length === 0) {\r\n            showToast('No Data', 'No valid rows to export.', 'warning');\r\n            return;\r\n        }\r\n\r\n        const validRows = validResults.map(r => csvData[r.rowIndex]);\r\n        exportCSV(validRows, 'PPP_Valid_Rows.csv');\r\n    }\r\n\r\n    function exportAllWithFixes() {\r\n        // Export all rows with a comment column for issues\r\n        const exportData = csvData.map((row, idx) => {\r\n            const result = validationResults[idx];\r\n            const newRow = { ...row };\r\n\r\n            // Add issues as a comment\r\n            if (result.errors.length > 0 || result.warnings.length > 0) {\r\n                const issues = [\r\n                    ...result.errors.map(e => `ERROR: ${e.field} - ${e.message}`),\r\n                    ...result.warnings.map(w => `WARNING: ${w.field} - ${w.message}`)\r\n                ];\r\n                newRow['_ValidationIssues'] = issues.join('; ');\r\n            } else {\r\n                newRow['_ValidationIssues'] = 'OK';\r\n            }\r\n\r\n            return newRow;\r\n        });\r\n\r\n        exportCSV(exportData, 'PPP_Validated.csv', [...csvHeaders, '_ValidationIssues']);\r\n    }\r\n\r\n    function exportCSV(data, filename, headers) {\r\n        headers = headers || csvHeaders;\r\n\r\n        let csv = headers.map(h => '\"' + h.replace(/\"/g, '\"\"') + '\"').join(',') + '\\n';\r\n\r\n        data.forEach(row => {\r\n            const values = headers.map(h => {\r\n                let value = row[h] || '';\r\n                // Escape quotes and wrap in quotes\r\n                value = '\"' + String(value).replace(/\"/g, '\"\"') + '\"';\r\n                return value;\r\n            });\r\n            csv += values.join(',') + '\\n';\r\n        });\r\n\r\n        // Download\r\n        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\r\n        const url = window.URL.createObjectURL(blob);\r\n        const link = document.createElement('a');\r\n        link.href = url;\r\n        link.download = filename;\r\n        document.body.appendChild(link);\r\n        link.click();\r\n        document.body.removeChild(link);\r\n        window.URL.revokeObjectURL(url);\r\n    }\r\n\r\n    async function importToFishbowl() {\r\n        // Get valid rows only\r\n        const validResults = validationResults.filter(r => r.status === 'valid');\r\n\r\n        if (validResults.length === 0) {\r\n            showToast('No Valid Data', 'No valid rows to import. Please fix all errors and warnings first.', 'warning');\r\n            return;\r\n        }\r\n\r\n        const validRows = validResults.map(r => csvData[r.rowIndex]);\r\n\r\n        if (!(await showConfirm(`Import ${validRows.length} valid rows to Fishbowl?\r\n\r\nThis will create/update parts, products, and vendor pricing in Fishbowl.`, \\'Import to Fishbowl\\'))) {\r\n            return;\r\n        }\r\n\r\n        showLoading('Preparing data for import...');\r\n\r\n        try {\r\n            // Build rows array in the format expected by Fishbowl API\r\n            let rows = [];\r\n\r\n            // Header row\r\n            rows.push(csvHeaders.map(h => '\"' + h.replace(/\"/g, '\"\"') + '\"').join(','));\r\n\r\n            // Data rows\r\n            validRows.forEach(function(row) {\r\n                const values = csvHeaders.map(h => {\r\n                    let value = row[h] || '';\r\n                    value = '\"' + String(value).replace(/\"/g, '\"\"') + '\"';\r\n                    return value;\r\n                });\r\n                rows.push(values.join(','));\r\n            });\r\n\r\n            // Build API request payload\r\n            let payload = {\r\n                \"ImportRq\": {\r\n                    \"Type\": \"ImportPartProductAndVendorPricing\",\r\n                    \"Rows\": {\r\n                        \"Row\": rows\r\n                    }\r\n                }\r\n            };\r\n\r\n            console.log('Import Request:', payload);\r\n            console.log('First 3 rows:', rows.slice(0, 3));\r\n\r\n            showLoading('Importing ' + validRows.length + ' rows to Fishbowl...');\r\n\r\n            // Call the Fishbowl API\r\n            let response = runApiRequest('ImportRq', JSON.stringify(payload));\r\n            console.log('Import Response (raw):', response);\r\n\r\n            hideLoading();\r\n\r\n            if (!response) {\r\n                showToast('API Error', 'Import failed: No response from API', 'danger');\r\n                return;\r\n            }\r\n\r\n            // Parse response\r\n            let result = typeof response === 'string' ? JSON.parse(response) : response;\r\n            console.log('Import Result (parsed):', result);\r\n\r\n            // Check for success\r\n            if (result && result.ImportRs && result.ImportRs.statusCode === 1000) {\r\n                showToast('Import Success', 'Successfully imported ' + validRows.length + ' rows to Fishbowl!', 'success');\r\n\r\n                // Optionally clear data after successful import\r\n                if (await showConfirm('Import successful! Clear the validator?', 'Clear Validator')) {\r\n                    clearData();\r\n                }\r\n            } else {\r\n                let errorMsg = 'Import failed';\r\n                let statusMessage = '';\r\n\r\n                if (result && result.ImportRs && result.ImportRs.statusMessage) {\r\n                    statusMessage = result.ImportRs.statusMessage;\r\n                    errorMsg += ': ' + statusMessage;\r\n                } else if (result && result.ErrorRs && result.ErrorRs.statusMessage) {\r\n                    statusMessage = result.ErrorRs.statusMessage;\r\n                    errorMsg += ': ' + statusMessage;\r\n                } else {\r\n                    errorMsg += ': ' + JSON.stringify(result);\r\n                }\r\n\r\n                // Try to extract line number from error message\r\n                let lineNumberMatch = statusMessage.match(/Line Number:\\s*(\\d+)/i);\r\n                if (lineNumberMatch && lineNumberMatch[1]) {\r\n                    let csvLineNum = parseInt(lineNumberMatch[1]);\r\n                    let arrayIndex = csvLineNum - 1;\r\n\r\n                    if (arrayIndex >= 0 && arrayIndex < rows.length) {\r\n                        errorMsg += '\\n\\nError on CSV line ' + csvLineNum + ':\\n' + rows[arrayIndex];\r\n                        console.error('Error on CSV line ' + csvLineNum + ' (array index ' + arrayIndex + '): ' + rows[arrayIndex]);\r\n                    }\r\n                }\r\n\r\n                alert(errorMsg);\r\n            }\r\n\r\n        } catch (error) {\r\n            hideLoading();\r\n            console.error('Error during import:', error);\r\n            showToast('Error', 'Import error: ' + error.message, 'danger');\r\n        }\r\n    }\r\n\r\n    // ============================================\r\n    // Utility Functions\r\n    // ============================================\r\n\r\n    async function revalidateData() {\r\n        if (csvData.length === 0) {\r\n            showToast('No Data', 'No data to validate. Please upload a file first.', 'warning');\r\n            return;\r\n        }\r\n\r\n        showLoading('Re-loading Fishbowl data...');\r\n        loadFishbowlReferenceData();\r\n\r\n        showLoading('Re-validating...');\r\n        await validateData(); // Now async!\r\n\r\n        showLoading('Rendering results...');\r\n        renderResults();\r\n\r\n        hideLoading();\r\n    }\r\n\r\n    function clearData() {\r\n        csvData = [];\r\n        csvHeaders = [];\r\n        validationResults = [];\r\n        consolidatedIssues = {};\r\n\r\n        document.getElementById('fileName').textContent = '';\r\n        document.getElementById('fileInput').value = '';\r\n        document.getElementById('summaryStats').classList.add('hidden');\r\n        document.getElementById('filterControls').classList.add('hidden');\r\n        document.getElementById('resultsSection').classList.add('hidden');\r\n        document.getElementById('actionButtons').classList.add('hidden');\r\n        document.getElementById('consolidatedIssues').classList.add('hidden');\r\n        document.getElementById('tableBody').innerHTML = '';\r\n    }\r\n\r\n    function showLoading(text) {\r\n        document.getElementById('loadingText').textContent = text || 'Processing...';\r\n        document.getElementById('loadingOverlay').classList.remove('hidden');\r\n    }\r\n\r\n    function hideLoading() {\r\n        document.getElementById('loadingOverlay').classList.add('hidden');\r\n    }\r\n\r\n    // ============================================\r\n    // Column Reference\r\n    // ============================================\r\n\r\n    function populateColumnReference() {\r\n        const container = document.getElementById('columnRefContent');\r\n        if (!container) return;\r\n\r\n        let html = '';\r\n\r\n        Object.entries(PPP_COLUMNS).forEach(([name, def]) => {\r\n            const required = def.required ? '<span class=\"badge bg-danger ms-2\">Required</span>' : '';\r\n            const validValuesHtml = def.validValues ?\r\n                `<div class=\"mt-2\"><small class=\"text-info\"><strong>Valid values:</strong> ${def.validValues.join(', ')}</small></div>` : '';\r\n\r\n            html += `\r\n                <div class=\"card card-compact mb-2\">\r\n                    <div class=\"card-body\">\r\n                        <h6 class=\"card-title mb-1\">\r\n                            ${name}\r\n                            <span class=\"badge bg-secondary ms-2\">${def.type}</span>\r\n                            ${required}\r\n                        </h6>\r\n                        <p class=\"card-text mb-0\"><small>${def.desc}</small></p>\r\n                        ${validValuesHtml}\r\n                    </div>\r\n                </div>\r\n            `;\r\n        });\r\n\r\n        // Add note about custom fields\r\n        html += `\r\n            <div class=\"card card-compact mb-2 border-warning\">\r\n                <div class=\"card-body bg-warning bg-opacity-10\">\r\n                    <h6 class=\"card-title mb-1\">\r\n                        CF-*\r\n                        <span class=\"badge bg-secondary ms-2\">Custom Field</span>\r\n                    </h6>\r\n                    <p class=\"card-text mb-0\"><small>Any column starting with \"CF-\" is treated as a custom field. The field name after \"CF-\" must match an existing custom field in Fishbowl.</small></p>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        container.innerHTML = html;\r\n    }\r\n\r\n    // Column reference toggle is now handled by Bootstrap offcanvas\r\n    function toggleColumnReference() {\r\n        // Deprecated - kept for compatibility\r\n        const toggle = document.getElementById('refToggle');\r\n        if (!toggle) return;\r\n\r\n        const grid = document.getElementById('columnGrid');\r\n        if (!grid) return;\r\n\r\n        if (grid.classList.contains('hidden')) {\r\n            grid.classList.remove('hidden');\r\n            toggle.textContent = '▼';\r\n        } else {\r\n            grid.classList.add('hidden');\r\n            toggle.textContent = '▶';\r\n        }\r\n    }\r\n\r\n    // ============================================\r\n    // Configuration Update Functions\r\n    // ============================================\r\n\r\n    function updateBatchSize(value) {\r\n        const numValue = parseInt(value, 10);\r\n        if (numValue >= 50 && numValue <= 1000) {\r\n            BATCH_SIZE = numValue;\r\n            console.log(`Batch size updated to: ${BATCH_SIZE}`);\r\n        }\r\n    }\r\n\r\n    function updateRowHeight(value) {\r\n        const numValue = parseInt(value, 10);\r\n        if (numValue >= 25 && numValue <= 60) {\r\n            ROW_HEIGHT = numValue;\r\n            console.log(`Row height updated to: ${ROW_HEIGHT}`);\r\n            // Re-render if data is loaded\r\n            if (csvData.length > 0) {\r\n                renderTable(validationResults);\r\n            }\r\n        }\r\n    }\r\n\r\n    function updateBufferRows(value) {\r\n        const numValue = parseInt(value, 10);\r\n        if (numValue >= 5 && numValue <= 50) {\r\n            BUFFER_ROWS = numValue;\r\n            console.log(`Buffer rows updated to: ${BUFFER_ROWS}`);\r\n        }\r\n    }\r\n\r\n    function updateVirtualScrollThreshold(value) {\r\n        const numValue = parseInt(value, 10);\r\n        if (numValue >= 100 && numValue <= 2000) {\r\n            VIRTUAL_SCROLL_THRESHOLD = numValue;\r\n            console.log(`Virtual scroll threshold updated to: ${VIRTUAL_SCROLL_THRESHOLD}`);\r\n            // Re-render if data is loaded\r\n            if (csvData.length > 0) {\r\n                renderTable(validationResults);\r\n            }\r\n        }\r\n    }\r\n\r\n    function updateDebounceDelay(value) {\r\n        const numValue = parseInt(value, 10);\r\n        if (numValue >= 100 && numValue <= 2000) {\r\n            DEBOUNCE_DELAY = numValue;\r\n            console.log(`Debounce delay updated to: ${DEBOUNCE_DELAY}ms`);\r\n            // Recreate debounced function with new delay\r\n            debouncedRevalidate = debounce(revalidateData, DEBOUNCE_DELAY);\r\n        }\r\n    }\r\n\r\n    function updateStrictMode(value) {\r\n        STRICT_MODE = value === 'true';\r\n        console.log(`Strict mode: ${STRICT_MODE ? 'enabled' : 'disabled'}`);\r\n        // Re-validate if data is loaded\r\n        if (csvData.length > 0) {\r\n            revalidateData();\r\n        }\r\n    }\r\n\r\n    // ============================================\r\n    // Toast Notification System\r\n    // ============================================\r\n\r\n    function showToast(title, message, type = 'info') {\r\n        // Type can be: success, danger, warning, info, primary\r\n        const toastContainer = document.getElementById('toastContainer');\r\n        if (!toastContainer) {\r\n            console.error('Toast container not found');\r\n            return;\r\n        }\r\n\r\n        const toastId = 'toast_' + Date.now();\r\n        const iconMap = {\r\n            success: 'bi-check-circle-fill',\r\n            danger: 'bi-x-circle-fill',\r\n            warning: 'bi-exclamation-triangle-fill',\r\n            info: 'bi-info-circle-fill',\r\n            primary: 'bi-bell-fill'\r\n        };\r\n\r\n        const icon = iconMap[type] || iconMap.info;\r\n        const bgClass = `bg-${type}`;\r\n\r\n        const toastHtml = `\r\n            <div class=\"toast\" id=\"${toastId}\" role=\"alert\" aria-live=\"assertive\" aria-atomic=\"true\">\r\n                <div class=\"toast-header ${bgClass} text-white\">\r\n                    <i class=\"bi ${icon} me-2\"></i>\r\n                    <strong class=\"me-auto\">${escapeHtml(title)}</strong>\r\n                    <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"toast\" aria-label=\"Close\"></button>\r\n                </div>\r\n                <div class=\"toast-body\">\r\n                    ${escapeHtml(message)}\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        toastContainer.insertAdjacentHTML('beforeend', toastHtml);\r\n\r\n        const toastElement = document.getElementById(toastId);\r\n        const toast = new bootstrap.Toast(toastElement, {\r\n            autohide: true,\r\n            delay: type === 'danger' ? 8000 : 5000 // Errors stay longer\r\n        });\r\n\r\n        toast.show();\r\n\r\n        // Clean up after toast is hidden\r\n        toastElement.addEventListener('hidden.bs.toast', function() {\r\n            toastElement.remove();\r\n        });\r\n    }\r\n\r\n    // ============================================\r\n    // Confirmation Dialog System (Bootstrap Modal)\r\n    // ============================================\r\n\r\n    function showConfirm(message, title = 'Confirm Action') {\r\n        return new Promise((resolve) => {\r\n            const modal = document.getElementById('confirmModal');\r\n            const modalTitle = document.getElementById('confirmModalLabel');\r\n            const modalBody = document.getElementById('confirmModalBody');\r\n            const confirmBtn = document.getElementById('confirmModalBtn');\r\n            const cancelBtn = document.getElementById('confirmModalCancelBtn');\r\n\r\n            // Set content\r\n            modalTitle.textContent = title;\r\n            modalBody.textContent = message;\r\n\r\n            // Create Bootstrap modal instance\r\n            const bsModal = new bootstrap.Modal(modal);\r\n\r\n            // Set up event handlers\r\n            const handleConfirm = () => {\r\n                bsModal.hide();\r\n                resolve(true);\r\n                cleanup();\r\n            };\r\n\r\n            const handleCancel = () => {\r\n                bsModal.hide();\r\n                resolve(false);\r\n                cleanup();\r\n            };\r\n\r\n            const cleanup = () => {\r\n                confirmBtn.removeEventListener('click', handleConfirm);\r\n                cancelBtn.removeEventListener('click', handleCancel);\r\n                modal.removeEventListener('hidden.bs.modal', handleCancel);\r\n            };\r\n\r\n            // Attach event listeners\r\n            confirmBtn.addEventListener('click', handleConfirm);\r\n            cancelBtn.addEventListener('click', handleCancel);\r\n            modal.addEventListener('hidden.bs.modal', handleCancel, { once: true });\r\n\r\n            // Show modal\r\n            bsModal.show();\r\n        });\r\n    }\r\n    </script>\r\n\r\n    <!-- Confirmation Modal -->\r\n    <div class=\"modal fade\" id=\"confirmModal\" tabindex=\"-1\" aria-labelledby=\"confirmModalLabel\" aria-hidden=\"true\">\r\n        <div class=\"modal-dialog modal-dialog-centered\">\r\n            <div class=\"modal-content\">\r\n                <div class=\"modal-header bg-warning text-dark\">\r\n                    <h5 class=\"modal-title\" id=\"confirmModalLabel\">Confirm Action</h5>\r\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\r\n                </div>\r\n                <div class=\"modal-body\" id=\"confirmModalBody\">\r\n                    Are you sure you want to proceed?\r\n                </div>\r\n                <div class=\"modal-footer\">\r\n                    <button type=\"button\" class=\"btn btn-secondary\" id=\"confirmModalCancelBtn\" data-bs-dismiss=\"modal\">Cancel</button>\r\n                    <button type=\"button\" class=\"btn btn-warning\" id=\"confirmModalBtn\">Confirm</button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Toast Notification Container -->\r\n    <div class=\"toast-container position-fixed bottom-0 end-0 p-3\" id=\"toastContainer\" style=\"z-index: 9999;\"></div>\r\n\r\n    <!-- Bootstrap 5.3 JS Bundle (includes Popper) -->\r\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\r\n</body>\r\n</html>\r\n",
  "active" : true,
  "note" : "",
  "type" : "Page"
} ]