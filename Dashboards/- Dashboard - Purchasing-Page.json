[ {
  "name" : "- Dashboard - Purchasing",
  "description" : "- Dashboard - Purchasing",
  "data" : "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Purchasing Dashboard - Fishbowl Advanced</title>\r\n\r\n    <!-- Tailwind CSS -->\r\n    <script src=\"https://cdn.tailwindcss.com\"></script>\r\n\r\n    <!-- D3.js v7 -->\r\n    <script src=\"https://d3js.org/d3.v7.min.js\"></script>\r\n\r\n    <!-- Moment.js -->\r\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js\"></script>\r\n\r\n    <!-- Google Fonts -->\r\n    <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap\" rel=\"stylesheet\">\r\n\r\n    <style>\r\n        html, body {\r\n            height: 100%;\r\n            margin: 0;\r\n            padding: 0;\r\n            overflow: hidden;\r\n            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\r\n        }\r\n\r\n        /* Custom Brand Colors */\r\n        :root {\r\n            --color-primary: #2d9cdb;\r\n            --color-primary-dark: #1e7bb4;\r\n            --color-sidebar: #06162d;\r\n            --color-sidebar-hover: #0a1f3d;\r\n        }\r\n\r\n        /* Custom Scrollbar */\r\n        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }\r\n        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }\r\n\r\n        /* Override Tailwind indigo with custom blue */\r\n        .bg-indigo-600 { background-color: var(--color-primary) !important; }\r\n        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }\r\n        .text-indigo-600 { color: var(--color-primary) !important; }\r\n        .text-indigo-700 { color: var(--color-primary-dark) !important; }\r\n        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }\r\n        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }\r\n        .hover\\:text-indigo-600:hover { color: var(--color-primary) !important; }\r\n        .hover\\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }\r\n        .hover\\:bg-indigo-100:hover { background-color: rgba(45, 156, 219, 0.15) !important; }\r\n        .focus\\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }\r\n        .focus\\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }\r\n        .focus\\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }\r\n\r\n        /* D3 Chart Styles */\r\n        .axis line, .axis path {\r\n            stroke: #cbd5e1;\r\n            shape-rendering: crispEdges;\r\n        }\r\n\r\n        .axis text {\r\n            fill: #64748b;\r\n            font-size: 11px;\r\n            font-weight: 500;\r\n        }\r\n\r\n        .grid line {\r\n            stroke: #e2e8f0;\r\n            stroke-opacity: 0.7;\r\n            shape-rendering: crispEdges;\r\n        }\r\n\r\n        .line {\r\n            fill: none;\r\n            stroke-width: 2.5px;\r\n        }\r\n\r\n        .area {\r\n            opacity: 0.3;\r\n        }\r\n\r\n        .tooltip {\r\n            position: absolute;\r\n            background: rgba(15, 23, 42, 0.95);\r\n            color: white;\r\n            padding: 12px 16px;\r\n            border-radius: 8px;\r\n            font-size: 13px;\r\n            pointer-events: none;\r\n            opacity: 0;\r\n            transition: opacity 0.2s;\r\n            z-index: 1000;\r\n            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);\r\n            max-width: 300px;\r\n        }\r\n\r\n        .tooltip-label {\r\n            color: #94a3b8;\r\n            display: inline-block;\r\n            min-width: 90px;\r\n            font-weight: 500;\r\n        }\r\n\r\n        .tooltip-value {\r\n            color: #ffffff;\r\n            font-weight: 600;\r\n            margin-left: 8px;\r\n        }\r\n\r\n        /* Loading spinner */\r\n        .spinner {\r\n            border: 3px solid #f1f5f9;\r\n            border-top: 3px solid var(--color-primary);\r\n            border-radius: 50%;\r\n            width: 40px;\r\n            height: 40px;\r\n            animation: spin 1s linear infinite;\r\n        }\r\n\r\n        @keyframes spin {\r\n            0% { transform: rotate(0deg); }\r\n            100% { transform: rotate(360deg); }\r\n        }\r\n\r\n        /* Status color coding */\r\n        .status-issued { fill: #3b82f6; }\r\n        .status-partial { fill: #f59e0b; }\r\n        .status-fulfilled { fill: #10b981; }\r\n        .status-overdue { fill: #ef4444; }\r\n\r\n        /* Order link styling */\r\n        .order-link {\r\n            color: var(--color-primary);\r\n            text-decoration: none;\r\n            font-weight: 600;\r\n            transition: color 0.2s ease;\r\n        }\r\n\r\n        .order-link:hover {\r\n            color: var(--color-primary-dark);\r\n            text-decoration: underline;\r\n        }\r\n    </style>\r\n</head>\r\n<body class=\"bg-slate-50\">\r\n    <div class=\"flex flex-col h-screen\">\r\n        <!-- Header -->\r\n        <header class=\"h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm\">\r\n            <div class=\"flex items-center gap-6\">\r\n                <div>\r\n                    <h1 class=\"text-xl font-bold text-slate-900\">\r\n                        Purchasing Dashboard\r\n                        <span id=\"dateRangeDisplay\" class=\"text-sm font-normal text-slate-500 ml-2\"></span>\r\n                    </h1>\r\n                    <p class=\"text-xs text-slate-500 mt-0.5\">Purchase orders, vendor performance, and spend analytics</p>\r\n                </div>\r\n\r\n                <!-- KPI Summary in Header -->\r\n                <div id=\"kpiCards\" class=\"hidden lg:flex items-center gap-3\">\r\n                    <!-- Will be populated dynamically -->\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"flex items-center gap-3\">\r\n                <!-- Export Button -->\r\n                <button onclick=\"exportToCSV()\" class=\"px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors\" title=\"Export CSV\">\r\n                    <svg class=\"w-4 h-4 inline mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path>\r\n                    </svg>\r\n                    Export\r\n                </button>\r\n\r\n                <!-- Refresh Button -->\r\n                <button onclick=\"loadDashboard()\" class=\"p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all\" title=\"Refresh Data\">\r\n                    <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\"></path>\r\n                    </svg>\r\n                </button>\r\n            </div>\r\n        </header>\r\n\r\n        <!-- Content Area -->\r\n        <div class=\"flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8\">\r\n            <!-- Filters Section -->\r\n            <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-4 mb-4\">\r\n                <div class=\"flex items-center justify-between mb-3\">\r\n                    <h3 class=\"text-base font-bold text-slate-800 flex items-center gap-2\">\r\n                        <svg class=\"w-4 h-4 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\"></path>\r\n                        </svg>\r\n                        <span>Filters</span>\r\n                        <button onclick=\"clearAllFilters()\" class=\"ml-2 px-2 py-1 text-xs text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex items-center gap-1\" title=\"Clear All Filters\">\r\n                            <svg class=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                            </svg>\r\n                            Clear\r\n                        </button>\r\n                    </h3>\r\n\r\n                    <!-- Date Range Selector -->\r\n                    <div class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200\">\r\n                        <svg class=\"w-4 h-4 text-slate-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\"></path>\r\n                        </svg>\r\n                        <select id=\"dateRangeFilter\" onchange=\"applyDateRange()\" class=\"px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700 font-semibold\" style=\"width: 180px;\">\r\n                            <option value=\"30\">Last 30 Days</option>\r\n                            <option value=\"60\">Last 60 Days</option>\r\n                            <option value=\"90\">Last 90 Days</option>\r\n                            <option value=\"180\">Last 180 Days</option>\r\n                            <option value=\"365\">Last Year</option>\r\n                            <option value=\"this_quarter\">This Quarter</option>\r\n                            <option value=\"last_quarter\">Last Quarter</option>\r\n                            <option value=\"current_fy\" selected>Current Financial Year</option>\r\n                            <option value=\"last_fy\">Last Financial Year</option>\r\n                            <option value=\"custom\">Custom Date Range</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Filter Controls -->\r\n                <div class=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3\">\r\n                    <!-- Vendor Filter -->\r\n                    <div>\r\n                        <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">Vendor</label>\r\n                        <select id=\"vendorFilter\" onchange=\"loadDashboard()\" class=\"w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300\">\r\n                            <option value=\"%\">All Vendors</option>\r\n                        </select>\r\n                    </div>\r\n\r\n                    <!-- Product Category Filter -->\r\n                    <div>\r\n                        <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">Product Category</label>\r\n                        <select id=\"productCategoryFilter\" onchange=\"loadDashboard()\" class=\"w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300\">\r\n                            <option value=\"%\">All Categories</option>\r\n                        </select>\r\n                    </div>\r\n\r\n                    <!-- ABC Code Filter -->\r\n                    <div>\r\n                        <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">ABC Code</label>\r\n                        <select id=\"abcCodeFilter\" onchange=\"loadDashboard()\" class=\"w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300\">\r\n                            <option value=\"%\">All</option>\r\n                            <option value=\"A\">A - High Value</option>\r\n                            <option value=\"B\">B - Medium Value</option>\r\n                            <option value=\"C\">C - Low Value</option>\r\n                            <option value=\"N\">N - None</option>\r\n                        </select>\r\n                    </div>\r\n\r\n                    <!-- Location Group Filter -->\r\n                    <div>\r\n                        <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">Location</label>\r\n                        <select id=\"locationFilter\" onchange=\"loadDashboard()\" class=\"w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300\">\r\n                            <option value=\"%\">All Locations</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Custom Date Range (Hidden by default) -->\r\n                <div id=\"customDateRangeContainer\" class=\"mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200\" style=\"display: none;\">\r\n                    <div class=\"grid grid-cols-2 gap-3\">\r\n                        <div>\r\n                            <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">Start Date</label>\r\n                            <input type=\"date\" id=\"customStartDate\" class=\"w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300\">\r\n                        </div>\r\n                        <div>\r\n                            <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">End Date</label>\r\n                            <input type=\"date\" id=\"customEndDate\" class=\"w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300\">\r\n                        </div>\r\n                    </div>\r\n                    <button onclick=\"applyCustomDateRange()\" class=\"mt-2 px-3 py-1.5 bg-indigo-600 text-white text-xs font-medium rounded-lg hover:bg-indigo-700 transition-colors\">Apply Date Range</button>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Dashboard Content -->\r\n            <div id=\"dashboardContent\">\r\n                <!-- Row 1: Main Chart + Status Overview -->\r\n                <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4\">\r\n                    <!-- Monthly PO Spend Trend (2-col span) -->\r\n                    <div class=\"lg:col-span-2 bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <div class=\"flex items-center justify-between mb-4\">\r\n                            <h3 class=\"text-lg font-bold text-slate-800\">Monthly PO Spend Trend</h3>\r\n                            <div class=\"flex gap-2\">\r\n                                <button id=\"spendLineBtn\" onclick=\"toggleSpendChartMode('line')\" class=\"p-2 rounded bg-white text-slate-800 border border-slate-300 hover:bg-slate-50 transition-colors\" title=\"Line Chart\">\r\n                                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                                <button id=\"spendBarBtn\" onclick=\"toggleSpendChartMode('bar')\" class=\"p-2 rounded text-slate-600 border border-slate-300 hover:bg-slate-50 transition-colors\" title=\"Bar Chart\">\r\n                                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                        <div id=\"monthlySpendChart\"></div>\r\n                    </div>\r\n\r\n                    <!-- PO Status Overview -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <h3 class=\"text-lg font-bold text-slate-800 mb-4\">PO Status Overview</h3>\r\n                        <div id=\"poStatusChart\"></div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Row 2: Upcoming & Alerts (PRIORITIZED) -->\r\n                <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4\">\r\n                    <!-- Expected Receipts This Week -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <div class=\"flex items-center justify-between mb-4\">\r\n                            <div>\r\n                                <h3 class=\"text-lg font-bold text-slate-800\">Expected Receipts</h3>\r\n                                <p class=\"text-xs text-slate-500\">Next 7 days</p>\r\n                            </div>\r\n                            <div id=\"expectedReceiptsMetric\" class=\"text-right\">\r\n                                <div class=\"text-4xl font-bold text-blue-600\">-</div>\r\n                                <div class=\"text-xs text-slate-500 mt-1\">POs</div>\r\n                            </div>\r\n                        </div>\r\n                        <div id=\"expectedReceiptsChart\"></div>\r\n                    </div>\r\n\r\n                    <!-- Overdue POs -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <div class=\"flex items-center justify-between mb-4\">\r\n                            <div>\r\n                                <h3 class=\"text-lg font-bold text-slate-800\">Overdue POs</h3>\r\n                                <p class=\"text-xs text-slate-500\">Past due date</p>\r\n                            </div>\r\n                            <div id=\"overduePOsMetric\" class=\"text-right\">\r\n                                <div class=\"text-4xl font-bold text-red-600\">-</div>\r\n                                <div class=\"text-xs text-slate-500 mt-1\">POs</div>\r\n                            </div>\r\n                        </div>\r\n                        <div id=\"overduePOsChart\"></div>\r\n                    </div>\r\n\r\n                    <!-- Recently Received -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <div class=\"flex items-center justify-between mb-4\">\r\n                            <div>\r\n                                <h3 class=\"text-lg font-bold text-slate-800\">Recently Received</h3>\r\n                                <p class=\"text-xs text-slate-500\">Last 10 receipts</p>\r\n                            </div>\r\n                            <div id=\"recentlyReceivedMetric\" class=\"text-right\">\r\n                                <div class=\"text-4xl font-bold text-green-600\">-</div>\r\n                                <div class=\"text-xs text-slate-500 mt-1\">POs</div>\r\n                            </div>\r\n                        </div>\r\n                        <div id=\"recentlyReceivedChart\"></div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Row 3: Vendor Performance -->\r\n                <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4\">\r\n                    <!-- Top Vendors by Spend -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <h3 class=\"text-lg font-bold text-slate-800 mb-4\">Top Vendors by Spend</h3>\r\n                        <div id=\"topVendorsSpendChart\"></div>\r\n                    </div>\r\n\r\n                    <!-- Top Vendors by PO Count -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <h3 class=\"text-lg font-bold text-slate-800 mb-4\">Top Vendors by PO Count</h3>\r\n                        <div id=\"topVendorsCountChart\"></div>\r\n                    </div>\r\n\r\n                    <!-- Vendor On-Time Performance -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <h3 class=\"text-lg font-bold text-slate-800 mb-4\">Vendor On-Time %</h3>\r\n                        <div id=\"vendorOnTimeChart\"></div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Row 4: Product & Analytics -->\r\n                <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4\">\r\n                    <!-- Top Products by Quantity -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <h3 class=\"text-lg font-bold text-slate-800 mb-4\">Top Products by Qty</h3>\r\n                        <div id=\"topProductsChart\"></div>\r\n                    </div>\r\n\r\n                    <!-- Purchases by Category -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <h3 class=\"text-lg font-bold text-slate-800 mb-4\">Purchases by Category</h3>\r\n                        <div id=\"categoryChart\"></div>\r\n                    </div>\r\n\r\n                    <!-- High Value POs -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <div class=\"flex items-center justify-between mb-4\">\r\n                            <div>\r\n                                <h3 class=\"text-lg font-bold text-slate-800\">High Value POs</h3>\r\n                                <p class=\"text-xs text-slate-500\">Orders over $10,000</p>\r\n                            </div>\r\n                            <div id=\"highValueMetric\" class=\"text-right\">\r\n                                <div class=\"text-4xl font-bold text-purple-600\">-</div>\r\n                                <div class=\"text-xs text-slate-500 mt-1\">POs</div>\r\n                            </div>\r\n                        </div>\r\n                        <div id=\"highValueChart\"></div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Debug Console (hidden by default, shown if BI_SHOW_DEBUG=true) -->\r\n                <div id=\"debugConsoleContainer\" class=\"mt-6\" style=\"display: none;\">\r\n                    <div class=\"bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden\">\r\n                        <button onclick=\"toggleDebugConsole()\" class=\"w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors\">\r\n                            <div class=\"flex items-center gap-2\">\r\n                                <svg class=\"w-4 h-4 text-slate-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4\"></path>\r\n                                </svg>\r\n                                <span class=\"text-sm font-semibold text-slate-700\">Debug Console</span>\r\n                                <span class=\"text-xs text-slate-400 font-normal\">Auto-scrolls to latest entry</span>\r\n                            </div>\r\n                            <svg id=\"debugChevron\" class=\"w-5 h-5 text-slate-400 transition-transform\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 9l-7 7-7-7\"></path>\r\n                            </svg>\r\n                        </button>\r\n\r\n                        <div id=\"debugContent\" class=\"hidden border-t border-slate-200\">\r\n                            <div class=\"bg-slate-900 px-4 py-2 flex items-center justify-between\">\r\n                                <span class=\"text-xs text-slate-400 font-mono\">Query & Application Diagnostics</span>\r\n                                <button onclick=\"clearDebugLog()\" class=\"text-xs text-slate-400 hover:text-white transition-colors\">\r\n                                    Clear\r\n                                </button>\r\n                            </div>\r\n                            <div id=\"debugLog\" class=\"bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto\" style=\"scrollbar-width: thin;\">\r\n                                <div class=\"text-slate-500 italic\">Waiting for application to initialize...</div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Loading Overlay -->\r\n    <div id=\"loadingOverlay\" class=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\" style=\"display: none;\">\r\n        <div class=\"bg-white rounded-xl p-8 flex flex-col items-center gap-4\">\r\n            <div class=\"spinner\"></div>\r\n            <p class=\"text-slate-700 font-semibold\">Loading purchasing data...</p>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Drilldown Modal -->\r\n    <div id=\"drilldownModal\" class=\"fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center\" onclick=\"closeDrilldown(event)\">\r\n        <div class=\"bg-white rounded-2xl shadow-2xl w-11/12 max-w-6xl max-h-[90vh] flex flex-col\" onclick=\"event.stopPropagation()\">\r\n            <!-- Modal Header -->\r\n            <div class=\"flex items-center justify-between px-6 py-4 border-b border-slate-200\">\r\n                <div>\r\n                    <h2 id=\"drilldownTitle\" class=\"text-xl font-bold text-slate-800\"></h2>\r\n                    <div id=\"drilldownBreadcrumb\" class=\"text-sm text-slate-500 mt-1\"></div>\r\n                </div>\r\n                <div class=\"flex items-center gap-2\">\r\n                    <button onclick=\"exportDrilldownData()\" class=\"px-3 py-2 text-sm font-semibold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all flex items-center gap-2\">\r\n                        <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path>\r\n                        </svg>\r\n                        Export CSV\r\n                    </button>\r\n                    <button onclick=\"closeDrilldown()\" class=\"p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                        </svg>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Modal Body -->\r\n            <div class=\"flex-1 overflow-auto px-6 py-4\">\r\n                <!-- Search Box -->\r\n                <div class=\"mb-4\">\r\n                    <input type=\"text\" id=\"drilldownSearch\" placeholder=\"Search...\" class=\"w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500\" oninput=\"filterDrilldownTable()\">\r\n                </div>\r\n\r\n                <!-- Table -->\r\n                <div class=\"overflow-x-auto\">\r\n                    <table id=\"drilldownTable\" class=\"w-full text-sm\">\r\n                        <thead id=\"drilldownTableHead\" class=\"bg-slate-50 sticky top-0\">\r\n                            <!-- Dynamic headers -->\r\n                        </thead>\r\n                        <tbody id=\"drilldownTableBody\" class=\"divide-y divide-slate-200\">\r\n                            <!-- Dynamic rows -->\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <script>\r\n        // Global variables\r\n        let currentDateRange = 'current_fy';\r\n        let customStartDate = null;\r\n        let customEndDate = null;\r\n\r\n        // Financial Year start month (1-12, default 7 = July)\r\n        // Configure via Fishbowl property: BI_FY_START_MONTH\r\n        const FY_START_MONTH = parseInt(getProperty('BI_FY_START_MONTH', '7')) || 7;\r\n\r\n        // Debug mode from Fishbowl system property (default to false)\r\n        const BI_SHOW_DEBUG_PROP = typeof getProperty === 'function' ? getProperty('BI_SHOW_DEBUG', 'false') : 'false';\r\n        const DEBUG_MODE = BI_SHOW_DEBUG_PROP === 'true' || BI_SHOW_DEBUG_PROP === true;\r\n\r\n        // Date format from Fishbowl system property (default to US format)\r\n        const FB_DATE_FORMAT = typeof getProperty === 'function' ? getProperty('DateFormatShort', 'MM/dd/yyyy') : 'MM/dd/yyyy';\r\n        // Convert Java SimpleDateFormat to moment.js format (dd -> DD, yyyy -> YYYY)\r\n        const MOMENT_DATE_FORMAT = FB_DATE_FORMAT\r\n            .replace(/yyyy/g, 'YYYY')\r\n            .replace(/yy/g, 'YY')\r\n            .replace(/dd/g, 'DD');\r\n\r\n        // Price formatting from Fishbowl system property\r\n        // Format: \"$ #,##0.00\" - currency symbol followed by number format\r\n        const PRICE_FORMAT = getProperty('REPORT_DECIMAL_PRICE', '$ #,##0.00');\r\n\r\n        // Parse the price format to extract currency symbol and decimal places\r\n        const CURRENCY_SYMBOL = PRICE_FORMAT.match(/^[^#0,.\\s]+/) ? PRICE_FORMAT.match(/^[^#0,.\\s]+/)[0].trim() : '$';\r\n        const DECIMAL_PLACES = (PRICE_FORMAT.match(/\\.([0#]+)$/) || ['', '00'])[1].length;\r\n\r\n        // Global currency formatting function\r\n        function formatCurrency(value, showDecimals = true) {\r\n            const num = parseFloat(value || 0);\r\n            const isNegative = num < 0;\r\n            const absValue = Math.abs(num);\r\n            const decimals = showDecimals ? DECIMAL_PLACES : 0;\r\n            const formatted = absValue.toLocaleString('en-US', {\r\n                minimumFractionDigits: decimals,\r\n                maximumFractionDigits: decimals\r\n            });\r\n            return isNegative ? `-${CURRENCY_SYMBOL}${formatted}` : `${CURRENCY_SYMBOL}${formatted}`;\r\n        }\r\n\r\n        // Color palette for charts\r\n        const colorPalette = [\r\n            '#2d9cdb', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',\r\n            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'\r\n        ];\r\n\r\n        // Drilldown state\r\n        let currentDrilldownData = [];\r\n        let currentDrilldownColumns = [];\r\n        let currentSortColumn = null;\r\n        let currentSortDirection = 'asc';\r\n\r\n        // PO Status chart state - track which statuses are hidden\r\n        let hiddenStatuses = new Set(['Fulfilled', 'Closed Short']); // Hide Fulfilled and Closed Short by default\r\n        let poStatusData = []; // Store the full dataset for re-rendering\r\n\r\n        // Tooltip element\r\n        const tooltip = d3.select('body')\r\n            .append('div')\r\n            .attr('class', 'tooltip')\r\n            .style('opacity', 0);\r\n\r\n        // Initialize on page load\r\n        window.addEventListener('DOMContentLoaded', function() {\r\n            // Show debug console if DEBUG_MODE is enabled\r\n            if (DEBUG_MODE) {\r\n                document.getElementById('debugConsoleContainer').style.display = 'block';\r\n            }\r\n\r\n            console.log('Purchasing Dashboard initializing...');\r\n\r\n            // Set default date range to Current Financial Year\r\n            const fyDates = getFYDates(0);\r\n            customStartDate = fyDates.start;\r\n            customEndDate = fyDates.end;\r\n            document.getElementById('dateRangeFilter').value = 'current_fy';\r\n            document.getElementById('customStartDate').value = fyDates.start;\r\n            document.getElementById('customEndDate').value = fyDates.end;\r\n\r\n            loadFilters();\r\n            loadDashboard();\r\n        });\r\n\r\n        // ============================================\r\n        // Date Helper Functions\r\n        // ============================================\r\n        function getDateRange() {\r\n            return {\r\n                start: customStartDate,\r\n                end: customEndDate\r\n            };\r\n        }\r\n\r\n        function getDateCondition() {\r\n            if (customStartDate && customEndDate) {\r\n                return `postpo.postdate BETWEEN '${customStartDate}' AND '${customEndDate}'`;\r\n            }\r\n\r\n            const rangeValue = document.getElementById('dateRangeFilter').value;\r\n\r\n            if (rangeValue === 'this_quarter') {\r\n                const dates = getQuarterDates(0);\r\n                return `postpo.postdate BETWEEN '${dates.start}' AND '${dates.end}'`;\r\n            } else if (rangeValue === 'last_quarter') {\r\n                const dates = getQuarterDates(1);\r\n                return `postpo.postdate BETWEEN '${dates.start}' AND '${dates.end}'`;\r\n            } else if (rangeValue === 'current_fy') {\r\n                const dates = getFYDates(0);\r\n                return `postpo.postdate BETWEEN '${dates.start}' AND '${dates.end}'`;\r\n            } else if (rangeValue === 'last_fy') {\r\n                const dates = getFYDates(1);\r\n                return `postpo.postdate BETWEEN '${dates.start}' AND '${dates.end}'`;\r\n            }\r\n\r\n            const days = parseInt(rangeValue) || 90;\r\n            return `postpo.postdate >= DATE_SUB(CURDATE(), INTERVAL ${days} DAY)`;\r\n        }\r\n\r\n        function getQuarterDates(quartersAgo) {\r\n            // Use moment's built-in quarter handling for proper year rollover\r\n            const now = moment();\r\n            const currentQuarterStart = moment(now).startOf('quarter');\r\n            const targetQuarterStart = moment(currentQuarterStart).subtract(quartersAgo, 'quarters');\r\n\r\n            const start = targetQuarterStart.startOf('quarter').format('YYYY-MM-DD');\r\n            const end = moment(targetQuarterStart).endOf('quarter').format('YYYY-MM-DD');\r\n\r\n            return { start, end };\r\n        }\r\n\r\n        function getFYDates(yearsAgo) {\r\n            // Financial Year: Configurable via BI_FY_START_MONTH property (1-12)\r\n            // Default: July (7) to June (6) - Australian/UK financial year\r\n            const now = moment();\r\n            const currentMonth = now.month() + 1; // Convert 0-11 to 1-12\r\n            const currentYear = now.year();\r\n\r\n            // FY_START_MONTH is 1-12 (e.g., 7 = July, 10 = October, 1 = January)\r\n            const fyStartMonth = Math.max(1, Math.min(12, FY_START_MONTH));\r\n\r\n            // Determine which FY we're currently in\r\n            let fyStartYear = currentMonth >= fyStartMonth ? currentYear : currentYear - 1;\r\n            fyStartYear -= yearsAgo;\r\n\r\n            // Calculate end month and year\r\n            let fyEndMonth, fyEndYear;\r\n            if (fyStartMonth === 1) {\r\n                // January start = calendar year (Jan-Dec)\r\n                fyEndMonth = 12;\r\n                fyEndYear = fyStartYear;\r\n            } else {\r\n                fyEndMonth = fyStartMonth - 1;\r\n                fyEndYear = fyStartYear + 1;\r\n            }\r\n\r\n            // Get the last day of the end month\r\n            const endDate = moment([fyEndYear, fyEndMonth - 1, 1]).endOf('month');\r\n\r\n            return {\r\n                start: `${fyStartYear}-${String(fyStartMonth).padStart(2, '0')}-01`,\r\n                end: endDate.format('YYYY-MM-DD')\r\n            };\r\n        }\r\n\r\n        // ============================================\r\n        // Filter Building Functions\r\n        // ============================================\r\n        function buildFilterConditions() {\r\n            const vendor = document.getElementById('vendorFilter').value;\r\n            const productCategory = document.getElementById('productCategoryFilter').value;\r\n            const abcCode = document.getElementById('abcCodeFilter').value;\r\n            const location = document.getElementById('locationFilter').value;\r\n\r\n            let conditions = `WHERE ${getDateCondition()}`;\r\n\r\n            if (vendor !== '%') {\r\n                conditions += ` AND vendor.id = ${parseInt(vendor)}`;\r\n            }\r\n            if (productCategory !== '%') {\r\n                conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;\r\n            }\r\n            if (abcCode !== '%') {\r\n                conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;\r\n            }\r\n            if (location !== '%') {\r\n                conditions += ` AND locationgroup.id = ${parseInt(location)}`;\r\n            }\r\n\r\n            return conditions;\r\n        }\r\n\r\n        // ============================================\r\n        // Filter Loading Functions\r\n        // ============================================\r\n        function loadFilters() {\r\n            debugLog('Loading filter dropdowns...', 'info');\r\n\r\n            // Load Vendors\r\n            const vendorQuery = `\r\n                SELECT DISTINCT vendor.id, vendor.name\r\n                FROM po\r\n                JOIN vendor ON vendor.id = po.vendorid\r\n                WHERE vendor.activeFlag = 1\r\n                ORDER BY vendor.name\r\n            `;\r\n            try {\r\n                const vendors = JSON.parse(runQuery(vendorQuery));\r\n                const vendorSelector = document.getElementById('vendorFilter');\r\n                vendorSelector.innerHTML = '<option value=\"%\">All Vendors</option>';\r\n                vendors.forEach(v => {\r\n                    vendorSelector.innerHTML += `<option value=\"${v.id}\">${v.name}</option>`;\r\n                });\r\n                debugLog(`Loaded ${vendors.length} vendors`, 'success');\r\n            } catch (error) {\r\n                debugLog('Error loading vendors: ' + error, 'error');\r\n            }\r\n\r\n            // Load Product Categories\r\n            const categoryQuery = `\r\n                SELECT DISTINCT ProductTree.Name as name\r\n                FROM part\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                WHERE ProductTree.Name IS NOT NULL\r\n                ORDER BY ProductTree.Name\r\n            `;\r\n            try {\r\n                const categories = JSON.parse(runQuery(categoryQuery));\r\n                const categorySelector = document.getElementById('productCategoryFilter');\r\n                categorySelector.innerHTML = '<option value=\"%\">All Categories</option>';\r\n                categories.forEach(c => {\r\n                    if (c.name) categorySelector.innerHTML += `<option value=\"${c.name}\">${c.name}</option>`;\r\n                });\r\n                debugLog(`Loaded ${categories.length} categories`, 'success');\r\n            } catch (error) {\r\n                debugLog('Error loading categories: ' + error, 'error');\r\n            }\r\n\r\n            // Load Location Groups\r\n            const locationQuery = `\r\n                SELECT DISTINCT locationgroup.id, locationgroup.name\r\n                FROM locationgroup\r\n                WHERE locationgroup.activeFlag = 1\r\n                ORDER BY locationgroup.name\r\n            `;\r\n            try {\r\n                const locations = JSON.parse(runQuery(locationQuery));\r\n                const locationSelector = document.getElementById('locationFilter');\r\n                locationSelector.innerHTML = '<option value=\"%\">All Locations</option>';\r\n                locations.forEach(l => {\r\n                    locationSelector.innerHTML += `<option value=\"${l.id}\">${l.name}</option>`;\r\n                });\r\n                debugLog(`Loaded ${locations.length} locations`, 'success');\r\n            } catch (error) {\r\n                debugLog('Error loading locations: ' + error, 'error');\r\n            }\r\n        }\r\n\r\n        // ============================================\r\n        // KPI Metrics Query\r\n        // ============================================\r\n        function getKPIMetrics() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    SUM(postpoitem.postedtotalcost) as total_spend,\r\n                    COUNT(DISTINCT po.num) as po_count,\r\n                    AVG(po_totals.po_total) as avg_po_value\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                LEFT JOIN (\r\n                    SELECT\r\n                        po.id as po_id,\r\n                        SUM(postpoitem.postedtotalcost) as po_total\r\n                    FROM postpoitem\r\n                    JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                    JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                    JOIN po ON poitem.poid = po.id\r\n                    GROUP BY po.id\r\n                ) as po_totals ON po_totals.po_id = po.id\r\n                ${conditions}\r\n            `;\r\n\r\n            debugLog('KPI Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // ============================================\r\n        // Main Dashboard Loading Function\r\n        // ============================================\r\n        function loadDashboard() {\r\n            debugLog('Loading dashboard data...', 'info');\r\n            const loading = document.getElementById('loadingOverlay');\r\n            loading.style.display = 'flex';\r\n\r\n            try {\r\n                // Load KPIs (including average lead time)\r\n                const kpiData = getKPIMetrics();\r\n                const avgLeadTimeData = getAverageLeadTime();\r\n                updateKPIs(kpiData, avgLeadTimeData);\r\n\r\n                // Load all charts and tiles\r\n                const monthlySpendData = getMonthlySpend();\r\n                renderMonthlySpendChart(monthlySpendData);\r\n\r\n                const poStatusData = getPOStatusBreakdown();\r\n                renderPOStatusChart(poStatusData);\r\n\r\n                const expectedReceiptsData = getExpectedReceipts();\r\n                renderExpectedReceiptsChart(expectedReceiptsData);\r\n\r\n                const overduePOsData = getOverduePOs();\r\n                renderOverduePOsChart(overduePOsData);\r\n\r\n                const recentlyReceivedData = getRecentlyReceived();\r\n                renderRecentlyReceivedChart(recentlyReceivedData);\r\n\r\n                const topVendorsSpendData = getTopVendorsBySpend();\r\n                renderTopVendorsSpendChart(topVendorsSpendData);\r\n\r\n                const topVendorsCountData = getTopVendorsByCount();\r\n                renderTopVendorsCountChart(topVendorsCountData);\r\n\r\n                const vendorOnTimeData = getVendorOnTimePerformance();\r\n                renderVendorOnTimeChart(vendorOnTimeData);\r\n\r\n                const topProductsData = getTopProducts();\r\n                renderTopProductsChart(topProductsData);\r\n\r\n                const categoryData = getPurchasesByCategory();\r\n                renderCategoryChart(categoryData);\r\n\r\n                const highValueData = getHighValuePOs();\r\n                renderHighValueChart(highValueData);\r\n\r\n                debugLog('Dashboard loaded successfully', 'success');\r\n            } catch (error) {\r\n                console.error('Error loading dashboard:', error);\r\n                alert('Error loading purchasing data. Please check console for details.');\r\n            } finally {\r\n                loading.style.display = 'none';\r\n                updateDateRangeDisplay();\r\n            }\r\n        }\r\n\r\n        // ============================================\r\n        // KPI Display Update\r\n        // ============================================\r\n        function updateKPIs(data, avgLeadTimeData) {\r\n            if (!data || data.length === 0) return;\r\n\r\n            const metrics = data[0];\r\n            const kpiCardsContainer = document.getElementById('kpiCards');\r\n\r\n            const totalSpend = formatCurrency(metrics.total_spend || 0, false);\r\n            const poCount = (metrics.po_count || 0).toLocaleString();\r\n            const avgPOValue = formatCurrency(metrics.avg_po_value || 0, false);\r\n\r\n            // Get average lead time\r\n            let avgLeadTime = 'N/A';\r\n            if (avgLeadTimeData && avgLeadTimeData.length > 0 && avgLeadTimeData[0].avg_lead_time !== null) {\r\n                avgLeadTime = Math.round(avgLeadTimeData[0].avg_lead_time) + ' days';\r\n            }\r\n\r\n            kpiCardsContainer.innerHTML = `\r\n                <div class=\"flex items-center gap-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg\">\r\n                    <svg class=\"w-4 h-4 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                    </svg>\r\n                    <span class=\"text-xs font-semibold text-slate-600\">Total Spend:</span>\r\n                    <span class=\"text-sm font-bold text-slate-900\">${totalSpend}</span>\r\n                </div>\r\n                <div class=\"flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg\">\r\n                    <svg class=\"w-4 h-4 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path>\r\n                    </svg>\r\n                    <span class=\"text-xs font-semibold text-slate-600\">POs Received:</span>\r\n                    <span class=\"text-sm font-bold text-slate-900\">${poCount}</span>\r\n                </div>\r\n                <div class=\"flex items-center gap-2 px-3 py-2 bg-purple-50 border border-purple-200 rounded-lg\">\r\n                    <svg class=\"w-4 h-4 text-purple-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z\"></path>\r\n                    </svg>\r\n                    <span class=\"text-xs font-semibold text-slate-600\">Avg PO:</span>\r\n                    <span class=\"text-sm font-bold text-slate-900\">${avgPOValue}</span>\r\n                </div>\r\n                <div class=\"flex items-center gap-2 px-3 py-2 bg-indigo-50 border border-indigo-200 rounded-lg\">\r\n                    <svg class=\"w-4 h-4 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                    </svg>\r\n                    <span class=\"text-xs font-semibold text-slate-600\">Avg Lead Time:</span>\r\n                    <span class=\"text-sm font-bold text-slate-900\">${avgLeadTime}</span>\r\n                </div>\r\n            `;\r\n        }\r\n\r\n        // ============================================\r\n        // Data Query Functions\r\n        // ============================================\r\n        // NOTE: KPI and spend metrics use postpoitem table, which only includes received POs\r\n        // This automatically excludes Bid status (10) and un-received POs from spend calculations\r\n\r\n        // Monthly PO Spend Trend\r\n        function getMonthlySpend() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    DATE_FORMAT(postpo.postdate, '%Y-%m') as month,\r\n                    SUM(postpoitem.postedtotalcost) as total_spend\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                GROUP BY month\r\n                ORDER BY month\r\n            `;\r\n            debugLog('Monthly Spend Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // PO Status Overview - Shows distribution across all active PO statuses\r\n        // Only filters by vendor, location, and date - not by product category/ABC (since POs contain multiple parts)\r\n        function getPOStatusBreakdown() {\r\n            try {\r\n                const vendor = document.getElementById('vendorFilter').value;\r\n                const location = document.getElementById('locationFilter').value;\r\n\r\n                const { start, end } = getDateRange();\r\n\r\n                // Include all statuses for overview: Bid(10), Issued(20), Picking(30), Partial(40), Fulfilled(60), Closed Short(70), Historical(80), Void(95)\r\n                let conditions = `WHERE postatus.id IN (10, 20, 30, 40, 60, 70, 80, 95)`;\r\n\r\n                // Date filter based on date range\r\n                if (start && end) {\r\n                    conditions += ` AND po.dateIssued BETWEEN '${start}' AND '${end}'`;\r\n                    debugLog(`Date range: ${start} to ${end}`, 'info');\r\n                }\r\n\r\n                if (vendor !== '%') {\r\n                    conditions += ` AND vendor.id = ${parseInt(vendor)}`;\r\n                    debugLog(`Vendor filter: ${vendor}`, 'info');\r\n                }\r\n                if (location !== '%') {\r\n                    conditions += ` AND locationgroup.id = ${parseInt(location)}`;\r\n                    debugLog(`Location filter: ${location}`, 'info');\r\n                }\r\n\r\n                const query = `\r\n                    SELECT\r\n                        postatus.id as status_id,\r\n                        postatus.name as status_name,\r\n                        COUNT(DISTINCT po.id) as po_count\r\n                    FROM po\r\n                    JOIN postatus ON po.statusid = postatus.id\r\n                    JOIN vendor ON po.vendorid = vendor.id\r\n                    JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                    ${conditions}\r\n                    GROUP BY postatus.name, postatus.id\r\n                    ORDER BY postatus.id\r\n                `;\r\n                debugLog('PO Status Query: ' + query, 'info');\r\n\r\n                const result = runQuery(query);\r\n                debugLog('PO Status query result received: ' + (result ? result.length + ' chars' : 'null'), result ? 'success' : 'error');\r\n\r\n                const parsedData = JSON.parse(result);\r\n                debugLog(`PO Status data parsed: ${parsedData.length} statuses found`, 'success');\r\n\r\n                return parsedData;\r\n            } catch (error) {\r\n                debugLog(`ERROR in getPOStatusBreakdown: ${error.message}`, 'error');\r\n                console.error('Full error:', error);\r\n                return [];\r\n            }\r\n        }\r\n\r\n        // Expected Receipts This Week\r\n        function getExpectedReceipts() {\r\n            const vendor = document.getElementById('vendorFilter').value;\r\n            const productCategory = document.getElementById('productCategoryFilter').value;\r\n            const abcCode = document.getElementById('abcCodeFilter').value;\r\n            const location = document.getElementById('locationFilter').value;\r\n\r\n            let conditions = `WHERE po.statusid IN (20, 30, 40)\r\n                AND poitem.dateScheduledFulfillment BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY)`;\r\n\r\n            if (vendor !== '%') {\r\n                conditions += ` AND vendor.id = ${parseInt(vendor)}`;\r\n            }\r\n            if (productCategory !== '%') {\r\n                conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;\r\n            }\r\n            if (abcCode !== '%') {\r\n                conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;\r\n            }\r\n            if (location !== '%') {\r\n                conditions += ` AND locationgroup.id = ${parseInt(location)}`;\r\n            }\r\n\r\n            const query = `\r\n                SELECT\r\n                    po.num as po_num,\r\n                    vendor.name as vendor_name,\r\n                    poitem.dateScheduledFulfillment as due_date,\r\n                    SUM(poitem.qtytofulfill * poitem.unitcost) as po_value\r\n                FROM po\r\n                JOIN poitem ON poitem.poid = po.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                GROUP BY po.num, vendor.name, poitem.dateScheduledFulfillment\r\n                ORDER BY poitem.dateScheduledFulfillment\r\n                LIMIT 100\r\n            `;\r\n            debugLog('Expected Receipts Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Overdue POs\r\n        function getOverduePOs() {\r\n            const vendor = document.getElementById('vendorFilter').value;\r\n            const productCategory = document.getElementById('productCategoryFilter').value;\r\n            const abcCode = document.getElementById('abcCodeFilter').value;\r\n            const location = document.getElementById('locationFilter').value;\r\n\r\n            let conditions = `WHERE po.statusid IN (20, 30, 40)\r\n                AND poitem.dateScheduledFulfillment < CURDATE()`;\r\n\r\n            if (vendor !== '%') {\r\n                conditions += ` AND vendor.id = ${parseInt(vendor)}`;\r\n            }\r\n            if (productCategory !== '%') {\r\n                conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;\r\n            }\r\n            if (abcCode !== '%') {\r\n                conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;\r\n            }\r\n            if (location !== '%') {\r\n                conditions += ` AND locationgroup.id = ${parseInt(location)}`;\r\n            }\r\n\r\n            const query = `\r\n                SELECT\r\n                    po.num as po_num,\r\n                    vendor.name as vendor_name,\r\n                    poitem.dateScheduledFulfillment as due_date,\r\n                    DATEDIFF(CURDATE(), poitem.dateScheduledFulfillment) as days_overdue,\r\n                    SUM(poitem.qtytofulfill * poitem.unitcost) as po_value\r\n                FROM po\r\n                JOIN poitem ON poitem.poid = po.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                GROUP BY po.num, vendor.name, poitem.dateScheduledFulfillment\r\n                ORDER BY days_overdue DESC\r\n                LIMIT 100\r\n            `;\r\n            debugLog('Overdue POs Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Recently Received POs\r\n        function getRecentlyReceived() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    po.num as po_num,\r\n                    vendor.name as vendor_name,\r\n                    postpo.postdate as received_date,\r\n                    SUM(postpoitem.postedtotalcost) as po_value\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                GROUP BY po.num, vendor.name, postpo.postdate\r\n                ORDER BY postpo.postdate DESC\r\n                LIMIT 10\r\n            `;\r\n            debugLog('Recently Received Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Top Vendors by Spend\r\n        function getTopVendorsBySpend() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    vendor.name as vendor_name,\r\n                    SUM(postpoitem.postedtotalcost) as total_spend,\r\n                    COUNT(DISTINCT po.num) as po_count\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                GROUP BY vendor.name\r\n                ORDER BY total_spend DESC\r\n                LIMIT 10\r\n            `;\r\n            debugLog('Top Vendors by Spend Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Top Vendors by PO Count\r\n        function getTopVendorsByCount() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    vendor.name as vendor_name,\r\n                    COUNT(DISTINCT po.num) as po_count,\r\n                    SUM(postpoitem.postedtotalcost) as total_spend\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                GROUP BY vendor.name\r\n                ORDER BY po_count DESC\r\n                LIMIT 10\r\n            `;\r\n            debugLog('Top Vendors by Count Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Vendor On-Time Performance\r\n        function getVendorOnTimePerformance() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    vendor.name as vendor_name,\r\n                    COUNT(*) as total_orders,\r\n                    SUM(CASE WHEN postpo.postdate <= poitem.dateScheduledFulfillment THEN 1 ELSE 0 END) as on_time_orders,\r\n                    ROUND((SUM(CASE WHEN postpo.postdate <= poitem.dateScheduledFulfillment THEN 1 ELSE 0 END) / COUNT(*)) * 100, 1) as on_time_percent\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                AND poitem.dateScheduledFulfillment IS NOT NULL\r\n                GROUP BY vendor.name\r\n                HAVING total_orders >= 3\r\n                ORDER BY on_time_percent DESC\r\n                LIMIT 10\r\n            `;\r\n            debugLog('Vendor On-Time Performance Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Top Products by Quantity\r\n        function getTopProducts() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    poitem.partnum as part_num,\r\n                    poitem.description as part_description,\r\n                    SUM(postpoitem.qty) as total_qty,\r\n                    SUM(postpoitem.postedtotalcost) as total_cost\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                GROUP BY poitem.partnum, poitem.description\r\n                ORDER BY total_qty DESC\r\n                LIMIT 10\r\n            `;\r\n            debugLog('Top Products Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Purchases by Category\r\n        function getPurchasesByCategory() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    COALESCE(ProductTree.Name, 'Uncategorized') as category_name,\r\n                    SUM(postpoitem.postedtotalcost) as total_spend,\r\n                    COUNT(DISTINCT po.num) as po_count\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                GROUP BY ProductTree.Name\r\n                ORDER BY total_spend DESC\r\n                LIMIT 10\r\n            `;\r\n            debugLog('Purchases by Category Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Average Lead Time\r\n        function getAverageLeadTime() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    AVG(DATEDIFF(postpo.postdate, po.dateIssued)) as avg_lead_time\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                AND po.dateIssued IS NOT NULL\r\n                AND postpo.postdate IS NOT NULL\r\n            `;\r\n            debugLog('Average Lead Time Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // High Value POs\r\n        function getHighValuePOs() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    po.num as po_num,\r\n                    vendor.name as vendor_name,\r\n                    postpo.postdate as received_date,\r\n                    SUM(postpoitem.postedtotalcost) as po_value\r\n                FROM postpoitem\r\n                JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                LEFT JOIN part ON poitem.partid = part.id\r\n                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                JOIN po ON poitem.poid = po.id\r\n                JOIN vendor ON po.vendorid = vendor.id\r\n                JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                ${conditions}\r\n                GROUP BY po.num, vendor.name, postpo.postdate\r\n                HAVING po_value >= 10000\r\n                ORDER BY po_value DESC\r\n                LIMIT 100\r\n            `;\r\n            debugLog('High Value POs Query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // ============================================\r\n        // Render Functions (Placeholders)\r\n        // ============================================\r\n\r\n        function renderMonthlySpendChart(data) {\r\n            const container = document.getElementById('monthlySpendChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 20, right: 20, bottom: 40, left: 80 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 200 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleBand()\r\n                .domain(data.map(d => d.month))\r\n                .range([0, width])\r\n                .padding(0.3);\r\n\r\n            const y = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => parseFloat(d.total_spend))])\r\n                .nice()\r\n                .range([height, 0]);\r\n\r\n            // Grid\r\n            svg.append('g')\r\n                .attr('class', 'grid')\r\n                .attr('opacity', 0.1)\r\n                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));\r\n\r\n            if (spendChartMode === 'bar') {\r\n                // Bar chart mode\r\n                svg.selectAll('.bar')\r\n                    .data(data)\r\n                    .enter()\r\n                    .append('rect')\r\n                    .attr('class', 'bar')\r\n                    .attr('x', d => x(d.month))\r\n                    .attr('y', d => y(parseFloat(d.total_spend)))\r\n                    .attr('width', x.bandwidth())\r\n                    .attr('height', d => height - y(parseFloat(d.total_spend)))\r\n                    .attr('fill', colorPalette[0])\r\n                    .attr('rx', 4)\r\n                    .style('cursor', 'pointer')\r\n                    .on('mouseover', function(event, d) {\r\n                        d3.select(this).attr('opacity', 0.8);\r\n                        tooltip.style('opacity', 1)\r\n                            .html(`\r\n                                <div><span class=\"tooltip-label\">Month:</span><span class=\"tooltip-value\">${moment(d.month).format('MMM YYYY')}</span></div>\r\n                                <div><span class=\"tooltip-label\">Total Spend:</span><span class=\"tooltip-value\">${formatCurrency(d.total_spend)}</span></div>\r\n                            `)\r\n                            .style('left', (event.pageX + 10) + 'px')\r\n                            .style('top', (event.pageY - 10) + 'px');\r\n                    })\r\n                    .on('mouseout', function() {\r\n                        d3.select(this).attr('opacity', 1);\r\n                        tooltip.style('opacity', 0);\r\n                    });\r\n            } else {\r\n                // Line chart mode\r\n                const line = d3.line()\r\n                    .x(d => x(d.month) + x.bandwidth() / 2)\r\n                    .y(d => y(parseFloat(d.total_spend)))\r\n                    .curve(d3.curveMonotoneX);\r\n\r\n                svg.append('path')\r\n                    .datum(data)\r\n                    .attr('class', 'line')\r\n                    .attr('d', line)\r\n                    .attr('stroke', colorPalette[0])\r\n                    .attr('stroke-width', 3)\r\n                    .attr('fill', 'none');\r\n\r\n                // Add dots\r\n                svg.selectAll('.dot')\r\n                    .data(data)\r\n                    .enter()\r\n                    .append('circle')\r\n                    .attr('class', 'dot')\r\n                    .attr('cx', d => x(d.month) + x.bandwidth() / 2)\r\n                    .attr('cy', d => y(parseFloat(d.total_spend)))\r\n                    .attr('r', 5)\r\n                    .attr('fill', colorPalette[0])\r\n                    .attr('stroke', 'white')\r\n                    .attr('stroke-width', 2)\r\n                    .style('cursor', 'pointer')\r\n                    .on('mouseover', function(event, d) {\r\n                        d3.select(this).attr('r', 7);\r\n                        tooltip.style('opacity', 1)\r\n                            .html(`\r\n                                <div><span class=\"tooltip-label\">Month:</span><span class=\"tooltip-value\">${moment(d.month).format('MMM YYYY')}</span></div>\r\n                                <div><span class=\"tooltip-label\">Total Spend:</span><span class=\"tooltip-value\">${formatCurrency(d.total_spend)}</span></div>\r\n                            `)\r\n                            .style('left', (event.pageX + 10) + 'px')\r\n                            .style('top', (event.pageY - 10) + 'px');\r\n                    })\r\n                    .on('mouseout', function() {\r\n                        d3.select(this).attr('r', 5);\r\n                        tooltip.style('opacity', 0);\r\n                    });\r\n            }\r\n\r\n            // Axes\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).tickFormat(d => moment(d).format('MMM YY')))\r\n                .selectAll('text')\r\n                .style('text-anchor', 'end')\r\n                .attr('dx', '-.8em')\r\n                .attr('dy', '.15em')\r\n                .attr('transform', 'rotate(-45)');\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y).ticks(5).tickFormat(d => CURRENCY_SYMBOL + (d / 1000).toFixed(0) + 'k'));\r\n\r\n            debugLog(`Monthly spend chart rendered: ${data.length} months`, 'success');\r\n        }\r\n\r\n        function renderPOStatusChart(data) {\r\n            const container = document.getElementById('poStatusChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            // Store full dataset for toggling\r\n            poStatusData = data;\r\n\r\n            // Filter out hidden statuses for rendering\r\n            const visibleData = data.filter(d => !hiddenStatuses.has(d.status_name));\r\n\r\n            // Create wrapper for chart and legend\r\n            const wrapper = d3.select(container)\r\n                .append('div')\r\n                .style('display', 'flex')\r\n                .style('flex-direction', 'row')\r\n                .style('align-items', 'center')\r\n                .style('gap', '16px')\r\n                .style('width', '100%');\r\n\r\n            // Chart container - 75% width\r\n            const chartDiv = wrapper.append('div')\r\n                .style('flex', '0 0 75%')\r\n                .style('display', 'flex')\r\n                .style('justify-content', 'center');\r\n\r\n            const width = 240;\r\n            const height = 240;\r\n            const radius = Math.min(width, height) / 2;\r\n\r\n            const svg = chartDiv.append('svg')\r\n                .attr('width', width)\r\n                .attr('height', height)\r\n                .append('g')\r\n                .attr('transform', `translate(${width / 2},${height / 2})`);\r\n\r\n            const color = d3.scaleOrdinal()\r\n                .domain(data.map(d => d.status_name))\r\n                .range(colorPalette);\r\n\r\n            // Only render visible data\r\n            if (visibleData.length > 0) {\r\n                const pie = d3.pie()\r\n                    .value(d => parseInt(d.po_count))\r\n                    .sort(null);\r\n\r\n                const arc = d3.arc()\r\n                    .innerRadius(radius * 0.35)\r\n                    .outerRadius(radius * 0.85);\r\n\r\n                const arcs = svg.selectAll('.arc')\r\n                    .data(pie(visibleData))\r\n                    .enter()\r\n                    .append('g')\r\n                    .attr('class', 'arc');\r\n\r\n                arcs.append('path')\r\n                    .attr('d', arc)\r\n                    .attr('fill', d => color(d.data.status_name))\r\n                    .attr('stroke', 'white')\r\n                    .attr('stroke-width', 2)\r\n                    .style('cursor', 'pointer')\r\n                    .on('mouseover', function(event, d) {\r\n                        d3.select(this)\r\n                            .transition()\r\n                            .duration(200)\r\n                            .attr('d', d3.arc().innerRadius(radius * 0.35).outerRadius(radius * 0.9));\r\n\r\n                        const total = d3.sum(visibleData, d => parseInt(d.po_count));\r\n                        const percent = (parseInt(d.data.po_count) / total * 100).toFixed(1);\r\n\r\n                        tooltip.style('opacity', 1)\r\n                            .html(`\r\n                                <div><span class=\"tooltip-label\">Status:</span><span class=\"tooltip-value\">${d.data.status_name}</span></div>\r\n                                <div><span class=\"tooltip-label\">PO Count:</span><span class=\"tooltip-value\">${parseInt(d.data.po_count).toLocaleString()}</span></div>\r\n                                <div><span class=\"tooltip-label\">Percentage:</span><span class=\"tooltip-value\">${percent}%</span></div>\r\n                                <div class=\"text-xs text-slate-500 mt-1\">Click to view POs</div>\r\n                            `)\r\n                            .style('left', (event.pageX + 10) + 'px')\r\n                            .style('top', (event.pageY - 10) + 'px');\r\n                    })\r\n                    .on('mouseout', function() {\r\n                        d3.select(this)\r\n                            .transition()\r\n                            .duration(200)\r\n                            .attr('d', arc);\r\n                        tooltip.style('opacity', 0);\r\n                    })\r\n                    .on('click', function(event, d) {\r\n                        drilldownPOStatus(d.data.status_id, d.data.status_name);\r\n                    });\r\n            }\r\n\r\n            // Add center text showing total of visible statuses\r\n            const total = d3.sum(visibleData, d => parseInt(d.po_count));\r\n            svg.append('text')\r\n                .attr('text-anchor', 'middle')\r\n                .attr('dy', '-0.2em')\r\n                .style('font-size', '32px')\r\n                .style('font-weight', 'bold')\r\n                .style('fill', '#1e293b')\r\n                .text(total);\r\n\r\n            svg.append('text')\r\n                .attr('text-anchor', 'middle')\r\n                .attr('dy', '1.5em')\r\n                .style('font-size', '12px')\r\n                .style('fill', '#64748b')\r\n                .text('Total POs');\r\n\r\n            // Add legend - show ALL statuses (both visible and hidden), but exclude statuses with 0 count\r\n            const legendDiv = wrapper.append('div')\r\n                .style('flex', '0 0 25%')\r\n                .style('display', 'flex')\r\n                .style('flex-direction', 'column')\r\n                .style('gap', '6px');\r\n\r\n            // Filter out statuses with no POs (e.g., Historical if there are none)\r\n            const legendData = data.filter(d => parseInt(d.po_count) > 0);\r\n\r\n            legendData.forEach(d => {\r\n                const isHidden = hiddenStatuses.has(d.status_name);\r\n\r\n                const legendItem = legendDiv.append('div')\r\n                    .style('display', 'flex')\r\n                    .style('align-items', 'center')\r\n                    .style('justify-content', 'space-between')\r\n                    .style('gap', '8px')\r\n                    .style('font-size', '11px')\r\n                    .style('cursor', 'pointer')\r\n                    .style('padding', '4px 6px')\r\n                    .style('border-radius', '4px')\r\n                    .style('opacity', isHidden ? '0.4' : '1')\r\n                    .style('transition', 'all 0.2s ease')\r\n                    .on('mouseover', function() {\r\n                        d3.select(this).style('background-color', '#f1f5f9');\r\n                    })\r\n                    .on('mouseout', function() {\r\n                        d3.select(this).style('background-color', 'transparent');\r\n                    })\r\n                    .on('click', function() {\r\n                        togglePOStatus(d.status_name);\r\n                    });\r\n\r\n                const leftSection = legendItem.append('div')\r\n                    .style('display', 'flex')\r\n                    .style('align-items', 'center')\r\n                    .style('gap', '6px');\r\n\r\n                leftSection.append('div')\r\n                    .style('width', '12px')\r\n                    .style('height', '12px')\r\n                    .style('border-radius', '2px')\r\n                    .style('background-color', color(d.status_name))\r\n                    .style('flex-shrink', '0');\r\n\r\n                leftSection.append('span')\r\n                    .style('color', '#475569')\r\n                    .style('font-weight', '500')\r\n                    .style('text-decoration', isHidden ? 'line-through' : 'none')\r\n                    .text(d.status_name);\r\n\r\n                legendItem.append('span')\r\n                    .style('color', '#1e293b')\r\n                    .style('font-weight', '600')\r\n                    .style('text-decoration', isHidden ? 'line-through' : 'none')\r\n                    .text(parseInt(d.po_count).toLocaleString());\r\n            });\r\n\r\n            debugLog(`PO status chart rendered: ${visibleData.length}/${legendData.length} statuses visible (${legendData.length} in legend)`, 'success');\r\n        }\r\n\r\n        function togglePOStatus(statusName) {\r\n            if (hiddenStatuses.has(statusName)) {\r\n                hiddenStatuses.delete(statusName);\r\n                debugLog(`Showing ${statusName} status`, 'click');\r\n            } else {\r\n                hiddenStatuses.add(statusName);\r\n                debugLog(`Hiding ${statusName} status`, 'click');\r\n            }\r\n\r\n            // Re-render the chart with updated visibility\r\n            renderPOStatusChart(poStatusData);\r\n        }\r\n\r\n        function renderExpectedReceiptsChart(data) {\r\n            const container = document.getElementById('expectedReceiptsChart');\r\n            const metric = document.querySelector('#expectedReceiptsMetric .text-4xl');\r\n            metric.textContent = data.length;\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8 text-sm\">No POs expected in next 7 days</div>';\r\n                return;\r\n            }\r\n\r\n            const list = document.createElement('div');\r\n            list.className = 'space-y-2 overflow-y-auto custom-scrollbar';\r\n            list.style.maxHeight = '200px';\r\n\r\n            data.forEach(po => {\r\n                const item = document.createElement('div');\r\n                item.className = 'p-2 bg-blue-50 rounded hover:bg-blue-100 transition-colors cursor-pointer';\r\n                const daysUntil = moment(po.due_date).diff(moment(), 'days');\r\n                item.innerHTML = `\r\n                    <div class=\"flex justify-between text-sm\">\r\n                        <span class=\"font-semibold text-slate-700\">PO ${po.po_num}</span>\r\n                        <span class=\"text-blue-700 font-bold\">${formatCurrency(po.po_value, false)}</span>\r\n                    </div>\r\n                    <div class=\"flex justify-between text-xs text-slate-500 mt-1\">\r\n                        <span>${po.vendor_name}</span>\r\n                        <span class=\"text-indigo-600 font-medium\">${daysUntil} days</span>\r\n                    </div>\r\n                `;\r\n                item.addEventListener('click', () => drilldownExpectedReceipts());\r\n                list.appendChild(item);\r\n            });\r\n\r\n            container.appendChild(list);\r\n            debugLog(`Expected receipts: ${data.length} POs`, 'success');\r\n        }\r\n\r\n        function renderOverduePOsChart(data) {\r\n            const container = document.getElementById('overduePOsChart');\r\n            const metric = document.querySelector('#overduePOsMetric .text-4xl');\r\n            metric.textContent = data.length;\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8 text-sm\">No overdue POs</div>';\r\n                return;\r\n            }\r\n\r\n            const list = document.createElement('div');\r\n            list.className = 'space-y-2 overflow-y-auto custom-scrollbar';\r\n            list.style.maxHeight = '200px';\r\n\r\n            data.forEach(po => {\r\n                const item = document.createElement('div');\r\n                item.className = 'p-2 bg-red-50 rounded hover:bg-red-100 transition-colors cursor-pointer';\r\n                item.innerHTML = `\r\n                    <div class=\"flex justify-between text-sm\">\r\n                        <span class=\"font-semibold text-slate-700\">PO ${po.po_num}</span>\r\n                        <span class=\"text-red-700 font-bold\">${formatCurrency(po.po_value, false)}</span>\r\n                    </div>\r\n                    <div class=\"flex justify-between text-xs text-slate-500 mt-1\">\r\n                        <span>${po.vendor_name}</span>\r\n                        <span class=\"text-red-600 font-medium\">${po.days_overdue} days overdue</span>\r\n                    </div>\r\n                `;\r\n                item.addEventListener('click', () => drilldownOverduePOs());\r\n                list.appendChild(item);\r\n            });\r\n\r\n            container.appendChild(list);\r\n            debugLog(`Overdue POs: ${data.length}`, 'success');\r\n        }\r\n\r\n        function renderRecentlyReceivedChart(data) {\r\n            const container = document.getElementById('recentlyReceivedChart');\r\n            const metric = document.querySelector('#recentlyReceivedMetric .text-4xl');\r\n            metric.textContent = data.length;\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8 text-sm\">No recent receipts</div>';\r\n                return;\r\n            }\r\n\r\n            const list = document.createElement('div');\r\n            list.className = 'space-y-2 overflow-y-auto custom-scrollbar';\r\n            list.style.maxHeight = '200px';\r\n\r\n            data.forEach(po => {\r\n                const item = document.createElement('div');\r\n                item.className = 'p-2 bg-green-50 rounded hover:bg-green-100 transition-colors cursor-pointer';\r\n                item.innerHTML = `\r\n                    <div class=\"flex justify-between text-sm\">\r\n                        <span class=\"font-semibold text-slate-700\">PO ${po.po_num}</span>\r\n                        <span class=\"text-green-700 font-bold\">${formatCurrency(po.po_value, false)}</span>\r\n                    </div>\r\n                    <div class=\"flex justify-between text-xs text-slate-500 mt-1\">\r\n                        <span>${po.vendor_name}</span>\r\n                        <span class=\"text-green-600 font-medium\">${moment(po.received_date).format(MOMENT_DATE_FORMAT)}</span>\r\n                    </div>\r\n                `;\r\n                item.addEventListener('click', () => drilldownRecentlyReceived());\r\n                list.appendChild(item);\r\n            });\r\n\r\n            container.appendChild(list);\r\n            debugLog(`Recently received: ${data.length} POs`, 'success');\r\n        }\r\n\r\n        function renderTopVendorsSpendChart(data) {\r\n            const container = document.getElementById('topVendorsSpendChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 10, right: 30, bottom: 30, left: 120 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 280 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => parseFloat(d.total_spend))])\r\n                .nice()\r\n                .range([0, width]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(data.map(d => d.vendor_name))\r\n                .range([0, height])\r\n                .padding(0.2);\r\n\r\n            svg.selectAll('.bar')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', 0)\r\n                .attr('y', d => y(d.vendor_name))\r\n                .attr('width', d => x(parseFloat(d.total_spend)))\r\n                .attr('height', y.bandwidth())\r\n                .attr('fill', colorPalette[0])\r\n                .attr('rx', 4)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).attr('fill', colorPalette[1]);\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Vendor:</span><span class=\"tooltip-value\">${d.vendor_name}</span></div>\r\n                            <div><span class=\"tooltip-label\">Total Spend:</span><span class=\"tooltip-value\">${formatCurrency(d.total_spend)}</span></div>\r\n                            <div><span class=\"tooltip-label\">PO Count:</span><span class=\"tooltip-value\">${parseInt(d.po_count).toLocaleString()}</span></div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Click to view POs</div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).attr('fill', colorPalette[0]);\r\n                    tooltip.style('opacity', 0);\r\n                })\r\n                .on('click', function(event, d) {\r\n                    drilldownVendor(d.vendor_name);\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(4).tickFormat(d => CURRENCY_SYMBOL + (d / 1000).toFixed(0) + 'k'));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '10px')\r\n                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);\r\n\r\n            debugLog(`Top vendors by spend chart rendered: ${data.length} vendors`, 'success');\r\n        }\r\n\r\n        function renderTopVendorsCountChart(data) {\r\n            const container = document.getElementById('topVendorsCountChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 10, right: 30, bottom: 30, left: 120 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 280 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => parseInt(d.po_count))])\r\n                .nice()\r\n                .range([0, width]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(data.map(d => d.vendor_name))\r\n                .range([0, height])\r\n                .padding(0.2);\r\n\r\n            svg.selectAll('.bar')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', 0)\r\n                .attr('y', d => y(d.vendor_name))\r\n                .attr('width', d => x(parseInt(d.po_count)))\r\n                .attr('height', y.bandwidth())\r\n                .attr('fill', colorPalette[2])\r\n                .attr('rx', 4)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).attr('fill', colorPalette[3]);\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Vendor:</span><span class=\"tooltip-value\">${d.vendor_name}</span></div>\r\n                            <div><span class=\"tooltip-label\">PO Count:</span><span class=\"tooltip-value\">${parseInt(d.po_count).toLocaleString()}</span></div>\r\n                            <div><span class=\"tooltip-label\">Total Spend:</span><span class=\"tooltip-value\">${formatCurrency(d.total_spend)}</span></div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).attr('fill', colorPalette[2]);\r\n                    tooltip.style('opacity', 0);\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(4));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '10px')\r\n                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);\r\n\r\n            debugLog(`Top vendors by count chart rendered: ${data.length} vendors`, 'success');\r\n        }\r\n\r\n        function renderVendorOnTimeChart(data) {\r\n            const container = document.getElementById('vendorOnTimeChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 10, right: 30, bottom: 30, left: 120 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 280 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleLinear()\r\n                .domain([0, 100])\r\n                .range([0, width]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(data.map(d => d.vendor_name))\r\n                .range([0, height])\r\n                .padding(0.2);\r\n\r\n            // Color scale for on-time performance\r\n            const getColor = (percent) => {\r\n                if (percent >= 90) return '#10b981'; // green\r\n                if (percent >= 75) return '#f59e0b'; // orange\r\n                return '#ef4444'; // red\r\n            };\r\n\r\n            svg.selectAll('.bar')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', 0)\r\n                .attr('y', d => y(d.vendor_name))\r\n                .attr('width', d => x(parseFloat(d.on_time_percent)))\r\n                .attr('height', y.bandwidth())\r\n                .attr('fill', d => getColor(parseFloat(d.on_time_percent)))\r\n                .attr('rx', 4)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).attr('opacity', 0.8);\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Vendor:</span><span class=\"tooltip-value\">${d.vendor_name}</span></div>\r\n                            <div><span class=\"tooltip-label\">On-Time %:</span><span class=\"tooltip-value\">${parseFloat(d.on_time_percent).toFixed(1)}%</span></div>\r\n                            <div><span class=\"tooltip-label\">On-Time Orders:</span><span class=\"tooltip-value\">${parseInt(d.on_time_orders)} / ${parseInt(d.total_orders)}</span></div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).attr('opacity', 1);\r\n                    tooltip.style('opacity', 0);\r\n                });\r\n\r\n            // Add percentage labels on bars\r\n            svg.selectAll('.label')\r\n                .data(data)\r\n                .enter()\r\n                .append('text')\r\n                .attr('x', d => x(parseFloat(d.on_time_percent)) + 5)\r\n                .attr('y', d => y(d.vendor_name) + y.bandwidth() / 2)\r\n                .attr('dy', '0.35em')\r\n                .style('font-size', '11px')\r\n                .style('font-weight', 'bold')\r\n                .style('fill', '#1e293b')\r\n                .text(d => parseFloat(d.on_time_percent).toFixed(0) + '%');\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(5).tickFormat(d => d + '%'));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '10px')\r\n                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);\r\n\r\n            debugLog(`Vendor on-time chart rendered: ${data.length} vendors`, 'success');\r\n        }\r\n\r\n        function renderTopProductsChart(data) {\r\n            const container = document.getElementById('topProductsChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 10, right: 30, bottom: 30, left: 100 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 280 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => parseFloat(d.total_qty))])\r\n                .nice()\r\n                .range([0, width]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(data.map(d => d.part_num))\r\n                .range([0, height])\r\n                .padding(0.2);\r\n\r\n            svg.selectAll('.bar')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', 0)\r\n                .attr('y', d => y(d.part_num))\r\n                .attr('width', d => x(parseFloat(d.total_qty)))\r\n                .attr('height', y.bandwidth())\r\n                .attr('fill', colorPalette[5])\r\n                .attr('rx', 4)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).attr('fill', colorPalette[6]);\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Part:</span><span class=\"tooltip-value\">${d.part_num}</span></div>\r\n                            <div><span class=\"tooltip-label\">Description:</span><span class=\"tooltip-value\">${d.part_description}</span></div>\r\n                            <div><span class=\"tooltip-label\">Quantity:</span><span class=\"tooltip-value\">${parseFloat(d.total_qty).toLocaleString()}</span></div>\r\n                            <div><span class=\"tooltip-label\">Total Cost:</span><span class=\"tooltip-value\">${formatCurrency(d.total_cost)}</span></div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).attr('fill', colorPalette[5]);\r\n                    tooltip.style('opacity', 0);\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(4));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '10px');\r\n\r\n            debugLog(`Top products chart rendered: ${data.length} products`, 'success');\r\n        }\r\n\r\n        function renderCategoryChart(data) {\r\n            const container = document.getElementById('categoryChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 10, right: 30, bottom: 30, left: 120 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 280 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => parseFloat(d.total_spend))])\r\n                .nice()\r\n                .range([0, width]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(data.map(d => d.category_name))\r\n                .range([0, height])\r\n                .padding(0.2);\r\n\r\n            svg.selectAll('.bar')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', 0)\r\n                .attr('y', d => y(d.category_name))\r\n                .attr('width', d => x(parseFloat(d.total_spend)))\r\n                .attr('height', y.bandwidth())\r\n                .attr('fill', colorPalette[7])\r\n                .attr('rx', 4)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).attr('fill', colorPalette[8]);\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Category:</span><span class=\"tooltip-value\">${d.category_name}</span></div>\r\n                            <div><span class=\"tooltip-label\">Total Spend:</span><span class=\"tooltip-value\">${formatCurrency(d.total_spend)}</span></div>\r\n                            <div><span class=\"tooltip-label\">PO Count:</span><span class=\"tooltip-value\">${parseInt(d.po_count).toLocaleString()}</span></div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Click to view POs</div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).attr('fill', colorPalette[7]);\r\n                    tooltip.style('opacity', 0);\r\n                })\r\n                .on('click', function(event, d) {\r\n                    drilldownCategory(d.category_name);\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(4).tickFormat(d => CURRENCY_SYMBOL + (d / 1000).toFixed(0) + 'k'));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '10px')\r\n                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);\r\n\r\n            debugLog(`Category chart rendered: ${data.length} categories`, 'success');\r\n        }\r\n\r\n        function renderHighValueChart(data) {\r\n            const container = document.getElementById('highValueChart');\r\n            const metric = document.querySelector('#highValueMetric .text-4xl');\r\n            metric.textContent = data.length;\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8 text-sm\">No high value POs found</div>';\r\n                return;\r\n            }\r\n\r\n            const list = document.createElement('div');\r\n            list.className = 'space-y-2 overflow-y-auto custom-scrollbar';\r\n            list.style.maxHeight = '200px';\r\n\r\n            data.forEach(po => {\r\n                const item = document.createElement('div');\r\n                item.className = 'p-2 bg-purple-50 rounded hover:bg-purple-100 transition-colors';\r\n                item.innerHTML = `\r\n                    <div class=\"flex justify-between text-sm\">\r\n                        <span class=\"font-semibold text-slate-700\">PO ${po.po_num}</span>\r\n                        <span class=\"text-purple-700 font-bold\">${formatCurrency(po.po_value, false)}</span>\r\n                    </div>\r\n                    <div class=\"flex justify-between text-xs text-slate-500 mt-1\">\r\n                        <span>${po.vendor_name}</span>\r\n                        <span class=\"text-purple-600 font-medium\">${moment(po.received_date).format(MOMENT_DATE_FORMAT)}</span>\r\n                    </div>\r\n                `;\r\n                list.appendChild(item);\r\n            });\r\n\r\n            container.appendChild(list);\r\n            debugLog(`High value POs: ${data.length}`, 'success');\r\n        }\r\n\r\n        function clearAllFilters() {\r\n            document.getElementById('dateRangeFilter').value = 'current_fy';\r\n            document.getElementById('vendorFilter').value = '%';\r\n            document.getElementById('productCategoryFilter').value = '%';\r\n            document.getElementById('abcCodeFilter').value = '%';\r\n            document.getElementById('locationFilter').value = '%';\r\n            customStartDate = null;\r\n            customEndDate = null;\r\n            document.getElementById('customStartDate').value = '';\r\n            document.getElementById('customEndDate').value = '';\r\n            document.getElementById('customDateRangeContainer').style.display = 'none';\r\n            loadDashboard();\r\n        }\r\n\r\n        function applyDateRange() {\r\n            const rangeValue = document.getElementById('dateRangeFilter').value;\r\n            const customContainer = document.getElementById('customDateRangeContainer');\r\n\r\n            if (rangeValue === 'custom') {\r\n                customContainer.style.display = 'block';\r\n                return;\r\n            } else {\r\n                customContainer.style.display = 'none';\r\n            }\r\n\r\n            currentDateRange = parseInt(rangeValue) || rangeValue;\r\n\r\n            // Calculate customStartDate and customEndDate based on the range\r\n            if (rangeValue === 'this_quarter') {\r\n                const dates = getQuarterDates(0);\r\n                customStartDate = dates.start;\r\n                customEndDate = dates.end;\r\n            } else if (rangeValue === 'last_quarter') {\r\n                const dates = getQuarterDates(1);\r\n                customStartDate = dates.start;\r\n                customEndDate = dates.end;\r\n            } else if (rangeValue === 'current_fy') {\r\n                const dates = getFYDates(0);\r\n                customStartDate = dates.start;\r\n                customEndDate = dates.end;\r\n            } else if (rangeValue === 'last_fy') {\r\n                const dates = getFYDates(1);\r\n                customStartDate = dates.start;\r\n                customEndDate = dates.end;\r\n            } else {\r\n                // For numeric ranges (30, 60, 90, etc. days)\r\n                const days = parseInt(rangeValue);\r\n                if (!isNaN(days)) {\r\n                    customEndDate = moment().format('YYYY-MM-DD');\r\n                    customStartDate = moment().subtract(days, 'days').format('YYYY-MM-DD');\r\n                } else {\r\n                    customStartDate = null;\r\n                    customEndDate = null;\r\n                }\r\n            }\r\n\r\n            updateDateRangeDisplay();\r\n            loadDashboard();\r\n        }\r\n\r\n        function applyCustomDateRange() {\r\n            const startInput = document.getElementById('customStartDate');\r\n            const endInput = document.getElementById('customEndDate');\r\n\r\n            if (startInput.value && endInput.value) {\r\n                customStartDate = startInput.value;\r\n                customEndDate = endInput.value;\r\n                currentDateRange = null;\r\n                updateDateRangeDisplay();\r\n                loadDashboard();\r\n            }\r\n        }\r\n\r\n        function updateDateRangeDisplay() {\r\n            const displayEl = document.getElementById('dateRangeDisplay');\r\n            if (!displayEl) return;\r\n\r\n            // Always show the actual date range using DateFormatShort property\r\n            if (customStartDate && customEndDate) {\r\n                displayEl.textContent = `(${moment(customStartDate).format(MOMENT_DATE_FORMAT)} - ${moment(customEndDate).format(MOMENT_DATE_FORMAT)})`;\r\n            } else {\r\n                displayEl.textContent = '';\r\n            }\r\n        }\r\n\r\n        function exportToCSV() {\r\n            alert('Export functionality will be implemented in next chunk');\r\n        }\r\n\r\n        function escapeSQL(str) {\r\n            if (typeof str !== 'string') return str;\r\n            return str.replace(/'/g, \"''\");\r\n        }\r\n\r\n        let spendChartMode = 'line';\r\n\r\n        function toggleSpendChartMode(mode) {\r\n            spendChartMode = mode;\r\n\r\n            const lineBtn = document.getElementById('spendLineBtn');\r\n            const barBtn = document.getElementById('spendBarBtn');\r\n\r\n            if (mode === 'line') {\r\n                lineBtn.classList.add('bg-white', 'text-slate-800');\r\n                lineBtn.classList.remove('text-slate-600');\r\n                barBtn.classList.remove('bg-white', 'text-slate-800');\r\n                barBtn.classList.add('text-slate-600');\r\n            } else {\r\n                barBtn.classList.add('bg-white', 'text-slate-800');\r\n                barBtn.classList.remove('text-slate-600');\r\n                lineBtn.classList.remove('bg-white', 'text-slate-800');\r\n                lineBtn.classList.add('text-slate-600');\r\n            }\r\n\r\n            // Re-render the chart\r\n            const monthlySpendData = getMonthlySpend();\r\n            renderMonthlySpendChart(monthlySpendData);\r\n        }\r\n\r\n        function debugLog(message, type = 'info') {\r\n            // Only log if DEBUG_MODE is enabled\r\n            if (!DEBUG_MODE) return;\r\n\r\n            const timestamp = new Date().toLocaleTimeString();\r\n            const logDiv = document.getElementById('debugLog');\r\n\r\n            // Also log to console\r\n            const prefix = type === 'error' ? '' : type === 'success' ? '' : '';\r\n            console.log(`${prefix} [${timestamp}] ${message}`);\r\n\r\n            if (!logDiv) return;\r\n\r\n            // Clear initial message\r\n            if (logDiv.querySelector('.italic')) {\r\n                logDiv.innerHTML = '';\r\n            }\r\n\r\n            const colors = {\r\n                'info': 'text-blue-400',\r\n                'success': 'text-green-400',\r\n                'warning': 'text-yellow-400',\r\n                'error': 'text-red-400',\r\n                'click': 'text-purple-400'\r\n            };\r\n\r\n            const entry = document.createElement('div');\r\n            entry.className = 'mb-1';\r\n            entry.innerHTML = `<span class=\"text-slate-500\">[${timestamp}]</span> <span class=\"${colors[type] || colors.info}\">${message}</span>`;\r\n\r\n            logDiv.appendChild(entry);\r\n            logDiv.scrollTop = logDiv.scrollHeight;\r\n        }\r\n\r\n        function toggleDebugConsole() {\r\n            const content = document.getElementById('debugContent');\r\n            const chevron = document.getElementById('debugChevron');\r\n\r\n            if (content.classList.contains('hidden')) {\r\n                content.classList.remove('hidden');\r\n                chevron.style.transform = 'rotate(180deg)';\r\n            } else {\r\n                content.classList.add('hidden');\r\n                chevron.style.transform = 'rotate(0deg)';\r\n            }\r\n        }\r\n\r\n        function clearDebugLog() {\r\n            const logDiv = document.getElementById('debugLog');\r\n            logDiv.innerHTML = '<div class=\"text-slate-500 italic\">Log cleared</div>';\r\n        }\r\n\r\n        // ============================================\r\n        // Module Opening Functions\r\n        // ============================================\r\n\r\n        function openPurchaseOrder(poNumber) {\r\n            openModule(\"Purchase Order\", poNumber);\r\n        }\r\n\r\n        // ============================================\r\n        // Drilldown Modal Functions\r\n        // ============================================\r\n\r\n        function openDrilldown(title, breadcrumb, data, columns) {\r\n            if (!data || !Array.isArray(data)) {\r\n                debugLog('openDrilldown called with invalid data', 'error');\r\n                return;\r\n            }\r\n            debugLog(`Opening drilldown: \"${title}\" with ${data.length} rows`, 'info');\r\n            currentDrilldownData = data;\r\n            currentDrilldownColumns = columns;\r\n            currentSortColumn = null;\r\n            currentSortDirection = 'asc';\r\n\r\n            document.getElementById('drilldownTitle').textContent = title;\r\n            document.getElementById('drilldownBreadcrumb').textContent = breadcrumb;\r\n            document.getElementById('drilldownSearch').value = '';\r\n\r\n            renderDrilldownTable(data);\r\n\r\n            const modal = document.getElementById('drilldownModal');\r\n            modal.style.display = 'flex';\r\n        }\r\n\r\n        function closeDrilldown(event) {\r\n            if (event && event.target !== event.currentTarget) return;\r\n\r\n            debugLog('Closing drilldown modal', 'info');\r\n            const modal = document.getElementById('drilldownModal');\r\n            modal.style.display = 'none';\r\n        }\r\n\r\n        function renderDrilldownTable(data) {\r\n            const thead = document.getElementById('drilldownTableHead');\r\n            const tbody = document.getElementById('drilldownTableBody');\r\n\r\n            // Render headers\r\n            thead.innerHTML = '<tr>' + currentDrilldownColumns.map((col, idx) => `\r\n                <th class=\"px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors\" onclick=\"sortDrilldownTable(${idx})\">\r\n                    <div class=\"flex items-center gap-2\">\r\n                        <span>${col.label}</span>\r\n                        <svg class=\"w-3 h-3 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4\"></path>\r\n                        </svg>\r\n                    </div>\r\n                </th>\r\n            `).join('') + '</tr>';\r\n\r\n            // Render rows\r\n            tbody.innerHTML = data.map((row, rowIndex) => {\r\n                const isPORow = row.hasOwnProperty('po_num');\r\n                const rowClass = isPORow ? 'hover:bg-indigo-50 cursor-pointer transition-colors' : 'hover:bg-slate-50 transition-colors';\r\n                const rowClick = isPORow ? `onclick=\"togglePOLineItems(${rowIndex}, '${escapeSQL(row.po_num)}')\"` : '';\r\n\r\n                return `<tr class=\"${rowClass}\" ${rowClick} data-row-index=\"${rowIndex}\">` +\r\n                    currentDrilldownColumns.map(col => {\r\n                        let value = row[col.key];\r\n                        let colorClass = '';\r\n                        const numericValue = parseFloat(value || 0);\r\n\r\n                        // Format based on type\r\n                        if (col.type === 'currency') {\r\n                            value = formatCurrency(numericValue);\r\n                            // Red text for negative currency values (not bold per UX feedback)\r\n                            if (numericValue < 0) colorClass = 'text-red-600';\r\n                        } else if (col.type === 'number') {\r\n                            value = numericValue.toLocaleString('en-US');\r\n                        } else if (col.type === 'percent') {\r\n                            value = (numericValue * 100).toFixed(1) + '%';\r\n                            // Red text for negative percentages (not bold per UX feedback)\r\n                            if (numericValue < 0) colorClass = 'text-red-600';\r\n                        } else if (col.type === 'date') {\r\n                            value = moment(value).format(MOMENT_DATE_FORMAT);\r\n                        } else if (col.format) {\r\n                            value = col.format(value);\r\n                        }\r\n\r\n                        // Make PO numbers clickable\r\n                        if (col.key === 'po_num' && value) {\r\n                            value = `<a href=\"#\" class=\"order-link\" onclick=\"event.stopPropagation(); openPurchaseOrder('${escapeSQL(value)}'); return false;\">${value}</a>`;\r\n                        }\r\n\r\n                        return `<td class=\"px-4 py-3 text-sm text-slate-700 ${colorClass}\">${value || ''}</td>`;\r\n                    }).join('') +\r\n                `</tr>`;\r\n            }).join('');\r\n        }\r\n\r\n        function togglePOLineItems(rowIndex, poNum) {\r\n            const tbody = document.getElementById('drilldownTableBody');\r\n            const existingExpanded = tbody.querySelector(`tr[data-expanded-for=\"${rowIndex}\"]`);\r\n\r\n            if (existingExpanded) {\r\n                existingExpanded.remove();\r\n                return;\r\n            }\r\n\r\n            // Query for PO line items\r\n            const query = `\r\n                SELECT\r\n                    poitem.partnum as part_num,\r\n                    poitem.description as part_description,\r\n                    poitem.qtytofulfill as qty,\r\n                    poitem.unitcost as unit_cost,\r\n                    (poitem.qtytofulfill * poitem.unitcost) as line_total\r\n                FROM po\r\n                JOIN poitem ON poitem.poid = po.id\r\n                WHERE po.num = '${escapeSQL(poNum)}'\r\n                ORDER BY poitem.id ASC\r\n            `;\r\n\r\n            const queryResult = runQuery(query);\r\n            const lineItems = queryResult ? JSON.parse(queryResult) : null;\r\n\r\n            if (!lineItems || lineItems.length === 0) {\r\n                alert('No line items found for this PO.');\r\n                return;\r\n            }\r\n\r\n            // Helper to format currency cell with color class for negative handling\r\n            const formatCurrencyCell = (val) => {\r\n                const num = parseFloat(val || 0);\r\n                const isNeg = num < 0;\r\n                return {\r\n                    value: formatCurrency(num),\r\n                    colorClass: isNeg ? 'text-red-600' : 'text-slate-700'\r\n                };\r\n            };\r\n\r\n            // Create expanded row with line items table\r\n            const targetRow = tbody.querySelector(`tr[data-row-index=\"${rowIndex}\"]`);\r\n            const expandedRow = document.createElement('tr');\r\n            expandedRow.setAttribute('data-expanded-for', rowIndex);\r\n            expandedRow.innerHTML = `\r\n                <td colspan=\"${currentDrilldownColumns.length}\" class=\"px-4 py-2 bg-slate-50 border-t border-b border-slate-200\">\r\n                    <div class=\"pl-8\">\r\n                        <div class=\"text-xs font-semibold text-slate-600 mb-2\">Line Items for PO ${poNum}:</div>\r\n                        <table class=\"w-full text-xs\">\r\n                            <thead>\r\n                                <tr class=\"text-left text-slate-600\">\r\n                                    <th class=\"py-1\">Part #</th>\r\n                                    <th class=\"py-1\">Description</th>\r\n                                    <th class=\"py-1 text-right\">Qty</th>\r\n                                    <th class=\"py-1 text-right\">Unit Cost</th>\r\n                                    <th class=\"py-1 text-right\">Line Total</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                ${lineItems.map(item => {\r\n                                    const unitCost = formatCurrencyCell(item.unit_cost);\r\n                                    const lineTotal = formatCurrencyCell(item.line_total);\r\n                                    return `\r\n                                    <tr class=\"border-t border-slate-200\">\r\n                                        <td class=\"py-1 text-slate-700\">${item.part_num || ''}</td>\r\n                                        <td class=\"py-1 text-slate-700\">${item.part_description || ''}</td>\r\n                                        <td class=\"py-1 text-right text-slate-700\">${parseFloat(item.qty || 0).toLocaleString()}</td>\r\n                                        <td class=\"py-1 text-right ${unitCost.colorClass}\">${unitCost.value}</td>\r\n                                        <td class=\"py-1 text-right ${lineTotal.colorClass}\">${lineTotal.value}</td>\r\n                                    </tr>\r\n                                `}).join('')}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </td>\r\n            `;\r\n\r\n            targetRow.insertAdjacentElement('afterend', expandedRow);\r\n        }\r\n\r\n        function filterDrilldownTable() {\r\n            const searchValue = document.getElementById('drilldownSearch').value.toLowerCase();\r\n\r\n            const filteredData = currentDrilldownData.filter(row =>\r\n                currentDrilldownColumns.some(col =>\r\n                    String(row[col.key] || '').toLowerCase().includes(searchValue)\r\n                )\r\n            );\r\n\r\n            renderDrilldownTable(filteredData);\r\n        }\r\n\r\n        function sortDrilldownTable(columnIndex) {\r\n            const column = currentDrilldownColumns[columnIndex];\r\n\r\n            if (currentSortColumn === columnIndex) {\r\n                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';\r\n            } else {\r\n                currentSortColumn = columnIndex;\r\n                currentSortDirection = 'asc';\r\n            }\r\n\r\n            const sorted = [...currentDrilldownData].sort((a, b) => {\r\n                let aVal = a[column.key];\r\n                let bVal = b[column.key];\r\n\r\n                // Convert to numbers if applicable\r\n                if (column.type === 'currency' || column.type === 'number' || column.type === 'percent') {\r\n                    aVal = parseFloat(aVal || 0);\r\n                    bVal = parseFloat(bVal || 0);\r\n                } else if (column.type === 'date') {\r\n                    aVal = new Date(aVal);\r\n                    bVal = new Date(bVal);\r\n                }\r\n\r\n                if (currentSortDirection === 'asc') {\r\n                    return aVal > bVal ? 1 : -1;\r\n                } else {\r\n                    return aVal < bVal ? 1 : -1;\r\n                }\r\n            });\r\n\r\n            currentDrilldownData = sorted;\r\n            renderDrilldownTable(sorted);\r\n        }\r\n\r\n        function exportDrilldownData() {\r\n            if (!currentDrilldownData || currentDrilldownData.length === 0) {\r\n                alert('No data to export');\r\n                return;\r\n            }\r\n\r\n            // Create CSV content\r\n            const headers = currentDrilldownColumns.map(col => col.label).join(',');\r\n            const rows = currentDrilldownData.map(row =>\r\n                currentDrilldownColumns.map(col => {\r\n                    let value = row[col.key] || '';\r\n                    // Escape commas and quotes\r\n                    if (typeof value === 'string' && (value.includes(',') || value.includes('\"'))) {\r\n                        value = `\"${value.replace(/\"/g, '\"\"')}\"`;\r\n                    }\r\n                    return value;\r\n                }).join(',')\r\n            ).join('\\n');\r\n\r\n            const csv = headers + '\\n' + rows;\r\n\r\n            // Download\r\n            const blob = new Blob([csv], { type: 'text/csv' });\r\n            const url = window.URL.createObjectURL(blob);\r\n            const a = document.createElement('a');\r\n            a.href = url;\r\n            a.download = `purchasing_drilldown_${moment().format('YYYY-MM-DD')}.csv`;\r\n            a.click();\r\n            window.URL.revokeObjectURL(url);\r\n        }\r\n\r\n        // ============================================\r\n        // Specific Drilldown Functions\r\n        // ============================================\r\n\r\n        function drilldownVendor(vendorName) {\r\n            try {\r\n                debugLog(`Drill-down: Vendor \"${vendorName}\"`, 'click');\r\n                const conditions = buildFilterConditions();\r\n\r\n                const query = `\r\n                    SELECT\r\n                        po.num as po_num,\r\n                        po.dateIssued as po_date,\r\n                        postpo.postdate as received_date,\r\n                        SUM(postpoitem.postedtotalcost) as po_value,\r\n                        postatus.name as status\r\n                    FROM postpoitem\r\n                    JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                    JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                    LEFT JOIN part ON poitem.partid = part.id\r\n                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                    JOIN po ON poitem.poid = po.id\r\n                    JOIN vendor ON po.vendorid = vendor.id\r\n                    JOIN postatus ON po.statusid = postatus.id\r\n                    JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                    ${conditions}\r\n                    AND vendor.name = '${escapeSQL(vendorName)}'\r\n                    GROUP BY po.num, po.dateIssued, postpo.postdate, postatus.name\r\n                    ORDER BY postpo.postdate DESC\r\n                `;\r\n\r\n                const data = JSON.parse(runQuery(query));\r\n\r\n                const columns = [\r\n                    { key: 'po_num', label: 'PO #' },\r\n                    { key: 'po_date', label: 'Issued', type: 'date' },\r\n                    { key: 'received_date', label: 'Received', type: 'date' },\r\n                    { key: 'po_value', label: 'Value', type: 'currency' },\r\n                    { key: 'status', label: 'Status' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    `POs from ${vendorName}`,\r\n                    `Vendor: ${vendorName}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownVendor: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownCategory(categoryName) {\r\n            try {\r\n                debugLog(`Drill-down: Category \"${categoryName}\"`, 'click');\r\n                const conditions = buildFilterConditions();\r\n\r\n                const categoryCondition = categoryName === 'Uncategorized'\r\n                    ? `AND (ProductTree.Name IS NULL OR ProductTree.Name = '')`\r\n                    : `AND ProductTree.Name = '${escapeSQL(categoryName)}'`;\r\n\r\n                const query = `\r\n                    SELECT\r\n                        po.num as po_num,\r\n                        vendor.name as vendor_name,\r\n                        postpo.postdate as received_date,\r\n                        SUM(postpoitem.postedtotalcost) as po_value\r\n                    FROM postpoitem\r\n                    JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                    JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                    LEFT JOIN part ON poitem.partid = part.id\r\n                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                    JOIN po ON poitem.poid = po.id\r\n                    JOIN vendor ON po.vendorid = vendor.id\r\n                    JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                    ${conditions}\r\n                    ${categoryCondition}\r\n                    GROUP BY po.num, vendor.name, postpo.postdate\r\n                    ORDER BY po_value DESC\r\n                `;\r\n\r\n                const data = JSON.parse(runQuery(query));\r\n\r\n                const columns = [\r\n                    { key: 'po_num', label: 'PO #' },\r\n                    { key: 'vendor_name', label: 'Vendor' },\r\n                    { key: 'received_date', label: 'Received', type: 'date' },\r\n                    { key: 'po_value', label: 'Value', type: 'currency' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    `POs in ${categoryName}`,\r\n                    `Category: ${categoryName}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownCategory: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownPOStatus(statusId, statusName) {\r\n            try {\r\n                debugLog(`Drill-down: PO Status \"${statusName}\" (ID: ${statusId})`, 'click');\r\n                const vendor = document.getElementById('vendorFilter').value;\r\n                const location = document.getElementById('locationFilter').value;\r\n\r\n                const { start, end } = getDateRange();\r\n\r\n                let conditions = `WHERE po.statusid = ${parseInt(statusId)}`;\r\n\r\n                // Date filter based on date range\r\n                if (start && end) {\r\n                    conditions += ` AND po.dateIssued BETWEEN '${start}' AND '${end}'`;\r\n                }\r\n\r\n                if (vendor !== '%') {\r\n                    conditions += ` AND vendor.id = ${parseInt(vendor)}`;\r\n                }\r\n                if (location !== '%') {\r\n                    conditions += ` AND locationgroup.id = ${parseInt(location)}`;\r\n                }\r\n\r\n                const query = `\r\n                    SELECT\r\n                        po.num as po_num,\r\n                        vendor.name as vendor_name,\r\n                        po.dateIssued as issued_date,\r\n                        po.dateFirstShip as first_ship_date,\r\n                        po.dateCompleted as completed_date,\r\n                        po.totalcost as po_total,\r\n                        postatus.name as status\r\n                    FROM po\r\n                    JOIN vendor ON po.vendorid = vendor.id\r\n                    JOIN postatus ON po.statusid = postatus.id\r\n                    JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                    ${conditions}\r\n                    ORDER BY po.dateIssued DESC\r\n                `;\r\n\r\n                debugLog('PO Status Drill-down Query: ' + query, 'info');\r\n                const result = runQuery(query);\r\n                debugLog('Query result: ' + (result ? result.length + ' chars' : 'null'), result ? 'success' : 'error');\r\n\r\n                if (!result || result.trim() === '' || result === 'null') {\r\n                    debugLog('ERROR: Query returned empty result', 'error');\r\n                    return;\r\n                }\r\n\r\n                const data = JSON.parse(result);\r\n                debugLog(`Found ${data.length} POs with status \"${statusName}\"`, 'success');\r\n\r\n                if (!data || data.length === 0) {\r\n                    debugLog('No POs found for this status', 'warning');\r\n                    // Still open drilldown with empty data to show \"no results\" message\r\n                }\r\n\r\n                const columns = [\r\n                    { key: 'po_num', label: 'PO #' },\r\n                    { key: 'vendor_name', label: 'Vendor' },\r\n                    { key: 'issued_date', label: 'Issued', type: 'date' },\r\n                    { key: 'first_ship_date', label: 'First Ship', type: 'date' },\r\n                    { key: 'completed_date', label: 'Completed', type: 'date' },\r\n                    { key: 'po_total', label: 'PO Total', type: 'currency' },\r\n                    { key: 'status', label: 'Status' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    `POs with Status: ${statusName}`,\r\n                    `Status: ${statusName}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownPOStatus: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownExpectedReceipts() {\r\n            try {\r\n                debugLog('Drill-down: Expected Receipts', 'click');\r\n                const vendor = document.getElementById('vendorFilter').value;\r\n                const productCategory = document.getElementById('productCategoryFilter').value;\r\n                const abcCode = document.getElementById('abcCodeFilter').value;\r\n                const location = document.getElementById('locationFilter').value;\r\n\r\n                let conditions = `WHERE po.statusid IN (20, 30, 40)\r\n                    AND poitem.dateScheduledFulfillment BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY)`;\r\n\r\n                if (vendor !== '%') {\r\n                    conditions += ` AND vendor.id = ${parseInt(vendor)}`;\r\n                }\r\n                if (productCategory !== '%') {\r\n                    conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;\r\n                }\r\n                if (abcCode !== '%') {\r\n                    conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;\r\n                }\r\n                if (location !== '%') {\r\n                    conditions += ` AND locationgroup.id = ${parseInt(location)}`;\r\n                }\r\n\r\n                const query = `\r\n                    SELECT\r\n                        po.num as po_num,\r\n                        vendor.name as vendor_name,\r\n                        poitem.dateScheduledFulfillment as due_date,\r\n                        DATEDIFF(poitem.dateScheduledFulfillment, CURDATE()) as days_until,\r\n                        SUM(poitem.qtytofulfill * poitem.unitcost) as po_value,\r\n                        postatus.name as status\r\n                    FROM po\r\n                    JOIN poitem ON poitem.poid = po.id\r\n                    LEFT JOIN part ON poitem.partid = part.id\r\n                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                    JOIN vendor ON po.vendorid = vendor.id\r\n                    JOIN postatus ON po.statusid = postatus.id\r\n                    JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                    ${conditions}\r\n                    GROUP BY po.num, vendor.name, poitem.dateScheduledFulfillment, postatus.name\r\n                    ORDER BY poitem.dateScheduledFulfillment\r\n                `;\r\n\r\n                const data = JSON.parse(runQuery(query));\r\n\r\n                const columns = [\r\n                    { key: 'po_num', label: 'PO #' },\r\n                    { key: 'vendor_name', label: 'Vendor' },\r\n                    { key: 'due_date', label: 'Due Date', type: 'date' },\r\n                    { key: 'days_until', label: 'Days Until', type: 'number' },\r\n                    { key: 'po_value', label: 'Value', type: 'currency' },\r\n                    { key: 'status', label: 'Status' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    'Expected Receipts (Next 7 Days)',\r\n                    'Expected PO Receipts',\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownExpectedReceipts: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownOverduePOs() {\r\n            try {\r\n                debugLog('Drill-down: Overdue POs', 'click');\r\n                const vendor = document.getElementById('vendorFilter').value;\r\n                const productCategory = document.getElementById('productCategoryFilter').value;\r\n                const abcCode = document.getElementById('abcCodeFilter').value;\r\n                const location = document.getElementById('locationFilter').value;\r\n\r\n                let conditions = `WHERE po.statusid IN (20, 30, 40)\r\n                    AND poitem.dateScheduledFulfillment < CURDATE()`;\r\n\r\n                if (vendor !== '%') {\r\n                    conditions += ` AND vendor.id = ${parseInt(vendor)}`;\r\n                }\r\n                if (productCategory !== '%') {\r\n                    conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;\r\n                }\r\n                if (abcCode !== '%') {\r\n                    conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;\r\n                }\r\n                if (location !== '%') {\r\n                    conditions += ` AND locationgroup.id = ${parseInt(location)}`;\r\n                }\r\n\r\n                const query = `\r\n                    SELECT\r\n                        po.num as po_num,\r\n                        vendor.name as vendor_name,\r\n                        poitem.dateScheduledFulfillment as due_date,\r\n                        DATEDIFF(CURDATE(), poitem.dateScheduledFulfillment) as days_overdue,\r\n                        SUM(poitem.qtytofulfill * poitem.unitcost) as po_value,\r\n                        postatus.name as status\r\n                    FROM po\r\n                    JOIN poitem ON poitem.poid = po.id\r\n                    LEFT JOIN part ON poitem.partid = part.id\r\n                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                    JOIN vendor ON po.vendorid = vendor.id\r\n                    JOIN postatus ON po.statusid = postatus.id\r\n                    JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                    ${conditions}\r\n                    GROUP BY po.num, vendor.name, poitem.dateScheduledFulfillment, postatus.name\r\n                    ORDER BY days_overdue DESC\r\n                `;\r\n\r\n                const data = JSON.parse(runQuery(query));\r\n\r\n                const columns = [\r\n                    { key: 'po_num', label: 'PO #' },\r\n                    { key: 'vendor_name', label: 'Vendor' },\r\n                    { key: 'due_date', label: 'Due Date', type: 'date' },\r\n                    { key: 'days_overdue', label: 'Days Overdue', type: 'number' },\r\n                    { key: 'po_value', label: 'Value', type: 'currency' },\r\n                    { key: 'status', label: 'Status' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    'Overdue Purchase Orders',\r\n                    'Overdue POs',\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownOverduePOs: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownRecentlyReceived() {\r\n            try {\r\n                debugLog('Drill-down: Recently Received', 'click');\r\n                const conditions = buildFilterConditions();\r\n\r\n                const query = `\r\n                    SELECT\r\n                        po.num as po_num,\r\n                        vendor.name as vendor_name,\r\n                        postpo.postdate as received_date,\r\n                        SUM(postpoitem.postedtotalcost) as po_value,\r\n                        postatus.name as status\r\n                    FROM postpoitem\r\n                    JOIN postpo ON postpoitem.postpoid = postpo.id\r\n                    JOIN poitem ON postpoitem.poitemid = poitem.id\r\n                    LEFT JOIN part ON poitem.partid = part.id\r\n                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId\r\n                    JOIN po ON poitem.poid = po.id\r\n                    JOIN vendor ON po.vendorid = vendor.id\r\n                    JOIN postatus ON po.statusid = postatus.id\r\n                    JOIN locationgroup ON po.locationgroupid = locationgroup.id\r\n                    ${conditions}\r\n                    GROUP BY po.num, vendor.name, postpo.postdate, postatus.name\r\n                    ORDER BY postpo.postdate DESC\r\n                    LIMIT 100\r\n                `;\r\n\r\n                const data = JSON.parse(runQuery(query));\r\n\r\n                const columns = [\r\n                    { key: 'po_num', label: 'PO #' },\r\n                    { key: 'vendor_name', label: 'Vendor' },\r\n                    { key: 'received_date', label: 'Received Date', type: 'date' },\r\n                    { key: 'po_value', label: 'Value', type: 'currency' },\r\n                    { key: 'status', label: 'Status' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    'Recently Received POs',\r\n                    'Recently Received',\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownRecentlyReceived: ${error.message}`, 'error');\r\n            }\r\n        }\r\n    </script>\r\n</body>\r\n</html>\r\n",
  "active" : true,
  "note" : "",
  "type" : "Page"
} ]