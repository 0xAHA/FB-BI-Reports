[ {
  "name" : "- Dashboard - Sales",
  "description" : "- Dashboard - Sales",
  "data" : "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Sales Dashboard - Fishbowl Advanced</title>\r\n\r\n    <!-- Tailwind CSS -->\r\n    <script src=\"https://cdn.tailwindcss.com\"></script>\r\n\r\n    <!-- D3.js v7 -->\r\n    <script src=\"https://d3js.org/d3.v7.min.js\"></script>\r\n\r\n    <!-- Moment.js -->\r\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js\"></script>\r\n\r\n    <!-- Google Fonts -->\r\n    <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap\" rel=\"stylesheet\">\r\n\r\n    <style>\r\n        html, body {\r\n            height: 100%;\r\n            margin: 0;\r\n            padding: 0;\r\n            overflow: hidden;\r\n            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\r\n        }\r\n\r\n        /* Custom Brand Colors (matching Gantt v3) */\r\n        :root {\r\n            --color-primary: #2d9cdb;\r\n            --color-primary-dark: #1e7bb4;\r\n            --color-sidebar: #06162d;\r\n            --color-sidebar-hover: #0a1f3d;\r\n        }\r\n\r\n        /* Custom Scrollbar */\r\n        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }\r\n        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }\r\n\r\n        /* Override Tailwind indigo with custom blue */\r\n        .bg-indigo-600 { background-color: var(--color-primary) !important; }\r\n        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }\r\n        .text-indigo-600 { color: var(--color-primary) !important; }\r\n        .text-indigo-700 { color: var(--color-primary-dark) !important; }\r\n        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }\r\n        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }\r\n        .hover\\:text-indigo-600:hover { color: var(--color-primary) !important; }\r\n        .hover\\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }\r\n        .hover\\:bg-indigo-100:hover { background-color: rgba(45, 156, 219, 0.15) !important; }\r\n        .focus\\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }\r\n        .focus\\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }\r\n        .focus\\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }\r\n\r\n        /* D3 Chart Styles */\r\n        .axis line, .axis path {\r\n            stroke: #cbd5e1;\r\n            shape-rendering: crispEdges;\r\n        }\r\n\r\n        .axis text {\r\n            fill: #64748b;\r\n            font-size: 11px;\r\n            font-weight: 500;\r\n        }\r\n\r\n        .grid line {\r\n            stroke: #e2e8f0;\r\n            stroke-opacity: 0.7;\r\n            shape-rendering: crispEdges;\r\n        }\r\n\r\n        .line {\r\n            fill: none;\r\n            stroke-width: 2.5px;\r\n        }\r\n\r\n        .area {\r\n            opacity: 0.3;\r\n        }\r\n\r\n        .tooltip {\r\n            position: absolute;\r\n            background: rgba(15, 23, 42, 0.95);\r\n            color: white;\r\n            padding: 12px 16px;\r\n            border-radius: 8px;\r\n            font-size: 13px;\r\n            pointer-events: none;\r\n            opacity: 0;\r\n            transition: opacity 0.2s;\r\n            z-index: 1000;\r\n            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);\r\n            max-width: 300px;\r\n        }\r\n\r\n        .tooltip-label {\r\n            color: #94a3b8;\r\n            display: inline-block;\r\n            min-width: 90px;\r\n            font-weight: 500;\r\n        }\r\n\r\n        .tooltip-value {\r\n            color: #ffffff;\r\n            font-weight: 600;\r\n            margin-left: 8px;\r\n        }\r\n\r\n        /* Loading spinner */\r\n        .spinner {\r\n            border: 3px solid #f1f5f9;\r\n            border-top: 3px solid var(--color-primary);\r\n            border-radius: 50%;\r\n            width: 40px;\r\n            height: 40px;\r\n            animation: spin 1s linear infinite;\r\n        }\r\n\r\n        @keyframes spin {\r\n            0% { transform: rotate(0deg); }\r\n            100% { transform: rotate(360deg); }\r\n        }\r\n\r\n        /* Margin color coding */\r\n        .margin-good { fill: #10b981; }\r\n        .margin-medium { fill: #f59e0b; }\r\n        .margin-low { fill: #ef4444; }\r\n\r\n        /* Order link styling */\r\n        .order-link {\r\n            color: var(--color-primary);\r\n            text-decoration: none;\r\n            font-weight: 600;\r\n            transition: color 0.2s ease;\r\n        }\r\n\r\n        .order-link:hover {\r\n            color: var(--color-primary-dark);\r\n            text-decoration: underline;\r\n        }\r\n    </style>\r\n</head>\r\n<body class=\"bg-slate-50\">\r\n    <div class=\"flex flex-col h-screen\">\r\n        <!-- Header (matching Gantt v3) -->\r\n        <header class=\"h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm\">\r\n            <div class=\"flex items-center gap-6\">\r\n                <div>\r\n                    <h1 class=\"text-xl font-bold text-slate-900\">\r\n                        Sales Dashboard\r\n                        <span id=\"dateRangeDisplay\" class=\"text-sm font-normal text-slate-500 ml-2\"></span>\r\n                    </h1>\r\n                    <p class=\"text-xs text-slate-500 mt-0.5\">Revenue, margins, and sales analytics</p>\r\n                </div>\r\n\r\n                <!-- KPI Summary in Header -->\r\n                <div id=\"kpiCards\" class=\"hidden lg:flex items-center gap-3\">\r\n                    <!-- Will be populated dynamically -->\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"flex items-center gap-3\">\r\n                <!-- Export Button -->\r\n                <button onclick=\"exportToCSV()\" class=\"px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors\" title=\"Export CSV\">\r\n                    <svg class=\"w-4 h-4 inline mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path>\r\n                    </svg>\r\n                    Export\r\n                </button>\r\n\r\n                <!-- Refresh Button -->\r\n                <button onclick=\"loadDashboard()\" class=\"p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all\" title=\"Refresh Data\">\r\n                    <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\"></path>\r\n                    </svg>\r\n                </button>\r\n            </div>\r\n        </header>\r\n\r\n        <!-- Content Area -->\r\n        <div class=\"flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8\">\r\n            <!-- Filters Section -->\r\n            <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-4 mb-4\">\r\n                <div class=\"flex items-center justify-between mb-3\">\r\n                    <h3 class=\"text-base font-bold text-slate-800 flex items-center gap-2\">\r\n                        <svg class=\"w-4 h-4 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\"></path>\r\n                        </svg>\r\n                        <span>Filters</span>\r\n                        <button onclick=\"clearAllFilters()\" class=\"ml-2 px-2 py-1 text-xs text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex items-center gap-1\" title=\"Clear All Filters\">\r\n                            <svg class=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                            </svg>\r\n                            Clear\r\n                        </button>\r\n                    </h3>\r\n\r\n                    <div class=\"flex items-center gap-2 flex-wrap\">\r\n                        <!-- Comparison Toggle -->\r\n                        <div id=\"comparisonToggleContainer\" class=\"flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200\" style=\"display: none;\">\r\n                            <input type=\"checkbox\" id=\"comparisonToggle\" onchange=\"toggleComparison()\" class=\"w-3.5 h-3.5 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500\">\r\n                            <label for=\"comparisonToggle\" class=\"text-xs font-semibold text-slate-700 cursor-pointer\">Compare to Previous Period</label>\r\n                        </div>\r\n\r\n                        <!-- Date Range Dropdown -->\r\n                        <div class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200\">\r\n                            <svg class=\"w-4 h-4 text-slate-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\"></path>\r\n                            </svg>\r\n                            <select id=\"dateRangeFilter\" onchange=\"applyDateRange()\" class=\"px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700 font-semibold\" style=\"width: 180px;\">\r\n                                <option value=\"90\">Last 90 Days</option>\r\n                                <option value=\"30\">Last 30 Days</option>\r\n                                <option value=\"60\">Last 60 Days</option>\r\n                                <option value=\"180\">Last 6 Months</option>\r\n                                <option value=\"365\">Last Year</option>\r\n                                <option value=\"this_quarter\">This Quarter</option>\r\n                                <option value=\"last_quarter\">Last Quarter</option>\r\n                                <option value=\"current_fy\">Current Financial Year</option>\r\n                                <option value=\"last_fy\">Last Financial Year</option>\r\n                                <option value=\"current_cy\">Current Calendar Year</option>\r\n                                <option value=\"last_cy\">Last Calendar Year</option>\r\n                                <option value=\"custom\">Custom Range</option>\r\n                            </select>\r\n                        </div>\r\n\r\n                        <!-- Custom Date Range Picker -->\r\n                        <div id=\"customDateRangeContainer\" class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200\" style=\"display: none;\">\r\n                            <input type=\"date\" id=\"customStartDate\" class=\"px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700\" style=\"width: 110px;\" onchange=\"applyCustomDateRange()\" title=\"Start Date\">\r\n                            <span class=\"text-slate-400 text-xs\">to</span>\r\n                            <input type=\"date\" id=\"customEndDate\" class=\"px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700\" style=\"width: 110px;\" onchange=\"applyCustomDateRange()\" title=\"End Date\">\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"grid grid-cols-1 md:grid-cols-4 gap-3\">\r\n                    <!-- Customer Group -->\r\n                    <div>\r\n                        <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">Customer Group</label>\r\n                        <select id=\"customerGroupFilter\" onchange=\"loadDashboard()\" class=\"w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600\">\r\n                            <option value=\"%\">All Groups</option>\r\n                        </select>\r\n                    </div>\r\n\r\n                    <!-- Product Category -->\r\n                    <div>\r\n                        <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">Product Category</label>\r\n                        <select id=\"productCategoryFilter\" onchange=\"loadDashboard()\" class=\"w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600\">\r\n                            <option value=\"%\">All Categories</option>\r\n                        </select>\r\n                    </div>\r\n\r\n                    <!-- Sales Person -->\r\n                    <div>\r\n                        <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">Sales Person</label>\r\n                        <select id=\"accountManagerFilter\" onchange=\"loadDashboard()\" class=\"w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600\">\r\n                            <option value=\"%\">All Sales People</option>\r\n                        </select>\r\n                    </div>\r\n\r\n                    <!-- Margin Filter -->\r\n                    <div>\r\n                        <label class=\"block text-[11px] font-semibold text-slate-600 mb-1.5\">Margin Level</label>\r\n                        <select id=\"marginFilter\" onchange=\"loadDashboard()\" class=\"w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600\">\r\n                            <option value=\"%\">All Margins</option>\r\n                            <option value=\"good\">Good (&gt; 30%)</option>\r\n                            <option value=\"medium\">Medium (15-30%)</option>\r\n                            <option value=\"low\">Low (&lt; 15%)</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Monthly Sales & Margin - Full Width -->\r\n            <div class=\"grid grid-cols-1 gap-6 mb-6\">\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <div class=\"flex items-center justify-between mb-4\">\r\n                        <h3 class=\"text-lg font-bold text-slate-800 flex items-center gap-2\">\r\n                            <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 7h8m0 0v8m0-8l-8 8-4-4-6 6\"></path>\r\n                            </svg>\r\n                            Monthly Sales & Margin\r\n                        </h3>\r\n                        <div class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200\">\r\n                            <button onclick=\"toggleRevenueChartMode('line')\" id=\"revenueLineBtn\" class=\"px-2 py-1 text-xs font-semibold bg-white rounded transition-colors text-slate-800\" title=\"Line Chart\">\r\n                                <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z\"></path>\r\n                                </svg>\r\n                            </button>\r\n                            <button onclick=\"toggleRevenueChartMode('bar')\" id=\"revenueBarBtn\" class=\"px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600\" title=\"Bar Chart\">\r\n                                <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\"></path>\r\n                                </svg>\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                    <div id=\"revenueChart\" style=\"height: 300px;\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Top Row: Customers, Products, and Sales People -->\r\n            <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6\">\r\n                <!-- Top 10 Customers by Revenue -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\"></path>\r\n                        </svg>\r\n                        Top 10 Customers by Revenue\r\n                    </h3>\r\n                    <div id=\"customersChart\" style=\"height: 300px;\"></div>\r\n                </div>\r\n\r\n                <!-- Top Products -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\"></path>\r\n                        </svg>\r\n                        Top Products\r\n                    </h3>\r\n                    <div id=\"productsChart\" style=\"height: 300px;\"></div>\r\n                </div>\r\n\r\n                <!-- Top Salespeople -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\"></path>\r\n                        </svg>\r\n                        Top Sales People\r\n                    </h3>\r\n                    <div id=\"salespeopleChart\" style=\"height: 280px;\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Product Tree and Customer Groups Row -->\r\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                <!-- Product Tree (formerly Sales by Category) -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z\"></path>\r\n                        </svg>\r\n                        Product Tree\r\n                    </h3>\r\n                    <div id=\"categoryChart\" style=\"height: 280px;\"></div>\r\n                </div>\r\n\r\n                <!-- Customer Groups -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\"></path>\r\n                        </svg>\r\n                        Customer Groups\r\n                    </h3>\r\n                    <div id=\"groupChart\" style=\"height: 280px;\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Critical Alerts Row: Low Margin, Negative Margin, High Value -->\r\n            <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4\">\r\n                <!-- Low Margin Sales (< 15%) -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-amber-200 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"></path>\r\n                        </svg>\r\n                        Low Margin Sales (&lt; 15%)\r\n                    </h3>\r\n                    <div id=\"lowMarginMetric\" class=\"text-center mb-4\">\r\n                        <div class=\"text-4xl font-bold text-amber-600\">-</div>\r\n                        <div class=\"text-sm text-slate-500 mt-1\">Orders</div>\r\n                    </div>\r\n                    <div id=\"lowMarginChart\" style=\"height: 200px;\"></div>\r\n                </div>\r\n\r\n                <!-- Negative Margin Orders -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-red-200 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                        </svg>\r\n                        Negative Margin Orders\r\n                    </h3>\r\n                    <div id=\"negativeMarginMetric\" class=\"text-center mb-4\">\r\n                        <div class=\"text-4xl font-bold text-red-600\">-</div>\r\n                        <div class=\"text-sm text-slate-500 mt-1\">Orders at Loss</div>\r\n                    </div>\r\n                    <div id=\"negativeMarginChart\" style=\"height: 200px;\"></div>\r\n                </div>\r\n\r\n                <!-- High Value Orders -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-green-200 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                        </svg>\r\n                        High Value Orders (&gt; $10k)\r\n                    </h3>\r\n                    <div id=\"highValueMetric\" class=\"text-center mb-4\">\r\n                        <div class=\"text-4xl font-bold text-green-600\">-</div>\r\n                        <div class=\"text-sm text-slate-500 mt-1\">Large Orders</div>\r\n                    </div>\r\n                    <div id=\"highValueChart\" style=\"height: 200px;\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Customer Insights Row -->\r\n            <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4\">\r\n                <!-- New vs Repeat Customers -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z\"></path>\r\n                        </svg>\r\n                        New vs Repeat Customers\r\n                    </h3>\r\n                    <div id=\"newRepeatChart\" style=\"height: 280px;\"></div>\r\n                </div>\r\n\r\n                <!-- Top Customers by Margin % -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z\"></path>\r\n                        </svg>\r\n                        Top Customers by Margin %\r\n                    </h3>\r\n                    <div id=\"topMarginCustomersChart\" style=\"height: 280px;\"></div>\r\n                </div>\r\n\r\n                <!-- Inactive Customers -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                        </svg>\r\n                        Inactive Customers (90+ Days)\r\n                    </h3>\r\n                    <div id=\"inactiveCustomersMetric\" class=\"text-center mb-4\">\r\n                        <div class=\"text-4xl font-bold text-slate-700\">-</div>\r\n                        <div class=\"text-sm text-slate-500 mt-1\">Inactive</div>\r\n                    </div>\r\n                    <div id=\"inactiveCustomersChart\" style=\"height: 200px;\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Product Performance Row -->\r\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4\">\r\n                <!-- DIFOT (Delivery Performance) -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path d=\"M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z\"></path>\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0\"></path>\r\n                        </svg>\r\n                        DIFOT (Delivery Performance)\r\n                    </h3>\r\n                    <div id=\"avgDaysMetric\"></div>\r\n                </div>\r\n\r\n                <!-- Slow-Moving Inventory -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-orange-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4\"></path>\r\n                        </svg>\r\n                        Slow-Moving Inventory\r\n                    </h3>\r\n                    <div id=\"slowMovingChart\" style=\"height: 280px;\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Sales Team Performance Row -->\r\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4\">\r\n                <!-- Sales Orders per Salesperson -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01\"></path>\r\n                        </svg>\r\n                        Orders per Salesperson\r\n                    </h3>\r\n                    <div id=\"ordersPerSalespersonChart\" style=\"height: 280px;\"></div>\r\n                </div>\r\n\r\n                <!-- Average Order Value -->\r\n                <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                        </svg>\r\n                        Average Order Value\r\n                    </h3>\r\n                    <div id=\"aovMetric\" style=\"height: 280px;\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Loading Overlay -->\r\n            <div id=\"loadingOverlay\" style=\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;\">\r\n                <div style=\"background: white; padding: 2rem; border-radius: 1rem; text-align: center;\">\r\n                    <div class=\"spinner mx-auto mb-4\"></div>\r\n                    <p class=\"text-slate-700 font-medium\">Loading sales data...</p>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Debug Console (hidden by default, shown if BI_SHOW_DEBUG=true) -->\r\n            <div id=\"debugConsoleContainer\" class=\"mt-6\" style=\"display: none;\">\r\n                <div class=\"bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden\">\r\n                    <button onclick=\"toggleDebugConsole()\" class=\"w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors\">\r\n                        <div class=\"flex items-center gap-2\">\r\n                            <svg class=\"w-4 h-4 text-slate-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4\"></path>\r\n                            </svg>\r\n                            <span class=\"text-sm font-semibold text-slate-700\">Debug Console</span>\r\n                            <span class=\"text-xs text-slate-400 font-normal\">Auto-scrolls to latest entry</span>\r\n                        </div>\r\n                        <svg id=\"debugChevron\" class=\"w-5 h-5 text-slate-400 transition-transform\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 9l-7 7-7-7\"></path>\r\n                        </svg>\r\n                    </button>\r\n\r\n                    <div id=\"debugContent\" class=\"hidden border-t border-slate-200\">\r\n                        <div class=\"bg-slate-900 px-4 py-2 flex items-center justify-between\">\r\n                            <span class=\"text-xs text-slate-400 font-mono\">Drill-down & Application Diagnostics</span>\r\n                            <button onclick=\"clearDebugLog()\" class=\"text-xs text-slate-400 hover:text-white transition-colors\">\r\n                                Clear\r\n                            </button>\r\n                        </div>\r\n                        <div id=\"debugLog\" class=\"bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto\" style=\"scrollbar-width: thin;\">\r\n                            <div class=\"text-slate-500 italic\">Waiting for application to initialize...</div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Tooltip -->\r\n    <div id=\"tooltip\" class=\"tooltip\"></div>\r\n\r\n    <!-- Drill-down Modal -->\r\n    <div id=\"drilldownModal\" class=\"fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center\" onclick=\"closeDrilldown(event)\">\r\n        <div class=\"bg-white rounded-2xl shadow-2xl w-11/12 max-w-6xl max-h-[90vh] flex flex-col\" onclick=\"event.stopPropagation()\">\r\n            <!-- Modal Header -->\r\n            <div class=\"flex items-center justify-between px-6 py-4 border-b border-slate-200\">\r\n                <div>\r\n                    <h2 id=\"drilldownTitle\" class=\"text-xl font-bold text-slate-800\"></h2>\r\n                    <div id=\"drilldownBreadcrumb\" class=\"text-sm text-slate-500 mt-1\"></div>\r\n                </div>\r\n                <div class=\"flex items-center gap-2\">\r\n                    <button onclick=\"exportDrilldownData()\" class=\"px-3 py-2 text-sm font-semibold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all flex items-center gap-2\">\r\n                        <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path>\r\n                        </svg>\r\n                        Export CSV\r\n                    </button>\r\n                    <button onclick=\"closeDrilldown()\" class=\"p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                        </svg>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Modal Body -->\r\n            <div class=\"flex-1 overflow-auto px-6 py-4\">\r\n                <!-- Search Box -->\r\n                <div class=\"mb-4\">\r\n                    <input type=\"text\" id=\"drilldownSearch\" placeholder=\"Search...\" class=\"w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500\" oninput=\"filterDrilldownTable()\">\r\n                </div>\r\n\r\n                <!-- Table -->\r\n                <div class=\"overflow-x-auto\">\r\n                    <table id=\"drilldownTable\" class=\"w-full text-sm\">\r\n                        <thead id=\"drilldownTableHead\" class=\"bg-slate-50 sticky top-0\">\r\n                            <!-- Dynamic headers -->\r\n                        </thead>\r\n                        <tbody id=\"drilldownTableBody\" class=\"divide-y divide-slate-200\">\r\n                            <!-- Dynamic rows -->\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <script>\r\n        // ============================================\r\n        // Global Variables\r\n        // ============================================\r\n        let currentDateRange = 90;\r\n        let comparisonEnabled = false;\r\n        let customStartDate = null;\r\n        let customEndDate = null;\r\n        const tooltip = d3.select('#tooltip');\r\n\r\n        // Color palette (matching Gantt v3 theme)\r\n        const colorPalette = [\r\n            '#2d9cdb', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',\r\n            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'\r\n        ];\r\n\r\n        // Margin thresholds\r\n        const MARGIN_GOOD = 0.30;\r\n        const MARGIN_MEDIUM = 0.15;\r\n\r\n        // Financial Year start month (1-12, default 7 = July)\r\n        // Configure via Fishbowl property: BI_FY_START_MONTH\r\n        const FY_START_MONTH = parseInt(getProperty('BI_FY_START_MONTH', '7')) || 7;\r\n\r\n        // Debug mode from Fishbowl system property (default to false)\r\n        const BI_SHOW_DEBUG_PROP = typeof getProperty === 'function' ? getProperty('BI_SHOW_DEBUG', 'false') : 'false';\r\n        const DEBUG_MODE = BI_SHOW_DEBUG_PROP === 'true' || BI_SHOW_DEBUG_PROP === true;\r\n\r\n        // Date format from Fishbowl system property (default to US format)\r\n        const FB_DATE_FORMAT = typeof getProperty === 'function' ? getProperty('DateFormatShort', 'MM/dd/yyyy') : 'MM/dd/yyyy';\r\n        // Convert Java SimpleDateFormat to moment.js format (dd -> DD, yyyy -> YYYY)\r\n        const MOMENT_DATE_FORMAT = FB_DATE_FORMAT\r\n            .replace(/yyyy/g, 'YYYY')\r\n            .replace(/yy/g, 'YY')\r\n            .replace(/dd/g, 'DD');\r\n\r\n        // Price formatting from Fishbowl system property\r\n        // Format: \"$ #,##0.00\" - currency symbol followed by number format\r\n        const PRICE_FORMAT = getProperty('REPORT_DECIMAL_PRICE', '$ #,##0.00');\r\n\r\n        // Currency code to symbol mapping (ISO 4217 codes)\r\n        const CURRENCY_SYMBOLS = {\r\n            'AUD': '$',      // Australian Dollar\r\n            'USD': '$',      // US Dollar\r\n            'NZD': '$',      // New Zealand Dollar\r\n            'CAD': '$',      // Canadian Dollar\r\n            'SGD': '$',      // Singapore Dollar\r\n            'HKD': '$',      // Hong Kong Dollar\r\n            'EUR': '€',      // Euro\r\n            'GBP': '£',      // British Pound\r\n            'JPY': '¥',      // Japanese Yen\r\n            'CNY': '¥',      // Chinese Yuan\r\n            'CHF': 'CHF',    // Swiss Franc\r\n            'SEK': 'kr',     // Swedish Krona\r\n            'NOK': 'kr',     // Norwegian Krone\r\n            'DKK': 'kr',     // Danish Krone\r\n            'INR': '₹',      // Indian Rupee\r\n            'ZAR': 'R',      // South African Rand\r\n            'BRL': 'R$',     // Brazilian Real\r\n            'MXN': '$',      // Mexican Peso\r\n            'KRW': '₩',      // South Korean Won\r\n            'THB': '฿',      // Thai Baht\r\n            'MYR': 'RM',     // Malaysian Ringgit\r\n            'PHP': '₱',      // Philippine Peso\r\n            'IDR': 'Rp',     // Indonesian Rupiah\r\n            'AED': 'د.إ',    // UAE Dirham\r\n            'SAR': '﷼',      // Saudi Riyal\r\n            'RUB': '₽',      // Russian Ruble\r\n            'PLN': 'zł',     // Polish Zloty\r\n            'TRY': '₺',      // Turkish Lira\r\n            'ILS': '₪',      // Israeli Shekel\r\n            'CZK': 'Kč',     // Czech Koruna\r\n            'HUF': 'Ft',     // Hungarian Forint\r\n            'TWD': 'NT$',    // Taiwan Dollar\r\n            'VND': '₫',      // Vietnamese Dong\r\n        };\r\n\r\n        // Get home currency symbol from database\r\n        function getHomeCurrencySymbol() {\r\n            try {\r\n                const query = `SELECT code FROM currency WHERE homeCurrency = 1 LIMIT 1`;\r\n                const result = runQuery(query);\r\n                if (result) {\r\n                    const parsed = JSON.parse(result);\r\n                    if (parsed && parsed.length > 0 && parsed[0].code) {\r\n                        const code = parsed[0].code.toUpperCase();\r\n                        const symbol = CURRENCY_SYMBOLS[code] || code;\r\n                        debugLog(`Home currency: ${code} → Symbol: ${symbol}`, 'info');\r\n                        return symbol;\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                debugLog(`getHomeCurrencySymbol error: ${e.message}`, 'error');\r\n            }\r\n            // Fallback to parsing from REPORT_DECIMAL_PRICE\r\n            return PRICE_FORMAT.match(/^[^#0,.\\s]+/) ? PRICE_FORMAT.match(/^[^#0,.\\s]+/)[0].trim() : '$';\r\n        }\r\n\r\n        // Parse decimal places from price format\r\n        const DECIMAL_PLACES = (PRICE_FORMAT.match(/\\.([0#]+)$/) || ['', '00'])[1].length;\r\n\r\n        // Get the currency symbol (from DB or fallback)\r\n        const CURRENCY_SYMBOL = getHomeCurrencySymbol();\r\n\r\n        // Global currency formatting function\r\n        function formatCurrency(value, showDecimals = true) {\r\n            const num = parseFloat(value || 0);\r\n            const isNegative = num < 0;\r\n            const absValue = Math.abs(num);\r\n            const decimals = showDecimals ? DECIMAL_PLACES : 0;\r\n            const formatted = absValue.toLocaleString('en-US', {\r\n                minimumFractionDigits: decimals,\r\n                maximumFractionDigits: decimals\r\n            });\r\n            return isNegative ? `-${CURRENCY_SYMBOL}${formatted}` : `${CURRENCY_SYMBOL}${formatted}`;\r\n        }\r\n\r\n        // ============================================\r\n        // SQL Helper Functions\r\n        // ============================================\r\n        function escapeSQL(str) {\r\n            if (str === null || str === undefined) return str;\r\n            // Escape single quotes by doubling them\r\n            return str.toString().replace(/'/g, \"''\");\r\n        }\r\n\r\n        // ============================================\r\n        // Module Opening Functions\r\n        // ============================================\r\n        function openSalesOrder(orderNumber) {\r\n            openModule(\"Sales Order\", orderNumber);\r\n        }\r\n\r\n        function getDateRange() {\r\n            return {\r\n                start: customStartDate,\r\n                end: customEndDate\r\n            };\r\n        }\r\n\r\n        // Revenue chart view mode\r\n        let revenueChartMode = 'line'; // 'line' or 'bar'\r\n\r\n        // Drill-down data\r\n        let currentDrilldownData = [];\r\n        let currentDrilldownColumns = [];\r\n        let currentSortColumn = null;\r\n        let currentSortDirection = 'asc';\r\n\r\n        // ============================================\r\n        // Helper Functions\r\n        // ============================================\r\n        // Date range calculation functions\r\n        function getQuarterDates(offset = 0) {\r\n            const now = moment();\r\n            // Get the start of the current quarter, then subtract offset quarters\r\n            // This properly handles year rollover (e.g., Q1 2026 -> Q4 2025)\r\n            const currentQuarterStart = moment(now).startOf('quarter');\r\n            const targetQuarterStart = moment(currentQuarterStart).subtract(offset, 'quarters');\r\n\r\n            const startDate = targetQuarterStart.startOf('quarter');\r\n            const endDate = moment(startDate).endOf('quarter');\r\n\r\n            return {\r\n                start: startDate.format('YYYY-MM-DD'),\r\n                end: endDate.format('YYYY-MM-DD')\r\n            };\r\n        }\r\n\r\n        function getFYDates(offset = 0) {\r\n            // Financial Year: Configurable via BI_FY_START_MONTH property (1-12)\r\n            // Default: July (7) to June (6) - Australian/UK financial year\r\n            // US fiscal year would be October (10) to September (9)\r\n            const now = moment();\r\n            const currentMonth = now.month() + 1; // Convert 0-11 to 1-12\r\n            const currentYear = now.year();\r\n\r\n            // FY_START_MONTH is 1-12 (e.g., 7 = July, 10 = October, 1 = January)\r\n            const fyStartMonth = Math.max(1, Math.min(12, FY_START_MONTH)); // Clamp to valid range\r\n\r\n            // Determine which FY we're currently in\r\n            // If current month >= start month, we're in FY starting this year\r\n            // If current month < start month, we're in FY that started last year\r\n            let fyStartYear = currentMonth >= fyStartMonth ? currentYear : currentYear - 1;\r\n            fyStartYear -= offset;\r\n\r\n            // Calculate end month and year\r\n            // FY ends in the month before start month, in the following year (unless start is January)\r\n            let fyEndMonth, fyEndYear;\r\n            if (fyStartMonth === 1) {\r\n                // January start = calendar year (Jan-Dec)\r\n                fyEndMonth = 12;\r\n                fyEndYear = fyStartYear;\r\n            } else {\r\n                fyEndMonth = fyStartMonth - 1;\r\n                fyEndYear = fyStartYear + 1;\r\n            }\r\n\r\n            // Get the last day of the end month\r\n            const endDate = moment([fyEndYear, fyEndMonth - 1, 1]).endOf('month');\r\n\r\n            return {\r\n                start: `${fyStartYear}-${String(fyStartMonth).padStart(2, '0')}-01`,\r\n                end: endDate.format('YYYY-MM-DD')\r\n            };\r\n        }\r\n\r\n        function getCalendarYearDates(offset = 0) {\r\n            const year = moment().year() - offset;\r\n            return {\r\n                start: `${year}-01-01`,\r\n                end: `${year}-12-31`\r\n            };\r\n        }\r\n\r\n        function getPreviousPeriodDates() {\r\n            if (!customStartDate || !customEndDate) return null;\r\n\r\n            const start = moment(customStartDate);\r\n            const end = moment(customEndDate);\r\n            const duration = end.diff(start, 'days');\r\n\r\n            const prevEnd = moment(customStartDate).subtract(1, 'day');\r\n            const prevStart = prevEnd.clone().subtract(duration, 'days');\r\n\r\n            return {\r\n                start: prevStart.format('YYYY-MM-DD'),\r\n                end: prevEnd.format('YYYY-MM-DD')\r\n            };\r\n        }\r\n\r\n        function getDateCondition(usePreviousPeriod = false) {\r\n            if (usePreviousPeriod && comparisonEnabled) {\r\n                const prevDates = getPreviousPeriodDates();\r\n                if (prevDates) {\r\n                    return `PostSo.PostDate >= '${prevDates.start}' AND PostSo.PostDate <= '${prevDates.end}'`;\r\n                }\r\n            }\r\n\r\n            if (customStartDate && customEndDate) {\r\n                return `PostSo.PostDate >= '${customStartDate}' AND PostSo.PostDate <= '${customEndDate}'`;\r\n            } else {\r\n                // Fallback to currentDateRange, defaulting to 90 days if null/undefined\r\n                const days = currentDateRange || 90;\r\n                return `PostSo.PostDate >= DATE_SUB(NOW(), INTERVAL ${days} DAY)`;\r\n            }\r\n        }\r\n\r\n        function debugLog(message, type = 'info') {\r\n            // Only log if DEBUG_MODE is enabled\r\n            if (!DEBUG_MODE) return;\r\n\r\n            const timestamp = new Date().toLocaleTimeString();\r\n            const logDiv = document.getElementById('debugLog');\r\n\r\n            // Clear initial message\r\n            if (logDiv.querySelector('.italic')) {\r\n                logDiv.innerHTML = '';\r\n            }\r\n\r\n            const colors = {\r\n                'info': 'text-blue-400',\r\n                'success': 'text-green-400',\r\n                'warning': 'text-yellow-400',\r\n                'error': 'text-red-400',\r\n                'click': 'text-purple-400'\r\n            };\r\n\r\n            const entry = document.createElement('div');\r\n            entry.className = 'mb-1';\r\n            entry.innerHTML = `<span class=\"text-slate-500\">[${timestamp}]</span> <span class=\"${colors[type] || colors.info}\">${message}</span>`;\r\n\r\n            logDiv.appendChild(entry);\r\n            logDiv.scrollTop = logDiv.scrollHeight;\r\n        }\r\n\r\n        function showTooltip(event, html) {\r\n            tooltip.style('opacity', 1)\r\n                .html(html)\r\n                .style('left', (event.pageX + 10) + 'px')\r\n                .style('top', (event.pageY - 10) + 'px');\r\n        }\r\n\r\n        function hideTooltip() {\r\n            tooltip.style('opacity', 0);\r\n        }\r\n\r\n        function toggleDebugConsole() {\r\n            const content = document.getElementById('debugContent');\r\n            const chevron = document.getElementById('debugChevron');\r\n\r\n            if (content.classList.contains('hidden')) {\r\n                content.classList.remove('hidden');\r\n                chevron.style.transform = 'rotate(180deg)';\r\n            } else {\r\n                content.classList.add('hidden');\r\n                chevron.style.transform = 'rotate(0deg)';\r\n            }\r\n        }\r\n\r\n        function clearDebugLog() {\r\n            const logDiv = document.getElementById('debugLog');\r\n            logDiv.innerHTML = '<div class=\"text-slate-500 italic\">Log cleared</div>';\r\n        }\r\n\r\n        // ============================================\r\n        // Fishbowl SQL Queries\r\n        // ============================================\r\n\r\n        function getSalesRevenueOverTime() {\r\n            const conditions = buildFilterConditions();\r\n\r\n            const query = `\r\n                SELECT\r\n                    DATE_FORMAT(PostSo.PostDate, '%Y-%m-01') as month,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                    SUM(PostSoItem.PostedTotalCost) as total_cogs,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost) as total_margin_dollar,\r\n                    COUNT(DISTINCT So.Num) as order_count,\r\n                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/NULLIF(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty, 0))) as avg_margin\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                LEFT JOIN ShipItem ON ShipItem.Id = PostSoItem.ShipItemId\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                GROUP BY DATE_FORMAT(PostSo.PostDate, '%Y-%m-01')\r\n                ORDER BY month ASC\r\n            `;\r\n\r\n            console.log('Monthly Revenue Query:', query);\r\n            const currentData = JSON.parse(runQuery(query));\r\n\r\n            // Fetch previous period data if comparison is enabled\r\n            if (comparisonEnabled && customStartDate && customEndDate) {\r\n                // Build previous period conditions (same filters but different date range)\r\n                const prevConditions = buildFilterConditions(true);\r\n\r\n                const prevQuery = `\r\n                    SELECT\r\n                        DATE_FORMAT(PostSo.PostDate, '%Y-%m-01') as month,\r\n                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                        SUM(PostSoItem.PostedTotalCost) as total_cogs,\r\n                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost) as total_margin_dollar,\r\n                        COUNT(DISTINCT So.Num) as order_count,\r\n                        AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/NULLIF(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty, 0))) as avg_margin\r\n                    FROM PostSo\r\n                    JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                    LEFT JOIN ShipItem ON ShipItem.Id = PostSoItem.ShipItemId\r\n                    JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                    JOIN So ON So.Id = SoItem.SoId\r\n                    LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                    LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                    LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                    LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                    LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                    ${prevConditions}\r\n                    GROUP BY DATE_FORMAT(PostSo.PostDate, '%Y-%m-01')\r\n                    ORDER BY month ASC\r\n                `;\r\n                console.log('Previous Period Revenue Query:', prevQuery);\r\n                const previousData = JSON.parse(runQuery(prevQuery));\r\n\r\n                return { current: currentData, previous: previousData };\r\n            }\r\n\r\n            return { current: currentData, previous: null };\r\n        }\r\n\r\n        function getTopCustomers() {\r\n            const conditions = buildFilterConditions();\r\n            const marginHaving = getMarginHavingClause('avg_margin');\r\n            const query = `\r\n                SELECT\r\n                    Customer.Name as customer_name,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                    COUNT(DISTINCT So.Num) as order_count,\r\n                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                GROUP BY Customer.Name\r\n                ${marginHaving}\r\n                ORDER BY total_revenue DESC\r\n                LIMIT 10\r\n            `;\r\n\r\n            console.log('Top Customers Query:', query);\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        function getSalesByCategory() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    COALESCE(ProductTree.Name, 'No Category') as category,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                GROUP BY category\r\n                ORDER BY total_revenue DESC\r\n                LIMIT 8\r\n            `;\r\n\r\n            console.log('Product Tree Query:', query);\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        function getSalesByManager() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    COALESCE(CONCAT(SysUser.FirstName,' ',SysUser.LastName), 'Head Office') as manager_name,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                    COUNT(DISTINCT So.Num) as order_count\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                GROUP BY manager_name\r\n                ORDER BY total_revenue DESC\r\n                LIMIT 8\r\n            `;\r\n\r\n            console.log('Sales by Manager Query:', query);\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        function getMarginTrend() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    DATE(PostSo.PostDate) as date,\r\n                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                GROUP BY DATE(PostSo.PostDate)\r\n                ORDER BY date ASC\r\n            `;\r\n\r\n            console.log('Margin Trend Query:', query);\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        function getTopSalespeople() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    So.salesmanId AS salesmanId,\r\n                    COALESCE(NULLIF(TRIM(CONCAT(SalesUser.FirstName, ' ', SalesUser.LastName)), ''), SalesUser.userName) as salesman,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                    COUNT(DISTINCT So.Num) as order_count,\r\n                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                JOIN SysUser AS SalesUser ON SalesUser.Id = So.salesmanId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                GROUP BY So.salesmanId, SalesUser.FirstName, SalesUser.LastName\r\n                ORDER BY total_revenue DESC\r\n                LIMIT 10\r\n            `;\r\n\r\n            console.log('Top Salespeople Query:', query);\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        function getSalesByGroup() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    COALESCE(AccountGroup.Name, 'No Group') as group_name,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                GROUP BY group_name\r\n                ORDER BY total_revenue DESC\r\n                LIMIT 8\r\n            `;\r\n\r\n            console.log('Sales by Group Query:', query);\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        function getTopProducts() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    Product.Num as product_num,\r\n                    Product.Description as product_desc,\r\n                    SUM(IF(SoItem.typeId IN (20,21), (PostSoItem.Qty*-1), PostSoItem.Qty)) as total_qty,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                GROUP BY Product.Num, Product.Description\r\n                ORDER BY total_qty DESC\r\n                LIMIT 10\r\n            `;\r\n\r\n            console.log('Top Products Query:', query);\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        function getKPIMetrics() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                    COUNT(DISTINCT So.Num) as order_count,\r\n                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n            `;\r\n\r\n            console.log('KPI Query:', query);\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        function buildFilterConditions(usePreviousPeriod = false) {\r\n            const customerGroup = document.getElementById('customerGroupFilter').value;\r\n            const accountManager = document.getElementById('accountManagerFilter').value;\r\n            const productCategory = document.getElementById('productCategoryFilter').value;\r\n            const marginFilter = document.getElementById('marginFilter').value;\r\n\r\n            let conditions = `WHERE ${getDateCondition(usePreviousPeriod)}\r\n                AND SoItem.typeId NOT IN (30,40)`;\r\n\r\n            if (customerGroup !== '%') {\r\n                conditions += ` AND AccountGroup.Name = '${escapeSQL(customerGroup)}'`;\r\n            }\r\n            if (accountManager !== '%' && !isNaN(parseInt(accountManager))) {\r\n                conditions += ` AND So.salesmanId = ${parseInt(accountManager)}`;\r\n            }\r\n            if (productCategory !== '%') {\r\n                conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;\r\n            }\r\n\r\n            // Filter by line item margin level\r\n            // Margin = (revenue - cost) / revenue where revenue = adjusted unit price * qty\r\n            if (marginFilter !== 'all') {\r\n                const marginExpr = `((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - PostSoItem.PostedTotalCost) / NULLIF(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty, 0)`;\r\n                if (marginFilter === 'good') {\r\n                    conditions += ` AND ${marginExpr} >= 0.30`;\r\n                } else if (marginFilter === 'medium') {\r\n                    conditions += ` AND ${marginExpr} >= 0.15 AND ${marginExpr} < 0.30`;\r\n                } else if (marginFilter === 'low') {\r\n                    conditions += ` AND ${marginExpr} < 0.15`;\r\n                }\r\n            }\r\n\r\n            return conditions;\r\n        }\r\n\r\n        // Order-level filter conditions (for queries without SoItem in main FROM clause)\r\n        function buildOrderLevelFilterConditions() {\r\n            const customerGroup = document.getElementById('customerGroupFilter').value;\r\n            const accountManager = document.getElementById('accountManagerFilter').value;\r\n\r\n            let conditions = `WHERE ${getDateCondition()}`;\r\n\r\n            if (customerGroup !== '%') {\r\n                conditions += ` AND AccountGroup.Name = '${escapeSQL(customerGroup)}'`;\r\n            }\r\n            if (accountManager !== '%' && !isNaN(parseInt(accountManager))) {\r\n                conditions += ` AND So.salesmanId = ${parseInt(accountManager)}`;\r\n            }\r\n\r\n            return conditions;\r\n        }\r\n\r\n        // Returns just the filter conditions without date or WHERE clause\r\n        function getAdditionalFilters() {\r\n            const customerGroup = document.getElementById('customerGroupFilter').value;\r\n            const accountManager = document.getElementById('accountManagerFilter').value;\r\n\r\n            let filters = '';\r\n\r\n            if (customerGroup !== '%') {\r\n                filters += ` AND AccountGroup.Name = '${escapeSQL(customerGroup)}'`;\r\n            }\r\n            if (accountManager !== '%' && !isNaN(parseInt(accountManager))) {\r\n                filters += ` AND So.salesmanId = ${parseInt(accountManager)}`;\r\n            }\r\n\r\n            return filters;\r\n        }\r\n\r\n        // Returns the HAVING clause for margin filtering\r\n        // Parameter marginField should be the alias used for margin in the query (e.g., 'avg_margin', 'margin_percent')\r\n        function getMarginHavingClause(marginField = 'avg_margin') {\r\n            const marginFilter = document.getElementById('marginFilter').value;\r\n            if (marginFilter === 'good') {\r\n                return `HAVING ${marginField} >= 0.30`;\r\n            } else if (marginFilter === 'medium') {\r\n                return `HAVING ${marginField} >= 0.15 AND ${marginField} < 0.30`;\r\n            } else if (marginFilter === 'low') {\r\n                return `HAVING ${marginField} < 0.15`;\r\n            }\r\n            return '';\r\n        }\r\n\r\n        function loadFilters() {\r\n            // Load Customer Groups\r\n            const cgQuery = `\r\n                SELECT DISTINCT COALESCE(AccountGroup.Name, 'No Group') as name\r\n                FROM So\r\n                JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ORDER BY name\r\n            `;\r\n            const customerGroups = JSON.parse(runQuery(cgQuery));\r\n            const cgSelector = document.getElementById('customerGroupFilter');\r\n            cgSelector.innerHTML = '<option value=\"%\">All Groups</option>';\r\n            customerGroups.forEach(cg => {\r\n                if (cg.name) cgSelector.innerHTML += `<option value=\"${cg.name}\">${cg.name}</option>`;\r\n            });\r\n\r\n            // Load Sales People\r\n            const amQuery = `\r\n                SELECT DISTINCT\r\n                    SysUser.Id as salesmanId,\r\n                    COALESCE(NULLIF(TRIM(CONCAT(SysUser.FirstName, ' ', SysUser.LastName)), ''), SysUser.userName) as fullName\r\n                FROM So\r\n                JOIN SysUser ON SysUser.Id = So.salesmanId\r\n                WHERE So.salesmanId IS NOT NULL\r\n                ORDER BY fullName\r\n            `;\r\n            debugLog('Loading sales people with query: ' + amQuery, 'info');\r\n            try {\r\n                const result = runQuery(amQuery);\r\n                debugLog('Sales people raw result length: ' + (result ? result.length : 'null'), 'info');\r\n\r\n                if (!result) {\r\n                    debugLog('ERROR: Sales people query returned null', 'error');\r\n                    throw new Error('Query returned null - possible SQL error');\r\n                }\r\n\r\n                debugLog('Attempting to parse JSON...', 'info');\r\n                const accountManagers = JSON.parse(result);\r\n                debugLog(`Successfully parsed. Got ${accountManagers ? accountManagers.length : 0} sales people`, 'success');\r\n\r\n                if (accountManagers && accountManagers.length > 0) {\r\n                    debugLog('First salesperson: ' + JSON.stringify(accountManagers[0]), 'info');\r\n                }\r\n\r\n                const amSelector = document.getElementById('accountManagerFilter');\r\n                amSelector.innerHTML = '<option value=\"%\">All Sales People</option>';\r\n                if (accountManagers && accountManagers.length > 0) {\r\n                    accountManagers.forEach(am => {\r\n                        // Use lowercase field names as returned by MySQL\r\n                        const salesmanId = am.salesmanid || am.salesmanId;\r\n                        const fullName = am.fullname || am.fullName;\r\n                        if (salesmanId && fullName) {\r\n                            debugLog(`Adding: ${salesmanId} - ${fullName}`, 'info');\r\n                            amSelector.innerHTML += `<option value=\"${salesmanId}\">${fullName}</option>`;\r\n                        }\r\n                    });\r\n                    debugLog(`Populated dropdown with ${accountManagers.length} salespeople`, 'success');\r\n                } else {\r\n                    debugLog('No sales people data to populate', 'warning');\r\n                }\r\n            } catch (error) {\r\n                debugLog(`ERROR loading sales people: ${error.message}`, 'error');\r\n                debugLog(`Error stack: ${error.stack}`, 'error');\r\n            }\r\n\r\n            // Load Product Categories\r\n            const pcQuery = `\r\n                SELECT DISTINCT ProductTree.Name as name\r\n                FROM ProductTree\r\n                WHERE ProductTree.Name IS NOT NULL\r\n                ORDER BY name\r\n            `;\r\n            const productCategories = JSON.parse(runQuery(pcQuery));\r\n            const pcSelector = document.getElementById('productCategoryFilter');\r\n            pcSelector.innerHTML = '<option value=\"%\">All Categories</option>';\r\n            productCategories.forEach(pc => {\r\n                if (pc.name) pcSelector.innerHTML += `<option value=\"${pc.name}\">${pc.name}</option>`;\r\n            });\r\n        }\r\n\r\n        // ============================================\r\n        // New Metrics Data Query Functions\r\n        // ============================================\r\n\r\n        // Low Margin Sales (< 15%)\r\n        function getLowMarginSales() {\r\n            const conditions = buildOrderLevelFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    So.Num as order_num,\r\n                    PostSo.PostDate as order_date,\r\n                    Customer.Name as customer_name,\r\n                    So.TotalPrice as order_total,\r\n                    COALESCE(NULLIF(TRIM(CONCAT(SysUser.FirstName, ' ', SysUser.LastName)), ''), SysUser.userName) as salesman,\r\n                    COALESCE(\r\n                        (So.TotalPrice - (\r\n                            SELECT SUM(PostSoItem.PostedTotalCost)\r\n                            FROM SoItem\r\n                            LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id\r\n                            WHERE SoItem.SoId = So.Id\r\n                            AND SoItem.typeId NOT IN (30,40)\r\n                        )) / NULLIF(So.TotalPrice, 0),\r\n                        0\r\n                    ) as margin_percent\r\n                FROM PostSo\r\n                JOIN So ON So.Id = PostSo.SoId\r\n                JOIN Customer ON Customer.Id = So.CustomerId\r\n                JOIN SysUser ON SysUser.Id = So.salesmanId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                    SELECT AccountGroupRelation.GroupId\r\n                    FROM AccountGroupRelation\r\n                    WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                    ORDER BY AccountGroupRelation.AccountId ASC\r\n                    LIMIT 1\r\n                )\r\n                ${conditions}\r\n                HAVING margin_percent < 0.15 AND margin_percent >= 0\r\n                ORDER BY margin_percent ASC\r\n                LIMIT 100\r\n            `;\r\n            debugLog('Low Margin Sales query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Negative Margin Orders\r\n        function getNegativeMarginOrders() {\r\n            const conditions = buildOrderLevelFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    So.Num as order_num,\r\n                    PostSo.PostDate as order_date,\r\n                    Customer.Name as customer_name,\r\n                    So.TotalPrice as order_total,\r\n                    COALESCE(NULLIF(TRIM(CONCAT(SysUser.FirstName, ' ', SysUser.LastName)), ''), SysUser.userName) as salesman,\r\n                    COALESCE(\r\n                        (So.TotalPrice - (\r\n                            SELECT SUM(PostSoItem.PostedTotalCost)\r\n                            FROM SoItem\r\n                            LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id\r\n                            WHERE SoItem.SoId = So.Id\r\n                            AND SoItem.typeId NOT IN (30,40)\r\n                        )) / NULLIF(So.TotalPrice, 0),\r\n                        0\r\n                    ) as margin_percent\r\n                FROM PostSo\r\n                JOIN So ON So.Id = PostSo.SoId\r\n                JOIN Customer ON Customer.Id = So.CustomerId\r\n                JOIN SysUser ON SysUser.Id = So.salesmanId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                    SELECT AccountGroupRelation.GroupId\r\n                    FROM AccountGroupRelation\r\n                    WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                    ORDER BY AccountGroupRelation.AccountId ASC\r\n                    LIMIT 1\r\n                )\r\n                ${conditions}\r\n                HAVING margin_percent < 0\r\n                ORDER BY margin_percent ASC\r\n                LIMIT 100\r\n            `;\r\n            debugLog('Negative Margin Orders query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // High Value Orders (> $10k)\r\n        function getHighValueOrders() {\r\n            const conditions = buildOrderLevelFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    So.Num as order_num,\r\n                    PostSo.PostDate as order_date,\r\n                    Customer.Name as customer_name,\r\n                    So.TotalPrice as order_total,\r\n                    So.salesman,\r\n                    COALESCE(\r\n                        (So.TotalPrice - (\r\n                            SELECT SUM(PostSoItem.PostedTotalCost)\r\n                            FROM SoItem\r\n                            LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id\r\n                            WHERE SoItem.SoId = So.Id\r\n                            AND SoItem.typeId NOT IN (30,40)\r\n                        )) / NULLIF(So.TotalPrice, 0),\r\n                        0\r\n                    ) as margin_percent\r\n                FROM PostSo\r\n                JOIN So ON So.Id = PostSo.SoId\r\n                JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                    SELECT AccountGroupRelation.GroupId\r\n                    FROM AccountGroupRelation\r\n                    WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                    ORDER BY AccountGroupRelation.AccountId ASC\r\n                    LIMIT 1\r\n                )\r\n                ${conditions}\r\n                AND So.TotalPrice > 10000\r\n                ORDER BY So.TotalPrice DESC\r\n                LIMIT 100\r\n            `;\r\n            debugLog('High Value Orders query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Average Order Value - Monthly\r\n        function getAverageOrderValue() {\r\n            const conditions = buildOrderLevelFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    DATE_FORMAT(PostSo.PostDate, '%Y-%m-01') as month,\r\n                    AVG(So.TotalPrice) as avg_order_value,\r\n                    COUNT(DISTINCT So.Id) as order_count,\r\n                    SUM(So.TotalPrice) as total_revenue\r\n                FROM PostSo\r\n                JOIN So ON So.Id = PostSo.SoId\r\n                JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                    SELECT AccountGroupRelation.GroupId\r\n                    FROM AccountGroupRelation\r\n                    WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                    ORDER BY AccountGroupRelation.AccountId ASC\r\n                    LIMIT 1\r\n                )\r\n                ${conditions}\r\n                GROUP BY DATE_FORMAT(PostSo.PostDate, '%Y-%m-01')\r\n                ORDER BY month ASC\r\n            `;\r\n\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // New vs Repeat Customers\r\n        function getNewVsRepeatCustomers() {\r\n            try {\r\n                const conditions = buildOrderLevelFilterConditions();\r\n                const { start, end } = getDateRange();\r\n\r\n                const query = `\r\n                SELECT\r\n                    Customer.Id as customer_id,\r\n                    Customer.Name as customer_name,\r\n                    (\r\n                        SELECT MIN(PostSo_All.PostDate)\r\n                        FROM PostSo AS PostSo_All\r\n                        JOIN So AS So_All ON So_All.Id = PostSo_All.SoId\r\n                        WHERE So_All.CustomerId = Customer.Id\r\n                    ) as first_order_date,\r\n                    COUNT(DISTINCT So.Id) as order_count,\r\n                    SUM(So.TotalPrice) as total_revenue\r\n                FROM PostSo\r\n                JOIN So ON So.Id = PostSo.SoId\r\n                JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                    SELECT AccountGroupRelation.GroupId\r\n                    FROM AccountGroupRelation\r\n                    WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                    ORDER BY AccountGroupRelation.AccountId ASC\r\n                    LIMIT 1\r\n                )\r\n                ${conditions}\r\n                GROUP BY Customer.Id, Customer.Name\r\n            `;\r\n\r\n                debugLog('New vs Repeat query: ' + query, 'info');\r\n                const customers = JSON.parse(runQuery(query));\r\n                debugLog(`New vs Repeat returned ${customers.length} customers`, 'info');\r\n\r\n                let newCustomers = 0;\r\n                let repeatCustomers = 0;\r\n                let newRevenue = 0;\r\n                let repeatRevenue = 0;\r\n\r\n                customers.forEach(c => {\r\n                    const firstOrderDate = moment(c.first_order_date);\r\n                    const periodStart = moment(start);\r\n\r\n                    // New customer: first order ever was during this period\r\n                    if (firstOrderDate >= periodStart) {\r\n                        newCustomers++;\r\n                        newRevenue += parseFloat(c.total_revenue || 0);\r\n                    } else {\r\n                        // Repeat customer: first order was before this period\r\n                        repeatCustomers++;\r\n                        repeatRevenue += parseFloat(c.total_revenue || 0);\r\n                    }\r\n                });\r\n\r\n                debugLog(`New: ${newCustomers}, Repeat: ${repeatCustomers}`, 'info');\r\n                return [\r\n                    { type: 'New', count: newCustomers, revenue: newRevenue },\r\n                    { type: 'Repeat', count: repeatCustomers, revenue: repeatRevenue }\r\n                ];\r\n            } catch (error) {\r\n                debugLog(`ERROR in getNewVsRepeatCustomers: ${error.message}`, 'error');\r\n                return [];\r\n            }\r\n        }\r\n\r\n        // Top Customers by Margin %\r\n        function getTopCustomersByMargin() {\r\n            const conditions = buildOrderLevelFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    Customer.Name as customer_name,\r\n                    Customer.Id as customer_id,\r\n                    SUM(So.TotalPrice) as total_revenue,\r\n                    AVG(\r\n                        COALESCE(\r\n                            (So.TotalPrice - (\r\n                                SELECT SUM(PostSoItem.PostedTotalCost)\r\n                                FROM SoItem\r\n                                LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id\r\n                                WHERE SoItem.SoId = So.Id\r\n                                AND SoItem.typeId NOT IN (30,40)\r\n                            )) / NULLIF(So.TotalPrice, 0),\r\n                            0\r\n                        )\r\n                    ) as avg_margin_percent,\r\n                    COUNT(DISTINCT So.Id) as order_count\r\n                FROM PostSo\r\n                JOIN So ON So.Id = PostSo.SoId\r\n                JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                    SELECT AccountGroupRelation.GroupId\r\n                    FROM AccountGroupRelation\r\n                    WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                    ORDER BY AccountGroupRelation.AccountId ASC\r\n                    LIMIT 1\r\n                )\r\n                ${conditions}\r\n                GROUP BY Customer.Id, Customer.Name\r\n                HAVING SUM(So.TotalPrice) > 1000\r\n                ORDER BY avg_margin_percent DESC\r\n                LIMIT 10\r\n            `;\r\n            debugLog('Top Customers by Margin query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Inactive Customers (90+ days since last order)\r\n        function getInactiveCustomers() {\r\n            const inactiveDays = 90;\r\n            const cutoffDate = moment().subtract(inactiveDays, 'days').format('YYYY-MM-DD');\r\n\r\n            const query = `\r\n                SELECT\r\n                    Customer.Id as customer_id,\r\n                    Customer.Name as customer_name,\r\n                    MAX(PostSo.PostDate) as last_order_date,\r\n                    COUNT(DISTINCT So.Id) as total_orders,\r\n                    SUM(So.TotalPrice) as lifetime_revenue,\r\n                    DATEDIFF(CURDATE(), MAX(PostSo.PostDate)) as days_since_order\r\n                FROM PostSo\r\n                JOIN So ON So.Id = PostSo.SoId\r\n                JOIN Customer ON Customer.Id = So.CustomerId\r\n                GROUP BY Customer.Id, Customer.Name\r\n                HAVING last_order_date < '${cutoffDate}' AND total_orders > 0\r\n                ORDER BY lifetime_revenue DESC\r\n                LIMIT 100\r\n            `;\r\n            debugLog('Inactive Customers query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Slow-Moving Inventory\r\n        function getSlowMovingInventory() {\r\n            try {\r\n                const { start, end } = getDateRange();\r\n                const daysDiff = moment(end).diff(moment(start), 'days') || 364;\r\n\r\n                const query = `\r\n                    SELECT\r\n                        Product.Num AS product_num,\r\n                        Product.Description AS product_name,\r\n                        COALESCE(SUM(CASE WHEN PostSo.PostDate IS NOT NULL THEN PostSoItem.Qty ELSE 0 END), 0) AS qty_sold,\r\n                        COALESCE(SUM(CASE WHEN PostSo.PostDate IS NOT NULL THEN PostSoItem.Qty ELSE 0 END), 0) / ${daysDiff} AS daily_velocity,\r\n                        (\r\n                            SELECT SUM(qtyOnHand)\r\n                            FROM qtyInventoryTotals\r\n                            WHERE partId = Product.Id\r\n                        ) AS qty_on_hand,\r\n                        (\r\n                            SELECT SUM(qtyOnHand)\r\n                            FROM qtyInventoryTotals\r\n                            WHERE partId = Product.Id\r\n                        ) / NULLIF(COALESCE(SUM(CASE WHEN PostSo.PostDate IS NOT NULL THEN PostSoItem.Qty ELSE 0 END), 0) / ${daysDiff}, 0) AS days_of_supply\r\n                    FROM Product\r\n                    LEFT JOIN SoItem ON SoItem.ProductId = Product.Id AND SoItem.typeId NOT IN (30, 40)\r\n                    LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id\r\n                    LEFT JOIN So ON So.Id = SoItem.SoId\r\n                    LEFT JOIN PostSo ON PostSo.SoId = So.Id AND PostSo.PostDate >= '${start}' AND PostSo.PostDate <= '${end}'\r\n                    LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                    LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                        SELECT AccountGroupRelation.GroupId\r\n                        FROM AccountGroupRelation\r\n                        WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                        ORDER BY AccountGroupRelation.AccountId ASC\r\n                        LIMIT 1\r\n                    )\r\n                    WHERE 1=1\r\n                    GROUP BY Product.Id, Product.Num, Product.Description\r\n                    HAVING qty_on_hand > 0 AND daily_velocity < 1\r\n                    ORDER BY days_of_supply DESC\r\n                    LIMIT 20\r\n                `;\r\n                debugLog('Slow-Moving Inventory query: ' + query, 'info');\r\n                const result = JSON.parse(runQuery(query));\r\n                debugLog(`Slow-Moving Inventory returned ${result ? result.length : 0} rows`, 'info');\r\n                return result || [];\r\n            } catch (error) {\r\n                debugLog(`ERROR in getSlowMovingInventory: ${error.message}`, 'error');\r\n                return [];\r\n            }\r\n        }\r\n\r\n        // Product Mix Analysis (Revenue by Category over Time)\r\n        function getProductMixAnalysis() {\r\n            const conditions = buildFilterConditions();\r\n            const query = `\r\n                SELECT\r\n                    DATE_FORMAT(PostSo.PostDate, '%Y-%m') as month,\r\n                    COALESCE(ProductTree.Name, 'No Category') as category,\r\n                    SUM(PostSoItem.TotalPrice) as revenue\r\n                FROM PostSo\r\n                JOIN So ON So.Id = PostSo.SoId\r\n                JOIN SoItem ON SoItem.SoId = So.Id\r\n                JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id\r\n                JOIN Product ON Product.Id = PostSoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = Product.ProductTreeId\r\n                JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                    SELECT AccountGroupRelation.GroupId\r\n                    FROM AccountGroupRelation\r\n                    WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                    ORDER BY AccountGroupRelation.AccountId ASC\r\n                    LIMIT 1\r\n                )\r\n                ${conditions}\r\n                GROUP BY month, category\r\n                ORDER BY month ASC, revenue DESC\r\n            `;\r\n            debugLog('Product Mix Analysis query: ' + query, 'info');\r\n            return JSON.parse(runQuery(query));\r\n        }\r\n\r\n        // Sales Orders per Salesperson\r\n        function getOrdersPerSalesperson() {\r\n            try {\r\n                const conditions = buildOrderLevelFilterConditions();\r\n                const query = `\r\n                    SELECT\r\n                        So.salesmanId AS salesmanId,\r\n                        COALESCE(NULLIF(TRIM(CONCAT(SalesUser.FirstName, ' ', SalesUser.LastName)), ''), SalesUser.userName) as fullName,\r\n                        COUNT(DISTINCT So.Id) as order_count,\r\n                        SUM(So.TotalPrice) as total_revenue\r\n                    FROM PostSo\r\n                    JOIN So ON So.Id = PostSo.SoId\r\n                    JOIN Customer ON Customer.Id = So.CustomerId\r\n                    JOIN SysUser AS SalesUser ON SalesUser.Id = So.salesmanId\r\n                    LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                        SELECT AccountGroupRelation.GroupId\r\n                        FROM AccountGroupRelation\r\n                        WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                        ORDER BY AccountGroupRelation.AccountId ASC\r\n                        LIMIT 1\r\n                    )\r\n                    ${conditions}\r\n                    GROUP BY So.salesmanId, SalesUser.FirstName, SalesUser.LastName\r\n                    ORDER BY order_count DESC\r\n                    LIMIT 10\r\n                `;\r\n                debugLog('Orders per Salesperson query: ' + query, 'info');\r\n                const result = JSON.parse(runQuery(query));\r\n                debugLog(`Orders per Salesperson returned ${result ? result.length : 0} rows`, 'info');\r\n                if (result && result.length > 0) {\r\n                    debugLog('First row: ' + JSON.stringify(result[0]), 'info');\r\n                }\r\n                return result || [];\r\n            } catch (error) {\r\n                debugLog(`ERROR in getOrdersPerSalesperson: ${error.message}`, 'error');\r\n                return [];\r\n            }\r\n        }\r\n\r\n        // DIFOT (Delivery In Full On Time) - Monthly Trend\r\n        function getAvgDaysToShip() {\r\n            try {\r\n                const additionalFilters = getAdditionalFilters();\r\n                const query = `\r\n                    SELECT\r\n                        DATE_FORMAT(So.dateIssued, '%Y-%m-01') as month,\r\n                        AVG(DATEDIFF(So.dateCompleted, So.dateIssued)) as avg_days_to_complete,\r\n                        COUNT(DISTINCT So.Id) as order_count,\r\n                        SUM(CASE WHEN So.dateCompleted <= So.dateFirstShip THEN 1 ELSE 0 END) as on_time_count\r\n                    FROM So\r\n                    JOIN Customer ON Customer.Id = So.CustomerId\r\n                    LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                        SELECT AccountGroupRelation.GroupId\r\n                        FROM AccountGroupRelation\r\n                        WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                        ORDER BY AccountGroupRelation.AccountId ASC\r\n                        LIMIT 1\r\n                    )\r\n                    JOIN PostSo ON PostSo.SoId = So.Id\r\n                    WHERE ${getDateCondition()}\r\n                        AND So.dateIssued IS NOT NULL\r\n                        AND So.dateCompleted IS NOT NULL\r\n                        ${additionalFilters}\r\n                    GROUP BY DATE_FORMAT(So.dateIssued, '%Y-%m-01')\r\n                    ORDER BY month ASC\r\n                `;\r\n                debugLog('DIFOT query: ' + query, 'info');\r\n                const result = JSON.parse(runQuery(query));\r\n                debugLog(`DIFOT returned ${result.length} rows`, 'info');\r\n                return result;\r\n            } catch (error) {\r\n                debugLog(`ERROR in getAvgDaysToShip: ${error.message}`, 'error');\r\n                return [];\r\n            }\r\n        }\r\n\r\n        // ============================================\r\n        // Chart Rendering Functions\r\n        // ============================================\r\n\r\n        function renderRevenueChart(data) {\r\n            const container = document.getElementById('revenueChart');\r\n            container.innerHTML = '';\r\n\r\n            // Handle new data structure with current and previous periods\r\n            let currentData = data;\r\n            let previousData = null;\r\n\r\n            if (data && data.current) {\r\n                currentData = data.current;\r\n                previousData = data.previous;\r\n            }\r\n\r\n            if (!currentData || currentData.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            // Map previous period data to current period months for proper alignment\r\n            if (previousData && previousData.length > 0) {\r\n                previousData = previousData.map((d, i) => ({\r\n                    ...d,\r\n                    originalMonth: d.month,  // Keep original for tooltip\r\n                    month: currentData[i] ? currentData[i].month : d.month  // Map to current period month\r\n                }));\r\n            }\r\n\r\n            const margin = { top: 20, right: 80, bottom: 40, left: 80 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 300 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            // Scales - calculate max across both current and previous data\r\n            const allData = previousData ? [...currentData, ...previousData] : currentData;\r\n\r\n            const x = d3.scaleBand()\r\n                .domain(currentData.map(d => d.month))\r\n                .range([0, width])\r\n                .padding(0.3);\r\n\r\n            const yRevenue = d3.scaleLinear()\r\n                .domain([0, d3.max(allData, d => parseFloat(d.total_revenue))])\r\n                .nice()\r\n                .range([height, 0]);\r\n\r\n            const yMargin = d3.scaleLinear()\r\n                .domain([0, d3.max(allData, d => parseFloat(d.avg_margin) * 100)])\r\n                .nice()\r\n                .range([height, 0]);\r\n\r\n            // Grid\r\n            svg.append('g')\r\n                .attr('class', 'grid')\r\n                .attr('opacity', 0.1)\r\n                .call(d3.axisLeft(yRevenue).tickSize(-width).tickFormat(''));\r\n\r\n            if (revenueChartMode === 'bar') {\r\n                // Bar chart mode\r\n                const hasPrevious = previousData && previousData.length > 0;\r\n                const numBarsPerGroup = hasPrevious ? 4 : 2; // 4 bars if comparison, 2 otherwise\r\n                const barWidth = x.bandwidth() / numBarsPerGroup;\r\n                const barGap = 2; // Small gap between bars\r\n\r\n                // Previous period bars (if available) - lighter shades\r\n                if (hasPrevious) {\r\n                    // Previous Revenue bars\r\n                    svg.selectAll('.bar-prev-revenue')\r\n                        .data(previousData)\r\n                        .enter()\r\n                        .append('rect')\r\n                        .attr('class', 'bar-prev-revenue')\r\n                        .attr('x', d => x(d.month))\r\n                        .attr('y', d => yRevenue(parseFloat(d.total_revenue)))\r\n                        .attr('width', barWidth - barGap)\r\n                        .attr('height', d => height - yRevenue(parseFloat(d.total_revenue)))\r\n                        .attr('fill', colorPalette[0])\r\n                        .attr('opacity', 0.5)\r\n                        .style('cursor', 'pointer')\r\n                        .on('mouseover', function(event, d) {\r\n                            d3.select(this).attr('opacity', 0.7);\r\n                            showMonthlyTooltip(event, d, false, true);\r\n                        })\r\n                        .on('mouseout', function() {\r\n                            d3.select(this).attr('opacity', 0.5);\r\n                            tooltip.style('opacity', 0);\r\n                        });\r\n\r\n                    // Current period Revenue bars\r\n                    svg.selectAll('.bar-revenue')\r\n                        .data(currentData)\r\n                        .enter()\r\n                        .append('rect')\r\n                        .attr('class', 'bar-revenue')\r\n                        .attr('x', d => x(d.month) + barWidth)\r\n                        .attr('y', d => yRevenue(parseFloat(d.total_revenue)))\r\n                        .attr('width', barWidth - barGap)\r\n                        .attr('height', d => height - yRevenue(parseFloat(d.total_revenue)))\r\n                        .attr('fill', colorPalette[0])\r\n                        .attr('opacity', 0.8)\r\n                        .style('cursor', 'pointer')\r\n                        .on('mouseover', function(event, d) {\r\n                            d3.select(this).attr('opacity', 1);\r\n                            showMonthlyTooltip(event, d, true);\r\n                        })\r\n                        .on('mouseout', function() {\r\n                            d3.select(this).attr('opacity', 0.8);\r\n                            tooltip.style('opacity', 0);\r\n                        })\r\n                        .on('click', function(event, d) {\r\n                            drilldownMonth(d.month);\r\n                        });\r\n\r\n                    // Previous Margin bars\r\n                    svg.selectAll('.bar-prev-margin')\r\n                        .data(previousData)\r\n                        .enter()\r\n                        .append('rect')\r\n                        .attr('class', 'bar-prev-margin')\r\n                        .attr('x', d => x(d.month) + (barWidth * 2))\r\n                        .attr('y', d => yMargin(parseFloat(d.avg_margin) * 100))\r\n                        .attr('width', barWidth - barGap)\r\n                        .attr('height', d => height - yMargin(parseFloat(d.avg_margin) * 100))\r\n                        .attr('fill', colorPalette[3])\r\n                        .attr('opacity', 0.5)\r\n                        .style('cursor', 'pointer')\r\n                        .on('mouseover', function(event, d) {\r\n                            d3.select(this).attr('opacity', 0.7);\r\n                            showMonthlyTooltip(event, d, false, true);\r\n                        })\r\n                        .on('mouseout', function() {\r\n                            d3.select(this).attr('opacity', 0.5);\r\n                            tooltip.style('opacity', 0);\r\n                        });\r\n\r\n                    // Current period Margin bars\r\n                    svg.selectAll('.bar-margin')\r\n                        .data(currentData)\r\n                        .enter()\r\n                        .append('rect')\r\n                        .attr('class', 'bar-margin')\r\n                        .attr('x', d => x(d.month) + (barWidth * 3))\r\n                        .attr('y', d => yMargin(parseFloat(d.avg_margin) * 100))\r\n                        .attr('width', barWidth - barGap)\r\n                        .attr('height', d => height - yMargin(parseFloat(d.avg_margin) * 100))\r\n                        .attr('fill', colorPalette[3])\r\n                        .attr('opacity', 0.8)\r\n                        .style('cursor', 'pointer')\r\n                        .on('mouseover', function(event, d) {\r\n                            d3.select(this).attr('opacity', 1);\r\n                            showMonthlyTooltip(event, d, true);\r\n                        })\r\n                        .on('mouseout', function() {\r\n                            d3.select(this).attr('opacity', 0.8);\r\n                            tooltip.style('opacity', 0);\r\n                        })\r\n                        .on('click', function(event, d) {\r\n                            drilldownMonth(d.month);\r\n                        });\r\n                } else {\r\n                    // No comparison - use original 2-bar layout\r\n                    // Current period Revenue bars\r\n                    svg.selectAll('.bar-revenue')\r\n                        .data(currentData)\r\n                        .enter()\r\n                        .append('rect')\r\n                        .attr('class', 'bar-revenue')\r\n                        .attr('x', d => x(d.month))\r\n                        .attr('y', d => yRevenue(parseFloat(d.total_revenue)))\r\n                        .attr('width', barWidth - barGap)\r\n                        .attr('height', d => height - yRevenue(parseFloat(d.total_revenue)))\r\n                        .attr('fill', colorPalette[0])\r\n                        .attr('opacity', 0.8)\r\n                        .style('cursor', 'pointer')\r\n                        .on('mouseover', function(event, d) {\r\n                            d3.select(this).attr('opacity', 1);\r\n                            showMonthlyTooltip(event, d, true);\r\n                        })\r\n                        .on('mouseout', function() {\r\n                            d3.select(this).attr('opacity', 0.8);\r\n                            tooltip.style('opacity', 0);\r\n                        })\r\n                        .on('click', function(event, d) {\r\n                            drilldownMonth(d.month);\r\n                        });\r\n\r\n                    // Current period Margin bars\r\n                    svg.selectAll('.bar-margin')\r\n                        .data(currentData)\r\n                        .enter()\r\n                        .append('rect')\r\n                        .attr('class', 'bar-margin')\r\n                        .attr('x', d => x(d.month) + barWidth)\r\n                        .attr('y', d => yMargin(parseFloat(d.avg_margin) * 100))\r\n                        .attr('width', barWidth - barGap)\r\n                        .attr('height', d => height - yMargin(parseFloat(d.avg_margin) * 100))\r\n                        .attr('fill', colorPalette[3])\r\n                        .attr('opacity', 0.8)\r\n                        .style('cursor', 'pointer')\r\n                        .on('mouseover', function(event, d) {\r\n                            d3.select(this).attr('opacity', 1);\r\n                            showMonthlyTooltip(event, d, true);\r\n                        })\r\n                        .on('mouseout', function() {\r\n                            d3.select(this).attr('opacity', 0.8);\r\n                            tooltip.style('opacity', 0);\r\n                        })\r\n                        .on('click', function(event, d) {\r\n                            drilldownMonth(d.month);\r\n                        });\r\n                }\r\n\r\n            } else {\r\n                // Line chart mode\r\n\r\n                // Previous period lines (if available) - lighter shades\r\n                if (previousData && previousData.length > 0) {\r\n                    // Previous Revenue line\r\n                    const prevRevenueLine = d3.line()\r\n                        .x(d => x(d.month) + x.bandwidth() / 2)\r\n                        .y(d => yRevenue(parseFloat(d.total_revenue)));\r\n\r\n                    svg.append('path')\r\n                        .datum(previousData)\r\n                        .attr('class', 'line-prev')\r\n                        .attr('d', prevRevenueLine)\r\n                        .attr('stroke', colorPalette[0])\r\n                        .attr('stroke-width', 2)\r\n                        .attr('fill', 'none')\r\n                        .attr('opacity', 0.5)\r\n                        .attr('stroke-dasharray', '5,5');\r\n\r\n                    // Previous Revenue points\r\n                    svg.selectAll('.dot-prev-revenue')\r\n                        .data(previousData)\r\n                        .enter()\r\n                        .append('circle')\r\n                        .attr('class', 'dot-prev-revenue')\r\n                        .attr('cx', d => x(d.month) + x.bandwidth() / 2)\r\n                        .attr('cy', d => yRevenue(parseFloat(d.total_revenue)))\r\n                        .attr('r', 4)\r\n                        .attr('fill', 'white')\r\n                        .attr('stroke', colorPalette[0])\r\n                        .attr('stroke-width', 2)\r\n                        .attr('opacity', 0.5)\r\n                        .style('cursor', 'pointer')\r\n                        .on('mouseover', function(event, d) {\r\n                            d3.select(this).attr('r', 6).attr('opacity', 0.8);\r\n                            showMonthlyTooltip(event, d, false, true);\r\n                        })\r\n                        .on('mouseout', function() {\r\n                            d3.select(this).attr('r', 4).attr('opacity', 0.5);\r\n                            tooltip.style('opacity', 0);\r\n                        });\r\n\r\n                    // Previous Margin line\r\n                    const prevMarginLine = d3.line()\r\n                        .x(d => x(d.month) + x.bandwidth() / 2)\r\n                        .y(d => yMargin(parseFloat(d.avg_margin) * 100));\r\n\r\n                    svg.append('path')\r\n                        .datum(previousData)\r\n                        .attr('class', 'line-prev')\r\n                        .attr('d', prevMarginLine)\r\n                        .attr('stroke', colorPalette[3])\r\n                        .attr('stroke-width', 2)\r\n                        .attr('fill', 'none')\r\n                        .attr('opacity', 0.5)\r\n                        .attr('stroke-dasharray', '5,5');\r\n\r\n                    // Previous Margin points\r\n                    svg.selectAll('.dot-prev-margin')\r\n                        .data(previousData)\r\n                        .enter()\r\n                        .append('circle')\r\n                        .attr('class', 'dot-prev-margin')\r\n                        .attr('cx', d => x(d.month) + x.bandwidth() / 2)\r\n                        .attr('cy', d => yMargin(parseFloat(d.avg_margin) * 100))\r\n                        .attr('r', 4)\r\n                        .attr('fill', 'white')\r\n                        .attr('stroke', colorPalette[3])\r\n                        .attr('stroke-width', 2)\r\n                        .attr('opacity', 0.5)\r\n                        .on('mouseover', function(event, d) {\r\n                            d3.select(this).attr('r', 6).attr('opacity', 0.8);\r\n                            showMonthlyTooltip(event, d, false, true);\r\n                        })\r\n                        .on('mouseout', function() {\r\n                            d3.select(this).attr('r', 4).attr('opacity', 0.5);\r\n                            tooltip.style('opacity', 0);\r\n                        });\r\n                }\r\n\r\n                // Current period Revenue line\r\n                const revenueLine = d3.line()\r\n                    .x(d => x(d.month) + x.bandwidth() / 2)\r\n                    .y(d => yRevenue(parseFloat(d.total_revenue)));\r\n\r\n                svg.append('path')\r\n                    .datum(currentData)\r\n                    .attr('class', 'line')\r\n                    .attr('d', revenueLine)\r\n                    .attr('stroke', colorPalette[0])\r\n                    .attr('stroke-width', 3)\r\n                    .attr('fill', 'none');\r\n\r\n                // Current period Revenue points\r\n                svg.selectAll('.dot-revenue')\r\n                    .data(currentData)\r\n                    .enter()\r\n                    .append('circle')\r\n                    .attr('class', 'dot-revenue')\r\n                    .attr('cx', d => x(d.month) + x.bandwidth() / 2)\r\n                    .attr('cy', d => yRevenue(parseFloat(d.total_revenue)))\r\n                    .attr('r', 5)\r\n                    .attr('fill', 'white')\r\n                    .attr('stroke', colorPalette[0])\r\n                    .attr('stroke-width', 3)\r\n                    .style('cursor', 'pointer')\r\n                    .on('mouseover', function(event, d) {\r\n                        d3.select(this).attr('r', 7);\r\n                        showMonthlyTooltip(event, d, true);\r\n                    })\r\n                    .on('mouseout', function() {\r\n                        d3.select(this).attr('r', 5);\r\n                        tooltip.style('opacity', 0);\r\n                    })\r\n                    .on('click', function(event, d) {\r\n                        drilldownMonth(d.month);\r\n                    });\r\n\r\n                // Current period Margin line\r\n                const marginLine = d3.line()\r\n                    .x(d => x(d.month) + x.bandwidth() / 2)\r\n                    .y(d => yMargin(parseFloat(d.avg_margin) * 100));\r\n\r\n                svg.append('path')\r\n                    .datum(currentData)\r\n                    .attr('class', 'line')\r\n                    .attr('d', marginLine)\r\n                    .attr('stroke', colorPalette[3])\r\n                    .attr('stroke-width', 3)\r\n                    .attr('fill', 'none')\r\n                    .attr('stroke-dasharray', '5,5');\r\n\r\n                // Current period Margin points\r\n                svg.selectAll('.dot-margin')\r\n                    .data(currentData)\r\n                    .enter()\r\n                    .append('circle')\r\n                    .attr('class', 'dot-margin')\r\n                    .attr('cx', d => x(d.month) + x.bandwidth() / 2)\r\n                    .attr('cy', d => yMargin(parseFloat(d.avg_margin) * 100))\r\n                    .attr('r', 5)\r\n                    .attr('fill', 'white')\r\n                    .attr('stroke', colorPalette[3])\r\n                    .attr('stroke-width', 3)\r\n                    .on('mouseover', function(event, d) {\r\n                        d3.select(this).attr('r', 7);\r\n                        showMonthlyTooltip(event, d);\r\n                    })\r\n                    .on('mouseout', function() {\r\n                        d3.select(this).attr('r', 5);\r\n                        tooltip.style('opacity', 0);\r\n                    });\r\n            }\r\n\r\n            // Axes\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).tickFormat(d => moment(d).format('MMM YY')));\r\n\r\n            // Left axis (Revenue)\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(yRevenue).ticks(5).tickFormat(d => '$' + d3.format('.2s')(d)));\r\n\r\n            svg.append('text')\r\n                .attr('transform', 'rotate(-90)')\r\n                .attr('y', -65)\r\n                .attr('x', -height / 2)\r\n                .attr('text-anchor', 'middle')\r\n                .attr('fill', colorPalette[0])\r\n                .attr('font-size', '12px')\r\n                .attr('font-weight', '600')\r\n                .text('Revenue');\r\n\r\n            // Right axis (Margin %)\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(${width}, 0)`)\r\n                .call(d3.axisRight(yMargin).ticks(5).tickFormat(d => d.toFixed(0) + '%'));\r\n\r\n            svg.append('text')\r\n                .attr('transform', 'rotate(-90)')\r\n                .attr('y', width + 65)\r\n                .attr('x', -height / 2)\r\n                .attr('text-anchor', 'middle')\r\n                .attr('fill', colorPalette[3])\r\n                .attr('font-size', '12px')\r\n                .attr('font-weight', '600')\r\n                .text('Margin %');\r\n\r\n            // Helper function for tooltip\r\n            function showMonthlyTooltip(event, d, clickable = false, isPreviousPeriod = false) {\r\n                const marginDollar = parseFloat(d.total_margin_dollar);\r\n                const marginPercent = parseFloat(d.avg_margin) * 100;\r\n                const clickHint = clickable ? '<div class=\"text-xs text-slate-500 mt-1\">Click to view top customers</div>' : '';\r\n                const periodLabel = isPreviousPeriod ? '<div class=\"text-xs font-semibold text-slate-400 mb-1\">Previous Period</div>' : '';\r\n                // Use originalMonth if available (for previous period), otherwise use month\r\n                const displayMonth = d.originalMonth || d.month;\r\n                tooltip.style('opacity', 1)\r\n                    .html(`\r\n                        ${periodLabel}\r\n                        <div><span class=\"tooltip-label\">Month:</span><span class=\"tooltip-value\">${moment(displayMonth).format('MMM YYYY')}</span></div>\r\n                        <div><span class=\"tooltip-label\">Revenue:</span><span class=\"tooltip-value\">${formatCurrency(d.total_revenue)}</span></div>\r\n                        <div><span class=\"tooltip-label\">Margin ${CURRENCY_SYMBOL}:</span><span class=\"tooltip-value\">${formatCurrency(marginDollar)}</span></div>\r\n                        <div><span class=\"tooltip-label\">Margin %:</span><span class=\"tooltip-value\">${marginPercent.toFixed(1)}%</span></div>\r\n                        <div><span class=\"tooltip-label\">Orders:</span><span class=\"tooltip-value\">${d.order_count}</span></div>\r\n                        ${clickHint}\r\n                    `)\r\n                    .style('left', (event.pageX + 10) + 'px')\r\n                    .style('top', (event.pageY - 10) + 'px');\r\n            }\r\n        }\r\n\r\n        function renderCustomersChart(data) {\r\n            const container = document.getElementById('customersChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 20, right: 30, bottom: 40, left: 120 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 300 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            // Scales\r\n            const x = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])\r\n                .nice()\r\n                .range([0, width]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(data.map(d => d.customer_name))\r\n                .range([0, height])\r\n                .padding(0.2);\r\n\r\n            // Bars with margin-based coloring\r\n            svg.selectAll('.bar')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('class', 'bar')\r\n                .attr('x', 0)\r\n                .attr('y', d => y(d.customer_name))\r\n                .attr('width', d => x(parseFloat(d.total_revenue)))\r\n                .attr('height', y.bandwidth())\r\n                .attr('rx', 4)\r\n                .attr('fill', d => {\r\n                    const margin = parseFloat(d.avg_margin);\r\n                    if (margin >= MARGIN_GOOD) return colorPalette[2]; // Green\r\n                    if (margin >= MARGIN_MEDIUM) return colorPalette[3]; // Orange\r\n                    return colorPalette[4]; // Red\r\n                })\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).style('opacity', 0.8);\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Customer:</span><span class=\"tooltip-value\">${d.customer_name}</span></div>\r\n                            <div><span class=\"tooltip-label\">Revenue:</span><span class=\"tooltip-value\">${formatCurrency(d.total_revenue)}</span></div>\r\n                            <div><span class=\"tooltip-label\">Orders:</span><span class=\"tooltip-value\">${d.order_count}</span></div>\r\n                            <div><span class=\"tooltip-label\">Avg Margin:</span><span class=\"tooltip-value\">${(parseFloat(d.avg_margin) * 100).toFixed(1)}%</span></div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Click to view orders</div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).style('opacity', 1);\r\n                    tooltip.style('opacity', 0);\r\n                })\r\n                .on('click', function(event, d) {\r\n                    drilldownCustomer(d.customer_name);\r\n                });\r\n\r\n            // Axes\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '10px');\r\n        }\r\n\r\n        function renderCategoryChart(data) {\r\n            const container = document.getElementById('categoryChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            // Create flex container for chart and legend\r\n            const wrapper = d3.select(container)\r\n                .append('div')\r\n                .style('display', 'flex')\r\n                .style('align-items', 'center')\r\n                .style('gap', '20px');\r\n\r\n            // Chart container (left side)\r\n            const chartDiv = wrapper.append('div')\r\n                .style('flex-shrink', '0');\r\n\r\n            const width = 240;\r\n            const height = 280;\r\n            const radius = Math.min(width, height) / 2;\r\n\r\n            const svg = chartDiv.append('svg')\r\n                .attr('width', width)\r\n                .attr('height', height)\r\n                .append('g')\r\n                .attr('transform', `translate(${width / 2},${height / 2})`);\r\n\r\n            const color = d3.scaleOrdinal()\r\n                .domain(data.map(d => d.category))\r\n                .range(colorPalette);\r\n\r\n            const pie = d3.pie()\r\n                .value(d => parseFloat(d.total_revenue))\r\n                .sort(null);\r\n\r\n            const arc = d3.arc()\r\n                .innerRadius(radius * 0.35)\r\n                .outerRadius(radius * 0.9);\r\n\r\n            const arcs = svg.selectAll('.arc')\r\n                .data(pie(data))\r\n                .enter()\r\n                .append('g')\r\n                .attr('class', 'arc');\r\n\r\n            arcs.append('path')\r\n                .attr('d', arc)\r\n                .attr('fill', d => color(d.data.category))\r\n                .attr('stroke', 'white')\r\n                .attr('stroke-width', 2)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this)\r\n                        .transition()\r\n                        .duration(200)\r\n                        .attr('d', d3.arc().innerRadius(radius * 0.35).outerRadius(radius * 0.95));\r\n\r\n                    const total = d3.sum(data, d => parseFloat(d.total_revenue));\r\n                    const percent = (parseFloat(d.data.total_revenue) / total * 100).toFixed(1);\r\n\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Category:</span><span class=\"tooltip-value\">${d.data.category}</span></div>\r\n                            <div><span class=\"tooltip-label\">Revenue:</span><span class=\"tooltip-value\">${formatCurrency(d.data.total_revenue)}</span></div>\r\n                            <div><span class=\"tooltip-label\">Percentage:</span><span class=\"tooltip-value\">${percent}%</span></div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Click to view products</div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this)\r\n                        .transition()\r\n                        .duration(200)\r\n                        .attr('d', arc);\r\n                    tooltip.style('opacity', 0);\r\n                })\r\n                .on('click', function(event, d) {\r\n                    drilldownCategory(d.data.category);\r\n                });\r\n\r\n            // Add percentage labels on segments\r\n            const total = d3.sum(data, d => parseFloat(d.total_revenue));\r\n            arcs.append('text')\r\n                .attr('transform', d => {\r\n                    const pos = arc.centroid(d);\r\n                    return `translate(${pos})`;\r\n                })\r\n                .attr('text-anchor', 'middle')\r\n                .style('fill', 'white')\r\n                .style('font-size', '12px')\r\n                .style('font-weight', 'bold')\r\n                .style('pointer-events', 'none')\r\n                .text(d => {\r\n                    const percent = (parseFloat(d.data.total_revenue) / total * 100);\r\n                    return percent > 5 ? percent.toFixed(0) + '%' : '';\r\n                });\r\n\r\n            // Legend container (right side)\r\n            const legendContainer = wrapper.append('div')\r\n                .style('flex', '1')\r\n                .style('max-height', '280px')\r\n                .style('overflow-y', 'auto');\r\n\r\n            const legendItems = legendContainer.selectAll('.legend-item')\r\n                .data(data)\r\n                .enter()\r\n                .append('div')\r\n                .attr('class', 'legend-item')\r\n                .style('display', 'flex')\r\n                .style('align-items', 'center')\r\n                .style('margin-bottom', '8px')\r\n                .style('font-size', '11px')\r\n                .style('cursor', 'pointer')\r\n                .on('click', (event, d) => drilldownCategory(d.category));\r\n\r\n            legendItems.append('div')\r\n                .style('width', '12px')\r\n                .style('height', '12px')\r\n                .style('background-color', d => color(d.category))\r\n                .style('margin-right', '8px')\r\n                .style('border-radius', '2px')\r\n                .style('flex-shrink', '0');\r\n\r\n            legendItems.append('div')\r\n                .style('color', '#475569')\r\n                .text(d => `${d.category} ($${d3.format('.2s')(parseFloat(d.total_revenue))})`);\r\n        }\r\n\r\n        function updateKPIs(data) {\r\n            if (!data || data.length === 0) return;\r\n\r\n            const metrics = data[0];\r\n            const kpiCardsContainer = document.getElementById('kpiCards');\r\n\r\n            const totalRevenue = formatCurrency(metrics.total_revenue || 0, false);\r\n            const orderCount = (metrics.order_count || 0).toLocaleString();\r\n            const avgOrderValue = formatCurrency((parseFloat(metrics.total_revenue || 0) / (metrics.order_count || 1)), false);\r\n            const avgMargin = ((parseFloat(metrics.avg_margin || 0)) * 100).toFixed(1) + '%';\r\n\r\n            kpiCardsContainer.innerHTML = `\r\n                <div class=\"flex items-center gap-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg\">\r\n                    <svg class=\"w-4 h-4 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\r\n                    </svg>\r\n                    <span class=\"text-xs font-semibold text-slate-600\">Revenue:</span>\r\n                    <span class=\"text-sm font-bold text-slate-900\">${totalRevenue}</span>\r\n                </div>\r\n                <div class=\"flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg\">\r\n                    <svg class=\"w-4 h-4 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path>\r\n                    </svg>\r\n                    <span class=\"text-xs font-semibold text-slate-600\">Orders:</span>\r\n                    <span class=\"text-sm font-bold text-slate-900\">${orderCount}</span>\r\n                </div>\r\n                <div class=\"flex items-center gap-2 px-3 py-2 bg-purple-50 border border-purple-200 rounded-lg\">\r\n                    <svg class=\"w-4 h-4 text-purple-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z\"></path>\r\n                    </svg>\r\n                    <span class=\"text-xs font-semibold text-slate-600\">Avg Order:</span>\r\n                    <span class=\"text-sm font-bold text-slate-900\">${avgOrderValue}</span>\r\n                </div>\r\n                <div class=\"flex items-center gap-2 px-3 py-2 bg-amber-50 border border-amber-200 rounded-lg\">\r\n                    <svg class=\"w-4 h-4 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\"></path>\r\n                    </svg>\r\n                    <span class=\"text-xs font-semibold text-slate-600\">Margin:</span>\r\n                    <span class=\"text-sm font-bold text-slate-900\">${avgMargin}</span>\r\n                </div>\r\n            `;\r\n        }\r\n\r\n        function renderManagerChart(data) {\r\n            const container = document.getElementById('managerChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 20, right: 30, bottom: 40, left: 90 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 280 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])\r\n                .nice()\r\n                .range([0, width]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(data.map(d => d.manager_name))\r\n                .range([0, height])\r\n                .padding(0.2);\r\n\r\n            svg.selectAll('.bar')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', 0)\r\n                .attr('y', d => y(d.manager_name))\r\n                .attr('width', d => x(parseFloat(d.total_revenue)))\r\n                .attr('height', y.bandwidth())\r\n                .attr('fill', colorPalette[1])\r\n                .attr('rx', 4)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).attr('fill', colorPalette[0]);\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Manager:</span><span class=\"tooltip-value\">${d.manager_name}</span></div>\r\n                            <div><span class=\"tooltip-label\">Revenue:</span><span class=\"tooltip-value\">${formatCurrency(d.total_revenue)}</span></div>\r\n                            <div><span class=\"tooltip-label\">Orders:</span><span class=\"tooltip-value\">${d.order_count}</span></div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Click to view customers</div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).attr('fill', colorPalette[1]);\r\n                    tooltip.style('opacity', 0);\r\n                })\r\n                .on('click', function(event, d) {\r\n                    drilldownManager(d.manager_name);\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '10px');\r\n        }\r\n\r\n        function renderMarginChart(data) {\r\n            const container = document.getElementById('marginChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 20, right: 50, bottom: 40, left: 60 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 280 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleTime()\r\n                .domain(d3.extent(data, d => new Date(d.date)))\r\n                .range([0, width]);\r\n\r\n            const yMargin = d3.scaleLinear()\r\n                .domain([0, 1])\r\n                .range([height, 0]);\r\n\r\n            // Line for margin %\r\n            const line = d3.line()\r\n                .x(d => x(new Date(d.date)))\r\n                .y(d => yMargin(parseFloat(d.avg_margin)));\r\n\r\n            svg.append('path')\r\n                .datum(data)\r\n                .attr('class', 'line')\r\n                .attr('d', line)\r\n                .attr('stroke', colorPalette[3])\r\n                .attr('stroke-width', 3);\r\n\r\n            // Axes\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat('%b %d')));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(yMargin).ticks(5).tickFormat(d => (d * 100).toFixed(0) + '%'));\r\n\r\n            // Reference lines for margin thresholds\r\n            svg.append('line')\r\n                .attr('x1', 0)\r\n                .attr('x2', width)\r\n                .attr('y1', yMargin(MARGIN_GOOD))\r\n                .attr('y2', yMargin(MARGIN_GOOD))\r\n                .attr('stroke', colorPalette[2])\r\n                .attr('stroke-dasharray', '4,4')\r\n                .attr('opacity', 0.5);\r\n\r\n            svg.append('line')\r\n                .attr('x1', 0)\r\n                .attr('x2', width)\r\n                .attr('y1', yMargin(MARGIN_MEDIUM))\r\n                .attr('y2', yMargin(MARGIN_MEDIUM))\r\n                .attr('stroke', colorPalette[3])\r\n                .attr('stroke-dasharray', '4,4')\r\n                .attr('opacity', 0.5);\r\n        }\r\n\r\n        function renderSalespeopleChart(data) {\r\n            const container = document.getElementById('salespeopleChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 20, right: 30, bottom: 40, left: 90 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 280 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])\r\n                .nice()\r\n                .range([0, width]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(data.map(d => d.salesman))\r\n                .range([0, height])\r\n                .padding(0.2);\r\n\r\n            svg.selectAll('.bar')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', 0)\r\n                .attr('y', d => y(d.salesman))\r\n                .attr('width', d => x(parseFloat(d.total_revenue)))\r\n                .attr('height', y.bandwidth())\r\n                .attr('fill', colorPalette[5])\r\n                .attr('rx', 4)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).attr('fill', colorPalette[4]);\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Sales Person:</span><span class=\"tooltip-value\">${d.salesman}</span></div>\r\n                            <div><span class=\"tooltip-label\">Revenue:</span><span class=\"tooltip-value\">${formatCurrency(d.total_revenue)}</span></div>\r\n                            <div><span class=\"tooltip-label\">Orders:</span><span class=\"tooltip-value\">${d.order_count}</span></div>\r\n                            <div><span class=\"tooltip-label\">Avg Margin:</span><span class=\"tooltip-value\">${(parseFloat(d.avg_margin || 0) * 100).toFixed(1)}%</span></div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Click to view orders</div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).attr('fill', colorPalette[5]);\r\n                    tooltip.style('opacity', 0);\r\n                })\r\n                .on('click', function(event, d) {\r\n                    drilldownSalesperson(d.salesmanid);\r\n                });\r\n\r\n            // Add value labels showing revenue and margin\r\n            svg.selectAll('.value-label')\r\n                .data(data)\r\n                .enter()\r\n                .append('text')\r\n                .attr('class', 'value-label')\r\n                .attr('x', d => x(parseFloat(d.total_revenue)) + 5)\r\n                .attr('y', d => y(d.salesman) + y.bandwidth() / 2)\r\n                .attr('dy', '0.35em')\r\n                .style('font-size', '10px')\r\n                .style('fill', '#475569')\r\n                .style('font-weight', '600')\r\n                .text(d => {\r\n                    const revenue = '$' + d3.format('.2s')(parseFloat(d.total_revenue));\r\n                    const margin = (parseFloat(d.avg_margin || 0) * 100).toFixed(0) + '%';\r\n                    return `${revenue} (${margin})`;\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '10px');\r\n        }\r\n\r\n        function renderGroupChart(data) {\r\n            const container = document.getElementById('groupChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            // Create flex container for chart and legend\r\n            const wrapper = d3.select(container)\r\n                .append('div')\r\n                .style('display', 'flex')\r\n                .style('align-items', 'center')\r\n                .style('gap', '20px');\r\n\r\n            // Chart container (left side)\r\n            const chartDiv = wrapper.append('div')\r\n                .style('flex-shrink', '0');\r\n\r\n            const width = 240;\r\n            const height = 280;\r\n            const radius = Math.min(width, height) / 2;\r\n\r\n            const svg = chartDiv.append('svg')\r\n                .attr('width', width)\r\n                .attr('height', height)\r\n                .append('g')\r\n                .attr('transform', `translate(${width / 2},${height / 2})`);\r\n\r\n            const color = d3.scaleOrdinal()\r\n                .domain(data.map(d => d.group_name))\r\n                .range(colorPalette);\r\n\r\n            const pie = d3.pie()\r\n                .value(d => parseFloat(d.total_revenue))\r\n                .sort(null);\r\n\r\n            const arc = d3.arc()\r\n                .innerRadius(radius * 0.35)\r\n                .outerRadius(radius * 0.9);\r\n\r\n            const arcs = svg.selectAll('.arc')\r\n                .data(pie(data))\r\n                .enter()\r\n                .append('g')\r\n                .attr('class', 'arc');\r\n\r\n            arcs.append('path')\r\n                .attr('d', arc)\r\n                .attr('fill', d => color(d.data.group_name))\r\n                .attr('stroke', 'white')\r\n                .attr('stroke-width', 2)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this)\r\n                        .transition()\r\n                        .duration(200)\r\n                        .attr('d', d3.arc().innerRadius(radius * 0.35).outerRadius(radius * 0.95));\r\n\r\n                    const total = d3.sum(data, d => parseFloat(d.total_revenue));\r\n                    const percent = (parseFloat(d.data.total_revenue) / total * 100).toFixed(1);\r\n\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Group:</span><span class=\"tooltip-value\">${d.data.group_name}</span></div>\r\n                            <div><span class=\"tooltip-label\">Revenue:</span><span class=\"tooltip-value\">${formatCurrency(d.data.total_revenue)}</span></div>\r\n                            <div><span class=\"tooltip-label\">Percentage:</span><span class=\"tooltip-value\">${percent}%</span></div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Click to view orders</div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this)\r\n                        .transition()\r\n                        .duration(200)\r\n                        .attr('d', arc);\r\n                    tooltip.style('opacity', 0);\r\n                })\r\n                .on('click', function(event, d) {\r\n                    drilldownCustomerGroup(d.data.group_name);\r\n                });\r\n\r\n            // Add percentage labels on segments\r\n            const total = d3.sum(data, d => parseFloat(d.total_revenue));\r\n            arcs.append('text')\r\n                .attr('transform', d => {\r\n                    const pos = arc.centroid(d);\r\n                    return `translate(${pos})`;\r\n                })\r\n                .attr('text-anchor', 'middle')\r\n                .style('fill', 'white')\r\n                .style('font-size', '12px')\r\n                .style('font-weight', 'bold')\r\n                .style('pointer-events', 'none')\r\n                .text(d => {\r\n                    const percent = (parseFloat(d.data.total_revenue) / total * 100);\r\n                    return percent > 5 ? percent.toFixed(0) + '%' : '';\r\n                });\r\n\r\n            // Legend container (right side)\r\n            const legendContainer = wrapper.append('div')\r\n                .style('flex', '1')\r\n                .style('max-height', '280px')\r\n                .style('overflow-y', 'auto');\r\n\r\n            const legendItems = legendContainer.selectAll('.legend-item')\r\n                .data(data)\r\n                .enter()\r\n                .append('div')\r\n                .attr('class', 'legend-item')\r\n                .style('display', 'flex')\r\n                .style('align-items', 'center')\r\n                .style('margin-bottom', '8px')\r\n                .style('font-size', '11px');\r\n\r\n            legendItems.append('div')\r\n                .style('width', '12px')\r\n                .style('height', '12px')\r\n                .style('background-color', d => color(d.group_name))\r\n                .style('margin-right', '8px')\r\n                .style('border-radius', '2px')\r\n                .style('flex-shrink', '0');\r\n\r\n            legendItems.append('div')\r\n                .style('color', '#475569')\r\n                .text(d => `${d.group_name} ($${d3.format('.2s')(parseFloat(d.total_revenue))})`);\r\n        }\r\n\r\n        function renderProductsChart(data) {\r\n            const container = document.getElementById('productsChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<p class=\"text-center text-slate-500 py-12 text-sm\">No data available</p>';\r\n                return;\r\n            }\r\n\r\n            const margin = { top: 20, right: 30, bottom: 40, left: 90 };\r\n            const width = container.offsetWidth - margin.left - margin.right;\r\n            const height = 280 - margin.top - margin.bottom;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width + margin.left + margin.right)\r\n                .attr('height', height + margin.top + margin.bottom)\r\n                .append('g')\r\n                .attr('transform', `translate(${margin.left},${margin.top})`);\r\n\r\n            const x = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => parseFloat(d.total_qty))])\r\n                .nice()\r\n                .range([0, width]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(data.map(d => d.product_num))\r\n                .range([0, height])\r\n                .padding(0.2);\r\n\r\n            svg.selectAll('.bar')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', 0)\r\n                .attr('y', d => y(d.product_num))\r\n                .attr('width', d => x(parseFloat(d.total_qty)))\r\n                .attr('height', y.bandwidth())\r\n                .attr('fill', colorPalette[7])\r\n                .attr('rx', 4)\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).attr('fill', colorPalette[6]);\r\n                    tooltip.style('opacity', 1)\r\n                        .html(`\r\n                            <div><span class=\"tooltip-label\">Product:</span><span class=\"tooltip-value\">${d.product_num}</span></div>\r\n                            <div><span class=\"tooltip-label\">Description:</span><span class=\"tooltip-value\">${d.product_desc}</span></div>\r\n                            <div><span class=\"tooltip-label\">Quantity:</span><span class=\"tooltip-value\">${parseFloat(d.total_qty).toLocaleString()}</span></div>\r\n                            <div><span class=\"tooltip-label\">Revenue:</span><span class=\"tooltip-value\">${formatCurrency(d.total_revenue)}</span></div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Click to view orders</div>\r\n                        `)\r\n                        .style('left', (event.pageX + 10) + 'px')\r\n                        .style('top', (event.pageY - 10) + 'px');\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).attr('fill', colorPalette[7]);\r\n                    tooltip.style('opacity', 0);\r\n                })\r\n                .on('click', function(event, d) {\r\n                    drilldownProduct(d.product_num, d.product_desc);\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .attr('transform', `translate(0,${height})`)\r\n                .call(d3.axisBottom(x).ticks(4));\r\n\r\n            svg.append('g')\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '10px');\r\n        }\r\n\r\n        // ============================================\r\n        // New Metrics Rendering Functions\r\n        // ============================================\r\n\r\n        // Render Low Margin Sales (continues next comment for brevity)\r\n        function renderLowMarginChart(data) {\r\n            // Update metric count\r\n            const countEl = document.querySelector('#lowMarginMetric .text-4xl');\r\n            countEl.textContent = data.length;\r\n\r\n            // Render simple list in chart area\r\n            const container = document.getElementById('lowMarginChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8\">No low margin orders found</div>';\r\n                return;\r\n            }\r\n\r\n            // Create clickable list - show all items\r\n            const list = document.createElement('div');\r\n            list.className = 'space-y-2 overflow-y-auto';\r\n            list.style.maxHeight = '200px';\r\n\r\n            data.forEach(order => {\r\n                const item = document.createElement('div');\r\n                item.className = 'p-2 bg-amber-50 rounded cursor-pointer hover:bg-amber-100 transition-colors';\r\n                item.onclick = () => drilldownLowMargin();\r\n                item.innerHTML = `\r\n                    <div class=\"flex justify-between text-sm\">\r\n                        <span class=\"font-semibold text-slate-700\">${order.order_num}</span>\r\n                        <span class=\"text-amber-700 font-bold\">${(order.margin_percent * 100).toFixed(1)}%</span>\r\n                    </div>\r\n                    <div class=\"text-xs text-slate-500\">${order.customer_name}</div>\r\n                `;\r\n                list.appendChild(item);\r\n            });\r\n\r\n            container.appendChild(list);\r\n        }\r\n\r\n        function renderNegativeMarginChart(data) {\r\n            // Update metric count\r\n            const countEl = document.querySelector('#negativeMarginMetric .text-4xl');\r\n            countEl.textContent = data.length;\r\n\r\n            const container = document.getElementById('negativeMarginChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-green-600 py-8 font-semibold\">✓ No negative margin orders!</div>';\r\n                return;\r\n            }\r\n\r\n            const list = document.createElement('div');\r\n            list.className = 'space-y-2 overflow-y-auto';\r\n            list.style.maxHeight = '200px';\r\n\r\n            data.forEach(order => {\r\n                const item = document.createElement('div');\r\n                item.className = 'p-2 bg-red-50 rounded cursor-pointer hover:bg-red-100 transition-colors';\r\n                item.onclick = () => drilldownNegativeMargin();\r\n                item.innerHTML = `\r\n                    <div class=\"flex justify-between text-sm\">\r\n                        <span class=\"font-semibold text-slate-700\">${order.order_num}</span>\r\n                        <span class=\"text-red-700 font-bold\">${(order.margin_percent * 100).toFixed(1)}%</span>\r\n                    </div>\r\n                    <div class=\"text-xs text-slate-500\">${order.customer_name}</div>\r\n                `;\r\n                list.appendChild(item);\r\n            });\r\n\r\n            container.appendChild(list);\r\n        }\r\n\r\n        function renderHighValueChart(data) {\r\n            // Update metric count\r\n            const countEl = document.querySelector('#highValueMetric .text-4xl');\r\n            countEl.textContent = data.length;\r\n\r\n            const container = document.getElementById('highValueChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8\">No high value orders found</div>';\r\n                return;\r\n            }\r\n\r\n            const list = document.createElement('div');\r\n            list.className = 'space-y-2 overflow-y-auto';\r\n            list.style.maxHeight = '200px';\r\n\r\n            data.forEach(order => {\r\n                const item = document.createElement('div');\r\n                item.className = 'p-2 bg-green-50 rounded cursor-pointer hover:bg-green-100 transition-colors';\r\n                item.onclick = () => drilldownHighValue();\r\n                item.innerHTML = `\r\n                    <div class=\"flex justify-between text-sm\">\r\n                        <span class=\"font-semibold text-slate-700\">${order.order_num}</span>\r\n                        <span class=\"text-green-700 font-bold\">${formatCurrency(order.order_total, false)}</span>\r\n                    </div>\r\n                    <div class=\"text-xs text-slate-500\">${order.customer_name}</div>\r\n                `;\r\n                list.appendChild(item);\r\n            });\r\n\r\n            container.appendChild(list);\r\n        }\r\n\r\n        function renderAverageOrderValue(data) {\r\n            const container = document.getElementById('aovMetric');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8\">No data available</div>';\r\n                return;\r\n            }\r\n\r\n            const width = container.clientWidth;\r\n            const height = 280;\r\n            const margin = { top: 20, right: 20, bottom: 60, left: 60 };\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width)\r\n                .attr('height', height);\r\n\r\n            const x = d3.scaleBand()\r\n                .domain(data.map(d => d.month))\r\n                .range([margin.left, width - margin.right])\r\n                .padding(0.2);\r\n\r\n            const y = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => d.avg_order_value)])\r\n                .nice()\r\n                .range([height - margin.bottom, margin.top]);\r\n\r\n            // Bars\r\n            svg.selectAll('rect')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', d => x(d.month))\r\n                .attr('y', d => y(d.avg_order_value))\r\n                .attr('width', x.bandwidth())\r\n                .attr('height', d => height - margin.bottom - y(d.avg_order_value))\r\n                .attr('fill', '#2d9cdb')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).style('opacity', 0.7);\r\n                    showTooltip(event, `\r\n                        <strong>${moment(d.month).format('MMM YYYY')}</strong><br>\r\n                        Avg Order Value: ${formatCurrency(d.avg_order_value)}<br>\r\n                        Orders: ${d.order_count}<br>\r\n                        Total Revenue: ${formatCurrency(d.total_revenue)}\r\n                    `);\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).style('opacity', 1);\r\n                    hideTooltip();\r\n                });\r\n\r\n            // X Axis\r\n            svg.append('g')\r\n                .attr('transform', `translate(0, ${height - margin.bottom})`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisBottom(x).tickFormat(d => moment(d).format('MMM YY')))\r\n                .selectAll('text')\r\n                .attr('transform', 'rotate(-45)')\r\n                .style('text-anchor', 'end')\r\n                .style('font-size', '10px');\r\n\r\n            // Y Axis with smart formatting\r\n            const maxValue = d3.max(data, d => d.avg_order_value);\r\n            const yAxisFormat = maxValue >= 10000\r\n                ? d => '$' + (d / 1000).toFixed(0) + 'k'\r\n                : d => '$' + d.toFixed(0);\r\n\r\n            svg.append('g')\r\n                .attr('transform', `translate(${margin.left}, 0)`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y).tickFormat(yAxisFormat));\r\n        }\r\n\r\n        function renderNewVsRepeatChart(data) {\r\n            const container = document.getElementById('newRepeatChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8\">No data available</div>';\r\n                return;\r\n            }\r\n\r\n            const width = container.clientWidth;\r\n            const height = 280;\r\n            const radius = Math.min(width, height) / 2 - 40;\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width)\r\n                .attr('height', height);\r\n\r\n            const g = svg.append('g')\r\n                .attr('transform', `translate(${width / 2}, ${height / 2})`);\r\n\r\n            const color = d3.scaleOrdinal()\r\n                .domain(['New', 'Repeat'])\r\n                .range(['#2d9cdb', '#27ae60']);\r\n\r\n            const pie = d3.pie()\r\n                .value(d => d.count)\r\n                .sort(null);\r\n\r\n            const arc = d3.arc()\r\n                .innerRadius(radius * 0.6)\r\n                .outerRadius(radius);\r\n\r\n            const arcs = g.selectAll('arc')\r\n                .data(pie(data))\r\n                .enter()\r\n                .append('g')\r\n                .attr('class', 'arc')\r\n                .style('cursor', 'pointer')\r\n                .on('click', (event, d) => drilldownNewRepeat(d.data.type));\r\n\r\n            arcs.append('path')\r\n                .attr('d', arc)\r\n                .attr('fill', d => color(d.data.type))\r\n                .attr('stroke', 'white')\r\n                .attr('stroke-width', 2)\r\n                .on('mouseover', function() {\r\n                    d3.select(this).style('opacity', 0.8);\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).style('opacity', 1);\r\n                });\r\n\r\n            arcs.append('text')\r\n                .attr('transform', d => `translate(${arc.centroid(d)})`)\r\n                .attr('text-anchor', 'middle')\r\n                .attr('fill', 'white')\r\n                .attr('font-weight', 'bold')\r\n                .attr('font-size', '14px')\r\n                .text(d => d.data.count);\r\n\r\n            // Legend\r\n            const legend = svg.append('g')\r\n                .attr('transform', `translate(10, ${height - 60})`);\r\n\r\n            data.forEach((d, i) => {\r\n                const legendRow = legend.append('g')\r\n                    .attr('transform', `translate(0, ${i * 20})`);\r\n\r\n                legendRow.append('rect')\r\n                    .attr('width', 12)\r\n                    .attr('height', 12)\r\n                    .attr('fill', color(d.type));\r\n\r\n                legendRow.append('text')\r\n                    .attr('x', 18)\r\n                    .attr('y', 10)\r\n                    .attr('font-size', '11px')\r\n                    .attr('fill', '#64748b')\r\n                    .text(`${d.type}: ${d.count} (${formatCurrency(d.revenue, false)})`);\r\n            });\r\n        }\r\n\r\n        function renderTopMarginCustomersChart(data) {\r\n            const container = document.getElementById('topMarginCustomersChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8\">No data available</div>';\r\n                return;\r\n            }\r\n\r\n            const width = container.clientWidth;\r\n            const height = 280;\r\n            const margin = { top: 10, right: 10, bottom: 60, left: 40 };\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width)\r\n                .attr('height', height);\r\n\r\n            const x = d3.scaleBand()\r\n                .domain(data.map(d => d.customer_name))\r\n                .range([margin.left, width - margin.right])\r\n                .padding(0.3);\r\n\r\n            const y = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => d.avg_margin_percent)])\r\n                .nice()\r\n                .range([height - margin.bottom, margin.top]);\r\n\r\n            const color = d3.scaleSequential()\r\n                .domain([0, d3.max(data, d => d.avg_margin_percent)])\r\n                .interpolator(d3.interpolateGreens);\r\n\r\n            svg.selectAll('rect')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', d => x(d.customer_name))\r\n                .attr('y', d => y(d.avg_margin_percent))\r\n                .attr('width', x.bandwidth())\r\n                .attr('height', d => height - margin.bottom - y(d.avg_margin_percent))\r\n                .attr('fill', d => color(d.avg_margin_percent))\r\n                .style('cursor', 'pointer')\r\n                .on('click', (event, d) => drilldownCustomer(d.customer_name))\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).style('opacity', 0.7);\r\n                    showTooltip(event, `\r\n                        <strong>${d.customer_name}</strong><br>\r\n                        Avg Margin: ${(d.avg_margin_percent * 100).toFixed(1)}%<br>\r\n                        Revenue: ${formatCurrency(d.total_revenue)}<br>\r\n                        Orders: ${d.order_count}\r\n                    `);\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).style('opacity', 1);\r\n                    hideTooltip();\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('transform', `translate(0, ${height - margin.bottom})`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisBottom(x))\r\n                .selectAll('text')\r\n                .attr('transform', 'rotate(-45)')\r\n                .style('text-anchor', 'end')\r\n                .style('font-size', '9px')\r\n                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);\r\n\r\n            svg.append('g')\r\n                .attr('transform', `translate(${margin.left}, 0)`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y).tickFormat(d => (d * 100).toFixed(0) + '%'));\r\n        }\r\n\r\n        function renderInactiveCustomersChart(data) {\r\n            // Update metric count\r\n            const countEl = document.querySelector('#inactiveCustomersMetric .text-4xl');\r\n            countEl.textContent = data.length;\r\n\r\n            const container = document.getElementById('inactiveCustomersChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-green-600 py-8 font-semibold\">✓ No inactive customers!</div>';\r\n                return;\r\n            }\r\n\r\n            const list = document.createElement('div');\r\n            list.className = 'space-y-2 overflow-y-auto';\r\n            list.style.maxHeight = '200px';\r\n\r\n            data.forEach(customer => {\r\n                const item = document.createElement('div');\r\n                item.className = 'p-2 bg-slate-50 rounded cursor-pointer hover:bg-slate-100 transition-colors';\r\n                item.onclick = () => drilldownInactiveCustomers();\r\n                item.innerHTML = `\r\n                    <div class=\"flex justify-between text-sm\">\r\n                        <span class=\"font-semibold text-slate-700\">${customer.customer_name}</span>\r\n                        <span class=\"text-slate-600 text-xs\">${customer.days_since_order} days</span>\r\n                    </div>\r\n                    <div class=\"text-xs text-slate-500\">Lifetime: ${formatCurrency(customer.lifetime_revenue, false)}</div>\r\n                `;\r\n                list.appendChild(item);\r\n            });\r\n\r\n            container.appendChild(list);\r\n        }\r\n\r\n        function renderProductMixChart(data) {\r\n            const container = document.getElementById('productMixChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8\">No data available</div>';\r\n                return;\r\n            }\r\n\r\n            // Group data by month and category\r\n            const months = [...new Set(data.map(d => d.month))].sort();\r\n            const categories = [...new Set(data.map(d => d.category))];\r\n\r\n            // Create stacked data structure\r\n            const stackData = months.map(month => {\r\n                const monthData = { month };\r\n                categories.forEach(cat => {\r\n                    const found = data.find(d => d.month === month && d.category === cat);\r\n                    monthData[cat] = found ? parseFloat(found.revenue) : 0;\r\n                });\r\n                return monthData;\r\n            });\r\n\r\n            const width = container.clientWidth;\r\n            const height = 280;\r\n            const margin = { top: 10, right: 120, bottom: 40, left: 60 };\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width)\r\n                .attr('height', height);\r\n\r\n            const x = d3.scaleBand()\r\n                .domain(months)\r\n                .range([margin.left, width - margin.right])\r\n                .padding(0.1);\r\n\r\n            const y = d3.scaleLinear()\r\n                .domain([0, d3.max(stackData, d => {\r\n                    return categories.reduce((sum, cat) => sum + (d[cat] || 0), 0);\r\n                })])\r\n                .nice()\r\n                .range([height - margin.bottom, margin.top]);\r\n\r\n            const color = d3.scaleOrdinal()\r\n                .domain(categories)\r\n                .range(d3.schemeCategory10);\r\n\r\n            const stack = d3.stack()\r\n                .keys(categories);\r\n\r\n            const series = stack(stackData);\r\n\r\n            svg.append('g')\r\n                .selectAll('g')\r\n                .data(series)\r\n                .enter().append('g')\r\n                .attr('fill', d => color(d.key))\r\n                .selectAll('rect')\r\n                .data(d => d)\r\n                .enter().append('rect')\r\n                .attr('x', d => x(d.data.month))\r\n                .attr('y', d => y(d[1]))\r\n                .attr('height', d => y(d[0]) - y(d[1]))\r\n                .attr('width', x.bandwidth())\r\n                .on('mouseover', function(event, d) {\r\n                    const category = d3.select(this.parentNode).datum().key;\r\n                    const value = d.data[category];\r\n                    showTooltip(event, `\r\n                        <strong>${category}</strong><br>\r\n                        Month: ${d.data.month}<br>\r\n                        Revenue: ${formatCurrency(value)}\r\n                    `);\r\n                })\r\n                .on('mouseout', hideTooltip);\r\n\r\n            svg.append('g')\r\n                .attr('transform', `translate(0, ${height - margin.bottom})`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisBottom(x))\r\n                .selectAll('text')\r\n                .style('font-size', '9px');\r\n\r\n            svg.append('g')\r\n                .attr('transform', `translate(${margin.left}, 0)`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y).tickFormat(d => '$' + (d / 1000).toFixed(0) + 'k'));\r\n\r\n            // Legend\r\n            const legend = svg.append('g')\r\n                .attr('transform', `translate(${width - margin.right + 10}, ${margin.top})`);\r\n\r\n            categories.forEach((cat, i) => {\r\n                const legendRow = legend.append('g')\r\n                    .attr('transform', `translate(0, ${i * 18})`);\r\n\r\n                legendRow.append('rect')\r\n                    .attr('width', 12)\r\n                    .attr('height', 12)\r\n                    .attr('fill', color(cat));\r\n\r\n                legendRow.append('text')\r\n                    .attr('x', 16)\r\n                    .attr('y', 10)\r\n                    .attr('font-size', '10px')\r\n                    .attr('fill', '#64748b')\r\n                    .text(cat.length > 12 ? cat.substring(0, 12) + '...' : cat);\r\n            });\r\n        }\r\n\r\n        function renderSlowMovingChart(data) {\r\n            const container = document.getElementById('slowMovingChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || !Array.isArray(data) || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8\">No slow-moving inventory found</div>';\r\n                return;\r\n            }\r\n\r\n            const width = container.clientWidth;\r\n            const height = 280;\r\n            const margin = { top: 10, right: 10, bottom: 60, left: 100 };\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width)\r\n                .attr('height', height);\r\n\r\n            const topData = data.slice(0, 10);\r\n\r\n            const x = d3.scaleLinear()\r\n                .domain([0, d3.max(topData, d => d.days_of_supply)])\r\n                .nice()\r\n                .range([margin.left, width - margin.right]);\r\n\r\n            const y = d3.scaleBand()\r\n                .domain(topData.map(d => d.product_name))\r\n                .range([margin.top, height - margin.bottom])\r\n                .padding(0.2);\r\n\r\n            svg.selectAll('rect')\r\n                .data(topData)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', margin.left)\r\n                .attr('y', d => y(d.product_name))\r\n                .attr('width', d => x(d.days_of_supply) - margin.left)\r\n                .attr('height', y.bandwidth())\r\n                .attr('fill', '#f97316')\r\n                .style('cursor', 'pointer')\r\n                .on('click', (event, d) => drilldownProduct(d.product_num))\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).style('opacity', 0.7);\r\n                    showTooltip(event, `\r\n                        <strong>${d.product_name}</strong><br>\r\n                        On Hand: ${d.qty_on_hand}<br>\r\n                        Sold (period): ${d.qty_sold}<br>\r\n                        Days of Supply: ${d.days_of_supply ? d.days_of_supply.toFixed(0) : 'N/A'}\r\n                    `);\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).style('opacity', 1);\r\n                    hideTooltip();\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('transform', `translate(0, ${height - margin.bottom})`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisBottom(x));\r\n\r\n            // Add X-axis label\r\n            svg.append('text')\r\n                .attr('x', width / 2)\r\n                .attr('y', height - 5)\r\n                .attr('text-anchor', 'middle')\r\n                .style('font-size', '12px')\r\n                .style('fill', '#64748b')\r\n                .text('Days of Stock');\r\n\r\n            svg.append('g')\r\n                .attr('transform', `translate(${margin.left}, 0)`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y))\r\n                .selectAll('text')\r\n                .style('font-size', '9px')\r\n                .text(d => d.length > 20 ? d.substring(0, 20) + '...' : d);\r\n        }\r\n\r\n        function renderOrdersPerSalespersonChart(data) {\r\n            const container = document.getElementById('ordersPerSalespersonChart');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8\">No data available</div>';\r\n                return;\r\n            }\r\n\r\n            const width = container.clientWidth;\r\n            const height = 280;\r\n            const margin = { top: 10, right: 10, bottom: 60, left: 40 };\r\n\r\n            const svg = d3.select(container)\r\n                .append('svg')\r\n                .attr('width', width)\r\n                .attr('height', height);\r\n\r\n            const x = d3.scaleBand()\r\n                .domain(data.map(d => d.fullname))\r\n                .range([margin.left, width - margin.right])\r\n                .padding(0.3);\r\n\r\n            const y = d3.scaleLinear()\r\n                .domain([0, d3.max(data, d => d.order_count)])\r\n                .nice()\r\n                .range([height - margin.bottom, margin.top]);\r\n\r\n            svg.selectAll('rect')\r\n                .data(data)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', d => x(d.fullname))\r\n                .attr('y', d => y(d.order_count))\r\n                .attr('width', x.bandwidth())\r\n                .attr('height', d => height - margin.bottom - y(d.order_count))\r\n                .attr('fill', '#2d9cdb')\r\n                .style('cursor', 'pointer')\r\n                .on('click', (event, d) => drilldownSalesperson(d.salesmanid))\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).style('opacity', 0.7);\r\n                    showTooltip(event, `\r\n                        <strong>${d.fullname}</strong><br>\r\n                        Orders: ${d.order_count}<br>\r\n                        Revenue: ${formatCurrency(d.total_revenue)}\r\n                    `);\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).style('opacity', 1);\r\n                    hideTooltip();\r\n                });\r\n\r\n            svg.append('g')\r\n                .attr('transform', `translate(0, ${height - margin.bottom})`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisBottom(x))\r\n                .selectAll('text')\r\n                .attr('transform', 'rotate(-45)')\r\n                .style('text-anchor', 'end')\r\n                .style('font-size', '9px')\r\n                .text(d => d.length > 12 ? d.substring(0, 12) + '...' : d);\r\n\r\n            svg.append('g')\r\n                .attr('transform', `translate(${margin.left}, 0)`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y));\r\n        }\r\n\r\n        function renderAvgDaysToShip(data) {\r\n            const container = document.getElementById('avgDaysMetric');\r\n            container.innerHTML = '';\r\n\r\n            if (!data || data.length === 0) {\r\n                container.innerHTML = '<div class=\"text-center text-slate-400 py-8\">No data available</div>';\r\n                return;\r\n            }\r\n\r\n            // Calculate on-time percentage for each month\r\n            const dataWithPercent = data.map(d => ({\r\n                ...d,\r\n                on_time_percent: d.order_count > 0 ? (d.on_time_count / d.order_count * 100) : 0,\r\n                late_count: d.order_count - d.on_time_count,\r\n                // Calculate average days overdue for late orders\r\n                avg_days_overdue: d.order_count > d.on_time_count ? d.avg_days_to_complete : 0\r\n            }));\r\n\r\n            // Calculate overall metrics\r\n            const totalOrders = data.reduce((sum, d) => sum + d.order_count, 0);\r\n            const totalOnTime = data.reduce((sum, d) => sum + d.on_time_count, 0);\r\n            const totalLate = totalOrders - totalOnTime;\r\n            const overallPercent = totalOrders > 0 ? (totalOnTime / totalOrders * 100) : 0;\r\n\r\n            // Calculate average days overdue (weighted average of late orders)\r\n            const totalDaysOverdue = data.reduce((sum, d) => {\r\n                const lateOrders = d.order_count - d.on_time_count;\r\n                return sum + (lateOrders * d.avg_days_to_complete);\r\n            }, 0);\r\n            const avgDaysOverdue = totalLate > 0 ? totalDaysOverdue / totalLate : 0;\r\n\r\n            // Create container layout: donut + KPI on left, bar chart on right\r\n            container.innerHTML = `\r\n                <div style=\"display: flex; gap: 20px; align-items: stretch;\">\r\n                    <div id=\"difotDonutContainer\" style=\"flex: 0 0 220px; display: flex; flex-direction: column; align-items: center;\">\r\n                        <div id=\"difotDonut\"></div>\r\n                        <div id=\"difotKpi\" style=\"margin-top: 10px; text-align: center; width: 100%;\"></div>\r\n                    </div>\r\n                    <div id=\"difotBarChart\" style=\"flex: 1;\"></div>\r\n                </div>\r\n            `;\r\n\r\n            // Render donut chart\r\n            const donutContainer = document.getElementById('difotDonut');\r\n            const donutSize = 180;\r\n            const donutRadius = donutSize / 2;\r\n            const innerRadius = donutRadius * 0.6;\r\n\r\n            const donutSvg = d3.select(donutContainer)\r\n                .append('svg')\r\n                .attr('width', donutSize)\r\n                .attr('height', donutSize)\r\n                .append('g')\r\n                .attr('transform', `translate(${donutRadius}, ${donutRadius})`);\r\n\r\n            const donutData = [\r\n                { label: 'On-Time', value: totalOnTime, color: overallPercent >= 90 ? '#10b981' : overallPercent >= 80 ? '#f59e0b' : '#ef4444' },\r\n                { label: 'Late', value: totalLate, color: '#e2e8f0' }\r\n            ];\r\n\r\n            const pie = d3.pie().value(d => d.value).sort(null);\r\n            const arc = d3.arc().innerRadius(innerRadius).outerRadius(donutRadius);\r\n\r\n            donutSvg.selectAll('path')\r\n                .data(pie(donutData))\r\n                .enter()\r\n                .append('path')\r\n                .attr('d', arc)\r\n                .attr('fill', d => d.data.color)\r\n                .attr('stroke', 'white')\r\n                .attr('stroke-width', 2);\r\n\r\n            // Add percentage text in center\r\n            donutSvg.append('text')\r\n                .attr('text-anchor', 'middle')\r\n                .attr('dy', '-0.2em')\r\n                .style('font-size', '28px')\r\n                .style('font-weight', 'bold')\r\n                .style('fill', donutData[0].color)\r\n                .text(`${overallPercent.toFixed(1)}%`);\r\n\r\n            donutSvg.append('text')\r\n                .attr('text-anchor', 'middle')\r\n                .attr('dy', '1.2em')\r\n                .style('font-size', '12px')\r\n                .style('fill', '#64748b')\r\n                .text('On-Time');\r\n\r\n            // Add Average Days Overdue KPI below donut\r\n            const kpiContainer = document.getElementById('difotKpi');\r\n            kpiContainer.innerHTML = `\r\n                <div style=\"padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;\">\r\n                    <div style=\"font-size: 24px; font-weight: bold; color: ${avgDaysOverdue > 5 ? '#ef4444' : avgDaysOverdue > 2 ? '#f59e0b' : '#10b981'};\">\r\n                        ${avgDaysOverdue.toFixed(1)}\r\n                    </div>\r\n                    <div style=\"font-size: 11px; color: #64748b; margin-top: 2px;\">\r\n                        Avg Days Overdue\r\n                    </div>\r\n                    <div style=\"font-size: 10px; color: #94a3b8; margin-top: 2px;\">\r\n                        ${totalLate} of ${totalOrders} late\r\n                    </div>\r\n                </div>\r\n            `;\r\n\r\n            // Render bar chart (taller now)\r\n            const barContainer = document.getElementById('difotBarChart');\r\n            const barWidth = barContainer.clientWidth;\r\n            const barHeight = 300;  // Increased from 200\r\n            const margin = { top: 20, right: 20, bottom: 60, left: 50 };\r\n\r\n            const barSvg = d3.select(barContainer)\r\n                .append('svg')\r\n                .attr('width', barWidth)\r\n                .attr('height', barHeight);\r\n\r\n            // X scale - band scale for bars\r\n            const x = d3.scaleBand()\r\n                .domain(dataWithPercent.map(d => d.month))\r\n                .range([margin.left, barWidth - margin.right])\r\n                .padding(0.2);\r\n\r\n            // Y scale - 0 to 100 for percentage\r\n            const y = d3.scaleLinear()\r\n                .domain([0, 100])\r\n                .range([barHeight - margin.bottom, margin.top]);\r\n\r\n            // Draw bars\r\n            barSvg.selectAll('rect')\r\n                .data(dataWithPercent)\r\n                .enter()\r\n                .append('rect')\r\n                .attr('x', d => x(d.month))\r\n                .attr('y', d => y(d.on_time_percent))\r\n                .attr('width', x.bandwidth())\r\n                .attr('height', d => barHeight - margin.bottom - y(d.on_time_percent))\r\n                .attr('fill', d => {\r\n                    const percent = d.on_time_percent;\r\n                    if (percent >= 90) return '#10b981';\r\n                    if (percent >= 80) return '#f59e0b';\r\n                    return '#ef4444';\r\n                })\r\n                .style('cursor', 'pointer')\r\n                .on('mouseover', function(event, d) {\r\n                    d3.select(this).style('opacity', 0.7);\r\n                    showTooltip(event, `\r\n                        <strong>${moment(d.month).format('MMM YYYY')}</strong><br>\r\n                        On-Time: ${d.on_time_percent.toFixed(1)}%<br>\r\n                        Delivered: ${d.on_time_count}/${d.order_count}<br>\r\n                        Avg Days: ${parseFloat(d.avg_days_to_complete).toFixed(1)}\r\n                    `);\r\n                })\r\n                .on('mouseout', function() {\r\n                    d3.select(this).style('opacity', 1);\r\n                    hideTooltip();\r\n                });\r\n\r\n            // X Axis\r\n            barSvg.append('g')\r\n                .attr('transform', `translate(0, ${barHeight - margin.bottom})`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisBottom(x).tickFormat(d => moment(d).format('MMM YY')))\r\n                .selectAll('text')\r\n                .attr('transform', 'rotate(-45)')\r\n                .style('text-anchor', 'end')\r\n                .style('font-size', '10px');\r\n\r\n            // Y Axis\r\n            barSvg.append('g')\r\n                .attr('transform', `translate(${margin.left}, 0)`)\r\n                .attr('class', 'axis')\r\n                .call(d3.axisLeft(y).tickFormat(d => d + '%'));\r\n\r\n            // Add reference lines at 90% and 80%\r\n            barSvg.append('line')\r\n                .attr('x1', margin.left)\r\n                .attr('x2', barWidth - margin.right)\r\n                .attr('y1', y(90))\r\n                .attr('y2', y(90))\r\n                .attr('stroke', '#10b981')\r\n                .attr('stroke-width', 1)\r\n                .attr('stroke-dasharray', '4,4')\r\n                .attr('opacity', 0.5);\r\n\r\n            barSvg.append('line')\r\n                .attr('x1', margin.left)\r\n                .attr('x2', barWidth - margin.right)\r\n                .attr('y1', y(80))\r\n                .attr('y2', y(80))\r\n                .attr('stroke', '#f59e0b')\r\n                .attr('stroke-width', 1)\r\n                .attr('stroke-dasharray', '4,4')\r\n                .attr('opacity', 0.5);\r\n        }\r\n\r\n        // ============================================\r\n        // UI Functions\r\n        // ============================================\r\n        function applyDateRange() {\r\n            const rangeValue = document.getElementById('dateRangeFilter').value;\r\n            const customContainer = document.getElementById('customDateRangeContainer');\r\n            const comparisonContainer = document.getElementById('comparisonToggleContainer');\r\n\r\n            // Hide/show custom date picker\r\n            if (rangeValue === 'custom') {\r\n                customContainer.style.display = 'flex';\r\n                comparisonContainer.style.display = 'none';\r\n                return; // Don't load dashboard until custom dates are set\r\n            } else {\r\n                customContainer.style.display = 'none';\r\n            }\r\n\r\n            // Show comparison toggle for current periods\r\n            const showComparison = ['this_quarter', 'current_fy', 'current_cy'].includes(rangeValue);\r\n            comparisonContainer.style.display = showComparison ? 'flex' : 'none';\r\n\r\n            // Calculate date range\r\n            let dates;\r\n            switch(rangeValue) {\r\n                case 'this_quarter':\r\n                    dates = getQuarterDates(0);\r\n                    break;\r\n                case 'last_quarter':\r\n                    dates = getQuarterDates(1);\r\n                    break;\r\n                case 'current_fy':\r\n                    dates = getFYDates(0);\r\n                    break;\r\n                case 'last_fy':\r\n                    dates = getFYDates(1);\r\n                    break;\r\n                case 'current_cy':\r\n                    dates = getCalendarYearDates(0);\r\n                    break;\r\n                case 'last_cy':\r\n                    dates = getCalendarYearDates(1);\r\n                    break;\r\n                default:\r\n                    // Numeric days\r\n                    currentDateRange = parseInt(rangeValue);\r\n                    customStartDate = null;\r\n                    customEndDate = null;\r\n                    updateDateRangeDisplay();\r\n                    loadDashboard();\r\n                    return;\r\n            }\r\n\r\n            customStartDate = dates.start;\r\n            customEndDate = dates.end;\r\n            document.getElementById('customStartDate').value = dates.start;\r\n            document.getElementById('customEndDate').value = dates.end;\r\n\r\n            updateDateRangeDisplay();\r\n            loadDashboard();\r\n        }\r\n\r\n        function toggleComparison() {\r\n            comparisonEnabled = document.getElementById('comparisonToggle').checked;\r\n            loadDashboard();\r\n        }\r\n\r\n        function setDateRange(days) {\r\n            // Legacy function for backward compatibility\r\n            document.getElementById('dateRangeFilter').value = days.toString();\r\n            applyDateRange();\r\n        }\r\n\r\n        function clearAllFilters() {\r\n            // Reset all filter dropdowns to default \"All\" values\r\n            document.getElementById('customerGroupFilter').value = '%';\r\n            document.getElementById('productCategoryFilter').value = '%';\r\n            document.getElementById('accountManagerFilter').value = '%';\r\n            document.getElementById('marginFilter').value = '%';\r\n            document.getElementById('dateRangeFilter').value = '90';\r\n\r\n            // Reset custom dates\r\n            customStartDate = null;\r\n            customEndDate = null;\r\n            document.getElementById('customStartDate').value = '';\r\n            document.getElementById('customEndDate').value = '';\r\n\r\n            // Hide custom date picker\r\n            document.getElementById('customDateRangeContainer').style.display = 'none';\r\n\r\n            // Reload dashboard with cleared filters\r\n            loadDashboard();\r\n        }\r\n\r\n        function printDashboard() {\r\n            // Hide elements that shouldn't be printed\r\n            const header = document.querySelector('header');\r\n            const filters = document.querySelector('.bg-white.rounded-2xl.shadow-md.border.border-slate-300.p-4.mb-4');\r\n            const debugConsole = document.getElementById('debugConsole');\r\n\r\n            // Store original display states\r\n            const headerDisplay = header.style.display;\r\n            const filtersDisplay = filters ? filters.style.display : '';\r\n            const debugDisplay = debugConsole ? debugConsole.style.display : '';\r\n\r\n            // Hide for printing\r\n            header.style.display = 'none';\r\n            if (filters) filters.style.display = 'none';\r\n            if (debugConsole) debugConsole.style.display = 'none';\r\n\r\n            // Set up one-time event listener to restore after printing\r\n            const restoreElements = () => {\r\n                header.style.display = headerDisplay;\r\n                if (filters) filters.style.display = filtersDisplay;\r\n                if (debugConsole) debugConsole.style.display = debugDisplay;\r\n                window.removeEventListener('afterprint', restoreElements);\r\n            };\r\n\r\n            window.addEventListener('afterprint', restoreElements);\r\n\r\n            // Trigger print\r\n            window.print();\r\n        }\r\n\r\n        function updateDateRangeDisplay() {\r\n            const displayEl = document.getElementById('dateRangeDisplay');\r\n            if (!displayEl) return;\r\n\r\n            const rangeValue = document.getElementById('dateRangeFilter').value;\r\n            let displayText = '';\r\n\r\n            if (customStartDate && customEndDate) {\r\n                displayText = `(${moment(customStartDate).format(MOMENT_DATE_FORMAT)} - ${moment(customEndDate).format(MOMENT_DATE_FORMAT)})`;\r\n            } else if (rangeValue === 'this_quarter') {\r\n                displayText = '(This Quarter)';\r\n            } else if (rangeValue === 'last_quarter') {\r\n                displayText = '(Last Quarter)';\r\n            } else if (rangeValue === 'current_fy') {\r\n                displayText = '(Current Financial Year)';\r\n            } else if (rangeValue === 'last_fy') {\r\n                displayText = '(Last Financial Year)';\r\n            } else if (rangeValue === 'current_cy') {\r\n                displayText = '(Current Calendar Year)';\r\n            } else if (rangeValue === 'last_cy') {\r\n                displayText = '(Last Calendar Year)';\r\n            } else if (rangeValue) {\r\n                displayText = `(Last ${rangeValue} Days)`;\r\n            }\r\n\r\n            displayEl.textContent = displayText;\r\n        }\r\n\r\n        function toggleRevenueChartMode(mode) {\r\n            revenueChartMode = mode;\r\n\r\n            // Update button states\r\n            const lineBtn = document.getElementById('revenueLineBtn');\r\n            const barBtn = document.getElementById('revenueBarBtn');\r\n\r\n            if (mode === 'line') {\r\n                lineBtn.classList.add('bg-white', 'text-slate-800');\r\n                lineBtn.classList.remove('text-slate-600');\r\n                barBtn.classList.remove('bg-white', 'text-slate-800');\r\n                barBtn.classList.add('text-slate-600');\r\n            } else {\r\n                barBtn.classList.add('bg-white', 'text-slate-800');\r\n                barBtn.classList.remove('text-slate-600');\r\n                lineBtn.classList.remove('bg-white', 'text-slate-800');\r\n                lineBtn.classList.add('text-slate-600');\r\n            }\r\n\r\n            // Re-render the chart with new mode\r\n            const data = getSalesRevenueOverTime();\r\n            renderRevenueChart(data);\r\n        }\r\n\r\n        function applyCustomDateRange() {\r\n            const startInput = document.getElementById('customStartDate');\r\n            const endInput = document.getElementById('customEndDate');\r\n\r\n            if (startInput.value && endInput.value) {\r\n                customStartDate = startInput.value;\r\n                customEndDate = endInput.value;\r\n                currentDateRange = null; // Clear preset range\r\n\r\n                // Clear preset button states\r\n                document.querySelectorAll('.bg-slate-50 button').forEach(btn => {\r\n                    btn.classList.remove('bg-white', 'text-slate-800');\r\n                    btn.classList.add('text-slate-600');\r\n                });\r\n\r\n                updateDateRangeDisplay();\r\n                loadDashboard();\r\n            }\r\n        }\r\n\r\n        // ============================================\r\n        // Drill-down Modal Functions\r\n        // ============================================\r\n        function openDrilldown(title, breadcrumb, data, columns) {\r\n            if (!data || !Array.isArray(data)) {\r\n                debugLog('openDrilldown called with invalid data', 'error');\r\n                return;\r\n            }\r\n            debugLog(`Opening drilldown: \"${title}\" with ${data.length} rows`, 'info');\r\n            currentDrilldownData = data;\r\n            currentDrilldownColumns = columns;\r\n            currentSortColumn = null;\r\n            currentSortDirection = 'asc';\r\n\r\n            document.getElementById('drilldownTitle').textContent = title;\r\n            document.getElementById('drilldownBreadcrumb').textContent = breadcrumb;\r\n            document.getElementById('drilldownSearch').value = '';\r\n\r\n            renderDrilldownTable(data);\r\n\r\n            const modal = document.getElementById('drilldownModal');\r\n            debugLog('Modal element found: ' + (modal ? 'YES' : 'NO'), modal ? 'success' : 'error');\r\n            debugLog('Setting modal display to flex...', 'info');\r\n            modal.style.display = 'flex';\r\n            debugLog('Modal display is now: ' + modal.style.display, modal.style.display === 'flex' ? 'success' : 'error');\r\n        }\r\n\r\n        function closeDrilldown(event) {\r\n            if (event && event.target !== event.currentTarget) return;\r\n\r\n            debugLog('Closing drilldown modal', 'info');\r\n            const modal = document.getElementById('drilldownModal');\r\n            modal.style.display = 'none';\r\n        }\r\n\r\n        function renderDrilldownTable(data) {\r\n            const thead = document.getElementById('drilldownTableHead');\r\n            const tbody = document.getElementById('drilldownTableBody');\r\n\r\n            // Render headers\r\n            thead.innerHTML = '<tr>' + currentDrilldownColumns.map((col, idx) => `\r\n                <th class=\"px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors\" onclick=\"sortDrilldownTable(${idx})\">\r\n                    <div class=\"flex items-center gap-2\">\r\n                        <span>${col.label}</span>\r\n                        <svg class=\"w-3 h-3 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4\"></path>\r\n                        </svg>\r\n                    </div>\r\n                </th>\r\n            `).join('') + '</tr>';\r\n\r\n            // Render rows\r\n            tbody.innerHTML = data.map((row, rowIndex) => {\r\n                const isOrderRow = row.hasOwnProperty('order_num');\r\n                const rowClass = isOrderRow ? 'hover:bg-indigo-50 cursor-pointer transition-colors' : 'hover:bg-slate-50 transition-colors';\r\n                const rowClick = isOrderRow ? `onclick=\"toggleOrderLineItems(${rowIndex}, '${escapeSQL(row.order_num)}')\"` : '';\r\n\r\n                // Detect if this is a credit/return row by checking for negative revenue/total\r\n                const revenueKeys = ['total_revenue', 'line_total', 'total', 'order_total'];\r\n                const isCredit = revenueKeys.some(key => parseFloat(row[key] || 0) < 0);\r\n\r\n                return `<tr class=\"${rowClass}\" ${rowClick} data-row-index=\"${rowIndex}\">` +\r\n                    currentDrilldownColumns.map(col => {\r\n                        let value = row[col.key];\r\n                        let colorClass = '';\r\n                        const numericValue = parseFloat(value || 0);\r\n\r\n                        // Format based on type\r\n                        if (col.type === 'currency') {\r\n                            value = formatCurrency(numericValue);\r\n                            // Red text for negative currency values (not bold per TODO)\r\n                            if (numericValue < 0) colorClass = 'text-red-600';\r\n                        } else if (col.type === 'number') {\r\n                            value = numericValue.toLocaleString('en-US');\r\n                        } else if (col.type === 'percent') {\r\n                            // For credits, invert the margin to show as negative\r\n                            let displayValue = numericValue;\r\n                            if (isCredit && col.key.includes('margin')) {\r\n                                displayValue = -Math.abs(numericValue); // Force negative for credit margins\r\n                            }\r\n                            value = (displayValue * 100).toFixed(1) + '%';\r\n                        } else if (col.type === 'date') {\r\n                            value = moment(value).format('D MMM YYYY');\r\n                        } else if (col.format) {\r\n                            value = col.format(value);\r\n                        }\r\n\r\n                        // Color coding for margin\r\n                        if (col.key.includes('margin') && col.type === 'percent') {\r\n                            if (isCredit) {\r\n                                // Credits show red for margin but not bold (per TODO - less aggressive styling)\r\n                                colorClass = 'text-red-600';\r\n                            } else {\r\n                                const marginVal = numericValue;\r\n                                if (marginVal >= MARGIN_GOOD) colorClass = 'text-green-600 font-semibold';\r\n                                else if (marginVal >= MARGIN_MEDIUM) colorClass = 'text-yellow-600 font-semibold';\r\n                                else colorClass = 'text-red-600 font-semibold';\r\n                            }\r\n                        }\r\n\r\n                        // Make order numbers clickable\r\n                        if (col.key === 'order_num' && value) {\r\n                            value = `<a href=\"#\" class=\"order-link\" onclick=\"event.stopPropagation(); openSalesOrder('${escapeSQL(value)}'); return false;\">${value}</a>`;\r\n                        }\r\n\r\n                        // Add expand icon for order_num column\r\n                        const expandIcon = col.key === 'order_num' && isOrderRow ?\r\n                            '<svg class=\"w-4 h-4 inline-block mr-1 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\"></path></svg>' : '';\r\n\r\n                        return `<td class=\"px-4 py-3 text-slate-700 ${colorClass}\">${expandIcon}${value}</td>`;\r\n                    }).join('') +\r\n                '</tr>';\r\n            }).join('');\r\n        }\r\n\r\n        function toggleOrderLineItems(rowIndex, orderNum) {\r\n            const tbody = document.getElementById('drilldownTableBody');\r\n            const existingExpandedRow = tbody.querySelector(`tr[data-expanded-for=\"${rowIndex}\"]`);\r\n\r\n            // If already expanded, collapse it\r\n            if (existingExpandedRow) {\r\n                existingExpandedRow.remove();\r\n                return;\r\n            }\r\n\r\n            // Get current filters for line items query and label\r\n            const productCategory = document.getElementById('productCategoryFilter').value;\r\n            const marginFilter = document.getElementById('marginFilter').value;\r\n\r\n            // Build filter conditions\r\n            const productCategoryCondition = productCategory !== '%'\r\n                ? `AND ProductTree.Name = '${escapeSQL(productCategory)}'`\r\n                : '';\r\n\r\n            // Margin filter condition for line items\r\n            const marginExpr = `((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - PostSoItem.PostedTotalCost) / NULLIF(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty, 0)`;\r\n            let marginCondition = '';\r\n            if (marginFilter === 'good') {\r\n                marginCondition = `AND ${marginExpr} >= 0.30`;\r\n            } else if (marginFilter === 'medium') {\r\n                marginCondition = `AND ${marginExpr} >= 0.15 AND ${marginExpr} < 0.30`;\r\n            } else if (marginFilter === 'low') {\r\n                marginCondition = `AND ${marginExpr} < 0.15`;\r\n            }\r\n\r\n            // Build filter label for display\r\n            const marginLabels = { 'good': 'Good margin (≥30%)', 'medium': 'Medium margin (15-30%)', 'low': 'Low margin (<15%)' };\r\n            let filterParts = [];\r\n            if (productCategory !== '%') filterParts.push(productCategory);\r\n            if (marginFilter !== 'all') filterParts.push(marginLabels[marginFilter]);\r\n            const filterLabel = filterParts.length > 0 ? ` (${filterParts.join(', ')})` : '';\r\n\r\n            // Fetch line items for this order (filtered by active filters)\r\n            const query = `\r\n                SELECT\r\n                    Product.Num as product_num,\r\n                    Product.Description as product_desc,\r\n                    PostSoItem.Qty as qty,\r\n                    COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) as unit_price,\r\n                    COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty as line_total,\r\n                    PostSoItem.PostedTotalCost as cost,\r\n                    ((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/NULLIF(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty, 0) as margin_percent\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                WHERE So.Num = '${escapeSQL(orderNum)}'\r\n                    AND SoItem.typeId NOT IN (30,40)\r\n                    ${productCategoryCondition}\r\n                    ${marginCondition}\r\n                ORDER BY SoItem.Id ASC\r\n            `;\r\n\r\n            console.log('Line Items Query:', query);\r\n            const queryResult = runQuery(query);\r\n            const lineItems = queryResult ? JSON.parse(queryResult) : null;\r\n\r\n            if (!lineItems || lineItems.length === 0) {\r\n                alert('No line items found for this order.');\r\n                return;\r\n            }\r\n\r\n            // Helper to format currency with negative handling (uses global formatCurrency)\r\n            const formatCurrencyCell = (val) => {\r\n                const num = parseFloat(val || 0);\r\n                const isNeg = num < 0;\r\n                return {\r\n                    value: formatCurrency(num),\r\n                    // Credits: red text but not bold (less aggressive styling per TODO)\r\n                    colorClass: isNeg ? 'text-red-600' : 'text-slate-700'\r\n                };\r\n            };\r\n\r\n            // Helper to format margin with credit detection\r\n            const formatMarginCell = (marginVal, lineTotal) => {\r\n                const margin = parseFloat(marginVal || 0);\r\n                const total = parseFloat(lineTotal || 0);\r\n                const isCredit = total < 0;\r\n\r\n                // For credits, show margin as negative\r\n                const displayMargin = isCredit ? -Math.abs(margin) : margin;\r\n                const formatted = (displayMargin * 100).toFixed(1) + '%';\r\n\r\n                let colorClass;\r\n                if (isCredit) {\r\n                    // Credits: red text but not bold (less aggressive styling per TODO)\r\n                    colorClass = 'text-red-600';\r\n                } else if (margin >= MARGIN_GOOD) {\r\n                    colorClass = 'text-green-600 font-semibold';\r\n                } else if (margin >= MARGIN_MEDIUM) {\r\n                    colorClass = 'text-yellow-600 font-semibold';\r\n                } else {\r\n                    colorClass = 'text-red-600 font-semibold';\r\n                }\r\n\r\n                return { value: formatted, colorClass };\r\n            };\r\n\r\n            // Create expanded row with line items table\r\n            const targetRow = tbody.querySelector(`tr[data-row-index=\"${rowIndex}\"]`);\r\n            const expandedRow = document.createElement('tr');\r\n            expandedRow.setAttribute('data-expanded-for', rowIndex);\r\n            expandedRow.innerHTML = `\r\n                <td colspan=\"${currentDrilldownColumns.length}\" class=\"px-4 py-2 bg-slate-50 border-t border-b border-slate-200\">\r\n                    <div class=\"pl-8\">\r\n                        <div class=\"text-xs font-semibold text-slate-600 mb-2\">Line Items for Order ${orderNum}${filterLabel}:</div>\r\n                        <table class=\"w-full text-xs\">\r\n                            <thead>\r\n                                <tr class=\"text-left text-slate-600\">\r\n                                    <th class=\"py-1\">Product #</th>\r\n                                    <th class=\"py-1\">Description</th>\r\n                                    <th class=\"py-1 text-right\">Qty</th>\r\n                                    <th class=\"py-1 text-right\">Unit Price</th>\r\n                                    <th class=\"py-1 text-right\">Line Total</th>\r\n                                    <th class=\"py-1 text-right\">Cost</th>\r\n                                    <th class=\"py-1 text-right\">Margin %</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                ${lineItems.map(item => {\r\n                                    const unitPrice = formatCurrencyCell(item.unit_price);\r\n                                    const lineTotal = formatCurrencyCell(item.line_total);\r\n                                    const cost = formatCurrencyCell(item.cost);\r\n                                    const margin = formatMarginCell(item.margin_percent, item.line_total);\r\n                                    return `\r\n                                    <tr class=\"border-t border-slate-200\">\r\n                                        <td class=\"py-1 text-slate-700\">${item.product_num || ''}</td>\r\n                                        <td class=\"py-1 text-slate-700\">${item.product_desc || ''}</td>\r\n                                        <td class=\"py-1 text-right text-slate-700\">${parseFloat(item.qty || 0).toLocaleString()}</td>\r\n                                        <td class=\"py-1 text-right ${unitPrice.colorClass}\">${unitPrice.value}</td>\r\n                                        <td class=\"py-1 text-right ${lineTotal.colorClass}\">${lineTotal.value}</td>\r\n                                        <td class=\"py-1 text-right ${cost.colorClass}\">${cost.value}</td>\r\n                                        <td class=\"py-1 text-right ${margin.colorClass}\">${margin.value}</td>\r\n                                    </tr>\r\n                                `}).join('')}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </td>\r\n            `;\r\n\r\n            targetRow.insertAdjacentElement('afterend', expandedRow);\r\n        }\r\n\r\n        function filterDrilldownTable() {\r\n            const searchValue = document.getElementById('drilldownSearch').value.toLowerCase();\r\n\r\n            const filteredData = currentDrilldownData.filter(row =>\r\n                currentDrilldownColumns.some(col =>\r\n                    String(row[col.key] || '').toLowerCase().includes(searchValue)\r\n                )\r\n            );\r\n\r\n            renderDrilldownTable(filteredData);\r\n        }\r\n\r\n        function sortDrilldownTable(columnIndex) {\r\n            const column = currentDrilldownColumns[columnIndex];\r\n\r\n            if (currentSortColumn === columnIndex) {\r\n                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';\r\n            } else {\r\n                currentSortColumn = columnIndex;\r\n                currentSortDirection = 'asc';\r\n            }\r\n\r\n            const sorted = [...currentDrilldownData].sort((a, b) => {\r\n                let aVal = a[column.key];\r\n                let bVal = b[column.key];\r\n\r\n                // Convert to numbers if applicable\r\n                if (column.type === 'currency' || column.type === 'number' || column.type === 'percent') {\r\n                    aVal = parseFloat(aVal || 0);\r\n                    bVal = parseFloat(bVal || 0);\r\n                } else if (column.type === 'date') {\r\n                    aVal = new Date(aVal);\r\n                    bVal = new Date(bVal);\r\n                }\r\n\r\n                if (currentSortDirection === 'asc') {\r\n                    return aVal > bVal ? 1 : -1;\r\n                } else {\r\n                    return aVal < bVal ? 1 : -1;\r\n                }\r\n            });\r\n\r\n            renderDrilldownTable(sorted);\r\n        }\r\n\r\n        function exportDrilldownData() {\r\n            const title = document.getElementById('drilldownTitle').textContent;\r\n            const headers = currentDrilldownColumns.map(col => col.label).join(',');\r\n            const rows = currentDrilldownData.map(row =>\r\n                currentDrilldownColumns.map(col => {\r\n                    let value = row[col.key] || '';\r\n                    // Escape commas and quotes\r\n                    if (String(value).includes(',') || String(value).includes('\"')) {\r\n                        value = '\"' + String(value).replace(/\"/g, '\"\"') + '\"';\r\n                    }\r\n                    return value;\r\n                }).join(',')\r\n            ).join('\\n');\r\n\r\n            const csv = headers + '\\n' + rows;\r\n            const blob = new Blob([csv], { type: 'text/csv' });\r\n            const url = URL.createObjectURL(blob);\r\n            const a = document.createElement('a');\r\n            a.href = url;\r\n            a.download = `${title.replace(/\\s+/g, '_')}_${moment().format('YYYY-MM-DD')}.csv`;\r\n            a.click();\r\n            URL.revokeObjectURL(url);\r\n        }\r\n\r\n        // ============================================\r\n        // Drill-down Data Functions\r\n        // ============================================\r\n        function drilldownManager(managerName) {\r\n            try {\r\n                debugLog(`Chart clicked: Sales by Manager - \"${managerName}\"`, 'click');\r\n                const conditions = buildFilterConditions();\r\n                const marginHaving = getMarginHavingClause('avg_margin');\r\n                debugLog('Building SQL query for manager customers...', 'info');\r\n                const query = `\r\n                SELECT\r\n                    Customer.Name as customer_name,\r\n                    COUNT(DISTINCT So.Num) as order_count,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                    SUM(PostSoItem.PostedTotalCost) as total_cost,\r\n                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin,\r\n                    MAX(PostSo.PostDate) as last_order_date\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN SoItem as PSI ON PSI.ParentId = SoItem.Id AND PSI.TypeId = 60\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                AND So.salesman = '${escapeSQL(managerName)}'\r\n                GROUP BY Customer.Name\r\n                ${marginHaving}\r\n                ORDER BY total_revenue DESC\r\n            `;\r\n\r\n            const queryResult = runQuery(query);\r\n            debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');\r\n\r\n            const data = queryResult ? JSON.parse(queryResult) : null;\r\n            if (!data || !Array.isArray(data)) {\r\n                debugLog('Query returned no data or invalid data', 'error');\r\n                alert('No data available for this selection. The query may have returned no results.');\r\n                return;\r\n            }\r\n            debugLog(`Query returned ${data.length} customers`, 'success');\r\n\r\n            const columns = [\r\n                { key: 'customer_name', label: 'Customer', type: 'string' },\r\n                { key: 'order_count', label: 'Orders', type: 'number' },\r\n                { key: 'total_revenue', label: 'Revenue', type: 'currency' },\r\n                { key: 'avg_margin', label: 'Avg Margin %', type: 'percent' },\r\n                { key: 'last_order_date', label: 'Last Order', type: 'date' }\r\n            ];\r\n\r\n                debugLog('Executing query...', 'info');\r\n                openDrilldown(\r\n                    `Customers for ${managerName}`,\r\n                    `Sales by Manager > ${managerName}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownManager: ${error.message}`, 'error');\r\n                debugLog(`Stack: ${error.stack}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownCustomer(customerName) {\r\n            try {\r\n                debugLog(`Chart clicked: Top Customers - \"${customerName}\"`, 'click');\r\n                const conditions = buildFilterConditions();\r\n                const marginHaving = getMarginHavingClause('margin_percent');\r\n                debugLog('Building SQL query for customer orders...', 'info');\r\n                const query = `\r\n                    SELECT\r\n                        So.Num as order_num,\r\n                        PostSo.PostDate as order_date,\r\n                        COUNT(DISTINCT SoItem.Id) as item_count,\r\n                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                        SUM(PostSoItem.PostedTotalCost) as total_cost,\r\n                        (SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost)) / NULLIF(SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty), 0) as margin_percent,\r\n                        So.salesman as salesman\r\n                    FROM PostSo\r\n                    JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                    JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                    JOIN So ON So.Id = SoItem.SoId\r\n                    LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                    LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                    LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                    LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                    LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                    ${conditions}\r\n                    AND Customer.Name = '${escapeSQL(customerName)}'\r\n                    GROUP BY So.Num, PostSo.PostDate, So.salesman\r\n                    ${marginHaving}\r\n                    ORDER BY PostSo.PostDate DESC\r\n                `;\r\n\r\n                debugLog('Executing query...', 'info');\r\n                console.log('SQL Query:', query);\r\n                debugLog(`SQL Query: ${query}`, 'info');\r\n                const queryResult = runQuery(query);\r\n                debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');\r\n\r\n                const data = queryResult ? JSON.parse(queryResult) : null;\r\n                if (!data || !Array.isArray(data)) {\r\n                    debugLog('Query returned no data or invalid data', 'error');\r\n                    debugLog(`Failed SQL: ${query}`, 'error');\r\n                    alert('No data available for this selection. The query may have returned no results.');\r\n                    return;\r\n                }\r\n                debugLog(`Query returned ${data.length} orders`, 'success');\r\n\r\n                const columns = [\r\n                    { key: 'order_num', label: 'Order #', type: 'string' },\r\n                    { key: 'order_date', label: 'Date', type: 'date' },\r\n                    { key: 'item_count', label: 'Items', type: 'number' },\r\n                    { key: 'total_revenue', label: 'Total', type: 'currency' },\r\n                    { key: 'margin_percent', label: 'Margin %', type: 'percent' },\r\n                    { key: 'salesman', label: 'Sales Person', type: 'string' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    `Orders for ${customerName}`,\r\n                    `Top Customers > ${customerName}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownCustomer: ${error.message}`, 'error');\r\n                debugLog(`Stack: ${error.stack}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownCategory(categoryName) {\r\n            try {\r\n                debugLog(`Chart clicked: Product Categories - \"${categoryName}\"`, 'click');\r\n                const conditions = buildFilterConditions();\r\n                const marginHaving = getMarginHavingClause('avg_margin');\r\n                debugLog('Building SQL query for category products...', 'info');\r\n\r\n                // Handle \"No Category\" specially - it represents null/blank categories\r\n                const categoryCondition = categoryName === 'No Category'\r\n                    ? `AND (ProductTree.Name IS NULL OR ProductTree.Name = '')`\r\n                    : `AND ProductTree.Name = '${escapeSQL(categoryName)}'`;\r\n\r\n                const query = `\r\n                SELECT\r\n                    Product.Num as product_num,\r\n                    Product.Description as product_name,\r\n                    SUM(PostSoItem.Qty) as units_sold,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                    AVG(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty)) as avg_price,\r\n                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                ${categoryCondition}\r\n                GROUP BY Product.Num, Product.Description\r\n                ${marginHaving}\r\n                ORDER BY total_revenue DESC\r\n            `;\r\n\r\n            debugLog('Executing query...', 'info');\r\n            console.log('SQL Query:', query);\r\n            debugLog(`SQL Query: ${query}`, 'info');\r\n            const queryResult = runQuery(query);\r\n            debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');\r\n\r\n            const data = queryResult ? JSON.parse(queryResult) : null;\r\n            if (!data || !Array.isArray(data)) {\r\n                debugLog('Query returned no data or invalid data', 'error');\r\n                debugLog(`Failed SQL: ${query}`, 'error');\r\n                alert('No data available for this selection. The query may have returned no results.');\r\n                return;\r\n            }\r\n            debugLog(`Query returned ${data.length} products`, 'success');\r\n\r\n            const columns = [\r\n                { key: 'product_num', label: 'Product #', type: 'string' },\r\n                { key: 'product_name', label: 'Product Name', type: 'string' },\r\n                { key: 'units_sold', label: 'Units Sold', type: 'number' },\r\n                { key: 'total_revenue', label: 'Revenue', type: 'currency' },\r\n                { key: 'avg_price', label: 'Avg Price', type: 'currency' },\r\n                { key: 'avg_margin', label: 'Avg Margin %', type: 'percent' }\r\n            ];\r\n\r\n                debugLog('Executing query...', 'info');\r\n                openDrilldown(\r\n                    `Products in ${categoryName}`,\r\n                    `Product Tree > ${categoryName}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownCategory: ${error.message}`, 'error');\r\n                debugLog(`Stack: ${error.stack}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownMonth(month) {\r\n            try {\r\n                debugLog(`Chart clicked: Monthly Sales - \"${moment(month).format('MMM YYYY')}\"`, 'click');\r\n                const conditions = buildFilterConditions();\r\n                const marginHaving = getMarginHavingClause('avg_margin');\r\n                debugLog('Building SQL query for month customers...', 'info');\r\n                const query = `\r\n                SELECT\r\n                    Customer.Name as customer_name,\r\n                    COUNT(DISTINCT So.Num) as order_count,\r\n                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin\r\n                FROM PostSo\r\n                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                JOIN So ON So.Id = SoItem.SoId\r\n                LEFT JOIN SoItem as PSI ON PSI.ParentId = SoItem.Id AND PSI.TypeId = 60\r\n                LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                ${conditions}\r\n                AND DATE_FORMAT(PostSo.PostDate, '%Y-%m-01') = '${escapeSQL(month)}'\r\n                GROUP BY Customer.Name\r\n                ${marginHaving}\r\n                ORDER BY total_revenue DESC\r\n                LIMIT 20\r\n            `;\r\n\r\n            const queryResult = runQuery(query);\r\n            debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');\r\n\r\n            const data = queryResult ? JSON.parse(queryResult) : null;\r\n            if (!data || !Array.isArray(data)) {\r\n                debugLog('Query returned no data or invalid data', 'error');\r\n                alert('No data available for this selection. The query may have returned no results.');\r\n                return;\r\n            }\r\n            debugLog(`Query returned ${data.length} customers`, 'success');\r\n\r\n            const columns = [\r\n                { key: 'customer_name', label: 'Customer', type: 'string' },\r\n                { key: 'order_count', label: 'Orders', type: 'number' },\r\n                { key: 'total_revenue', label: 'Revenue', type: 'currency' },\r\n                { key: 'avg_margin', label: 'Avg Margin %', type: 'percent' }\r\n            ];\r\n\r\n                debugLog('Executing query...', 'info');\r\n                openDrilldown(\r\n                    `Top Customers for ${moment(month).format('MMMM YYYY')}`,\r\n                    `Monthly Sales > ${moment(month).format('MMM YYYY')}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownMonth: ${error.message}`, 'error');\r\n                debugLog(`Stack: ${error.stack}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownSalesperson(salesmanId) {\r\n            try {\r\n                debugLog(`Chart clicked: Top Sales People - ID: ${salesmanId}`, 'click');\r\n\r\n                if (!salesmanId || isNaN(parseInt(salesmanId))) {\r\n                    debugLog(`ERROR: Invalid salesmanId: ${salesmanId}`, 'error');\r\n                    alert('Invalid salesperson ID. Cannot load drill-down.');\r\n                    return;\r\n                }\r\n\r\n                const conditions = buildFilterConditions();\r\n                const marginHaving = getMarginHavingClause('margin_percent');\r\n                debugLog('Building SQL query for salesperson orders...', 'info');\r\n                const query = `\r\n                    SELECT\r\n                        So.Num as order_num,\r\n                        PostSo.PostDate as order_date,\r\n                        Customer.Name as customer_name,\r\n                        COALESCE(NULLIF(TRIM(CONCAT(SalesUser.FirstName, ' ', SalesUser.LastName)), ''), SalesUser.userName) as salesman,\r\n                        COUNT(DISTINCT SoItem.Id) as item_count,\r\n                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                        SUM(PostSoItem.PostedTotalCost) as total_cost,\r\n                        (SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost)) / NULLIF(SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty), 0) as margin_percent\r\n                    FROM PostSo\r\n                    JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                    JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                    JOIN So ON So.Id = SoItem.SoId\r\n                    LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                    LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                    LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                    LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId\r\n                    LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                    JOIN SysUser AS SalesUser ON SalesUser.Id = So.salesmanId\r\n                    ${conditions}\r\n                    AND So.salesmanId = ${parseInt(salesmanId)}\r\n                    GROUP BY So.Num, PostSo.PostDate, Customer.Name, SalesUser.FirstName, SalesUser.LastName\r\n                    ${marginHaving}\r\n                    ORDER BY PostSo.PostDate DESC\r\n                `;\r\n\r\n                debugLog('Executing query...', 'info');\r\n                console.log('SQL Query:', query);\r\n                debugLog(`SQL Query: ${query}`, 'info');\r\n                const queryResult = runQuery(query);\r\n                debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');\r\n\r\n                const data = queryResult ? JSON.parse(queryResult) : null;\r\n                if (!data || !Array.isArray(data)) {\r\n                    debugLog('Query returned no data or invalid data', 'error');\r\n                    debugLog(`Failed SQL: ${query}`, 'error');\r\n                    alert('No data available for this selection. The query may have returned no results.');\r\n                    return;\r\n                }\r\n                debugLog(`Query returned ${data.length} orders`, 'success');\r\n\r\n                const salesmanName = data.length > 0 ? data[0].salesman : 'Salesperson';\r\n                const columns = [\r\n                    { key: 'order_num', label: 'Order #', type: 'string' },\r\n                    { key: 'order_date', label: 'Date', type: 'date' },\r\n                    { key: 'customer_name', label: 'Customer', type: 'string' },\r\n                    { key: 'item_count', label: 'Items', type: 'number' },\r\n                    { key: 'total_revenue', label: 'Total', type: 'currency' },\r\n                    { key: 'margin_percent', label: 'Margin %', type: 'percent' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    `Orders for ${salesmanName}`,\r\n                    `Top Sales People > ${salesmanName}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownSalesperson: ${error.message}`, 'error');\r\n                debugLog(`Stack: ${error.stack}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownCustomerGroup(groupName) {\r\n            try {\r\n                debugLog(`Chart clicked: Customer Groups - \"${groupName}\"`, 'click');\r\n                const conditions = buildFilterConditions();\r\n                const marginHaving = getMarginHavingClause('margin_percent');\r\n                debugLog('Building SQL query for customer group orders...', 'info');\r\n\r\n                // Handle \"No Group\" specially - it represents null/blank groups\r\n                const groupCondition = groupName === 'No Group'\r\n                    ? `AND (AccountGroup.Name IS NULL OR AccountGroup.Name = '')`\r\n                    : `AND AccountGroup.Name = '${escapeSQL(groupName)}'`;\r\n\r\n                const query = `\r\n                    SELECT\r\n                        So.Num as order_num,\r\n                        PostSo.PostDate as order_date,\r\n                        Customer.Name as customer_name,\r\n                        COUNT(DISTINCT SoItem.Id) as item_count,\r\n                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,\r\n                        SUM(PostSoItem.PostedTotalCost) as total_cost,\r\n                        (SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost)) / NULLIF(SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty), 0) as margin_percent,\r\n                        COALESCE(NULLIF(TRIM(CONCAT(SalesUser.FirstName, ' ', SalesUser.LastName)), ''), SalesUser.userName) as salesman\r\n                    FROM PostSo\r\n                    JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                    JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                    JOIN So ON So.Id = SoItem.SoId\r\n                    JOIN SysUser AS SalesUser ON SalesUser.Id = So.salesmanId\r\n                    LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                    LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                    LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                    LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                    ${conditions}\r\n                    ${groupCondition}\r\n                    GROUP BY So.Num, PostSo.PostDate, Customer.Name, SalesUser.FirstName, SalesUser.LastName\r\n                    ${marginHaving}\r\n                    ORDER BY PostSo.PostDate DESC\r\n                `;\r\n\r\n                debugLog('Executing query...', 'info');\r\n                console.log('SQL Query:', query);\r\n                debugLog(`SQL Query: ${query}`, 'info');\r\n                const queryResult = runQuery(query);\r\n                debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');\r\n\r\n                const data = queryResult ? JSON.parse(queryResult) : null;\r\n                if (!data || !Array.isArray(data)) {\r\n                    debugLog('Query returned no data or invalid data', 'error');\r\n                    debugLog(`Failed SQL: ${query}`, 'error');\r\n                    alert('No data available for this selection. The query may have returned no results.');\r\n                    return;\r\n                }\r\n                debugLog(`Query returned ${data.length} orders`, 'success');\r\n\r\n                const columns = [\r\n                    { key: 'order_num', label: 'Order #', type: 'string' },\r\n                    { key: 'order_date', label: 'Date', type: 'date' },\r\n                    { key: 'customer_name', label: 'Customer', type: 'string' },\r\n                    { key: 'item_count', label: 'Items', type: 'number' },\r\n                    { key: 'total_revenue', label: 'Total', type: 'currency' },\r\n                    { key: 'margin_percent', label: 'Margin %', type: 'percent' },\r\n                    { key: 'salesman', label: 'Sales Person', type: 'string' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    `Orders for ${groupName}`,\r\n                    `Customer Groups > ${groupName}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownCustomerGroup: ${error.message}`, 'error');\r\n                debugLog(`Stack: ${error.stack}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownProduct(productNum, productDesc) {\r\n            try {\r\n                debugLog(`Chart clicked: Top Products - \"${productNum} - ${productDesc}\"`, 'click');\r\n                const conditions = buildFilterConditions();\r\n                const marginHaving = getMarginHavingClause('margin_percent');\r\n                debugLog('Building SQL query for product orders...', 'info');\r\n                const query = `\r\n                    SELECT\r\n                        So.Num as order_num,\r\n                        PostSo.PostDate as order_date,\r\n                        Customer.Name as customer_name,\r\n                        SUM(PostSoItem.Qty) as qty,\r\n                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as line_total,\r\n                        AVG(((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)) as margin_percent,\r\n                        COALESCE(NULLIF(TRIM(CONCAT(SalesUser.FirstName, ' ', SalesUser.LastName)), ''), SalesUser.userName) as salesman\r\n                    FROM PostSo\r\n                    JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id\r\n                    JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId\r\n                    JOIN So ON So.Id = SoItem.SoId\r\n                    JOIN SysUser AS SalesUser ON SalesUser.Id = So.salesmanId\r\n                    LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id\r\n                    LEFT JOIN Product ON Product.Id = SoItem.ProductId\r\n                    LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)\r\n                    LEFT JOIN Customer ON Customer.Id = So.CustomerId\r\n                    LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)\r\n                    ${conditions}\r\n                    AND Product.Num = '${escapeSQL(productNum)}'\r\n                    AND SoItem.typeId NOT IN (30,40)\r\n                    GROUP BY So.Num, PostSo.PostDate, Customer.Name, SalesUser.FirstName, SalesUser.LastName\r\n                    ${marginHaving}\r\n                    ORDER BY PostSo.PostDate DESC\r\n                `;\r\n\r\n                debugLog('Executing query...', 'info');\r\n                console.log('SQL Query:', query);\r\n                debugLog(`SQL Query: ${query}`, 'info');\r\n                const queryResult = runQuery(query);\r\n                debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');\r\n\r\n                const data = queryResult ? JSON.parse(queryResult) : null;\r\n                if (!data || !Array.isArray(data)) {\r\n                    debugLog('Query returned no data or invalid data', 'error');\r\n                    debugLog(`Failed SQL: ${query}`, 'error');\r\n                    alert('No data available for this selection. The query may have returned no results.');\r\n                    return;\r\n                }\r\n                debugLog(`Query returned ${data.length} orders with this product`, 'success');\r\n\r\n                const columns = [\r\n                    { key: 'order_num', label: 'Order #', type: 'string' },\r\n                    { key: 'order_date', label: 'Date', type: 'date' },\r\n                    { key: 'customer_name', label: 'Customer', type: 'string' },\r\n                    { key: 'qty', label: 'Qty', type: 'number' },\r\n                    { key: 'line_total', label: 'Line Total', type: 'currency' },\r\n                    { key: 'margin_percent', label: 'Margin %', type: 'percent' },\r\n                    { key: 'salesman', label: 'Sales Person', type: 'string' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    `Orders containing ${productNum} - ${productDesc}`,\r\n                    `Top Products > ${productNum}`,\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownProduct: ${error.message}`, 'error');\r\n                debugLog(`Stack: ${error.stack}`, 'error');\r\n            }\r\n        }\r\n\r\n        // ============================================\r\n        // New Metrics Drill-down Functions\r\n        // ============================================\r\n\r\n        function drilldownLowMargin() {\r\n            try {\r\n                debugLog('Drill-down: Low Margin Sales', 'click');\r\n                const data = getLowMarginSales();\r\n\r\n                const columns = [\r\n                    { key: 'order_num', label: 'Order #' },\r\n                    { key: 'order_date', label: 'Date', format: (v) => moment(v).format('D MMM YYYY') },\r\n                    { key: 'customer_name', label: 'Customer' },\r\n                    { key: 'order_total', label: 'Total', format: (v) => formatCurrency(v) },\r\n                    { key: 'margin_percent', label: 'Margin %', format: (v) => (parseFloat(v) * 100).toFixed(1) + '%' },\r\n                    { key: 'salesman', label: 'Sales Person' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    'Low Margin Sales (< 15%)',\r\n                    'Low Margin Sales',\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownLowMargin: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownNegativeMargin() {\r\n            try {\r\n                debugLog('Drill-down: Negative Margin Orders', 'click');\r\n                const data = getNegativeMarginOrders();\r\n\r\n                const columns = [\r\n                    { key: 'order_num', label: 'Order #' },\r\n                    { key: 'order_date', label: 'Date', format: (v) => moment(v).format('D MMM YYYY') },\r\n                    { key: 'customer_name', label: 'Customer' },\r\n                    { key: 'order_total', label: 'Total', format: (v) => formatCurrency(v) },\r\n                    { key: 'margin_percent', label: 'Margin %', format: (v) => (parseFloat(v) * 100).toFixed(1) + '%' },\r\n                    { key: 'salesman', label: 'Sales Person' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    'Negative Margin Orders',\r\n                    'Negative Margin Orders',\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownNegativeMargin: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownHighValue() {\r\n            try {\r\n                debugLog('Drill-down: High Value Orders', 'click');\r\n                const data = getHighValueOrders();\r\n\r\n                const columns = [\r\n                    { key: 'order_num', label: 'Order #' },\r\n                    { key: 'order_date', label: 'Date', format: (v) => moment(v).format('D MMM YYYY') },\r\n                    { key: 'customer_name', label: 'Customer' },\r\n                    { key: 'order_total', label: 'Total', format: (v) => formatCurrency(v) },\r\n                    { key: 'margin_percent', label: 'Margin %', format: (v) => (parseFloat(v) * 100).toFixed(1) + '%' },\r\n                    { key: 'salesman', label: 'Sales Person' }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    'High Value Orders (> $10k)',\r\n                    'High Value Orders',\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownHighValue: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownNewRepeat(customerType) {\r\n            try {\r\n                debugLog(`Drill-down: ${customerType} Customers`, 'click');\r\n                const conditions = buildFilterConditions();\r\n                const { start, end } = getDateRange();\r\n\r\n                const query = `\r\n                    SELECT\r\n                        Customer.Id as customer_id,\r\n                        Customer.Name as customer_name,\r\n                        MIN(PostSo.PostDate) as first_order_date,\r\n                        COUNT(DISTINCT So.Id) as order_count,\r\n                        SUM(So.TotalPrice) as total_revenue,\r\n                        MAX(PostSo.PostDate) as last_order_date\r\n                    FROM PostSo\r\n                    JOIN So ON So.Id = PostSo.SoId\r\n                    JOIN Customer ON Customer.Id = So.CustomerId\r\n                    LEFT JOIN AccountGroup ON AccountGroup.Id = (\r\n                        SELECT AccountGroupRelation.GroupId\r\n                        FROM AccountGroupRelation\r\n                        WHERE AccountGroupRelation.AccountId = Customer.AccountId\r\n                        ORDER BY AccountGroupRelation.AccountId ASC\r\n                        LIMIT 1\r\n                    )\r\n                    ${conditions}\r\n                    GROUP BY Customer.Id, Customer.Name\r\n                `;\r\n\r\n                const customers = JSON.parse(runQuery(query));\r\n\r\n                if (!customers || !Array.isArray(customers)) {\r\n                    debugLog('No customer data returned for drill-down', 'warning');\r\n                    return;\r\n                }\r\n\r\n                // Filter by customer type\r\n                const filteredData = customers.filter(c => {\r\n                    const firstOrderDate = moment(c.first_order_date);\r\n                    const periodStart = moment(start);\r\n                    const isNew = firstOrderDate >= periodStart;\r\n                    return customerType === 'New' ? isNew : !isNew;\r\n                });\r\n\r\n                const columns = [\r\n                    { key: 'customer_name', label: 'Customer' },\r\n                    { key: 'first_order_date', label: 'First Order', format: (v) => moment(v).format('D MMM YYYY') },\r\n                    { key: 'last_order_date', label: 'Last Order', format: (v) => moment(v).format('D MMM YYYY') },\r\n                    { key: 'order_count', label: 'Orders' },\r\n                    { key: 'total_revenue', label: 'Revenue', format: (v) => formatCurrency(v) }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    `${customerType} Customers`,\r\n                    `New vs Repeat > ${customerType}`,\r\n                    filteredData,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownNewRepeat: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        function drilldownInactiveCustomers() {\r\n            try {\r\n                debugLog('Drill-down: Inactive Customers', 'click');\r\n                const data = getInactiveCustomers();\r\n\r\n                const columns = [\r\n                    { key: 'customer_name', label: 'Customer' },\r\n                    { key: 'last_order_date', label: 'Last Order', format: (v) => moment(v).format('D MMM YYYY') },\r\n                    { key: 'days_since_order', label: 'Days Inactive' },\r\n                    { key: 'total_orders', label: 'Total Orders' },\r\n                    { key: 'lifetime_revenue', label: 'Lifetime Revenue', format: (v) => formatCurrency(v) }\r\n                ];\r\n\r\n                openDrilldown(\r\n                    'Inactive Customers (90+ Days)',\r\n                    'Inactive Customers',\r\n                    data,\r\n                    columns\r\n                );\r\n            } catch (error) {\r\n                debugLog(`ERROR in drilldownInactiveCustomers: ${error.message}`, 'error');\r\n            }\r\n        }\r\n\r\n        // ============================================\r\n        // Data Loading and Refresh\r\n        // ============================================\r\n        function loadDashboard() {\r\n            debugLog('Loading dashboard data...', 'info');\r\n            debugLog(`Using currency symbol: ${CURRENCY_SYMBOL}`, 'info');\r\n\r\n            const loading = document.getElementById('loadingOverlay');\r\n            loading.style.display = 'flex';\r\n\r\n            try {\r\n                // Load KPIs\r\n                const kpiData = getKPIMetrics();\r\n                updateKPIs(kpiData);\r\n\r\n                // Load charts\r\n                const revenueData = getSalesRevenueOverTime();\r\n                renderRevenueChart(revenueData);\r\n\r\n                const customersData = getTopCustomers();\r\n                renderCustomersChart(customersData);\r\n\r\n                const categoryData = getSalesByCategory();\r\n                renderCategoryChart(categoryData);\r\n\r\n                const salespeopleData = getTopSalespeople();\r\n                renderSalespeopleChart(salespeopleData);\r\n\r\n                const groupData = getSalesByGroup();\r\n                renderGroupChart(groupData);\r\n\r\n                const productsData = getTopProducts();\r\n                renderProductsChart(productsData);\r\n\r\n                // Load new metrics\r\n                const lowMarginData = getLowMarginSales();\r\n                renderLowMarginChart(lowMarginData);\r\n\r\n                const negativeMarginData = getNegativeMarginOrders();\r\n                renderNegativeMarginChart(negativeMarginData);\r\n\r\n                const highValueData = getHighValueOrders();\r\n                renderHighValueChart(highValueData);\r\n\r\n                const aovData = getAverageOrderValue();\r\n                renderAverageOrderValue(aovData);\r\n\r\n                const newRepeatData = getNewVsRepeatCustomers();\r\n                renderNewVsRepeatChart(newRepeatData);\r\n\r\n                const topMarginCustomersData = getTopCustomersByMargin();\r\n                renderTopMarginCustomersChart(topMarginCustomersData);\r\n\r\n                const inactiveCustomersData = getInactiveCustomers();\r\n                renderInactiveCustomersChart(inactiveCustomersData);\r\n\r\n                const slowMovingData = getSlowMovingInventory();\r\n                renderSlowMovingChart(slowMovingData);\r\n\r\n                const ordersPerSalespersonData = getOrdersPerSalesperson();\r\n                renderOrdersPerSalespersonChart(ordersPerSalespersonData);\r\n\r\n                const avgDaysData = getAvgDaysToShip();\r\n                renderAvgDaysToShip(avgDaysData);\r\n\r\n            } catch (error) {\r\n                console.error('Error loading dashboard:', error);\r\n                alert('Error loading sales data. Please check console for details.');\r\n            } finally {\r\n                loading.style.display = 'none';\r\n                updateDateRangeDisplay();\r\n            }\r\n        }\r\n\r\n        function exportToCSV() {\r\n            try {\r\n                const kpiData = getKPIMetrics();\r\n                const customersData = getTopCustomers();\r\n                const productsData = getTopProducts();\r\n\r\n                // Build CSV header\r\n                let csv = 'Sales Dashboard Export - ' + moment().format('YYYY-MM-DD HH:mm:ss') + '\\n\\n';\r\n\r\n                // KPI Summary\r\n                csv += 'Key Metrics\\n';\r\n                csv += 'Metric,Value\\n';\r\n                if (kpiData && kpiData.length > 0) {\r\n                    const metrics = kpiData[0];\r\n                    csv += `Total Revenue,${formatCurrency(metrics.total_revenue || 0)}\\n`;\r\n                    csv += `Total Orders,${metrics.order_count || 0}\\n`;\r\n                    csv += `Average Order Value,${formatCurrency((parseFloat(metrics.total_revenue || 0) / (metrics.order_count || 1)))}\\n`;\r\n                    csv += `Average Margin,${(parseFloat(metrics.avg_margin || 0) * 100).toFixed(1)}%\\n`;\r\n                }\r\n\r\n                csv += '\\n\\nTop 10 Customers by Revenue\\n';\r\n                csv += 'Customer Name,Revenue,Orders,Average Margin\\n';\r\n                customersData.forEach(customer => {\r\n                    csv += `\"${(customer.customer_name || '').replace(/\"/g, '\"\"')}\",`;\r\n                    csv += `${parseFloat(customer.total_revenue).toFixed(2)},`;\r\n                    csv += `${customer.order_count},`;\r\n                    csv += `${(parseFloat(customer.avg_margin) * 100).toFixed(1)}%\\n`;\r\n                });\r\n\r\n                csv += '\\n\\nTop 10 Products by Quantity\\n';\r\n                csv += 'Product Number,Description,Quantity,Revenue\\n';\r\n                productsData.forEach(product => {\r\n                    csv += `\"${product.product_num}\",\"${(product.product_desc || '').replace(/\"/g, '\"\"')}\",`;\r\n                    csv += `${parseFloat(product.total_qty).toFixed(2)},`;\r\n                    csv += `${parseFloat(product.total_revenue).toFixed(2)}\\n`;\r\n                });\r\n\r\n                // Create download link\r\n                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\r\n                const link = document.createElement('a');\r\n                const url = URL.createObjectURL(blob);\r\n\r\n                link.setAttribute('href', url);\r\n                link.setAttribute('download', 'Sales_Dashboard_' + moment().format('YYYY-MM-DD_HHmmss') + '.csv');\r\n                link.style.visibility = 'hidden';\r\n\r\n                document.body.appendChild(link);\r\n                link.click();\r\n                document.body.removeChild(link);\r\n\r\n                console.log('CSV export completed successfully');\r\n            } catch (error) {\r\n                console.error('Error exporting CSV:', error);\r\n                alert('Error exporting CSV. Please check console for details.');\r\n            }\r\n        }\r\n\r\n        // ============================================\r\n        // Event Listeners\r\n        // ============================================\r\n        document.addEventListener('DOMContentLoaded', function() {\r\n            // Show debug console if DEBUG_MODE is enabled\r\n            if (DEBUG_MODE) {\r\n                document.getElementById('debugConsoleContainer').style.display = 'block';\r\n            }\r\n\r\n            debugLog('Sales Dashboard initialized', 'success');\r\n            debugLog('Click any chart element to drill down', 'info');\r\n\r\n            // Set default date range to Current Financial Year\r\n            const fyDates = getFYDates(0);\r\n            customStartDate = fyDates.start;\r\n            customEndDate = fyDates.end;\r\n            document.getElementById('dateRangeFilter').value = 'current_fy';\r\n            document.getElementById('customStartDate').value = fyDates.start;\r\n            document.getElementById('customEndDate').value = fyDates.end;\r\n\r\n            loadFilters();\r\n            loadDashboard();\r\n\r\n            // Window resize handler\r\n            let resizeTimeout;\r\n            window.addEventListener('resize', function() {\r\n                clearTimeout(resizeTimeout);\r\n                resizeTimeout = setTimeout(loadDashboard, 250);\r\n            });\r\n        });\r\n    </script>\r\n</body>\r\n</html>\r\n",
  "active" : true,
  "note" : "",
  "type" : "Page"
} ]