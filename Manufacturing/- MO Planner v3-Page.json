[ {
  "name" : "- MO Planner v3",
  "description" : "MO Planner v3",
  "data" : "<!DOCTYPE html>\r\n<!--\r\n    Commit: 4b821c8b5f1c9e2a7d4f8c3b6e9a5d2f1c8b7a4e\r\n    Updated: 2026-01-16 13:19:45 AEDT (UTC+10)\r\n    Changes: Lighter arrows (hover to highlight), reduced row spacing (25px), MO tooltips with details\r\n-->\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Manufacturing Capacity Planning (beta)</title>\r\n\r\n    <!-- Tailwind CSS -->\r\n    <script src=\"https://cdn.tailwindcss.com\"></script>\r\n\r\n    <!-- D3.js -->\r\n    <script src=\"https://d3js.org/d3.v7.min.js\"></script>\r\n\r\n    <!-- Moment.js -->\r\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js\"></script>\r\n\r\n    <!-- Google Fonts -->\r\n    <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap\" rel=\"stylesheet\">\r\n\r\n    <style>\r\n        html, body {\r\n            height: 100%;\r\n            margin: 0;\r\n            padding: 0;\r\n            overflow: hidden;\r\n            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\r\n        }\r\n\r\n        /* Custom Brand Colors */\r\n        :root {\r\n            --color-primary: #2d9cdb;\r\n            --color-primary-dark: #1e7bb4;\r\n            --color-sidebar: #06162d;\r\n            --color-sidebar-hover: #0a1f3d;\r\n        }\r\n\r\n        /* Custom Scrollbar */\r\n        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }\r\n        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }\r\n        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }\r\n\r\n        /* Override Tailwind indigo with custom blue */\r\n        .bg-indigo-600 { background-color: var(--color-primary) !important; }\r\n        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }\r\n        .text-indigo-600 { color: var(--color-primary) !important; }\r\n        .text-indigo-700 { color: var(--color-primary-dark) !important; }\r\n        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }\r\n        .hover\\:text-indigo-600:hover { color: var(--color-primary) !important; }\r\n        .hover\\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }\r\n        .focus\\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }\r\n        .shadow-indigo-900\\/20 { box-shadow: 0 10px 15px -3px rgba(45, 156, 219, 0.2) !important; }\r\n\r\n        /* Sidebar colors */\r\n        .bg-slate-900 { background-color: var(--color-sidebar) !important; }\r\n        .bg-slate-800 { background-color: var(--color-sidebar-hover) !important; }\r\n\r\n        /* Gantt Chart Styles */\r\n        .wo-bar {\r\n            cursor: move;\r\n            transition: opacity 0.2s ease;\r\n        }\r\n        .wo-bar:hover { opacity: 0.9; }\r\n        .wo-bar.dragging { opacity: 0.6; }\r\n\r\n        .dependency-arrow { pointer-events: none; }\r\n        .dependency-arrow.conflict { stroke: #ef4444; }\r\n\r\n        /* Capacity Table */\r\n        .capacity-table-wrapper {\r\n            cursor: grab;\r\n            user-select: none;\r\n        }\r\n        .capacity-table-wrapper:active { cursor: grabbing; }\r\n\r\n        .capacity-wo-bar {\r\n            cursor: move;\r\n            transition: transform 0.2s;\r\n        }\r\n        .capacity-wo-bar:hover {\r\n            transform: translateY(-2px);\r\n        }\r\n\r\n        /* Toast Container */\r\n        .toast-container {\r\n            position: fixed;\r\n            bottom: 1rem;\r\n            right: 1rem;\r\n            z-index: 9999;\r\n            display: flex;\r\n            flex-direction: column;\r\n            gap: 0.5rem;\r\n        }\r\n\r\n        .toast {\r\n            min-width: 300px;\r\n            padding: 1rem;\r\n            background: white;\r\n            border-radius: 0.75rem;\r\n            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);\r\n            border-left: 4px solid;\r\n            animation: slideIn 0.3s ease-out;\r\n        }\r\n\r\n        @keyframes slideIn {\r\n            from { transform: translateX(400px); opacity: 0; }\r\n            to { transform: translateX(0); opacity: 1; }\r\n        }\r\n\r\n        .toast.success { border-color: #10b981; }\r\n        .toast.error { border-color: #ef4444; }\r\n        .toast.info { border-color: #6366f1; }\r\n\r\n        /* Modal/Offcanvas */\r\n        .modal-overlay {\r\n            position: fixed;\r\n            inset: 0;\r\n            background: rgba(0, 0, 0, 0.5);\r\n            z-index: 9998;\r\n            display: none;\r\n            backdrop-filter: blur(4px);\r\n        }\r\n\r\n        .modal-overlay.show { display: block; }\r\n\r\n        .offcanvas {\r\n            position: fixed;\r\n            top: 0;\r\n            right: -500px;\r\n            width: 500px;\r\n            height: 100%;\r\n            background: white;\r\n            z-index: 9999;\r\n            transition: right 0.3s ease-out;\r\n            box-shadow: -10px 0 25px rgba(0, 0, 0, 0.1);\r\n        }\r\n\r\n        .offcanvas.show { right: 0; }\r\n\r\n        /* Loading Spinner */\r\n        .spinner {\r\n            border: 3px solid #e2e8f0;\r\n            border-top-color: #6366f1;\r\n            border-radius: 50%;\r\n            width: 40px;\r\n            height: 40px;\r\n            animation: spin 1s linear infinite;\r\n        }\r\n\r\n        @keyframes spin {\r\n            to { transform: rotate(360deg); }\r\n        }\r\n\r\n        /* Sidebar transition */\r\n        .sidebar-collapsed { width: 5rem; }\r\n        .sidebar-expanded { width: 16rem; }\r\n\r\n        /* Custom Tooltips */\r\n        .wo-tooltip {\r\n            position: absolute;\r\n            background: rgba(15, 23, 42, 0.95);\r\n            color: white;\r\n            padding: 0.75rem;\r\n            border-radius: 0.5rem;\r\n            font-size: 0.75rem;\r\n            line-height: 1.5;\r\n            pointer-events: none;\r\n            z-index: 10000;\r\n            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);\r\n            opacity: 0;\r\n            transition: opacity 0.2s ease;\r\n            max-width: 300px;\r\n            white-space: pre-line;\r\n        }\r\n        .wo-tooltip.show { opacity: 1; }\r\n        .wo-tooltip-label {\r\n            font-weight: 600;\r\n            color: #94a3b8;\r\n            margin-right: 0.5rem;\r\n        }\r\n        .wo-tooltip-value {\r\n            color: #ffffff;\r\n        }\r\n    </style>\r\n</head>\r\n<body class=\"bg-slate-50\">\r\n    <!-- Toast Container -->\r\n    <div class=\"toast-container\"></div>\r\n\r\n    <!-- Tooltip Container -->\r\n    <div id=\"woTooltip\" class=\"wo-tooltip\"></div>\r\n\r\n    <!-- Modal Overlay -->\r\n    <div class=\"modal-overlay\" id=\"modalOverlay\"></div>\r\n\r\n    <!-- Settings Offcanvas -->\r\n    <div class=\"offcanvas custom-scrollbar\" id=\"settingsOffcanvas\">\r\n        <div class=\"h-full flex flex-col\">\r\n            <div class=\"flex items-center justify-between p-6 border-b border-slate-200\">\r\n                <h2 class=\"text-xl font-bold text-slate-800\">Settings</h2>\r\n                <button onclick=\"closeOffcanvas('settingsOffcanvas')\" class=\"p-2 hover:bg-slate-100 rounded-lg transition-colors\">\r\n                    <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                    </svg>\r\n                </button>\r\n            </div>\r\n            <div class=\"flex-1 overflow-y-auto p-6 space-y-6\">\r\n                <div class=\"space-y-4\">\r\n                    <h3 class=\"text-sm font-bold text-slate-700 uppercase tracking-wider\">Schedule Options</h3>\r\n                    <label class=\"flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors\">\r\n                        <div>\r\n                            <div class=\"text-sm font-medium text-slate-700\">Allow Same-Day Dependency Starts</div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Allow multiple WOs in the same MO to start on the same day</div>\r\n                        </div>\r\n                        <input type=\"checkbox\" id=\"sameDayStartsToggle\" class=\"w-5 h-5 flex-shrink-0 text-indigo-600 rounded\">\r\n                    </label>\r\n                    <label class=\"flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors\">\r\n                        <div>\r\n                            <div class=\"text-sm font-medium text-slate-700\">Shift Dependent WOs on Drag</div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">When dragging a WO in Gantt view, automatically shift its dependent WOs by the same amount</div>\r\n                        </div>\r\n                        <input type=\"checkbox\" id=\"shiftDependentWOsToggle\" class=\"w-5 h-5 flex-shrink-0 text-indigo-600 rounded\">\r\n                    </label>\r\n                    <label class=\"flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors\">\r\n                        <div>\r\n                            <div class=\"text-sm font-medium text-slate-700\">Skip Weekends When Scheduling</div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">When dragging or resizing WOs, automatically skip weekends to land on weekdays</div>\r\n                        </div>\r\n                        <input type=\"checkbox\" id=\"skipWeekendsToggle\" class=\"w-5 h-5 flex-shrink-0 text-indigo-600 rounded\">\r\n                    </label>\r\n                </div>\r\n\r\n                <div class=\"space-y-4\">\r\n                    <h3 class=\"text-sm font-bold text-slate-700 uppercase tracking-wider\">Display</h3>\r\n                    <label class=\"flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors\">\r\n                        <span class=\"text-sm font-medium text-slate-700\">Show Dependency Arrows</span>\r\n                        <input type=\"checkbox\" id=\"showArrowsToggle\" checked class=\"w-5 h-5 flex-shrink-0 text-indigo-600 rounded\">\r\n                    </label>\r\n                    <label class=\"flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors\">\r\n                        <div>\r\n                            <div class=\"text-sm font-medium text-slate-700\">Show Completed WOs</div>\r\n                            <div class=\"text-xs text-slate-500 mt-1\">Display completed work orders in Capacity Planning and Calendar views</div>\r\n                        </div>\r\n                        <input type=\"checkbox\" id=\"showCompletedWOsToggle\" checked class=\"w-5 h-5 flex-shrink-0 text-indigo-600 rounded\">\r\n                    </label>\r\n                    <div class=\"p-4 bg-slate-50 rounded-xl\">\r\n                        <label class=\"block text-sm font-medium text-slate-700 mb-2\">Date Format</label>\r\n                        <select id=\"dateFormatSelect\" class=\"w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500\">\r\n                            <option value=\"DD/MM/YYYY\">DD/MM/YYYY</option>\r\n                            <option value=\"MM/DD/YYYY\">MM/DD/YYYY</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Instructions Offcanvas -->\r\n    <div class=\"offcanvas custom-scrollbar\" id=\"instructionsOffcanvas\">\r\n        <div class=\"h-full flex flex-col\">\r\n            <div class=\"flex items-center justify-between p-6 border-b border-slate-200\">\r\n                <h2 class=\"text-xl font-bold text-slate-800\">Instructions</h2>\r\n                <button onclick=\"closeOffcanvas('instructionsOffcanvas')\" class=\"p-2 hover:bg-slate-100 rounded-lg transition-colors\">\r\n                    <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                    </svg>\r\n                </button>\r\n            </div>\r\n            <div class=\"flex-1 overflow-y-auto p-6 space-y-6\">\r\n                <div class=\"space-y-3\">\r\n                    <h3 class=\"text-sm font-bold text-slate-700 uppercase tracking-wider\">About This Tool</h3>\r\n                    <p class=\"text-sm text-slate-600 leading-relaxed\">Manufacturing Capacity Planning (beta) provides three interactive views for visualizing and managing work order schedules:</p>\r\n                    <ul class=\"text-sm text-slate-600 space-y-2 ml-4\">\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>MO Gantt View:</strong> Groups work orders by Manufacturing Order</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Category View:</strong> Groups work orders by manufacturing category (swim lanes)</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Capacity Planning:</strong> Weekly calendar view with drag-and-drop scheduling and capacity tracking</span>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n\r\n                <div class=\"space-y-3\">\r\n                    <h3 class=\"text-sm font-bold text-slate-700 uppercase tracking-wider\">MO Gantt & Category Views</h3>\r\n                    <ul class=\"text-sm text-slate-600 space-y-2 ml-4\">\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Drag WO:</strong> Click and drag work order bars to reschedule (auto-scrolls to updated WO)</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Resize WO:</strong> Drag left/right edge to adjust dates</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Navigate:</strong> Scroll or drag the timeline, use prev/next week buttons</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Zoom:</strong> Use zoom buttons (persists across sessions)</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Collapse MOs:</strong> Double-click MO header to collapse/expand (MO view only)</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Undo/Redo:</strong> Use toolbar buttons (50-step history)</span>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n\r\n                <div class=\"space-y-3\">\r\n                    <h3 class=\"text-sm font-bold text-slate-700 uppercase tracking-wider\">Capacity Planning View</h3>\r\n                    <ul class=\"text-sm text-slate-600 space-y-2 ml-4\">\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Weekly View:</strong> Drag WOs horizontally (change dates) or vertically (change categories)</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Monthly Calendar:</strong> Drag WOs to reschedule across days, navigate with month buttons or Today</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Category Sorting:</strong> Categories are sorted alphabetically by name</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Navigate:</strong> Use prev/next week buttons or Today button to jump to current week</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Capacity Settings:</strong> Click gear icon to set daily labor hours per category (auto-saves)</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Color Coding:</strong> Green = under capacity, Orange = at capacity, Red = over capacity</span>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n\r\n                <div class=\"space-y-3\">\r\n                    <h3 class=\"text-sm font-bold text-slate-700 uppercase tracking-wider\">Search & Filter</h3>\r\n                    <ul class=\"text-sm text-slate-600 space-y-2 ml-4\">\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Global Search:</strong> Searches WO numbers, MO numbers, part numbers, categories, and descriptions</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>MO Filter:</strong> Filter by specific Manufacturing Order (MO view only)</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Works Across Views:</strong> Search results apply to all views (gantt and capacity)</span>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n\r\n                <div class=\"space-y-3\">\r\n                    <h3 class=\"text-sm font-bold text-slate-700 uppercase tracking-wider\">Settings & Preferences</h3>\r\n                    <ul class=\"text-sm text-slate-600 space-y-2 ml-4\">\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Auto-Save:</strong> All settings automatically save to database and persist across sessions</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Same-Day Starts:</strong> Allow/prevent multiple WOs in same MO from starting on same day</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Show Arrows:</strong> Toggle dependency arrows between WOs in same MO</span>\r\n                        </li>\r\n                        <li class=\"flex items-start gap-2\">\r\n                            <span class=\"text-indigo-600 mt-1\">•</span>\r\n                            <span><strong>Persisted Settings:</strong> Zoom level, collapsed MOs, calendar state, capacity limits</span>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <!-- Main Layout -->\r\n    <div class=\"h-screen flex overflow-hidden\">\r\n        <!-- Main Content -->\r\n        <main class=\"flex-1 flex flex-col min-w-0 h-screen overflow-hidden bg-slate-50\">\r\n            <!-- Header -->\r\n            <header class=\"h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm\">\r\n                <div class=\"flex items-center gap-6 flex-1\">\r\n                    <!-- View Switcher -->\r\n                    <div class=\"flex items-center gap-2 bg-slate-100 p-1 rounded-lg\">\r\n                        <button id=\"view-btn-mo\" onclick=\"switchView('mo')\" class=\"p-2 rounded-md transition-all bg-white text-indigo-600 shadow-sm\" title=\"MO Gantt View\">\r\n                            <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\"></path>\r\n                            </svg>\r\n                        </button>\r\n                        <button id=\"view-btn-capacity\" onclick=\"switchView('capacity')\" class=\"p-2 rounded-md transition-all text-slate-400 hover:text-slate-600\" title=\"Capacity Planning\">\r\n                            <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\"></path>\r\n                            </svg>\r\n                        </button>\r\n                    </div>\r\n                    <h2 id=\"viewTitle\" class=\"text-xl font-bold text-slate-800 hidden md:block\">Gantt View</h2>\r\n                    <div class=\"h-6 w-px bg-slate-200 hidden md:block\"></div>\r\n                    <!-- KPI Cards -->\r\n                    <div id=\"kpiCards\" class=\"hidden lg:flex items-center gap-2 flex-1\">\r\n                        <!-- Will be populated dynamically -->\r\n                    </div>\r\n                    <div class=\"relative flex-shrink min-w-[200px] max-w-sm group\">\r\n                        <svg class=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\"></path>\r\n                        </svg>\r\n                        <input\r\n                            type=\"text\"\r\n                            id=\"searchInput\"\r\n                            placeholder=\"Search work orders...\"\r\n                            class=\"w-full bg-slate-50 border border-slate-300 rounded-xl py-2.5 pl-10 pr-4 text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n                <div class=\"flex items-center gap-3\">\r\n                    <button onclick=\"openOffcanvas('settingsOffcanvas')\" class=\"p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all\" title=\"Settings\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\"></path>\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\"></path>\r\n                        </svg>\r\n                    </button>\r\n                    <button onclick=\"openOffcanvas('instructionsOffcanvas')\" class=\"p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all\" title=\"Instructions\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253\"></path>\r\n                        </svg>\r\n                    </button>\r\n                    <button onclick=\"loadWorkOrders()\" id=\"refreshBtn\" class=\"p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all\" title=\"Refresh Data\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\"></path>\r\n                        </svg>\r\n                    </button>\r\n                </div>\r\n            </header>\r\n\r\n            <!-- Content Area -->\r\n            <div class=\"flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8\">\r\n                <!-- Gantt/Category View Container -->\r\n                <div id=\"ganttContainer\" class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                    <div class=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6\">\r\n                        <h3 class=\"text-lg font-bold text-slate-800 flex items-center gap-2\">\r\n                            <svg class=\"w-5 h-5 text-indigo-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\"></path>\r\n                            </svg>\r\n                            <span id=\"ganttTitle\">Production Schedule</span>\r\n                        </h3>\r\n\r\n                        <div class=\"flex items-center gap-2\">\r\n                            <!-- Status Filter (Multi-select) -->\r\n                            <div class=\"relative\">\r\n                                <button id=\"statusFilterButton\" class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200 hover:bg-white text-xs font-semibold text-slate-600\">\r\n                                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\"></path>\r\n                                    </svg>\r\n                                    <span id=\"statusFilterLabel\">All Status</span>\r\n                                    <svg class=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 9l-7 7-7-7\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                                <div id=\"statusFilterDropdown\" class=\"hidden absolute z-50 mt-1 bg-white rounded-lg shadow-lg border border-slate-300 py-2 min-w-[160px]\">\r\n                                    <label class=\"flex items-center gap-2 px-3 py-1.5 hover:bg-slate-50 cursor-pointer\">\r\n                                        <input type=\"checkbox\" class=\"status-filter-checkbox\" value=\"10\" checked>\r\n                                        <span class=\"text-xs text-slate-700\">Entered</span>\r\n                                    </label>\r\n                                    <label class=\"flex items-center gap-2 px-3 py-1.5 hover:bg-slate-50 cursor-pointer\">\r\n                                        <input type=\"checkbox\" class=\"status-filter-checkbox\" value=\"30\" checked>\r\n                                        <span class=\"text-xs text-slate-700\">Started</span>\r\n                                    </label>\r\n                                    <label class=\"flex items-center gap-2 px-3 py-1.5 hover:bg-slate-50 cursor-pointer\">\r\n                                        <input type=\"checkbox\" class=\"status-filter-checkbox\" value=\"40\" checked>\r\n                                        <span class=\"text-xs text-slate-700\">Fulfilled</span>\r\n                                    </label>\r\n                                    <label class=\"flex items-center gap-2 px-3 py-1.5 hover:bg-slate-50 cursor-pointer\">\r\n                                        <input type=\"checkbox\" class=\"status-filter-checkbox\" value=\"conflict\" checked>\r\n                                        <span class=\"text-xs text-slate-700\">Conflicts</span>\r\n                                    </label>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <!-- Date Navigation -->\r\n                            <div class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200\">\r\n                                <button onclick=\"prevWeek()\" class=\"p-1 hover:bg-white rounded transition-colors text-slate-600\" title=\"Previous Week\">\r\n                                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                                <button onclick=\"goToToday()\" class=\"px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600\" title=\"Go to Today\">\r\n                                    Today\r\n                                </button>\r\n                                <button onclick=\"nextWeek()\" class=\"p-1 hover:bg-white rounded transition-colors text-slate-600\" title=\"Next Week\">\r\n                                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                            </div>\r\n\r\n                            <!-- Time Range -->\r\n                            <div class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200\">\r\n                                <button onclick=\"setTimeRange(7)\" class=\"px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600\" title=\"Show 1 Week\">1W</button>\r\n                                <button onclick=\"setTimeRange(14)\" class=\"px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600\" title=\"Show 2 Weeks\">2W</button>\r\n                                <button onclick=\"setTimeRange(30)\" class=\"px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600\" title=\"Show 1 Month\">1M</button>\r\n                                <button onclick=\"setTimeRange(90)\" class=\"px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600\" title=\"Show 3 Months\">3M</button>\r\n                            </div>\r\n\r\n                            <!-- Zoom Controls -->\r\n                            <div class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200\">\r\n                                <button onclick=\"zoomOut()\" class=\"p-1 hover:bg-white rounded transition-colors text-slate-600\" title=\"Zoom Out\">\r\n                                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                                <button onclick=\"zoomIn()\" class=\"p-1 hover:bg-white rounded transition-colors text-slate-600\" title=\"Zoom In\">\r\n                                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                            </div>\r\n\r\n                            <!-- Toggle Buttons -->\r\n                            <div class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200\">\r\n                                <button id=\"toggleArrowsBtn\" onclick=\"toggleArrows()\" class=\"p-1 hover:bg-white rounded transition-colors\" title=\"Show/Hide Dependency Arrows\">\r\n                                    <svg class=\"w-4 h-4 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 7l5 5m0 0l-5 5m5-5H6\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                            </div>\r\n\r\n                            <!-- Undo/Redo -->\r\n                            <div class=\"flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200\">\r\n                                <button id=\"undoBtn\" onclick=\"undo()\" disabled class=\"p-1 hover:bg-white rounded transition-colors text-slate-600 disabled:opacity-30 disabled:cursor-not-allowed\" title=\"Undo\">\r\n                                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                                <button id=\"redoBtn\" onclick=\"redo()\" disabled class=\"p-1 hover:bg-white rounded transition-colors text-slate-600 disabled:opacity-30 disabled:cursor-not-allowed\" title=\"Redo\">\r\n                                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M21 10h-10a8 8 0 00-8 8v2m18-10l-6-6m6 6l-6 6\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <!-- Gantt Chart SVG -->\r\n                    <div id=\"ganttWrapper\" class=\"overflow-auto custom-scrollbar\" style=\"max-height: 800px; position: relative;\">\r\n                        <svg id=\"ganttSvg\"></svg>\r\n                        <!-- Sticky category labels overlay (category view only) -->\r\n                        <div id=\"categoryLabelsOverlay\" style=\"position: absolute; top: 0; left: 0; width: 185px; display: none; background: #f8fafc; z-index: 100;\">\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Capacity Planning View Container -->\r\n                <div id=\"capacityContainer\" style=\"display: none;\">\r\n                    <!-- Monthly Calendar View - Always Visible -->\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 mb-4 p-6\">\r\n                        <div class=\"flex items-center justify-between mb-4\">\r\n                            <div class=\"flex items-center gap-2\">\r\n                                <svg class=\"w-5 h-5 text-slate-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\"></path>\r\n                                </svg>\r\n                                <h3 class=\"text-lg font-bold text-slate-800\">Monthly Calendar</h3>\r\n                                <span id=\"calendarMonthDisplay\" class=\"text-sm font-semibold text-slate-600 ml-2\"></span>\r\n                            </div>\r\n                            <div class=\"flex items-center gap-2\">\r\n                                <button onclick=\"changeCalendarMonth(-1)\" class=\"px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors\">\r\n                                    <svg class=\"w-4 h-4 inline mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M11 19l-7-7 7-7m8 14l-7-7 7-7\"></path>\r\n                                    </svg>\r\n                                    Month\r\n                                </button>\r\n                                <button onclick=\"goToCalendarToday()\" class=\"px-3 py-2 bg-indigo-50 hover:bg-indigo-100 border border-indigo-300 rounded-lg text-sm font-semibold text-indigo-700 transition-colors\">\r\n                                    Today\r\n                                </button>\r\n                                <button onclick=\"changeCalendarMonth(1)\" class=\"px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors\">\r\n                                    Month\r\n                                    <svg class=\"w-4 h-4 inline ml-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 5l7 7-7 7M5 5l7 7-7 7\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                                <div class=\"ml-2 border-l border-slate-300 pl-2\">\r\n                                    <select id=\"calendarColorModeSelect\" onchange=\"toggleCalendarColorMode()\" class=\"px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500\">\r\n                                        <option value=\"status\">Color by Status</option>\r\n                                        <option value=\"category\">Color by Category</option>\r\n                                    </select>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        <div id=\"monthCalendar\" class=\"relative\" style=\"min-height: 400px; margin-left: 82px;\">\r\n                            <!-- Calendar will be rendered here (inset to align with capacity planning days) -->\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"bg-white rounded-2xl shadow-md border border-slate-300 p-6\">\r\n                        <div class=\"flex items-center justify-between mb-4\">\r\n                            <h3 class=\"text-lg font-bold text-slate-800\">Weekly Capacity Planning</h3>\r\n                            <div class=\"flex items-center gap-2\">\r\n                                <button onclick=\"openCapacitySettingsModal()\" class=\"px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors\" title=\"Capacity Settings\">\r\n                                    <svg class=\"w-4 h-4 inline mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\"></path>\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\"></path>\r\n                                    </svg>\r\n                                    Settings\r\n                                </button>\r\n                                <button onclick=\"changeCapacityWeek(-1)\" class=\"px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors\">\r\n                                    <svg class=\"w-4 h-4 inline mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M11 19l-7-7 7-7m8 14l-7-7 7-7\"></path>\r\n                                    </svg>\r\n                                    Week\r\n                                </button>\r\n                                <button onclick=\"goToCapacityToday()\" class=\"px-3 py-2 bg-indigo-50 hover:bg-indigo-100 border border-indigo-300 rounded-lg text-sm font-semibold text-indigo-700 transition-colors\">\r\n                                    Today\r\n                                </button>\r\n                                <span id=\"capacityWeekDisplay\" class=\"text-sm font-semibold text-slate-600 px-4\"></span>\r\n                                <button onclick=\"changeCapacityWeek(1)\" class=\"px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors\">\r\n                                    Week\r\n                                    <svg class=\"w-4 h-4 inline ml-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 5l7 7-7 7M5 5l7 7-7 7\"></path>\r\n                                    </svg>\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class=\"capacity-table-wrapper overflow-auto custom-scrollbar\" style=\"max-height: 800px;\">\r\n                            <table id=\"capacityTable\" class=\"w-full border-collapse\">\r\n                                <!-- Will be populated dynamically -->\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Debug Console -->\r\n                <div class=\"bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden\">\r\n                    <button onclick=\"toggleDebugConsole()\" class=\"w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors\">\r\n                        <div class=\"flex items-center gap-2\">\r\n                            <svg class=\"w-4 h-4 text-slate-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4\"></path>\r\n                            </svg>\r\n                            <span class=\"text-sm font-semibold text-slate-700\">Debug Console</span>\r\n                            <span class=\"text-xs text-slate-400 font-normal\">Auto-scrolls to latest entry</span>\r\n                        </div>\r\n                        <svg id=\"debugChevron\" class=\"w-5 h-5 text-slate-400 transition-transform rotate-180\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 9l-7 7-7-7\"></path>\r\n                        </svg>\r\n                    </button>\r\n\r\n                    <div id=\"debugContent\" class=\"border-t border-slate-200\">\r\n                        <div class=\"bg-slate-900 px-4 py-2 flex items-center justify-between\">\r\n                            <span class=\"text-xs text-slate-400 font-mono\">Fishbowl Connection Diagnostics</span>\r\n                            <button onclick=\"clearDebugLog()\" class=\"text-xs text-slate-400 hover:text-white transition-colors\">\r\n                                Clear\r\n                            </button>\r\n                        </div>\r\n                        <div id=\"debugLog\" class=\"bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto custom-scrollbar\">\r\n                            <div class=\"text-slate-500 italic\">Waiting for application to initialize...</div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </main>\r\n    </div>\r\n\r\n<script>\r\n// ============================================\r\n// GLOBAL VARIABLES\r\n// ============================================\r\nlet allWorkOrders = [];\r\nlet filteredWorkOrders = [];\r\nlet manufacturingOrders = [];\r\nlet categories = [];\r\nlet stagingDependencies = [];\r\nlet conflicts = new Set();\r\n\r\nlet viewMode = 'mo'; // 'mo', 'category', 'capacity'\r\nlet currentCapacityWeek = null;\r\nlet capacitySettings = { categories: [] };\r\nlet collapsedMOs = new Set(); // Track which MOs are collapsed in MO view\r\n\r\n// Undo/Redo\r\nlet undoStack = [];\r\nlet redoStack = [];\r\nconst MAX_UNDO_STACK = 50;\r\n\r\n// D3 Gantt Settings\r\nlet ganttScale = 80; // pixels per day\r\nlet ganttStartDate = null; // Will be initialized in DOMContentLoaded\r\nlet ganttEndDate = null; // Will be initialized in DOMContentLoaded\r\n\r\n// Settings\r\nlet allowSameDayStarts = false;\r\nlet shiftDependentWOs = false; // When dragging a WO in gantt view, shift dependent WOs relatively\r\nlet skipWeekends = false; // When dragging/resizing WOs in gantt view, skip weekends to land on weekdays\r\nlet showArrows = true;\r\nlet dateFormat = 'DD/MM/YYYY'; // 'DD/MM/YYYY' or 'MM/DD/YYYY'\r\nlet calendarColorMode = 'status'; // 'status' or 'category'\r\nlet showCompletedWOs = true; // Show completed WOs in capacity planning and calendar views\r\nlet scrollToDateAfterRender = null; // Used to scroll to a specific date after render completes\r\nlet activeStatusFilters = new Set(['10', '30', '40', 'conflict']); // Track current status filters (multi-select)\r\n\r\n// Debug Console\r\nlet debugLogInitialized = false;\r\n\r\n// Standard WO Status Colors - used across all views for consistency\r\nconst WO_STATUS_COLORS = {\r\n    10: { // Entered/Planned - Light Blue (Fishbowl blue based)\r\n        fill: '#C5E9F7',      // Light version of #2d9cdb\r\n        stroke: '#2d9cdb',    // Fishbowl blue\r\n        border: 'border-blue-400',\r\n        bg: 'bg-blue-100',\r\n        text: 'text-slate-900'\r\n    },\r\n    20: { // Issued\r\n        fill: '#FEF3C7',      // amber-100\r\n        stroke: '#F59E0B',    // amber-500\r\n        border: 'border-amber-400',\r\n        bg: 'bg-amber-100',\r\n        text: 'text-slate-900'\r\n    },\r\n    30: { // Started/In Progress - Light Orange\r\n        fill: '#FFE4CC',      // Light orange\r\n        stroke: '#FF8C42',    // Orange\r\n        border: 'border-orange-400',\r\n        bg: 'bg-orange-100',\r\n        text: 'text-slate-900'\r\n    },\r\n    40: { // Fulfilled/Completed - Light Green\r\n        fill: '#D1FAE5',      // green-100\r\n        stroke: '#10B981',    // green-500\r\n        border: 'border-green-400',\r\n        bg: 'bg-green-100',\r\n        text: 'text-slate-900'\r\n    },\r\n    50: { // Closed\r\n        fill: '#E5E7EB',      // gray-200\r\n        stroke: '#6B7280',    // gray-500\r\n        border: 'border-gray-400',\r\n        bg: 'bg-gray-200',\r\n        text: 'text-gray-700'\r\n    }\r\n};\r\n\r\n// ============================================\r\n// UTILITY FUNCTIONS\r\n// ============================================\r\nfunction formatDate(momentObj, includeTime = false) {\r\n    // Format a moment object according to the user's date format preference\r\n    if (!momentObj || !momentObj.isValid()) return 'N/A';\r\n\r\n    if (includeTime) {\r\n        return dateFormat === 'DD/MM/YYYY'\r\n            ? momentObj.format('DD/MM/YYYY HH:mm')\r\n            : momentObj.format('MM/DD/YYYY HH:mm');\r\n    } else {\r\n        return dateFormat === 'DD/MM/YYYY'\r\n            ? momentObj.format('DD/MM/YYYY')\r\n            : momentObj.format('MM/DD/YYYY');\r\n    }\r\n}\r\n\r\nfunction debugLog(type, message, ...args) {\r\n    const timestamp = moment().format('HH:mm:ss.SSS');\r\n    const prefix = `[${timestamp}] [${type.toUpperCase()}]`;\r\n    console.log(prefix, message, ...args);\r\n\r\n    // Add to UI debug console\r\n    const debugLogEl = document.getElementById('debugLog');\r\n    if (debugLogEl) {\r\n        // Clear placeholder message on first log\r\n        if (!debugLogInitialized) {\r\n            debugLogEl.innerHTML = '';\r\n            debugLogInitialized = true;\r\n        }\r\n\r\n        const colorMap = {\r\n            'success': 'text-emerald-400',\r\n            'error': 'text-red-400',\r\n            'warn': 'text-amber-400',\r\n            'info': 'text-blue-400'\r\n        };\r\n        const entry = document.createElement('div');\r\n        entry.className = `${colorMap[type] || 'text-slate-300'} py-0.5`;\r\n        const argsStr = args.length > 0 ? ' ' + args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ') : '';\r\n        entry.textContent = `${prefix} ${message}${argsStr}`;\r\n        debugLogEl.appendChild(entry);\r\n        debugLogEl.scrollTop = debugLogEl.scrollHeight; // Auto-scroll to bottom\r\n    }\r\n}\r\n\r\nfunction showToast(message, type = 'info', duration = 3000) {\r\n    const container = document.querySelector('.toast-container');\r\n    const toast = document.createElement('div');\r\n    toast.className = `toast ${type}`;\r\n\r\n    const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';\r\n    toast.innerHTML = `\r\n        <div class=\"flex items-center gap-3\">\r\n            <span class=\"text-lg\">${icon}</span>\r\n            <span class=\"text-sm font-medium text-slate-700\">${message}</span>\r\n        </div>\r\n    `;\r\n\r\n    container.appendChild(toast);\r\n\r\n    setTimeout(() => {\r\n        toast.style.opacity = '0';\r\n        setTimeout(() => toast.remove(), 300);\r\n    }, duration);\r\n}\r\n\r\n// Custom Tooltip Functions\r\nfunction showWOTooltip(event, content) {\r\n    const tooltip = document.getElementById('woTooltip');\r\n    tooltip.innerHTML = content;\r\n    tooltip.classList.add('show');\r\n\r\n    // Position tooltip near mouse, but keep it on screen\r\n    const x = event.pageX + 15;\r\n    const y = event.pageY + 15;\r\n    const tooltipWidth = 300; // max-width from CSS\r\n    const tooltipHeight = 200; // estimated max height\r\n\r\n    const adjustedX = (x + tooltipWidth > window.innerWidth) ? event.pageX - tooltipWidth - 15 : x;\r\n    const adjustedY = (y + tooltipHeight > window.innerHeight) ? event.pageY - tooltipHeight - 15 : y;\r\n\r\n    tooltip.style.left = `${adjustedX}px`;\r\n    tooltip.style.top = `${adjustedY}px`;\r\n}\r\n\r\nfunction hideWOTooltip() {\r\n    const tooltip = document.getElementById('woTooltip');\r\n    tooltip.classList.remove('show');\r\n}\r\n\r\nfunction openOffcanvas(id) {\r\n    document.getElementById('modalOverlay').classList.add('show');\r\n    document.getElementById(id).classList.add('show');\r\n}\r\n\r\nfunction closeOffcanvas(id) {\r\n    document.getElementById('modalOverlay').classList.remove('show');\r\n    document.getElementById(id).classList.remove('show');\r\n}\r\n\r\n// Close offcanvas on overlay click\r\ndocument.getElementById('modalOverlay').addEventListener('click', () => {\r\n    document.querySelectorAll('.offcanvas').forEach(el => el.classList.remove('show'));\r\n    document.getElementById('modalOverlay').classList.remove('show');\r\n});\r\n\r\nfunction toggleSidebar() {\r\n    const sidebar = document.getElementById('sidebar');\r\n    sidebar.classList.toggle('sidebar-collapsed');\r\n    sidebar.classList.toggle('sidebar-expanded');\r\n\r\n    // Hide text when collapsed\r\n    const texts = sidebar.querySelectorAll('.sidebar-text');\r\n    const title = sidebar.querySelector('.sidebar-title');\r\n    const status = sidebar.querySelector('.sidebar-status');\r\n\r\n    if (sidebar.classList.contains('sidebar-collapsed')) {\r\n        texts.forEach(t => t.style.display = 'none');\r\n        title.style.display = 'none';\r\n        if (status) status.style.display = 'none';\r\n    } else {\r\n        texts.forEach(t => t.style.display = '');\r\n        title.style.display = '';\r\n        if (status) status.style.display = '';\r\n    }\r\n}\r\n\r\nfunction toggleDebugConsole() {\r\n    const content = document.getElementById('debugContent');\r\n    const chevron = document.getElementById('debugChevron');\r\n    content.classList.toggle('hidden');\r\n    chevron.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';\r\n}\r\n\r\nfunction clearDebugLog() {\r\n    const debugLogEl = document.getElementById('debugLog');\r\n    if (debugLogEl) {\r\n        debugLogEl.innerHTML = '';\r\n        debugLogInitialized = false; // Reset flag so next log clears properly\r\n        debugLog('info', '═══ Debug console cleared by user ═══');\r\n    }\r\n}\r\n\r\n// ============================================\r\n// DATA LOADING (Fishbowl API)\r\n// ============================================\r\n// Note: runQuery() and runApiRequest() are provided by Fishbowl as global functions\r\n// We call them directly without wrappers to avoid overwriting them\r\nfunction loadWorkOrders() {\r\n    debugLog('info', 'Loading work orders from Fishbowl...');\r\n    document.getElementById('refreshBtn').style.opacity = '0.5';\r\n\r\n    // Check if Fishbowl API is available\r\n    if (typeof runQuery !== 'function') {\r\n        const errorMsg = 'This file must be opened within Fishbowl to access work order data. The Fishbowl API (runQuery) is not available.';\r\n        debugLog('error', errorMsg);\r\n        showToast(errorMsg, 'error', 10000);\r\n        document.getElementById('refreshBtn').style.opacity = '1';\r\n\r\n        // Show helpful message in UI\r\n        const debugLogEl = document.getElementById('debugLog');\r\n        if (debugLogEl) {\r\n            debugLogEl.innerHTML = `\r\n                <div class=\"text-amber-400 py-2\">\r\n                    <strong>[ERROR]</strong> This application must run inside Fishbowl.\r\n                </div>\r\n                <div class=\"text-slate-300 py-1 text-sm\">\r\n                    Please open this file through Fishbowl's Report module to access the database.\r\n                </div>\r\n            `;\r\n        }\r\n        return;\r\n    }\r\n\r\n    const woQuery = `\r\n        SELECT\r\n            mo.num AS mo_num,\r\n            mo.id AS mo_id,\r\n            wo.id AS wo_id,\r\n            wo.num AS wo_num,\r\n            wo.statusid AS wo_status,\r\n            CASE wo.statusid\r\n                WHEN 10 THEN 'Entered'\r\n                WHEN 30 THEN 'In Progress'\r\n                WHEN 40 THEN 'Fulfilled'\r\n                ELSE 'Unknown'\r\n            END AS wo_status_name,\r\n            moitem.description AS description,\r\n            COALESCE(bom.estimatedDuration, 0) * COALESCE(wo.qtyTarget, 0) AS estimated_duration,\r\n            COALESCE(wo.datescheduled, moitem.datescheduled) AS date_scheduled,\r\n            COALESCE(wo.datescheduledtostart, moitem.datescheduledtostart) AS date_scheduled_start,\r\n            wo.datefinished AS date_finished,\r\n            COALESCE(calcat.name, '') AS calendar_category,\r\n            COALESCE(calcat.color, 'CCCCCC') AS category_color,\r\n            COALESCE(calcat.id, 0) AS calcategory_id,\r\n            wo.qtyTarget AS qty_target,\r\n            COALESCE(bom.estimatedDuration, 0) AS bom_duration_minutes,\r\n            (SELECT part.num FROM woitem\r\n             LEFT JOIN part ON woitem.partid = part.id\r\n             WHERE woitem.woid = wo.id AND woitem.typeid = 10\r\n             LIMIT 1) AS part_num,\r\n            (SELECT SUM(\r\n                CASE\r\n                    WHEN bomitem.uomid = (SELECT id FROM uom WHERE name = 'Hour' LIMIT 1) THEN\r\n                        COALESCE(bomitem.quantity, 0)\r\n                    WHEN EXISTS (\r\n                        SELECT 1 FROM uomconversion\r\n                        WHERE fromuomid = bomitem.uomid\r\n                        AND touomid = (SELECT id FROM uom WHERE name = 'Hour' LIMIT 1)\r\n                    ) THEN\r\n                        COALESCE(bomitem.quantity, 0) * (\r\n                            SELECT (multiply / factor)\r\n                            FROM uomconversion\r\n                            WHERE fromuomid = bomitem.uomid\r\n                            AND touomid = (SELECT id FROM uom WHERE name = 'Hour' LIMIT 1)\r\n                            LIMIT 1\r\n                        )\r\n                    WHEN EXISTS (\r\n                        SELECT 1 FROM uomconversion\r\n                        WHERE fromuomid = (SELECT id FROM uom WHERE name = 'Hour' LIMIT 1)\r\n                        AND touomid = bomitem.uomid\r\n                    ) THEN\r\n                        COALESCE(bomitem.quantity, 0) / (\r\n                            SELECT (multiply / factor)\r\n                            FROM uomconversion\r\n                            WHERE fromuomid = (SELECT id FROM uom WHERE name = 'Hour' LIMIT 1)\r\n                            AND touomid = bomitem.uomid\r\n                            LIMIT 1\r\n                        )\r\n                    ELSE 0\r\n                END\r\n            )\r\n            FROM bomitem\r\n            INNER JOIN part ON bomitem.partid = part.id\r\n            WHERE bomitem.bomid = bom.id\r\n            AND part.typeid = 21) AS labor_hours_from_bom\r\n        FROM wo\r\n        LEFT JOIN moitem ON wo.moitemid = moitem.id\r\n        LEFT JOIN mo ON moitem.moid = mo.id\r\n        LEFT JOIN bom ON moitem.bomid = bom.id\r\n        LEFT JOIN calcategory AS calcat ON wo.calcategoryid = calcat.id\r\n        WHERE wo.num IS NOT NULL\r\n            AND wo.statusid IN (10, 30, 40)\r\n            AND moitem.typeid = 50\r\n            AND mo.statusid NOT IN (60, 70, 80)\r\n        ORDER BY mo.num, wo.num\r\n    `;\r\n\r\n    const depQuery = `\r\n        SELECT DISTINCT\r\n            wo.id AS wo_id,\r\n            wo.num AS wo_num,\r\n            staging_wo.id AS staging_wo_id,\r\n            staging_wo.num AS staging_wo_num,\r\n            COALESCE(staging_wo.datescheduled, staging_moitem.datescheduled) AS staging_wo_finish,\r\n            COALESCE(wo.datescheduledtostart, current_moitem.datescheduledtostart) AS wo_start,\r\n            part.num AS part_num\r\n        FROM wo\r\n        LEFT JOIN moitem AS current_moitem ON wo.moitemid = current_moitem.id\r\n        LEFT JOIN mo AS current_mo ON current_moitem.moid = current_mo.id\r\n        LEFT JOIN woitem ON woitem.woid = wo.id AND woitem.typeid = 20\r\n        LEFT JOIN part ON woitem.partid = part.id\r\n        LEFT JOIN woitem AS staging_woitem ON staging_woitem.partid = part.id AND staging_woitem.typeid = 10\r\n        LEFT JOIN wo AS staging_wo ON staging_woitem.woid = staging_wo.id\r\n        LEFT JOIN moitem AS staging_moitem ON staging_wo.moitemid = staging_moitem.id\r\n        LEFT JOIN mo AS staging_mo ON staging_moitem.moid = staging_mo.id\r\n        WHERE wo.num IS NOT NULL\r\n            AND wo.statusid IN (10, 30, 40)\r\n            AND staging_wo.num IS NOT NULL\r\n            AND staging_wo.id != wo.id\r\n            AND current_mo.id = staging_mo.id\r\n            AND current_mo.statusid NOT IN (60, 70, 80)\r\n    `;\r\n\r\n    const moQuery = `\r\n        SELECT DISTINCT\r\n            mo.num AS mo_num,\r\n            mo.id AS mo_id,\r\n            mo.statusid AS mo_status,\r\n            mo.datescheduled AS mo_date_scheduled,\r\n            part.num AS part_num,\r\n            moitem.description AS description,\r\n            moitem.qtytofulfill AS qty,\r\n            bom.num AS bom_num\r\n        FROM mo\r\n        LEFT JOIN moitem ON moitem.moid = mo.id\r\n        LEFT JOIN part ON moitem.partid = part.id\r\n        LEFT JOIN bom ON moitem.bomid = bom.id\r\n        WHERE moitem.typeid = 50\r\n            AND moitem.parentid IS NULL\r\n            AND mo.statusid NOT IN (60, 70, 80)\r\n            AND mo.id IN (\r\n                SELECT DISTINCT mo.id\r\n                FROM wo\r\n                LEFT JOIN moitem ON wo.moitemid = moitem.id\r\n                LEFT JOIN mo ON moitem.moid = mo.id\r\n                WHERE wo.num IS NOT NULL AND wo.statusid IN (10, 30, 40) AND mo.statusid NOT IN (60, 70, 80)\r\n            )\r\n        ORDER BY mo.num\r\n    `;\r\n\r\n    try {\r\n        debugLog('info', 'Starting to load work orders...');\r\n\r\n        let usingMockData = false;\r\n\r\n        // Load WOs\r\n        const woResults = JSON.parse(runQuery(woQuery));\r\n        allWorkOrders = processWorkOrdersWithHours(woResults);\r\n        debugLog('success', `Loaded ${allWorkOrders.length} work orders`);\r\n\r\n        // Load staging dependencies\r\n        const depResults = JSON.parse(runQuery(depQuery));\r\n        stagingDependencies = depResults;\r\n        debugLog('success', `Loaded ${stagingDependencies.length} staging dependencies`);\r\n\r\n        // Load MO finished goods\r\n        const moResults = JSON.parse(runQuery(moQuery));\r\n        manufacturingOrders = moResults;\r\n        debugLog('success', `Loaded ${manufacturingOrders.length} MO finished goods`);\r\n\r\n        // Extract unique MOs and categories\r\n        const uniqueMOs = [...new Set(allWorkOrders.map(wo => wo.mo_num))].sort();\r\n        manufacturingOrders = uniqueMOs.map(mo => {\r\n            const existing = manufacturingOrders.find(m => m.mo_num === mo);\r\n            return existing || { mo_num: mo };\r\n        });\r\n\r\n        const catMap = new Map();\r\n        allWorkOrders.forEach(wo => {\r\n            const catName = wo.calendar_category || wo.category_name || 'Uncategorized';\r\n            if (!catMap.has(catName)) {\r\n                catMap.set(catName, {\r\n                    id: wo.calcategory_id || 0,\r\n                    name: catName,\r\n                    color: wo.category_color ? '#' + wo.category_color : '#6366f1'\r\n                });\r\n            }\r\n        });\r\n        categories = Array.from(catMap.values());\r\n\r\n        filteredWorkOrders = [...allWorkOrders];\r\n\r\n        // Calculate initial date range from work orders\r\n        if (allWorkOrders.length > 0) {\r\n            const allDates = allWorkOrders.flatMap(wo => [\r\n                moment(wo.date_scheduled_start),\r\n                moment(wo.date_scheduled)\r\n            ]);\r\n            const minDate = moment.min(allDates);\r\n            const maxDate = moment.max(allDates);\r\n\r\n            // Add 1 week padding on each side\r\n            ganttStartDate = minDate.clone().subtract(1, 'week').startOf('isoWeek');\r\n            ganttEndDate = maxDate.clone().add(1, 'week').endOf('isoWeek');\r\n\r\n            debugLog('info', `Date range: ${ganttStartDate.format('YYYY-MM-DD')} to ${ganttEndDate.format('YYYY-MM-DD')}`);\r\n        }\r\n\r\n        // Initialize capacity planning settings\r\n        initializeCapacitySettings();\r\n\r\n        // Load saved settings from database AFTER categories are initialized\r\n        // (updateKPIs will be called by applySettings after settings are loaded)\r\n        const settingsLoaded = loadSettingsFromDatabase();\r\n\r\n        // If no settings were loaded, update KPIs with defaults\r\n        if (!settingsLoaded) {\r\n            updateKPIs();\r\n        }\r\n\r\n        if (!currentCapacityWeek) {\r\n            currentCapacityWeek = moment().startOf('isoWeek');\r\n        }\r\n\r\n        renderCurrentView();\r\n\r\n        // Show appropriate message based on data source\r\n        const statusTitle = document.getElementById('systemStatusTitle');\r\n        const statusText = document.getElementById('systemStatusText');\r\n\r\n        if (usingMockData) {\r\n            showToast(`⚠ Using MOCK DATA (${allWorkOrders.length} WOs) - Fishbowl not connected`, 'info', 5000);\r\n            if (statusTitle) statusTitle.className = 'flex items-center gap-2 text-xs font-semibold mb-2 text-amber-400';\r\n            if (statusText) statusText.textContent = 'Mock Data Mode';\r\n        } else {\r\n            showToast(`✓ Loaded ${allWorkOrders.length} work orders from Fishbowl`, 'success');\r\n            if (statusTitle) statusTitle.className = 'flex items-center gap-2 text-xs font-semibold mb-2 text-emerald-400';\r\n            if (statusText) statusText.textContent = 'Fishbowl Connected';\r\n        }\r\n    } catch (error) {\r\n        debugLog('error', 'Failed to load work orders', error);\r\n        showToast('Failed to load data: ' + error.message, 'error');\r\n    } finally {\r\n        document.getElementById('refreshBtn').style.opacity = '1';\r\n    }\r\n}\r\n\r\n// ============================================\r\n// DATA PROCESSING FUNCTIONS\r\n// ============================================\r\nfunction processWorkOrdersWithHours(workOrders) {\r\n    return workOrders.map(wo => {\r\n        const totalHours = calculateWOHours(wo);\r\n        const dailyHours = calculateDailyHours(wo, totalHours);\r\n\r\n        // Normalize category name\r\n        const category_name = wo.calendar_category || 'Uncategorized';\r\n\r\n        return {\r\n            ...wo,\r\n            category_name: category_name,\r\n            total_hours: totalHours,\r\n            daily_hours: dailyHours,\r\n            date_range_days: moment(wo.date_scheduled).diff(\r\n                moment(wo.date_scheduled_start),\r\n                'days'\r\n            ) + 1\r\n        };\r\n    });\r\n}\r\n\r\nfunction calculateWOHours(wo) {\r\n    let totalHours = 0;\r\n\r\n    // Priority 1: BOM estimated duration (convert minutes to hours)\r\n    if (wo.bom_duration_minutes && wo.bom_duration_minutes > 0) {\r\n        totalHours = (wo.bom_duration_minutes / 60) * wo.qty_target;\r\n        debugLog('info', `WO ${wo.wo_num}: Using BOM duration ${wo.bom_duration_minutes}min * ${wo.qty_target}qty = ${totalHours.toFixed(2)}hrs`);\r\n    }\r\n    // Priority 2: Labor hours from BOM parts (already in hours)\r\n    else if (wo.labor_hours_from_bom && wo.labor_hours_from_bom > 0) {\r\n        totalHours = wo.labor_hours_from_bom * wo.qty_target;\r\n        debugLog('info', `WO ${wo.wo_num}: Using labor parts ${wo.labor_hours_from_bom}hrs * ${wo.qty_target}qty = ${totalHours.toFixed(2)}hrs`);\r\n    }\r\n    // Priority 3: Default fallback (1 hour per day)\r\n    else {\r\n        const dateRange = moment(wo.date_scheduled).diff(\r\n            moment(wo.date_scheduled_start),\r\n            'days'\r\n        ) + 1;\r\n        totalHours = Math.max(1, dateRange) * 1; // 1 hour per day, minimum 1 hour\r\n        debugLog('warn', `WO ${wo.wo_num}: No BOM data found, using fallback ${totalHours}hrs (1hr/day * ${dateRange}days)`);\r\n    }\r\n\r\n    return Math.max(0, totalHours); // Ensure non-negative\r\n}\r\n\r\nfunction calculateDailyHours(wo, totalHours) {\r\n    const startDate = moment(wo.date_scheduled_start);\r\n    const endDate = moment(wo.date_scheduled);\r\n    const days = endDate.diff(startDate, 'days') + 1;\r\n\r\n    if (days <= 0) return [];\r\n\r\n    const hoursPerDay = totalHours / days;\r\n    const dailyHours = [];\r\n\r\n    for (let i = 0; i < days; i++) {\r\n        const currentDate = startDate.clone().add(i, 'days');\r\n        dailyHours.push({\r\n            date: currentDate.format('YYYY-MM-DD'),\r\n            hours: hoursPerDay\r\n        });\r\n    }\r\n\r\n    return dailyHours;\r\n}\r\n\r\n// ============================================\r\n// SAVE WO DATES\r\n// ============================================\r\nfunction scrollToWO(woNum) {\r\n    // Scroll to and highlight a specific WO in the gantt chart\r\n    const woBar = document.querySelector(`[data-wo-num=\"${woNum}\"]`);\r\n\r\n    if (woBar) {\r\n        const ganttWrapper = document.getElementById('ganttWrapper');\r\n        if (!ganttWrapper) return;\r\n\r\n        // Get the WO bar position relative to the SVG\r\n        const barRect = woBar.getBoundingClientRect();\r\n        const wrapperRect = ganttWrapper.getBoundingClientRect();\r\n\r\n        // Calculate the scroll position to center the WO\r\n        const scrollTop = ganttWrapper.scrollTop + (barRect.top - wrapperRect.top) - (wrapperRect.height / 2) + (barRect.height / 2);\r\n        const scrollLeft = ganttWrapper.scrollLeft + (barRect.left - wrapperRect.left) - (wrapperRect.width / 2) + (barRect.width / 2);\r\n\r\n        // Smooth scroll to the WO\r\n        ganttWrapper.scrollTo({\r\n            top: scrollTop,\r\n            left: scrollLeft,\r\n            behavior: 'smooth'\r\n        });\r\n\r\n        // Briefly highlight the WO\r\n        const originalStroke = woBar.getAttribute('stroke');\r\n        const originalStrokeWidth = woBar.getAttribute('stroke-width');\r\n\r\n        woBar.setAttribute('stroke', '#fbbf24');\r\n        woBar.setAttribute('stroke-width', '4');\r\n\r\n        setTimeout(() => {\r\n            woBar.setAttribute('stroke', originalStroke || 'none');\r\n            woBar.setAttribute('stroke-width', originalStrokeWidth || '1');\r\n        }, 2000);\r\n\r\n        debugLog('info', `Scrolled to WO ${woNum}`);\r\n    } else {\r\n        debugLog('warn', `Could not find WO ${woNum} in gantt chart`);\r\n    }\r\n}\r\n\r\nasync function saveWOCategory(woNum, newCategoryId) {\r\n    debugLog('info', `Saving WO ${woNum} category to ${newCategoryId}`);\r\n\r\n    try {\r\n        // Get the full WO record from Fishbowl\r\n        const woRequest = {\r\n            GetWorkOrderRq: {\r\n                WorkOrderNumber: woNum\r\n            }\r\n        };\r\n\r\n        const woResponse = JSON.parse(runApiRequest('GetWorkOrderRq', JSON.stringify(woRequest)));\r\n\r\n        if (woResponse.GetWorkOrderRs && woResponse.GetWorkOrderRs.statusCode === 1000 && woResponse.GetWorkOrderRs.WO) {\r\n            const wo = woResponse.GetWorkOrderRs.WO;\r\n\r\n            // Update the calendar category ID\r\n            wo.CalCategoryID = newCategoryId;\r\n\r\n            // Save the updated WO\r\n            const saveRequest = {\r\n                SaveWorkOrderRq: {\r\n                    WO: wo\r\n                }\r\n            };\r\n\r\n            const saveResponse = JSON.parse(runApiRequest('SaveWorkOrderRq', JSON.stringify(saveRequest)));\r\n\r\n            if (saveResponse.SaveWorkOrderRs && saveResponse.SaveWorkOrderRs.statusCode === 1000) {\r\n                debugLog('success', `WO ${woNum} category updated successfully`);\r\n                showToast(`WO ${woNum} category updated successfully`, 'success');\r\n                return true;\r\n            } else {\r\n                const errorMsg = saveResponse.SaveWorkOrderRs ? saveResponse.SaveWorkOrderRs.statusMessage : 'Unknown error';\r\n                throw new Error('Failed to save WO: ' + errorMsg);\r\n            }\r\n        } else {\r\n            const errorMsg = woResponse.GetWorkOrderRs ? woResponse.GetWorkOrderRs.statusMessage : 'Failed to retrieve WO';\r\n            throw new Error('Failed to get WO: ' + errorMsg);\r\n        }\r\n    } catch (error) {\r\n        debugLog('error', `Failed to save WO ${woNum} category`, error);\r\n        showToast(`Failed to save WO category: ${error.message}`, 'error', 5000);\r\n        return false;\r\n    }\r\n}\r\n\r\nasync function saveWODates(woNum, newStartDate, newEndDate) {\r\n    debugLog('info', `Saving WO ${woNum} dates: ${newStartDate} to ${newEndDate}`);\r\n\r\n    try {\r\n        // Get the full WO record from Fishbowl\r\n        const woRequest = {\r\n            GetWorkOrderRq: {\r\n                WorkOrderNumber: woNum\r\n            }\r\n        };\r\n\r\n        const woResponse = JSON.parse(runApiRequest('GetWorkOrderRq', JSON.stringify(woRequest)));\r\n\r\n        if (woResponse.GetWorkOrderRs && woResponse.GetWorkOrderRs.statusCode === 1000 && woResponse.GetWorkOrderRs.WO) {\r\n            const wo = woResponse.GetWorkOrderRs.WO;\r\n\r\n            // Parse original dates to preserve time component\r\n            const originalStart = moment(wo.DateScheduledToStart);\r\n            const originalEnd = moment(wo.DateScheduled);\r\n\r\n            // Create new date moments, preserving original time\r\n            const newStartMoment = moment(newStartDate).hour(originalStart.hour()).minute(originalStart.minute()).second(originalStart.second());\r\n            const newEndMoment = moment(newEndDate).hour(originalEnd.hour()).minute(originalEnd.minute()).second(originalEnd.second());\r\n\r\n            // Update the dates with time preserved\r\n            wo.DateScheduledToStart = newStartMoment.format('YYYY-MM-DD[T]HH:mm:ss');\r\n            wo.DateScheduled = newEndMoment.format('YYYY-MM-DD[T]HH:mm:ss');\r\n\r\n            // Also update WO items if they exist\r\n            if (wo.WOItems && wo.WOItems.WOItem) {\r\n                const items = Array.isArray(wo.WOItems.WOItem) ? wo.WOItems.WOItem : [wo.WOItems.WOItem];\r\n                items.forEach(item => {\r\n                    if (item.DateScheduled) {\r\n                        const originalItemDate = moment(item.DateScheduled);\r\n                        const newItemMoment = moment(newStartDate).hour(originalItemDate.hour()).minute(originalItemDate.minute()).second(originalItemDate.second());\r\n                        item.DateScheduled = newItemMoment.format('YYYY-MM-DD[T]HH:mm:ss');\r\n                    }\r\n                });\r\n            }\r\n\r\n            // Save the updated WO\r\n            const saveRequest = {\r\n                SaveWorkOrderRq: {\r\n                    WO: wo\r\n                }\r\n            };\r\n\r\n            const saveResponse = JSON.parse(runApiRequest('SaveWorkOrderRq', JSON.stringify(saveRequest)));\r\n\r\n            if (saveResponse.SaveWorkOrderRs && saveResponse.SaveWorkOrderRs.statusCode === 1000) {\r\n                debugLog('success', `WO ${woNum} updated successfully`);\r\n                showToast(`WO ${woNum} dates updated successfully`, 'success');\r\n\r\n                // Save current scroll position\r\n                const ganttWrapper = document.getElementById('ganttWrapper');\r\n                const savedScrollLeft = ganttWrapper ? ganttWrapper.scrollLeft : 0;\r\n                const savedScrollTop = ganttWrapper ? ganttWrapper.scrollTop : 0;\r\n\r\n                // Set flag to skip auto-scroll on next render\r\n                window.skipAutoScroll = true;\r\n\r\n                // Reload data to reflect changes\r\n                loadWorkOrders();\r\n\r\n                // Restore scroll position after render\r\n                setTimeout(() => {\r\n                    if (ganttWrapper) {\r\n                        ganttWrapper.scrollLeft = savedScrollLeft;\r\n                        ganttWrapper.scrollTop = savedScrollTop;\r\n                    }\r\n                    window.skipAutoScroll = false;\r\n                }, 150);\r\n\r\n                return true;\r\n            } else {\r\n                const errorMsg = saveResponse.SaveWorkOrderRs ? saveResponse.SaveWorkOrderRs.statusMessage : 'Unknown error';\r\n                throw new Error('Failed to save WO: ' + errorMsg);\r\n            }\r\n        } else {\r\n            const errorMsg = woResponse.GetWorkOrderRs ? woResponse.GetWorkOrderRs.statusMessage : 'Failed to retrieve WO';\r\n            throw new Error('Failed to get WO: ' + errorMsg);\r\n        }\r\n    } catch (error) {\r\n        debugLog('error', `Failed to save WO ${woNum}`, error);\r\n        showToast(`Failed to save WO: ${error.message}`, 'error', 5000);\r\n        return false;\r\n    }\r\n}\r\n\r\nfunction generateMockData() {\r\n    const statuses = [\r\n        { id: 10, name: 'Entered' },\r\n        { id: 30, name: 'In Progress' },\r\n        { id: 40, name: 'Fulfilled' }\r\n    ];\r\n\r\n    const categories = [\r\n        { name: 'Fabrication', color: '#3b82f6' },\r\n        { name: 'Machining', color: '#10b981' },\r\n        { name: 'Assembly', color: '#f59e0b' },\r\n        { name: 'Quality Control', color: '#8b5cf6' }\r\n    ];\r\n\r\n    const mockWOs = [];\r\n    const today = moment();\r\n\r\n    for (let i = 1; i <= 20; i++) {\r\n        const mo = `MO-${1000 + Math.floor(i / 3)}`;\r\n        const cat = categories[i % categories.length];\r\n        const status = statuses[i % statuses.length];\r\n        const startOffset = Math.floor(i / 2) - 5;\r\n        const duration = 2 + (i % 4);\r\n\r\n        mockWOs.push({\r\n            wo_id: i,\r\n            wo_num: `WO-${2000 + i}`,\r\n            wo_status: status.id,\r\n            wo_status_name: status.name,\r\n            date_scheduled_start: today.clone().add(startOffset, 'days').format('YYYY-MM-DD[T]08:00:00'),\r\n            date_scheduled: today.clone().add(startOffset + duration, 'days').format('YYYY-MM-DD[T]17:00:00'),\r\n            date_finished: status.id === 40 ? today.clone().add(startOffset + duration - 1, 'days').format('YYYY-MM-DD[T]15:00:00') : null,\r\n            mo_num: mo,\r\n            mo_date_scheduled: today.clone().add(startOffset + duration + 2, 'days').format('YYYY-MM-DD[T]17:00:00'),\r\n            category_name: cat.name,\r\n            category_color: cat.color,\r\n            qty_target: 100\r\n        });\r\n    }\r\n\r\n    return mockWOs;\r\n}\r\n\r\n// ============================================\r\n// KPI DASHBOARD\r\n// ============================================\r\nfunction updateKPIs() {\r\n    const container = document.getElementById('kpiCards');\r\n\r\n    const startedWOs = filteredWorkOrders.filter(wo => wo.wo_status === 30).length;\r\n    const enteredWOs = filteredWorkOrders.filter(wo => wo.wo_status === 10).length;\r\n    const fulfilledWOs = filteredWorkOrders.filter(wo => wo.wo_status === 40).length;\r\n    const totalWOs = filteredWorkOrders.length;\r\n\r\n    // Calculate dependency conflicts (WOs that start before their dependencies are fulfilled)\r\n    let dependencyConflicts = 0;\r\n    let stagingConflicts = 0;\r\n    let sameDayConflicts = 0;\r\n    const stagingIssueMOs = new Map(); // Track conflict count per MO number\r\n\r\n    debugLog('info', `Checking ${stagingDependencies.length} staging dependencies, allowSameDayStarts=${allowSameDayStarts}`);\r\n\r\n    // Check staging dependencies\r\n    stagingDependencies.forEach(dep => {\r\n        const dependentWO = filteredWorkOrders.find(wo => wo.wo_id === dep.wo_id);\r\n        const stagingWO = filteredWorkOrders.find(wo => wo.wo_id === dep.staging_wo_id);\r\n\r\n        if (dependentWO && stagingWO) {\r\n            const dependentStart = moment(dependentWO.date_scheduled_start).startOf('day');\r\n            const stagingEnd = moment(stagingWO.date_scheduled).startOf('day');\r\n\r\n            // Conflict logic matching arrow rendering\r\n            let isConflict;\r\n            if (allowSameDayStarts) {\r\n                // Allow same-day: only conflict if staging finishes AFTER dependent starts\r\n                isConflict = stagingEnd.isAfter(dependentStart);\r\n            } else {\r\n                // Don't allow same-day: conflict if staging finishes on or after dependent starts\r\n                isConflict = stagingEnd.isSameOrAfter(dependentStart);\r\n            }\r\n\r\n            if (isConflict) {\r\n                stagingConflicts++;\r\n                dependencyConflicts++;\r\n                // Count conflicts per MO\r\n                const moNum = dependentWO.mo_num;\r\n                stagingIssueMOs.set(moNum, (stagingIssueMOs.get(moNum) || 0) + 1);\r\n                debugLog('warn', `Staging dependency conflict: ${stagingWO.wo_num} ends ${stagingEnd.format('YYYY-MM-DD')} vs ${dependentWO.wo_num} starts ${dependentStart.format('YYYY-MM-DD')}`);\r\n            }\r\n        }\r\n    });\r\n\r\n    // Also check same-day starts in same MO if setting is disabled\r\n    if (!allowSameDayStarts) {\r\n        const moGroups = {};\r\n        filteredWorkOrders.forEach(wo => {\r\n            if (!moGroups[wo.mo_num]) moGroups[wo.mo_num] = [];\r\n            moGroups[wo.mo_num].push(wo);\r\n        });\r\n\r\n        Object.values(moGroups).forEach(wos => {\r\n            if (wos.length > 1) {\r\n                const startDates = {};\r\n                wos.forEach(wo => {\r\n                    const startDate = moment(wo.date_scheduled_start).format('YYYY-MM-DD');\r\n                    if (startDates[startDate]) {\r\n                        sameDayConflicts++;\r\n                        dependencyConflicts++;\r\n                        const moNum = wo.mo_num;\r\n                        stagingIssueMOs.set(moNum, (stagingIssueMOs.get(moNum) || 0) + 1);\r\n                        debugLog('warn', `Same-day start conflict in MO: ${wo.wo_num} starts ${startDate}`);\r\n                    } else {\r\n                        startDates[startDate] = true;\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    debugLog('info', `Dependency conflicts breakdown: ${stagingConflicts} from staging deps, ${sameDayConflicts} from same-day MO starts, total=${dependencyConflicts}`);\r\n\r\n    // Calculate capacity issues (count each category-day combination that exceeds capacity)\r\n    let capacityIssues = 0;\r\n    const daysToCheck = 90;\r\n    const today = moment();\r\n    const categoryDaysWithIssues = new Set();\r\n    const capacityIssueDetails = []; // Track category-date pairs for tooltip\r\n\r\n    debugLog('info', `Checking capacity for ${capacitySettings.categories.length} categories over ${daysToCheck} days`);\r\n\r\n    // Debug: Show capacity settings\r\n    if (capacitySettings.categories.length > 0) {\r\n        debugLog('debug', 'Capacity limits per category:');\r\n        capacitySettings.categories.forEach(cat => {\r\n            debugLog('debug', `  ${cat.name} (ID ${cat.id}): ${cat.limits.join('/')} hrs (Mon-Sun)`);\r\n        });\r\n    }\r\n\r\n    for (let i = 0; i < daysToCheck; i++) {\r\n        const checkDay = today.clone().add(i, 'days');\r\n\r\n        capacitySettings.categories.forEach(cat => {\r\n            const dayOfWeek = checkDay.isoWeekday() - 1;\r\n            const capacity = cat.limits[dayOfWeek];\r\n\r\n            if (capacity > 0) {\r\n                const { usage } = getUsageForCategoryAndDay(cat.id, checkDay);\r\n\r\n                // Debug: Log when usage is significant\r\n                if (usage > 0) {\r\n                    debugLog('debug', `${checkDay.format('YYYY-MM-DD')} - Category ${cat.name}: usage=${usage.toFixed(2)}hrs, capacity=${capacity}hrs${usage > capacity ? ' ⚠️ EXCEEDED' : ''}`);\r\n                }\r\n\r\n                // If this category exceeds capacity on this day, count it as a separate issue\r\n                if (usage > capacity) {\r\n                    const issueKey = `${cat.id}-${checkDay.format('YYYY-MM-DD')}`;\r\n                    if (!categoryDaysWithIssues.has(issueKey)) {\r\n                        categoryDaysWithIssues.add(issueKey);\r\n                        capacityIssues++;\r\n                        capacityIssueDetails.push({\r\n                            category: cat.name,\r\n                            date: checkDay.format('YYYY-MM-DD'),\r\n                            usage: usage,\r\n                            capacity: capacity\r\n                        });\r\n                        debugLog('warn', `⚠️ CAPACITY ISSUE #${capacityIssues}: ${checkDay.format('YYYY-MM-DD')} - ${cat.name} has ${usage.toFixed(2)}hrs usage but only ${capacity}hrs capacity`);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    debugLog('info', `Total capacity issues found: ${capacityIssues}`);\r\n    debugLog('info', `Total dependency conflicts found: ${dependencyConflicts}`);\r\n    debugLog('info', `KPI Summary - Dependency Conflicts: ${dependencyConflicts}, Capacity Issues: ${capacityIssues}`);\r\n\r\n    // Check for WOs with missing or low labor hours\r\n    const wosWithNoLabor = filteredWorkOrders.filter(wo => !wo.labor_hours_from_bom || parseFloat(wo.labor_hours_from_bom) === 0);\r\n    const wosWithLowLabor = filteredWorkOrders.filter(wo => {\r\n        const hours = parseFloat(wo.labor_hours_from_bom) || 0;\r\n        return hours > 0 && hours < 2; // Less than 2 hours total seems suspiciously low\r\n    });\r\n\r\n    if (wosWithNoLabor.length > 0) {\r\n        debugLog('warn', `⚠️ ${wosWithNoLabor.length} WO(s) have NO labor hours: ${wosWithNoLabor.map(wo => wo.wo_num).join(', ')}`);\r\n    }\r\n    if (wosWithLowLabor.length > 0) {\r\n        debugLog('warn', `⚠️ ${wosWithLowLabor.length} WO(s) have suspiciously LOW labor hours (<2hrs): ${wosWithLowLabor.map(wo => `${wo.wo_num}(${wo.labor_hours_from_bom}hrs)`).join(', ')}`);\r\n    }\r\n\r\n    const kpis = [\r\n        {\r\n            title: 'Entered WOs',\r\n            value: enteredWOs,\r\n            color: 'blue', // Match WO status 10 color (#2d9cdb)\r\n            icon: `<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\"></path>`\r\n        },\r\n        {\r\n            title: 'Started WOs',\r\n            value: startedWOs,\r\n            color: 'orange', // Match WO status 30 color (#FF8C42)\r\n            icon: `<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 10V3L4 14h7v7l9-11h-7z\"></path>`\r\n        },\r\n        {\r\n            title: 'Fulfilled WOs',\r\n            value: fulfilledWOs,\r\n            color: 'green', // Match WO status 40 color (#10B981)\r\n            icon: `<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"></path>`\r\n        },\r\n        {\r\n            title: 'Total WOs',\r\n            value: totalWOs,\r\n            color: 'slate',\r\n            icon: `<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2\"></path>`\r\n        },\r\n        {\r\n            title: 'Staging Issues',\r\n            value: dependencyConflicts,\r\n            color: 'rose',\r\n            icon: `<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"></path>`,\r\n            tooltipHTML: stagingIssueMOs.size > 0\r\n                ? '<div style=\"font-weight: 600; margin-bottom: 0.5rem;\">MO Numbers:</div>' +\r\n                  '<div style=\"color: #ffffff;\">' +\r\n                  Array.from(stagingIssueMOs.keys())\r\n                      .sort((a, b) => a - b)\r\n                      .map(moNum => `MO ${moNum}`)\r\n                      .join(', ') +\r\n                  '</div>'\r\n                : null\r\n        },\r\n        {\r\n            title: 'Capacity Issues',\r\n            value: capacityIssues,\r\n            color: 'amber', // Changed from orange to amber to avoid confusion with Started WOs\r\n            icon: `<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 17h8m0 0V9m0 8l-8-8-4 4-6-6\"></path>`,\r\n            tooltipHTML: capacityIssueDetails.length > 0\r\n                ? '<div style=\"font-weight: 600; margin-bottom: 0.5rem;\">Capacity Overages:</div>' +\r\n                  capacityIssueDetails\r\n                    .sort((a, b) => a.date.localeCompare(b.date) || a.category.localeCompare(b.category))\r\n                    .map(issue => {\r\n                        const dateStr = moment(issue.date).format('MMM DD');\r\n                        const usageStr = issue.usage ? `${issue.usage.toFixed(1)}h` : 'N/A';\r\n                        const capacityStr = issue.capacity ? `${issue.capacity}h` : 'N/A';\r\n                        return `<div><span class=\"wo-tooltip-label\">${dateStr} - ${issue.category}:</span><span class=\"wo-tooltip-value\">${usageStr}/${capacityStr}</span></div>`;\r\n                    })\r\n                    .join('')\r\n                : null\r\n        }\r\n    ];\r\n\r\n    const colorClasses = {\r\n        blue: 'bg-blue-100 text-blue-700',        // WO status 10 (Entered) - darker for visibility\r\n        orange: 'bg-orange-100 text-orange-700',  // WO status 30 (Started) - darker for visibility\r\n        green: 'bg-green-100 text-green-700',     // WO status 40 (Fulfilled) - darker for visibility\r\n        amber: 'bg-amber-100 text-amber-700',\r\n        slate: 'bg-slate-100 text-slate-700',\r\n        rose: 'bg-rose-100 text-rose-700'\r\n    };\r\n\r\n    container.innerHTML = kpis.map((kpi, index) => `\r\n        <div class=\"kpi-tile bg-white rounded-md px-2 py-1.5 shadow-sm border border-slate-300 flex flex-col gap-1 flex-1 min-w-0${kpi.tooltipHTML ? ' cursor-help' : ''}\" data-kpi-index=\"${index}\">\r\n            <p class=\"text-slate-600 text-[10px] font-bold uppercase tracking-wide truncate\">${kpi.title}</p>\r\n            <div class=\"flex items-center gap-1.5\">\r\n                <div class=\"${colorClasses[kpi.color]} p-1 rounded flex-shrink-0\">\r\n                    <svg class=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        ${kpi.icon}\r\n                    </svg>\r\n                </div>\r\n                <h3 class=\"text-lg font-bold text-slate-800\">${kpi.value}</h3>\r\n            </div>\r\n        </div>\r\n    `).join('');\r\n\r\n    // Add event handlers for tooltips\r\n    kpis.forEach((kpi, index) => {\r\n        if (kpi.tooltipHTML) {\r\n            const tile = container.querySelectorAll('.kpi-tile')[index];\r\n            if (tile) {\r\n                tile.addEventListener('mouseover', (e) => showWOTooltip(e, kpi.tooltipHTML));\r\n                tile.addEventListener('mouseout', () => hideWOTooltip());\r\n                tile.addEventListener('mousemove', (e) => showWOTooltip(e, kpi.tooltipHTML));\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// ============================================\r\n// VIEW SWITCHING\r\n// ============================================\r\nfunction switchView(mode) {\r\n    viewMode = mode;\r\n\r\n    // Update view switcher buttons\r\n    const moBtn = document.getElementById('view-btn-mo');\r\n    const capacityBtn = document.getElementById('view-btn-capacity');\r\n\r\n    // Reset both buttons\r\n    [moBtn, capacityBtn].forEach(btn => {\r\n        btn.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm');\r\n        btn.classList.add('text-slate-400', 'hover:text-slate-600');\r\n    });\r\n\r\n    // Activate the appropriate button based on mode\r\n    if (mode === 'mo' || mode === 'category') {\r\n        moBtn.classList.remove('text-slate-400', 'hover:text-slate-600');\r\n        moBtn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm');\r\n    } else if (mode === 'capacity') {\r\n        capacityBtn.classList.remove('text-slate-400', 'hover:text-slate-600');\r\n        capacityBtn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm');\r\n    }\r\n\r\n    // Update view title\r\n    const titles = {\r\n        mo: 'Gantt View',\r\n        category: 'Category View',\r\n        capacity: 'Capacity'\r\n    };\r\n    document.getElementById('viewTitle').textContent = titles[mode];\r\n\r\n    // Show/hide appropriate containers\r\n    if (mode === 'capacity') {\r\n        document.getElementById('ganttContainer').style.display = 'none';\r\n        document.getElementById('capacityContainer').style.display = 'block';\r\n\r\n        if (!currentCapacityWeek) {\r\n            currentCapacityWeek = moment().startOf('isoWeek');\r\n        }\r\n        buildCapacityTable(currentCapacityWeek);\r\n        buildMonthCalendar(); // Always build calendar when switching to capacity view\r\n    } else {\r\n        document.getElementById('ganttContainer').style.display = 'block';\r\n        document.getElementById('capacityContainer').style.display = 'none';\r\n\r\n        renderGanttChart();\r\n    }\r\n}\r\n\r\nfunction renderCurrentView() {\r\n    if (viewMode === 'capacity') {\r\n        if (currentCapacityWeek) {\r\n            buildCapacityTable(currentCapacityWeek);\r\n        }\r\n        buildMonthCalendar(); // Rebuild calendar when data updates\r\n    } else {\r\n        renderGanttChart();\r\n    }\r\n}\r\n\r\n// ============================================\r\n// WO PACKING FOR CATEGORY VIEW\r\n// ============================================\r\nfunction packWOsIntoLanes(wos) {\r\n    // Sort WOs by start date\r\n    const sortedWOs = [...wos].sort((a, b) =>\r\n        moment(a.date_scheduled_start).valueOf() - moment(b.date_scheduled_start).valueOf()\r\n    );\r\n\r\n    const lanes = [];\r\n\r\n    sortedWOs.forEach(wo => {\r\n        // Use full day spans for overlap detection (matching rendering logic)\r\n        const woStart = moment(wo.date_scheduled_start).startOf('day');\r\n        const woEnd = moment(wo.date_scheduled).endOf('day');\r\n\r\n        // Find first lane where this WO doesn't overlap\r\n        let placed = false;\r\n        for (let i = 0; i < lanes.length; i++) {\r\n            const lane = lanes[i];\r\n            const overlaps = lane.some(existingWO => {\r\n                const existingStart = moment(existingWO.date_scheduled_start).startOf('day');\r\n                const existingEnd = moment(existingWO.date_scheduled).endOf('day');\r\n                return woStart.isBefore(existingEnd) && woEnd.isAfter(existingStart);\r\n            });\r\n\r\n            if (!overlaps) {\r\n                lane.push(wo);\r\n                wo._lane = i; // Store lane index on WO object\r\n                placed = true;\r\n                break;\r\n            }\r\n        }\r\n\r\n        // If no suitable lane found, create new lane\r\n        if (!placed) {\r\n            wo._lane = lanes.length;\r\n            lanes.push([wo]);\r\n        }\r\n    });\r\n\r\n    return lanes.length; // Return number of lanes needed\r\n}\r\n\r\n// ============================================\r\n// TOPOLOGICAL SORT FOR WO ORDERING\r\n// ============================================\r\nfunction sortWOsByDependencies(wos) {\r\n    // Build dependency graph from staging relationships\r\n    // If WO A produces a part used in WO B, then A should come before B\r\n\r\n    const woMap = new Map(wos.map(wo => [wo.wo_id, wo]));\r\n    const dependencies = new Map(); // wo_id -> array of wo_ids it depends on\r\n    const dependents = new Map(); // wo_id -> array of wo_ids that depend on it\r\n\r\n    // Initialize maps\r\n    wos.forEach(wo => {\r\n        dependencies.set(wo.wo_id, []);\r\n        dependents.set(wo.wo_id, []);\r\n    });\r\n\r\n    // Build dependency graph from staging relationships\r\n    stagingDependencies.forEach(dep => {\r\n        // dep.staging_wo_id produces a part that dep.wo_id consumes\r\n        // So dep.wo_id depends on dep.staging_wo_id\r\n        if (woMap.has(dep.wo_id) && woMap.has(dep.staging_wo_id)) {\r\n            dependencies.get(dep.wo_id).push(dep.staging_wo_id);\r\n            dependents.get(dep.staging_wo_id).push(dep.wo_id);\r\n        }\r\n    });\r\n\r\n    // Topological sort using Kahn's algorithm\r\n    const sorted = [];\r\n    const inDegree = new Map();\r\n\r\n    wos.forEach(wo => {\r\n        inDegree.set(wo.wo_id, dependencies.get(wo.wo_id).length);\r\n    });\r\n\r\n    // Start with WOs that have no dependencies\r\n    const queue = wos.filter(wo => inDegree.get(wo.wo_id) === 0);\r\n\r\n    while (queue.length > 0) {\r\n        // Sort queue by WO number to maintain stable sort for WOs at same level\r\n        queue.sort((a, b) => a.wo_num.localeCompare(b.wo_num));\r\n\r\n        const wo = queue.shift();\r\n        sorted.push(wo);\r\n\r\n        // Reduce in-degree for dependent WOs\r\n        const deps = dependents.get(wo.wo_id) || [];\r\n        deps.forEach(depWoId => {\r\n            inDegree.set(depWoId, inDegree.get(depWoId) - 1);\r\n            if (inDegree.get(depWoId) === 0) {\r\n                queue.push(woMap.get(depWoId));\r\n            }\r\n        });\r\n    }\r\n\r\n    // If there are cycles or orphaned WOs, append them sorted by WO number\r\n    const remaining = wos.filter(wo => !sorted.includes(wo));\r\n    if (remaining.length > 0) {\r\n        remaining.sort((a, b) => a.wo_num.localeCompare(b.wo_num));\r\n        sorted.push(...remaining);\r\n    }\r\n\r\n    return sorted;\r\n}\r\n\r\n// ============================================\r\n// SKIP WEEKENDS HELPER\r\n// ============================================\r\nfunction applySkipWeekends(date) {\r\n    if (!skipWeekends) {\r\n        return date;\r\n    }\r\n\r\n    const m = moment(date);\r\n    const dayOfWeek = m.day();\r\n    const originalDate = m.format('YYYY-MM-DD');\r\n\r\n    // If Saturday (6), move to Monday (+2 days)\r\n    if (dayOfWeek === 6) {\r\n        const newDate = m.add(2, 'days').toDate();\r\n        debugLog('info', `Skip weekends: ${originalDate} (Sat) → ${moment(newDate).format('YYYY-MM-DD')} (Mon)`);\r\n        return newDate;\r\n    }\r\n    // If Sunday (0), move to Monday (+1 day)\r\n    if (dayOfWeek === 0) {\r\n        const newDate = m.add(1, 'day').toDate();\r\n        debugLog('info', `Skip weekends: ${originalDate} (Sun) → ${moment(newDate).format('YYYY-MM-DD')} (Mon)`);\r\n        return newDate;\r\n    }\r\n\r\n    return date;\r\n}\r\n\r\nfunction countWeekdaysInRange(startDate, endDate) {\r\n    // Count weekdays (Mon-Fri) in inclusive date range\r\n    let count = 0;\r\n    let current = startDate.clone();\r\n\r\n    while (current.isSameOrBefore(endDate)) {\r\n        const dayOfWeek = current.day();\r\n        // 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri\r\n        if (dayOfWeek >= 1 && dayOfWeek <= 5) {\r\n            count++;\r\n        }\r\n        current.add(1, 'day');\r\n    }\r\n\r\n    return count;\r\n}\r\n\r\n// ============================================\r\n// CUSTOM D3 GANTT CHART\r\n// ============================================\r\nfunction renderGanttChart() {\r\n    debugLog('info', `Rendering ${viewMode} Gantt chart...`);\r\n\r\n    // Clear conflicts\r\n    conflicts.clear();\r\n\r\n    // Apply status filter (multi-select)\r\n    let displayedWorkOrders = filteredWorkOrders;\r\n    if (activeStatusFilters.size > 0 && activeStatusFilters.size < 4) {\r\n        // Only filter if not all statuses are selected\r\n        displayedWorkOrders = filteredWorkOrders.filter(wo => {\r\n            // Check if WO status matches any selected filter\r\n            const statusMatch = activeStatusFilters.has(String(wo.wo_status));\r\n\r\n            // Check if conflicts filter is active\r\n            if (activeStatusFilters.has('conflict')) {\r\n                const conflictWOIds = new Set();\r\n                stagingDependencies.forEach(dep => {\r\n                    conflictWOIds.add(dep.wo_id);\r\n                    conflictWOIds.add(dep.staging_wo_id);\r\n                });\r\n                if (conflictWOIds.has(wo.wo_id)) {\r\n                    return true;\r\n                }\r\n            }\r\n\r\n            return statusMatch;\r\n        });\r\n        debugLog('info', `Status filters active: ${Array.from(activeStatusFilters).join(', ')}, showing ${displayedWorkOrders.length}/${filteredWorkOrders.length} WOs`);\r\n    }\r\n\r\n    const svg = d3.select('#ganttSvg');\r\n    svg.selectAll('*').remove();\r\n\r\n    if (displayedWorkOrders.length === 0) {\r\n        svg.append('text')\r\n            .attr('x', '50%')\r\n            .attr('y', 100)\r\n            .attr('text-anchor', 'middle')\r\n            .attr('class', 'text-slate-400 text-sm')\r\n            .text('No work orders to display');\r\n        return;\r\n    }\r\n\r\n    // Dimensions\r\n    const margin = { top: 110, right: 40, bottom: 40, left: 200 }; // Increased top margin for date headers\r\n    const dayWidth = ganttScale;\r\n    const days = moment(ganttEndDate).diff(ganttStartDate, 'days') + 1;\r\n    const width = days * dayWidth + margin.left + margin.right;\r\n    const rowHeight = 25; // Reduced to minimize space around 20px tiles\r\n\r\n    // Build groups based on view mode\r\n    let groups = [];\r\n    if (viewMode === 'mo') {\r\n        // Hierarchical view: Each MO gets a header row + WO child rows\r\n        const moNums = [...new Set(displayedWorkOrders.map(wo => wo.mo_num))].sort((a, b) => a - b);\r\n\r\n        moNums.forEach(moNum => {\r\n            const moWOs = displayedWorkOrders.filter(wo => wo.mo_num === moNum);\r\n\r\n            // Sort WOs by staging dependencies for natural workflow order\r\n            const sortedMoWOs = sortWOsByDependencies(moWOs);\r\n\r\n            const moData = manufacturingOrders.find(mo => mo.mo_num === moNum);\r\n            const bomInfo = moData ? `${moData.bom_num || 'N/A'} x ${moData.qty || '?'}` : '';\r\n\r\n            // Add MO header row\r\n            groups.push({\r\n                id: `mo_${moNum}`,\r\n                name: `MO ${moNum} (${bomInfo})`,\r\n                type: 'mo-header',\r\n                moNum: moNum,\r\n                wos: sortedMoWOs,\r\n                isCollapsed: collapsedMOs.has(moNum)\r\n            });\r\n\r\n            // Add WO rows (if expanded)\r\n            if (!collapsedMOs.has(moNum)) {\r\n                sortedMoWOs.forEach((wo, idx) => {\r\n                    groups.push({\r\n                        id: `mo_${moNum}_wo_${idx}`,\r\n                        name: `  WO ${wo.wo_num}`,\r\n                        type: 'wo-row',\r\n                        moNum: moNum,\r\n                        wos: [wo]\r\n                    });\r\n                });\r\n            }\r\n        });\r\n\r\n        debugLog('info', `MO view: ${moNums.length} MOs, ${groups.filter(g => g.type === 'wo-row').length} WO rows visible`);\r\n    } else {\r\n        // Category view - group by category_name with lane packing for overlapping WOs\r\n        const catNames = [...new Set(displayedWorkOrders.map(wo => wo.category_name))].sort();\r\n        groups = catNames.map(cat => {\r\n            const wo = displayedWorkOrders.find(wo => wo.category_name === cat);\r\n            const categoryWOs = displayedWorkOrders.filter(wo => wo.category_name === cat);\r\n            const laneCount = packWOsIntoLanes(categoryWOs);\r\n\r\n            return {\r\n                id: cat,\r\n                name: cat,\r\n                color: wo?.category_color ? '#' + wo.category_color : '#94a3b8',\r\n                wos: categoryWOs,\r\n                laneCount: laneCount // Number of lanes needed for stacking\r\n            };\r\n        });\r\n        debugLog('info', `Category view: ${groups.length} categories, ${groups.map(g => `${g.name}(${g.wos.length} WOs, ${g.laneCount} lanes)`).join(', ')}`);\r\n    }\r\n\r\n    // Calculate total height based on lane counts\r\n    const totalHeight = groups.reduce((sum, g) => {\r\n        const groupHeight = g.laneCount ? g.laneCount * 35 + 15 : rowHeight; // 35px per lane + 15px padding\r\n        return sum + groupHeight;\r\n    }, 0);\r\n    const height = totalHeight + margin.top + margin.bottom;\r\n\r\n    svg.attr('width', width).attr('height', height);\r\n\r\n    // Scales\r\n    const xScale = d3.scaleTime()\r\n        .domain([ganttStartDate.toDate(), ganttEndDate.toDate()])\r\n        .range([margin.left, width - margin.right]);\r\n\r\n    // Custom yScale for variable-height rows (category view uses lanes)\r\n    const yPositions = new Map();\r\n    const yHeights = new Map();\r\n    let currentY = margin.top;\r\n\r\n    groups.forEach(g => {\r\n        yPositions.set(g.id, currentY);\r\n        const groupHeight = g.laneCount ? g.laneCount * 40 + 15 : rowHeight; // Match capacity planning lane height (40px)\r\n        yHeights.set(g.id, groupHeight);\r\n        currentY += groupHeight;\r\n    });\r\n\r\n    // yScale function that returns position\r\n    const yScale = (id) => yPositions.get(id) || 0;\r\n    yScale.bandwidth = (id) => yHeights.get(id) || rowHeight;\r\n\r\n    // Grid lines only (weekends rendered later)\r\n    const gridGroup = svg.append('g').attr('class', 'grid');\r\n    let currentDay = ganttStartDate.clone();\r\n    while (currentDay.isSameOrBefore(ganttEndDate)) {\r\n        const dayX = xScale(currentDay.toDate());\r\n        const isMonday = currentDay.day() === 1; // ISO week starts on Monday\r\n\r\n        // Grid line - thicker for week starts (Mondays), darker for better visibility\r\n        gridGroup.append('line')\r\n            .attr('x1', dayX)\r\n            .attr('x2', dayX)\r\n            .attr('y1', margin.top)\r\n            .attr('y2', height - margin.bottom)\r\n            .attr('stroke', isMonday ? '#64748b' : '#cbd5e1') // slate-500 for Mondays, slate-300 for others (darker)\r\n            .attr('stroke-width', isMonday ? 2 : 1.5)\r\n            .attr('opacity', 1);\r\n\r\n        currentDay.add(1, 'day');\r\n    }\r\n\r\n    // Row backgrounds with borders\r\n    svg.selectAll('.row-bg')\r\n        .data(groups)\r\n        .enter()\r\n        .append('rect')\r\n        .attr('class', 'row-bg')\r\n        .attr('x', margin.left)\r\n        .attr('y', d => yScale(d.id))\r\n        .attr('width', width - margin.left - margin.right)\r\n        .attr('height', d => yScale.bandwidth(d.id))\r\n        .attr('fill', viewMode === 'category' ? d => d.color || '#6366f1' : (d, i) => i % 2 === 0 ? '#ffffff' : '#f8fafc')\r\n        .attr('fill-opacity', viewMode === 'category' ? 0.2 : 1)\r\n        .attr('stroke', '#cbd5e1')  // slate-300 for darker row borders\r\n        .attr('stroke-width', 1.5)\r\n        .attr('rx', 4);\r\n\r\n    // Weekend highlighting (after row backgrounds to show on top) - matching capacity planning style\r\n    const weekendGroup = svg.append('g').attr('class', 'weekends');\r\n    currentDay = ganttStartDate.clone();\r\n    while (currentDay.isSameOrBefore(ganttEndDate)) {\r\n        if (currentDay.day() === 0 || currentDay.day() === 6) {\r\n            const dayX = xScale(currentDay.toDate());\r\n            weekendGroup.append('rect')\r\n                .attr('x', dayX)\r\n                .attr('y', margin.top)\r\n                .attr('width', dayWidth)\r\n                .attr('height', height - margin.top - margin.bottom)\r\n                .attr('fill', '#fffbeb')  // amber-50 to match capacity planning\r\n                .attr('opacity', 0.5)\r\n                .attr('stroke', '#cbd5e1')  // Add visible borders to weekend columns\r\n                .attr('stroke-width', 1.5)\r\n                .attr('pointer-events', 'none');\r\n        }\r\n        currentDay.add(1, 'day');\r\n    }\r\n\r\n    // Group labels with colored backgrounds for category view\r\n    if (viewMode === 'category') {\r\n        svg.selectAll('.group-label-bg')\r\n            .data(groups)\r\n            .enter()\r\n            .append('rect')\r\n            .attr('class', 'group-label-bg')\r\n            .attr('x', 0)\r\n            .attr('y', d => yScale(d.id))\r\n            .attr('width', margin.left - 15)\r\n            .attr('height', d => yScale.bandwidth(d.id))\r\n            .attr('fill', d => d.color || '#6366f1')\r\n            .attr('fill-opacity', 0.15)\r\n            .attr('stroke', d => d.color || '#6366f1')\r\n            .attr('stroke-width', 2)\r\n            .attr('rx', 4);\r\n    }\r\n\r\n    // Group labels - use HTML overlay for both category and MO views\r\n    const labelsOverlay = document.getElementById('categoryLabelsOverlay');\r\n    if (viewMode === 'category' || viewMode === 'mo') {\r\n        labelsOverlay.style.display = 'block';\r\n        labelsOverlay.style.height = `${height}px`;\r\n        labelsOverlay.innerHTML = '';\r\n\r\n        groups.forEach(group => {\r\n            const labelDiv = document.createElement('div');\r\n\r\n            if (viewMode === 'category') {\r\n                // Category view labels\r\n                labelDiv.style.cssText = `\r\n                    position: absolute;\r\n                    top: ${yScale(group.id)}px;\r\n                    left: 0;\r\n                    width: 185px;\r\n                    height: ${yScale.bandwidth(group.id)}px;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    justify-content: flex-end;\r\n                    padding-right: 10px;\r\n                    background: ${group.color}26;\r\n                    border: 2px solid ${group.color};\r\n                    border-radius: 4px;\r\n                    font-size: 13px;\r\n                    font-weight: 600;\r\n                    color: #1e293b;\r\n                    pointer-events: none;\r\n                `;\r\n                labelDiv.textContent = group.name;\r\n            } else if (viewMode === 'mo') {\r\n                // MO view labels\r\n                const isMOHeader = group.type === 'mo-header';\r\n                const expandIcon = group.isCollapsed ? '▶' : '▼';\r\n                const labelText = isMOHeader ? `${expandIcon} ${group.name}` : `  ${group.name}`;\r\n\r\n                labelDiv.style.cssText = `\r\n                    position: absolute;\r\n                    top: ${yScale(group.id)}px;\r\n                    left: 0;\r\n                    width: 185px;\r\n                    height: ${yScale.bandwidth()}px;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    padding-left: ${isMOHeader ? '8px' : '24px'};\r\n                    background: ${isMOHeader ? '#f59e0b26' : '#ffffff'};\r\n                    border: 1px solid ${isMOHeader ? '#f59e0b' : '#e2e8f0'};\r\n                    border-radius: 4px;\r\n                    font-size: ${isMOHeader ? '13px' : '12px'};\r\n                    font-weight: ${isMOHeader ? '700' : '500'};\r\n                    color: #1e293b;\r\n                    cursor: ${isMOHeader ? 'pointer' : 'default'};\r\n                    pointer-events: ${isMOHeader ? 'auto' : 'none'};\r\n                    overflow: hidden;\r\n                    text-overflow: ellipsis;\r\n                    white-space: nowrap;\r\n                `;\r\n                labelDiv.textContent = labelText;\r\n\r\n                // Add tooltip for MO headers with detailed info\r\n                if (isMOHeader) {\r\n                    const moData = manufacturingOrders.find(mo => mo.mo_num === group.moNum);\r\n                    if (moData) {\r\n                        const moScheduledDate = moData.mo_date_scheduled ? formatDate(moment(moData.mo_date_scheduled)) : 'N/A';\r\n                        const bomInfo = moData.part_num ? `${moData.part_num} x ${moData.qty || '?'}` : 'N/A';\r\n                        labelDiv.title = `MO ${group.moNum}\\nBOM: ${bomInfo}\\nScheduled: ${moScheduledDate}\\nWO Count: ${group.wos.length}`;\r\n                    } else {\r\n                        labelDiv.title = labelText;\r\n                    }\r\n                } else {\r\n                    labelDiv.title = labelText;\r\n                }\r\n\r\n                // Add click handlers for MO headers\r\n                if (isMOHeader) {\r\n                    labelDiv.dataset.moNum = group.moNum;\r\n\r\n                    // Single click: scroll to MO start date\r\n                    let clickTimeout;\r\n                    labelDiv.addEventListener('click', function(e) {\r\n                        clickTimeout = setTimeout(() => {\r\n                            const starts = group.wos.map(wo => moment(wo.date_scheduled_start));\r\n                            const moStart = moment.min(starts);\r\n                            const moStartX = xScale(moStart.toDate());\r\n\r\n                            // Scroll to show the MO start date\r\n                            const wrapper = document.getElementById('ganttWrapper');\r\n                            wrapper.scrollLeft = Math.max(0, moStartX - margin.left - 100);\r\n\r\n                            debugLog('info', `Scrolled to MO ${group.moNum} start date`);\r\n                        }, 250); // Delay to allow double-click detection\r\n                    });\r\n\r\n                    // Double click: toggle collapse/expand\r\n                    labelDiv.addEventListener('dblclick', function(e) {\r\n                        clearTimeout(clickTimeout);\r\n\r\n                        const wasCollapsed = collapsedMOs.has(group.moNum);\r\n\r\n                        if (wasCollapsed) {\r\n                            collapsedMOs.delete(group.moNum);\r\n                            debugLog('info', `Expanded MO ${group.moNum}`);\r\n                            // Set scroll target to MO start date\r\n                            scrollToDateAfterRender = moment(group.start);\r\n                        } else {\r\n                            collapsedMOs.add(group.moNum);\r\n                            debugLog('info', `Collapsed MO ${group.moNum}`);\r\n                        }\r\n\r\n                        renderGanttChart();\r\n                        saveSettingsToDatabase();  // Auto-save collapsed MOs state\r\n                    });\r\n                }\r\n            }\r\n\r\n            labelsOverlay.appendChild(labelDiv);\r\n        });\r\n    } else {\r\n        labelsOverlay.style.display = 'none';\r\n    }\r\n\r\n    // Day column borders - vertical lines for each day to help with alignment (drawn early so they appear behind all tiles)\r\n    const columnBordersGroup = svg.append('g').attr('class', 'day-column-borders');\r\n    let borderDay = ganttStartDate.clone();\r\n    while (borderDay.isSameOrBefore(ganttEndDate)) {\r\n        const dayX = xScale(borderDay.toDate());\r\n        const isToday = borderDay.isSame(moment(), 'day');\r\n\r\n        // Draw vertical line from top to bottom of chart\r\n        columnBordersGroup.append('line')\r\n            .attr('x1', dayX)\r\n            .attr('x2', dayX)\r\n            .attr('y1', 95)  // Start below headers\r\n            .attr('y2', height)  // Extend to bottom of chart\r\n            .attr('stroke', isToday ? '#818CF8' : '#cbd5e1')  // indigo-400 for today, slate-300 for others (darker)\r\n            .attr('stroke-width', isToday ? 2 : 1.5)\r\n            .attr('opacity', 0.7)  // Slightly more opaque for better visibility\r\n            .attr('pointer-events', 'none');  // Don't interfere with mouse events\r\n\r\n        borderDay.add(1, 'day');\r\n    }\r\n\r\n    // MO Header Rows (in MO view only) - drawn BEFORE WO bars\r\n    if (viewMode === 'mo') {\r\n        groups.forEach(group => {\r\n            if (group.type === 'mo-header') {\r\n                // Calculate MO bar span (earliest start to latest end of all WOs)\r\n                const starts = group.wos.map(wo => moment(wo.date_scheduled_start).startOf('day'));\r\n                const ends = group.wos.map(wo => moment(wo.date_scheduled).startOf('day'));\r\n                const moStart = moment.min(starts);\r\n\r\n                // Check for conflicts with MO scheduled date\r\n                const moData = manufacturingOrders.find(mo => mo.mo_num === group.moNum);\r\n                const bomInfo = moData ? `${moData.bom_num || 'N/A'} x ${moData.qty || '?'}` : '';\r\n                let moEnd;\r\n                let hasConflict = false;\r\n                if (moData && moData.mo_date_scheduled) {\r\n                    moEnd = moment(moData.mo_date_scheduled).startOf('day');\r\n                    group.wos.forEach(wo => {\r\n                        if (moment(wo.date_scheduled).startOf('day').isAfter(moEnd)) {\r\n                            hasConflict = true;\r\n                            conflicts.add(wo.wo_id);\r\n                        }\r\n                    });\r\n                } else {\r\n                    moEnd = moment.max(ends);\r\n                }\r\n\r\n                // MO tiles span full days with visual margin\r\n                const tilePadding = dayWidth * 0.08;\r\n                const moX = xScale(moStart.toDate()) + tilePadding;\r\n                const moEndX = xScale(moEnd.clone().add(1, 'day').toDate()) - tilePadding;\r\n                const moWidth = Math.max(20, moEndX - moX);\r\n                const groupY = yScale(group.id);\r\n                const rowHeight = yScale.bandwidth();\r\n\r\n                // Match calendar tile sizing - 20px bar height\r\n                const moHeight = 20;\r\n                const moY = groupY + (rowHeight - moHeight) / 2; // Center vertically in row\r\n\r\n                // MO header bar - orange/amber for MOs, red if conflict\r\n                const moBar = svg.append('rect')\r\n                    .attr('class', 'mo-header-bar')\r\n                    .attr('x', moX)\r\n                    .attr('y', moY)\r\n                    .attr('width', moWidth)\r\n                    .attr('height', moHeight)\r\n                    .attr('rx', 6)\r\n                    .attr('fill', hasConflict ? '#ef4444' : '#f59e0b')\r\n                    .attr('stroke', hasConflict ? '#dc2626' : '#d97706')\r\n                    .attr('stroke-width', 2)\r\n                    .attr('data-mo-num', group.moNum)\r\n                    .style('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))');\r\n\r\n                // Add MO tooltip\r\n                const moTooltipHTML = `\r\n                    <div><span class=\"wo-tooltip-label\">MO:</span><span class=\"wo-tooltip-value\">${group.moNum}</span></div>\r\n                    <div><span class=\"wo-tooltip-label\">BOM:</span><span class=\"wo-tooltip-value\">${bomInfo}</span></div>\r\n                    <div><span class=\"wo-tooltip-label\">Start:</span><span class=\"wo-tooltip-value\">${formatDate(moStart)}</span></div>\r\n                    <div><span class=\"wo-tooltip-label\">Scheduled Finish:</span><span class=\"wo-tooltip-value\">${formatDate(moEnd)}</span></div>\r\n                    <div><span class=\"wo-tooltip-label\">WO Count:</span><span class=\"wo-tooltip-value\">${group.wos.length}</span></div>\r\n                    ${hasConflict ? '<div><span class=\"wo-tooltip-label\">Status:</span><span class=\"wo-tooltip-value\" style=\"color: #ef4444;\">⚠ Conflict - WOs exceed MO date</span></div>' : ''}\r\n                `;\r\n\r\n                moBar.on('mouseover', function(event) {\r\n                    showWOTooltip(event, moTooltipHTML);\r\n                }).on('mouseout', function() {\r\n                    hideWOTooltip();\r\n                }).on('mousemove', function(event) {\r\n                    showWOTooltip(event, moTooltipHTML);\r\n                });\r\n\r\n                // MO label - single line format: \"MO 5 - FG2100 x 3\"\r\n                const moLabelText = `MO ${group.moNum} - ${bomInfo}${hasConflict ? ' ⚠' : ''}`;\r\n                svg.append('text')\r\n                    .attr('x', moX + 10)\r\n                    .attr('y', moY + moHeight / 2 + 4)  // Vertically center\r\n                    .attr('font-size', '11px')\r\n                    .attr('font-weight', '600')\r\n                    .attr('fill', '#1e293b')\r\n                    .attr('pointer-events', 'none')\r\n                    .text(moLabelText);\r\n            }\r\n        });\r\n    }\r\n\r\n    // Month header background\r\n    const monthHeaderGroup = svg.append('g');\r\n    let currentMonth = ganttStartDate.clone().startOf('month');\r\n    const processedMonths = new Set();\r\n\r\n    while (currentMonth.isSameOrBefore(ganttEndDate)) {\r\n        const monthKey = currentMonth.format('YYYY-MM');\r\n        if (!processedMonths.has(monthKey)) {\r\n            processedMonths.add(monthKey);\r\n\r\n            const monthStart = moment.max(currentMonth.clone().startOf('month'), ganttStartDate);\r\n            const monthEnd = moment.min(currentMonth.clone().endOf('month'), ganttEndDate);\r\n\r\n            const monthX = xScale(monthStart.toDate());\r\n            const monthWidth = xScale(monthEnd.toDate()) - monthX + dayWidth;\r\n\r\n            // Month background\r\n            monthHeaderGroup.append('rect')\r\n                .attr('x', monthX)\r\n                .attr('y', 10)\r\n                .attr('width', monthWidth)\r\n                .attr('height', 30)\r\n                .attr('fill', '#f8fafc')\r\n                .attr('stroke', '#e2e8f0')\r\n                .attr('stroke-width', 1);\r\n\r\n            // Month label\r\n            monthHeaderGroup.append('text')\r\n                .attr('x', monthX + monthWidth / 2)\r\n                .attr('y', 28)\r\n                .attr('text-anchor', 'middle')\r\n                .attr('font-size', '14px')\r\n                .attr('font-weight', '700')\r\n                .attr('fill', '#334155')\r\n                .text(currentMonth.format('MMMM YYYY'));\r\n        }\r\n        currentMonth.add(1, 'month');\r\n    }\r\n\r\n    // Day header\r\n    const headerGroup = svg.append('g');\r\n    currentDay = ganttStartDate.clone();\r\n    while (currentDay.isSameOrBefore(ganttEndDate)) {\r\n        const isWeekend = currentDay.day() === 0 || currentDay.day() === 6;\r\n        const dayX = xScale(currentDay.toDate());\r\n\r\n        // Day background\r\n        headerGroup.append('rect')\r\n            .attr('x', dayX)\r\n            .attr('y', 45)\r\n            .attr('width', dayWidth)\r\n            .attr('height', 50)\r\n            .attr('fill', isWeekend ? '#fef3c7' : '#ffffff')\r\n            .attr('stroke', '#e2e8f0')\r\n            .attr('stroke-width', 1);\r\n\r\n        // Day label\r\n        headerGroup.append('text')\r\n            .attr('x', dayX + dayWidth / 2)\r\n            .attr('y', 62)\r\n            .attr('text-anchor', 'middle')\r\n            .attr('font-size', '12px')\r\n            .attr('font-weight', isWeekend ? '700' : '600')\r\n            .attr('fill', isWeekend ? '#92400e' : '#64748b')\r\n            .text(currentDay.format('ddd'));\r\n\r\n        // Date number\r\n        headerGroup.append('text')\r\n            .attr('x', dayX + dayWidth / 2)\r\n            .attr('y', 62)\r\n            .attr('dy', '1.1em')\r\n            .attr('text-anchor', 'middle')\r\n            .attr('font-size', '11px')\r\n            .attr('font-weight', '500')\r\n            .attr('fill', isWeekend ? '#92400e' : '#94a3b8')\r\n            .text(currentDay.format('D'));\r\n\r\n        currentDay.add(1, 'day');\r\n    }\r\n\r\n    // WO Bars\r\n    groups.forEach(group => {\r\n        // Skip MO header rows - they're rendered above\r\n        if (group.type === 'mo-header') return;\r\n\r\n        group.wos.forEach(wo => {\r\n            const start = moment(wo.date_scheduled_start).startOf('day');\r\n            const end = moment(wo.date_scheduled).startOf('day');\r\n\r\n            // Visual margin for better appearance\r\n            const tilePadding = dayWidth * 0.08; // 8% margin on each side\r\n\r\n            // Default: span from start of day to end of day with margins\r\n            let startX = xScale(start.toDate()) + tilePadding;\r\n            let endX = xScale(end.clone().add(1, 'day').toDate()) - tilePadding;\r\n\r\n            // Check for same-day dependencies\r\n            const stagingDep = stagingDependencies.find(d => d.wo_id === wo.wo_id);\r\n            const dependentDep = stagingDependencies.find(d => d.staging_wo_id === wo.wo_id);\r\n\r\n            if (stagingDep) {\r\n                const stagingWO = filteredWorkOrders.find(w => w.wo_id === stagingDep.staging_wo_id);\r\n                if (stagingWO) {\r\n                    const stagingEnd = moment(stagingWO.date_scheduled).startOf('day');\r\n                    // If staging WO ends same day this WO starts, position from midday\r\n                    if (stagingEnd.isSame(start, 'day')) {\r\n                        startX = xScale(start.toDate()) + dayWidth / 2 + tilePadding;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (dependentDep) {\r\n                const dependentWO = filteredWorkOrders.find(w => w.wo_id === dependentDep.wo_id);\r\n                if (dependentWO) {\r\n                    const dependentStart = moment(dependentWO.date_scheduled_start).startOf('day');\r\n                    // If dependent WO starts same day this WO ends, position to midday\r\n                    if (dependentStart.isSame(end, 'day')) {\r\n                        endX = xScale(end.toDate()) + dayWidth / 2 - tilePadding;\r\n                    }\r\n                }\r\n            }\r\n\r\n            const x = startX;\r\n            const barWidth = Math.max(10, endX - startX);\r\n\r\n            // Calculate y position and bar height - match capacity planning sizing (35px bars)\r\n            let y, barHeight;\r\n            if (viewMode === 'category' && wo._lane !== undefined) {\r\n                const groupY = yScale(group.id);\r\n                const laneHeight = 40; // Match capacity planning lane spacing\r\n                y = groupY + (wo._lane * laneHeight) + 2.5; // 2.5px padding for centering\r\n                barHeight = 20; // Match calendar tile height\r\n            } else {\r\n                // MO view: center 20px bar within row\r\n                const groupY = yScale(group.id);\r\n                const rowHeight = yScale.bandwidth(group.id);\r\n                barHeight = 20; // Match calendar tile height\r\n                y = groupY + (rowHeight - barHeight) / 2; // Center vertically in row\r\n            }\r\n\r\n            // Use standard color scheme\r\n            const colors = WO_STATUS_COLORS[wo.wo_status] || WO_STATUS_COLORS[10];\r\n\r\n            // Bar with tooltip - compact styling to match capacity planning\r\n            const bar = svg.append('rect')\r\n                .attr('class', 'wo-bar')\r\n                .attr('x', x)\r\n                .attr('y', y)\r\n                .attr('width', barWidth)\r\n                .attr('height', barHeight)\r\n                .attr('rx', 4)\r\n                .attr('fill', colors.fill)\r\n                .attr('stroke', colors.stroke)\r\n                .attr('stroke-width', 2)\r\n                .attr('data-wo-id', wo.wo_id)\r\n                .attr('data-wo-num', wo.wo_num);\r\n\r\n            // Add custom CSS tooltip with BOM, Qty, dates, and category\r\n            const statusName = wo.wo_status === 10 ? 'Entered' : wo.wo_status === 30 ? 'Started' : wo.wo_status === 40 ? 'Fulfilled' : 'Unknown';\r\n            // Use WO's specific part number and quantity (not MO's BOM)\r\n            const bomInfo = wo.part_num ? `${wo.part_num} x ${wo.qty_target || '?'}` : 'N/A';\r\n            const tooltipHTML = `\r\n                <div><span class=\"wo-tooltip-label\">WO:</span><span class=\"wo-tooltip-value\">${wo.wo_num}</span></div>\r\n                <div><span class=\"wo-tooltip-label\">MO:</span><span class=\"wo-tooltip-value\">${wo.mo_num}</span></div>\r\n                <div><span class=\"wo-tooltip-label\">Category:</span><span class=\"wo-tooltip-value\">${wo.category_name || 'Uncategorized'}</span></div>\r\n                <div><span class=\"wo-tooltip-label\">BOM:</span><span class=\"wo-tooltip-value\">${bomInfo}</span></div>\r\n                <div><span class=\"wo-tooltip-label\">Status:</span><span class=\"wo-tooltip-value\">${statusName}</span></div>\r\n                <div><span class=\"wo-tooltip-label\">Start:</span><span class=\"wo-tooltip-value\">${formatDate(start, true)}</span></div>\r\n                <div><span class=\"wo-tooltip-label\">Finish:</span><span class=\"wo-tooltip-value\">${formatDate(end, true)}</span></div>\r\n            `;\r\n\r\n            // Add tooltip events\r\n            bar.on('mouseover', function(event) {\r\n                showWOTooltip(event, tooltipHTML);\r\n            }).on('mouseout', function() {\r\n                hideWOTooltip();\r\n            }).on('mousemove', function(event) {\r\n                showWOTooltip(event, tooltipHTML);\r\n            });\r\n\r\n            // Add arrow highlighting on hover\r\n            bar.on('mouseenter', function() {\r\n                const woId = wo.wo_id;\r\n                // Find and highlight all arrows connected to this WO (source or target)\r\n                svg.selectAll('.dependency-arrow')\r\n                    .filter(function() {\r\n                        const sourceId = parseInt(d3.select(this).attr('data-source-wo-id'));\r\n                        const targetId = parseInt(d3.select(this).attr('data-target-wo-id'));\r\n                        return sourceId === woId || targetId === woId;\r\n                    })\r\n                    .attr('stroke-width', 2.5)\r\n                    .attr('opacity', 0.9);\r\n            }).on('mouseleave', function() {\r\n                // Reset all arrows to light state\r\n                svg.selectAll('.dependency-arrow')\r\n                    .attr('stroke-width', 1.5)\r\n                    .attr('opacity', 0.25);\r\n            });\r\n\r\n            // Add drag behavior\r\n            let isDragging = false;\r\n            let dragStartX = 0;\r\n\r\n            const drag = d3.drag()\r\n                .on('start', function(event) {\r\n                    isDragging = false;\r\n                    dragStartX = event.x;\r\n\r\n                    d3.select(this)\r\n                        .classed('dragging', true);\r\n\r\n                    // Don't change opacity during drag - let hover classes handle it\r\n                })\r\n                .on('drag', function(event) {\r\n                    // Only consider it a drag if moved more than 5 pixels\r\n                    if (Math.abs(event.x - dragStartX) > 5) {\r\n                        isDragging = true;\r\n                    }\r\n\r\n                    if (isDragging) {\r\n                        const newX = Math.max(margin.left, event.x);\r\n                        d3.select(this).attr('x', newX);\r\n\r\n                        // Update label position\r\n                        const labelElement = d3.select(this.nextSibling);\r\n                        labelElement.attr('x', newX + 8);\r\n                    }\r\n                })\r\n                .on('end', async function(event) {\r\n                    d3.select(this)\r\n                        .classed('dragging', false);\r\n\r\n                    // Only save if actually dragged\r\n                    if (!isDragging) {\r\n                        // Reset position\r\n                        d3.select(this).attr('x', x);\r\n                        const labelElement = d3.select(this.nextSibling);\r\n                        labelElement.attr('x', x + 8);\r\n                        return;\r\n                    }\r\n\r\n                    // Add to undo stack only on actual drag\r\n                    undoStack.push(captureState());\r\n                    if (undoStack.length > MAX_UNDO_STACK) {\r\n                        undoStack.shift();\r\n                    }\r\n                    redoStack = [];\r\n                    updateUndoRedoButtons();\r\n\r\n                    const newX = Math.max(margin.left, event.x);\r\n                    const newStartDate = xScale.invert(newX);\r\n                    let newStart = moment(newStartDate).startOf('day');\r\n\r\n                    // Apply skip weekends if enabled\r\n                    newStart = moment(applySkipWeekends(newStart.toDate()));\r\n\r\n                    // Calculate duration and new end date\r\n                    const duration = moment(wo.date_scheduled).diff(moment(wo.date_scheduled_start), 'days');\r\n                    let newEnd = newStart.clone().add(duration, 'days');\r\n\r\n                    // Apply skip weekends to end date as well\r\n                    newEnd = moment(applySkipWeekends(newEnd.toDate()));\r\n\r\n                    const woNum = d3.select(this).attr('data-wo-num');\r\n                    debugLog('info', `Dropped WO ${woNum}: ${newStart.format('YYYY-MM-DD')} to ${newEnd.format('YYYY-MM-DD')}`);\r\n\r\n                    // Update in Fishbowl\r\n                    await saveWODates(woNum, newStart.format('YYYY-MM-DD'), newEnd.format('YYYY-MM-DD'));\r\n\r\n                    // Shift dependent WOs if setting is enabled\r\n                    if (shiftDependentWOs) {\r\n                        const daysDiff = newStart.diff(moment(wo.date_scheduled_start), 'days');\r\n                        if (daysDiff !== 0) {\r\n                            // Find all WOs that depend on this WO (where this WO is the staging_wo_id)\r\n                            const dependentRelations = stagingDependencies.filter(dep => dep.staging_wo_id === wo.wo_id);\r\n\r\n                            for (const relation of dependentRelations) {\r\n                                const dependentWO = allWorkOrders.find(w => w.wo_id === relation.wo_id);\r\n                                if (dependentWO) {\r\n                                    let depStart = moment(dependentWO.date_scheduled_start).add(daysDiff, 'days');\r\n                                    let depEnd = moment(dependentWO.date_scheduled).add(daysDiff, 'days');\r\n\r\n                                    // Apply skip weekends to dependent WOs as well\r\n                                    depStart = moment(applySkipWeekends(depStart.toDate()));\r\n                                    depEnd = moment(applySkipWeekends(depEnd.toDate()));\r\n\r\n                                    debugLog('info', `Shifting dependent WO ${dependentWO.wo_num} by ${daysDiff} days: ${depStart.format('YYYY-MM-DD')} to ${depEnd.format('YYYY-MM-DD')}`);\r\n                                    await saveWODates(dependentWO.wo_num, depStart.format('YYYY-MM-DD'), depEnd.format('YYYY-MM-DD'));\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n\r\n            bar.call(drag);\r\n\r\n            // Double-click to open WO in Fishbowl\r\n            bar.on('dblclick', function() {\r\n                debugLog('info', `Opening WO ${wo.wo_num} in Fishbowl...`);\r\n                try {\r\n                    if (typeof openModule === 'function') {\r\n                        openModule('Work Order', wo.wo_num);\r\n                        showToast(`Opening WO ${wo.wo_num}`, 'info');\r\n                    } else {\r\n                        debugLog('warn', 'openModule function not available in Fishbowl');\r\n                        showToast('Cannot open WO - not running in Fishbowl', 'error');\r\n                    }\r\n                } catch (error) {\r\n                    debugLog('error', 'Error opening WO:', error);\r\n                    showToast('Error opening WO: ' + error.message, 'error');\r\n                }\r\n            });\r\n\r\n            // Label - single line format: \"WO 5:001 - FG2100 x 3\"\r\n            const labelText = `WO ${wo.wo_num} - ${bomInfo}`;\r\n            const label = svg.append('text')\r\n                .attr('x', x + 8)\r\n                .attr('y', y + barHeight / 2 + 4)  // Vertically center\r\n                .attr('font-size', '11px')\r\n                .attr('font-weight', '600')\r\n                .attr('fill', '#1e293b')\r\n                .attr('pointer-events', 'none')\r\n                .text(labelText);\r\n\r\n            // Left resize handle\r\n            const handleWidth = 8;\r\n            const leftHandle = svg.append('rect')\r\n                .attr('class', 'resize-handle-left')\r\n                .attr('x', x)\r\n                .attr('y', y)\r\n                .attr('width', handleWidth)\r\n                .attr('height', barHeight)\r\n                .attr('fill', 'transparent')\r\n                .style('cursor', 'ew-resize');\r\n\r\n            const leftDrag = d3.drag()\r\n                .on('start', function() {\r\n                    d3.select(this).style('fill', 'rgba(255,255,255,0.3)');\r\n                })\r\n                .on('drag', function(event) {\r\n                    const newX = Math.max(margin.left, Math.min(event.x, x + barWidth - 20));\r\n                    const newWidth = barWidth + (x - newX);\r\n\r\n                    bar.attr('x', newX).attr('width', newWidth);\r\n                    d3.select(this).attr('x', newX);\r\n                    label.attr('x', newX + 8);\r\n                })\r\n                .on('end', async function(event) {\r\n                    d3.select(this).style('fill', 'transparent');\r\n\r\n                    const newX = Math.max(margin.left, Math.min(event.x, x + barWidth - 20));\r\n                    const newStartDate = xScale.invert(newX);\r\n                    let newStart = moment(newStartDate).startOf('day');\r\n\r\n                    const woNum = wo.wo_num;\r\n                    const currentEnd = moment(wo.date_scheduled).format('YYYY-MM-DD');\r\n                    debugLog('info', `Resized WO ${woNum} start: ${newStart.format('YYYY-MM-DD')}`);\r\n\r\n                    undoStack.push(captureState());\r\n                    if (undoStack.length > MAX_UNDO_STACK) undoStack.shift();\r\n                    redoStack = [];\r\n                    updateUndoRedoButtons();\r\n\r\n                    await saveWODates(woNum, newStart.format('YYYY-MM-DD'), currentEnd);\r\n                });\r\n\r\n            leftHandle.call(leftDrag);\r\n\r\n            // Right resize handle\r\n            const rightHandle = svg.append('rect')\r\n                .attr('class', 'resize-handle-right')\r\n                .attr('x', x + barWidth - handleWidth)\r\n                .attr('y', y)\r\n                .attr('width', handleWidth)\r\n                .attr('height', barHeight)\r\n                .attr('fill', 'transparent')\r\n                .style('cursor', 'ew-resize');\r\n\r\n            const rightDrag = d3.drag()\r\n                .on('start', function() {\r\n                    d3.select(this).style('fill', 'rgba(255,255,255,0.3)');\r\n                })\r\n                .on('drag', function(event) {\r\n                    const newWidth = Math.max(20, event.x - x);\r\n                    bar.attr('width', newWidth);\r\n                    d3.select(this).attr('x', x + newWidth - handleWidth);\r\n                })\r\n                .on('end', async function(event) {\r\n                    d3.select(this).style('fill', 'transparent');\r\n\r\n                    const newWidth = Math.max(20, event.x - x);\r\n                    const newEndX = x + newWidth;\r\n                    const newEndDate = xScale.invert(newEndX);\r\n                    let newEnd = moment(newEndDate).startOf('day');\r\n\r\n                    const woNum = wo.wo_num;\r\n                    const currentStart = moment(wo.date_scheduled_start).format('YYYY-MM-DD');\r\n                    debugLog('info', `Resized WO ${woNum} end: ${newEnd.format('YYYY-MM-DD')}`);\r\n\r\n                    undoStack.push(captureState());\r\n                    if (undoStack.length > MAX_UNDO_STACK) undoStack.shift();\r\n                    redoStack = [];\r\n                    updateUndoRedoButtons();\r\n\r\n                    await saveWODates(woNum, currentStart, newEnd.format('YYYY-MM-DD'));\r\n                });\r\n\r\n            rightHandle.call(rightDrag);\r\n        });\r\n    });\r\n\r\n    // Dependency Arrows\r\n    // Defer arrow rendering to next frame to ensure tiles are fully laid out\r\n    if (showArrows && stagingDependencies.length > 0) {\r\n        requestAnimationFrame(() => {\r\n            const arrowGroup = svg.append('g').attr('class', 'arrows');\r\n\r\n        stagingDependencies.forEach(dep => {\r\n            // Find the WO bars for source and target\r\n            const sourceWO = filteredWorkOrders.find(wo => wo.wo_id === dep.staging_wo_id);\r\n            const targetWO = filteredWorkOrders.find(wo => wo.wo_id === dep.wo_id);\r\n\r\n            if (!sourceWO || !targetWO) return;\r\n\r\n            // Find groups differently based on view mode\r\n            let sourceGroup, targetGroup;\r\n            if (viewMode === 'mo') {\r\n                // In MO view, find the WO row (not MO header) that contains this WO\r\n                sourceGroup = groups.find(g => g.type === 'wo-row' && g.wos.some(wo => wo.wo_id === sourceWO.wo_id));\r\n                targetGroup = groups.find(g => g.type === 'wo-row' && g.wos.some(wo => wo.wo_id === targetWO.wo_id));\r\n            } else {\r\n                // In category view, group by category name\r\n                sourceGroup = groups.find(g => g.id === sourceWO.category_name);\r\n                targetGroup = groups.find(g => g.id === targetWO.category_name);\r\n            }\r\n\r\n            if (!sourceGroup || !targetGroup) return;\r\n\r\n            // Calculate tile edge positions (matching tile rendering logic exactly)\r\n            const tilePadding = dayWidth * 0.08;\r\n\r\n            // Source tile end (right edge)\r\n            const sourceEndDate = moment(sourceWO.date_scheduled).startOf('day');\r\n            let sourceEnd = xScale(sourceEndDate.clone().add(1, 'day').toDate()) - tilePadding;\r\n\r\n            // Check if source has a dependent WO that starts same day it ends (same-day logic)\r\n            const sourceDependentDep = stagingDependencies.find(d => d.staging_wo_id === sourceWO.wo_id);\r\n            if (sourceDependentDep) {\r\n                const sourceDependentWO = filteredWorkOrders.find(w => w.wo_id === sourceDependentDep.wo_id);\r\n                if (sourceDependentWO) {\r\n                    const dependentStart = moment(sourceDependentWO.date_scheduled_start).startOf('day');\r\n                    // If dependent WO starts same day this WO ends, position to midday\r\n                    if (dependentStart.isSame(sourceEndDate, 'day')) {\r\n                        sourceEnd = xScale(sourceEndDate.toDate()) + dayWidth / 2 - tilePadding;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Target tile start (left edge)\r\n            const targetStartDate = moment(targetWO.date_scheduled_start).startOf('day');\r\n            let targetStart = xScale(targetStartDate.toDate()) + tilePadding;\r\n\r\n            // Check if target has a staging dependency that ends same day it starts (same-day logic)\r\n            const targetStagingDep = stagingDependencies.find(d => d.wo_id === targetWO.wo_id);\r\n            if (targetStagingDep) {\r\n                const targetStagingWO = filteredWorkOrders.find(w => w.wo_id === targetStagingDep.staging_wo_id);\r\n                if (targetStagingWO) {\r\n                    const stagingEnd = moment(targetStagingWO.date_scheduled).startOf('day');\r\n                    // If staging WO ends same day this WO starts, position from midday\r\n                    if (stagingEnd.isSame(targetStartDate, 'day')) {\r\n                        targetStart = xScale(targetStartDate.toDate()) + dayWidth / 2 + tilePadding;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Calculate Y position accounting for lanes and bar sizes\r\n            let sourceY, targetY;\r\n            const barHeight = 20; // Match calendar tile height\r\n\r\n            if (viewMode === 'category' && sourceWO._lane !== undefined) {\r\n                const groupY = yScale(sourceGroup.id);\r\n                const laneHeight = 40; // Match capacity planning\r\n                sourceY = groupY + (sourceWO._lane * laneHeight) + 2.5 + (barHeight / 2);\r\n            } else {\r\n                // MO view: center of 35px bar within row\r\n                const groupY = yScale(sourceGroup.id);\r\n                const rowHeight = yScale.bandwidth(sourceGroup.id);\r\n                sourceY = groupY + (rowHeight - barHeight) / 2 + (barHeight / 2);\r\n            }\r\n\r\n            if (viewMode === 'category' && targetWO._lane !== undefined) {\r\n                const groupY = yScale(targetGroup.id);\r\n                const laneHeight = 40; // Match capacity planning\r\n                targetY = groupY + (targetWO._lane * laneHeight) + 2.5 + (barHeight / 2);\r\n            } else {\r\n                // MO view: center of 35px bar within row\r\n                const groupY = yScale(targetGroup.id);\r\n                const rowHeight = yScale.bandwidth(targetGroup.id);\r\n                targetY = groupY + (rowHeight - barHeight) / 2 + (barHeight / 2);\r\n            }\r\n\r\n            // Check for conflict based on allowSameDayStarts setting\r\n            const sourceFinish = sourceEndDate;\r\n            const targetStartDay = targetStartDate;\r\n\r\n            let isConflict;\r\n            if (allowSameDayStarts) {\r\n                // Allow same-day: only conflict if source finishes AFTER target starts\r\n                isConflict = sourceFinish.isAfter(targetStartDay);\r\n            } else {\r\n                // Don't allow same-day: conflict if source finishes on or after target starts\r\n                isConflict = sourceFinish.isSameOrAfter(targetStartDay);\r\n            }\r\n\r\n            const arrowColor = isConflict ? '#ef4444' : '#64748b';\r\n\r\n            // Draw arrow path\r\n            let path;\r\n\r\n            // Check if WOs end and start on the same day\r\n            if (sourceEnd >= targetStart) {\r\n                // Same-day: draw L-shape going straight down then left\r\n                path = `M ${sourceEnd},${sourceY}\r\n                       L ${sourceEnd},${targetY}\r\n                       L ${targetStart},${targetY}`;\r\n            } else {\r\n                // Normal case: source ends before target starts\r\n                const midX = (sourceEnd + targetStart) / 2;\r\n                path = `M ${sourceEnd},${sourceY}\r\n                       L ${midX},${sourceY}\r\n                       L ${midX},${targetY}\r\n                       L ${targetStart},${targetY}`;\r\n            }\r\n\r\n            arrowGroup.append('path')\r\n                .attr('d', path)\r\n                .attr('stroke', arrowColor)\r\n                .attr('stroke-width', 1.5)\r\n                .attr('fill', 'none')\r\n                .attr('marker-end', `url(#arrow-${isConflict ? 'conflict' : 'normal'})`)\r\n                .attr('opacity', 0.25)  // Lighter by default\r\n                .attr('class', isConflict ? 'dependency-arrow conflict' : 'dependency-arrow')\r\n                .attr('data-source-wo-id', dep.staging_wo_id)\r\n                .attr('data-target-wo-id', dep.wo_id);  // Track both source and target\r\n\r\n            // Track conflicts\r\n            if (isConflict) {\r\n                conflicts.add(dep.wo_id);\r\n                conflicts.add(dep.staging_wo_id);\r\n            }\r\n        });\r\n\r\n        // Define arrow markers\r\n        const defs = svg.append('defs');\r\n\r\n        // Normal arrow\r\n        defs.append('marker')\r\n            .attr('id', 'arrow-normal')\r\n            .attr('viewBox', '0 0 10 10')\r\n            .attr('refX', 9)\r\n            .attr('refY', 5)\r\n            .attr('markerWidth', 6)\r\n            .attr('markerHeight', 6)\r\n            .attr('orient', 'auto')\r\n            .append('path')\r\n            .attr('d', 'M 0 0 L 10 5 L 0 10 z')\r\n            .attr('fill', '#64748b');\r\n\r\n        // Conflict arrow\r\n        defs.append('marker')\r\n            .attr('id', 'arrow-conflict')\r\n            .attr('viewBox', '0 0 10 10')\r\n            .attr('refX', 9)\r\n            .attr('refY', 5)\r\n            .attr('markerWidth', 6)\r\n            .attr('markerHeight', 6)\r\n            .attr('orient', 'auto')\r\n            .append('path')\r\n            .attr('d', 'M 0 0 L 10 5 L 0 10 z')\r\n            .attr('fill', '#ef4444');\r\n\r\n        // Highlight conflicted WO bars\r\n        svg.selectAll('.wo-bar').each(function() {\r\n            const woId = parseInt(d3.select(this).attr('data-wo-id'));\r\n            if (conflicts.has(woId)) {\r\n                d3.select(this)\r\n                    .attr('stroke', '#ef4444')\r\n                    .attr('stroke-width', 3);\r\n            }\r\n        });\r\n\r\n            debugLog('success', `Gantt chart rendered with ${filteredWorkOrders.length} WOs, ${stagingDependencies.length} dependencies, ${conflicts.size} conflicts`);\r\n        });\r\n    } else {\r\n        debugLog('success', `Gantt chart rendered with ${filteredWorkOrders.length} WOs, no dependencies or arrows disabled`);\r\n    }\r\n\r\n    // Setup sticky labels on scroll (for category and MO views)\r\n    if (viewMode === 'category' || viewMode === 'mo') {\r\n        setupStickyLabels(groups, yScale);\r\n    }\r\n\r\n    // Setup pan and zoom\r\n    setupGanttPanZoom();\r\n\r\n    // Scroll to specific date if requested (e.g., after MO expansion)\r\n    if (scrollToDateAfterRender) {\r\n        const wrapper = document.getElementById('ganttWrapper');\r\n        const targetX = xScale(scrollToDateAfterRender.toDate());\r\n        const viewportWidth = wrapper.clientWidth;\r\n        const scrollTarget = Math.max(0, targetX - viewportWidth / 2);\r\n\r\n        // Use setTimeout to ensure DOM is fully updated\r\n        setTimeout(() => {\r\n            wrapper.scrollLeft = scrollTarget;\r\n            debugLog('info', `Scrolled to date: ${scrollToDateAfterRender.format('MMM D, YYYY')}`);\r\n        }, 100);\r\n\r\n        // Clear the scroll target\r\n        scrollToDateAfterRender = null;\r\n    }\r\n    // Scroll to current week when MO view loads (unless skipAutoScroll flag is set or we just scrolled to a specific date)\r\n    else if (viewMode === 'mo' && !window.skipAutoScroll) {\r\n        const wrapper = document.getElementById('ganttWrapper');\r\n        const currentWeekStart = moment().startOf('isoWeek'); // Monday of current week\r\n        const todayX = xScale(currentWeekStart.toDate());\r\n\r\n        // Center the current week in the viewport\r\n        const viewportWidth = wrapper.clientWidth;\r\n        const scrollTarget = Math.max(0, todayX - viewportWidth / 2);\r\n\r\n        // Use setTimeout to ensure DOM is fully updated\r\n        setTimeout(() => {\r\n            wrapper.scrollLeft = scrollTarget;\r\n            debugLog('info', `Scrolled MO view to current week (${currentWeekStart.format('MMM D, YYYY')})`);\r\n        }, 100);\r\n    }\r\n}\r\n\r\n// ============================================\r\n// STICKY LABELS (CATEGORY AND MO VIEWS)\r\n// ============================================\r\nfunction setupStickyLabels(groups, yScale) {\r\n    const wrapper = document.getElementById('ganttWrapper');\r\n    const overlay = document.getElementById('categoryLabelsOverlay');\r\n\r\n    // Remove existing scroll listener to avoid duplicates\r\n    const existingListener = wrapper._categoryScrollListener;\r\n    if (existingListener) {\r\n        wrapper.removeEventListener('scroll', existingListener);\r\n    }\r\n\r\n    // Scroll handler to keep labels fixed on the left during horizontal scroll\r\n    const scrollHandler = () => {\r\n        const scrollLeft = wrapper.scrollLeft;\r\n        // Update overlay position to compensate for horizontal scroll\r\n        overlay.style.left = `${scrollLeft}px`;\r\n    };\r\n\r\n    // Attach scroll listener\r\n    wrapper.addEventListener('scroll', scrollHandler);\r\n    wrapper._categoryScrollListener = scrollHandler;\r\n\r\n    // Initial call to position labels correctly\r\n    scrollHandler();\r\n}\r\n\r\n// ============================================\r\n// PAN AND ZOOM\r\n// ============================================\r\nfunction setupGanttPanZoom() {\r\n    const wrapper = document.getElementById('ganttWrapper');\r\n\r\n    // Pan (click and drag to scroll)\r\n    let isPanning = false;\r\n    let startX = 0;\r\n    let startY = 0;\r\n    let scrollLeft = 0;\r\n    let scrollTop = 0;\r\n\r\n    wrapper.addEventListener('mousedown', (e) => {\r\n        // Don't pan if clicking on a WO bar or resize handle\r\n        if (e.target.closest('.wo-bar') || e.target.classList.contains('resize-handle-left') || e.target.classList.contains('resize-handle-right')) {\r\n            return;\r\n        }\r\n\r\n        isPanning = true;\r\n        startX = e.pageX - wrapper.offsetLeft;\r\n        startY = e.pageY - wrapper.offsetTop;\r\n        scrollLeft = wrapper.scrollLeft;\r\n        scrollTop = wrapper.scrollTop;\r\n        wrapper.style.cursor = 'grabbing';\r\n    });\r\n\r\n    wrapper.addEventListener('mouseleave', () => {\r\n        isPanning = false;\r\n        wrapper.style.cursor = 'default';\r\n    });\r\n\r\n    wrapper.addEventListener('mouseup', () => {\r\n        isPanning = false;\r\n        wrapper.style.cursor = 'default';\r\n    });\r\n\r\n    wrapper.addEventListener('mousemove', (e) => {\r\n        if (!isPanning) return;\r\n        e.preventDefault();\r\n\r\n        const x = e.pageX - wrapper.offsetLeft;\r\n        const y = e.pageY - wrapper.offsetTop;\r\n        const walkX = (x - startX) * 2; // Scroll speed\r\n        const walkY = (y - startY) * 2;\r\n\r\n        wrapper.scrollLeft = scrollLeft - walkX;\r\n        wrapper.scrollTop = scrollTop - walkY;\r\n    });\r\n\r\n}\r\n\r\n// ============================================\r\n// ZOOM CONTROLS\r\n// ============================================\r\nfunction zoomIn() {\r\n    ganttScale = Math.min(200, ganttScale + 20);\r\n    renderGanttChart();\r\n    saveSettingsToDatabase();  // Auto-save zoom level\r\n}\r\n\r\nfunction zoomOut() {\r\n    ganttScale = Math.max(40, ganttScale - 20);\r\n    renderGanttChart();\r\n    saveSettingsToDatabase();  // Auto-save zoom level\r\n}\r\n\r\n// ============================================\r\n// DATE NAVIGATION\r\n// ============================================\r\nfunction prevWeek() {\r\n    // Move to previous Monday\r\n    ganttStartDate = ganttStartDate.clone().subtract(7, 'days').startOf('isoWeek');\r\n    // Keep same range duration\r\n    const rangeDays = ganttEndDate.diff(ganttStartDate, 'days');\r\n    ganttEndDate = ganttStartDate.clone().add(rangeDays, 'days');\r\n    renderGanttChart();\r\n}\r\n\r\nfunction nextWeek() {\r\n    // Move to next Monday\r\n    ganttStartDate = ganttStartDate.clone().add(7, 'days').startOf('isoWeek');\r\n    // Keep same range duration\r\n    const rangeDays = ganttEndDate.diff(ganttStartDate, 'days');\r\n    ganttEndDate = ganttStartDate.clone().add(rangeDays, 'days');\r\n    renderGanttChart();\r\n}\r\n\r\nfunction goToToday() {\r\n    // Calculate current range duration\r\n    const rangeDays = ganttEndDate.diff(ganttStartDate, 'days');\r\n\r\n    // Center the current range on this week's Monday\r\n    ganttStartDate = moment().startOf('isoWeek');\r\n    ganttEndDate = ganttStartDate.clone().add(rangeDays, 'days');\r\n\r\n    // Set scroll target to today\r\n    scrollToDateAfterRender = moment().startOf('day');\r\n\r\n    renderGanttChart();\r\n}\r\n\r\nfunction setTimeRange(days) {\r\n    // Adjust zoom scale to fit specified days in viewport\r\n    // Viewport width is roughly 1200px (common container width)\r\n    const viewportWidth = document.getElementById('ganttWrapper').clientWidth || 1200;\r\n    const margin = 200; // left margin for labels\r\n    const availableWidth = viewportWidth - margin;\r\n\r\n    // Calculate scale to fit days in available width\r\n    ganttScale = Math.max(40, Math.min(200, availableWidth / days));\r\n\r\n    renderGanttChart();\r\n    debugLog('info', `Zoom adjusted to fit ${days} days (scale: ${ganttScale.toFixed(1)}px/day)`);\r\n}\r\n\r\n// ============================================\r\n// TOGGLE SETTINGS\r\n// ============================================\r\nfunction toggleArrows() {\r\n    showArrows = !showArrows;\r\n    const btn = document.getElementById('toggleArrowsBtn');\r\n    if (showArrows) {\r\n        btn.querySelector('svg').classList.remove('text-slate-400');\r\n        btn.querySelector('svg').classList.add('text-emerald-600');\r\n    } else {\r\n        btn.querySelector('svg').classList.remove('text-emerald-600');\r\n        btn.querySelector('svg').classList.add('text-slate-400');\r\n    }\r\n    renderGanttChart();\r\n    debugLog('info', `Dependency arrows ${showArrows ? 'enabled' : 'disabled'}`);\r\n}\r\n\r\n// ============================================\r\n// CAPACITY PLANNING VIEW\r\n// ============================================\r\nfunction buildCapacityTable(weekStart) {\r\n    debugLog('info', 'Building capacity table...');\r\n    // Placeholder - will implement full capacity table\r\n    const container = document.getElementById('capacityTable');\r\n    container.innerHTML = `\r\n        <thead>\r\n            <tr class=\"bg-slate-50\">\r\n                <th class=\"p-4 text-left font-semibold text-slate-700\">Category</th>\r\n                ${[0,1,2,3,4,5,6].map(day => `\r\n                    <th class=\"p-4 text-center font-semibold text-slate-700\">\r\n                        ${weekStart.clone().add(day, 'days').format('ddd D')}\r\n                    </th>\r\n                `).join('')}\r\n            </tr>\r\n        </thead>\r\n        <tbody>\r\n            <tr>\r\n                <td colspan=\"8\" class=\"p-8 text-center text-slate-400\">\r\n                    Capacity planning table coming soon...\r\n                </td>\r\n            </tr>\r\n        </tbody>\r\n    `;\r\n\r\n    const display = document.getElementById('capacityWeekDisplay');\r\n    display.textContent = `${weekStart.format('MMM D')} - ${weekStart.clone().add(6, 'days').format('MMM D, YYYY')}`;\r\n}\r\n\r\n// ============================================\r\n// UNDO/REDO\r\n// ============================================\r\nfunction undo() {\r\n    if (undoStack.length === 0) return;\r\n    const state = undoStack.pop();\r\n    redoStack.push(captureState());\r\n    restoreState(state);\r\n    updateUndoRedoButtons();\r\n}\r\n\r\nfunction redo() {\r\n    if (redoStack.length === 0) return;\r\n    const state = redoStack.pop();\r\n    undoStack.push(captureState());\r\n    restoreState(state);\r\n    updateUndoRedoButtons();\r\n}\r\n\r\nfunction captureState() {\r\n    return JSON.stringify(allWorkOrders);\r\n}\r\n\r\nfunction restoreState(state) {\r\n    allWorkOrders = JSON.parse(state);\r\n    filteredWorkOrders = [...allWorkOrders];\r\n    renderCurrentView();\r\n}\r\n\r\nfunction updateUndoRedoButtons() {\r\n    document.getElementById('undoBtn').disabled = undoStack.length === 0;\r\n    document.getElementById('redoBtn').disabled = redoStack.length === 0;\r\n}\r\n\r\n// ============================================\r\n// SETTINGS PERSISTENCE\r\n// ============================================\r\nfunction gatherSettings() {\r\n    // Compile all settings into a single object\r\n    // Only save capacity limits (not category names/colors which come from DB)\r\n    const categoryLimits = {};\r\n    capacitySettings.categories.forEach(cat => {\r\n        categoryLimits[cat.id] = cat.limits;\r\n    });\r\n\r\n    return {\r\n        version: '1.0',\r\n        categoryLimits: categoryLimits, // Map of category_id -> limits array\r\n        ganttScale: ganttScale,\r\n        showArrows: showArrows,\r\n        allowSameDayStarts: allowSameDayStarts,\r\n        shiftDependentWOs: shiftDependentWOs,\r\n        skipWeekends: skipWeekends,\r\n        dateFormat: dateFormat,\r\n        calendarColorMode: calendarColorMode,\r\n        showCompletedWOs: showCompletedWOs,\r\n        calendarExpanded: calendarExpanded,\r\n        collapsedMOs: Array.from(collapsedMOs), // Convert Set to Array for JSON\r\n        savedAt: new Date().toISOString()\r\n    };\r\n}\r\n\r\nfunction applySettings(settings) {\r\n    // Apply loaded settings to global variables\r\n    if (!settings || !settings.version) {\r\n        debugLog('warn', 'Invalid settings object, using defaults');\r\n        return false;\r\n    }\r\n\r\n    try {\r\n        // Apply category limits to existing categories (don't replace category metadata)\r\n        if (settings.categoryLimits && typeof settings.categoryLimits === 'object') {\r\n            capacitySettings.categories.forEach(cat => {\r\n                if (settings.categoryLimits[cat.id]) {\r\n                    cat.limits = settings.categoryLimits[cat.id];\r\n                }\r\n            });\r\n        }\r\n\r\n        if (typeof settings.ganttScale === 'number') {\r\n            ganttScale = settings.ganttScale;\r\n        }\r\n        if (typeof settings.showArrows === 'boolean') {\r\n            showArrows = settings.showArrows;\r\n            // Update UI checkbox\r\n            const showArrowsCheckbox = document.getElementById('showArrowsToggle');\r\n            if (showArrowsCheckbox) showArrowsCheckbox.checked = showArrows;\r\n        }\r\n        if (typeof settings.allowSameDayStarts === 'boolean') {\r\n            allowSameDayStarts = settings.allowSameDayStarts;\r\n            // Update UI checkbox\r\n            const sameDayStartsCheckbox = document.getElementById('sameDayStartsToggle');\r\n            if (sameDayStartsCheckbox) sameDayStartsCheckbox.checked = allowSameDayStarts;\r\n        }\r\n        if (typeof settings.shiftDependentWOs === 'boolean') {\r\n            shiftDependentWOs = settings.shiftDependentWOs;\r\n            // Update UI checkbox\r\n            const shiftDependentWOsCheckbox = document.getElementById('shiftDependentWOsToggle');\r\n            if (shiftDependentWOsCheckbox) shiftDependentWOsCheckbox.checked = shiftDependentWOs;\r\n        }\r\n        if (typeof settings.skipWeekends === 'boolean') {\r\n            skipWeekends = settings.skipWeekends;\r\n            // Update UI checkbox\r\n            const skipWeekendsCheckbox = document.getElementById('skipWeekendsToggle');\r\n            if (skipWeekendsCheckbox) skipWeekendsCheckbox.checked = skipWeekends;\r\n        }\r\n        if (settings.dateFormat && (settings.dateFormat === 'DD/MM/YYYY' || settings.dateFormat === 'MM/DD/YYYY')) {\r\n            dateFormat = settings.dateFormat;\r\n            // Update UI select\r\n            const dateFormatSelect = document.getElementById('dateFormatSelect');\r\n            if (dateFormatSelect) dateFormatSelect.value = dateFormat;\r\n        }\r\n        if (settings.calendarColorMode && (settings.calendarColorMode === 'status' || settings.calendarColorMode === 'category')) {\r\n            calendarColorMode = settings.calendarColorMode;\r\n            // Update UI select\r\n            const calendarColorModeSelect = document.getElementById('calendarColorModeSelect');\r\n            if (calendarColorModeSelect) calendarColorModeSelect.value = calendarColorMode;\r\n        }\r\n        if (typeof settings.showCompletedWOs === 'boolean') {\r\n            showCompletedWOs = settings.showCompletedWOs;\r\n            // Update UI checkbox\r\n            const showCompletedWOsCheckbox = document.getElementById('showCompletedWOsToggle');\r\n            if (showCompletedWOsCheckbox) showCompletedWOsCheckbox.checked = showCompletedWOs;\r\n        }\r\n        if (typeof settings.calendarExpanded === 'boolean') {\r\n            calendarExpanded = settings.calendarExpanded;\r\n        }\r\n        if (Array.isArray(settings.collapsedMOs)) {\r\n            collapsedMOs = new Set(settings.collapsedMOs);\r\n        }\r\n\r\n        // Sync UI checkboxes with current global variable values\r\n        // This ensures UI reflects state even if some settings weren't in the saved JSON\r\n        const showArrowsCheckbox = document.getElementById('showArrowsToggle');\r\n        if (showArrowsCheckbox) showArrowsCheckbox.checked = showArrows;\r\n\r\n        const sameDayStartsCheckbox = document.getElementById('sameDayStartsToggle');\r\n        if (sameDayStartsCheckbox) sameDayStartsCheckbox.checked = allowSameDayStarts;\r\n\r\n        const shiftDependentWOsCheckbox = document.getElementById('shiftDependentWOsToggle');\r\n        if (shiftDependentWOsCheckbox) shiftDependentWOsCheckbox.checked = shiftDependentWOs;\r\n\r\n        const skipWeekendsCheckbox = document.getElementById('skipWeekendsToggle');\r\n        if (skipWeekendsCheckbox) skipWeekendsCheckbox.checked = skipWeekends;\r\n\r\n        debugLog('success', `Settings loaded from ${settings.savedAt || 'unknown date'}`);\r\n\r\n        // Update KPIs after settings are loaded (especially capacity limits)\r\n        updateKPIs();\r\n\r\n        return true;\r\n    } catch (error) {\r\n        debugLog('error', 'Error applying settings:', error);\r\n        return false;\r\n    }\r\n}\r\n\r\nfunction saveSettingsToDatabase() {\r\n    // Save settings to database via part.details field using ImportRq API\r\n    const settings = gatherSettings();\r\n    const settingsJson = JSON.stringify(settings);\r\n\r\n    // First, query the headers to know the column order\r\n    const headers = queryImportHeaders();\r\n\r\n    if (!headers) {\r\n        debugLog('error', 'Could not retrieve import headers');\r\n        showToast('Failed to save: Could not get import format', 'error');\r\n        return false;\r\n    }\r\n\r\n    // Parse headers - they are quoted CSV values like \"PartNumber\",\"PartDescription\",...\r\n    const headerColumns = headers.match(/(\".*?\"|[^\",\\s]+)(?=\\s*,|\\s*$)/g) || [];\r\n    const cleanColumns = headerColumns.map(col => col.replace(/^\"|\"$/g, '').trim());\r\n\r\n    // Try base64 encoding instead of CSV escaping to avoid issues with commas/quotes in JSON\r\n    const base64Json = btoa(settingsJson);\r\n\r\n    // Define our field values matching the ImportPart example format exactly\r\n    const fieldValues = {\r\n        'PartNumber': '\"_settingsCapacityPlanner\"',\r\n        'PartDescription': '\"_settingsCapacityPlanner\"',\r\n        'PartDetails': '\"' + base64Json + '\"',\r\n        'UOM': '\"ea\"',\r\n        'PartType': '\"Internal Use\"',\r\n        'Active': '\"true\"',\r\n        'ABCCode': '\"N\"',\r\n        'Weight': '\"0\"',\r\n        'WeightUOM': '\"kg\"',\r\n        'Width': '\"0\"',\r\n        'Height': '\"0\"',\r\n        'Length': '\"0\"',\r\n        'SizeUOM': '\"ft\"',\r\n        'ConsumptionRate': '\"0\"',\r\n        'POItemType': '\"Purchase\"',\r\n        'DefaultOutsourcedReturnItem': '\"_settingsCapacityPlanner\"',\r\n        'Tracks-Lot Number': '\"false\"',\r\n        'Tracks-Revision Level': '\"false\"',\r\n        'Tracks-Expiration Date': '\"false\"',\r\n        'Tracks-Serial Number': '\"false\"'\r\n    };\r\n\r\n    // Build CSV row by mapping header columns to field values\r\n    const csvFields = cleanColumns.map(col => {\r\n        if (fieldValues.hasOwnProperty(col)) {\r\n            return fieldValues[col];\r\n        }\r\n        return '';  // Empty string for unmapped columns\r\n    });\r\n\r\n    const csvDataRow = csvFields.join(',');\r\n\r\n    // Build API request with BOTH header row and data row\r\n    const payload = {\r\n        \"ImportRq\": {\r\n            \"Type\": \"ImportPart\",\r\n            \"Rows\": {\r\n                \"Row\": [\r\n                    headers,      // Header row with column names\r\n                    csvDataRow    // Data row with values\r\n                ]\r\n            }\r\n        }\r\n    };\r\n\r\n    try {\r\n        const response = runApiRequest('ImportRq', JSON.stringify(payload));\r\n\r\n        if (!response) {\r\n            debugLog('error', 'Save settings failed: No response from API');\r\n            showToast('Failed to save settings: No response', 'error');\r\n            return false;\r\n        }\r\n\r\n        const result = typeof response === 'string' ? JSON.parse(response) : response;\r\n\r\n        if (result && result.ImportRs && result.ImportRs.statusCode === 1000) {\r\n            const saveTimestamp = new Date().toLocaleString();\r\n            debugLog('success', `✅ Settings saved at ${saveTimestamp}`);\r\n            showToast(`Settings saved at ${saveTimestamp}`, 'success', 3000);\r\n            return true;\r\n        } else {\r\n            let errorMsg = 'Save settings failed';\r\n            if (result && result.ImportRs) {\r\n                errorMsg += ` (Status: ${result.ImportRs.statusCode})`;\r\n                if (result.ImportRs.statusMessage) {\r\n                    errorMsg += `: ${result.ImportRs.statusMessage}`;\r\n                }\r\n            }\r\n            debugLog('error', 'Save Settings Error:', result);\r\n            showToast(errorMsg, 'error');\r\n            return false;\r\n        }\r\n    } catch (error) {\r\n        debugLog('error', 'Error saving settings:', error);\r\n        showToast('Error saving settings: ' + error.message, 'error');\r\n        return false;\r\n    }\r\n}\r\n\r\nfunction queryImportHeaders() {\r\n    // Query the required headers for ImportPart (for debugging/verification)\r\n    const headerPayload = {\r\n        \"ImportHeaderRq\": {\r\n            \"Type\": \"ImportPart\"\r\n        }\r\n    };\r\n\r\n    try {\r\n        const headerResponse = runApiRequest('ImportHeaderRq', JSON.stringify(headerPayload));\r\n        debugLog('info', 'Import Headers Response:', headerResponse);\r\n\r\n        if (headerResponse) {\r\n            const headerResult = typeof headerResponse === 'string' ? JSON.parse(headerResponse) : headerResponse;\r\n            debugLog('info', 'Import Headers Parsed:', headerResult);\r\n\r\n            if (headerResult && headerResult.ImportHeaderRs && headerResult.ImportHeaderRs.Header && headerResult.ImportHeaderRs.Header.Row) {\r\n                const headerRow = headerResult.ImportHeaderRs.Header.Row;\r\n                debugLog('info', 'Expected CSV Headers:', headerRow);\r\n                return headerRow;\r\n            }\r\n        }\r\n    } catch (e) {\r\n        debugLog('error', 'Error querying import headers:', e);\r\n    }\r\n    return null;\r\n}\r\n\r\nfunction loadSettingsFromDatabase() {\r\n    // Load settings from database via part.details field\r\n    const selectQuery = `\r\n        SELECT details\r\n        FROM part\r\n        WHERE num = '_settingsCapacityPlanner'\r\n        LIMIT 1\r\n    `;\r\n\r\n    try {\r\n        const result = JSON.parse(runQuery(selectQuery));\r\n        if (result && result.length > 0 && result[0].details) {\r\n            const base64Details = result[0].details;\r\n\r\n            // Decode base64 to get JSON string\r\n            const settingsJson = atob(base64Details);\r\n            const settings = JSON.parse(settingsJson);\r\n\r\n            const savedAtTime = settings.savedAt || 'unknown';\r\n            debugLog('success', `✅ Settings loaded (saved at ${savedAtTime})`);\r\n\r\n            return applySettings(settings);\r\n        } else {\r\n            debugLog('info', 'No saved settings found in database');\r\n            return false;\r\n        }\r\n    } catch (error) {\r\n        debugLog('warn', 'Could not load settings from database:', error);\r\n        return false;\r\n    }\r\n}\r\n\r\n// ============================================\r\n// EVENT LISTENERS INITIALIZATION\r\n// ============================================\r\nfunction initializeEventListeners() {\r\n    debugLog('info', 'Initializing event listeners...');\r\n\r\n    // FILTERS\r\n    const searchInput = document.getElementById('searchInput');\r\n    if (searchInput) {\r\n        searchInput.addEventListener('input', (e) => {\r\n            const term = e.target.value.toLowerCase();\r\n            if (!term) {\r\n                filteredWorkOrders = [...allWorkOrders];\r\n            } else {\r\n                filteredWorkOrders = allWorkOrders.filter(wo =>\r\n                    wo.wo_num.toLowerCase().includes(term) ||\r\n                    wo.mo_num.toLowerCase().includes(term) ||\r\n                    (wo.category_name && wo.category_name.toLowerCase().includes(term)) ||\r\n                    (wo.part_num && wo.part_num.toLowerCase().includes(term)) ||\r\n                    (wo.description && wo.description.toLowerCase().includes(term))\r\n                );\r\n            }\r\n            updateKPIs();\r\n            renderCurrentView();  // Updates all views (gantt and capacity)\r\n        });\r\n        debugLog('info', '✓ searchInput event listener attached');\r\n    }\r\n\r\n    // SETTINGS\r\n    const sameDayStartsToggle = document.getElementById('sameDayStartsToggle');\r\n    if (sameDayStartsToggle) {\r\n        sameDayStartsToggle.addEventListener('change', (e) => {\r\n            allowSameDayStarts = e.target.checked;\r\n            saveSettingsToDatabase();  // Auto-save when toggled\r\n        });\r\n        debugLog('info', '✓ sameDayStartsToggle event listener attached');\r\n    }\r\n\r\n    const shiftDependentWOsToggle = document.getElementById('shiftDependentWOsToggle');\r\n    if (shiftDependentWOsToggle) {\r\n        shiftDependentWOsToggle.addEventListener('change', (e) => {\r\n            shiftDependentWOs = e.target.checked;\r\n            saveSettingsToDatabase();  // Auto-save when toggled\r\n        });\r\n        debugLog('info', '✓ shiftDependentWOsToggle event listener attached');\r\n    }\r\n\r\n    const skipWeekendsToggle = document.getElementById('skipWeekendsToggle');\r\n    if (skipWeekendsToggle) {\r\n        skipWeekendsToggle.addEventListener('change', (e) => {\r\n            skipWeekends = e.target.checked;\r\n            saveSettingsToDatabase();  // Auto-save when toggled\r\n        });\r\n        debugLog('info', '✓ skipWeekendsToggle event listener attached');\r\n    }\r\n\r\n    // Status filter multi-select dropdown\r\n    const statusFilterButton = document.getElementById('statusFilterButton');\r\n    const statusFilterDropdown = document.getElementById('statusFilterDropdown');\r\n    const statusFilterLabel = document.getElementById('statusFilterLabel');\r\n    const statusFilterCheckboxes = document.querySelectorAll('.status-filter-checkbox');\r\n\r\n    if (statusFilterButton && statusFilterDropdown) {\r\n        // Toggle dropdown\r\n        statusFilterButton.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            statusFilterDropdown.classList.toggle('hidden');\r\n        });\r\n\r\n        // Close dropdown when clicking outside\r\n        document.addEventListener('click', (e) => {\r\n            if (!statusFilterDropdown.contains(e.target) && !statusFilterButton.contains(e.target)) {\r\n                statusFilterDropdown.classList.add('hidden');\r\n            }\r\n        });\r\n\r\n        // Handle checkbox changes\r\n        statusFilterCheckboxes.forEach(checkbox => {\r\n            checkbox.addEventListener('change', () => {\r\n                const value = checkbox.value;\r\n                if (checkbox.checked) {\r\n                    activeStatusFilters.add(value);\r\n                } else {\r\n                    activeStatusFilters.delete(value);\r\n                }\r\n\r\n                // Update label\r\n                const checkedCount = document.querySelectorAll('.status-filter-checkbox:checked').length;\r\n                if (checkedCount === 4) {\r\n                    statusFilterLabel.textContent = 'All Status';\r\n                } else if (checkedCount === 0) {\r\n                    statusFilterLabel.textContent = 'None';\r\n                } else {\r\n                    statusFilterLabel.textContent = `${checkedCount} Selected`;\r\n                }\r\n\r\n                debugLog('info', `Status filters: ${Array.from(activeStatusFilters).join(', ')}`);\r\n                renderGanttChart();\r\n            });\r\n        });\r\n\r\n        debugLog('info', '✓ statusFilter multi-select event listeners attached');\r\n    }\r\n\r\n    const showArrowsToggle = document.getElementById('showArrowsToggle');\r\n    if (showArrowsToggle) {\r\n        showArrowsToggle.addEventListener('change', (e) => {\r\n            showArrows = e.target.checked;\r\n            renderGanttChart();\r\n            saveSettingsToDatabase();  // Auto-save when toggled\r\n        });\r\n        debugLog('info', '✓ showArrowsToggle event listener attached');\r\n    } else {\r\n        debugLog('warn', '✗ showArrowsToggle element not found');\r\n    }\r\n\r\n    const showCompletedWOsToggle = document.getElementById('showCompletedWOsToggle');\r\n    if (showCompletedWOsToggle) {\r\n        showCompletedWOsToggle.addEventListener('change', (e) => {\r\n            showCompletedWOs = e.target.checked;\r\n            renderCurrentView();  // Re-render capacity planning and calendar\r\n            saveSettingsToDatabase();  // Auto-save when toggled\r\n        });\r\n        debugLog('info', '✓ showCompletedWOsToggle event listener attached');\r\n    } else {\r\n        debugLog('warn', '✗ showCompletedWOsToggle element not found');\r\n    }\r\n\r\n    const dateFormatSelect = document.getElementById('dateFormatSelect');\r\n    if (dateFormatSelect) {\r\n        dateFormatSelect.addEventListener('change', (e) => {\r\n            dateFormat = e.target.value;\r\n            renderCurrentView();  // Re-render to apply new date format\r\n            saveSettingsToDatabase();  // Auto-save when changed\r\n        });\r\n        debugLog('info', '✓ dateFormatSelect event listener attached');\r\n    } else {\r\n        debugLog('warn', '✗ dateFormatSelect element not found');\r\n    }\r\n\r\n    debugLog('success', 'Event listeners initialization complete');\r\n}\r\n\r\n// ============================================\r\n// CAPACITY PLANNING\r\n// ============================================\r\n\r\nfunction initializeCapacitySettings() {\r\n    // Extract unique categories from work orders\r\n    const uniqueCategories = new Map();\r\n\r\n    filteredWorkOrders.forEach(wo => {\r\n        const catId = wo.calcategory_id ?? 0; // Treat null/undefined as 0 (Uncategorized)\r\n        if (!uniqueCategories.has(catId)) {\r\n            uniqueCategories.set(catId, {\r\n                id: catId,\r\n                name: wo.calendar_category || 'Uncategorized',\r\n                color: '#' + (wo.category_color || 'CCCCCC'),\r\n                limits: [8, 8, 8, 8, 8, 0, 0] // Default: 8hrs Mon-Fri, 0hrs weekends\r\n            });\r\n        }\r\n    });\r\n\r\n    capacitySettings.categories = Array.from(uniqueCategories.values());\r\n    debugLog('info', `Initialized ${capacitySettings.categories.length} categories for capacity planning`);\r\n}\r\n\r\nfunction getCapacity(categoryId, dayOfWeek) {\r\n    const cat = capacitySettings.categories.find(c => c.id === categoryId);\r\n    return cat ? cat.limits[dayOfWeek] : 0;\r\n}\r\n\r\nfunction setCapacity(categoryId, dayOfWeek, hours) {\r\n    const cat = capacitySettings.categories.find(c => c.id === categoryId);\r\n    if (cat) {\r\n        cat.limits[dayOfWeek] = hours;\r\n    }\r\n}\r\n\r\nfunction buildCapacityTable(weekStart) {\r\n    const table = document.getElementById('capacityTable');\r\n    if (!table) return;\r\n\r\n    table.innerHTML = '';\r\n\r\n    // Ensure weekStart is always a Monday\r\n    if (weekStart.isoWeekday() !== 1) {\r\n        weekStart = weekStart.clone().isoWeekday(1);\r\n        currentCapacityWeek = weekStart;\r\n    }\r\n\r\n    // Show 1 week (7 days) - aligns with monthly calendar above\r\n    const numWeeks = 1;\r\n    const numDays = 7;\r\n    const viewEnd = weekStart.clone().add(numDays, 'days');\r\n\r\n    // Update week display to show full date range\r\n    const weekDisplay = document.getElementById('capacityWeekDisplay');\r\n    if (weekDisplay) {\r\n        weekDisplay.textContent = `${weekStart.format('MMM D')} - ${viewEnd.clone().subtract(1, 'day').format('MMM D, YYYY')}`;\r\n    }\r\n\r\n    // Build header\r\n    const thead = document.createElement('thead');\r\n    const headerRow = document.createElement('tr');\r\n    headerRow.innerHTML = `<th class=\"sticky left-0 bg-slate-100 z-10 px-2 py-2 text-center text-sm font-bold text-slate-700 border-b-2 border-r-2 border-slate-300 w-20\">\r\n        <svg class=\"w-5 h-5 mx-auto text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z\"></path>\r\n        </svg>\r\n    </th>`;\r\n\r\n    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];\r\n    for (let day = 0; day < numDays; day++) {\r\n        const currentDay = weekStart.clone().add(day, 'days');\r\n        const dayOfWeek = day % 7;\r\n        const isWeekend = dayOfWeek >= 5;\r\n        const isToday = currentDay.isSame(moment(), 'day');\r\n        const isWeekStart = dayOfWeek === 0;\r\n\r\n        headerRow.innerHTML += `\r\n            <th class=\"px-3 py-3 text-center text-xs font-bold ${isWeekend ? 'bg-amber-100' : 'bg-slate-100'} ${isToday ? 'bg-indigo-100 border-l-2 border-r-2 border-indigo-500' : 'border-l border-slate-300'} border-b-2 border-slate-400 min-w-[120px]\">\r\n                <div${isToday ? ' class=\"text-indigo-700 font-extrabold\"' : ''}>${dayNames[dayOfWeek]}</div>\r\n                <div class=\"text-slate-500 font-normal\">${currentDay.format('D MMM')}</div>\r\n            </th>\r\n        `;\r\n    }\r\n    thead.appendChild(headerRow);\r\n    table.appendChild(thead);\r\n\r\n    // Build body with categories (sorted alphabetically by name)\r\n    const tbody = document.createElement('tbody');\r\n\r\n    const sortedCategories = [...capacitySettings.categories].sort((a, b) =>\r\n        a.name.localeCompare(b.name)\r\n    );\r\n\r\n    sortedCategories.forEach(category => {\r\n        // Category name row\r\n        const row = document.createElement('tr');\r\n        row.className = 'border-b-2 border-slate-300 group';\r\n\r\n        // Category name cell spanning both WO row and stats row\r\n        const categoryCell = document.createElement('td');\r\n        categoryCell.rowSpan = 2; // Span both the WO tile row and stats row\r\n        categoryCell.className = 'sticky left-0 bg-white z-10 px-2 py-2 border-r-2 border-slate-300 w-20';\r\n        categoryCell.style.writingMode = 'vertical-rl';\r\n        categoryCell.style.textOrientation = 'mixed';\r\n\r\n        // Truncate long category names and add title attribute for full text\r\n        const maxLength = 30;\r\n        const displayName = category.name.length > maxLength ? category.name.substring(0, maxLength) + '...' : category.name;\r\n\r\n        categoryCell.innerHTML = `\r\n            <div class=\"flex flex-col items-center justify-center h-full gap-2\">\r\n                <span class=\"text-sm font-semibold text-slate-700\" title=\"${category.name}\" style=\"hyphens: auto; word-wrap: break-word;\">${displayName}</span>\r\n                <div class=\"w-3 h-3 rounded-full flex-shrink-0\" style=\"background-color: ${category.color}\"></div>\r\n            </div>\r\n        `;\r\n\r\n        row.appendChild(categoryCell);\r\n\r\n        // SVG cell spanning all days for WO bars\r\n        const svgCell = document.createElement('td');\r\n        svgCell.colSpan = numDays;\r\n        svgCell.className = 'p-0 relative border-b border-slate-300';\r\n\r\n        // Get all WOs for this category in this view\r\n        const categoryWOs = getWOsForCategory(category.id, weekStart, numWeeks);\r\n\r\n        // Create SVG container for WO bars\r\n        const svgId = `capacity-svg-${category.id}`;\r\n        const svgHeight = categoryWOs.lanes > 0 ? categoryWOs.lanes * 40 + 10 : 50;\r\n        svgCell.innerHTML = `<svg id=\"${svgId}\" width=\"100%\" height=\"${svgHeight}\"></svg>`;\r\n\r\n        row.appendChild(svgCell);\r\n        tbody.appendChild(row);\r\n\r\n        // Create separate row for stat cells\r\n        const statsRow = document.createElement('tr');\r\n        statsRow.className = 'border-b-2 border-slate-300';\r\n\r\n        // No category cell needed here - it spans from the row above\r\n\r\n        // Individual stat cells to match header structure\r\n        for (let day = 0; day < numDays; day++) {\r\n            const dayOfWeek = day % 7;\r\n            const capacity = category.limits[dayOfWeek];\r\n            const isWeekend = dayOfWeek >= 5;\r\n            const currentDay = weekStart.clone().add(day, 'days');\r\n            const isToday = currentDay.isSame(moment(), 'day');\r\n            const { usage } = getUsageForCategoryAndDay(category.id, currentDay);\r\n            const percentage = capacity > 0 ? (usage / capacity) * 100 : 0;\r\n            const isOverCapacity = usage > capacity;\r\n\r\n            const statCell = document.createElement('td');\r\n            // Match header border styling exactly\r\n            statCell.className = `px-3 py-2 text-center border-t-2 border-slate-400 ${isWeekend ? 'bg-amber-100' : 'bg-slate-50'} ${isToday ? 'bg-indigo-100 border-l-2 border-r-2 border-indigo-500' : 'border-l border-slate-300'} ${isOverCapacity ? 'ring-2 ring-inset ring-red-600' : ''}`;\r\n            statCell.innerHTML = `\r\n                <div class=\"text-xs font-semibold ${isOverCapacity ? 'text-red-600' : 'text-slate-600'}\">${usage.toFixed(2)}h / ${capacity}h</div>\r\n                <div class=\"w-full bg-slate-200 rounded-full h-1.5 mt-1\">\r\n                    <div class=\"h-1.5 rounded-full ${isOverCapacity ? 'bg-red-500' : 'bg-green-500'}\" style=\"width: ${Math.min(percentage, 100)}%\"></div>\r\n                </div>\r\n            `;\r\n            statsRow.appendChild(statCell);\r\n        }\r\n        tbody.appendChild(statsRow);\r\n    });\r\n\r\n    table.appendChild(tbody);\r\n\r\n    // Render WO bars after browser finishes laying out the table\r\n    // Use requestAnimationFrame to ensure table layout is complete\r\n    requestAnimationFrame(() => {\r\n        const sortedCategories = [...capacitySettings.categories].sort((a, b) =>\r\n            a.name.localeCompare(b.name)\r\n        );\r\n        sortedCategories.forEach(category => {\r\n            renderCapacityWOs(category, weekStart, numWeeks);\r\n        });\r\n        debugLog('info', `Capacity table built for week ${weekStart.format('MMM D, YYYY')}`);\r\n    });\r\n}\r\n\r\nfunction getWOsForCategory(categoryId, weekStart, numWeeks = 1) {\r\n    const viewEnd = weekStart.clone().add(numWeeks * 7, 'days');\r\n    const wos = [];\r\n\r\n    filteredWorkOrders.forEach(wo => {\r\n        // Filter out completed WOs if setting is disabled\r\n        if (!showCompletedWOs && wo.wo_status === 40) return;\r\n\r\n        // Match category\r\n        if (wo.calcategory_id !== categoryId) return;\r\n\r\n        const woStart = moment(wo.date_scheduled_start);\r\n        const woEnd = moment(wo.date_scheduled);\r\n\r\n        // Check if WO overlaps with this view\r\n        if (woStart.isBefore(viewEnd) && woEnd.isAfter(weekStart)) {\r\n            wos.push(wo);\r\n        }\r\n    });\r\n\r\n    // Pack WOs into lanes\r\n    const lanes = packWOsIntoLanes(wos);\r\n\r\n    return { wos, lanes };\r\n}\r\n\r\nfunction getUsageForCategoryAndDay(categoryId, currentDay) {\r\n    const checkDay = currentDay.clone().startOf('day');\r\n\r\n    let usage = 0;\r\n    let matchedWOs = 0;\r\n    let wosWithNoLabor = 0;\r\n\r\n    filteredWorkOrders.forEach(wo => {\r\n        // Filter out completed WOs if setting is disabled\r\n        if (!showCompletedWOs && wo.wo_status === 40) return;\r\n\r\n        // Match category\r\n        if (wo.calcategory_id !== categoryId) return;\r\n\r\n        // Use startOf('day') for both dates to match tile rendering logic\r\n        const woStart = moment(wo.date_scheduled_start).startOf('day');\r\n        let woEnd = moment(wo.date_scheduled).startOf('day');\r\n\r\n        // For completed WOs, use date_finished if available and earlier than date_scheduled\r\n        // This prevents completed WOs from inflating capacity in future days\r\n        if (wo.wo_status === 40 && wo.date_finished) {\r\n            const dateFinished = moment(wo.date_finished).startOf('day');\r\n            // Use the earlier of date_finished or date_scheduled\r\n            woEnd = moment.min(woEnd, dateFinished);\r\n        }\r\n\r\n        // Check if this day falls within the WO date range (inclusive)\r\n        if (checkDay.isSameOrAfter(woStart) && checkDay.isSameOrBefore(woEnd)) {\r\n            // If skip weekends is enabled and this is a weekend day, skip it\r\n            if (skipWeekends) {\r\n                const dayOfWeek = checkDay.day();\r\n                if (dayOfWeek === 0 || dayOfWeek === 6) {\r\n                    // Weekend day - don't count any hours\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // Calculate hours for this day\r\n            const laborHoursPerUnit = parseFloat(wo.labor_hours_from_bom) || 0;\r\n            const qtyTarget = parseFloat(wo.qty_target) || 1;\r\n            const totalHours = laborHoursPerUnit * qtyTarget;\r\n\r\n            // Calculate days to divide hours across\r\n            let daysInWO;\r\n            if (skipWeekends) {\r\n                // Count only weekdays\r\n                daysInWO = countWeekdaysInRange(woStart, woEnd);\r\n            } else {\r\n                // Count all days (inclusive)\r\n                daysInWO = woEnd.diff(woStart, 'days') + 1;\r\n            }\r\n\r\n            const hoursPerDay = daysInWO > 0 ? totalHours / daysInWO : 0;\r\n\r\n            if (totalHours > 0) {\r\n                matchedWOs++;\r\n                const dayType = skipWeekends ? 'weekdays' : 'days';\r\n                debugLog('debug', `  WO ${wo.wo_num}: ${totalHours}hrs / ${daysInWO}${dayType} = ${hoursPerDay.toFixed(2)}hrs/day (${woStart.format('YYYY-MM-DD')} to ${woEnd.format('YYYY-MM-DD')})`);\r\n            } else {\r\n                wosWithNoLabor++;\r\n                debugLog('warn', `  WO ${wo.wo_num} has NO labor hours (labor_hours_from_bom = ${wo.labor_hours_from_bom})`);\r\n            }\r\n\r\n            usage += hoursPerDay;\r\n        }\r\n    });\r\n\r\n    if (matchedWOs > 0) {\r\n        debugLog('debug', `  Total: ${matchedWOs} WOs matched for category ${categoryId} on ${checkDay.format('YYYY-MM-DD')}`);\r\n    }\r\n\r\n    if (wosWithNoLabor > 0) {\r\n        debugLog('warn', `  ⚠️ ${wosWithNoLabor} WO(s) have no labor hours and contribute 0 to capacity!`);\r\n    }\r\n\r\n    return { usage };\r\n}\r\n\r\nfunction renderCapacityWOs(category, weekStart, numWeeks = 1) {\r\n    const svgId = `capacity-svg-${category.id}`;\r\n    const svg = d3.select(`#${svgId}`);\r\n    if (svg.empty()) return;\r\n\r\n    svg.selectAll('*').remove();\r\n\r\n    const viewEnd = weekStart.clone().add(numWeeks * 7, 'days');\r\n\r\n    const svgNode = svg.node();\r\n    const height = parseInt(svg.attr('height'));\r\n    const numDays = numWeeks * 7;\r\n\r\n    // Read actual column positions from table headers after they're rendered\r\n    const table = document.getElementById('capacityTable');\r\n    const headerCells = table.querySelectorAll('thead th');\r\n\r\n    // Get the SVG's bounding rectangle\r\n    const svgRect = svgNode.getBoundingClientRect();\r\n\r\n    // Build arrays of column positions and widths\r\n    const dayPositions = [];\r\n    const dayWidths = [];\r\n\r\n    // Skip first header (category column) and read day columns\r\n    for (let i = 1; i < headerCells.length && i <= numDays; i++) {\r\n        const cell = headerCells[i];\r\n        const cellRect = cell.getBoundingClientRect();\r\n        // Calculate position relative to SVG's left edge\r\n        const relativeLeft = cellRect.left - svgRect.left;\r\n        dayPositions.push(relativeLeft);\r\n        dayWidths.push(cellRect.width);\r\n    }\r\n\r\n    // Set SVG width to match the total width of all day columns\r\n    const totalWidth = dayPositions.length > 0\r\n        ? (dayPositions[dayPositions.length - 1] + dayWidths[dayWidths.length - 1])\r\n        : numDays * 120;\r\n    svg.attr('width', totalWidth);\r\n\r\n    // Create xScale based on actual column positions\r\n    const xScale = (date) => {\r\n        const dayIndex = moment(date).diff(weekStart, 'days');\r\n        if (dayIndex < 0 || dayPositions.length === 0) return dayPositions[0] || 0;\r\n        if (dayIndex >= dayPositions.length) return dayPositions[dayPositions.length - 1] + dayWidths[dayWidths.length - 1];\r\n        return dayPositions[dayIndex];\r\n    };\r\n\r\n    // Draw day dividers and weekend backgrounds\r\n    for (let day = 0; day < dayPositions.length; day++) {\r\n        const dayOfWeek = day % 7;\r\n        const isWeekend = dayOfWeek >= 5;\r\n        const dayStart = weekStart.clone().add(day, 'days');\r\n        const x = dayPositions[day];\r\n        const dayWidth = dayWidths[day];\r\n\r\n        const isToday = dayStart.isSame(moment(), 'day');\r\n\r\n        if (isWeekend) {\r\n            svg.append('rect')\r\n                .attr('x', x)\r\n                .attr('y', 0)\r\n                .attr('width', dayWidth)\r\n                .attr('height', height)\r\n                .attr('fill', '#fffbeb')\r\n                .attr('opacity', 0.5);\r\n        }\r\n\r\n        // Today indicator - indigo background\r\n        if (isToday) {\r\n            svg.append('rect')\r\n                .attr('x', x)\r\n                .attr('y', 0)\r\n                .attr('width', dayWidth)\r\n                .attr('height', height)\r\n                .attr('fill', '#EEF2FF') // indigo-50\r\n                .attr('opacity', 0.8);\r\n        }\r\n\r\n        // Day divider - no special Monday border, today gets indigo borders\r\n        svg.append('line')\r\n            .attr('x1', x)\r\n            .attr('x2', x)\r\n            .attr('y1', 0)\r\n            .attr('y2', height)\r\n            .attr('stroke', isToday ? '#818CF8' : '#e2e8f0') // indigo-400 for today\r\n            .attr('stroke-width', isToday ? 2 : 1);\r\n\r\n        // Right border for today column\r\n        if (isToday) {\r\n            svg.append('line')\r\n                .attr('x1', x + dayWidth)\r\n                .attr('x2', x + dayWidth)\r\n                .attr('y1', 0)\r\n                .attr('y2', height)\r\n                .attr('stroke', '#818CF8') // indigo-400\r\n                .attr('stroke-width', 2);\r\n        }\r\n    }\r\n\r\n    // Get WOs for this category\r\n    const { wos } = getWOsForCategory(category.id, weekStart, numWeeks);\r\n    if (wos.length === 0) return;\r\n\r\n    // Render each WO\r\n    wos.forEach(wo => {\r\n        // Use start of day for start and end of day for finish to ignore time component\r\n        const woStart = moment(wo.date_scheduled_start).startOf('day');\r\n        let woEnd = moment(wo.date_scheduled).endOf('day');\r\n\r\n        // For completed WOs, use date_finished if available and earlier than date_scheduled\r\n        // This ensures visual representation matches capacity calculations\r\n        if (wo.wo_status === 40 && wo.date_finished) {\r\n            const dateFinished = moment(wo.date_finished).endOf('day');\r\n            // Use the earlier of date_finished or date_scheduled\r\n            woEnd = moment.min(woEnd, dateFinished);\r\n        }\r\n\r\n        // Clamp to visible view\r\n        const visibleStart = moment.max(woStart, weekStart);\r\n        const visibleEnd = moment.min(woEnd, viewEnd);\r\n\r\n        const x = xScale(visibleStart.toDate());\r\n\r\n        // For end position, we need the RIGHT edge of the day, not the left edge\r\n        const endDayIndex = moment(visibleEnd).diff(weekStart, 'days');\r\n        const xEnd = (endDayIndex >= 0 && endDayIndex < dayPositions.length)\r\n            ? dayPositions[endDayIndex] + dayWidths[endDayIndex]\r\n            : xScale(visibleEnd.toDate());\r\n        const barWidth = xEnd - x;\r\n\r\n        // Add padding so tiles don't touch cell edges\r\n        const horizontalPadding = 4;\r\n        const paddedX = x + horizontalPadding;\r\n        const paddedWidth = Math.max(0, barWidth - (horizontalPadding * 2));\r\n\r\n        const lane = wo._lane || 0;\r\n        const y = 10 + (lane * 40);\r\n        const barHeight = 35; // Keep larger for capacity view (has 2 lines of text)\r\n\r\n        // Calculate total hours and hours per day\r\n        const laborHoursPerUnit = parseFloat(wo.labor_hours_from_bom) || 0;\r\n        const qtyTarget = parseFloat(wo.qty_target) || 1;\r\n        const totalHours = laborHoursPerUnit * qtyTarget;\r\n\r\n        // Calculate days to divide hours across\r\n        let daysInWO;\r\n        if (skipWeekends) {\r\n            // Count only weekdays\r\n            daysInWO = countWeekdaysInRange(woStart, woEnd);\r\n        } else {\r\n            // Count all days\r\n            daysInWO = Math.ceil(woEnd.diff(woStart, 'days', true)) || 1;\r\n        }\r\n\r\n        const hoursPerDay = daysInWO > 0 ? totalHours / daysInWO : 0;\r\n\r\n        // Status colors\r\n        // Use standard color scheme\r\n        const colors = WO_STATUS_COLORS[wo.wo_status] || WO_STATUS_COLORS[10];\r\n        const barColor = colors.fill;\r\n        const borderColor = colors.stroke;\r\n\r\n        // WO bar background (with padding)\r\n        const bar = svg.append('rect')\r\n            .attr('x', paddedX)\r\n            .attr('y', y)\r\n            .attr('width', paddedWidth)\r\n            .attr('height', barHeight)\r\n            .attr('fill', barColor)\r\n            .attr('stroke', borderColor)\r\n            .attr('stroke-width', 2)\r\n            .attr('rx', 4)\r\n            .attr('class', 'wo-bar')\r\n            .attr('data-wo-id', wo.wo_id)\r\n            .attr('data-wo-num', wo.wo_num);\r\n\r\n        // Custom CSS tooltip\r\n        const finishedGoodInfo = wo.part_num ? `${wo.part_num}` : 'N/A';\r\n        const descriptionInfo = wo.description ? wo.description : '';\r\n        const capacityTooltipHTML = `\r\n            <div><span class=\"wo-tooltip-label\">WO:</span><span class=\"wo-tooltip-value\">${wo.wo_num}</span></div>\r\n            <div><span class=\"wo-tooltip-label\">Finished Good:</span><span class=\"wo-tooltip-value\">${finishedGoodInfo}</span></div>\r\n            ${descriptionInfo ? `<div><span class=\"wo-tooltip-label\">Description:</span><span class=\"wo-tooltip-value\">${descriptionInfo}</span></div>` : ''}\r\n            <div><span class=\"wo-tooltip-label\">Total Hours:</span><span class=\"wo-tooltip-value\">${totalHours.toFixed(2)}h</span></div>\r\n            <div><span class=\"wo-tooltip-label\">Hours per Day:</span><span class=\"wo-tooltip-value\">${hoursPerDay.toFixed(2)}h</span></div>\r\n        `;\r\n\r\n        bar.on('mouseover', function(event) {\r\n            showWOTooltip(event, capacityTooltipHTML);\r\n        }).on('mouseout', function() {\r\n            hideWOTooltip();\r\n        }).on('mousemove', function(event) {\r\n            showWOTooltip(event, capacityTooltipHTML);\r\n        });\r\n\r\n        // Double-click to open WO in Fishbowl\r\n        bar.on('dblclick', function() {\r\n            debugLog('info', `Opening WO ${wo.wo_num} in Fishbowl...`);\r\n            try {\r\n                if (typeof openModule === 'function') {\r\n                    openModule('Work Order', wo.wo_num);\r\n                    showToast(`Opening WO ${wo.wo_num}`, 'info');\r\n                } else {\r\n                    debugLog('warn', 'openModule function not available in Fishbowl');\r\n                    showToast('Cannot open WO - not running in Fishbowl', 'error');\r\n                }\r\n            } catch (error) {\r\n                debugLog('error', 'Error opening WO:', error);\r\n                showToast('Error opening WO: ' + error.message, 'error');\r\n            }\r\n        });\r\n\r\n        // Add drag behavior\r\n        const woId = wo.wo_id;\r\n        let dragStartX = paddedX;\r\n        let dragStartY = y;\r\n        let isDragging = false;\r\n        let totalDragDistance = 0;\r\n        let associatedTexts = []; // Store text elements that belong to this WO\r\n        let dragOverlay = null; // Overlay element for cross-category dragging\r\n\r\n        const dragBehavior = d3.drag()\r\n            .on('start', function(event) {\r\n                dragStartX = parseFloat(d3.select(this).attr('x'));\r\n                dragStartY = parseFloat(d3.select(this).attr('y'));\r\n                isDragging = false;\r\n                totalDragDistance = 0;\r\n                hideWOTooltip();\r\n\r\n                // Find and store all text elements that belong to this WO\r\n                associatedTexts = [];\r\n                svg.selectAll('text').each(function() {\r\n                    const text = d3.select(this);\r\n                    const textX = parseFloat(text.attr('x'));\r\n                    const textY = parseFloat(text.attr('y'));\r\n\r\n                    // Check if this text belongs to this WO by initial position\r\n                    // Label text is at (paddedX + 6, y + barHeight/2 - 4)\r\n                    if (Math.abs(textX - (dragStartX + 6)) < 5 &&\r\n                        Math.abs(textY - (dragStartY + barHeight / 2 - 4)) < 5) {\r\n                        associatedTexts.push({\r\n                            element: text,\r\n                            offsetX: textX - dragStartX,\r\n                            offsetY: textY - dragStartY\r\n                        });\r\n                    }\r\n                    // Daily hours text is centered in each day column\r\n                    else if (textY >= dragStartY + barHeight / 2 &&\r\n                             textY <= dragStartY + barHeight &&\r\n                             text.attr('text-anchor') === 'middle') {\r\n                        // Check if it's roughly within the WO's horizontal span\r\n                        const woStartX = dragStartX;\r\n                        const woEndX = dragStartX + parseFloat(d3.select('.wo-bar[data-wo-id=\"' + woId + '\"]').attr('width'));\r\n                        if (textX >= woStartX - 20 && textX <= woEndX + 20) {\r\n                            associatedTexts.push({\r\n                                element: text,\r\n                                offsetX: textX - dragStartX,\r\n                                offsetY: textY - dragStartY\r\n                            });\r\n                        }\r\n                    }\r\n                });\r\n            })\r\n            .on('drag', function(event) {\r\n                // Track total drag distance\r\n                totalDragDistance += Math.abs(event.dx) + Math.abs(event.dy);\r\n\r\n                // Only start visual dragging if we've moved more than 5 pixels\r\n                if (totalDragDistance > 5) {\r\n                    if (!isDragging) {\r\n                        // First time exceeding threshold - apply drag styling\r\n                        isDragging = true;\r\n                        const draggedBar = d3.select(this);\r\n\r\n                        // Hide the original bar and text\r\n                        draggedBar.attr('opacity', 0.3);\r\n                        associatedTexts.forEach(t => t.element.attr('opacity', 0.3));\r\n\r\n                        // Create a drag overlay that sits above everything\r\n                        const barRect = this.getBoundingClientRect();\r\n                        dragOverlay = document.createElement('div');\r\n                        dragOverlay.style.position = 'fixed';\r\n                        dragOverlay.style.left = barRect.left + 'px';\r\n                        dragOverlay.style.top = barRect.top + 'px';\r\n                        dragOverlay.style.width = barRect.width + 'px';\r\n                        dragOverlay.style.height = barHeight + 'px';\r\n                        dragOverlay.style.backgroundColor = barColor;\r\n                        dragOverlay.style.border = `2px solid ${borderColor}`;\r\n                        dragOverlay.style.borderRadius = '4px';\r\n                        dragOverlay.style.opacity = '0.7';\r\n                        dragOverlay.style.pointerEvents = 'none';\r\n                        dragOverlay.style.zIndex = '10000';\r\n                        dragOverlay.style.boxShadow = '0 4px 6px rgba(0,0,0,0.2)';\r\n                        dragOverlay.innerHTML = `<div style=\"padding: 4px 6px; font-size: 11px; font-weight: 600; color: #06162d;\">${labelText}</div>`;\r\n                        document.body.appendChild(dragOverlay);\r\n                    }\r\n\r\n                    // Update overlay position to follow mouse\r\n                    if (dragOverlay) {\r\n                        const currentLeft = parseFloat(dragOverlay.style.left);\r\n                        const currentTop = parseFloat(dragOverlay.style.top);\r\n                        dragOverlay.style.left = (currentLeft + event.dx) + 'px';\r\n                        dragOverlay.style.top = (currentTop + event.dy) + 'px';\r\n                    }\r\n\r\n                    // Still move the original bar (hidden) for position tracking\r\n                    const newX = parseFloat(d3.select(this).attr('x')) + event.dx;\r\n                    const newY = parseFloat(d3.select(this).attr('y')) + event.dy;\r\n                    d3.select(this).attr('x', newX).attr('y', newY);\r\n\r\n                    // Move associated text elements\r\n                    associatedTexts.forEach(textInfo => {\r\n                        textInfo.element\r\n                            .attr('x', newX + textInfo.offsetX)\r\n                            .attr('y', newY + textInfo.offsetY);\r\n                    });\r\n                }\r\n            })\r\n            .on('end', function(event) {\r\n                // Remove drag overlay\r\n                if (dragOverlay) {\r\n                    dragOverlay.remove();\r\n                    dragOverlay = null;\r\n                }\r\n\r\n                // Reset styling\r\n                d3.select(this)\r\n                    .attr('opacity', 1)\r\n                    .attr('stroke-width', 2);\r\n\r\n                // Reset text opacity\r\n                associatedTexts.forEach(t => t.element.attr('opacity', 1));\r\n\r\n                // If we never started dragging, it was just a click - do nothing\r\n                if (!isDragging) {\r\n                    return;\r\n                }\r\n\r\n                // Get the final position\r\n                const finalX = parseFloat(d3.select(this).attr('x'));\r\n                const finalY = parseFloat(d3.select(this).attr('y'));\r\n\r\n                // Calculate which day based on X position\r\n                let targetDay = null;\r\n                for (let i = 0; i < dayPositions.length; i++) {\r\n                    const dayX = dayPositions[i];\r\n                    const dayW = dayWidths[i];\r\n                    if (finalX >= dayX && finalX < dayX + dayW) {\r\n                        targetDay = weekStart.clone().add(i, 'days');\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                // Calculate which category based on Y position\r\n                // Only check for category change if Y movement was significant\r\n                const draggedY = finalY - dragStartY;\r\n                const draggedX = finalX - dragStartX;\r\n                let targetCategory = null;\r\n\r\n                // Only detect category change if vertical movement is significant (>30px)\r\n                // AND greater than horizontal movement (primarily vertical drag)\r\n                if (Math.abs(draggedY) > 30 && Math.abs(draggedY) > Math.abs(draggedX)) {\r\n                    debugLog('info', `Category drag detected: Y=${draggedY.toFixed(1)}px, X=${draggedX.toFixed(1)}px`);\r\n                    const table = document.getElementById('capacityTable');\r\n                    const tbody = table.querySelector('tbody');\r\n                    const categoryRows = tbody.querySelectorAll('tr:nth-child(odd)'); // Odd rows are category WO rows\r\n\r\n                    // Get sorted categories to match table row order (categories are sorted alphabetically in buildCapacityTable)\r\n                    const sortedCategories = [...capacitySettings.categories].sort((a, b) =>\r\n                        a.name.localeCompare(b.name)\r\n                    );\r\n\r\n                    categoryRows.forEach((row, idx) => {\r\n                        const svgCell = row.querySelector('td:last-child');\r\n                        if (svgCell) {\r\n                            const svgElement = svgCell.querySelector('svg');\r\n                            if (svgElement) {\r\n                                const rect = svgElement.getBoundingClientRect();\r\n                                const mouseY = event.sourceEvent.clientY;\r\n                                if (mouseY >= rect.top && mouseY <= rect.bottom) {\r\n                                    // Use sortedCategories instead of capacitySettings.categories to match table order\r\n                                    const detectedCategory = sortedCategories[idx];\r\n                                    debugLog('info', `Mouse over category ${idx}: ${detectedCategory?.name} (ID: ${detectedCategory?.id}), WO current category: ${wo.calcategory_id}`);\r\n                                    // Only set if different from current category\r\n                                    if (detectedCategory && detectedCategory.id !== wo.calcategory_id) {\r\n                                        targetCategory = detectedCategory;\r\n                                        debugLog('success', `Target category set to: ${targetCategory.name} (ID: ${targetCategory.id})`);\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n\r\n                // Only process drop if something actually changed\r\n                let hasChanges = false;\r\n                let categoryChanged = false;\r\n\r\n                // Check if category actually changed\r\n                if (targetCategory) {\r\n                    categoryChanged = true;\r\n                    hasChanges = true;\r\n                }\r\n\r\n                // Check if day changed (only if we found a valid target day)\r\n                if (targetDay) {\r\n                    const originalStart = moment(wo.date_scheduled_start).startOf('day');\r\n                    if (!targetDay.isSame(originalStart, 'day')) {\r\n                        hasChanges = true;\r\n                    }\r\n                }\r\n\r\n                // Handle the drop only if there are actual changes\r\n                if (hasChanges) {\r\n                    handleCapacityWODrop(wo, targetDay, categoryChanged ? targetCategory : null, weekStart);\r\n                } else {\r\n                    // No changes - snap back to original position\r\n                    renderCurrentView();\r\n                }\r\n            });\r\n\r\n        bar.call(dragBehavior);\r\n\r\n        // WO label - show WO number and total hours\r\n        const labelText = `WO ${wo.wo_num} (${totalHours.toFixed(2)}h)`;\r\n        svg.append('text')\r\n            .attr('x', paddedX + 6)\r\n            .attr('y', y + barHeight / 2 - 4)\r\n            .attr('font-size', '11px')\r\n            .attr('font-weight', '600')\r\n            .attr('fill', '#06162d') // Fishbowl dark text\r\n            .attr('pointer-events', 'none')\r\n            .text(labelText);\r\n\r\n        // Daily breakdown - show hours per day aligned under each day\r\n        // Since we're using full days now, each day gets equal hours\r\n        let currentDay = visibleStart.clone().startOf('day');\r\n        const breakdown = [];\r\n        while (currentDay.isBefore(visibleEnd)) {\r\n            const dayEnd = currentDay.clone().add(1, 'day');\r\n\r\n            // Check if this day overlaps with the WO\r\n            if (currentDay.isBefore(woEnd) && dayEnd.isAfter(woStart)) {\r\n                const dayIndex = currentDay.diff(weekStart, 'days');\r\n                if (dayIndex >= 0 && dayIndex < dayPositions.length) {\r\n                    const dayX = dayPositions[dayIndex];\r\n                    const dayWidth = dayWidths[dayIndex];\r\n\r\n                    // Calculate the visible portion of this day within the WO bar (with padding)\r\n                    const visibleDayStart = Math.max(dayX, paddedX);\r\n                    const visibleDayEnd = Math.min(dayX + dayWidth, paddedX + paddedWidth);\r\n                    const visibleDayWidth = visibleDayEnd - visibleDayStart;\r\n\r\n                    // Only show hours if there's enough space (at least 30px)\r\n                    if (visibleDayWidth >= 30) {\r\n                        // Center the hours text within the visible portion\r\n                        svg.append('text')\r\n                            .attr('x', visibleDayStart + visibleDayWidth / 2)\r\n                            .attr('y', y + barHeight / 2 + 10)\r\n                            .attr('font-size', '9px')\r\n                            .attr('fill', '#64748b')\r\n                            .attr('text-anchor', 'middle')\r\n                            .attr('pointer-events', 'none')\r\n                            .text(`${hoursPerDay.toFixed(2)}h`);\r\n                    }\r\n                }\r\n            }\r\n\r\n            currentDay.add(1, 'day');\r\n        }\r\n\r\n        // TODO: Add drag and resize handlers\r\n    });\r\n}\r\n\r\nfunction openCapacitySettingsModal() {\r\n    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];\r\n\r\n    const modalHtml = `\r\n        <div class=\"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center\" id=\"capacityModal\" onclick=\"if(event.target===this) closeCapacityModal()\">\r\n            <div class=\"bg-white rounded-lg shadow-xl max-w-4xl w-full m-4 max-h-[90vh] overflow-auto\">\r\n                <div class=\"sticky top-0 bg-white flex items-center justify-between p-4 border-b border-slate-200\">\r\n                    <h3 class=\"text-lg font-bold text-slate-800\">Capacity Settings</h3>\r\n                    <button onclick=\"closeCapacityModal()\" class=\"p-1 hover:bg-slate-100 rounded\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                        </svg>\r\n                    </button>\r\n                </div>\r\n                <div class=\"p-4\">\r\n                    <table class=\"w-full border-collapse\">\r\n                        <thead>\r\n                            <tr>\r\n                                <th class=\"border border-slate-300 bg-slate-50 px-3 py-2 text-left text-sm font-bold text-slate-700\">Category</th>\r\n                                ${dayNames.map(day => `<th class=\"border border-slate-300 bg-slate-50 px-3 py-2 text-center text-sm font-bold text-slate-700\">${day}</th>`).join('')}\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            ${capacitySettings.categories.map((category, catIdx) => `\r\n                                <tr>\r\n                                    <td class=\"border border-slate-300 px-3 py-2 text-sm font-medium text-slate-700 bg-slate-50\">\r\n                                        <div class=\"flex items-center gap-2\">\r\n                                            <div class=\"w-3 h-3 rounded-full flex-shrink-0\" style=\"background-color: ${category.color}\"></div>\r\n                                            ${category.name}\r\n                                        </div>\r\n                                    </td>\r\n                                    ${dayNames.map((day, dayIdx) => `\r\n                                        <td class=\"border border-slate-300 px-2 py-2 text-center\">\r\n                                            <input type=\"number\"\r\n                                                   class=\"capacity-input w-full px-2 py-1 border border-slate-300 rounded text-sm text-center\"\r\n                                                   data-category=\"${catIdx}\"\r\n                                                   data-day=\"${dayIdx}\"\r\n                                                   value=\"${category.limits[dayIdx]}\"\r\n                                                   min=\"0\"\r\n                                                   max=\"24\"\r\n                                                   step=\"0.5\">\r\n                                        </td>\r\n                                    `).join('')}\r\n                                </tr>\r\n                            `).join('')}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n                <div class=\"sticky bottom-0 bg-white flex items-center justify-end gap-2 p-4 border-t border-slate-200\">\r\n                    <button onclick=\"closeCapacityModal()\" class=\"px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg\">\r\n                        Cancel\r\n                    </button>\r\n                    <button onclick=\"saveAllCapacitySettings()\" class=\"px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg\">\r\n                        Save All\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    document.body.insertAdjacentHTML('beforeend', modalHtml);\r\n}\r\n\r\nfunction closeCapacityModal() {\r\n    debugLog('info', 'closeCapacityModal called');\r\n    const modal = document.getElementById('capacityModal');\r\n    if (!modal) {\r\n        debugLog('warn', 'Modal not found');\r\n        return;\r\n    }\r\n\r\n    // Save any changed settings before closing\r\n    const inputs = modal.querySelectorAll('.capacity-input');\r\n    debugLog('info', `Found ${inputs.length} capacity inputs`);\r\n    let hasChanges = false;\r\n\r\n    inputs.forEach(input => {\r\n        const categoryIndex = parseInt(input.dataset.category);\r\n        const dayIndex = parseInt(input.dataset.day);\r\n        const hours = parseFloat(input.value);\r\n\r\n        if (!isNaN(categoryIndex) && !isNaN(dayIndex) && !isNaN(hours)) {\r\n            const category = capacitySettings.categories[categoryIndex];\r\n            if (category) {\r\n                debugLog('info', `Setting capacity for category ${category.id}, day ${dayIndex}: ${hours} hours`);\r\n                setCapacity(category.id, dayIndex, hours);\r\n                hasChanges = true;\r\n            }\r\n        }\r\n    });\r\n\r\n    debugLog('info', `hasChanges: ${hasChanges}`);\r\n    modal.remove();\r\n\r\n    // Rebuild capacity table and save settings\r\n    if (hasChanges) {\r\n        buildCapacityTable(currentCapacityWeek);\r\n        debugLog('info', 'Capacity settings updated, saving to database...');\r\n        saveSettingsToDatabase();\r\n\r\n        // Refresh KPIs to reflect new capacity limits\r\n        updateKPIs();\r\n        debugLog('info', 'KPIs refreshed with updated capacity settings');\r\n    } else {\r\n        debugLog('info', 'No changes detected, skipping save');\r\n    }\r\n}\r\n\r\nfunction saveAllCapacitySettings() {\r\n    // This function is kept for the \"Save\" button, but it just calls closeCapacityModal now\r\n    closeCapacityModal();\r\n}\r\n\r\nfunction changeCapacityWeek(direction) {\r\n    if (!currentCapacityWeek) {\r\n        currentCapacityWeek = moment().startOf('isoWeek');\r\n    }\r\n\r\n    // Add/subtract weeks and ensure we snap to Monday\r\n    currentCapacityWeek = currentCapacityWeek.clone().add(direction, 'weeks').startOf('isoWeek');\r\n    buildCapacityTable(currentCapacityWeek);\r\n}\r\n\r\nfunction goToCapacityToday() {\r\n    // Snap to current week's Monday\r\n    currentCapacityWeek = moment().startOf('isoWeek');\r\n    buildCapacityTable(currentCapacityWeek);\r\n    showToast('Jumped to current week', 'info');\r\n}\r\n\r\n// ============================================\r\n// MONTHLY CALENDAR VIEW\r\n// ============================================\r\nlet currentCalendarMonth = moment();\r\nlet calendarExpanded = false;\r\n\r\nfunction toggleMonthCalendar() {\r\n    calendarExpanded = !calendarExpanded;\r\n    const content = document.getElementById('monthCalendarContent');\r\n    const chevron = document.getElementById('calendarChevron');\r\n\r\n    if (calendarExpanded) {\r\n        content.style.display = 'block';\r\n        chevron.style.transform = 'rotate(180deg)';\r\n        buildMonthCalendar();\r\n    } else {\r\n        content.style.display = 'none';\r\n        chevron.style.transform = 'rotate(0deg)';\r\n    }\r\n    saveSettingsToDatabase();  // Auto-save calendar expanded state\r\n}\r\n\r\nfunction changeCalendarMonth(direction) {\r\n    currentCalendarMonth = currentCalendarMonth.clone().add(direction, 'months');\r\n    buildMonthCalendar();\r\n}\r\n\r\nfunction goToCalendarToday() {\r\n    currentCalendarMonth = moment();\r\n    buildMonthCalendar();\r\n    debugLog('info', 'Jumped to current month in calendar');\r\n}\r\n\r\nfunction toggleCalendarColorMode() {\r\n    const select = document.getElementById('calendarColorModeSelect');\r\n    calendarColorMode = select.value;\r\n    buildMonthCalendar();\r\n    saveSettingsToDatabase();\r\n    debugLog('info', `Calendar color mode changed to: ${calendarColorMode}`);\r\n}\r\n\r\nfunction scrollCapacityToWeek(weekStart) {\r\n    // Update capacity view to show this week\r\n    currentCapacityWeek = weekStart.clone().startOf('isoWeek');\r\n    buildCapacityTable(currentCapacityWeek);\r\n\r\n    // Scroll the capacity table into view smoothly\r\n    const capacityTable = document.getElementById('capacityTable');\r\n    if (capacityTable) {\r\n        capacityTable.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\r\n    }\r\n}\r\n\r\nasync function handleCalendarWODrop(dragData, dropDateStr) {\r\n    // Find the WO in allWorkOrders\r\n    const wo = allWorkOrders.find(w => w.wo_id === dragData.wo_id);\r\n    if (!wo) {\r\n        debugLog('error', `WO ${dragData.wo_num} not found in allWorkOrders`);\r\n        return;\r\n    }\r\n\r\n    // Calculate the date shift\r\n    const originalStart = moment(dragData.originalStart);\r\n    const originalEnd = moment(dragData.originalEnd);\r\n    const dropDate = moment(dropDateStr);\r\n    const daysDiff = dropDate.diff(originalStart, 'days');\r\n\r\n    if (daysDiff === 0) {\r\n        debugLog('info', `WO ${dragData.wo_num} dropped on same date, no change needed`);\r\n        return;\r\n    }\r\n\r\n    // Calculate new dates\r\n    const newStart = originalStart.clone().add(daysDiff, 'days');\r\n    const newEnd = originalEnd.clone().add(daysDiff, 'days');\r\n\r\n    debugLog('info', `Moving WO ${dragData.wo_num} by ${daysDiff} days: ${originalStart.format('YYYY-MM-DD')} → ${newStart.format('YYYY-MM-DD')}`);\r\n\r\n    // Save to database using the async function\r\n    await saveWODates(dragData.wo_num, newStart.format('YYYY-MM-DD'), newEnd.format('YYYY-MM-DD'));\r\n}\r\n\r\nasync function handleCapacityWODrop(wo, targetDay, targetCategory, currentWeekStart) {\r\n    debugLog('info', `handleCapacityWODrop called for WO ${wo.wo_num}, targetCategory: ${targetCategory ? targetCategory.name + ' (ID: ' + targetCategory.id + ')' : 'null'}`);\r\n\r\n    let hasChanges = false;\r\n    const changes = [];\r\n    let newStart, newEnd;\r\n\r\n    // Handle date change\r\n    if (targetDay) {\r\n        const originalStart = moment(wo.date_scheduled_start);\r\n        const originalEnd = moment(wo.date_scheduled);\r\n        const daysDiff = targetDay.diff(originalStart.startOf('day'), 'days');\r\n\r\n        if (daysDiff !== 0) {\r\n            newStart = originalStart.clone().add(daysDiff, 'days');\r\n            newEnd = originalEnd.clone().add(daysDiff, 'days');\r\n\r\n            changes.push(`date: ${originalStart.format('YYYY-MM-DD')} → ${newStart.format('YYYY-MM-DD')}`);\r\n            hasChanges = true;\r\n        }\r\n    }\r\n\r\n    // Handle category change\r\n    let categoryChanged = false;\r\n    if (targetCategory && targetCategory.id !== wo.calcategory_id) {\r\n        const oldCategoryName = wo.calendar_category || 'Uncategorized';\r\n        changes.push(`category: ${oldCategoryName} → ${targetCategory.name}`);\r\n        categoryChanged = true;\r\n        hasChanges = true;\r\n        debugLog('info', `Category change detected: ${oldCategoryName} (ID: ${wo.calcategory_id}) → ${targetCategory.name} (ID: ${targetCategory.id})`);\r\n    } else if (targetCategory) {\r\n        debugLog('info', `No category change - target ${targetCategory.id} is same as current ${wo.calcategory_id}`);\r\n    }\r\n\r\n    if (hasChanges) {\r\n        debugLog('info', `Moving WO ${wo.wo_num}: ${changes.join(', ')}`);\r\n\r\n        // Save date changes first if any\r\n        if (newStart && newEnd) {\r\n            debugLog('info', `Calling saveWODates for WO ${wo.wo_num}`);\r\n            await saveWODates(wo.wo_num, newStart.format('YYYY-MM-DD'), newEnd.format('YYYY-MM-DD'));\r\n        }\r\n\r\n        // Then save category change if any\r\n        if (categoryChanged) {\r\n            debugLog('info', `Calling saveWOCategory for WO ${wo.wo_num} with category ID ${targetCategory.id}`);\r\n            await saveWOCategory(wo.wo_num, targetCategory.id);\r\n        }\r\n\r\n        // Reload work orders to reflect changes\r\n        debugLog('info', `Reloading work orders after WO ${wo.wo_num} changes`);\r\n        loadWorkOrders();\r\n    } else {\r\n        debugLog('info', `WO ${wo.wo_num} dropped with no changes`);\r\n        renderCurrentView(); // Still refresh to snap back to original position\r\n    }\r\n}\r\n\r\nfunction buildMonthCalendar() {\r\n    const container = document.getElementById('monthCalendar');\r\n    if (!container) return;\r\n\r\n    container.innerHTML = '';\r\n\r\n    const monthStart = currentCalendarMonth.clone().startOf('month');\r\n    const monthEnd = currentCalendarMonth.clone().endOf('month');\r\n\r\n    // Update month display\r\n    const monthDisplay = document.getElementById('calendarMonthDisplay');\r\n    if (monthDisplay) {\r\n        monthDisplay.textContent = monthStart.format('MMMM YYYY');\r\n    }\r\n\r\n    // Calculate calendar grid (start from Monday of first week)\r\n    const calendarStart = monthStart.clone().startOf('isoWeek');\r\n    const calendarEnd = monthEnd.clone().endOf('isoWeek');\r\n    const totalDays = calendarEnd.diff(calendarStart, 'days') + 1;\r\n    const numWeeks = Math.ceil(totalDays / 7);\r\n\r\n    // Pre-calculate max lanes per week row for dynamic height\r\n    const maxLanesPerWeek = new Array(numWeeks).fill(0);\r\n\r\n    // Get all WOs for this month and pack them\r\n    const calendarEndForWOs = calendarStart.clone().add(totalDays, 'days');\r\n    const wosInMonth = [];\r\n    filteredWorkOrders.forEach(wo => {\r\n        const woStart = moment(wo.date_scheduled_start).startOf('day');\r\n        const woEnd = moment(wo.date_scheduled).endOf('day');\r\n        if (woStart.isBefore(calendarEndForWOs) && woEnd.isAfter(calendarStart)) {\r\n            wosInMonth.push(wo);\r\n        }\r\n    });\r\n    packWOsIntoLanes(wosInMonth);\r\n\r\n    // Calculate max lanes for each week\r\n    wosInMonth.forEach(wo => {\r\n        const woStart = moment(wo.date_scheduled_start).startOf('day');\r\n        const woEnd = moment(wo.date_scheduled).endOf('day');\r\n        const startDayIndex = Math.max(0, woStart.diff(calendarStart, 'days'));\r\n        const endDayIndex = Math.min(totalDays - 1, woEnd.diff(calendarStart, 'days'));\r\n\r\n        if (startDayIndex < totalDays && endDayIndex >= 0) {\r\n            const startRow = Math.floor(startDayIndex / 7);\r\n            const endRow = Math.floor(endDayIndex / 7);\r\n\r\n            // Only count single-row WOs for now\r\n            if (startRow === endRow && startRow < numWeeks) {\r\n                const lane = wo._lane || 0;\r\n                maxLanesPerWeek[startRow] = Math.max(maxLanesPerWeek[startRow], lane + 1);\r\n            }\r\n        }\r\n    });\r\n\r\n    // Create table structure\r\n    const table = document.createElement('table');\r\n    table.className = 'w-full border-collapse';\r\n\r\n    // Header row with day names\r\n    const thead = document.createElement('thead');\r\n    const headerRow = document.createElement('tr');\r\n    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];\r\n    dayNames.forEach(day => {\r\n        const th = document.createElement('th');\r\n        th.className = 'px-2 py-2 text-xs font-bold text-slate-700 border border-slate-300 bg-slate-100';\r\n        th.textContent = day;\r\n        headerRow.appendChild(th);\r\n    });\r\n    thead.appendChild(headerRow);\r\n    table.appendChild(thead);\r\n\r\n    // Body with weeks and days\r\n    const tbody = document.createElement('tbody');\r\n    let currentDay = calendarStart.clone();\r\n\r\n    for (let week = 0; week < numWeeks; week++) {\r\n        const row = document.createElement('tr');\r\n\r\n        // Calculate dynamic height: 24px for header + 24px per lane, minimum 80px\r\n        const numLanes = maxLanesPerWeek[week] || 0;\r\n        const dynamicHeight = Math.max(80, 24 + (numLanes * 24) + 10); // +10px bottom padding\r\n\r\n        for (let day = 0; day < 7; day++) {\r\n            const cell = document.createElement('td');\r\n            cell.className = 'border border-slate-300 p-0 align-top relative cursor-pointer hover:bg-slate-100 transition-colors';\r\n            cell.style.height = `${dynamicHeight}px`;\r\n            cell.style.minWidth = '100px';\r\n\r\n            const isCurrentMonth = currentDay.month() === monthStart.month();\r\n            const isToday = currentDay.isSame(moment(), 'day');\r\n            const isWeekend = day >= 5;\r\n\r\n            // Calculate capacity for this day\r\n            let totalCapacity = 0;\r\n            let totalUsage = 0;\r\n            capacitySettings.categories.forEach(cat => {\r\n                const dayOfWeek = day;\r\n                const capacity = cat.limits[dayOfWeek];\r\n                const { usage } = getUsageForCategoryAndDay(cat.id, currentDay.clone());\r\n                totalCapacity += capacity;\r\n                totalUsage += usage;\r\n            });\r\n            const isOverCapacity = totalUsage > totalCapacity;\r\n\r\n            cell.innerHTML = `\r\n                <div class=\"p-1 ${isCurrentMonth ? '' : 'opacity-40'} ${isWeekend ? 'bg-amber-50' : 'bg-white'} h-full\">\r\n                    <div class=\"flex items-start justify-between gap-1\">\r\n                        <div class=\"flex items-center gap-1\">\r\n                            <span class=\"text-xs font-semibold ${isToday ? 'bg-indigo-500 text-white rounded-full px-2 py-0.5' : 'text-slate-600'}\">${currentDay.format('D')}</span>\r\n                            <span class=\"text-xs text-slate-500\">${totalUsage.toFixed(0)}/${totalCapacity}h</span>\r\n                        </div>\r\n                        ${isOverCapacity ? '<span class=\"text-xs text-red-600 font-bold\">!</span>' : ''}\r\n                    </div>\r\n                </div>\r\n            `;\r\n\r\n            // Add click handler for day\r\n            const clickDay = currentDay.clone();\r\n            cell.addEventListener('click', () => {\r\n                const weekStart = clickDay.clone().startOf('isoWeek');\r\n                scrollCapacityToWeek(weekStart);\r\n            });\r\n\r\n            // Add drop zone handlers for drag and drop\r\n            cell.setAttribute('data-calendar-date', clickDay.format('YYYY-MM-DD'));\r\n\r\n            cell.addEventListener('dragover', (e) => {\r\n                e.preventDefault();\r\n                e.dataTransfer.dropEffect = 'move';\r\n                cell.style.backgroundColor = '#e0e7ff'; // indigo-100\r\n            });\r\n\r\n            cell.addEventListener('dragleave', (e) => {\r\n                if (isWeekend) {\r\n                    cell.style.backgroundColor = '';\r\n                } else {\r\n                    cell.querySelector('div').style.backgroundColor = isCurrentMonth ? '#ffffff' : '';\r\n                }\r\n            });\r\n\r\n            cell.addEventListener('drop', (e) => {\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n\r\n                // Reset background\r\n                if (isWeekend) {\r\n                    cell.style.backgroundColor = '';\r\n                } else {\r\n                    cell.querySelector('div').style.backgroundColor = isCurrentMonth ? '#ffffff' : '';\r\n                }\r\n\r\n                try {\r\n                    const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));\r\n                    const dropDate = clickDay.format('YYYY-MM-DD');\r\n                    handleCalendarWODrop(dragData, dropDate);\r\n                } catch (error) {\r\n                    debugLog('error', 'Error handling calendar WO drop:', error);\r\n                }\r\n            });\r\n\r\n            // Add red border if over capacity\r\n            if (isOverCapacity) {\r\n                cell.style.borderColor = '#ef4444';\r\n                cell.style.borderWidth = '2px';\r\n            }\r\n\r\n            row.appendChild(cell);\r\n            currentDay.add(1, 'day');\r\n        }\r\n\r\n        tbody.appendChild(row);\r\n    }\r\n\r\n    table.appendChild(tbody);\r\n    container.appendChild(table);\r\n\r\n    // Now render WO overlays\r\n    renderCalendarWOs(table, calendarStart);\r\n}\r\n\r\nfunction renderCalendarWOs(table, calendarStart) {\r\n    const tbody = table.querySelector('tbody');\r\n    const rows = tbody.querySelectorAll('tr');\r\n\r\n    // Get all WOs that overlap with this month\r\n    const totalDays = rows.length * 7;\r\n    const calendarEnd = calendarStart.clone().add(totalDays, 'days');\r\n    const wosInMonth = [];\r\n\r\n    filteredWorkOrders.forEach(wo => {\r\n        // Filter out completed WOs if setting is disabled\r\n        if (!showCompletedWOs && wo.wo_status === 40) return;\r\n\r\n        const woStart = moment(wo.date_scheduled_start).startOf('day');\r\n        let woEnd = moment(wo.date_scheduled).endOf('day');\r\n\r\n        // For completed WOs, use date_finished if available and earlier than date_scheduled\r\n        if (wo.wo_status === 40 && wo.date_finished) {\r\n            const dateFinished = moment(wo.date_finished).endOf('day');\r\n            woEnd = moment.min(woEnd, dateFinished);\r\n        }\r\n\r\n        if (woStart.isBefore(calendarEnd) && woEnd.isAfter(calendarStart)) {\r\n            wosInMonth.push(wo);\r\n        }\r\n    });\r\n\r\n    // Pack WOs into rows to avoid overlap\r\n    packWOsIntoLanes(wosInMonth);\r\n\r\n    // Render each WO as positioned within cells\r\n    wosInMonth.forEach((wo) => {\r\n        const woStart = moment(wo.date_scheduled_start).startOf('day');\r\n        let woEnd = moment(wo.date_scheduled).endOf('day');\r\n\r\n        // For completed WOs, use date_finished if available and earlier than date_scheduled\r\n        if (wo.wo_status === 40 && wo.date_finished) {\r\n            const dateFinished = moment(wo.date_finished).endOf('day');\r\n            woEnd = moment.min(woEnd, dateFinished);\r\n        }\r\n\r\n        // Calculate which days this WO spans\r\n        const startDayIndex = Math.max(0, woStart.diff(calendarStart, 'days'));\r\n        const endDayIndex = Math.min(totalDays - 1, woEnd.diff(calendarStart, 'days'));\r\n\r\n        if (startDayIndex >= totalDays || endDayIndex < 0) return;\r\n\r\n        // Find which row and columns\r\n        const startRow = Math.floor(startDayIndex / 7);\r\n        const startCol = startDayIndex % 7;\r\n        const endRow = Math.floor(endDayIndex / 7);\r\n        const endCol = endDayIndex % 7;\r\n\r\n        // For now, only render WOs that fit within a single row\r\n        if (startRow !== endRow) return; // Skip multi-row WOs for simplicity\r\n\r\n        const row = rows[startRow];\r\n        if (!row) return;\r\n\r\n        const cells = row.querySelectorAll('td');\r\n        const startCell = cells[startCol];\r\n        const endCell = cells[endCol];\r\n\r\n        if (!startCell || !endCell) return;\r\n\r\n        // Create WO bar as absolute positioned element within the row\r\n        const woBar = document.createElement('div');\r\n        woBar.className = 'absolute rounded px-1 py-0.5 text-xs font-medium cursor-move hover:opacity-80 transition-opacity border';\r\n        woBar.draggable = true;\r\n        woBar.setAttribute('data-wo-id', wo.wo_id);\r\n        woBar.setAttribute('data-wo-num', wo.wo_num);\r\n        woBar.setAttribute('data-wo-start', wo.date_scheduled_start);\r\n        woBar.setAttribute('data-wo-end', wo.date_scheduled);\r\n\r\n        // Calculate position based on cell positions within the row\r\n        const rowWidth = row.offsetWidth;\r\n        const cellWidth = rowWidth / 7;\r\n        const horizontalPadding = 4;\r\n        const left = (startCol * cellWidth) + horizontalPadding;\r\n        const width = ((endCol - startCol + 1) * cellWidth) - (horizontalPadding * 2);\r\n        const top = 24 + ((wo._lane || 0) * 24);\r\n\r\n        woBar.style.left = `${left}px`;\r\n        woBar.style.top = `${top}px`;\r\n        woBar.style.width = `${width}px`;\r\n        woBar.style.height = '20px';\r\n        woBar.style.zIndex = '10';\r\n\r\n        // Color by status or category based on setting\r\n        if (calendarColorMode === 'category' && wo.category_color) {\r\n            // Use category color (add # prefix if not present)\r\n            const categoryColor = wo.category_color.startsWith('#') ? wo.category_color : '#' + wo.category_color;\r\n            woBar.style.backgroundColor = categoryColor + '40'; // Add transparency (40 = 25% opacity in hex)\r\n            woBar.style.borderColor = categoryColor;\r\n            woBar.style.color = '#06162d'; // Fishbowl dark text\r\n            woBar.className += ' border-2';\r\n        } else {\r\n            // Use status color (default)\r\n            const colors = WO_STATUS_COLORS[wo.wo_status] || WO_STATUS_COLORS[10];\r\n            woBar.className += ` ${colors.bg} ${colors.border} ${colors.text}`;\r\n        }\r\n        woBar.textContent = `WO ${wo.wo_num}`;\r\n\r\n        // Custom CSS tooltip\r\n        const laborHoursPerUnit = parseFloat(wo.labor_hours_from_bom) || 0;\r\n        const qtyTarget = parseFloat(wo.qty_target) || 1;\r\n        const totalHours = laborHoursPerUnit * qtyTarget;\r\n        const statusName = wo.wo_status === 10 ? 'Entered' : wo.wo_status === 30 ? 'Started' : wo.wo_status === 40 ? 'Fulfilled' : 'Unknown';\r\n        const bomInfo = wo.part_num ? `${wo.part_num} x ${wo.qty_target || '?'}` : 'N/A';\r\n        const calendarTooltipHTML = `\r\n            <div><span class=\"wo-tooltip-label\">WO:</span><span class=\"wo-tooltip-value\">${wo.wo_num}</span></div>\r\n            <div><span class=\"wo-tooltip-label\">MO:</span><span class=\"wo-tooltip-value\">${wo.mo_num}</span></div>\r\n            <div><span class=\"wo-tooltip-label\">Category:</span><span class=\"wo-tooltip-value\">${wo.category_name || 'Uncategorized'}</span></div>\r\n            <div><span class=\"wo-tooltip-label\">BOM:</span><span class=\"wo-tooltip-value\">${bomInfo}</span></div>\r\n            <div><span class=\"wo-tooltip-label\">Status:</span><span class=\"wo-tooltip-value\">${statusName}</span></div>\r\n            <div><span class=\"wo-tooltip-label\">Hours:</span><span class=\"wo-tooltip-value\">${totalHours.toFixed(2)}h</span></div>\r\n            <div><span class=\"wo-tooltip-label\">Start:</span><span class=\"wo-tooltip-value\">${formatDate(woStart)}</span></div>\r\n            <div><span class=\"wo-tooltip-label\">Finish:</span><span class=\"wo-tooltip-value\">${formatDate(woEnd)}</span></div>\r\n        `;\r\n\r\n        woBar.addEventListener('mouseover', (e) => {\r\n            showWOTooltip(e, calendarTooltipHTML);\r\n        });\r\n        woBar.addEventListener('mouseout', () => {\r\n            hideWOTooltip();\r\n        });\r\n        woBar.addEventListener('mousemove', (e) => {\r\n            showWOTooltip(e, calendarTooltipHTML);\r\n        });\r\n\r\n        // Drag and drop handlers\r\n        woBar.addEventListener('dragstart', (e) => {\r\n            e.dataTransfer.effectAllowed = 'move';\r\n            e.dataTransfer.setData('text/plain', JSON.stringify({\r\n                wo_id: wo.wo_id,\r\n                wo_num: wo.wo_num,\r\n                originalStart: wo.date_scheduled_start,\r\n                originalEnd: wo.date_scheduled\r\n            }));\r\n            woBar.style.opacity = '0.5';\r\n        });\r\n\r\n        woBar.addEventListener('dragend', (e) => {\r\n            woBar.style.opacity = '1';\r\n        });\r\n\r\n        // Click handler - scroll to week\r\n        woBar.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            const weekStart = woStart.clone().startOf('isoWeek');\r\n            scrollCapacityToWeek(weekStart);\r\n        });\r\n\r\n        // Append to the row (not tbody) with relative positioning\r\n        row.style.position = 'relative';\r\n        row.appendChild(woBar);\r\n    });\r\n}\r\n\r\n// ============================================\r\n// INITIALIZATION\r\n// ============================================\r\nwindow.addEventListener('DOMContentLoaded', () => {\r\n    // Initialize date ranges now that moment.js is loaded\r\n    if (typeof moment === 'undefined') {\r\n        const debugLogEl = document.getElementById('debugLog');\r\n        if (debugLogEl) {\r\n            debugLogEl.innerHTML = '<div class=\"text-red-400\">[ERROR] moment.js not loaded! Check internet connection or CDN access.</div>';\r\n        }\r\n        console.error('moment.js is not loaded!');\r\n        return;\r\n    }\r\n\r\n    ganttStartDate = moment().startOf('isoWeek');\r\n    ganttEndDate = moment().startOf('isoWeek').add(14, 'days');\r\n\r\n    debugLog('info', 'Application starting...');\r\n\r\n    // Initialize event listeners for UI controls\r\n    initializeEventListeners();\r\n\r\n    // Load work orders (settings will be loaded after categories are initialized)\r\n    loadWorkOrders();\r\n});\r\n</script>\r\n</body>\r\n</html>\r\n",
  "active" : true,
  "note" : "",
  "type" : "Page"
} ]